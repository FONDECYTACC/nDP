---
title: "Chilean prosecutor's office Data merge (Step 3.1)"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  distill::distill_article:
    code_folding: true
    fig_height: 6
    fig_width: 8
    theme: flatly
    toc: yes
    toc_depth: 5
    toc_float: yes
    output_dir: "docs"
  toc_float:
    collapsed: false
    smooth_scroll: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 

```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }  
.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}

.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: scroll; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}

div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 20px; text-align: justify;}

.verysmall .table{
  font-size: 18px;
  overflow-y: scroll;
  height:350px;
  white-space: nowrap;
  overflow-x: scroll; 
  width:100%;
}

.pandoc-table {
  font-size: 8px;
  overflow-y:scroll;
  height:350px;
  white-space: nowrap;
  overflow-x: scroll; 
  width:100%;
}

</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```
```{r prev-setup, include = FALSE, cache=T, error=T}
rm(list=ls());gc()
if(!grepl("4.1.2",R.version.string)){stop("Different version (must be 4.1.2)")}
path<-getwd()#we define it again later in setup chunk

```

```{r setup, include = FALSE, cache=T, error=T, echo=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  

if(!require(pacman)){install.packages("pacman")}
pacman::p_load(APCtools, ggpattern, withr, boot, matrixStats, knitr, tidyr, stringi,stringr, ggplot2, Hmisc, kableExtra, plotly, janitor, rbokeh, zoo, broom, sqldf, devtools, codebook, data.table, panelr, RColorBrewer, lsmeans, finalfit, ggiraph, sf, treemapify, dplyr, tidyverse, epiR, survminer, ggfortify, survMisc, foreign, reshape2, stargazer, tableone, MatchIt, cobalt, eha, igraph, Amelia, DiagrammeR, DiagrammeRsvg, rsvg, mstate, htmltools, webshot, flexsurv, muhaz, Metrics, rpivotTable, caret, polycor, ClusterR, flextable, ggstatsplot, ggside, daff, explore, sjPlot, compareGroups, job, missForest, showtext, ggpattern, distill, showtext, googleVis, tidylog, magick, dlookr, install=F)
try(webshot::install_phantomjs())

if(!require(bpmn)){try(devtools::install_github("bergant/bpmn",upgrade =F))}

options(scipen=2) #display numbers rather scientific number

#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("stulacy/multistateutils", build_vignettes=TRUE, upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

fitstats.flexsurvreg = function(x){
  ll = x$loglik
  aic = x$AIC
  k = length(x$coefficients)
  n = sum(x$data$m["(weights)"])
  aicc = aic + ((2 * k) * (k + 1) / (n - k - 1))
  bic = - 2 * ll + (k * log(n))
  data.frame(
   Df = k,
    "n2ll" = -2 * ll,
    AIC = aic,
    AICc = aicc,
    BIC = bic
  )
}


if(.Platform$OS.type == "windows") withAutoprint({
  memory.size()
  memory.size(TRUE)
  memory.limit()
})
memory.limit(size=56000)

path<-dirname(rstudioapi::getSourceEditorContext()$path)

options(knitr.kable.NA = '')


#to format rows in bold
format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  # one * for italics, two ** for bold
  map <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  

  for (r in rows){
    for(c in cols){

      # Make sure values are not factors
      df[[c]] <- as.character( df[[c]])

      # Update formatting
      df[r, c] <- ifelse(nchar(df[r, c])==0,"",paste0("<b>", df[r, c], "</b>"))
    }
  }

  return(df)
}
format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  # one * for italics, two ** for bold
  map <- setNames(c("*", "<b>", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  

  for (r in rows){
    for(c in cols){

      # Make sure values are not factors
      df[[c]] <- as.character( df[[c]])

      # Update formatting
      df[r, c] <- ifelse(nchar(df[r, c])==0,"",paste0("<b>", df[r, c], "</b>"))
    }
  }

  return(df)
}
```

::: blue
Several issues were found in the first stage of the exploration of the matches.

-   Replace missing sex and nationality <!--- Done --->

-   Clean dates of commission of the crime <!--- 16/08/2022 --->

-   Explore Duplicated entries (relationships) <!--- Pending --->

-   `TIPO_SUJETO_VIC` that are victims and imputed at the same time <!--- Pending --->

-   Investigate 0's in `IDSUJETO_VICTIMA`. Â¿Have they the same distributed crimes? <!--- Done --->

-   Explore missing values in `TIPO_TERMINO` <!--- Done --->

-   `AGRUPA_TERMINOS`, explore missing values <!--- Done --->

-   `GLS_MOTTERMINO` explore missing values; see why is different with `AGRUPA_TERMINOS`.

-   Explore differences of `IDDELITO` with `cod_delito`.

-   `COD_DELITO`. explore deprecated crimes

-   `FAMILIA_DELITO` explore whether crimes that were in a family are no longer there or viceversa <!--- Done --->

-   Generate a category to define VIF `RELACION_VIFSAF` (domestic violence) (include mistreatment, femicide or parricide)

-   Analyze these procedures "AnulaciÃ³n de ingreso error de digitaciÃ³n" & "Agrupado" (gls_mottermino)

-   Generate a narrative of IDs and their nested relationships
:::

```{=html}
<!---
 #https://github.com/kosukeimai/fastLink
 
  #"aquellos registros que terminaronpor ejemplo, con una sentencia absolutoria o en que no se pudo acreditar un hecho delictual". No tengo la bbdd para revisar si esto aplica a nosotros, pero prefiero dejarlo acÃ¡ para que no se me olvide.
 --->
```

### Replace missing sex and nationality

#### Sex

```{r 0-sexor, layout="l-body-outset", echo=T, message=T, error=T, eval=T}
`%>%`<- magrittr::`%>%`
data(mtcars)

cbind(mtcars,mtcars,mtcars) %>% 
    format_cells(1, 1:9, "bold") %>%
rmarkdown::paged_table()
```

```{r 0-sexo, echo=T, message=T, error=T, eval=T}
`%>%`<- magrittr::`%>%`
data(mtcars)

cbind(mtcars,mtcars,mtcars) %>% 
    format_cells(1, 1:9, "bold") %>%
rmarkdown::paged_table()
```


```{r 0-sexo2, echo=T, message=T, error=T, eval=T}
`%>%`<- magrittr::`%>%`
data(mtcars)

cbind(mtcars,mtcars,mtcars) %>% 
    format_cells(1, 1:9, "bold") %>%
DT::datatable(#extensions = c('FixedColumns',"FixedHeader"), 
              rownames = F,
              filter = 'top',
              caption = htmltools::tags$caption(
              style = 'caption-side: top; text-align: left; font-size:100%;',
             'Table 7: ', htmltools::em('Dates with missing values on each country in Stringency Index as a result of the match')),
          options = list(searching = T, #remove search box
                          info = F,
                         searchHighlight = T,
                         scrollX = TRUE,
                         scrollY = "450px",
                         paging=FALSE,
                         fixedHeader=T,
                         lengthMenu = c(2, 12, 18),
                         autoHideNavigation = F, 
                         escape = 1,  # escape the first column
                         buttons=c('copy', 'csv'),
                         class = "display",
                         initComplete = DT::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}"))) %>% 
  DT::formatStyle(1:33,fontWeight= DT::styleRow(1, "bold"))

#DT::formatStyle(names(df),lineHeight='80%') 

```


Many of these cases did not have a date of birth and nationallity, and seem to have other characteristics that may differentiate them from cases that have a defined sex in the database. In PO everyone had consistent values along their records. The criteria to replace values were based in the presence of records with values associated to pregnancy, stay in centers for women and treatments for women. Some of them include more "DELITOS ECONÃMICOS Y TRIBUTARIOS", "DELITOS LEY DE TRÃNSITO HOMICIDIOS", but less "OTROS DELITOS CONTRA LA PROPIEDAD FALTAS LESIONES". In terms of finishing the proceedings, they had more "No Inicio InvestigaciÃ³n", "S Definit (vencim plazo suspens art 240)", "Sentencia definitiva absolutoria" (grouped in SUSPENSION CONDICIONAL DEL PROCEDIMIENTO ), but also "Sentencia definitiva condenatoria". Less crimes were commited in the Metropolitan Region and less individuals were born before 1940.
