<head>
  <link rel="stylesheet" type="text/css" href="stmarkdown2.css">
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
		$(document).ready(function() {
		  // Add button after each code chunk
		  $('.sourceCode').after('<button class="show-code">Show code</button>');

		  // Hide code after each chunk
		  $('.sourceCode').hide();

		  // Show code when button is clicked
		  $('.show-code').click(function() {
		    $(this).prev('.sourceCode').toggle();
		  });
		});
</script>
<script type="text/javascript">
$(document).ready(function() {
  $("button.toggle-code").click(function() {
    $(this).toggleClass("collapsed");
    $(this).siblings("div.sourceCode").toggleClass("hide");
  });
});
</script>
</head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<head>
  <link rel="stylesheet" type="text/css" href="stmarkdown2.css">
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
		$(document).ready(function() {
		  // Add button after each code chunk
		  $('.sourceCode').after('<button class="show-code">Show code</button>');

		  // Hide code after each chunk
		  $('.sourceCode').hide();

		  // Show code when button is clicked
		  $('.show-code').click(function() {
		    $(this).prev('.sourceCode').toggle();
		  });
		});
</script>
<script type="text/javascript">
$(document).ready(function() {
  $("button.toggle-code").click(function() {
    $(this).toggleClass("collapsed");
    $(this).siblings("div.sourceCode").toggleClass("hide");
  });
});
</script>
</head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<pre><code>. clear all

. cap noi which tabout
c:\ado\plus\t\tabout.ado
*! 2.0.8 Ian Watson 15mar2019
*! tabout version 3 (beta) available at: http://tabout.net.au

. if _rc==111 {
.         cap noi ssc install tabout
.         }

. cap noi which pathutil
c:\ado\plus\p\pathutil.ado
*! version 2.2.0 19nov2020 daniel klein

. if _rc==111 {
.         cap noi net install pathutil, from(&quot;http://fmwww.bc.edu/repec/bocode/p/&quot;) 
.         }

. cap noi which pathutil
c:\ado\plus\p\pathutil.ado
*! version 2.2.0 19nov2020 daniel klein

. if _rc==111 {
.         ssc install dirtools    
.         }

. cap noi which project
c:\ado\plus\p\project.ado
*! version 1.3.1  22dec2013  picard@netbox.com

. if _rc==111 {   
.         ssc install project
.         }

. cap noi which stipw
c:\ado\plus\s\stipw.ado
*! Version 1.0.0 17Jan2022

. if _rc==111 {   
.         ssc install stipw
.         }

. cap noi which stpm2
c:\ado\plus\s\stpm2.ado
*! version 1.7.5 May2021

. if _rc==111 {   
.         ssc install stpm2
.         }       

. cap noi which rcsgen
c:\ado\plus\r\rcsgen.ado
*! version 1.5.9 13FEB2022

. if _rc==111 {   
.         ssc install rcsgen
.         }       

. cap noi which matselrc
c:\ado\plus\m\matselrc.ado
*! NJC 1.1.0 20 Apr 2000  (STB-56: dm79)

. if _rc==111 {           
. cap noi net install dm79, from(http://www.stata.com/stb/stb56)
.         }

. cap noi which pbalchk
c:\ado\plus\p\pbalchk.ado
*! Version: 3.0.0
*! Author:  Mark Lunt
*! Date:    October 2, 2017 @ 12:47:35

. if _rc==111 {
.         cap noi net install pbalchk from(&quot;http://personalpages.manchester.ac.uk/staff/mark.lunt/&quot;)
.         }

. cap noi which matselrc
c:\ado\plus\m\matselrc.ado
*! NJC 1.1.0 20 Apr 2000  (STB-56: dm79)

. if _rc==111 {
.         ssc install matselrc
.         }

. 
</code></pre>
<h1><a href="#exercise" id="exercise">Exercise</a></h1>
<p>Date created: 20:56:53  9 May 2023.</p>
<p>Get the folder</p>
<pre><code>
E:\Mi unidad\Alvacast\SISTRAT 2022 (github)


Fecha:  9 May 2023, considerando un SO Windows para el usuario: andre

</code></pre>
<head>
  <link rel="stylesheet" type="text/css" href="stmarkdown2.css">
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
		$(document).ready(function() {
		  // Add button after each code chunk
		  $('.sourceCode').after('<button class="show-code">Show code</button>');

		  // Hide code after each chunk
		  $('.sourceCode').hide();

		  // Show code when button is clicked
		  $('.show-code').click(function() {
		    $(this).prev('.sourceCode').toggle();
		  });
		});
</script>
<script type="text/javascript">
$(document).ready(function() {
  $("button.toggle-code").click(function() {
    $(this).toggleClass("collapsed");
    $(this).siblings("div.sourceCode").toggleClass("hide");
  });
});
</script>
</head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<p>Path data= ;</p>
<p>Tiempo:  9 May 2023, considerando un SO Windows</p>
<p>The file is located and named as: E:\Mi unidad\Alvacast\SISTRAT 2022 (github)fiscalia_mariel_oct_2022_match_SENDA_pris.dta</p>
<p>=============================================================================</p>
<h2><a href="#structure-database-and-survival" id="structure-database-and-survival">Structure database and survival</a></h2>
<p>=============================================================================</p>
<p>We open the files</p>
<pre><code>. use &quot;fiscalia_mariel_jan_2023_match_SENDA.dta&quot;, clear

. encode escolaridad_rec, gen(esc_rec)

. encode sex, generate(sex_enc)

. encode sus_principal_mod, gen(sus_prin_mod)

. encode freq_cons_sus_prin, gen(fr_sus_prin)

. encode compromiso_biopsicosocial, gen(comp_biosoc)

. encode tenencia_de_la_vivienda_mod, gen(ten_viv)

. *encode dg_cie_10_rec, generate(dg_cie_10_mental_h) *already numeric
. encode dg_trs_cons_sus_or, generate(sud_severity_icd10)

. encode macrozona, generate(macrozone)

. 
. recode policonsumo (0=0 &quot;No polysubstance use&quot;) (1=1 &quot;Polysubstance use&quot;), gen(poly)
(0 differences between policonsumo and poly)

. 
. lab var poly &quot;Polysubstance use&quot;

. 
. *rename Clasificación clas 
. *encode Clasificación, gen(clas)
. *drop Clasificación
. 
. gen     clas = 0

. replace clas = 1 if strpos(Clasificación,&quot;Mixta&quot;)&gt;0
(6,835 real changes made)

. replace clas = 2 if strpos(Clasificación,&quot;Rural&quot;)&gt;0
(5,750 real changes made)

. recode clas (0=0 &quot;Urban&quot;) (1=1 &quot;Mixed&quot;) (2=2 &quot;Rural&quot;), gen(clas2) 
(0 differences between clas and clas2)

. drop clas

. 
. rename clas2 clas

. 
. lab var clas &quot;Classification of Municipallities of Residence into Rural-Urban&quot; 

. lab var offender_d &quot;Offenders (proxy of event; missing not event)&quot; 

. 
. lab var porc_pobr &quot;Poverty of municipallities of Residence (numeric)&quot; 

. lab var comuna_residencia_cod_rec &quot;Municipallity of Residence (code)&quot; 

. 
. drop Clasificación

. 
. *región
. format comuna_residencia_cod_rec 

  variable name              display format
  -----------------------------------------
  comuna_residencia_cod_rec  %-9s
  -----------------------------------------

. gen comuna_residencia_cod_rec_num = real(comuna_residencia_cod_rec)
(2 missing values generated)

. gen comuna_residencia_cod_rec_str = string(comuna_residencia_cod_rec_num ,&quot;%05.0f&quot;)

. 
. gen region=substr(comuna_residencia_cod_rec_str, 1,2)

. gen region_num = real(region)
(2 missing values generated)

. 
. drop comuna_residencia_cod_rec_num

. 
. lab var comuna_residencia_cod_rec &quot;Municipallity of Residence (code)&quot; 

. lab var region &quot;Region&quot; 

. lab var region_num &quot;Region (numeric)&quot; 

. lab var age_at_censor_date &quot;Age at censorship date (2019-11-13)&quot; 

. 
. /*
&gt; label define country1 1 &quot;Ukraine&quot; 2 &quot;Bulgaria&quot; 3 &quot;Georgia&quot; 4 &quot;Russia&quot; 5 &quot;Lithuania&quot; 6 &quot;Czech Republic&quot; ///
&gt; 7 &quot;Hungary&quot; 8 &quot;Slovakia&quot; 9 &quot;Portugal&quot; 10 &quot;Croatia&quot; 11 &quot;Ireland&quot; 12 &quot;Estonia&quot; 13 &quot;France&quot; 14 &quot;Cyprus&quot; ///
&gt; 15 &quot;Poland&quot; 16 &quot;Germany&quot; 17 &quot;Great Britain&quot; 18 &quot;Slovenia&quot; 19 &quot;Israel&quot; 20 &quot;Spain&quot; 21 &quot;Belgium&quot; ///
&gt; 22 &quot;Netherlands&quot; 23 &quot;Switzerland&quot; 24 &quot;Sweden&quot; 25 &quot;Norway&quot; 26 &quot;Denmark&quot; 27 &quot;Finland&quot; 
&gt; label values country country1
&gt; */
. 
</code></pre>
<p>Then we set the data base in surirval format and bring the urban-rural classification of municipallities from this <a href="&quot;https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fwww.masvidarural.gob.cl%2Fwp-content%2Fuploads%2F2021%2F04%2FClasificacion-comunas-PNDR.xlsx&amp;wdOrigin=BROWSELINK&quot;">link</a>.</p>
<p>===================================================================================</p>
<h2><a href="#survival" id="survival">Survival</a></h2>
<p>===================================================================================</p>
<pre><code>. *si no está perdido cod_region, significa que hubo un registro (0/1) y el tiempo es el tiempo desde 
. *set the indicator
. gen event=0

. replace event=1 if !missing(offender_d)
(22,287 real changes made)

. 
. // censorship
. gen diff1a= age_at_censor_date-edad_al_ing_1 

. // time to event
. gen diff2b= age_offending_imp-edad_al_ing_1 

. // conditional
. gen diff2= cond(event==1, diff2b, diff1a) //age_offending_imp-edad_al_ing_1

. // completion
. gen diff1b= edad_al_egres_imp-edad_al_ing_1 // edad_al_egres_imp

. gen comp= cond(strpos(motivodeegreso_mod_imp_rec,&quot;Treatment completion&quot;), 1, 0)

. gen contact_js= event

. // time to tr. completion
. gen diff1 = cond(comp==1, diff1b, diff1a)

. 
. gen edad_al_egres_imp_rec = cond(comp==1, edad_al_egres_imp, age_at_censor_date)

. 
. lab var diff2 &quot;Time to offending&quot; 

. lab var diff1 &quot;Time to tr. completion&quot; 

. lab var edad_al_egres_imp_rec &quot;Time to tr. completion (if not, censorship)&quot; 

. 
. lab var contact_js &quot;Contact with justice system status&quot; 

. lab var comp &quot;Tr. completion status&quot; 

. 
. drop comuna_residencia_cod_rec_str event 

. drop diff1a diff1b diff2b

. 
. //id in numeric format
. *encode hash_key, gen(id)
. *gen id= encode(hash_key)
. egen long id = group(hash_key)

. lab var id &quot;HASH (numeric)&quot; 

. 
. //Age at admission, corrected when 0 days in treatment
. gen edad_al_ing_1_mod = cond(diff1&lt;0, edad_al_ing_1 -0.01,edad_al_ing_1)

. lab var edad_al_ing_1_mod &quot;Age at admission (corrected)&quot; 

. 
. //Sort variables
. order id hash_key edad_al_ing_1 edad_al_egres_imp age_offending_imp age_at_censor_date diff1 diff2 comp contact_js

. /*
&gt; global covs_2_mod &quot;i.policonsumo i.sus_prin_mod i.fr_sus_prin edad_al_ing_1 edad_ini_cons i.sex_enc i.esc_rec i.ten_viv i.dg_cie_10_rec i.sud_severity_icd10 n_off_vio n_off_acq n_off_sud i.clas porc_pobr i.macrozo
&gt; ne&quot;
&gt; global covs_3_mod &quot;policonsumo sus_prin_mod fr_sus_prin edad_al_ing_1 edad_ini_cons sex_enc esc_rec ten_viv dg_cie_10_rec n_off_vio n_off_acq n_off_sud clas porc_pobr macrozone&quot;
&gt; */
. 
. //a string variable, so it is encoded
. destring id_centro, replace
id_centro: all characters numeric; replaced as int
(16 missing values generated)

. 
. gen diff1c= cond(diff1&lt;0.001, 0.01, diff1)

. 
. drop diff1

. 
. rename diff1c diff1

. lab var diff1 &quot;Time to tr. completion&quot; 

. 
. //Sort variables
. order id hash_key edad_al_ing_1 edad_al_egres_imp age_offending_imp age_at_censor_date diff1 diff2 comp contact_js

</code></pre>
<p>We show a table of missing values</p>
<pre><code>. misstable sum poly sus_prin_mod fr_sus_prin edad_al_ing_1 edad_ini_cons sex_enc esc_rec ten_viv dg_cie_10_rec n_off_vio n_off_acq n_off_sud clas porc_pobr macrozone
                                                               Obs&lt;.
                                                +------------------------------
               |                                | Unique
      Variable |     Obs=.     Obs&gt;.     Obs&lt;.  | values        Min         Max
  -------------+--------------------------------+------------------------------
  sus_prin_mod |         1              70,862  |      5          1           5
   fr_sus_prin |       355              70,508  |      5          1           5
  edad_ini_c~s |     5,924              64,939  |     68          5          74
       esc_rec |       317              70,546  |      3          1           3
       ten_viv |     4,058              66,805  |      5          1           5
     porc_pobr |         2              70,861  |   &gt;500   .0003295    .6305783
     macrozone |        16              70,847  |      3          1           3
  -----------------------------------------------------------------------------

</code></pre>
<p>And missing patterns</p>
<pre><code>. misstable pat poly sus_prin_mod fr_sus_prin edad_al_ing_1 edad_ini_cons sex_enc esc_rec ten_viv dg_cie_10_rec n_off_vio n_off_acq n_off_sud clas porc_pobr macrozone

         Missing-value patterns
           (1 means complete)

              |   Pattern
    Percent   |  1  2  3  4    5  6  7
  ------------+------------------------
       86%    |  1  1  1  1    1  1  1
              |
        7     |  1  1  1  1    1  1  0
        5     |  1  1  1  1    1  0  1
       &lt;1     |  1  1  1  1    1  0  0
       &lt;1     |  1  1  1  1    0  1  1
       &lt;1     |  1  1  1  0    1  1  1
       &lt;1     |  1  1  1  1    0  0  1
       &lt;1     |  1  1  1  0    1  1  0
       &lt;1     |  1  1  1  0    1  0  1
       &lt;1     |  1  1  1  1    0  0  0
       &lt;1     |  1  1  1  1    0  1  0
       &lt;1     |  1  1  1  0    1  0  0
       &lt;1     |  1  1  0  1    1  0  1
       &lt;1     |  1  1  0  1    1  1  0
       &lt;1     |  1  1  0  1    1  1  1
       &lt;1     |  1  0  1  1    1  1  1
       &lt;1     |  1  1  1  0    0  1  1
       &lt;1     |  0  1  1  0    0  0  0
       &lt;1     |  1  1  0  1    1  0  0
       &lt;1     |  1  1  1  0    0  0  0
       &lt;1     |  1  1  1  0    0  0  1
       &lt;1     |  1  1  1  0    0  1  0
  ------------+------------------------
      100%    |

  Variables are  (1) sus_prin_mod  (2) porc_pobr  (3) macrozone  (4) esc_rec  (5) fr_sus_prin  (6) ten_viv  (7) edad_ini_cons

</code></pre>
<p>86% of patients showed complete data, and 2% had missing data due to tenure status of the household and age of onset of substance use.</p>
<p>=======================================</p>
<h2><a href="#survival-descriptives-ipw" id="survival-descriptives-ipw">Survival, descriptives &amp; IPW</a></h2>
<p>=======================================</p>
<p><strong>Time to tr. completion</strong></p>
<pre><code>. *comp contact_js
. *stset edad_al_egres_imp, enter(edad_al_ing_1_mod) failure(comp==1) //*scale(12) 
. cap drop  _st

. cap drop _d

. cap drop _t

. cap drop _t0

. cap drop _start

. 
. cap gen _start= 0

. stset diff1, enter(_start) failure(comp==1) //*scale(12) 

     failure event:  comp == 1
obs. time interval:  (0, diff1]
 enter on or after:  time _start
 exit on or before:  failure

------------------------------------------------------------------------------
     70,863  total observations
          0  exclusions
------------------------------------------------------------------------------
     70,863  observations remaining, representing
     19,276  failures in single-record/single-failure data
 287,715.27  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  12.57176

. 
. stsum, by (poly)

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start

         |               Incidence     Number of   |------ Survival time -----|
    poly | Time at risk       rate      subjects        25%       50%       75%
---------+---------------------------------------------------------------------
No polys |  59,578.7698   .1074712         18443   1.164159         .         .
Polysubs |  228,136.504   .0564267         52420   2.405592         .         .
---------+---------------------------------------------------------------------
   Total |  287,715.273   .0669968         70863   1.625129         .         .

. *https://www.statalist.org/forums/forum/general-stata-discussion/general/1635683-stata-stir-command-with-pweights
</code></pre>
<pre><code>. poisson _d i.poly , irr exposure(_t) vce(rob)

Iteration 0:   log pseudolikelihood = -73839.905  
Iteration 1:   log pseudolikelihood = -73839.905  

Poisson regression                              Number of obs     =     70,863
                                                Wald chi2(1)      =    1345.95
                                                Prob &gt; chi2       =     0.0000
Log pseudolikelihood = -73839.905               Pseudo R2         =     0.0109

------------------------------------------------------------------------------------
                   |               Robust
                _d |        IRR   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
              poly |
Polysubstance use  |   .5250407   .0092205   -36.69   0.000     .5072764    .5434271
             _cons |   .1074712   .0015603  -153.63   0.000      .104456    .1105733
            ln(_t) |          1  (exposure)
------------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.

. matrix pois_irr_t0_nowgt= r(table)

. *matselrc pois_ir_t0_nowgt pois_ir_t0_nowgt, c(1/1) r(1, 5/6)
. 
. margins i.poly, predict(ir)

Adjusted predictions                            Number of obs     =     70,863
Model VCE    : Robust

Expression   : Predicted incidence rate, predict(ir)

---------------------------------------------------------------------------------------
                      |            Delta-method
                      |     Margin   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
----------------------+----------------------------------------------------------------
                 poly |
No polysubstance use  |   .1074712   .0015603    68.88   0.000     .1044129    .1105294
   Polysubstance use  |   .0564267   .0005575   101.22   0.000     .0553341    .0575194
---------------------------------------------------------------------------------------

. matrix pois_ir_t0_nowgt= r(table)

. *matselrc pois_ir_t0_nowgt pois_ir_t0_nowgt, c(1/2) r(1, 5/6)
. local ir_poly_0 : di %6.2f pois_ir_t0_nowgt[1,1]

. local ir_poly_0_lo : di %6.2f pois_ir_t0_nowgt[2,1]

. local ir_poly_0_up : di %6.2f pois_ir_t0_nowgt[3,1]

. *&quot;`=scalar(round(pois_ir_t0_nowgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt[2,1]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt[3,1]*1000,.01))')&quot;
. scalar ir_poly_00 = &quot;`=scalar(round(pois_ir_t0_nowgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt[5,1]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt[6,1]*1000,.01))')&quot;

. local ir_poly_1 : di %6.2f pois_ir_t0_nowgt[1,2]

. local ir_poly_1_lo : di %6.2f pois_ir_t0_nowgt[2,2]

. local ir_poly_1_up : di %6.2f pois_ir_t0_nowgt[3,2]

. *&quot;`=scalar(round(pois_ir_t0_nowgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt[2,2]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt[3,2]*1000,.01))')&quot;
. scalar ir_poly_11 = &quot;`=scalar(round(pois_ir_t0_nowgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt[5,2]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt[6,2]*1000,.01))')&quot;

. 
. local irr_poly_1 : di %6.2f pois_irr_t0_nowgt[1,2]

. local irr_poly_1_lo : di %6.2f pois_irr_t0_nowgt[2,2]

. local irr_poly_1_up : di %6.2f pois_irr_t0_nowgt[3,2]

. **&quot;`=scalar(round(pois_irr_t0_nowgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_nowgt[2,1]*1000,.01))',`=scalar(round(pois_irr_t0_nowgt[3,1]*1000,.01))')&quot;
. scalar irr_poly01 = &quot;`=scalar(round(pois_irr_t0_nowgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_nowgt[5,2]*1000,.01))',`=scalar(round(pois_irr_t0_nowgt[6,2]*1000,.01))')&quot;

. 
</code></pre>
<pre><code>. *set trace on
. cap noi qui sts test poly, logrank

. scalar logrank_chi= round(r(chi2),.01)

. scalar logrank_df= r(df)

. scalar logrank_p_= round(chiprob(r(df),r(chi2)),.001)

. local lr1: di %3.2f logrank_chi

. local lr2: di %1.0f logrank_df

. local lr3: di %5.4f logrank_p_

. scalar logrank_nowgt= &quot; Chi^2(`lr2')=`lr1',p=`lr3'&quot;

. *di logrank_nowgt
. 
. matrix comb_irs = (0 \ 0 \ 0 \ 0)

. matrix colnames comb_irs = IRs_t0

. matrix rownames comb_irs = &quot;No poly: `=scalar(ir_poly_00)'&quot; &quot;Poly: `=scalar(ir_poly_11)'&quot; &quot;IRR: `=scalar(irr_poly01)'&quot; &quot;Logrank: `=scalar(logrank_nowgt)'&quot;

. esttab matrix(comb_irs) using &quot;prueba_irrs_t0_nowgt_tr_comp.html&quot;, replace
(note: file prueba_irrs_t0_nowgt_tr_comp.html not found)
(output written to prueba_irrs_t0_nowgt_tr_comp.html)

. *set trace off
</code></pre>
<table border="0" width="*">
<tr><td colspan=2><hr></td></tr>
<tr><td>            </td><td>    comb_irs</td></tr>
<tr><td>            </td><td>      IRs_t0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>No poly     </td><td>            </td></tr>
<tr><td>107.47 (95%CI: 104.41,110.53)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Poly        </td><td>            </td></tr>
<tr><td>56.43 (95%CI: 55.33,57.52)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>IRR         </td><td>            </td></tr>
<tr><td>525.04 (95%CI: 507.28,543.4300000000001)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Logrank     </td><td>            </td></tr>
<tr><td>Chi^2(1)=768.07,p=0.0000</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
</table>
<p>We calculated the inverse probability weights</p>
<pre><code>. *https://www.statalist.org/forums/forum/general-stata-discussion/general/1600895-survival-model-stpm2-using-previously-estimated-weights
. *pweights are Stata’s sampling weights—the inverse of the probability that the subject was chosen from the population.
. 
. stipw (logit poly sus_prin_mod fr_sus_prin edad_al_ing_1 edad_ini_cons sex_enc esc_rec ten_viv dg_cie_10_rec n_off_vio n_off_acq n_off_sud clas porc_pobr macrozone), distribution(weibull) ipwtype(stabilised) vce(r
&gt; obust) genweight(ipw_wgt) //*edad_al_ing_1 df(10)  ten_viv colinealidad
9882 observations have missing treatment and/or missing confounder values and/or _st = 0.
These observations are excluded from the analysis, see variable _stipw_flag

Fitting logistic regression to obtain denominator for weights

Iteration 0:   log likelihood = -35519.999  
Iteration 1:   log likelihood = -29792.782  
Iteration 2:   log likelihood = -29570.649  
Iteration 3:   log likelihood = -29570.242  
Iteration 4:   log likelihood = -29570.242  
Fitting second logistic regression with no confounders to obtain numerator for stabilised weights

Iteration 0:   log likelihood = -35519.999  
Iteration 1:   log likelihood = -35519.999  

Fitting weighted survival model to obtain point estimates

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start
             weight:  [pweight=ipw_wgt]

Fitting constant-only model:

Iteration 0:   log pseudolikelihood = -64271.311
Iteration 1:   log pseudolikelihood = -61514.983
Iteration 2:   log pseudolikelihood = -61432.542
Iteration 3:   log pseudolikelihood = -61432.443
Iteration 4:   log pseudolikelihood = -61432.443

Fitting full model:

Iteration 0:   log pseudolikelihood = -61432.443  
Iteration 1:   log pseudolikelihood = -61371.114  
Iteration 2:   log pseudolikelihood = -61370.876  
Iteration 3:   log pseudolikelihood = -61370.876  

Displaying weighted survival model with Robust standard errors

Weibull PH regression                           Number of obs     =     60,981
                                                Wald chi2(1)      =      58.97
Log pseudolikelihood = -61370.876               Prob &gt; chi2       =     0.0000

------------------------------------------------------------------------------
             |               Robust
          _t | Haz. Ratio   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        poly |   .8287182   .0202742    -7.68   0.000     .7899191     .869423
       _cons |   .1444749   .0030453   -91.78   0.000     .1386279    .1505685
-------------+----------------------------------------------------------------
       /ln_p |  -.4725821   .0036318  -130.12   0.000    -.4797003    -.465464
-------------+----------------------------------------------------------------
           p |   .6233905    .002264                      .6189689    .6278437
         1/p |   1.604131   .0058258                      1.592753     1.61559
------------------------------------------------------------------------------
Note: _cons estimates baseline hazard.

</code></pre>
<p>We calculated the incidence rate.</p>
<pre><code>. cap drop  _st

. cap drop _d

. cap drop _t

. cap drop _t0

. cap drop _start

. 
. cap gen _start= 0

. stset diff1 [pw=ipw_wgt], enter(_start) failure(comp==1) //*scale(12) 

     failure event:  comp == 1
obs. time interval:  (0, diff1]
 enter on or after:  time _start
 exit on or before:  failure
            weight:  [pweight=ipw_wgt]

------------------------------------------------------------------------------
     70,863  total observations
      9,882  weights invalid                                    PROBABLE ERROR
------------------------------------------------------------------------------
     60,981  observations remaining, representing
     16,678  failures in single-record/single-failure data
 229,317.06  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  12.32557

. 
. stsum, by (poly)

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start
             weight:  [pweight=ipw_wgt]

         |               Incidence     Number of   |------ Survival time -----|
    poly | Time at risk       rate      subjects        25%       50%       75%
---------+---------------------------------------------------------------------
No polys |  61,334.2363   .0843216      17835.22   1.391781         .         .
Polysubs |  174,998.945   .0665666       44401.7    1.79726         .         .
---------+---------------------------------------------------------------------
   Total |  236,333.182   .0711744      62236.92   1.635616         .         .

</code></pre>
<p>Given the possible errors pointed out by stata in the weights, we calculated the IPW manually</p>
<pre><code>. cap qui noi frame drop example_a
frame example_a not found

. frame copy default example_a

. frame example_a: logistic poly i.sus_prin_mod i.fr_sus_prin edad_al_ing_1 edad_ini_cons i.sex_enc i.esc_rec i.ten_viv i.dg_cie_10_rec i.n_off_vio i.n_off_acq i.n_off_sud i.clas porc_pobr i.macrozone, nolog 

Logistic regression                             Number of obs     =     60,981
                                                LR chi2(27)       =   13933.31
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -28553.345                     Pseudo R2         =     0.1961

-------------------------------------------------------------------------------------------------------------
                                       poly | Odds Ratio   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
--------------------------------------------+----------------------------------------------------------------
                               sus_prin_mod |
                     Cocaine hydrochloride  |   4.314091   .1405755    44.86   0.000     4.047182    4.598603
                             Cocaine paste  |   3.711172   .1012944    48.04   0.000     3.517856    3.915112
                                 Marijuana  |   2.400394    .114662    18.33   0.000      2.18586    2.635983
                                     Other  |   2.542306   .2087736    11.36   0.000     2.164349    2.986264
                                            |
                                fr_sus_prin |
                        2 to 3 days a week  |   1.356489   .0564807     7.32   0.000     1.250186    1.471832
                        4 to 6 days a week  |    1.32917   .0600495     6.30   0.000     1.216536    1.452233
                                     Daily  |   1.490526   .0613763     9.69   0.000     1.374957    1.615809
                    Less than 1 day a week  |   .8239853    .047071    -3.39   0.001     .7367051    .9216058
                                            |
                              edad_al_ing_1 |   .9638512   .0010522   -33.73   0.000     .9617912    .9659156
                              edad_ini_cons |   .9483434    .001846   -27.25   0.000     .9447321    .9519685
                                            |
                                    sex_enc |
                                     Women  |   .8470801   .0217369    -6.47   0.000     .8055302    .8907732
                                            |
                                    esc_rec |
           2-Completed high school or less  |   .7875212   .0240585    -7.82   0.000     .7417513    .8361153
        3-Completed primary school or less  |   .6042393   .0202336   -15.04   0.000     .5658555    .6452268
                                            |
                                    ten_viv |
                                    Others  |   .8918871   .1063883    -0.96   0.337     .7059512    1.126795
Owner/Transferred dwellings/Pays Dividends  |   .8371567   .0862349    -1.73   0.084     .6841087    1.024444
                                   Renting  |   .9754207   .1019295    -0.24   0.812      .794773    1.197129
         Stays temporarily with a relative  |   1.040631   .1072828     0.39   0.699     .8502428    1.273651
                                            |
                              dg_cie_10_rec |
           Diagnosis unknown (under study)  |   1.254299   .0378978     7.50   0.000     1.182177     1.33082
              With psychiatric comorbidity  |   1.450683   .0339206    15.91   0.000       1.3857    1.518713
                                            |
                                1.n_off_vio |   .9904797   .0279471    -0.34   0.735     .9371913    1.046798
                                1.n_off_acq |   1.199716   .0361672     6.04   0.000     1.130883    1.272738
                                1.n_off_sud |   1.096785   .0317454     3.19   0.001     1.036297    1.160803
                                            |
                                       clas |
                                     Mixed  |   .6456518   .0219471   -12.87   0.000      .604038    .6901326
                                     Rural  |   .5185464   .0193394   -17.61   0.000      .481994    .5578707
                                            |
                                  porc_pobr |   15.61556   2.418692    17.74   0.000     11.52697    21.15437
                                            |
                                  macrozone |
                                     North  |   1.666094   .0571907    14.87   0.000      1.55769    1.782042
                                     South  |   .8639278   .0297692    -4.24   0.000     .8075078    .9242897
                                            |
                                      _cons |   8.320871   1.037526    16.99   0.000     6.516776    10.62441
-------------------------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.

. 
. frame example_a: predict double ps //ps = propensity score
(option pr assumed; Pr(poly))
(9,882 missing values generated)

. 
. frame example_a: gen double HAW = ((poly == 1) / ps) + ((poly == 0) / (1 - ps)) // 
(9,882 missing values generated)

. *Compute the inverse probability Treatment weights (IPTW)
. frame example_a: summarize HAW, detail

                             HAW
-------------------------------------------------------------
      Percentiles      Smallest
 1%     1.043065       1.010741
 5%     1.063813       1.011246
10%     1.079079       1.014947       Obs              60,981
25%      1.12127       1.016076       Sum of Wgt.      60,981

50%     1.254799                      Mean           2.039393
                        Largest       Std. Dev.      2.326552
75%     1.788462       36.64304
90%     3.325771       40.13872       Variance       5.412842
95%     6.587939       40.45366       Skewness       4.807837
99%     12.83064       53.91683       Kurtosis        35.9779

. *keep if inrange(HAW, r(p05), r(p95))
. frame example_a: keep if inrange(HAW, r(p1), r(p99)) //2023-01-08
(11,100 observations deleted)

. 
. frame example_a: cap drop  _st

. frame example_a: cap drop _d

. frame example_a: cap drop _t

. frame example_a: cap drop _t0

. frame example_a: cap drop _start

. 
. frame example_a: cap gen _start= 0

. frame example_a: stset diff1 [pw=HAW], enter(_start) failure(comp==1) //*scale(12) 

     failure event:  comp == 1
obs. time interval:  (0, diff1]
 enter on or after:  time _start
 exit on or before:  failure
            weight:  [pweight=HAW]

------------------------------------------------------------------------------
     59,763  total observations
          0  exclusions
------------------------------------------------------------------------------
     59,763  observations remaining, representing
     16,475  failures in single-record/single-failure data
 223,317.35  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  12.32557

. 
. frame example_a: stsum, by (poly)

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start
             weight:  [pweight=HAW]

         |               Incidence     Number of   |------ Survival time -----|
    poly | Time at risk       rate      subjects        25%       50%       75%
---------+---------------------------------------------------------------------
No polys |  179,687.316   .0870395      53647.68   1.372603         .         .
Polysubs |  234,271.937   .0674141      59753.28   1.761644         .         .
---------+---------------------------------------------------------------------
   Total |  413,959.253   .0759329        113401   1.534247         .         .

</code></pre>
<pre><code>. frame change example_a

. poisson _d i.poly [pw=HAW], irr exposure(_t) vce(rob)

Iteration 0:   log pseudolikelihood = -118000.86  
Iteration 1:   log pseudolikelihood = -118000.86  

Poisson regression                              Number of obs     =     59,763
                                                Wald chi2(1)      =     113.00
Log pseudolikelihood = -118000.86               Prob &gt; chi2       =     0.0000

------------------------------------------------------------------------------------
                   |               Robust
                _d |        IRR   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
              poly |
Polysubstance use  |   .7745235   .0186167   -10.63   0.000     .7388815    .8118848
             _cons |   .0870395   .0018266  -116.33   0.000      .083532    .0906943
            ln(_t) |          1  (exposure)
------------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.

. matrix pois_irr_t0_wgt= r(table)

. *matselrc pois_ir_t0_nowgt pois_ir_t0_nowgt, c(1/1) r(1, 5/6)
. 
. margins i.poly, predict(ir)

Adjusted predictions                            Number of obs     =     59,763
Model VCE    : Robust

Expression   : Predicted incidence rate, predict(ir)

---------------------------------------------------------------------------------------
                      |            Delta-method
                      |     Margin   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
----------------------+----------------------------------------------------------------
                 poly |
No polysubstance use  |   .0870395   .0018266    47.65   0.000     .0834593    .0906196
   Polysubstance use  |   .0674141     .00079    85.34   0.000     .0658658    .0689625
---------------------------------------------------------------------------------------

. matrix pois_ir_t0_wgt= r(table)

. *matselrc pois_ir_t0_wgt pois_ir_t0_wgt, c(1/2) r(1, 5/6)
. local ir_poly_0 : di %6.2f pois_ir_t0_wgt[1,1]

. local ir_poly_0_lo : di %6.2f pois_ir_t0_wgt[2,1]

. local ir_poly_0_up : di %6.2f pois_ir_t0_wgt[3,1]

. *&quot;`=scalar(round(pois_ir_t0_wgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt[2,1]*1000,.01))',`=scalar(round(pois_ir_t0_wgt[3,1]*1000,.01))')&quot;
. scalar ir_poly_001 = &quot;`=scalar(round(pois_ir_t0_wgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt[5,1]*1000,.01))',`=scalar(round(pois_ir_t0_wgt[6,1]*1000,.01))')&quot;

. local ir_poly_1 : di %6.2f pois_ir_t0_wgt[1,2]

. local ir_poly_1_lo : di %6.2f pois_ir_t0_wgt[2,2]

. local ir_poly_1_up : di %6.2f pois_ir_t0_wgt[3,2]

. *&quot;`=scalar(round(pois_ir_t0_wgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt[2,2]*1000,.01))',`=scalar(round(pois_ir_t0_wgt[3,2]*1000,.01))')&quot;
. scalar ir_poly_111 = &quot;`=scalar(round(pois_ir_t0_wgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt[5,2]*1000,.01))',`=scalar(round(pois_ir_t0_wgt[6,2]*1000,.01))')&quot;

. 
. local irr_poly_1 : di %6.2f pois_irr_t0_wgt[1,2]

. local irr_poly_1_lo : di %6.2f pois_irr_t0_wgt[2,2]

. local irr_poly_1_up : di %6.2f pois_irr_t0_wgt[3,2]

. **&quot;`=scalar(round(pois_irr_t0_wgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_wgt[2,1]*1000,.01))',`=scalar(round(pois_irr_t0_wgt[3,1]*1000,.01))')&quot;
. scalar irr_poly011 = &quot;`=scalar(round(pois_irr_t0_wgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_wgt[5,2]*1000,.01))',`=scalar(round(pois_irr_t0_wgt[6,2]*1000,.01))')&quot;

. 
</code></pre>
<pre><code>. *set trace on
. cap noi qui sts test poly

. scalar logrank_chi= round(r(chi2),.01)

. scalar logrank_df= r(df)

. scalar logrank_p_= round(chiprob(r(df),r(chi2)),.001)

. local lr11: di %3.2f logrank_chi

. local lr21: di %1.0f logrank_df

. local lr31: di %5.4f logrank_p_

. scalar logrank_wgt1 = &quot;Cox regression-based test for equality of survival curves: Wald Chi^2(`lr21')=`lr11',p=`lr31'&quot;

. *di logrank_nowgt
. 
. matrix comb_irs2 = (0 \ 0 \ 0 \ 0)

. matrix colnames comb_irs2 = IRs_t0

. matrix rownames comb_irs2 = &quot;No poly: `=scalar(ir_poly_001)'&quot; &quot;Poly: `=scalar(ir_poly_111)'&quot; &quot;IRR: `=scalar(irr_poly011)'&quot; &quot;Logrank: `=scalar(irr_poly011)'&quot;

. esttab matrix(comb_irs) using &quot;prueba_irrs_t0_wgt_tr_comp.html&quot;, replace
(note: file prueba_irrs_t0_wgt_tr_comp.html not found)
(output written to prueba_irrs_t0_wgt_tr_comp.html)

. *set trace off
</code></pre>
<table border="0" width="*">
<tr><td colspan=2><hr></td></tr>
<tr><td>            </td><td>    comb_irs</td></tr>
<tr><td>            </td><td>      IRs_t0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>No poly     </td><td>            </td></tr>
<tr><td>107.47 (95%CI: 104.41,110.53)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Poly        </td><td>            </td></tr>
<tr><td>56.43 (95%CI: 55.33,57.52)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>IRR         </td><td>            </td></tr>
<tr><td>525.04 (95%CI: 507.28,543.4300000000001)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Logrank     </td><td>            </td></tr>
<tr><td>Chi^2(1)=768.07,p=0.0000</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
</table>
<pre><code>. frame example_a: stdescribe, weight

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start
             weight:  [pweight=HAW]

                                   |-------------- per subject --------------|
                         weighted     weighted              weighted
Category                   total        mean         min     median        max
------------------------------------------------------------------------------
no. of subjects        113400.96   
no. of records         113400.96           1           1          1          1

(first) entry time                         0           0          0          0
(final) exit time                   3.650403    .0027322   3.202186   12.32557

subjects with gap              0   
time on gap if gap             0   
time at risk           413959.25    3.650403    .0027322   3.202186   12.32557

failures                31433.13    .2771858           0          0          1
------------------------------------------------------------------------------

. frame change default

. 
</code></pre>
<p>*################### <strong>Time to contact with the justice system</strong></p>
<p>We defined the incidence rates and weights for the time to contact with the justice system</p>
<pre><code>. *comp contact_js
. *stset edad_al_egres_imp, enter(edad_al_ing_1_mod) failure(comp==1) //*scale(12) 
. cap drop  _st

. cap drop _d

. cap drop _t

. cap drop _t0

. cap drop _start

. 
. cap gen _start= 0

. stset diff2, enter(_start) failure(contact_js==1) //*scale(12) 

     failure event:  contact_js == 1
obs. time interval:  (0, diff2]
 enter on or after:  time _start
 exit on or before:  failure

------------------------------------------------------------------------------
     70,863  total observations
          0  exclusions
------------------------------------------------------------------------------
     70,863  observations remaining, representing
     22,287  failures in single-record/single-failure data
 272,564.41  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  12.57176

. 
. stsum, by (poly)

         failure _d:  contact_js == 1
   analysis time _t:  diff2
  enter on or after:  time _start

         |               Incidence     Number of   |------ Survival time -----|
    poly | Time at risk       rate      subjects        25%       50%       75%
---------+---------------------------------------------------------------------
No polys |  66,792.8278   .0541226         18443   5.412414         .         .
Polysubs |  205,771.586   .0907414         52420   2.495617         .         .
---------+---------------------------------------------------------------------
   Total |  272,564.413   .0817678         70863   2.904719         .         .

. 
</code></pre>
<pre><code>. poisson _d i.poly , irr exposure(_t) vce(rob)

Iteration 0:   log pseudolikelihood = -66938.873  
Iteration 1:   log pseudolikelihood = -66938.873  

Poisson regression                              Number of obs     =     70,863
                                                Wald chi2(1)      =     769.90
                                                Prob &gt; chi2       =     0.0000
Log pseudolikelihood = -66938.873               Pseudo R2         =     0.0067

------------------------------------------------------------------------------------
                   |               Robust
                _d |        IRR   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
              poly |
Polysubstance use  |    1.67659   .0312249    27.75   0.000     1.616494    1.738921
             _cons |   .0541226   .0009168  -172.17   0.000     .0523552    .0559496
            ln(_t) |          1  (exposure)
------------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.

. matrix pois_irr_t0_nowgt2= r(table)

. *matselrc pois_ir_t0_nowgt pois_ir_t0_nowgt, c(1/1) r(1, 5/6)
. 
. margins i.poly, predict(ir)

Adjusted predictions                            Number of obs     =     70,863
Model VCE    : Robust

Expression   : Predicted incidence rate, predict(ir)

---------------------------------------------------------------------------------------
                      |            Delta-method
                      |     Margin   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
----------------------+----------------------------------------------------------------
                 poly |
No polysubstance use  |   .0541226   .0009168    59.03   0.000     .0523257    .0559195
   Polysubstance use  |   .0907414   .0007024   129.19   0.000     .0893647     .092118
---------------------------------------------------------------------------------------

. matrix pois_ir_t0_nowgt2= r(table)

. *matselrc pois_ir_t0_nowgt pois_ir_t0_nowgt, c(1/2) r(1, 5/6)
. local ir_poly_0 : di %6.2f pois_ir_t0_nowgt2[1,1]

. local ir_poly_0_lo : di %6.2f pois_ir_t0_nowgt2[2,1]

. local ir_poly_0_up : di %6.2f pois_ir_t0_nowgt2[3,1]

. *&quot;`=scalar(round(pois_ir_t0_nowgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt[2,1]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt[3,1]*1000,.01))')&quot;
. scalar ir_poly_002 = &quot;`=scalar(round(pois_ir_t0_nowgt2[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt2[5,1]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt2[6,1]*1000,.01))')&quot;

. local ir_poly_1 : di %6.2f pois_ir_t0_nowgt2[1,2]

. local ir_poly_1_lo : di %6.2f pois_ir_t0_nowgt2[2,2]

. local ir_poly_1_up : di %6.2f pois_ir_t0_nowgt2[3,2]

. *&quot;`=scalar(round(pois_ir_t0_nowgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt[2,2]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt[3,2]*1000,.01))')&quot;
. scalar ir_poly_112 = &quot;`=scalar(round(pois_ir_t0_nowgt2[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_nowgt2[5,2]*1000,.01))',`=scalar(round(pois_ir_t0_nowgt2[6,2]*1000,.01))')&quot;

. 
. local irr_poly_1 : di %6.2f pois_irr_t0_nowgt2[1,2]

. local irr_poly_1_lo : di %6.2f pois_irr_t0_nowgt2[2,2]

. local irr_poly_1_up : di %6.2f pois_irr_t0_nowgt2[3,2]

. **&quot;`=scalar(round(pois_irr_t0_nowgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_nowgt[2,1]*1000,.01))',`=scalar(round(pois_irr_t0_nowgt[3,1]*1000,.01))')&quot;
. scalar irr_poly012 = &quot;`=scalar(round(pois_irr_t0_nowgt2[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_nowgt2[5,2]*1000,.01))',`=scalar(round(pois_irr_t0_nowgt2[6,2]*1000,.01))')&quot;

. 
</code></pre>
<pre><code>. *set trace on
. cap noi qui sts test poly, logrank

. scalar logrank_chi= round(r(chi2),.01)

. scalar logrank_df= r(df)

. scalar logrank_p_= round(chiprob(r(df),r(chi2)),.001)

. local lr12: di %3.2f logrank_chi

. local lr22: di %1.0f logrank_df

. local lr32: di %5.4f logrank_p_

. scalar logrank_nowgt2= &quot; Chi^2(`lr22')=`lr12',p=`lr32'&quot;

. *di logrank_nowgt
. 
. matrix comb_irs2 = (0 \ 0 \ 0 \ 0)

. matrix colnames comb_irs2 = IRs_t0

. matrix rownames comb_irs2 = &quot;No poly: `=scalar(ir_poly_002)'&quot; &quot;Poly: `=scalar(ir_poly_112)'&quot; &quot;IRR: `=scalar(irr_poly012)'&quot; &quot;Logrank: `=scalar(logrank_nowgt2)'&quot;

. esttab matrix(comb_irs2) using &quot;prueba_irrs_t0_nowgt_contact_js.html&quot;, replace
(note: file prueba_irrs_t0_nowgt_contact_js.html not found)
(output written to prueba_irrs_t0_nowgt_contact_js.html)

. *set trace off
</code></pre>
<table border="0" width="*">
<tr><td colspan=2><hr></td></tr>
<tr><td>            </td><td>   comb_irs2</td></tr>
<tr><td>            </td><td>      IRs_t0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>No poly     </td><td>            </td></tr>
<tr><td>54.12 (95%CI: 52.33,55.92)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Poly        </td><td>            </td></tr>
<tr><td>90.73999999999999 (95%CI: 89.36,92.12)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>IRR         </td><td>            </td></tr>
<tr><td>1676.59 (95%CI: 1616.49,1738.92)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Logrank     </td><td>            </td></tr>
<tr><td>Chi^2(1)=1035.19,p=0.0000</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
</table>
<p>We then computed the data with weights</p>
<pre><code>. *https://www.statalist.org/forums/forum/general-stata-discussion/general/1600895-survival-model-stpm2-using-previously-estimated-weights
. *pweights are Stata’s sampling weights—the inverse of the probability that the subject was chosen from the population.
. 
. stipw (logit poly sus_prin_mod fr_sus_prin edad_al_ing_1 edad_ini_cons sex_enc esc_rec ten_viv dg_cie_10_rec n_off_vio n_off_acq n_off_sud clas porc_pobr macrozone), distribution(weibull) ipwtype(stabilised) vce(r
&gt; obust) genweight(ipw_wgt2) //*edad_al_ing_1 df(10)  ten_viv
9882 observations have missing treatment and/or missing confounder values and/or _st = 0.
These observations are excluded from the analysis, see variable _stipw_flag

Fitting logistic regression to obtain denominator for weights

Iteration 0:   log likelihood = -35519.999  
Iteration 1:   log likelihood = -29792.782  
Iteration 2:   log likelihood = -29570.649  
Iteration 3:   log likelihood = -29570.242  
Iteration 4:   log likelihood = -29570.242  
Fitting second logistic regression with no confounders to obtain numerator for stabilised weights

Iteration 0:   log likelihood = -35519.999  
Iteration 1:   log likelihood = -35519.999  

Fitting weighted survival model to obtain point estimates

         failure _d:  contact_js == 1
   analysis time _t:  diff2
  enter on or after:  time _start
             weight:  [pweight=ipw_wgt2]

Fitting constant-only model:

Iteration 0:   log pseudolikelihood = -56613.048
Iteration 1:   log pseudolikelihood = -56584.745
Iteration 2:   log pseudolikelihood = -56584.738
Iteration 3:   log pseudolikelihood = -56584.738

Fitting full model:

Iteration 0:   log pseudolikelihood = -56584.738  
Iteration 1:   log pseudolikelihood = -56584.293  
Iteration 2:   log pseudolikelihood = -56584.293  

Displaying weighted survival model with Robust standard errors

Weibull PH regression                           Number of obs     =     60,981
                                                Wald chi2(1)      =       0.38
Log pseudolikelihood = -56584.293               Prob &gt; chi2       =     0.5370

------------------------------------------------------------------------------
             |               Robust
          _t | Haz. Ratio   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        poly |   1.015887   .0259395     0.62   0.537     .9662982    1.068021
       _cons |   .0858533   .0020809  -101.29   0.000     .0818701    .0900302
-------------+----------------------------------------------------------------
       /ln_p |  -.0479137   .0056126    -8.54   0.000    -.0589141   -.0369132
-------------+----------------------------------------------------------------
           p |   .9532161     .00535                      .9427878    .9637597
         1/p |    1.04908    .005888                      1.037603    1.060684
------------------------------------------------------------------------------
Note: _cons estimates baseline hazard.

</code></pre>
<p>We calculated the incidence rate.</p>
<pre><code>. cap drop  _st

. cap drop _d

. cap drop _t

. cap drop _t0

. cap drop _start

. 
. cap gen _start= 0

. 
. *The stset command is used for survival analysis to set the time variable and specify the structure of the dataset, while the [pw] option specifies the weights for each observation in the analysis.
. stset diff2 [pw=ipw_wgt2], enter(_start) failure(contact_js==1) //*scale(12) 

     failure event:  contact_js == 1
obs. time interval:  (0, diff2]
 enter on or after:  time _start
 exit on or before:  failure
            weight:  [pweight=ipw_wgt2]

------------------------------------------------------------------------------
     70,863  total observations
      9,882  weights invalid                                    PROBABLE ERROR
------------------------------------------------------------------------------
     60,981  observations remaining, representing
     17,942  failures in single-record/single-failure data
 221,228.05  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  11.91507

. 
. stsum, by (poly)

         failure _d:  contact_js == 1
   analysis time _t:  diff2
  enter on or after:  time _start
             weight:  [pweight=ipw_wgt2]

         |               Incidence     Number of   |------ Survival time -----|
    poly | Time at risk       rate      subjects        25%       50%       75%
---------+---------------------------------------------------------------------
No polys |  60,464.9445   .0803327      17835.22   3.270333         .         .
Polysubs |   168,424.47   .0811235       44401.7   2.942625         .         .
---------+---------------------------------------------------------------------
   Total |  228,889.415   .0809146      62236.92   3.038083         .         .

</code></pre>
<pre><code>. stdescribe, weight

         failure _d:  contact_js == 1
   analysis time _t:  diff2
  enter on or after:  time _start
             weight:  [pweight=ipw_wgt2]

                                   |-------------- per subject --------------|
                         weighted     weighted              weighted
Category                   total        mean         min     median        max
------------------------------------------------------------------------------
no. of subjects        62236.924   
no. of records         62236.924           1           1          1          1

(first) entry time                         0           0          0          0
(final) exit time                   3.677711    .0152209   3.245191   11.91507

subjects with gap              0   
time on gap if gap             0   
time at risk           228889.41    3.677711    .0152209   3.245191   11.91507

failures               18520.496    .2975805           0          0          1
------------------------------------------------------------------------------

</code></pre>
<p>Given the possible errors pointed out by stata in the weights, we calculated the IPW manually</p>
<pre><code>. cap qui noi drop ps2
variable ps2 not found

. cap qui noi drop HAW2
variable HAW2 not found

. 
. cap qui noi frame drop example_b
frame example_b not found

. frame copy default example_b

. frame example_b: logistic poly i.sus_prin_mod i.fr_sus_prin edad_al_ing_1 edad_ini_cons i.sex_enc i.esc_rec i.ten_viv i.dg_cie_10_rec i.n_off_vio i.n_off_acq i.n_off_sud i.clas porc_pobr i.macrozone, nolog 

Logistic regression                             Number of obs     =     60,981
                                                LR chi2(27)       =   13933.31
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -28553.345                     Pseudo R2         =     0.1961

-------------------------------------------------------------------------------------------------------------
                                       poly | Odds Ratio   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
--------------------------------------------+----------------------------------------------------------------
                               sus_prin_mod |
                     Cocaine hydrochloride  |   4.314091   .1405755    44.86   0.000     4.047182    4.598603
                             Cocaine paste  |   3.711172   .1012944    48.04   0.000     3.517856    3.915112
                                 Marijuana  |   2.400394    .114662    18.33   0.000      2.18586    2.635983
                                     Other  |   2.542306   .2087736    11.36   0.000     2.164349    2.986264
                                            |
                                fr_sus_prin |
                        2 to 3 days a week  |   1.356489   .0564807     7.32   0.000     1.250186    1.471832
                        4 to 6 days a week  |    1.32917   .0600495     6.30   0.000     1.216536    1.452233
                                     Daily  |   1.490526   .0613763     9.69   0.000     1.374957    1.615809
                    Less than 1 day a week  |   .8239853    .047071    -3.39   0.001     .7367051    .9216058
                                            |
                              edad_al_ing_1 |   .9638512   .0010522   -33.73   0.000     .9617912    .9659156
                              edad_ini_cons |   .9483434    .001846   -27.25   0.000     .9447321    .9519685
                                            |
                                    sex_enc |
                                     Women  |   .8470801   .0217369    -6.47   0.000     .8055302    .8907732
                                            |
                                    esc_rec |
           2-Completed high school or less  |   .7875212   .0240585    -7.82   0.000     .7417513    .8361153
        3-Completed primary school or less  |   .6042393   .0202336   -15.04   0.000     .5658555    .6452268
                                            |
                                    ten_viv |
                                    Others  |   .8918871   .1063883    -0.96   0.337     .7059512    1.126795
Owner/Transferred dwellings/Pays Dividends  |   .8371567   .0862349    -1.73   0.084     .6841087    1.024444
                                   Renting  |   .9754207   .1019295    -0.24   0.812      .794773    1.197129
         Stays temporarily with a relative  |   1.040631   .1072828     0.39   0.699     .8502428    1.273651
                                            |
                              dg_cie_10_rec |
           Diagnosis unknown (under study)  |   1.254299   .0378978     7.50   0.000     1.182177     1.33082
              With psychiatric comorbidity  |   1.450683   .0339206    15.91   0.000       1.3857    1.518713
                                            |
                                1.n_off_vio |   .9904797   .0279471    -0.34   0.735     .9371913    1.046798
                                1.n_off_acq |   1.199716   .0361672     6.04   0.000     1.130883    1.272738
                                1.n_off_sud |   1.096785   .0317454     3.19   0.001     1.036297    1.160803
                                            |
                                       clas |
                                     Mixed  |   .6456518   .0219471   -12.87   0.000      .604038    .6901326
                                     Rural  |   .5185464   .0193394   -17.61   0.000      .481994    .5578707
                                            |
                                  porc_pobr |   15.61556   2.418692    17.74   0.000     11.52697    21.15437
                                            |
                                  macrozone |
                                     North  |   1.666094   .0571907    14.87   0.000      1.55769    1.782042
                                     South  |   .8639278   .0297692    -4.24   0.000     .8075078    .9242897
                                            |
                                      _cons |   8.320871   1.037526    16.99   0.000     6.516776    10.62441
-------------------------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.

. 
. frame example_b: predict double ps2 //ps = propensity score
(option pr assumed; Pr(poly))
(9,882 missing values generated)

. 
. frame example_b: gen double HAW2 = ((poly == 1) / ps2) + ((poly == 0) / (1 - ps2)) // 
(9,882 missing values generated)

. *Compute the inverse probability Treatment weights (IPTW)
. frame example_b: summarize HAW2, detail

                            HAW2
-------------------------------------------------------------
      Percentiles      Smallest
 1%     1.043065       1.010741
 5%     1.063813       1.011246
10%     1.079079       1.014947       Obs              60,981
25%      1.12127       1.016076       Sum of Wgt.      60,981

50%     1.254799                      Mean           2.039393
                        Largest       Std. Dev.      2.326552
75%     1.788462       36.64304
90%     3.325771       40.13872       Variance       5.412842
95%     6.587939       40.45366       Skewness       4.807837
99%     12.83064       53.91683       Kurtosis        35.9779

. *keep if inrange(HAW, r(p05), r(p95))
. frame example_b: keep if inrange(HAW2, r(p1), r(p99)) //2023-01-08
(11,100 observations deleted)

. 
. frame example_b: cap drop  _st

. frame example_b: cap drop _d

. frame example_b: cap drop _t

. frame example_b: cap drop _t0

. frame example_b: cap drop _start

. 
. frame example_b: cap gen _start= 0

. frame example_b: stset diff2 [pw=HAW2], enter(_start) failure(contact_js==1) //*scale(12) 

     failure event:  contact_js == 1
obs. time interval:  (0, diff2]
 enter on or after:  time _start
 exit on or before:  failure
            weight:  [pweight=HAW2]

------------------------------------------------------------------------------
     59,763  total observations
          0  exclusions
------------------------------------------------------------------------------
     59,763  observations remaining, representing
     17,267  failures in single-record/single-failure data
 217,349.13  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  11.91507

. 
. frame example_b: stsum, by (poly)

         failure _d:  contact_js == 1
   analysis time _t:  diff2
  enter on or after:  time _start
             weight:  [pweight=HAW2]

         |               Incidence     Number of   |------ Survival time -----|
    poly | Time at risk       rate      subjects        25%       50%       75%
---------+---------------------------------------------------------------------
No polys |  182,624.916    .072249      53647.68   3.741665         .         .
Polysubs |  226,642.837   .0802631      59753.28   3.016474         .         .
---------+---------------------------------------------------------------------
   Total |  409,267.754    .076687        113401   3.348228         .         .

</code></pre>
<pre><code>. frame change example_b 

. poisson _d i.poly [pw=HAW2], irr exposure(_t) vce(rob)

Iteration 0:   log pseudolikelihood = -97335.671  
Iteration 1:   log pseudolikelihood =  -97335.67  

Poisson regression                              Number of obs     =     59,763
                                                Wald chi2(1)      =      18.13
Log pseudolikelihood =  -97335.67               Prob &gt; chi2       =     0.0000

------------------------------------------------------------------------------------
                   |               Robust
                _d |        IRR   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
              poly |
Polysubstance use  |   1.110924   .0274452     4.26   0.000     1.058414     1.16604
             _cons |    .072249   .0016506  -115.02   0.000     .0690852    .0755576
            ln(_t) |          1  (exposure)
------------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.

. matrix pois_irr_t0_wgt3= r(table)

. *matselrc pois_ir_t0_nowgt pois_ir_t0_nowgt, c(1/1) r(1, 5/6)
. 
. margins i.poly, predict(ir)

Adjusted predictions                            Number of obs     =     59,763
Model VCE    : Robust

Expression   : Predicted incidence rate, predict(ir)

---------------------------------------------------------------------------------------
                      |            Delta-method
                      |     Margin   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
----------------------+----------------------------------------------------------------
                 poly |
No polysubstance use  |    .072249   .0016506    43.77   0.000     .0690139     .075484
   Polysubstance use  |   .0802631   .0007547   106.36   0.000      .078784    .0817422
---------------------------------------------------------------------------------------

. matrix pois_ir_t0_wgt3= r(table)

. *matselrc pois_ir_t0_wgt pois_ir_t0_wgt, c(1/2) r(1, 5/6)
. local ir_poly_0 : di %6.2f pois_ir_t0_wgt3[1,1]

. local ir_poly_0_lo : di %6.2f pois_ir_t0_wgt3[2,1]

. local ir_poly_0_up : di %6.2f pois_ir_t0_wgt3[3,1]

. *&quot;`=scalar(round(pois_ir_t0_wgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt[2,1]*1000,.01))',`=scalar(round(pois_ir_t0_wgt[3,1]*1000,.01))')&quot;
. scalar ir_poly_003 = &quot;`=scalar(round(pois_ir_t0_wgt3[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt3[5,1]*1000,.01))',`=scalar(round(pois_ir_t0_wgt3[6,1]*1000,.01))')&quot;

. local ir_poly_1 : di %6.2f pois_ir_t0_wgt3[1,2]

. local ir_poly_1_lo : di %6.2f pois_ir_t0_wgt3[2,2]

. local ir_poly_1_up : di %6.2f pois_ir_t0_wgt3[3,2]

. *&quot;`=scalar(round(pois_ir_t0_wgt[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt[2,2]*1000,.01))',`=scalar(round(pois_ir_t0_wgt[3,2]*1000,.01))')&quot;
. scalar ir_poly_113 = &quot;`=scalar(round(pois_ir_t0_wgt3[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_ir_t0_wgt3[5,2]*1000,.01))',`=scalar(round(pois_ir_t0_wgt3[6,2]*1000,.01))')&quot;

. 
. local irr_poly_1 : di %6.2f pois_irr_t0_wgt3[1,2]

. local irr_poly_1_lo : di %6.2f pois_irr_t0_wgt3[2,2]

. local irr_poly_1_up : di %6.2f pois_irr_t0_wgt3[3,2]

. **&quot;`=scalar(round(pois_irr_t0_wgt[1,1]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_wgt[2,1]*1000,.01))',`=scalar(round(pois_irr_t0_wgt[3,1]*1000,.01))')&quot;
. scalar irr_poly013 = &quot;`=scalar(round(pois_irr_t0_wgt3[1,2]*1000,.01))' (95%CI: `=scalar(round(pois_irr_t0_wgt3[5,2]*1000,.01))',`=scalar(round(pois_irr_t0_wgt3[6,2]*1000,.01))')&quot;

. 
</code></pre>
<pre><code>. *set trace on
. cap noi qui sts test poly

. scalar logrank_chi= round(r(chi2),.01)

. scalar logrank_df= r(df)

. scalar logrank_p_= round(chiprob(r(df),r(chi2)),.001)

. local lr13: di %3.2f logrank_chi

. local lr23: di %1.0f logrank_df

. local lr33: di %5.4f logrank_p_

. scalar logrank_wgt3 = &quot;Cox regression-based test for equality of survival curves: Wald Chi^2(`lr23')=`lr13',p=`lr33'&quot;

. *di logrank_nowgt
. 
. matrix comb_irs3 = (0 \ 0 \ 0 \ 0)

. matrix colnames comb_irs3 = IRs_t0

. matrix rownames comb_irs3 = &quot;No poly: `=scalar(ir_poly_003)'&quot; &quot;Poly: `=scalar(ir_poly_113)'&quot; &quot;IRR: `=scalar(irr_poly013)'&quot; &quot;Logrank: `=scalar(logrank_wgt3)'&quot;

. esttab matrix(comb_irs3) using &quot;prueba_irrs_t0_wgt_contact_js.html&quot;, replace
(note: file prueba_irrs_t0_wgt_contact_js.html not found)
(output written to prueba_irrs_t0_wgt_contact_js.html)

. *set trace off
</code></pre>
<table border="0" width="*">
<tr><td colspan=2><hr></td></tr>
<tr><td>            </td><td>   comb_irs3</td></tr>
<tr><td>            </td><td>      IRs_t0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>No poly     </td><td>            </td></tr>
<tr><td>72.25 (95%CI: 69.01000000000001,75.48)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Poly        </td><td>            </td></tr>
<tr><td>80.26000000000001 (95%CI: 78.78,81.73999999999999)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>IRR         </td><td>            </td></tr>
<tr><td>1110.92 (95%CI: 1058.41,1166.04)</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>Logrank     </td><td>            </td></tr>
<tr><td>Cox regression-based test for equality of survival curves: Wald Chi^2(1)=36.20,p=0.0000</td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
</table>
<pre><code>. frame example_b: stdescribe, weight

         failure _d:  contact_js == 1
   analysis time _t:  diff2
  enter on or after:  time _start
             weight:  [pweight=HAW2]

                                   |-------------- per subject --------------|
                         weighted     weighted              weighted
Category                   total        mean         min     median        max
------------------------------------------------------------------------------
no. of subjects        113400.96   
no. of records         113400.96           1           1          1          1

(first) entry time                         0           0          0          0
(final) exit time                   3.609033    .0152209   3.217474   11.91507

subjects with gap              0   
time on gap if gap             0   
time at risk           409267.75    3.609033    .0152209   3.217474   11.91507

failures               31385.522    .2767659           0          0          1
------------------------------------------------------------------------------

. frame change default

</code></pre>
<pre><code>. frame change default

</code></pre>
<p><strong>##############################</strong></p>
<h3><a href="#get-weighted-balance-tables-and-proportional-hazards-from-the-selected-weights" id="get-weighted-balance-tables-and-proportional-hazards-from-the-selected-weights">GET WEIGHTED BALANCE TABLES AND PROPORTIONAL HAZARDS FROM THE SELECTED WEIGHTS</a></h3>
<p><strong>##############################</strong></p>
<pre><code>. quietly tab sus_prin_mod, generate(sus_prin_mod_cat) 

. quietly tab fr_sus_prin, gen(fr_sus_prin_cat)

. 
. quietly tab esc_rec, gen(esc_rec_tab) 

. quietly tab ten_viv, gen(ten_viv_tab) 

. quietly tab dg_cie_10_rec, gen(dg_cie_10_rec_tab) 

. quietly tab clas, gen(clas) 

. quietly tab macrozone, gen(macrozone_cat) 

. 
. lab var macrozone_cat2 &quot;Macrozone (North)&quot;  

. lab var macrozone_cat3 &quot;Macrozone (South)&quot;  

. lab var clas2 &quot;Municipallity of Residence Classification (Mixed)&quot;

. lab var clas3 &quot;Municipallity of Residence Classification (Rural)&quot;

. lab var sex_enc &quot;Sex (Women)&quot;

. lab var n_off_vio &quot;Pre-tr. criminality (Violent)&quot;

. lab var n_off_acq &quot;Pre-tr. criminality (Acquisitve)&quot;

. lab var n_off_sud &quot;Pre-tr. criminality (substance-related)&quot;

. lab var dg_cie_10_rec_tab2 &quot;Psychiatric comorbidity ICD-10 (Diagnosis under study)&quot;

. lab var dg_cie_10_rec_tab3 &quot;Psychiatric comorbidity ICD-10 (Diagnosis under study)&quot;

. lab var ten_viv_tab1 &quot;Housing situation (Illegal Settlement)&quot;

. lab var ten_viv_tab3 &quot;Housing situation (owner/Tr. dwellings/Pays divide)&quot;

. lab var ten_viv_tab4 &quot;Housing situation (Renting)&quot;

. lab var ten_viv_tab5 &quot;Housing situation (Stays temporary w/ a relative)&quot;

. lab var esc_rec_tab2 &quot;Educational Attainment (Complete high-school or less)&quot;

. lab var esc_rec_tab3 &quot;Educational Attainment (Complete high-school or less)&quot;

. lab var edad_al_ing_1 &quot;Admission Age&quot;

. lab var edad_ini_cons &quot;Substance use onset age&quot;

. lab var sus_prin_mod_cat1 &quot;Primary`=char(9)'Subs`=char(9)'at`=char(9)'Adm.`=char(9)'(Alcohol)&quot; //asdsa

. lab var sus_prin_mod_cat2 &quot;Primary Subs at Adm. (Snort cocaine)&quot;

. lab var sus_prin_mod_cat3 &quot;Primary Subs at Adm. (Cocaine paste base)&quot;

. lab var sus_prin_mod_cat4 &quot;Primary Subs at Adm .(Marijuana)&quot;

. lab var fr_sus_prin_cat1 &quot;Primary Subs use Freq (1 day a week or more)&quot;

. lab var fr_sus_prin_cat2 &quot;Primary Subs use Freq (2-3 days a week or more)&quot;

. lab var fr_sus_prin_cat3 &quot;Primary Subs use Freq (4-6 days a week or more)&quot;

. lab var fr_sus_prin_cat4 &quot;Primary Subs use Freq (Daily)&quot;

. 
.                                                                                                                 
. logistic poly sus_prin_mod_cat1 sus_prin_mod_cat2 sus_prin_mod_cat3 sus_prin_mod_cat4 ///
&gt;                                                         fr_sus_prin_cat1 fr_sus_prin_cat2 fr_sus_prin_cat3 fr_sus_prin_cat4 /// 
&gt;                                                         edad_al_ing_1 edad_ini_cons ///
&gt;                                                         sex_enc ///
&gt;                                                         esc_rec_tab2 esc_rec_tab3 /// 
&gt;                                                         ten_viv_tab1 ten_viv_tab3 ten_viv_tab4 ten_viv_tab5 /// 
&gt;                                                         dg_cie_10_rec_tab2 dg_cie_10_rec_tab3 /// 
&gt;                                                         n_off_vio  /// 
&gt;                                                         n_off_acq  /// 
&gt;                                                         n_off_sud  /// 
&gt;                                                         clas2 clas3 /// 
&gt;                                                         porc_pobr ///
&gt;                                                         macrozone_cat2 macrozone_cat3, nolog 

Logistic regression                             Number of obs     =     60,981
                                                LR chi2(27)       =   13933.31
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -28553.345                     Pseudo R2         =     0.1961

------------------------------------------------------------------------------------
              poly | Odds Ratio   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
 sus_prin_mod_cat1 |   .3933437   .0323013   -11.36   0.000     .3348665    .4620327
 sus_prin_mod_cat2 |   1.696921   .1451577     6.18   0.000     1.434988    2.006665
 sus_prin_mod_cat3 |   1.459766   .1218049     4.53   0.000     1.239533     1.71913
 sus_prin_mod_cat4 |   .9441799   .0870699    -0.62   0.533     .7880596    1.131229
  fr_sus_prin_cat1 |   1.213614   .0693289     3.39   0.001     1.085063    1.357395
  fr_sus_prin_cat2 |   1.646254   .0782354    10.49   0.000     1.499841    1.806961
  fr_sus_prin_cat3 |     1.6131    .081531     9.46   0.000     1.460962    1.781081
  fr_sus_prin_cat4 |   1.808923   .0847687    12.65   0.000     1.650181    1.982936
     edad_al_ing_1 |   .9638512   .0010522   -33.73   0.000     .9617912    .9659156
     edad_ini_cons |   .9483434    .001846   -27.25   0.000     .9447321    .9519685
           sex_enc |   .8470801   .0217369    -6.47   0.000     .8055302    .8907732
      esc_rec_tab2 |   .7875212   .0240585    -7.82   0.000     .7417513    .8361153
      esc_rec_tab3 |   .6042393   .0202336   -15.04   0.000     .5658555    .6452268
      ten_viv_tab1 |   1.121218    .133744     0.96   0.337     .8874726    1.416529
      ten_viv_tab3 |   .9386353   .0607476    -0.98   0.328     .8268142    1.065579
      ten_viv_tab4 |   1.093659   .0734767     1.33   0.183     .9587265    1.247583
      ten_viv_tab5 |   1.166774   .0758046     2.37   0.018     1.027271    1.325223
dg_cie_10_rec_tab2 |   1.254299   .0378978     7.50   0.000     1.182177     1.33082
dg_cie_10_rec_tab3 |   1.450683   .0339206    15.91   0.000       1.3857    1.518713
         n_off_vio |   .9904797   .0279471    -0.34   0.735     .9371913    1.046798
         n_off_acq |   1.199716   .0361672     6.04   0.000     1.130883    1.272738
         n_off_sud |   1.096785   .0317454     3.19   0.001     1.036297    1.160803
             clas2 |   .6456518   .0219471   -12.87   0.000      .604038    .6901326
             clas3 |   .5185464   .0193394   -17.61   0.000      .481994    .5578707
         porc_pobr |   15.61556   2.418692    17.74   0.000     11.52697    21.15437
    macrozone_cat2 |   1.666094   .0571907    14.87   0.000      1.55769    1.782042
    macrozone_cat3 |   .8639278   .0297692    -4.24   0.000     .8075078    .9242897
             _cons |   18.35276   2.432124    21.96   0.000     14.15466    23.79597
------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.

. predict double ps //ps = propensity score
(option pr assumed; Pr(poly))
(9,882 missing values generated)

. gen double HAW = ((poly == 1) / ps) + ((poly == 0) / (1 - ps)) // 
(9,882 missing values generated)

. *Compute the inverse probability Treatment weights (IPTW)
. summarize HAW, detail

                             HAW
-------------------------------------------------------------
      Percentiles      Smallest
 1%     1.043065       1.010741
 5%     1.063813       1.011246
10%     1.079079       1.014947       Obs              60,981
25%      1.12127       1.016076       Sum of Wgt.      60,981

50%     1.254799                      Mean           2.039393
                        Largest       Std. Dev.      2.326552
75%     1.788462       36.64304
90%     3.325771       40.13872       Variance       5.412842
95%     6.587939       40.45366       Skewness       4.807837
99%     12.83064       53.91683       Kurtosis        35.9779

. //ci mean HAW //2022-01-08 does not work well, many out
. keep if inrange(HAW, r(p1), r(p99))
(11,100 observations deleted)

. //keep if inrange(HAW, r(lb), r(ub))
. 
. cap drop  _st

. cap drop _d

. cap drop _t

. cap drop _t0

. cap drop _start

. 
. cap gen _start= 0

. stset diff1 [pw=HAW], enter(_start) failure(comp==1) id(id) //*scale(12) 

                id:  id
     failure event:  comp == 1
obs. time interval:  (diff1[_n-1], diff1]
 enter on or after:  time _start
 exit on or before:  failure
            weight:  [pweight=HAW]

------------------------------------------------------------------------------
     59,763  total observations
          0  exclusions
------------------------------------------------------------------------------
     59,763  observations remaining, representing
     59,763  subjects
     16,475  failures in single-failure-per-subject data
 223,317.35  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  12.32557

. 
. stsum, by (poly)

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start
                 id:  id
             weight:  [pweight=HAW]

         |               Incidence     Number of   |------ Survival time -----|
    poly | Time at risk       rate      subjects        25%       50%       75%
---------+---------------------------------------------------------------------
No polys |  179,687.316   .0870395      53647.68   1.372603         .         .
Polysubs |  234,271.937   .0674141      59753.28   1.761644         .         .
---------+---------------------------------------------------------------------
   Total |  413,959.253   .0759329        113401   1.534247         .         .

. scalar ir_total= round(r(ir),.01) 

. global ir_total= ir_total

</code></pre>
<p>We explored the inicidence rate ratios (IRR) of polysubstance use.</p>
<pre><code>. stptime, title(person-years) per(1000) by(poly)

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start
                 id:  id
             weight:  [pweight=HAW]

      poly | person-years   Failures        Rate   [95% Conf. Interval]
-----------+-----------------------------------------------------------
 No poly~e |    179687.32    15639.9   87.039487   83.53578    90.69968
 Polysub~e |    234271.94    15793.2   67.414129   65.88591    68.98316
-----------+-----------------------------------------------------------
     Total |    413959.25    31433.1    75.93291   74.21936    77.69024

Note: The jackknife was used to calculate confidence intervals.

. 
. stmh poly

         failure _d:  comp == 1
   analysis time _t:  diff1
  enter on or after:  time _start
                 id:  id
             weight:  [pweight=HAW]

Mantel-Haenszel estimate of the rate ratio
  comparing poly==1 vs. poly==0

------------------------------------------------------------------------
    Rate ratio         chi2         P&gt;chi2          [95% Conf. Interval]
------------------------------------------------------------------------
         0.775       515.80         0.0000              0.758      0.792
------------------------------------------------------------------------
Warning: pweights used; confidence intervals and p-values may be wrong.

. scalar poly_b_rr= round( r(rratio), .01)

. scalar poly_b_rr_lb= round(r(lb),.01) 

. scalar poly_b_rr_ub= round(r(ub),.01) 

. local ir1b= poly_b_rr

. local ir2b= poly_b_rr_lb

. local ir3b= poly_b_rr_ub

. global poly2_irr &quot; `title': IRR: `ir1b' (95%IC `ir2b' - `ir3b') &quot;

. scalar exp1= &quot;`poly2_irr'&quot;

</code></pre>
<ul>
<li>The weighted IRR of treatment completion was  : IRR: .77 (95%IC .76 - .79)  per 1,000 person-years</li>
</ul>
<pre><code>. 
. *set trace on
. local stname `&quot; &quot;2_1&quot; &quot;' 

. local titl `&quot; &quot;Poly vs No-Poly&quot; &quot;' 

. foreach s of local stname {
  2.         gettoken title titl: titl
  3. cap noi qui ir _d poly _t
  4. scalar ir2_`s' =round(r(irr),.01)
  5. *di ir_`s'
. scalar ir2_`s'_lb =round(r(lb_irr),.01) 
  6. *di ir_`s'_lb
. scalar ir2_`s'_ub =round(r(ub_irr),.01)
  7. *di ir_`s'_ub
. local ir12a= ir2_`s'
  8. local ir22a= ir2_`s'_lb
  9. local ir32a= ir2_`s'_ub
 10. *di  in gr _col(13) &quot; `title': IRR `ir1' (IC 95% `ir2' - `ir3') &quot;
. global irr2_`s' &quot; `title': IRR (non weighted): `ir12a' (IC 95% `ir22a' - `ir32a') &quot;
 11. global ir2_`s' &quot;`ir1' (IC 95% `ir2' - `ir3')&quot;
 12. }       

</code></pre>
<ul>
<li>Poly vs No-Poly: IRR (non weighted): .5 (IC 95% .49 - .52)</li>
</ul>
<pre><code>. matrix comb_irs6 = (0 \ 0 )

. matrix colnames comb_irs6 = IRRs_t0

. matrix rownames comb_irs6 = &quot;IRR weighted: `poly2_irr'&quot; &quot;IRR non qweighted: `irr2_2_1'&quot; 

. esttab matrix(comb_irs6) using &quot;prueba_irrs_t0_wgt_tr_comp2.html&quot;, replace
(note: file prueba_irrs_t0_wgt_tr_comp2.html not found)
(output written to prueba_irrs_t0_wgt_tr_comp2.html)

. *set trace off
</code></pre>
<table border="0" width="*">
<tr><td colspan=2><hr></td></tr>
<tr><td>            </td><td>   comb_irs6</td></tr>
<tr><td>            </td><td>     IRRs_t0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>IRR weighted</td><td>            </td></tr>
<tr><td>r1          </td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><td>IRR non qweighted</td><td>            </td></tr>
<tr><td>r2          </td><td>           0</td></tr>
<tr><td colspan=2><hr></td></tr>
</table>
