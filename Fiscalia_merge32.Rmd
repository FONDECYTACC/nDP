---
title: "Chilean prosecutor's office Data merge (Step 3.2)"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  distill::distill_article:
    code_folding: true
    fig_height: 6
    fig_width: 8
    theme: flatly
    toc: yes
    toc_depth: 5
    toc_float: yes
    output_dir: "docs"
  toc_float:
    collapsed: false
    smooth_scroll: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 

```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }

.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }

.centrado {
    text-align: center;
}

.table.center {
    margin-left:auto; 
    margin-right:auto;
  }

/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/

/* Applies to outputs that are not code other than R*/

pre {
  overflow-x: auto !important;
}
pre code {
  word-wrap: normal !important;
  white-space: pre !important;
}
/*
pre:not(.sourceCode) { 
  white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence  */
  font-size: 10px !important;
  line-height: 50% !important;
}

body{ /* Normal  */
      text-align: justify;
  }

.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: auto; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}

.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}

.pandoc-table { /* Should add !important; but it seems no necessary  */
  margin-left:auto; /* To center */
  margin-right:auto;
  border-collapse: collapse;
  table-layout: auto;
  font-size: 11px;
  overflow-y: auto;
  max-height:450px !important;
  white-space: nowrap;
  overflow-x: auto; 
  width:450px;
}

.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}

.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0px;
}

.pandoc-table caption {
    text-align: left !important;
    font-size: 11px !important;
}

.controlly{
    overflow-y:scroll;
    height:350px;
    overflow-x: scroll; 
}

</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```

```{r prev-setup, include = FALSE, cache=T, error=T}
rm(list=ls());gc()
if(!grepl("4.1.2",R.version.string)){stop("Different version (must be 4.1.2)")}
path<-getwd()#we define it again later in setup chunk
if (grepl("CISS Fondecyt",path)==T){
    try(setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)"));load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/12.Rdata")
  } else if (grepl("andre",path)==T){
    try(setwd('C:/Users/andre/Desktop/SUD_CL/'));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/12.Rdata")
  } else if (grepl("E:",path)==T){
    try(setwd("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/SUD_CL/"));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/12.Rdata")
  } else {
    try(setwd(paste0(path)));load(paste0(gsub("SUD_CL","",gsub("2022","2019",path)),"/12.Rdata"))
  }
```

```{r setup, include = FALSE, cache=T, error=T, echo=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(try(dplyr::ungroup(x)))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  

if(!require(pacman)){install.packages("pacman")}
if(!require(devtools)){install.packages("devtools", type = "win.binary", dependencies=T)}

pacman::p_load(APCtools, ggpattern, withr, boot, matrixStats, knitr, tidyr, stringi,stringr, ggplot2, Hmisc, kableExtra, plotly, janitor, rbokeh, zoo, broom, sqldf, devtools, codebook, data.table, panelr, RColorBrewer, lsmeans, finalfit, ggiraph, sf, treemapify, dplyr, tidyverse, epiR, survminer, ggfortify, survMisc, foreign, reshape2, stargazer, tableone, MatchIt, cobalt, eha, igraph, Amelia, DiagrammeR, DiagrammeRsvg, rsvg, mstate, htmltools, webshot, flexsurv, muhaz, Metrics, rpivotTable, caret, polycor, ClusterR, flextable, ggstatsplot, ggside, daff, explore, sjPlot, compareGroups, job, missForest, showtext, ggpattern, distill, showtext, googleVis, tidylog, magick, dlookr, easystats, tidylog, install=F)
try(webshot::install_phantomjs())

if(!require(bpmn)){try(devtools::install_github("bergant/bpmn",upgrade =F))}

#easystats::install_suggested()


options(scipen=2) #display numbers rather scientific number

#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("stulacy/multistateutils", build_vignettes=TRUE, upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

fitstats.flexsurvreg = function(x){
  ll = x$loglik
  aic = x$AIC
  k = length(x$coefficients)
  n = sum(x$data$m["(weights)"])
  aicc = aic + ((2 * k) * (k + 1) / (n - k - 1))
  bic = - 2 * ll + (k * log(n))
  data.frame(
   Df = k,
    "n2ll" = -2 * ll,
    AIC = aic,
    AICc = aicc,
    BIC = bic
  )
}


if(.Platform$OS.type == "windows") withAutoprint({
  memory.size()
  memory.size(TRUE)
  memory.limit()
})
memory.limit(size=56000)

path<-dirname(rstudioapi::getSourceEditorContext()$path)

options(knitr.kable.NA = '')

#to format rows in bold
format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  # one * for italics, two ** for bold
  map <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  

  for (r in rows){
    for(c in cols){

      # Make sure values are not factors
      df[[c]] <- as.character( df[[c]])

      # Update formatting
      df[r, c] <- ifelse(nchar(df[r, c])==0,"",paste0(markup, gsub(" ", "", df[r, c]), markup))
    }
  }

  return(df)
}
#To produce line breaks in messages and warnings
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('<div class="message">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
)
```

# Explore missing/aberrant values

::: controlly
```{r 1-exp-miss-val, echo=T, fig.align='center',layout="l-body-outset", message=T, error=T, eval=T}
#- Investigate 0's in `IDSUJETO_VICTIMA`. ¿Have they the same distributed crimes?
#- Missing values in `TIPO_TERMINO`
#- `AGRUPA_TERMINOS`, explore missing values

tbone_idsujeto_victima_0<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso","tipo_sujeto_vic", "gls_materia", "encontrado_como_victima",  "reg")), data=  dplyr::mutate(Base_fiscalia_v7, idsujeto_victima_0=ifelse(idsujeto_victima==0,1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg")), smd=T, strata=c("idsujeto_victima_0"), addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_idsujeto_victima_0, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
kable(size=10, format="markdown",caption= "Summary descriptives, missing values in ID of the victim (1)")
```
:::

<br>

Registries with no ID are far more frequent in the north: I Región de Tarapaca, II Región de Antofagasta and XV Región de Arica y Parinacota, while less in the Metropolitan Region. Also have judiciary finishings of the proceedings. Much more were applied a principle of discretion ("PRINCIPIO DE OPORTUNIDAD") and condemnatory sentence ("SENTENCIA DEFINITIVA CONDENATORIA"), and less ended in provision filling of the case ("ARCHIVO PROVISIONAL"), grouped in another case ("AGRUPACI¿N A OTRO CASO") and definitive dismissal ("SOBRESEIMIENTO DEFINITIVO"). Many of the crimes were related to drunk driving, possession of drugs and knives or sharp objects, brawls, drug traffic, microtraffic. There are no cases related to domestic violence. The order for payment procedure ("MONITORIO") was more frequent, in contrast to the ordinary procedure ("ORDINARIO"). The place in which the crime was committed more frequently in national or municipal goods of public use ("BIENES NACIONALES USO PUBLICO"), but less in residential places ("LUGAR HABITADO"). Also, these crimes were more frequently committed between 2010 and 2015, but less after 2015.

<br>

::: controlly
```{r 2-exp-miss-val, echo=T, fig.align='center', message=T, error=T, eval=T}
tbone_tipo_termino_na<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic ", "reg", "gls_materia")), data=  dplyr::mutate(Base_fiscalia_v7, tipo_termino_NA=ifelse(is.na(tipo_termino),1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg")), smd=T, strata="tipo_termino_NA", addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_tipo_termino_na, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>%
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Missing values in Termination of the relationship(1)", format.args = list(decimal.mark = ".", big.mark = ","))
```
:::

<br>

It is difficult to find any pattern with only 21 records. Despite this, much of the records were from patients that were found imputed, from the Metropolitan Region and the Region of Valparaiso. Every record had "SIN PROCEDIMIENTO" type of proceedings. Those values missing in grouped finishings (`AGRUPA_TERMINOS`) coincide with missing in the type of termination of the relationship (`TIPO_TERMINO`).

<br>

::: controlly
```{r 3-exp-miss-val, echo=T, fig.align='center', message=T, error=T, eval=T}
#- `GLS_MOTTERMINO` explore missing values; see why is different with . 
tbone_mot_termino_na<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic ", "reg", "gls_mottermino", "encontrado_como_victima","gls_materia")), data=  dplyr::mutate(Base_fiscalia_v7, mot_termino_NA=ifelse(is.na(gls_mottermino),1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg", "tipo_termino")), smd=T, strata=c("mot_termino_NA","encontrado_como_imputado"), addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_mot_termino_na, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Missing values in the Cause of termination of the relationship(1) & Found as an imputed (YES)")  
```
:::

<br>

As seen in the Table above, people missing values in the cause of the termination of the relationship (`GLS_MOTTERMINO`) were more frequently found as an imputed, had no records in in the type of termination "SALIDA NO JUDICIAL" and much more in "SALIDA JUDICIAL" (judicial intervention rather no judicial intervention). In summary, these cases correspond to suspended proceedings (non-missing values in `GLS_MOTSUSPENSION`). Also these records seem to be linked with compensation agreements, temporary dismissal, and conditional suspension of proceedings. Were more frequent in crimes such as thefts ("HURTOS"), injuries, but less frequent in misdemeanours ("FALTAS") or burglaries ("ROBOS"). They also were more frequent in cases with a relation to VIF. They also were more frequent in the Metropolitan Region, but less frequent in the Region of Valparaiso. Notably, these cases does not seem to have further changes in the causes (`MARCA_SUSPENSION_43` to `CLASIFICACION_PENA_55`). Another characteristic worth mentioning is that these type of records have continued to grow steadily since 2015 in the date of the commission of the crime.

We also explored end of the proceedings with `r message(paste0("Administrative annulment:\n(p= ",format(nrow(unique(subset(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA","rut_enc_saf"))),big.mark=","),";\n RUCs= ", format(nrow(unique(subset(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA","ruc"))), big.mark=","),";\nn= ", format(nrow(subset(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA","rut_enc_saf")), big.mark=",")))`.

<br>

::: controlly
```{r 4-exp-miss-val, echo=T, fig.align='center', message=T, error=T, eval=T}
tbone_agrup_ter_anul<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic ", "reg", "gls_mottermino", "encontrado_como_victima", "gls_materia")), data=  dplyr::mutate(Base_fiscalia_v7, agrupa_terminos_anul=ifelse(agrupa_terminos=="ANULACI¿N ADMINISTRATIVA",1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg", "tipo_termino")), smd=T, strata=c("agrupa_terminos_anul", "encontrado_como_imputado"), addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_agrup_ter_anul, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Values in the Cause of termination of the relationship, Administrative annulment(1) & Found as an imputed (YES)")
```
:::

<br>

Those records that were nullified as a type of termination of the relationship, were more frequently patients found as imputed, with more missing values in the type of victim. Also, more were concentrated in the Metropolitan Region & VIII Bio-Bio, but less were in VI Region of O'Higgins and VII Maule. More records had the value "DENUNCIADO" in the type of imputed, but less with the category "IMPUTADO". Lastly, every record were terminated without a proceeding ("SIN PROCEDIMIENTO"). Notably, these cases does not seem to have further changes in the causes (`MARCA_SUSPENSION_43` to `CLASIFICACION_PENA_55`).They also were much less frequent in cases with a relation to VIF. In terms of date of commision of the crime, there were more records in 2018 to 2020, but less from 1972 to 2011-05.

We also explored end of the proceedings with `r message(paste0("Grouped to another case:\n(p= ",format(nrow(unique(subset(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO","rut_enc_saf"))),big.mark=","),";\n RUCs= ", format(nrow(unique(subset(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO","ruc"))), big.mark=","),";\nn= ", format(nrow(subset(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO","rut_enc_saf")), big.mark=",")))`.

<br>

::: controlly
```{r 4-2-exp-miss-val, echo=T, fig.align='center', message=T, error=T, eval=T}
tbone_agrup_ter_agrup<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic ", "reg", "gls_mottermino", "encontrado_como_victima", "gls_materia")), data=  dplyr::mutate(Base_fiscalia_v7, agrupa_terminos_agrup=ifelse(agrupa_terminos=="AGRUPACI¿N A OTRO CASO",1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg", "tipo_termino")), smd=T, strata=c("agrupa_terminos_agrup","encontrado_como_imputado"), addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_agrup_ter_agrup, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Values in the Cause of termination of the relationship, Grouped to another case(1) & Found as an imputed (YES)")
```
:::

<br>

Among those records grouped to another case, more cases were found as a victim, more committed the crime in the south of the Metropolitan Region and more corresponded to Region del Bio Bio. Every record finished with other terms as judiciary proceedings ("OTROS T¿RMINOS"), more  crimes against the public faith ("DELITOS CONTRA LA FE PÚBLICA"), more corresponded to crimes of criminal relevance ("HECHOS DE RELEVANCIA CRIMINAL"), less  misdemeanours ("FALTAS"), thefts ("HURTOS") and burglaries ("ROBOS"). Also more had a relationship with the victim because of domestic violence. Every record had a missing cause of suspension, possibly because every record had no proceedings. There are no sentences with imprisonment. Crimes were committed more frequently starting from 2017.

<br>

::: controlly
```{r 4-3-exp-miss-val, echo=T, fig.align='center', message=T, error=T, eval=T}
#- `TIPO_SUJETO_VIC` that are victims and imputed at the same time

tbone_suj_vic_imp<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic", "reg", "gls_mottermino", "encontrado_como_victima", "gls_materia")), data=  dplyr::mutate(Base_fiscalia_v7, vicimp=ifelse(encontrado_como_victima=="SI"& encontrado_como_imputado=="SI",1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg", "tipo_termino")), smd=T, strata="vicimp", addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_suj_vic_imp, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Relationships of people both victim and accused(1)")
```
:::

<br>

All of the registries both accused and victim were indicated as a victim in the type of subject, were more frequently in the Metropolitan Region (excepting Western sector), more relationships ended without a judicial intervention, applying the principle of discretion ("PRINCIPIO DE OPORTUNIDAD"), compensation agreements ("ACUERDO REPARATORIO") or provision filling of the case ("ARCHIVO PROVISIONAL"), but less a condemnatory sentence ("SENTENCIA DEFINITIVA CONDENATORIA"). Most of them were inflictions/injuries ("LESIONES"). The proceedings corresponded more to ordinary ("ORDINARIO") or no proceedings, and were committed more in residential cohabited location.

<br>

::: controlly
```{r 5-exp-miss-val, echo=T, fig.align='center', message=T, error=T, eval=T}
#- `TIPO_SUJETO_VIC` 

tbone_suj_tip_suj_novic<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic", "reg", "encontrado_como_victima", "gls_mottermino")), data=  dplyr::mutate(Base_fiscalia_v7, diff_vic_tip_suj=ifelse((tipo_sujeto_vic==6),0,1),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg", "tipo_termino")), smd=T, strata="diff_vic_tip_suj", addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_suj_tip_suj_novic, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Types of Victim as Victim vs. Others (1)")
```
:::

<br>

Those cases in which the type of subject that is a victim did not have the value of "victim (6)", corresponded to records with the following characteristics: every record the patient was found as imputed, most ended with judiciary proceedings, had more condemnatory or of acquittal sentence ("SENTENCIA DEFINITIVA CONDENATORIA" and "ABSOLUTAORIA") and definitive dismissal ("SOBRESEIMIENTO DEFINITIVO") but less provision filling of the case ("ARHIVO PROVISIONAL"). Crimes were much more related to sex-related (specially one to a child under 14 years of age), quasi-delicts ("CUASIDELITOS") or against public trust ("CONTRA LA FE PÚBLICA"), less had a  relationship with the victim because of domestic violence, more were on ordinary proceedings ("ORDINARIO") and accelerated ("ABREVIADO"), while less on payment procedure (“MONITORIO”). Also more occured in residential places ("LUGAR HABITADO") while less in public or social associations ("ORGANIZACION PÚBLICA Y/O SOCIAL"). Less crimes were committed in the Metropolitan Region ("Región Metropolitana") de Santiago	but more in IV Región de Coquimbo. more patients were sentenced to a term of ordinary imprisonment ("PRESIDIO MENOR"), and more frequently from 1 to 60 days in prison. Also more crimes were committed between 1972- mid 2010, declining from 2018, and were more frequent in people born in 1992 and afterwards.

::: controlly
```{r 5-5-exp-miss-val, echo=T, fig.align='center', message=T, error=T, eval=T}
table(Base_fiscalia_v7$region_delito,Base_fiscalia_v7$reg,Base_fiscalia_v7$gls_region, exclude=NULL) %>% melt() %>% dplyr::filter(value>0)%>% dplyr::arrange(Var1, -value) %>% 
  kable(size=10, format="markdown",caption= "Differences between 'region_delito', 'reg' and 'gls_region'", col.names=c("region_delito", "reg", "gls_region", "count"))
#it has "region metropolitana" alone
```
:::

<br>

We should use `region_delito`, because we are not trying to evaluate the performance of each prosecutor's office, but the crime itself. However `region_delito` have "Not defined" and blank values. For research purposes only, we replaced these values with the region of the office in which the patient participated as imputed or victim.

<br>

## Crimes

```{r 5-cod-crimes-more-family, echo=T, fig.align='center', message=T, error=T, eval=T}
# - `FAMILIA_DELITO` explore whether crimes that were in a family are no longer there or viceversa
message(paste0("Number of crime codes that are members of"));message(paste0("more than one family of crimes: ",
Base_fiscalia_v7 %>% 
    janitor::tabyl(cod_delito, familia_delito) %>% 
    data.frame() %>% 
    dplyr::mutate(sum_n=rowSums(dplyr::select(dplyr::mutate_all(.,~ifelse(.==0,0,1)),-1),na.rm=T)) %>%
  dplyr::filter(sum_n>1) %>% nrow()))
```

<br>

See cases in which `COD_DELITO` with value 0 is "Not defined"

```{r 6-exp-crimes, echo=T, fig.align='center', message=T, error=T, eval=T, fig.align='center', fig.pos='H', fig.cap="Crime codes no longer committed"}
crime_cod_label<-
dplyr::distinct(Base_fiscalia_v7[,c("cod_delito","gls_materia")],cod_delito,.keep_all = T)

# - `COD_DELITO`. explore deprecated crimes
crimes_no_cases<-
Base_fiscalia_v7 %>% 
  dplyr::mutate(cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple-1, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table() %>% 
  janitor::tabyl(cut_com_del2,cod_delito) %>% 
  reshape2::melt() %>%
  dplyr::filter(value==0)%>%
  dplyr::filter(cut_com_del2!="1972-12-20") %>% 
  dplyr::distinct(variable)
# create a vector with crimes that have 0 cases in one determined date window

invisible("Its normal if there is a value that is not includeed in the categorization. It is because of the nature of the cut of equal parts in the dates")

(
Base_fiscalia_v7 %>% 
  dplyr::mutate(cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple-1, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table() %>% 
  janitor::tabyl(cut_com_del2,cod_delito) %>% 
  reshape2::melt() %>%
    dplyr::filter(cut_com_del2!="1972-12-20") %>% 
  ungroup()%>%
  dplyr::filter(variable %in% as.numeric(unlist(crimes_no_cases)))%>%
  dplyr::left_join(dplyr::mutate(crime_cod_label,cod_delito=as.factor(cod_delito)), by=c("variable"="cod_delito")) %>% 
  dplyr::mutate(var=factor(variable), lab=paste0("cod= ",var,"\ndetail= ",gls_materia,"\n Count= ",value), log_value=dplyr::case_when(value==1~0.345,value==0~log(1.1),T~log(value)))%>%
   dplyr::group_by(var)%>%
   ggplot(aes(x=cut_com_del2, y= jitter(log_value,factor = .5),color=var, group=var, text=lab))+
   geom_line()+ #position="stack"
    scale_color_manual(values= colorspace::rainbow_hcl(2e2))+
    theme_blank()+
    theme(legend.position='none')
)%>%
  ggplotly(tooltip="text") %>% 
  layout(xaxis= list(title= "Dates", tickangle= 90), yaxis= list(title = "count"))
```

<br>

::: controlly
```{r 6-exp-crimes2, echo=T, fig.align='center', message=T, error=T, eval=T}
invisible("Its normal if there is a value that is not includeed in the categorization. It is because of the nature of the cut of equal parts in the dates")

Base_fiscalia_v7 %>% 
  dplyr::mutate(cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple-1, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table() %>% 
  janitor::tabyl(cut_com_del2,cod_delito) %>% 
  reshape2::melt() %>%
    dplyr::filter(cut_com_del2!="1972-12-20") %>% 
  dplyr::left_join(dplyr::mutate(crime_cod_label,cod_delito=as.factor(cod_delito)), by=c("variable"="cod_delito")) %>%
  ungroup()%>%
  dplyr::filter(variable %in% as.numeric(unlist(crimes_no_cases)))%>%
#format_cells(1, 1:length(names(.)), "bold") %>%
  kable(size=10, format="markdown",caption= "Crimes that had a null count in one time window", col.names=c("Dates","Crime (Code)", "Count","Details"))
```
:::

<br>

We explored the relationship between the ID of the crime by each RUC, with the code of the crime.

::: controlly 
```{r 7a-iddelito-cod-delito, echo=T, fig.align='center', message=T, error=T, eval=T}
#- Explore differences of `IDDELITO` with `cod_delito`.
Base_fiscalia_v7 %>% 
  dplyr::group_by(cod_delito,iddelito) %>% 
  summarise(n=n()) %>% 
  head(20) %>% 
  kable(size=10, format="markdown",caption= "ID of crimes in each cause, by the code of crime (First 20 cases)", col.names=c("Crime code","Crime ID", "Count")) 
```
:::

```{r 7b-iddelito-cod-delito, echo=T, fig.align='center', message=T, error=T, eval=T}
message(paste0("More than one distinct crime codes (cod_delito) by ID of crime (iddelito)= ",
Base_fiscalia_v7 %>% 
  dplyr::group_by(iddelito) %>% 
  summarise(n=n_distinct(cod_delito)) %>% 
  dplyr::filter(n>1) %>% 
  nrow()))
```

## End of the proceedings

::: controlly 
```{r 8-termino-grupa-terminos, echo=T, fig.align='center', message=T, error=T, eval=T}
table(Base_fiscalia_v7$tipo_termino,Base_fiscalia_v7$agrupa_terminos, Base_fiscalia_v7$gls_mottermino, exclude=NULL) %>% melt() %>% dplyr::arrange(Var1, Var2,-value) %>%  dplyr::filter(value!=0) %>% 
    kable(size=10, format="markdown",caption= "Differences between 'tipo_termino', 'agrupa_terminos' and 'gls_mottermino'", col.names=c("tipo_termino", "agrupa_terminos", "gls_mottermino","count"))
```
:::

<br>

We compared cases that ended with a condemnatory sentence vs. other types of endings.

<br>

::: controlly 
```{r 9-termino-agrupa-terminos-exp, echo=T, fig.align='center', message=T, error=T, eval=T}
tbone_sent_def_cond<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic", "reg", "encontrado_como_victima", "gls_mottermino")), data=  dplyr::mutate(Base_fiscalia_v7, sent_def_cond=ifelse(agrupa_terminos=="SENTENCIA DEFINITIVA CONDENATORIA",1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks"))),cut_com_del2=cut2(fec_comision_simple, cuts=as.Date(attr(dlookr::binning(as.numeric(fec_comision_simple)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg", "tipo_termino")), smd=T, strata=c("sent_def_cond", "encontrado_como_imputado"), addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_sent_def_cond, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Condemnatory sentence (1) & Found as an imputed (YES)")
```
:::

<br>

We notice that records with condemnatory sentences were found exclusively as imputed. Also less frequently corresponded to patients found as victim as the type of victim. Were in concentrated more in Regions Antofagasta, Tarapaca, Los Lagos y Los Rios, but less in the Metropolitan Region. As expected, every record ended with judiciary proceedings. Cases had more misdemeanours ("FALTAS"), thefts ("HURTOS"), crimes of special laws ("DELITOS DE LEYES ESPECIALES"), and other crimes ("OTROS DELITOS"), while less economic and tax crimes ("DELITOS ECONÓMICOS Y TRIBUTARIOS") and crimes against personal freedom and privacy ("DELITOS CONTRA LA LIBERTAD E INTIMIDAD DE LAS PERSONAS"). here are less cases related to domestic violence. Regarding the judiciary procedures, the order for payment ("MONITORIO"), accelerated ("ABREVIADO") and simplified/streamlined ("SIMPLIFICADO") were more frequent. More crimes were committed in malls or business locals and public domains, while less at residential places (“LUGAR HABITADO”). More had more other precautionary measures (Art. 155), pretrial detention (PP), juvenile detention (IP). Crimes were committd more frequently between 2010 and mid-2011, and between February 2013 and June 2016, while less starting from June 2017 (**maybe due to delayed times in finishing the proceedings**). Patients born between 1930 and 1963 were less frequent, while more were born between July 1983 and 1992.

<br>

<!---
+ frecuente imputado
- sujeto víctima como víctima
+ Antofagasta, Tarapacá, Los lagos y Los Ríos
- RM Centro Norte, RM Occidente y RM Sur
Todos Salida Judicial 
+ TRÁFICO ILÍCITO DE DROGAS ART. 3 LEY Nº 20.000., ROBO EN LUGAR NO HABITADO. ART. 442., RIÑA PÚBLICA 496 Nº 10 CÓDIGO PENAL, RECEPTACIÓN. ART. 456 BIS A, PORTE DE ARMA CORTANTE O PUNZANTE (288 bis), PORTE ILEGAL DE ARMA DE FUEGO, MUNIC.Y OTR.SUJETAS A CONTROL,OTROS DELITOS DE LA LEY 20.000, OTROS DELITOS CONTEMPLADOS EN LEY DE PROPIEDAD INTELECTUAL, OTRAS FALTAS CÓDIGO PENAL, OCULTACIÓN DE IDENTIDAD 496 Nº5 CÓDIGO PENAL, OCULTACIÓN DE IDENT. CONTROL PREV. 496 Nº 5 Y 12 LEY 20.931, MICROTRÁFICO (TRÁFICO DE PEQUEÑAS CANTID. ART. 4 LEY 20000), HURTO SIMPLE POR UN VALOR DE MEDIA A 4 UTM, HURTO FALTA 494 BIS CÓDIGO PENAL, HOMICIDIO, FALTA DE RESPETO A LA AUTORIDAD PÚBLICA 495 Nº4 CÓDIGO PENAL, CONSUMO/PORTE EN LUG. PÚB.O PRIV. CON PREV.CONCIERTO(ART.50), CONSUMO/PORTE DE DROGAS EN LUGARES CALIFICADOS (ART.51), CONDUCCIÓN EBRIEDAD CON O SIN DAÑO O LES. LEVE 196 INC. 1, CONDUCCIÓN ESTADO DE EBRIEDAD CON RESULTADO DE LESIONES., CONDUC EBRIEDAD C/SUSP LICENCIA ART 196,209 LEY TRANSITO, ARROJAMIENTO DE PIEDRAS U OTROS OBJETOS (496 Nº26 Cód.Penal)			
- ROBO CON VIOLENCIA. ART.436 inc. 1º 433, 438, 439, ROBO CON INTIMIDACIÓN . ART. 433, 436 INC 1º 438., OTROS HECHOS, MALTRATO HABITUAL (VIOLENCIA INTRAFAMILIAR), LESIONES en general, ESTAFAS Y OTRAS DEFRAUDACIONES CONTRA PARTICULARES, DESACATO (Art. 240 Código de Procedimiento Civil), DAÑOS SIMPLES. ART. 487., DAÑO FALTA (495 N° 21 Código Penal) , CUASIDELITO DE LESIONES. ART 490, 491 INC 2° Y 492., AMENAZAS SIMPLES CONTRA PERSONAS Y PROPIEDADES ART. 296 Nº3., AMENAZAS CONDIC. CONTRA PERSONAS Y PROP. ART. 296 1 y 2, 297	
+ FALTAS,HURTOS,OTROS DELITOS, DELITOS DE LEYES ESPECIALES	
- DELITOS CONTRA LA LIBERTAD E INTIMIDAD DE LAS PERSONAS, DELITOS ECONÓMICOS Y TRIBUTARIOS.
- Relación VIFSAF
+ Procedimiento término: MONITORIO,ABREVIADO, SIMPLIFICADO; - MONITORIO, nadie SIN PROCEDIMIENTO
+ ESTABLECIMIENTO COMERCIAL, BIENES NACIONALES USO PUBLICO		
- LUGAR HABITADO O DESTINADO A LA HABITACION Y SUS DEPENDENCIAS
+ medidas_155, medidas_pp, medidas_ip , marca_suspension_43 
+ marca_pena_44, marca_multa_45 
+ Desde [2009-12-20, a ,2011-05-27; Desde 2013-02-23 a 2016-06-22
- Desde 2017-06-28,
- en nacidos desde 1930-01-18,1963-06-08
+ nacidos entre 1983-07-04 y 1992-12-13
--->

<br>

# Date of commission of the crime

we get a glance at the distribution of the dates.

```{r 0-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}
#invisible("see applyrulesage4 chunk in Fiscalia_merge2.Rmd")
#https://www.efta.int/sites/default/files/RvalPart3.pdf
#https://books.google.cl/books?id=3slJDwAAQBAJ&pg=PA160&lpg=PA160&dq=%22errorlocate%22&source=bl&ots=PjMI_G_1ja&sig=ACfU3U03eKo_UALC12_ND1oulbUB6iNsgg&hl=es-419&sa=X&ved=2ahUKEwjPx-ar9tr5AhWRBLkGHYbhBOE4HhDoAXoECAIQAw#v=onepage&q=%22errorlocate%22&f=false

cbind(cat="Date of comission of the crime",
      Base_fiscalia_v7 %>% 
          dplyr::summarise(min = min(fec_comision_simple, na.rm=T),
                           p025=as.Date(quantile(unclass(fec_comision_simple), .025, na.rm=T), origin = "1970-01-01"),p25=as.Date(quantile(unclass(fec_comision_simple), .25, na.rm=T), origin = "1970-01-01"), p50=as.Date(quantile(unclass(fec_comision_simple), .5, na.rm=T), origin = "1970-01-01"), p75=as.Date(quantile(unclass(fec_comision_simple), .75, na.rm=T), origin = "1970-01-01"), p975=as.Date(quantile(unclass(fec_comision_simple), .975, na.rm=T), origin = "1970-01-01"), max = max(fec_comision_simple, na.rm=T)))
```

<br>

We explored several characteristics of the date of commission of the crime.

```{r 2b1-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}
Base_fiscalia_v7 %>%
  dplyr::mutate(obs_age_com_crime= factor(dplyr::case_when(fec_comision_simple <"2010-01-01"~"a. Less 2010",edad_ter_rel_imp < edad_comision_imp~ "b. Age of termination of relationship < Age relationship", edad_comision_imp<0~ "c. Less 0 years age crime committed", edad_comision_imp < 18~ "d. Less 18 years age crime committed", is.na(edad_comision_imp)~"e. Missing age of crime comission", is.na(fec_comision_simple)~"f. Missing of date of crime comission", is.na(imp_birth_date)~ "g. MIssing birth date", T~"0. none"), levels=c("a. Less 2010", "b. Age of termination of relationship < Age relationship", "c. Less 0 years age crime committed", "d. Less 18 years age crime committed", "e. Missing age of crime commission", "f. Missing of date of crime commission", "g. Missing birth date", "0. none"))) %>% 
  #group_by(obs_age_com_crime) %>% 
  #summarise(obs_age_com_crime = n())
  janitor::tabyl(obs_age_com_crime, show_missing_levels = T) %>% 
  dplyr::mutate(percent=scales::percent(percent, accuracy = .1)) %>% 
  kable("markdown", caption= "Count of distinct cases ")
#- Crimes committed at an age lower than the date of birth
#- Edad de nacimiento, crimenes cometidos a una edad
```

`r invisible("Ver si por cada caso(RUC), hay distintos ID de sujetos imputados, pero para un único RUT")`

## Records w/ crimes committed before 2010

```{r 1-obs-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}
#6- 984 < 14 años fecha de comisión: las 144 son responsabilidad mía, las otras no. Las primeras porque las manipulé y elegí el mal menor pero seguía existiendo mal (tal vez que el problema ahí es la fecha de comisión y no la de nacimiento). Las segundas ver cuál es el origen, ahí probablemente la fecha de nac no esté mal porque SENDA y PO tienen la misma. En los 2 casos, hacer tablitas para ver la razón de término de la causa y ver anomalías
#5- Investigar fechas de término <2010

#- Crimes committed before 2009-12-31 as.Date(quantile(unclass(Base_fiscalia_v7$fec_comision_simple), .05))
#- Crimes committed at a age lower than the date of birth
#- age of commission <14
#- Imputed age
#- Age of termination of the relationship prior to the date of comission of the crime
#- Add ten years to the age of comission and see if gets better
```

The lowest 5% of the dates of crimes committed were in `r as.Date(quantile(unclass(Base_fiscalia_v7$fec_comision_simple), .05), origin="1970-01-01")` or older. We decided to explore these entries.

```{r 2a-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}
#- Crimes committed before 2009-12-31 as.Date(quantile(unclass(Base_fiscalia_v7$fec_comision_simple), .05))
#- Crimes committed at a age lower than the date of birth
#- age of commission <14
#- Imputed age
#- Age of termination of the relationship prior to the date of comission of the crime
#- Add ten years to the age of comission and see if gets better
if(no_mostrar==0){
    library(errorlocate)
    rules <- validator( grepl(obs,"22_3")==T
                      , fec_comision_simple < "2010-01-01"
                      , edad_comision_imp < 18
                      , edad_ter_rel_imp < edad_comision_imp # is implied
    )
    weight <- c(obs=1, fec_comision_simple=3, edad_comsion_imp=1,
                edad_ter_rel_imp=6)#
    errorlocate::locate_errors(Base_fiscalia_v7, rules, weight= weight)
}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

message(
paste0("Crimes committed before 2010:\n(p= ",format(nrow(unique(subset(Base_fiscalia_v7,fec_comision_simple<"2010-01-01","rut_enc_saf"))),big.mark=","),";\n RUCs= ",
       format(nrow(unique(subset(Base_fiscalia_v7,fec_comision_simple<"2010-01-01","ruc"))), big.mark=","),";\nn= ",
       format(nrow(subset(Base_fiscalia_v7,fec_comision_simple<"2010-01-01","rut_enc_saf")), big.mark=","),")"))
```

<br>

::: controlly
```{r 2-date-comission-perc-05, echo=T, fig.align='center', message=T, error=T, eval=T}
tbone_date_comission_perc_05<-
CreateTableOne(vars= setdiff(c(myVars,"cut_com_del2","cut_fec_nac2"), c("gls_comuna", "gls_sitiosuceso", "tipo_sujeto_vic", "reg", "gls_mottermino", "encontrado_como_victima", "gls_materia")), data=  dplyr::mutate(Base_fiscalia_v7, date_comission_perc_05=ifelse(fec_comision_simple<as.Date(quantile(unclass(Base_fiscalia_v7$fec_comision_simple), .05)),1,0),cut_fec_nac2=cut2(imp_birth_date, cuts=as.Date(attr(dlookr::binning(as.numeric(imp_birth_date)),"breaks")))) %>% data.table(), factorVars = setdiff(catVars, c("gls_comuna", "gls_sitiosuceso", "reg", "tipo_termino")), smd=T, strata= c("date_comission_perc_05","encontrado_como_imputado"), addOverall = T, includeNA=T,test=T)

as.data.frame.TableOne(tbone_date_comission_perc_05, smd=T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  kable(size=10, format="markdown",caption= "Summary descriptives, Date comission before percentile .05 (2010) & Found as an imputed (YES)")  
```
:::

<br>

More cases were found as imputed, more were from the Metropolitan Region, more relationships ended with a judicial intervention, more ended with dismissal of proceedings art.[240](http://iura.cl/cpp/240.html) but less were provision filling of the case ("ARCHIVO PROVISIONAL"). In terms of the types of crimes, misdemeanours ("FALTAS") were less frequent, but more inflictions/injuries ("LESIONES"). By contrast, much more suspended finishings of the proceedings ("SUSPENSION CONDICIONAL DEL PROCEDIMIENTO"). The proceedings corresponded more to ordinary ("ORDINARIO") or no proceedings. Also more had precautionary measures from art.  [155](http://iura.cl/cpp/155.html). Lastly, less were born after December, 1992.

```{r 2-date-comission-perc-05-2, echo=T, fig.align='center', message=T, error=T, eval=T}
#APROPIACIÓN Y DISTRACCIÓN DE COTIZACIONES PREVISIONALES	
#APROPIACIÓN INDEBIDA (INCL. DEPOSITARIO ALZADO) ART.470 Nº1	
#CONSUMO/PORTE EN LUG. PÚB.O PRIV. CON PREV.CONCIERTO(ART.50)	 mucho menos
# DELITOS CONTRA LEY DE PROPIEDAD INTELECTUAL	(todos)
# casi todos los HURTO SIMPLE	
# todos INFRACCIONES A LA LEY DE SEG.NUCLEAR (Art.41 a 47 Ley 18302)	
#OTROS DELITOS CONTEMPLADOS EN LEY DE PROPIEDAD INTELECTUAL	 x3
# PORTE ILEGAL DE ARMA DE FUEGO, MUNIC.Y OTR.SUJETAS A CONTROL	x3
# PRESUNTA DESGRACIA	mucho menos
# PROMOVER O FACILITAR PROSTITUCIÓN DE MENORES . ART. 367.	x2
#TRÁFICO ILÍCITO DE DROGAS ART. 3 LEY Nº 20.000.  x2
# VIOLACIÓN DE MENOR DE 14 AÑOS. ART. 362.	x2
# VIOLACIÓN DE MAYOR DE 14 AÑOS. ART. 361.	x1.5
#	RIÑA PÚBLICA 496 Nº 10 CÓDIGO PENAL x3 menos
# RECEPTACIÓN. ART. 456 BIS A	x2
```  

<br>

::: controlly
```{r 2b2-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}

Base_fiscalia_v7 %>% 
dplyr::select(rut_enc_saf, encontrado_como_imputado, fec_comision_simple, fec_cbiorelacion_simple, edad_ter_rel_imp, edad_comision_imp, imp_birth_date, gls_region, gls_materia, agrupa_terminos, obs) %>% 
  dplyr::distinct(rut_enc_saf, .keep_all=T) %>% 
  dplyr::mutate(b=dplyr::if_else(edad_ter_rel_imp < edad_comision_imp,1,0,0)) %>% 
  dplyr::filter(fec_comision_simple<"2010-01-01") %>% 
  dplyr::arrange(b,fec_comision_simple) %>% 
  head(50) %>% 
  kable(size=10, format="markdown",caption= "Cases w/ crimes committed before 2010 (First 50 cases)") 

#- Delitos de violación <14a para los mas largo
#- Bigamia: dselitos permanentes, duración de la acción humanada exigida por el tipo penal // persona "que contrajere matrimonio estando válidamente casada". // Nos adelantamos a exponer la razón: cuando todo el mundo consideraba como un hecho absolutamente indiscutible el de la instantaneidad del delito de bigamia, conSUs consecuencias en materia de prescripción, nos ha tocado leer algunos fallos recientes emanados de la Corte Suprema, que vienen a romper el consenso de que dábamos cuenta en ~as páginas que preceden.
#- "Se produciría falta de concordancia y armonia entre los artículos 29 y 35 de la Ley de Matrimonio Civil al estimar que la acción penal y la pena del delito que  tipifica el artículo 382 del Código Penal, pueden ser  declaradas extinguidas por la prescripción en circunstancias de que civilmente la acción de nulidad de matrimonio celebrado con infracción del artículo 49, NQ 1 es imprescriptible ... El delito de bigamia no es de carácter instantáneo, sino que, por el contrario, es pennanente ..."
#- http://www.rdpucv.cl/index.php/rderecho/article/view/148/138

```
:::

<br>

## Records w/ relationship dates finished before the crime was committed


```{r 2c-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}

invisible("No son mayores a 1 año")
invisible("algunos son 22_1_, por lo que fuern imputados")
invisible("ninguno de ellos fue cometido antes del 2010")

message(
    paste0("Relationship date finished before the crime was committed:\n(p= ",format(nrow(unique(subset(Base_fiscalia_v7,edad_ter_rel_imp < edad_comision_imp,"rut_enc_saf"))),big.mark=","),";\n RUCs= ",
           format(nrow(unique(subset(Base_fiscalia_v7,edad_ter_rel_imp < edad_comision_imp,"ruc"))), big.mark=","),";\nn= ",
           format(nrow(subset(Base_fiscalia_v7,edad_ter_rel_imp < edad_comision_imp,"rut_enc_saf")), big.mark=","),")"))

invisible("no hay más de un RUC en estos RUTs, pero aparecen más de una vez en la base") 
 # purrr::when(dplyr::filter(.,nchar(c_22_1_a1a_1234_ab2)>2) %>% nrow()>0 ~ stop("imputed age at admission lower than the age of onset of drug use in imputed"), ~.) %>% 
```


::: controlly
```{r 2d-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}
Base_fiscalia_v7 %>%
    dplyr::filter(edad_ter_rel_imp < edad_comision_imp) %>% 
    dplyr::mutate(diff_bet_ter_com= edad_comision_imp-edad_ter_rel_imp) %>% 
    dplyr::select(rut_enc_saf, diff_bet_ter_com, encontrado_como_imputado, diff_bet_ter_com, fec_comision_simple, fec_cbiorelacion_simple, edad_ter_rel_imp, edad_comision_imp, imp_birth_date, gls_region, gls_materia, agrupa_terminos, obs)%>% 
  dplyr::arrange(-diff_bet_ter_com)  %>% 
  dplyr::mutate(diff_bet_ter_com=scales::percent(diff_bet_ter_com, .1)) %>% 
  kable(size=10, format="markdown",caption= "Cases w/ Age of finishing of relationship before the crimes being committed") 
```
:::

<br>

We decided to discard crimes committed before 2010. We also left as missing values the ID of subjects that were equal to 0. Lastly, we deleted the registries with Administrative annulment and grouped to another case.


```{r 3-date-crimecomission, echo=T, fig.align='center', message=T, error=T, eval=T}
#entender los NAs, los No definidos, y cuál es la relación de las variables region
#luego limpiarlos
#no definido: region_delito , gls_parentesco poner como perdido, más una observación de reemplazo

#We should use `region_delito`, because we are not trying to evaluate the performance of each prosecutor's office, but the crime itself. However `region_delito` have "Not defined" and blank values. For research purposes only, we replaced these values with the region of the office in which the patient participated as imputed or victim.

#duplicated rows eliminated
eliminated_duplicates<-    
Base_fiscalia_v7 %>% 
 dplyr::mutate(rut_ruc= paste0(rut_enc_saf,"_",ruc)) %>% 
  dplyr::filter( rut_ruc %in% as.character(unlist(dplyr::distinct(dplyr::mutate(ungroup(subset(agrupacion_base,max>1)), rut_ruc=paste0(rut_enc_saf,"_",ruc)),rut_ruc)))) %>% 
  dplyr::group_by(rut_ruc) %>% 
     dplyr::mutate(rn_rut_ruc=dplyr::row_number()) %>% 
     dplyr::ungroup() %>% 
dplyr::filter(dplyr::case_when((rut_ruc %in% as.character(unlist(dplyr::distinct(dplyr::mutate(ungroup(subset(agrupacion_base,max>1)), rut_ruc=paste0(rut_enc_saf,"_",ruc)),rut_ruc)))) & rn_rut_ruc>1~F,T~T)) 

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
Base_fiscalia_v8 <-
Base_fiscalia_v7 %>%
  dplyr::filter(fec_comision_simple>="2010-01-01", agrupa_terminos!="ANULACI¿N ADMINISTRATIVA", agrupa_terminos!="AGRUPACI¿N A OTRO CASO") %>% 
  dplyr::mutate(obs=dplyr::case_when(idsujeto_victima==0~glue::glue("{obs};3.3.1.Victim ID equals 0"),T~obs)) %>% 
  dplyr::mutate(idsujeto_victima= dplyr::case_when(idsujeto_victima==0 ~ NA_character_,T~ as.character(idsujeto_victima))) %>% 
  dplyr::mutate(rut_ruc= paste0(rut_enc_saf,"_",ruc)) %>% 
  dplyr::mutate(obs=dplyr::case_when(rut_ruc %in% unlist(dplyr::distinct(dplyr::mutate(ungroup(subset(agrupacion_base,max>1)), rut_ruc=paste0(rut_enc_saf,"_",ruc)),rut_ruc))~glue::glue("{obs};3.3.2.Duplicate entries in PO"),T~obs)) %>% 
  dplyr::group_by(rut_ruc) %>% 
  dplyr::mutate(rn_rut_ruc=dplyr::row_number()) %>% 
  dplyr::ungroup() %>% 
  #filter the 2nd observation from duplicated entries
  dplyr::filter(dplyr::case_when((rut_ruc %in% as.character(unlist(dplyr::distinct(dplyr::mutate(ungroup(subset(agrupacion_base,max>1)), rut_ruc=paste0(rut_enc_saf,"_",ruc)),rut_ruc)))) & rn_rut_ruc>1~F,T~T)) %>% 
  dplyr::select(-rn_rut_ruc, -rut_ruc) %>% 
  #Region of the crime, change according
    dplyr::mutate(obs=dplyr::case_when(region_delito=="No Definido"~glue::glue("{obs};3.3.3a.Not defined value in Region of Crime commission"), is.na(region_delito)~glue::glue("{obs};3.3.3b.Missing value in Region of Crime commission"),T~as.character(obs))) %>% 
        dplyr::mutate(region_delito_rec= dplyr::case_when(region_delito=="No Definido"~as.character(gls_region), is.na(region_delito)~as.character(gls_region),T~as.character(region_delito))) %>% 
  dplyr::mutate(region_delito_rec= dplyr::case_when(grepl("RM",region_delito_rec)~"Región Metropolitana de Santiago",T~as.character(region_delito_rec)))

#check if added rows
if(nrow(Base_fiscalia_v8)-nrow(Base_fiscalia_v7)>0){
  stop("Some rows were added in the imputation")}
```

<br>

  
```{r export-svg,echo=T, paged.print=TRUE, eval=T, error=T}
if(isTRUE(getOption('knitr.in.progress'))==T){
} else {
  #path<-ifelse(!grepl("$\\/",getwd()),paste0(getwd(),"/"),getwd())
  path<- getwd()
}

tab1_lab_aft_d<- paste0('Original C1 Dataset \n(n = ', formatC(nrow(CONS_C1), format='f', big.mark=',', digits=0), ';\npatients: ',formatC(CONS_C1%>% dplyr::distinct(HASH_KEY)%>% nrow(), format='f', big.mark=',', digits=0),')')
tab2_lab_aft_d<- paste0('&#8226;Remove duplicated entries\\\\\\l&#8226;Overlapping treatments of patients\\\\\\l&#8226;Intermediate treatment events (continuous referrals)    \\\\\\l')
tab3_lab_aft_d<- paste0('      C1 Dataset          \n(n = ', formatC(nrow(CONS_C1_df_dup_SEP_2020), format='f', big.mark=',', digits=0), ';\npatients: ',formatC(CONS_C1_df_dup_SEP_2020%>% dplyr::distinct(hash_key)%>% nrow(), format='f', big.mark=',', digits=0),')')
tab4_lab_aft_d<- paste0('Original Prosecutors Office\n(n = ',format(nrow(Base_fiscalia_v2),big.mark=","), 
                        ';\nCauses= ',Base_fiscalia_v2%>% dplyr::distinct(ruc)%>% nrow() %>% format(big.mark=','),
                        ';\nRel.=',Base_fiscalia_v2%>%dplyr::distinct(idrelacion)%>%nrow()%>%format(big.mark=','),
                        ';\nRUC_Vic_Imp=',Base_fiscalia_v2%>%dplyr::mutate(rel=paste0(ruc,"_",idsujeto_victima,"_",idsujeto_imputado,"_","iddelito"))%>%dplyr::distinct(rel)%>%nrow()%>%format(big.mark=','),
                        ';\nindividuals= ',Base_fiscalia_v2%>% dplyr::distinct(rut_enc_saf)%>% nrow() %>% format(big.mark=','),')')

#crimes committed after study follow-up
tab5_lab_aft_d1<-
    paste0("(p= ",format(nrow(unique(subset(Base_fiscalia_v2,fec_comision_simple>as.Date("2019-11-13"),"rut_enc_saf"))),big.mark=","),"; RUCs= ",
           format(nrow(unique(subset(Base_fiscalia_v2,fec_comision_simple>as.Date("2019-11-13"),"ruc"))), big.mark=","),";n= ",
           format(nrow(subset(Base_fiscalia_v2,fec_comision_simple>as.Date("2019-11-13"),"rut_enc_saf")), big.mark=","),")")
#erase entries with missing values in fec_comision_simple y termino_relacion_simple
leftovers_Base_fiscalia_v3<-
Base_fiscalia_v3 %>% 
  dplyr::left_join(after_imp_Base_fiscalia_v3_db[,c("rut_enc_saf","imp_birth_date","flowch_age")], by="rut_enc_saf") %>% 
  dplyr::rename("obs"="flowch_age") %>% 
  dplyr::mutate(imp_birth_date=dplyr::case_when(!is.na(imp_birth_date)~imp_birth_date,T~fec_nacimiento_simple))%>% dplyr::mutate(edad_comision_imp=as.numeric(fec_comision_simple-imp_birth_date)/365.25) %>% dplyr::mutate(edad_ter_rel_imp=as.numeric(termino_relacion_simple-imp_birth_date)/365.25) %>%
  #arrange the rut from the first date of comission of a crime, but we are not detecting if he/she is the victim or not
  dplyr::arrange(rut_enc_saf, edad_comision_imp) %>% #566884
  dplyr::filter(dplyr::case_when(!is.na(edad_comision_imp)~T,T~F)) %>% #566644
  dplyr::filter(imp_birth_date=="1900-01-01"|is.na(imp_birth_date))

tab5_lab_aft_d12<-
    paste0("(p= ",format(nrow(dplyr::distinct(leftovers_Base_fiscalia_v3,rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(leftovers_Base_fiscalia_v3,ruc)), big.mark=","),";n= ",
           format(nrow(leftovers_Base_fiscalia_v3), big.mark=","),")")

#minor to 14 years old
tab5_lab_aft_d13<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v4,edad_comision_imp<14),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v4,edad_comision_imp<14),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v4,edad_comision_imp<14)), big.mark=","),")")

#Remove duplicated entries
tab5_lab_aft_d2<-
  paste0("(p= ",format(length(unique(eliminated_duplicates$rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(length(unique(eliminated_duplicates$ruc)), big.mark=","),";n= ",
           format(nrow(eliminated_duplicates), big.mark=","),")")
#before 2010
 tab5_lab_aft_d3<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,fec_comision_simple<"2010-01-01"),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,fec_comision_simple<"2010-01-01"),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v7,fec_comision_simple<"2010-01-01")), big.mark=","),")")
#remove administrative annulment
tab5_lab_aft_d4<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA"),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA"),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA")), big.mark=","),")")
#remove grouped to another case
tab5_lab_aft_d5<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO"),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO"),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO")), big.mark=","),")")

tab5_lab_aft_d<- paste0('&#8226;Filter crimes committed after study follow-up period',tab5_lab_aft_d1,'\\\\\\l&#8226;Remove duplicated entries',tab5_lab_aft_d2,'\\\\\\l&#8226;Correct dates (birth, comission of crime, end of judicial proceedings), missing nationality and sex\\\\\\l&#8226;Erase entries with missing values in  comission of crime, end of judicial proceedings',tab5_lab_aft_d12,'\\\\\\l&#8226;Erase entries with values in comission of crime when minor to 14 years old after imputation',tab5_lab_aft_d13,'\\\\\\l&#8226;Filter crimes committed before study follow-up',tab5_lab_aft_d3,'\\\\\\l&#8226;Filter records with cause of end of the proceedings= administrative annulment',tab5_lab_aft_d4,'\\\\\\l&#8226;Filter records with cause of end of the proceedings= grouped to another case',tab5_lab_aft_d5,'\\\\\\l')
tab6_lab_aft_d<- paste0("O.P. Dataset \n(n= ", formatC(nrow(Base_fiscalia_v8),big.mark = ","),";\nindividuals= ",Base_fiscalia_v8%>% dplyr::distinct(rut_enc_saf)%>% nrow()%>% formatC(big.mark = ","),")")
tab7_lab_aft_d<- paste0('&#8226;Discard observations depending on the values of the end of the proceedings         \\\\\\l&#8226;Long-to-wide relationships/crimes, end of judicial proceedings, penalty         \\\\\\l&#8226;Group crimes into violent, drug-related, etc.         \\\\\\l&#8226;Check overlapping events (e.g., incarcerated while completing a residential treatment)         \\\\\\l')

library(DiagrammeR) #⋉
plot_merge_flowchart_after_dates<-
  grViz("digraph flowchart {
      fontname='Comic Sans MS'
      # node definitions with substituted label text
      node [shape = rectangle,fontsize = 9]        
      tab1 [label = '@@1']
      blank [label = '', width = 0.0001, height = 0.0001]
      tab2 [label = '@@2',fontsize = 7]
      tab3 [label = '@@3']
      
      tab4 [label = '@@4',fontsize = 8]
      blank2 [label = '', width = 0.0001, height = 0.0001]
      tab5 [label = '@@5',fontsize = 7]
      tab6 [label= '@@6']
      
      blank3 [label = '', width = 0.0001, height = 0.0001]
      blank4 [label = '', width = 0.0001, height = 0.0001]      
      blank5 [label = '', width = 0.0001, height = 0.0001] 
      
      blank6 [label = '', width = 0.0001, height = 0.0001]
      tab7 [label = '@@7',fontsize = 7]
      tab8 [label= '@@8']
      
      # edge definitions with the node IDs
      rankdir='TB'; rank= same; tab1 -> blank [arrowhead = none,label='        Data wrangling and normalization process',fontsize = 8];
      rankdir='TB'; rank= same; tab1; tab3;   
      blank -> tab2;
                  subgraph {
              rank = same; tab2; blank;
                  }
      rankdir='TB'; rank= same; blank -> tab3;      
            
      tab4 -> blank2 [arrowhead = none,label='        Data wrangling and normalization process',fontsize = 8];
      blank2 -> tab5
      blank2 -> tab6
      blank4 -> blank6 [arrowhead= none, label='  &#10198;']
      blank6 -> tab7
                  subgraph {
        rank = same; blank6; tab7;
                  }
      blank6 -> tab8
                  subgraph {
        rank = same; tab5; blank2;
                  }
                  subgraph {
      rank= same; tab3 -> blank3 -> blank4 -> blank5 -> tab6 [arrowhead= none]
                  }
      }
                  subgraph {
        rank = same; tab3; tab6;
                  }
                  subgraph {
        rank = same; tab1; tab4;
                  }         
                  subgraph {
        rank = same; tab2; tab5;
                  } 
                  subgraph {
        rank = same; tab1; tab3;
        rankdir=TB
        rank=same
                  }
                  subgraph {
        rank = same; tab4; tab6;
        rankdir=TB
        rank=same
                  }                     

      [1]:  tab1_lab_aft_d
      [2]:  tab2_lab_aft_d
      [3]:  tab3_lab_aft_d
      [4]:  tab4_lab_aft_d
      [5]:  tab5_lab_aft_d
      [6]:  tab6_lab_aft_d
      [7]:  tab7_lab_aft_d
      [8]:  'Merged database'
      ", width = 1200,
        height = 900)

DPI = 1200
WidthCM = 11
HeightCM = 8

sysfonts::font_add(family = "Rooney Sans", regular = paste0(sub("2019 \\(github\\)/SUD_CL","2022 \\(github\\)",path),"/_style/RooneySansRegular.otf"))

showtext::showtext_begin()
plot_merge_flowchart_after_dates %>%
  export_svg %>% charToRaw %>% rsvg_pdf(paste0(sub("2019 \\(github\\)/SUD_CL","2022 \\(github\\)",path),"/_figs/_flowchart_merge2.pdf"))
plot_merge_flowchart_after_dates %>% export_svg()%>%charToRaw %>% rsvg(width = WidthCM *(DPI/2.54), height = HeightCM *(DPI/2.54)) %>% png::writePNG(paste0(sub("2019 \\(github\\)/SUD_CL","2022 \\(github\\)",path),"/_figs/_flowchart_merge_wo_fmt2.png"))

htmlwidgets::saveWidget(plot_merge_flowchart_after_dates, paste0(sub("2019 \\(github\\)/SUD_CL","2022 \\(github\\)",path),"/_figs/_flowchart_merge_222_2.html"))
webshot(paste0(sub("2019 \\(github\\)/SUD_CL","2022 \\(github\\)",path),"/_figs/_flowchart_merge_222_2.html"), paste0(sub("2019 \\(github\\)/SUD_CL","2022 \\(github\\)",path),"/_figs/_flowchart_merge_formatted_2.png"),vwidth = 1200, vheight = 900,
        zoom = 2)
```

<br>

# Label

```{r change-labels,echo=T, paged.print=TRUE, eval=F}
invisible("Temporarily useless")
Base_fiscalia_v8%>%
dplyr::mutate_at(c('dg_trs_psiq_cie_10_or','x2_dg_trs_psiq_cie_10_or','x3_dg_trs_psiq_cie_10_or','x2_dg_trs_psiq_sub_cie_10_or','x3_dg_trs_psiq_sub_cie_10_or','compromiso_biopsicosocial','pais_nacimiento','nacionalidad','dg_trs_psiq_sub_dsm_iv_or','x2_dg_trs_psiq_sub_dsm_iv_or','x3_dg_trs_psiq_sub_dsm_iv_or','dg_trs_psiq_sub_cie_10_or','etnia_cor_2','motivodeegreso_mod_imp','fecha_ultimo_tratamiento','fecha_ultimo_tratamiento','tiene_menores_de_edad_a_cargo'),~as.factor(.)) %>%
  dplyr::group_by(hash_key)%>%
  dplyr::mutate(at_least_one_cont_entry=sum(!is.na(diff_bet_treat)))%>%
  ungroup()%>%
  dplyr::mutate(at_least_one_cont_entry= ifelse(at_least_one_cont_entry>0,1,0))%>%
  dplyr::mutate(menor_45_dias_diff= ifelse(diff_bet_treat<45,1,0))%>%
  dplyr::mutate(at_least_one_cont_entry= recode(as.character(at_least_one_cont_entry),"0"="User with no cont. entry","1"="User with cont. entry"))%>%
  dplyr::mutate(menor_45_dias_diff= recode(as.character(menor_45_dias_diff),"0"=">= 45 Days of Difference Between Entries","1"="<45 Days of Difference Between Entries"))%>%
  dplyr::mutate(menor_60_dias_diff= recode(as.character(menor_60_dias_diff),"0"=">= 60 Days of Difference Between Entries","1"="<60 Days of Difference Between Entries"))%>%
  dplyr::mutate(obs_cambios_ninguno= recode(as.character(obs_cambios_ninguno),"0"="At least 1 Change w/ the Next Entry","1"="No Changes w/ the Next Entry"))%>%
  dplyr::mutate(motivoegreso_derivacion= recode(as.character(motivoegreso_derivacion),"0"="Other causes of discharge","1"="Referral"))%>%
  dplyr::mutate_at(vars(at_least_one_cont_entry,menor_45_dias_diff,menor_60_dias_diff,obs_cambios_ninguno,motivoegreso_derivacion,obs_cambios),~as.factor(.))%>%
        dplyr::mutate(familia_delito_rec2=dplyr::case_when(grepl("LESA HUMANIDAD",familia_delito)~"VIOLENT CRIME",
                                                        grepl("SEXUALES",familia_delito)~"VIOLENT CRIME",
                                                        grepl("ROBOS$",familia_delito)~"VIOLENT CRIME",
                                                        grepl("LESIONES$",familia_delito)~"VIOLENT CRIME",
                                                        grepl("HOMICIDIOS$",familia_delito)~"VIOLENT CRIME",
                                                        grepl("DROGAS$",familia_delito)~"DRUG-RELATED CRIME",
                                                        grepl("RELEVANCIA",familia_delito)& grepl("DROGAS",gls_materia)~"DRUG-RELATED CRIME",
                                                        grepl("RELEVANCIA",familia_delito)& grepl("PRESUNTA",gls_materia)~"VIOLENT CRIME",
                                                        grepl("RELEVANCIA",familia_delito)& grepl("MUERTES",gls_materia)~"VIOLENT CRIME",
#2022-09-22
                                                        grepl("LIBERTAD",familia_delito)~"",
                                                        T~"OTHER CHARGES")) %>% 
  assign("Base_fiscalia_v8",., envir = .GlobalEnv)
  
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#

#(rut_enc_saf, fec_nacimiento, pais, sexo, encontrado_como_victima, encontrado_como_imputado, tipo_sujeto_vic, gls_tipo_sujeto_vic, idsujeto_victima, reg, gls_region, idrelacion, ruc, tipo_termino, agrupa_terminos, cod_delito, gls_materia, familia_delito, cod_mottermino, gls_mottermino, impcod_tiposujeto, gls_tipo_imputado, iddelito, fec_comision, marca_pena_44, marca_multa_45, medida_alternativa_46, clasificacion_pena_47, marca_pena_52, marca_multa_53, medida_alternativa_54, clasificacion_pena_55, imp_birth_date, obs, edad_comision_imp, edad_ter_rel_imp, familia_delito_rec, sex_imp, nat_imp2, nat_imp)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#

codebook::var_label(Base_fiscalia_v8) <- list(
row= 'Numerador de los eventos presentes en la Base de Datos/Events in the Dataset',
table= 'Origen de los Datos (de los archivos por año)/Source of Data (of files per year)',
hash_key= 'Codificación del RUN/Masked Identifier (RUN)',
ano_bd= 'Año de la Base de Datos/Year of the Dataset (Source)',
id= 'Codigo Identificación de SENDA/SENDA ID',
nombre_centro= 'Nombre del Centro de Tratamiento/Treatment Center',
tipo_centro= 'Tipo de Centro/Type of Center',
region_del_centro= '(original, Recodificado en nombre_region)/',
servicio_de_salud= 'Servicio de Salud/Health Service',
tipo_de_programa= '(original, Recodificado en tipo_de_programa_2)/',
tipo_de_plan= '(original, Recodificado en tipo_de_plan_2)/',
senda= 'SENDA/SENDA',
dias_trat= 'Días de Tratamiento/Days of Treatment',
nmesesentratamiento= 'Número de Meses en Tratamiento/Number of Months in Treatment',
dias_en_senda= 'Días en SENDA/Days in SENDA',
n_meses_en_senda= 'Número de Meses en SENDA/Number of Months in SENDA',
sexo= '(original, Recodificado en sexo_2)/',
edad= 'Edad (número entero)/Age (In years, Discrete Number)',
nombre_usuario= 'Nombre del Usuario (OCULTO y no accesible)/Name of the User (Not Accessible)',
comuna_residencia= '(original, Recodificado en comuna_residencia_cod)/',
origen_de_ingreso= '(original, Recodificado en origen_ingreso)/',
pais_nacimiento= 'País de Nacimiento/Country of Birth',
nacionalidad= 'Nacionalidad/Nationality',
etnia= '(original, recodificado en etnia_cor)/',
estado_conyugal= '(original, Recodificado en estado_conyugal_2)/',
numero_de_hijos= 'Número de Hijos/Number of Children',
num_hijos_ing_trat_res= 'Número de Hijos para Ingreso a Tratamiento Residencial/Number of Children to Residential Treatment',
parentesco_con_el_jefe_de_hogar= '(Sólo presenta valores perdidos)/',
num_trat_ant= 'Número de Tratamientos Anteriores/Number of Previous Treatments',
fecha_ultimo_tratamiento= 'Fecha del Último Tratamiento/Date of the Last Treatment',
sustancia_de_inicio= '(original, Recodificado en sus_ini)/',
edad_inicio_consumo= '(original, Recodificado en edad_ini_cons)/', 
x_se_trata_mujer_emb= 'Mujer Embarazada al Ingreso/Pregnant at Admission',
escolaridad_ultimo_ano_cursado= '(original, Recodificado en escolaridad)/', 
condicion_ocupacional= '(original, Recodificado en estatus_ocupacional)/', 
categoria_ocupacional= '(original, Recodificado en cat_ocupacional)/',
rubro_trabaja= '(original, Recodificado en rubro_trabaja_mod)/',
con_quien_vive= 'Persona con la que vive el Usuario/People that Share Household with the User',
tipo_de_vivienda= '(original, Recodificado en tipo_de_vivienda_mod)/',
tenencia_de_la_vivienda= '(original, Recodificado en tenencia_de_la_vivienda_mod)/',
sustancia_principal= '(original, Recodificado en sus_principal)/',
`otras_sustancias_nº1`= '(original, Recodificado en otras_sus1)/',
`otras_sustancias_nº2`= '(original, Recodificado en otras_sus2)/',
`otras_sustancias_nº3`= '(original, Recodificado en otras_sus3)/',
freq_cons_sus_prin_original= '(original, Recodificado en freq_cons_sus_prin)/',
edad_inicio_sustancia_principal= '(original, Recodificado en edad_ini_sus_prin)/',
via_adm_sus_prin_original= '(original, Recodificado en via_adm_sus_prin)/',
dg_trs_cons_sus_or= 'Diagnósico de Trastorno por Consumo de Sustancias/Diagnosed of Substance Use Disorder',
dg_trs_psiq_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV/Diagnosis of Psychiatric Disorders, DSM-IV criteria',
dg_trs_psiq_sub_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification)',
x2_dg_trs_psiq_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (2)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (2)',
x2_dg_trs_psiq_sub_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion) (2)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (2)',
x3_dg_trs_psiq_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (3)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (3)',
x3_dg_trs_psiq_sub_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion) (3)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (3)',
dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10/Diagnosis of Psychiatric Disorders, CIE-10 criteria',
dg_trs_psiq_sub_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification)',
x2_dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (2)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (2)',
x2_dg_trs_psiq_sub_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion) (2)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (2)',
x3_dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (3)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (3)',
x3_dg_trs_psiq_sub_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion) (3)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (3)',
diagnostico_trs_fisico= 'Diagnóstico de Trastorno Físico/Diagnosis of Physical Disorder',
otros_probl_at_sm_or= 'Otros Problemas de Atención Vinculados a Salud Mental/Other problems linked to Mental Health',
compromiso_biopsicosocial= 'Compromiso Biopsicosocial/Biopsychosocial Involvement',
dg_global_nec_int_soc_or= 'Diagnóstico Global de Necesidades de Integración Social (Al Ingreso)/Global Diagnosis of Social Integration (At Admission)',
dg_nec_int_soc_cap_hum_or= 'Diagnóstico de Necesidades de Integración Social en Capital Humano (Al Ingreso)/Global Diagnosis of Social Integration in Human Capital (At Admission)',
dg_nec_int_soc_cap_fis_or= 'Diagnóstico de Necesidades de Integración Social en Capital Físico (Al Ingreso)/Global Diagnosis of Social Integration in Physical Capital (At Admission)',
dg_nec_int_soc_cap_soc_or= 'Diagnóstico de Necesidades de Integración Social en Capital Social (Al Ingreso)/Global Diagnosis of Social Integration in Social Capital (At Admission)',
fech_ing= 'Fecha de Ingreso a Tratamiento/Date of Admission to Treatment',
fecha_ingreso_a_convenio_senda= 'Fecha de Ingreso a Convenio SENDA (aún no formateada como fecha)/Date of Admission to SENDA Agreement',
usuario_tribunal_trat_droga= 'Usuario de modalidad Tribunales de Tratamiento de Drogas/User of Drug Treatment Courts Modality',
consentimiento_informado= 'Consentimiento Informado/Informed Consent',
fech_egres= 'Fecha de Egreso de Tratamiento/Date of Discharge from Treatment',
motivodeegreso= 'Motivo de Egreso/Cause of Discharge',
tipo_centro_derivacion= 'Tipo de Centro al que el Usuario es Derivado/Type of Center of Derivation',
evaluacindelprocesoteraputico= 'Evaluación del Proceso Terapéutico/Evaluation of the Therapeutic Process',
eva_consumo= 'Evaluación al Egreso Respecto al Patrón de consumo/Evaluation at Discharge regarding to Consumption Pattern',
eva_fam= 'Evaluación al Egreso Respecto a Situación Familiar/Evaluation at Discharge regarding to Family Situation',
eva_relinterp= 'Evaluación al Egreso Respecto a Relaciones Interpersonales/Evaluation at Discharge regarding to Interpersonal Relations',
eva_ocupacion= 'Evaluación al Egreso Respecto a Situación Ocupacional/Evaluation at Discharge regarding to Occupational Status',
eva_sm= 'Evaluación al Egreso Respecto a Salud Mental/Evaluation at Discharge regarding to Mental Health',
eva_fisica= 'Evaluación al Egreso Respecto a Salud Física/Evaluation at Discharge regarding to Physical Health',
eva_transgnorma= 'Evaluación al Egreso Respecto a Trasgresión a la Norma Social/Evaluation at Discharge regarding to Transgression to the Norm',
dg_trs_psiq_cie_10_egres_or= '(Sólo presenta valores perdidos)/',
dg_global_nec_int_soc_or_1= 'Diagnóstico Global de Necesidades de Integración Social (Al Egreso)/Global Diagnosis of Social Integration (At Discharge)',
dg_nec_int_soc_cap_hum_or_1= 'Diagnóstico de Necesidades de Integración Social en Capital Humano (Al Egreso)/Global Diagnosis of Social Integration in Human Capital (At Discharge)',
dg_nec_int_soc_cap_fis_or_1= 'Diagnóstico de Necesidades de Integración Social en Capital Físico (Al Egreso)/Global Diagnosis of Social Integration in Physical Capital (At Discharge)',
dg_nec_int_soc_cap_soc_or_1= 'Diagnóstico de Necesidades de Integración Social en Capital Social (Al Egreso)/Global Diagnosis of Social Integration in Social Capital (At Discharge)',
tiene_menores_de_edad_a_cargo= 'Menores de Edad A Cargo/Minor Dependants',
mot_egres_alt_adm_or= 'Motivo de Egreso Alta Administrativa/Cause of Administrative Discharge',
consorcio=  'Sociedades de Tratamiento Servicios de Salud- Fundaciones- entre otras entidades encargadas de los centros/Consortium',
id_centro= 'ID de Centro/Treatment center ID',
ha_estado_embarazada_egreso= '¿Ha estado embarazada? (al Egreso)/Have you been Pregnant (at Discharge)',
identidad_de_genero= 'Identidad de Género/Gender Identity',
discapacidad= 'Presenta Discapacidad/Disability',
hash_rut_completo= 'HASH alternativo, en el escenario en que se asuma que el individuo al que se le codificó el RUN presente mayor edad/Alternative HASH-Key',
opcion_discapacidad= 'Origen de Discapacidad/Cause of Disability',
sexo_2= 'Sexo Usuario/Sex of User',
embarazo= 'Embarazo al Ingreso /Pregnant at Admission',
tipo_de_plan_2= 'Tipo de Plan/Type of Plan',
tipo_de_programa_2= 'Tipo de Programa de Tratamiento/Type of Program',
fech_egres_sin_fmt= 'Fecha de Egreso de Tratamiento (Sin Formato de Fecha)/Date of Discharge',
id_mod= 'ID de SENDA para Presentación en Página Web (enmascara caracteres 5 y 6)/SENDA ID (mask characters 5 & 6)',
ano_nac= 'Año de Nacimiento (numérico)/Year of Birth (numeric)',
fech_ing_ano= 'Año de Ingreso (numérico)/Year of Admission (numeric)',
fech_ing_mes= 'Mes de Ingreso (numérico)/Month of Admission (numeric)',
fech_ing_dia= 'Día de Ingreso (numérico)/Day of Admission (numeric)',
concat= 'ID de SENDA y HASH Concatenado (permite discriminar más de un HASH en un mismo ID)/Combination of SENDA ID & HASH',
obs= 'Observaciones al Proceso de Limpieza y Estandarización de Casos/Observations to the Process of Data Tidying & Standardization',
dias_trat_inv= 'Días de Tratamiento Invertidos (fecha más reciente, menor valor numérico)/Treatment Days (Reversed)',
fech_nac= 'Fecha de Nacimiento/Date of Birth',
edad_al_ing= 'Edad a la Fecha de Ingreso a Tratamiento (numérico continuo)/Age at Admission to Treatment',
edad_ini_cons= 'Edad de Inicio de Consumo/Age of the Onset of Drug Use',
edad_ini_sus_prin=  'Edad de Inicio de Consumo Sustancia Principal/Age of the Onset of Drug Use of Primary Substance',
dias_trat_alta_temprana= 'Días de tratamiento (<90)/Less than 90 days in treatment',
motivodeegreso_mod= 'Motivo de Egreso (con abandono temprano y tardío)/Cause of Discharge (with late and early withdrawal)',
sus_principal= 'Sustancia Principal de Consumo/Primary or Main Substance of Consumption at Admission',
otras_sus1= 'Otras Sustancias (1)/Other Substances (1)',
otras_sus2= 'Otras Sustancias (2)/Other Substances (2)',
otras_sus3= 'Otras Sustancias (3)/Other Substances (3)',
sus_ini= 'Sustancia de Inicio/Starting Substance',
estado_conyugal_2= 'Estado Conyugal/Marital Status',
estatus_ocupacional= 'Condición Ocupacional/Occupational Status',
cat_ocupacional= 'Categoría Ocupacional/Occupational Category',
edad_grupos= 'Edad agrupada/Age in groups',
origen_ingreso= "(modificado en origen_ingreso_mod)/",
escolaridad= 'Escolaridad: Nivel Eduacional/Educational Attainment',
via_adm_sus_prin= 'Vía de Administración de la Sustancia Principal/Route of Administration of the Primary or Main Substance',
freq_cons_sus_prin= 'Frecuencia de Consumo de la Sustancia Principal (30 días previos a la admisión)/Frequency of Consumption of the Primary or Main Substance (30 days previous to admission)',
dias_trat_knn_imp= 'Días de Tratamiento (Imputados KNN)/Days of Treatment (Imputed KNN)',
fech_egres_knn_imp= 'Fecha de Egreso (Imputados KNN)/Date of Discharge (Imputed KNN)',
dias_trat_alta_temprana_knn_imp= 'Días de Tratamiento con Alta Temprana (<90) (Imputados KNN)/Days of Treatment w Early Withdrawal (Imputed KNN)',
fech_egres_imp= 'Fecha de Egreso (Imputados KNN & Lógico)/Date of Discharge (Imputed KNN & Logic)',
motivodeegreso_imp= 'Motivo de Egreso(Imputados KNN & Lógico)/Cause of Discharge (Imputed KNN & Logic)',
motivodeegreso_mod_imp= 'Motivo de Egreso (con abandono temprano y tardío)(Imputados KNN & Lógico)/Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic)',
dias_trat_imp= 'Días de Tratamiento (Imputados KNN & Lógico)/Days of Treatment (Imputed KNN & Logic)', 
dias_trat_alta_temprana_imp= 'Días de Tratamiento con Alta Temprana (<90) (Imputados KNN & Lógico)/Days of Treatment w Early Withdrawal (Imputed KNN & Logic)',
via_adm_sus_prin_act= 'Vía de Administración de la Sustancia Principal (Se aplicaron criterios de limpieza)/Route of Administration of the Primary or Main Substance (Tidy)',
etnia_cor= 'Etnia/Ethnic Group',
nacionalidad_2= 'Segunda Nacionalidad/Second Nationality',
etnia_cor_2= 'Etnia (2)/Second Ethnic Group',
sus_ini_2= 'Segunda Sustancia de Inicio/Second Starting Substance',
sus_ini_3= 'Tercera Sustancia de Inicio/Third Starting Substance',
concat_hash_sus_prin= 'Combination of User & Primary Substance',
macrozona= "Macrozona/Macrozones",
nombre_region= " Región del Centro/Chilean Region of the Center",
comuna_residencia_cod= "Comuna de Residencia/Municipality or District of Residence",
sus_ini_mod= "Sustancia de Inicio (Sólo más frecuentes)/Starting Substance (Only more frequent)",
sus_principal_mod= 'Sustancia Principal de Consumo (Sólo más frecuentes)/Primary or Main Substance of Consumption at Admission (Only more frequent)',
origen_ingreso_mod= 'Origen de Ingreso/Motive of Admission to Treatment',
tipo_de_vivienda_mod= 'Tipo de Vivienda/Type of Housing', 
tenencia_de_la_vivienda_mod= 'Tenencia de la Vivienda/Tenure status of Households',
rubro_trabaja_mod= 'Rubro de Trabajo/Area of Work',
edad_al_ing_grupos= 'Edad a la Fecha de Ingreso a Tratamiento en Grupos/Age at Admission to Treatment In Groups',
menor_60_dias_diff= 'Menor a 60 días de diferencia con el registro posterior/Menor a 60 days of difference between the next entry',
menor_45_dias_diff= 'Menor a 45 días de diferencia con el registro posterior/Less than 45 days of difference between the next entry',
diff_bet_treat= 'Días de diferencia con el registro posterior/Days of difference between the next entry',
id_centro_sig_trat= "ID del Centro del registro posterior/Center ID of the Next Treatment",
tipo_plan_sig_trat= "Tipo de Plan del registro posterior/Type of Plan of the Next Entry",
tipo_programa_sig_trat= "Tipo de Programa del registro posterior/Type of Program of the Next Entry", 
senda_sig_trat= "SENDA del registro posterior/SENDA of the Next Entry",
motivoegreso_derivacion= "Motivo de Egreso= Derivación/Cause of Discharge= Derivación",
obs_cambios= "Cambios del tratamiento en comparación al registro posterior/Changes in treatment compared to the Next Entry",
obs_cambios_ninguno= "Sin cambios del tratamiento en comparación al registro posterior/No changes in treatment compared to the Next Entry",
obs_cambios_num= "Recuento de cambios del tratamiento en comparación al registro posterior/Count of changes in treatment compared to the Next Entry",
obs_cambios_fac= "Recuento de cambios del tratamiento en comparación al registro posterior(factor)/Count of changes in treatment compared to the Next Entry(factor)",
at_least_one_cont_entry= "Casos de Usuarios con más de una entrada después de otra/Cases of users with more than one entry after another one"
)
```

# Session Info

```{r session-info, echo=T, error=T, message=TRUE, paged.print=TRUE}
message(Sys.getenv("R_LIBS_USER"))
Sys.Date()
message(paste0("Editor context: ", path))

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/13.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/13.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/13.RData")
  } else {
    save.image(paste0(sub("2019","2022",sub("SUD_CL","",path)),"13.RData"))
  }
rstudioapi::getSourceEditorContext()

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}")))
```

# Export

```{r export, warning=FALSE, echo=T, error=T}
invisible("Exported database in 22-09-2022")
CONS_C1_df_dup_SEP_2020_22<-
CONS_C1_df_dup_SEP_2020 %>% 
  subset(select= c("hash_key", "dup", "ano_bd_first", "duplicates_filtered", "id_centro", "tipo_centro", "tipo_de_programa_2", "tipo_de_plan_2", "senda", "macrozona", "nombre_region", "escolaridad_rec", "estado_conyugal_2", "compromiso_biopsicosocial", "edad_ini_cons", "edad_ini_sus_prin" ,"edad_ini_sus_prin_grupos", "freq_cons_sus_prin", "via_adm_sus_prin_act", 
"sus_ini_2_mod", "sus_ini_3_mod", "sus_ini_mod", "con_quien_vive", "sus_principal_mod", "tipo_de_vivienda_mod", "tenencia_de_la_vivienda_mod", "rubro_trabaja_mod", "cat_ocupacional", "estatus_ocupacional", "sus_ini_mod_mvv","cat_ocupacional_corr", "condicion_ocupacional_corr", "otras_sus1_mod", "otras_sus2_mod",  "otras_sus3_mod", "fech_ing_num", "fech_egres_num", "motivodeegreso_mod_imp","motivoegreso_derivacion", "evaluacindelprocesoteraputico",
paste0("tipo_de_plan_2_",1:10),paste0("motivodeegreso_mod_imp_",1:10),
paste0("dias_treat_imp_sin_na_",1:10), "dg_trs_cons_sus_or", "dg_total_cie_10", "dg_cie_10_rec", "dg_total_dsm_iv", "dg_dsm_iv_rec", "cnt_diagnostico_trs_fisico", "diagnostico_trs_fisico", "dg_fis_anemia", "dg_fis_card", "dg_fis_in_study", "dg_fis_enf_som", "dg_fis_ets", "dg_fis_hep_alc", "dg_fis_hep_b", "dg_fis_hep_cro", "dg_fis_inf", "dg_fis_otr_cond_fis_ries_vit", "dg_fis_otr_cond_fis", "dg_fis_pat_buc", "dg_fis_pat_ges_intrau", "dg_fis_trau_sec", "otros_pr_sm_abu_sex", "otros_pr_sm_exp_com_sex", "otros_pr_sm_otros", "otros_pr_sm_vif")) %>% 
    dplyr::mutate(comorbidity_icd_10=dplyr::case_when(dg_total_cie_10>=2~ "Two or more", dg_total_cie_10==1~ "One", as.character(dg_cie_10_rec)=="Diagnosis unknown (under study)"~"Diagnosis unknown (under study)", as.character(dg_cie_10_rec)=="Without psychiatric comorbidity"~"Without psychiatric comorbidity")) %>%
  dplyr::mutate(comorbidity_icd_10=as.factor(comorbidity_icd_10)) %>% 
    dplyr::mutate(estatus_ocupacional= dplyr::case_when(!is.na(cat_ocupacional)&!is.na(estatus_ocupacional)~"Empleado", TRUE~as.character(estatus_ocupacional)))%>% 
  dplyr::mutate(estatus_ocupacional= as.factor(estatus_ocupacional))%>% 
  dplyr::mutate(cnt_mod_cie_10_dg_cons_sus_or= dplyr::case_when(as.character(dg_trs_cons_sus_or)=="Drug dependence"~dg_total_cie_10+1, TRUE~dg_total_cie_10))%>% 
  dplyr::mutate(freq_cons_sus_prin= dplyr::case_when(as.character(freq_cons_sus_prin)=="Did not use"~ "Less than 1 day a week", TRUE~as.character(freq_cons_sus_prin)))%>% 
  dplyr::mutate(freq_cons_sus_prin= as.factor(freq_cons_sus_prin)) %>% 
    dplyr::mutate(tipo_centro_pub= factor(dplyr::if_else(as.character(tipo_centro)=="Public",TRUE,FALSE,NA))) %>%  dplyr::mutate(dg_trs_fis_rec= factor(dplyr::case_when(as.character(diagnostico_trs_fisico)=="En estudio"~"Diagnosis unknown (under study)",as.character(diagnostico_trs_fisico)=="Sin trastorno"~'Without physical comorbidity',cnt_diagnostico_trs_fisico>0 ~'With physical comorbidity',
                                             TRUE~NA_character_)))%>%
    dplyr::mutate(escolaridad_rec= readr::parse_factor(as.character(escolaridad_rec),levels=c('3-Completed primary school or less', '2-Completed high school or less', '1-More than high school'), ordered=T,trim_ws=T,include_na =F, locale=readr::locale(encoding = "Latin1"))) %>%   
dplyr::mutate(freq_cons_sus_prin= readr::parse_factor(as.character(freq_cons_sus_prin),levels=c('Did not use', 'Less than 1 day a week','2 to 3 days a week','4 to 6 days a week','1 day a week or more','Daily'), ordered =T,trim_ws=T,include_na =F, locale=readr::locale(encoding = "UTF-8"))) %>% 
  dplyr::mutate(evaluacindelprocesoteraputico= dplyr::case_when(grepl("1",as.character(evaluacindelprocesoteraputico))~'1-High Achievement',grepl("2",as.character(evaluacindelprocesoteraputico))~'2-Medium Achievement',grepl("3",as.character(evaluacindelprocesoteraputico))~'3-Minimum Achievement', TRUE~as.character(evaluacindelprocesoteraputico))) %>% 
  dplyr::mutate(evaluacindelprocesoteraputico= readr::parse_factor(as.character(evaluacindelprocesoteraputico),levels=c('1-High Achievement', '2-Medium Achievement','3-Minimum Achievement'), ordered =T,trim_ws=T,include_na =F, locale=readr::locale(encoding = "UTF-8"))) %>% 
    dplyr::mutate(tenencia_de_la_vivienda_mod= factor(dplyr::case_when(tenencia_de_la_vivienda_mod=="Allegado"~"Stays temporarily with a relative", tenencia_de_la_vivienda_mod=="Arrienda"~"Renting", tenencia_de_la_vivienda_mod=="Cedida"~"Owner/Transferred dwellings/Pays Dividends", tenencia_de_la_vivienda_mod=="Ocupación Irregular"~"Illegal Settlement", tenencia_de_la_vivienda_mod=="Otros"~"Others", tenencia_de_la_vivienda_mod=="Paga dividendo"~"Owner/Transferred dwellings/Pays Dividends", tenencia_de_la_vivienda_mod=="Propia"~"Owner/Transferred dwellings/Pays Dividends", T~NA_character_))) %>% 
  dplyr::mutate(freq_cons_sus_prin=dplyr::case_when(freq_cons_sus_prin=="1 day a week or less"~"1 day a week or more",T~as.character(freq_cons_sus_prin))) %>% 
  dplyr::mutate(freq_cons_sus_prin=ordered(freq_cons_sus_prin,levels=c("Did not use", "Less than 1 day a week", "1 day a week or more", "2 to 3 days a week","4 to 6 days a week", "Daily"))) %>%   
  data.table::data.table() %>% 
    dplyr::group_by(hash_key) %>% 
  dplyr::mutate(rn_hash_discard=row_number())%>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(fech_ing_num_discard=fech_ing_num, fech_egres_num_discard= fech_egres_num) %>% 
   tidyr::pivot_wider(
    names_from =  rn_hash_discard, 
    names_sep="_",
    values_from = c(fech_ing_num_discard, fech_egres_num_discard))%>% #glimpse() 
     dplyr::group_by(hash_key)%>%
  dplyr::mutate_at(vars(fech_ing_num_discard_1:fech_egres_num_discard_10),~suppressWarnings(max(as.character(.),na.rm=T)))%>%
  dplyr::ungroup()
 
name_vec <- setNames(c(paste0("fech_ing_num_discard_",1:10),paste0("fech_egres_num_discard_",1:10)),c(paste0("fech_ing_num_",1:10),paste0("fech_egres_num_",1:10)))

CONS_C1_df_dup_SEP_2020_22<-
CONS_C1_df_dup_SEP_2020_22 %>% rename(!!!name_vec)

#_#_#_#_#_#__#_#_#_#_#_#_

Base_fiscalia_v8 %>% 
  #arrange the rut from the first date of comission of a crime, but we are not detecting if he/she is the victim or not
  dplyr::arrange(rut_enc_saf, fec_comision_simple) %>% 
  dplyr::left_join(subset(CONS_C1_df_dup_SEP_2020_22, subset= dup==1),by=c("rut_enc_saf"="hash_key")) %>%
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_sep_2022_match_SENDA.dta"))
  
Base_fiscalia_v8 %>% 
    rio::export(file = paste0("fiscalia_mariel_sep_2022.dta"))

invisible("Temporarily useless")
# ```{r label_to_stata, echo=T, paged.print=TRUE}
# 
# export_lab_stata_merge<-
#   tibble::rownames_to_column(data.frame(Hmisc::label(Base_fiscalia_v2)))%>% data.frame() %>%
#   dplyr::rename("code" = !!names(.[1]), "label" = !!names(.[2]))%>% data.frame()%>%
#   dplyr::mutate(first= "cap noi label variable")%>%
#   dplyr::mutate(final= paste0(first, " ",code,' "',label,'"'))%>%
#   dplyr::select(-code,-label,-first)%>%
#   dplyr::rename("*clear all"="final") %>% 
#   rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\fiscalia_mariel_ago_2022.dta", replace'))%>%
#   rbind('cap noi drop id id_mod nombre_centro consentimiento_informado')%>%
#   rbind('cap noi drop id id_mod nombre_centro')%>%
#   rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\fiscalia_mariel_ago_2022.dta", replace'))
# 
# rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\fiscalia_mariel_ago_2022.dta", clear'),export_lab_stata_merge) %>% knitr::kable("html") %>% 
#     kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size =10) %>% 
#   kableExtra::scroll_box(width = "100%", height = "375px")
# 
# write.table(rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\fiscalia_mariel_ago_2022.dta", clear'),export_lab_stata_merge), file = paste0(path,"/SUD_CL/_label_var_to_stata.do"), sep = "",row.names = FALSE, quote = FALSE, fileEncoding="UTF-8")
# ```
# 
# <br>
# 
# <div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
# 
# ```{stata 2, collectcode=F, include=T, error=T, cleanlog=F}
# *should be in the same folder of the .Rmd to work
# cap noi do _label_var_to_stata.do
# ```
# 
# </div>
```
