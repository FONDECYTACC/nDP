---
title: "Individual offenses eported in TOP databases and Prossecutors Office's Records"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  distill::distill_article:
    code_folding: true
    fig_height: 6
    fig_width: 8
    theme: flatly
    toc: yes
    toc_depth: 5
    toc_float: yes
    output_dir: "docs"
  toc_float:
    collapsed: false
    smooth_scroll: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 

```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }

.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }

.centrado {
    text-align: center;
}

.table.center {
    margin-left:auto; 
    margin-right:auto;
  }

/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/

/* Applies to outputs that are not code other than R*/

pre {
  overflow-x: auto !important
  line-height: 1 !important
  font-size: 9px !important;
}
pre code {
  word-wrap: normal !important;
  white-space: pre !important;
  line-height: 1 !important;
  font-size: 9px !important;
}

/*   
font-size: 0.8em;  
*/

/* 
https://stackoverflow.com/questions/25646333/code-chunk-font-size-in-rmarkdown-with-knitr-and-latex 
*/

/*
pre:not(.sourceCode) { 
  white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence  */
  font-size: 9px !important;
  line-height: 50% !important;
}

body{ /* Normal  */
      text-align: justify;
  }

.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: auto; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}

.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}

.pandoc-table { /* Should add !important; but it seems no necessary  */
  margin-left:auto; /* To center */
  margin-right:auto;
  border-collapse: collapse;
  table-layout: auto;
  font-size: 11px;
  overflow-y: auto;
  max-height:450px !important;
  white-space: nowrap;
  overflow-x: auto; 
  width:450px;
}

.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}

.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0px;
}

.pandoc-table caption {
    text-align: left !important;
    font-size: 11px !important;
}

.controlly{
    overflow-y:scroll;
    height:350px;
    overflow-x: scroll; 
}


.controlly2{
    overflow-y:scroll;
    height:550px;
    overflow-x: scroll; 
}

</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```

```{r prev-setup, include = FALSE, cache=T, error=T}
rm(list=ls());gc()
if(!grepl("4.1.2",R.version.string)){stop("Different version (must be 4.1.2)")}
path<-getwd()#we define it again later in setup chunk
if (grepl("CISS Fondecyt",path)==T){
  try(setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)"));load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
} else if (grepl("andre",path)==T){
  try(setwd('C:/Users/andre/Desktop/SUD_CL/'));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
} else if (grepl("E:",path)==T){
  try(setwd("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/SUD_CL/"));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
} else {
  try(setwd(paste0(path)));load(paste0(gsub("SUD_CL","",gsub("2022","2019",path)),"/14.Rdata"))
}
library(tidyverse)


#If you render multiple documents from the same script or R session, you should detach("Statamarkdown") in between documents.
try(detach("Statamarkdown"))

if(!grepl("4.1.2",R.version.string)){stop("Different version (must be 4.1.2)")}
path<-getwd()#we define it again later in setup chunk

```

```{r setup, include = FALSE, cache=T, error=T, echo=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(try(dplyr::ungroup(x)))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  

pacman::p_unlock(lib.loc = .libPaths()) #para no tener problemas reinstalando paquetes

if(!require(pacman)){install.packages("pacman")}
if(!require(devtools)){install.packages("devtools", type = "win.binary", dependencies=T)}

pacman::p_load(ggpattern, withr, boot, matrixStats, knitr, tidyr, 
               stringi,stringr, ggplot2, Hmisc, kableExtra, plotly, janitor, 
               rbokeh, zoo, broom, sqldf, devtools, codebook, data.table, panelr, 
               RColorBrewer, lsmeans, finalfit, ggiraph, sf, treemapify, dplyr, 
               tidyverse, epiR, survminer, ggfortify, survMisc, foreign, reshape2, 
               stargazer, tableone, MatchIt, cobalt, eha, igraph, Amelia, DiagrammeR, 
               DiagrammeRsvg, rsvg, mstate, htmltools, webshot, flexsurv, muhaz, Metrics, 
               rpivotTable, caret, polycor, ClusterR, flextable, ggstatsplot, ggside, psych,
               daff, explore, sjPlot, compareGroups, job, missForest, showtext, ggpattern, 
               distill, showtext, googleVis, tidylog, magick, dlookr, easystats, tidylog, 
               sqldf,  adjustedCurves, ggpmisc, rms, irrCAC, xaringanExtra, VGAM, mlogit, rpart,
               rpart.plot, partykit, randomForest, nn, car, WeightedROC, WeightIt, nstall=T)

xaringanExtra::use_panelset()
#Error in if (options$noisey == TRUE) message(paste("\n", options$engine, : argument is of length zero


if(!require(survcomp)){try(devtools::install_github("bhklab/survcomp",upgrade ="never"))}

try(webshot::install_phantomjs())

if(!require(bpmn)){try(devtools::install_github("bergant/bpmn",upgrade ="never"))}


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

if(.Platform$OS.type == "windows") withAutoprint({
  memory.size()
  memory.size(TRUE)
  memory.limit()
})
memory.limit(size=56000)

path<-dirname(rstudioapi::getSourceEditorContext()$path)

options(knitr.kable.NA = '')


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- ifelse(difftime(Sys.time(), now)>(60^2),difftime(Sys.time(), now)/(60^2),difftime(Sys.time(), now)/(60^1))
      # return a character string to show the time
      x<-ifelse(difftime(Sys.time(), now)>(60^2),paste("Time for this code chunk to run:", round(res,1), "hours"),paste("Time for this code chunk to run:", round(res,1), "minutes"))
      paste('<div class="message">', gsub('##', '\n', x),'</div>', sep = '\n')
    }
  }
}))
knitr::opts_chunk$set(time_it = TRUE)
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#to format rows in bold
format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  # one * for italics, two ** for bold
  map <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  

  for (r in rows){
    for(c in cols){

      # Make sure values are not factors
      df[[c]] <- as.character( df[[c]])

      # Update formatting
      df[r, c] <- ifelse(nchar(df[r, c])==0,"",paste0(markup, gsub(" ", "", df[r, c]), markup))
    }
  }

  return(df)
}
#To produce line breaks in messages and warnings
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('<div class="message">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
)
```


::: blue

- Generate flowcharts of joins

- Kappa y MLs for classification

:::

<!--- 
# - https://www.statology.org/cohens-kappa-in-r/
# - 
--->

<br>

# Bring other databases

```{r bring_db1, echo=T, fig.align='center', message=T, error=T, eval=T}

### 1.- What is Base_fiscalia_v9, why it has 49,970 IDs & 174,961 rows : paste0("Patients in PO records with unique combination of ID, RUC, end type and date of comission of the offense and offense ", a_tab11_lab_aft_d1 (p= 5,470; RUCs= 5,993; n= 8,291) --> should be only people that commit offenses, not victims)

### 2.- why the difference of 49,970- 49,252????
### 3.- 

Base_fiscalia_v10b_dic_2022<-
  sqldf("SELECT *
  FROM CONS_C1_df_dup_SEP_2020_22_d AS x  
  LEFT JOIN (SELECT *
             FROM Base_fiscalia_v9
             ) AS y
  ON x.hash_key == y.id AND 
  x.dup = 1
  ") #2022-11-25  added dup // #changed the direction to past events, where age at discharge is greater than the age of commission //FEB 2023: WHERE ano_bd_first='2015' OR ano_bd_first='2016' OR ano_bd_first='2017' OR ano_bd_first='2018' OR ano_bd_first='2019'

message(
paste0("First, for each baseline admission of patients in C1 (", format(length(unique(CONS_C1_df_dup_SEP_2020_22_d$hash_key)), big.mark=","), "; n= ",format(nrow(CONS_C1_df_dup_SEP_2020_22_d), big.mark=","),"), we found the PO records in which is found as the offender (p=", format(length(unique(Base_fiscalia_v9$id)), big.mark=","), "; n= ",format(nrow(Base_fiscalia_v9), big.mark=","),") (p= ", format(length(unique(Base_fiscalia_v10b_dic_2022$hash_key)), big.mark=","), "; n= ",format(nrow(Base_fiscalia_v10b_dic_2022), big.mark=","),"). We did not exclude patients in C1 that were registered in databases before 2015 in this step (Feb 2023)")
)

invisible("49,970 patients")

Base_fiscalia_v11b_dic_2022<-
  Base_fiscalia_v10b_dic_2022 %>% 
  #discrepancies in names of variables
  janitor::clean_names() %>%   #janitor::tabyl(!is.na(dob_imp_num))
  #previously recoded, 
  dplyr::select(-dateofbirth_imp, -country, -victim, -id_victim, -crime_code_c , -reg_c, -end_type_2c, -cod_comunadelito, -cod_lugarocurrencia, -sex_imp, -region_delito, -filter, -id)%>%
  plyr::rename(c("dateofbirth_imp_2"="dateofbirth_imp")) %>% 
  dplyr::ungroup() %>% 
  #selected the first row with distinct information regarding patient ID, case ID, crime code.
  dplyr::group_by(hash_key, dateofbirth_imp, caseid, crime_code_group_rec_prof) %>%
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(hash_key,dateofbirth_imp) %>% 
  summarise(n_off_acq= ifelse(sum(crime_code_group_rec_prof=="Acquisitive", na.rm=T)>0, 1,0), n_off_vio= ifelse(sum(crime_code_group_rec_prof=="Violent", na.rm=T)>0, 1,0), n_off_sud= ifelse(sum(crime_code_group_rec_prof== "Substance-related", na.rm=T)>0, 1,0), n_off_oth=  ifelse(sum(crime_code_group_rec_prof== "Other", na.rm=T)>0, 1,0)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(n_off= rowSums(dplyr::select(., dplyr::starts_with("n_")), na.rm=T)) 

message(paste0( "Afterwards, we counted the offenses by type of offense (Acquisitive, violent, substance-related and other) and the total by each user before baseline admisson (p= ", format(length(unique(Base_fiscalia_v11b_dic_2022$hash_key)), big.mark=","), "; cases with records in P.O.= ",format(as.numeric(table(is.na(Base_fiscalia_v10b_dic_2022$dateofbirth_imp))[[2]]), big.mark=","),")." ))
```

```{r bring_db2, echo=T, fig.align='center', message=T, error=T, eval=T}
#Registrar hurtos, robos, violencia intrafamiliar y otras acciones cometidas en las últimas 4 semanas
#Violencia Intrafamiliar (Maltrato físico o psicológico)
CONS_TOP_2022<-
  # 107307
  CONS_TOP%>% 
  # dplyr::left_join(subset(dplyr::mutate(dplyr::group_by(Base_fiscalia_v9, id), hash_rn=row_number())%>% ungroup(), hash_rn==1), by= c("HASH_KEY" = "id"))%>% 
  dplyr::left_join(subset(dplyr::mutate(dplyr::group_by(Base_fiscalia_v11b_dic_2022, hash_key), hash_rn=row_number())%>% ungroup(), hash_rn==1), by= c("HASH_KEY" = "hash_key"))%>% 
  dplyr::mutate(fech_ap_top_num= as.numeric(as.Date(str_sub(as.character(lubridate::parse_date_time(Fecha.Aplicación.TOP, c("%Y-%m-%d"),exact=T)),1,10))))%>% #No parse failures
  dplyr::select(HASH_KEY, fech_ap_top_num, Fecha.Aplicación.TOP, dateofbirth_imp, Hurto, Robo, Venta.Drogas, Riña, Total.VIF, Otro) %>% 
  dplyr::filter(!is.na(HASH_KEY)) %>% 
  dplyr::mutate_at(vars("Hurto", "Robo", "Venta.Drogas", "Riña", "Otro"), ~ifelse(.=="S",1,0)) %>% 
  dplyr::mutate(Total.VIF= ifelse(Total.VIF>0,1,0))%>% 
  dplyr::mutate(tot_off_top = base::rowSums(dplyr::select(.,c(Hurto, Robo, Venta.Drogas, Riña, Total.VIF, Otro)), na.rm = T)) %>% 
  dplyr::mutate(dateofbirth_imp_num= as.numeric(dateofbirth_imp),
                fech_ap_top= lubridate::parse_date_time(Fecha.Aplicación.TOP, c("%Y-%m-%d"),exact=T),
                edad_a_ap_top_num= lubridate::time_length(lubridate::interval(dateofbirth_imp, fech_ap_top),unit="years"),
                edad_b_ap_top_num= (fech_ap_top_num-dateofbirth_imp_num)/365.25,
                edad_a_ap_top_num_lim= edad_a_ap_top_num-(1/12),
                edad_b_ap_top_num_lim= edad_b_ap_top_num-(1/12)) %>% 
  dplyr::select(-dateofbirth_imp, -dateofbirth_imp_num) %>% 
  dplyr::filter(!is.na(edad_a_ap_top_num)) %>% 
  dplyr::group_by(HASH_KEY, edad_a_ap_top_num) %>%
  dplyr::slice(1) %>% 
  dplyr::ungroup()



message(paste0("Then, we standardized the varibles in TOP (e.g., dates format) and counted self-reported offenses, and also we standardized data with PO records (dates of birth) to get the age when the patient have answered TOP and the age previous [ (1/12)*365.25 ]=",round((1/12)*365.25,0)," days before TOP application. This resulted in ", format(nrow(CONS_TOP_2022), big.mark=","), " rows (combination of different application dates and patients) of ", format(length(unique(CONS_TOP_2022$HASH_KEY)), big.mark=","), " patients."))

```

```{r bring_db3, echo=T, fig.align='center', message=T, error=T, eval=T}
Base_fiscalia_v9_dic_2022<-
Base_fiscalia_v9 %>% 
  dplyr::group_by(id, caseid, end_type, fec_comision_simple, crime_code_c) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()

message(
paste0("We reduced PO records to those that do not have the same sentence for the same offense committed at the same date in the same process (case ID/RUC) (p= ", format(length(unique(Base_fiscalia_v9_dic_2022$id)), big.mark=","), "; n= ",format(nrow(Base_fiscalia_v9_dic_2022), big.mark=","),")")
)

#busco en la base de datos de fiscalía, algún delito que haya cometido en el transcurso 
#del último mes anterior a la aplicación del TOP
Base_fiscalia_v13c_dic_2022<-
  sqldf("SELECT *
  FROM CONS_TOP_2022 AS x  
  LEFT JOIN (SELECT *
             FROM Base_fiscalia_v9_dic_2022
             ) AS y
  ON x.HASH_KEY == y.id AND 
  x.edad_a_ap_top_num > y.age_offending_imp AND 
  x.edad_a_ap_top_num_lim < y.age_offending_imp") #2022-11-25  added dup // #changed the direction to past events, where age at discharge is greater than the age of commission

message(
paste0("Of the total of TOP applications (p= ", format(length(unique(CONS_TOP_2022$HASH_KEY)), big.mark=","), "; n= ",format(nrow(CONS_TOP_2022), big.mark=","),"), we looked for offenses comitted in the period of thirty days before (`x.edad_a_ap_top_num_lim`) the application of TOP (p= ", format(length(unique(Base_fiscalia_v13c_dic_2022$HASH_KEY)), big.mark=","), "; n= ",format(nrow(Base_fiscalia_v13c_dic_2022), big.mark=","),"). If this database contains more records, is beacause there may be some patients that had more than one record as a result of more than one application of TOP. This will be resolved in the next step")
)

#Luego, contar por cada combinación de HASH y fecha de aplicación, el número de delitos segun familai de delito
#crime_code_group
Base_fiscalia_v13c_dic_2022_2<-
  Base_fiscalia_v13c_dic_2022 %>% 
  dplyr::select(tidyr::any_of(c("HASH_KEY", "fech_ap_top_num", "Fecha.Aplicación.TOP", "Hurto", "Robo", "Venta.Drogas", "Riña",
                "Total.VIF", "Otro", "tot_off_top", "fech_ap_top", "edad_a_ap_top_num", "edad_b_ap_top_num",
                "edad_a_ap_top_num_lim", "edad_b_ap_top_num_lim", "caseid", "end_type", "fec_comision_simple",
                "crime_code_c", "crime_code_group_rec", "crime_code_group_rec_prof", "age_offending_imp")))
#HASH_KEY
#fech_ap_top_num
#Fecha.Aplicación.TOP
#Hurto
#Robo
#Venta.Drogas
#Riña
#Total.VIF
#Otro
#tot_off_top
#fech_ap_top
#edad_a_ap_top_num
#edad_b_ap_top_num
#edad_a_ap_top_num_lim
#edad_b_ap_top_num_lim
#caseid
#end_type
#fec_comision_simple
#crime_code_c
#crime_code_group_rec_prof
#crime_code_group_rec
#age_offending_imp

invisible("# 131 rows added, why?")
message("Patients than had more than one combination of application date and ID. That means, they answered TOP more than one time, and in at least 2 of these times they had previous records: "); Base_fiscalia_v13c_dic_2022_2 %>% 
    dplyr::count(HASH_KEY, fech_ap_top_num) %>% 
    dplyr::filter(n>1) %>% 
    dplyr::summarise(sum=sum(n), n=n(), tot=sum-n)

Base_fiscalia_v13c_dic_2022_3<-
Base_fiscalia_v13c_dic_2022_2 %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(vio=dplyr::if_else(crime_code_group_rec_prof=="Violent",1,0,0),
                acq=dplyr::if_else(crime_code_group_rec_prof=="Acquisitive",1,0,0),
                sud=dplyr::if_else(crime_code_group_rec_prof=="Substance-related",1,0,0),
                oth=dplyr::if_else(crime_code_group_rec_prof=="Other",1,0,0)) %>% 
  dplyr::mutate(tot= rowSums(dplyr::select(., c("vio","acq","sud","oth")), na.rm=T)) %>% 
  dplyr::mutate(acq_top= rowSums(dplyr::select(., c("Hurto","Robo")), na.rm=T)) %>%
  dplyr::mutate(sud_top= rowSums(dplyr::select(., c("Venta.Drogas")), na.rm=T)) %>%
  dplyr::mutate(vio_top= rowSums(dplyr::select(., c("Riña", "Total.VIF")), na.rm=T)) %>%
  dplyr::mutate(oth_top= rowSums(dplyr::select(., c("Otro")), na.rm=T)) %>% 
  dplyr::group_by(HASH_KEY, fech_ap_top_num) %>% 
  dplyr::mutate(vio=sum(vio,na.rm=T), acq=sum(acq,na.rm=T), sud=sum(sud,na.rm=T), 
                oth=sum(oth,na.rm=T), tot=sum(tot,na.rm=T), n=n()) %>%
  dplyr::slice(1) %>% 
  dplyr::ungroup() 
#Los que tienen todo pelado en caseid es porque no tienen fecha de comisión en los últimos 30 días
message(
paste0("For each combination of TOP application, count the number of previous offenses in PO records (those with 0s are people that did not committed an offense recorded by PO in the period previous to the application of TOP) (p= ", format(length(unique(Base_fiscalia_v13c_dic_2022_3$HASH_KEY)), big.mark=","), "; n= ",format(nrow(Base_fiscalia_v13c_dic_2022_3), big.mark=","),")")
)
```

<br>

## Descriptives



```{r desc0-get-municipallity-info, echo=T, fig.align='center', message=T, error=T, eval=T}
#http://observatorio.ministeriodesarrollosocial.gob.cl/pobreza-comunal-2020

Comunas_PNDR <- readxl::read_excel("Clasificacion-comunas-PNDR.xlsx")%>% 
  dplyr::mutate(cod= dplyr::case_when(as.character(cod_com)=="16101"~"8401",
                                      as.character(cod_com)=="16102"~"8402",
                                      as.character(cod_com)=="16103"~"8406",
                                      as.character(cod_com)=="16104"~"8407",
                                      as.character(cod_com)=="16105"~"8410",
                                      as.character(cod_com)=="16106"~"8411",
                                      as.character(cod_com)=="16107"~"8413",
                                      as.character(cod_com)=="16108"~"8418",
                                      as.character(cod_com)=="16109"~"8421",
                                      as.character(cod_com)=="16201"~"8414",
                                      as.character(cod_com)=="16202"~"8403",
                                      as.character(cod_com)=="16203"~"8404",
                                      as.character(cod_com)=="16204"~"8408",
                                      as.character(cod_com)=="16205"~"8412",
                                      as.character(cod_com)=="16206"~"8415",
                                      as.character(cod_com)=="16207"~"8420",
                                      as.character(cod_com)=="16301"~"8416",
                                      as.character(cod_com)=="16302"~"8405",
                                      as.character(cod_com)=="16303"~"8409",
                                      as.character(cod_com)=="16304"~"8417",
                                      as.character(cod_com)=="16305"~"8419",
                                      T~ as.character(cod_com)
                                      ))

#http://observatorio.ministeriodesarrollosocial.gob.cl/pobreza-comunal-2011
pobr_mult_2020<-readxl::read_excel("Estimaciones_de_Tasa_de_Pobreza_por_Ingresos_por_Comunas_2020_revisada2022_09.xlsx", skip=1) %>% dplyr::mutate(anio=2020) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2019<-readxl::read_excel("Estimaciones_de_Tasa_de_Pobreza_por_Ingresos_por_Comunas_2020_revisada2022_09.xlsx", skip=1) %>% dplyr::mutate(anio=2019) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2018<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2017.xlsx", skip=1) %>% dplyr::mutate(anio=2018) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2017<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2017.xlsx", skip=1) %>% dplyr::mutate(anio=2017) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2016<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2015.xlsx", skip=1) %>% dplyr::mutate(anio=2016) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2015<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2015.xlsx", skip=1) %>% dplyr::mutate(anio=2015) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2014<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_2013.xlsx", skip=1)%>% dplyr::mutate(anio=2014) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2013<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_2013.xlsx", skip=1)%>% dplyr::mutate(anio=2013) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2012<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2012) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2011<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2011) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2010<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2010) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2009<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2009) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2008<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2008) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2007<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2007) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)

# replace comuna= "16103" if strpos(strlower(comuna),"8406")>0
# replace comuna= "16104" if strpos(strlower(comuna),"8407")>0
# replace comuna= "16105" if strpos(strlower(comuna),"8410")>0
# replace comuna= "16106" if strpos(strlower(comuna),"8411")>0
# replace comuna= "16107" if strpos(strlower(comuna),"8413")>0
# replace comuna= "16108" if strpos(strlower(comuna),"8418")>0
# replace comuna= "16109" if strpos(strlower(comuna),"8421")>0
# replace comuna= "16201" if strpos(strlower(comuna),"8414")>0
# replace comuna= "16202" if strpos(strlower(comuna),"8403")>0
# replace comuna= "16203" if strpos(strlower(comuna),"8404")>0
# replace comuna= "16204" if strpos(strlower(comuna),"8408")>0
# replace comuna= "16205" if strpos(strlower(comuna),"8412")>0
# replace comuna= "16206" if strpos(strlower(comuna),"8415")>0
# replace comuna= "16207" if strpos(strlower(comuna),"8420")>0
# replace comuna= "16301" if strpos(strlower(comuna),"8416")>0
# replace comuna= "16302" if strpos(strlower(comuna),"8405")>0
# replace comuna= "16303" if strpos(strlower(comuna),"8409")>0
# replace comuna= "16304" if strpos(strlower(comuna),"8417")>0
# replace comuna= "16305" if strpos(strlower(comuna),"8419")>0
pobr_mult_2007_2020<-
rbind.data.frame(pobr_mult_2007, pobr_mult_2008, pobr_mult_2009, pobr_mult_2010, pobr_mult_2011, pobr_mult_2012, pobr_mult_2013, pobr_mult_2014, pobr_mult_2015, pobr_mult_2016, pobr_mult_2017, pobr_mult_2018, pobr_mult_2019, pobr_mult_2020) %>% 
  dplyr::mutate(cod= dplyr::case_when(Código=="16101"~"8401",
                                      Código=="16102"~"8402",
                                      Código=="16103"~"8406",
                                      Código=="16104"~"8407",
                                      Código=="16105"~"8410",
                                      Código=="16106"~"8411",
                                      Código=="16107"~"8413",
                                      Código=="16108"~"8418",
                                      Código=="16109"~"8421",
                                      Código=="16201"~"8414",
                                      Código=="16202"~"8403",
                                      Código=="16203"~"8404",
                                      Código=="16204"~"8408",
                                      Código=="16205"~"8412",
                                      Código=="16206"~"8415",
                                      Código=="16207"~"8420",
                                      Código=="16301"~"8416",
                                      Código=="16302"~"8405",
                                      Código=="16303"~"8409",
                                      Código=="16304"~"8417",
                                      Código=="16305"~"8419",
                                      T~ Código
                                      ))


#2023-02-01:classifications by municipality
class_centros <- readxl::read_excel(paste0(path,"/_ig_borquez/class_centros.xlsx"))%>%
    tidylog::left_join(dplyr::distinct(CONS_C1_df_dup_SEP_2020, id_centro, nombre_centro), by=c("nombre_centro_1" ="nombre_centro"))%>%
    dplyr::group_by(id_centro)%>%
    slice(1)%>% 
    dplyr::ungroup()%>%
    dplyr::mutate(id_centro=dplyr::case_when(grepl("Allende",nombre_centro_1) & is.na(id_centro)~ "475",  T~ as.character(id_centro)))%>%
    dplyr::group_by(id_centro)%>%
    slice(1)
    #dplyr::filter(grepl("Allende",nombre_centro_1))


CONS_C1_df_dup_SEP_2020_22_e<-
CONS_C1_df_dup_SEP_2020_22_d %>% 
  dplyr::mutate(comuna_residencia_cod_rec= as.character(readr::parse_number(as.character(comuna_residencia_cod))), anio_ing_tr= lubridate::epiyear(fech_ing)) %>% #glimpse()
  dplyr::left_join(pobr_mult_2007_2020[,c("anio", "cod","porc_pobr")], by= c("comuna_residencia_cod_rec"="cod", "anio_ing_tr"="anio")) %>% 
  dplyr::left_join(Comunas_PNDR[,c("cod", "Clasificación")], by= c("comuna_residencia_cod_rec"="cod"))%>%
  #2023-02-01
  dplyr::left_join(class_centros[,c("id_centro", "nombre_centro_1", "classification")], by= "id_centro")%>%
    purrr::when(nrow(.)>nrow(CONS_C1_df_dup_SEP_2020_22_d) ~ stop("More cases in the new database"), ~.) %>% 
  dplyr::mutate(via_adm_sus_prin_act= factor(dplyr::case_when(via_adm_sus_prin_act=="Injected Intravenously or Intramuscularly"~ "Other",T~as.character(via_adm_sus_prin_act)))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
dplyr::mutate(con_quien_vive_joel=dplyr::case_when(
    grepl("Solo$",con_quien_vive, ignore.case=T)~"Alone",
    grepl("Con abuelos",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con hermanos",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con la madre \\(sola\\)",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con otro pariente",con_quien_vive, ignore.case=T)~"Others",
    grepl("con hijos y padres o familia",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("con la pareja y padres o familia de origen",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("con padres o familia de origen",con_quien_vive, ignore.case=T)~"Family of origin",
    #2021-10-01
    grepl("Únicamente con hijos",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Únicamente con pareja",con_quien_vive, ignore.case=T)~"With couple/children",
    #2021-10-01
    grepl("Con la Pareja, Hijos y Padres o Familia de Origen",con_quien_vive, ignore.case=T)~"With couple/children", 
    grepl("Hijos y Padres o Familia de Origen",con_quien_vive, ignore.case=T)~"Family of origin",
    #2021-10-01
    grepl("Únicamente con la pareja e hijos",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Con amigos",con_quien_vive, ignore.case=T)~"Others",
    grepl("Con otro NO pariente",con_quien_vive, ignore.case=T)~"Others",
    grepl("*Otros$",con_quien_vive, ignore.case=T)~"Others")) 
  
#TO CHECK IF SOME MUNICIPALLITIES DID NOT JOIN
  #dplyr::filter(is.na(porc_pobr)) %>% dplyr::select(comuna_residencia_cod, anio_ing_tr)

#TO CHECK IF SOME MUNICIPALLITIES DID NOT JOIN
  #dplyr::filter(is.na(porc_pobr)) %>% dplyr::select(comuna_residencia_cod, anio_ing_tr)  

#Private Therapeutic Community, ref
CONS_C1_df_dup_SEP_2020_22_e$clas_r <- relevel(factor(CONS_C1_df_dup_SEP_2020_22_e$Clasificación), ref = "Urbana")
CONS_C1_df_dup_SEP_2020_22_e$via_adm_sus_prin_act <- relevel(factor(CONS_C1_df_dup_SEP_2020_22_e$via_adm_sus_prin_act), ref = "Oral (drunk or eaten)")

```


```{r recode-comparison, echo=T, fig.align='center', message=T, error=T, eval=T}

cat("Recode to binary measures")
Base_fiscalia_v13c_dic_2022_3$tot_off_top_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$tot_off_top>=1,1,0)
Base_fiscalia_v13c_dic_2022_3$tot_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$tot>=1,1,0)

Base_fiscalia_v13c_dic_2022_3$vio_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$vio>=1,1,0)
Base_fiscalia_v13c_dic_2022_3$acq_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$acq>=1,1,0)
Base_fiscalia_v13c_dic_2022_3$sud_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$sud>=1,1,0)
Base_fiscalia_v13c_dic_2022_3$oth_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$oth>=1,1,0)

Base_fiscalia_v13c_dic_2022_3$acq_top_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$acq_top>=1,1,0)
Base_fiscalia_v13c_dic_2022_3$sud_top_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$sud_top>=1,1,0)
Base_fiscalia_v13c_dic_2022_3$vio_top_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$vio_top>=1,1,0)
Base_fiscalia_v13c_dic_2022_3$oth_top_bin<-
ifelse(Base_fiscalia_v13c_dic_2022_3$oth_top>=1,1,0)


```
Join the data of the comparison between TOP reports and PO records, with the baseline information at admission of each patient.

```{r desc1, echo=T, fig.align='center', message=T, error=T, eval=T, layout="l-body-outset"}
vars_db<-
c("edad_a_ap_top_num", "end_type", "fech_ap_top_num", "sex", "duplicates_filtered", "id_centro", "macrozona", "nombre_region", "comuna_residencia_cod", "escolaridad_rec", "estado_conyugal_2", "freq_cons_sus_prin", "via_adm_sus_prin_act", "con_quien_vive_joel", "sus_principal_mod", "origen_ingreso_mod", "numero_de_hijos_mod", "tenencia_de_la_vivienda_mod", "sus_ini_mod_mvv", "condicion_ocupacional_corr", "dg_trs_cons_sus_or", "comorbidity_icd_10", "clas_r", "classification")
  
Base_fiscalia_v13c_dic_2022_4 <-
Base_fiscalia_v13c_dic_2022_3 %>% 
  tidylog::left_join(CONS_C1_df_dup_SEP_2020_22_e, by=c("HASH_KEY"="hash_key")) %>% 
  dplyr::select(any_of(c("HASH_KEY",vars_db, paste0(c("acq","sud","vio","oth"),"_bin"), paste0(c("acq","sud","vio","oth"),"_top_bin"), "numero_de_hijos_mod", "tot_off_top","tot_off_top_bin", "tot", "tot_bin", "edad_a_ap_top_num", "fech_ap_top"))) %>% 
   #multinomial
  dplyr::mutate(discrepancies=dplyr::case_when(tot> tot_off_top~ "underreport", tot< tot_off_top~ "overreport", T~ "coincidence")) %>% 
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
  dplyr::mutate(tenencia_de_la_vivienda_mod2=
                  factor(dplyr::case_when(tenencia_de_la_vivienda_mod=="Allegado"~"Stays temporarily with a relative", tenencia_de_la_vivienda_mod=="Arrienda"~"Renting", tenencia_de_la_vivienda_mod=="Cedida"~"Owner/Transferred dwellings/Pays Dividends", tenencia_de_la_vivienda_mod=="Ocupación Irregular"~"Illegal Settlement", tenencia_de_la_vivienda_mod=="Otros"~"Others", tenencia_de_la_vivienda_mod=="Paga dividendo"~"Owner/Transferred dwellings/Pays Dividends", tenencia_de_la_vivienda_mod=="Propia"~"Owner/Transferred dwellings/Pays Dividends", T~NA_character_)))%>% 
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
  # dplyr::mutate(numero_de_hijos_mod_joel=dplyr::case_when(
  #   grepl("Si$",embarazo, ignore.case=T)~as.integer(numero_de_hijos_mod+1),
  #   T~as.integer(numero_de_hijos_mod)))%>% 
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
    dplyr::mutate(freq_cons_sus_prin=parse_factor(as.character(freq_cons_sus_prin),levels=c('Less than 1 day a week','2 to 3 days a week','4 to 6 days a week','1 day a week or more','Daily'), ordered =T,trim_ws=F,include_na =F)) %>% #, locale=locale(encoding = "Latin1")
  dplyr::mutate(freq_cons_sus_prin=if_else(freq_cons_sus_prin=='Did not use','Less than 1 day a week',as.character(freq_cons_sus_prin),NA_character_)) 

attr(Base_fiscalia_v13c_dic_2022_4$escolaridad_rec,"label") <- "Educational Attainment"
attr(Base_fiscalia_v13c_dic_2022_4$freq_cons_sus_prin,"label") <- "Primary Substance at Admission Usage
Frequency"
attr(Base_fiscalia_v13c_dic_2022_4$fech_ap_top_num,"label") <- "Date of discharge"
attr(Base_fiscalia_v13c_dic_2022_4$edad_a_ap_top_num,"label") <- "Age at TOP application"
attr(Base_fiscalia_v13c_dic_2022_4$end_type,"label") <- "Date of discharge"
attr(Base_fiscalia_v13c_dic_2022_4$comorbidity_icd_10,"label") <- "Comorbidity ICD-10 (with amount of different diagnosis)"
attr(Base_fiscalia_v13c_dic_2022_4$con_quien_vive_joel,"label") <- "Living conditions"
attr(Base_fiscalia_v13c_dic_2022_4$acq_bin,"label") <- "Pre-treatment Criminality, Acquisitive (PO) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$sud_bin,"label") <- "Pre-treatment Criminality, Substance-related (PO) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$vio_bin,"label") <- "Pre-treatment Criminality, Violent (PO) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$oth_bin,"label") <- "Pre-treatment Criminality, Other (PO) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$acq_top_bin,"label") <- "Pre-treatment Criminality, Acquisitive (TOP) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$sud_top_bin,"label") <- "Pre-treatment Criminality, Substance-related (TOP) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$vio_top_bin,"label") <- "Pre-treatment Criminality, Violent (TOP) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$oth_top_bin,"label") <- "Pre-treatment Criminality, Other (TOP) (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$tot_off_top,"label") <- "Count of previous TOP offenses"
attr(Base_fiscalia_v13c_dic_2022_4$tot_off_top_bin,"label") <- "Count of previous TOP offenses (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$tot,"label") <- "Count of previous offenses"
attr(Base_fiscalia_v13c_dic_2022_4$tot_bin,"label") <- "Count of previous PO offenses (dichotomized)"
attr(Base_fiscalia_v13c_dic_2022_4$discrepancies,"label") <- "Relationship between total records (PO) and reports of offenses (TOP)"
attr(Base_fiscalia_v13c_dic_2022_4$classification,"label") <- "Types of ther. center"
attr(Base_fiscalia_v13c_dic_2022_4$clas_r,"label") <- "Rurality classification"

tbone_desc_merge<-
CreateTableOne(vars= setdiff(c(vars_db, paste0(c("acq","sud","vio","oth"),"_bin"), paste0(c("acq","sud","vio","oth"),"_top_bin"), "tot_off_top","tot_off_top_bin", "tot", "tot_bin", "edad_a_ap_top_num", "fech_ap_top"),c("id_centro", "comuna_residencia_cod")), data=  Base_fiscalia_v13c_dic_2022_4, factorVars = c(setdiff(vars_db,c("edad_a_ap_top_num","fech_ap_top_num","id_centro")),  paste0(c("acq","sud","vio","oth"),"_bin"), paste0(c("acq","sud","vio","oth"),"_top_bin")), smd=T,  addOverall = T, includeNA=T, strata="discrepancies", test=T) #

as.data.frame.TableOne(tbone_desc_merge, smd=T, nonnormal= T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  #knitr::kable(size=10, format="markdown",caption= "Summary descriptives, by discrepancy between PO records and TOP reports of offenses", escape=T)
 knitr::kable(size=10, format="html",caption= "Summary descriptives, by discrepancy between PO records and TOP reports of offenses", escape=T) %>% kableExtra::kable_classic()%>% 
    kableExtra::scroll_box(width = "100%", height = "550px") 
```


<br>

## Comparison

We compared the records of TOP (`Hurto`,`Robo`, `Venta.Drogas`, `Riña`, `Total.VIF`, `Otro`, & `tot_off_top`) with the records of PO (`vio`, `acq`, `sud`, `oth` & `tot`). We grouped TOPs self-reports of offenses related to burglary or robbery into acquisitive (`acq_top`), the reports of drug-selling into substance related (`sud_top`) and reports of fights and domestic violence into violent (`vio_top`) and Other into other (`oth_top`).


::: controlly2

::::: {.panelset}

```{r chisq-tot, echo=T, fig.align='center', message=T, error=T, eval=T, results='asis', layout="l-body-outset"}
cat("::: {.panel}", "\n", "[Total]{.panel-name}", "\n")

cat("**Total records of offenses vs. TOP reported offenses**")
paste0("**Records from PO**")
message(
paste0(median(Base_fiscalia_v13c_dic_2022_3$tot,na.rm=T), ' (p2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$tot,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$tot,1-.025, na.rm=T),')')
)
paste0("**Reports from TOP**")
message(
  paste0(median(Base_fiscalia_v13c_dic_2022_3$tot_off_top,na.rm=T), ' (p 2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$tot_off_top,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$tot_off_top,1-.025, na.rm=T),')')
)
pol_p<-
polychor(Base_fiscalia_v13c_dic_2022_3$tot_off_top, Base_fiscalia_v13c_dic_2022_3$tot, std.err=T, ML=T)

pol_p2<-
psych::polychoric(table(Base_fiscalia_v13c_dic_2022_3$tot_off_top, Base_fiscalia_v13c_dic_2022_3$tot))
#rho	: The (matrix) of tetrachoric/polychoric/biserial correlations
#tau	: The normal equivalent of the cutpoints

#for ordinal variables, the same idea holds...but now we have more than one τ-cut to subdivide the normal distribution into regions associated with the different values of the ordinal measure.

# polychoric is appropriate when the manifest ordinal variables came from categorizing latent normal variables & not otherwise. (In practice, it's more like when you are willing to assume thi

#We start with a relative frequency pattern for our contingency table of ordinal data in the lower-left, and we find the optimal solution for correlation and tau-cuts to get us back to a bivariate normal distribution that would have comparable relative joint-frequencies.

cat("**Polychoric correlation: Total records of offenses vs. TOP reported offenses**")
message(
capture.output(print(pol_p))[c(2,3)]
)
cat("**Overdispersion**")
message(
round(var(Base_fiscalia_v13c_dic_2022_3$tot_off_top)/mean(Base_fiscalia_v13c_dic_2022_3$tot_off_top),2)
)
#The variance is not much greater than the mean, which suggests that we will have over-dispersion in the model.
# obtained with a poisson regression

cat("**Recode**")
Base_fiscalia_v13c_dic_2022_3$tot_off_top_rec<-
ifelse(Base_fiscalia_v13c_dic_2022_3$tot_off_top>=4,4,Base_fiscalia_v13c_dic_2022_3$tot_off_top)

cat("**Confusion Matrix**")
#For more than two classes, these results are calculated comparing each factor level to the remaining levels (i.e. a "one versus all" approach).
# accuracy should be higher than No information rate (naive classifier) in order to be model significant. 
#No information rate tests whether our classifier does better than random assignment
# A hypothesis test is also computed to evaluate whether the overall accuracy rate is greater than the rate of the largest class. P-Value [Acc > NIR]
#Null Error Rate: This is how often you would be wrong if you always predicted the majority class.
# but sometimes the best classifier for a particular application will sometimes have a higher error rate than the null error rate, as in the accuracy paradox
#if the incidence of category A is dominant, being found in 99% of cases, then predicting that every case is category A will have an accuracy of 99%

#Kappa statistics is a measure of how the classification results compare to values assigned by chance. P-value mcnemar, can produce NA values with sparse tables)
pander::pander(caret::confusionMatrix(factor(Base_fiscalia_v13c_dic_2022_3$tot_off_top_rec), factor(Base_fiscalia_v13c_dic_2022_3$tot))) 

cat("**Kappa with ordinal weights**")
pander::pander(irrCAC::kappa2.table(table(ordered(Base_fiscalia_v13c_dic_2022_3$tot_off_top_rec), ordered(Base_fiscalia_v13c_dic_2022_3$tot)),weights = irrCAC::ordinal.weights(0:4)))
#really low
#To choose between linear and quadratic weights, ask yourself if the difference between being off by 1 vs. 2 categories is the same as the difference between being off by 2 vs. 3 categories. With linear weights, the penalty is always the same (e.g., 0.33 credit is subtracted for each additional category). However, this is not the case for quadratic weights, where penalties begin mild then grow harsher.
#CONS: Depends on the marginal distribution (prevalence) of the categories

cat("**Plot**")
ggstatsplot::ggscatterstats(tot_off_top, tot, data=Base_fiscalia_v13c_dic_2022_3, 
                            type="nonparametric", point.width.jitter=.9, point.height.jitter=.9,
                            xlab="Number of TOP offenses", ylab="Number of PO offenses", 
                            title="Relationship between Total counts of offenses from PO and TOP")

cat(":::", "\n")



cat("::: {.panel}", "\n", "[Acquisitive]{.panel-name}", "\n")

cat("**Total records of offenses vs. TOP reported offenses**")
paste0("**Records from PO**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$acq,na.rm=T), ' (p2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$acq,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$acq,1-.025, na.rm=T),')')
)

paste0("**Reports from TOP**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$acq_top,na.rm=T), ' (p 2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$acq_top,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$acq_top,1-.025, na.rm=T),')')
)

pol_p_acq<-
polychor(Base_fiscalia_v13c_dic_2022_3$acq_top, Base_fiscalia_v13c_dic_2022_3$acq, std.err=T, ML=T)

pol_p2_acq<-
psych::polychoric(table(Base_fiscalia_v13c_dic_2022_3$acq_top, Base_fiscalia_v13c_dic_2022_3$acq))

cat("**Polychoric correlation: Total records of offenses vs. TOP reported offenses**")
message(capture.output(print(pol_p_acq))[c(2,3)])

cat("**Recode**")
Base_fiscalia_v13c_dic_2022_3$acq_rec<-
ifelse(Base_fiscalia_v13c_dic_2022_3$acq>=2,2,Base_fiscalia_v13c_dic_2022_3$acq)

cat("**Confusion Matrix**")
pander::pander(tidy(caret::confusionMatrix(factor(Base_fiscalia_v13c_dic_2022_3$acq_top), factor(Base_fiscalia_v13c_dic_2022_3$acq_rec))))

cat("**Kappa with ordinal weights**")
pander::pander(irrCAC::kappa2.table(table(ordered(Base_fiscalia_v13c_dic_2022_3$acq_top), ordered(Base_fiscalia_v13c_dic_2022_3$acq_rec)),weights = irrCAC::ordinal.weights(0:2)))

cat("**Plot**")
ggstatsplot::ggscatterstats(acq_top, acq, data=Base_fiscalia_v13c_dic_2022_3, 
                            type="nonparametric", point.width.jitter=.9, point.height.jitter=.9,
                            xlab="Number of TOP offenses", ylab="Number of PO offenses", 
                            title="Relationship between counts of Acquisitive offenses from PO and TOP")



cat(":::", "\n")
cat("::: {.panel}", "\n", "[SUD]{.panel-name}", "\n")


cat("**Total records of offenses vs. TOP reported offenses**")
paste0("**Records from PO**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$sud,na.rm=T), ' (p2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$sud,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$sud,1-.025, na.rm=T),')')
)

paste0("**Reports from TOP**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$sud_top,na.rm=T), ' (p 2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$sud_top,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$sud_top,1-.025, na.rm=T),')')
)

pol_p_sud<-
polychor(Base_fiscalia_v13c_dic_2022_3$sud_top, Base_fiscalia_v13c_dic_2022_3$sud, std.err=T, ML=T)

pol_p2_sud<-
psych::polychoric(table(Base_fiscalia_v13c_dic_2022_3$sud_top, Base_fiscalia_v13c_dic_2022_3$sud))

cat("**Polychoric correlation: Total records of offenses vs. TOP reported offenses**")
message(capture.output(print(pol_p_sud))[c(2,3)])

cat("**Recode**")
Base_fiscalia_v13c_dic_2022_3$sud_rec<-
ifelse(Base_fiscalia_v13c_dic_2022_3$sud>=1,1,Base_fiscalia_v13c_dic_2022_3$sud)

cat("**Confusion Matrix**")
pander::pander(tidy(
caret::confusionMatrix(factor(Base_fiscalia_v13c_dic_2022_3$sud_top), factor(Base_fiscalia_v13c_dic_2022_3$sud_rec))
))


cat(":::", "\n")
cat("::: {.panel}", "\n", "[Violent]{.panel-name}", "\n")

cat("**Total records of offenses vs. TOP reported offenses**")
paste0("**Records from PO**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$vio,na.rm=T), ' (p2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$vio,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$vio,1-.025, na.rm=T),')')
)

paste0("**Reports from TOP**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$vio_top,na.rm=T), ' (p 2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$vio_top,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$vio_top,1-.025, na.rm=T),')')
)

pol_p_vio<-
polychor(Base_fiscalia_v13c_dic_2022_3$vio_top, Base_fiscalia_v13c_dic_2022_3$vio, std.err=T, ML=T)

pol_p2_vio<-
psych::polychoric(table(Base_fiscalia_v13c_dic_2022_3$vio_top, Base_fiscalia_v13c_dic_2022_3$vio))

cat("**Polychoric correlation: Total records of offenses vs. TOP reported offenses**")
message(capture.output(print(pol_p_vio))[c(2,3)])

cat("**Recode**")
Base_fiscalia_v13c_dic_2022_3$vio_rec<-
ifelse(Base_fiscalia_v13c_dic_2022_3$vio>=2,2,Base_fiscalia_v13c_dic_2022_3$vio)

cat("**Confusion Matrix**")
pander::pander(tidy(
  caret::confusionMatrix(factor(Base_fiscalia_v13c_dic_2022_3$vio_top), factor(Base_fiscalia_v13c_dic_2022_3$vio_rec))
))

cat("**Kappa with ordinal weights**")
pander::pander(
irrCAC::kappa2.table(table(ordered(Base_fiscalia_v13c_dic_2022_3$vio_top), ordered(Base_fiscalia_v13c_dic_2022_3$vio_rec)),weights = irrCAC::ordinal.weights(0:2))
)

cat("**Plot**")
ggstatsplot::ggscatterstats(vio_top, vio, data=Base_fiscalia_v13c_dic_2022_3, 
                            type="nonparametric", point.width.jitter=.9, point.height.jitter=.9,
                            xlab="Number of TOP offenses", ylab="Number of PO offenses", 
                            title="Relationship between counts of violent offenses from PO and TOP")


cat(":::", "\n")
cat("::: {.panel}", "\n", "[Other]{.panel-name}", "\n")

cat("**Total records of offenses vs. TOP reported offenses**")
paste0("**Records from PO**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$oth,na.rm=T), ' (p2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$oth,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$oth,1-.025, na.rm=T),')')
)

paste0("**Reports from TOP**")
message(
paste0("Mdn= ", median(Base_fiscalia_v13c_dic_2022_3$oth_top,na.rm=T), ' (p 2.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$oth_top,.025,na.rm=T),',  p97.5= ',quantile(Base_fiscalia_v13c_dic_2022_3$oth_top,1-.025, na.rm=T),')')
)

pol_p_oth<-
polychor(Base_fiscalia_v13c_dic_2022_3$oth_top, Base_fiscalia_v13c_dic_2022_3$oth, std.err=T, ML=T)

pol_p2_oth<-
psych::polychoric(table(Base_fiscalia_v13c_dic_2022_3$oth_top, Base_fiscalia_v13c_dic_2022_3$oth))

cat("**Polychoric correlation: Total records of offenses vs. TOP reported offenses**")
message(capture.output(print(pol_p_oth))[c(2,3)])

cat("**Recode**")
Base_fiscalia_v13c_dic_2022_3$oth_rec<-
ifelse(Base_fiscalia_v13c_dic_2022_3$oth>=1,1,Base_fiscalia_v13c_dic_2022_3$oth)

cat("**Confusion Matrix**")
pander::pander(tidy(
caret::confusionMatrix(factor(Base_fiscalia_v13c_dic_2022_3$oth_top), factor(Base_fiscalia_v13c_dic_2022_3$oth_rec))
))

cat(":::", "\n")

```

:::::

:::


```{r chisq-tot-2, echo=T, fig.align='center', message=T, error=T, eval=F}
#
cat("Manually construct measure tables")
#http://rstudio-pubs-static.s3.amazonaws.com/370944_96c386c03ac54ef3bec4535d49e92890.html

confusion_table = table(Base_fiscalia_v13c_dic_2022_3$tot_off_top_bin, Base_fiscalia_v13c_dic_2022_3$tot_bin)
confusion_table[1,1] = 'TN'
confusion_table[1,2] = 'FN'
confusion_table[2,1] = 'FP'
confusion_table[2,2] = 'TP'

get_accuracy <- function(df, predicted, actual){
  confusion_table = table(df[[predicted]],df[[actual]])
  TP = confusion_table[2,2]
  TN = confusion_table[1,1]
  FN = confusion_table[1,2]
  FP = confusion_table[2,1]
  accuracy = round((TP + TN) / sum(TP,FP,TN,FN), 2)
  return(accuracy)
}
get_classification_error_rate <- function(df, predicted, actual){
  confusion_table = table(df[[predicted]],df[[actual]])
  TP = confusion_table[2,2]
  TN = confusion_table[1,1]
  FN = confusion_table[1,2]
  FP = confusion_table[2,1]
  classification_error_rate = round((FP + FN) / sum(TP,FP,TN,FN),2)
  return(classification_error_rate)
}
get_precision <- function(df, predicted, actual){
  confusion_table = table(df[[predicted]],df[[actual]])
  TP = confusion_table[2,2]
  TN = confusion_table[1,1]
  FN = confusion_table[1,2]
  FP = confusion_table[2,1]
  precision = round(TP / (TP + FP), 2)
  return(precision)
}
get_sensitivity <- function(df, predicted, actual){
  confusion_table = table(df[[predicted]],df[[actual]])
  TP = confusion_table[2,2]
  TN = confusion_table[1,1]
  FN = confusion_table[1,2]
  FP = confusion_table[2,1]
  sensitivity = round(TP / (TP + FN), 2)
  return(sensitivity)
}
get_specificity <- function(df, predicted, actual){
  confusion_table = table(df[[predicted]],df[[actual]])
  TP = confusion_table[2,2]
  TN = confusion_table[1,1]
  FN = confusion_table[1,2]
  FP = confusion_table[2,1]
  specificity = round(TN / (TN + FP), 2)
  return(specificity)
}
get_f1_score <- function(df, predicted, actual){
  confusion_table = table(df[[predicted]],df[[actual]])
  TP = confusion_table[2,2]
  TN = confusion_table[1,1]
  FN = confusion_table[1,2]
  FP = confusion_table[2,1]
  
  precision = round(TP / (TP + FP), 2)
  sensitivity = round(TP / (TP + FN), 2)
  f1_score = round((2 * precision * sensitivity) / (precision + sensitivity), 2)
  return(f1_score)
}

caret::confusionMatrix(factor(Base_fiscalia_v13c_dic_2022_3$tot_off_top_bin), factor(Base_fiscalia_v13c_dic_2022_3$tot_bin))

score = data.frame(accuracy=get_accuracy(Base_fiscalia_v13c_dic_2022_3, 'tot_off_top_bin', 'tot_bin'),
      classification_error_rate=get_classification_error_rate(Base_fiscalia_v13c_dic_2022_3, 'tot_off_top_bin', 'tot_bin'),
      precision=get_precision(Base_fiscalia_v13c_dic_2022_3, 'tot_off_top_bin', 'tot_bin'),
      sensitivity=get_sensitivity(Base_fiscalia_v13c_dic_2022_3, 'tot_off_top_bin', 'tot_bin'),
      specificity=get_specificity(Base_fiscalia_v13c_dic_2022_3, 'tot_off_top_bin', 'tot_bin'),
      f1_score=get_f1_score(Base_fiscalia_v13c_dic_2022_3, 'tot_off_top_bin', 'tot_bin'))

#We can also combine precision and recall into an F1 score. This is the harmonic mean of precision and recall.
knitr::kable(score, caption= "Table 1. Properties")# %>% kableExtra::kable_classic()
```

<br>

## ROC


For ROC curves, we dichotomized into committing a crime or not against reporting or not (`*_bin`). Posteriorly, we calculated confidence intervals using bootstrap with 500 replications.

::: controlly2

<div class="layout-chunk" data-layout="l-body">

```{r roc, echo=T, fig.align='center', message=T, error=T, eval=T, results='asis', layout="l-body-outset"}
#Acquisitive  SUD   Violent Other
suppressMessages(suppressWarnings(library(ROCit)))
## Warning: package 'ROCit' was built under R version 3.5.2
message("Error in convertclass(class, reference = negref) :    class must have exactly two unique values)")

cat("::::: {.panelset}", "\n")
cat("::: {.panel}", "\n", "[Total]{.panel-name}", "\n")

ROCit_obj <- rocit(score=Base_fiscalia_v13c_dic_2022_3$tot_off_top_bin,class=Base_fiscalia_v13c_dic_2022_3$tot_bin)
plot(ROCit_obj)

#Del YOuden, el óptimo es...
pander::pander(ciROC(ROCit_obj,nboot = 500))
#FPR: 1-especificidad
#TPR: Sensibilidad

cat(":::", "\n")
cat("::: {.panel}", "\n", "[Acquisitive]{.panel-name}", "\n")

ROCit_acq <- rocit(score=Base_fiscalia_v13c_dic_2022_3$acq_top_bin,class=Base_fiscalia_v13c_dic_2022_3$acq_bin)
plot(ROCit_acq)

pander::pander(ciROC(ROCit_acq,nboot = 500))

cat(":::", "\n")
cat("::: {.panel}", "\n", "[SUD]{.panel-name}", "\n")

ROCit_sud <- rocit(score=Base_fiscalia_v13c_dic_2022_3$sud_top_bin,class=Base_fiscalia_v13c_dic_2022_3$sud_bin)
plot(ROCit_sud)

pander::pander(ciROC(ROCit_sud,nboot = 500))

cat(":::", "\n")
cat("::: {.panel}", "\n", "[Violent]{.panel-name}", "\n")

ROCit_vio <- rocit(score=Base_fiscalia_v13c_dic_2022_3$vio_top_bin,class=Base_fiscalia_v13c_dic_2022_3$vio_bin)
plot(ROCit_vio)

pander::pander(ciROC(ROCit_vio,nboot = 500))

cat(":::", "\n")
cat("::: {.panel}", "\n", "[Other]{.panel-name}", "\n")

ROCit_oth <- rocit(score=Base_fiscalia_v13c_dic_2022_3$oth_top_bin,class=Base_fiscalia_v13c_dic_2022_3$oth_bin)
plot(ROCit_oth)

pander::pander(ciROC(ROCit_oth,nboot = 500))

cat(":::", "\n")
cat(":::::", "\n")
```

</div>

:::

<br>

## Analysis

::: controlly2

```{r an-1, eval=T, echo=T, error=T, message=FALSE, warning=FALSE, paged.print=TRUE, layout="l-body-outset"}
mlogit.display2 <- function(multinom.model, decimal=2, alpha=.05) {
  s <- summary(multinom.model)
  z <- s$coefficients/s$standard.errors
  pnorm.z <- pnorm(z)
  pgroup <- cut(pnorm.z, c(0,0.0005,0.005,0.025,0.975, 0.995, 0.9995,1))
  stars <-c("***","**","*","","*","**","***")
  #x <-paste(round(s$coefficients,decimal),"/",round(s$standard.errors,decimal+1),stars[pgroup], sep="")
   x <-paste(round(s$coefficients,decimal),"", "", sep="")
  dim(x) <- dim(z)
  colnames(x) <- colnames(s$coefficients)
  rownames(x) <- rownames(s$coefficients)
  
  x1 <- t( x)
  x2 <- t(exp(s$coefficients))
  x2 <- round(x2,decimal)
  x2.1 <- t(exp(s$coefficients-qnorm(1-alpha/2)*s$standard.errors))
  x2.1 <- round(x2.1,decimal)
  x2.2 <- t(exp(s$coefficients+qnorm(1-alpha/2)*s$standard.errors))
  x2.2 <- round(x2.2,decimal)
  x2 <- paste(x2,"(", x2.1, ",", x2.2, ")",  sep="")
  dim(x2) <- dim(x1)
  x2[1,] <- "-"
  x3 <- cbind(x1[,1],x2[,1])
  for(i in 2: (length(s$lab)-1)){x3 <- cbind(x3, cbind(x1[,i],x2[,i]))}
  x4 <- rbind(c("Coeff./SE",paste("RRR(",100-100*alpha,"%CI)   ",sep=""),"Coeff./SE",paste("RRR(",100-100*alpha,"%CI)   ",sep="")),x3)
  colnames.x4 <- c(s$lab[2],"")
  for(i in 3:(length(s$lab))){colnames.x4 <- c(colnames.x4,c(s$lab[i],""))}
  colnames(x4) <- colnames.x4
  rownames(x4) <- c("",s$coefnames)
  cat("\n")
  cat(paste("Outcome =",as.character(s$term)[2],"; ","Referent group = ",s$lab[1],sep=""), "\n")
  

  assign(paste0("output_", deparse(substitute(multinom.model))),data.table::data.table(x4, keep.rownames=T), envir = .GlobalEnv)
    
  cat(paste("Residual Deviance:", round(s$deviance,decimal), "\n"))
  cat(paste("AIC =", round(s$AIC,digits=decimal), "\n"))
  cat("\n")
}


library(rpart)
library(rpart.plot)
library(partykit)
#Random Forest
library(randomForest)

form<-
as.formula(paste("discrepancies~ ", paste(setdiff(c(vars_db, "numero_de_hijos_mod", "tot_off_top","tot_off_top_bin", "tot", "tot_bin", "edad_a_ap_top_num", "fech_ap_top"), c("id_centro", "comuna_residencia_cod",  "tot_off_top", "tot", "tot_off_top_bin", "tot_bin", "end_type", "fech_ap_top", "nombre_region")), collapse="+ "))) #paste0(c("acq","sud","vio","oth"),"_bin"),   paste0(c("acq","sud","vio","oth"),"_top_bin"), 

form_multilev<-
as.formula(paste("discrepancies~ ", paste(setdiff(c(vars_db, "numero_de_hijos_mod", "tot_off_top","tot_off_top_bin", "tot", "tot_bin", "edad_a_ap_top_num", "fech_ap_top"), c("id_centro", "comuna_residencia_cod", "tot_off_top", "tot",  "tot_off_top_bin", "tot_bin", "end_type", "fech_ap_top", "nombre_region")), collapse="+ "), "| HASH_KEY"))

set.seed(2125)
#Increase the MaxNWts parameter by passing it directly
#Error in nnet.default(X, Y, w, mask = mask, size = 0, skip = TRUE, softmax = TRUE,  :  too many (2502) weights
#In both GLMs and nnet::multinom it is the case that covariates should be scaled to make sure that the fit converges.
invisible("Multinomial logistic")
logit <- nnet::multinom(formula= form, data=Base_fiscalia_v13c_dic_2022_4 %>% dplyr::mutate_if(is.numeric, ~scale(.)),MaxNWts=84581, maxit= 1e3)

bs <- function(formula, data, indices) {
  d = data[indices,] # allows boot to select sample
  fit = nnet::multinom(formula, data=d, Hess = TRUE, trace=F, MaxNWts=84581, maxit= 1e3)
  s = summary(fit)
  return( cbind(s$coefficients, s$standard.errors) )
}

# 5 replications
results = list()
set.seed(2125)
results <- boot(
  data=Base_fiscalia_v13c_dic_2022_4 %>% dplyr::mutate_if(is.numeric, ~scale(.)), statistic=bs, R=2e3, parallel='multicore', formula=form
)

#mm <- nnet::multinom(discrepancies ~ .+0, data=Base_fiscalia_v13c_dic_2022_4 %>% dplyr::mutate_if(is.numeric, ~scale(.)), trace=F)
#lmtest::lrtest(mm, "Speciesversicolor")
#Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
#car::Anova(mm)

#https://stackoverflow.com/questions/33170335/bootstrap-multinomial-regression-in-r
# label the estimates

subModelNames <- colnames(results$t0)
varNames <- rownames(results$t0)

estNames <- apply(expand.grid(varNames,subModelNames),1,function(x) paste(x,collapse="_"))
colnames(results$t) <- estNames

library(car)
multinom_cis_norm<-round(exp(confint(results, level=0.95, type="norm")),2)
multinom_cis_perc<-round(exp(confint(results, level=0.95, type="perc")),2)
#multinom_cis_bca<-confint(results, level=0.95, type="bca") #slow
#In confint.boot(results, level = 0.95, type = "bca") :
#  BCa method fails for this problem.  Using 'perc' instead

multinom_cis_logit <- round(exp(confint(logit)),2)
multinom_cis_logit12 <-confint(logit)

# plot the results
#hist(results, legend="separate")

mlogit.display2(logit)

tibble(output_logit) %>% 
      dplyr::slice(-1) %>% 
      tidyr::separate(V2, sep="\\(", into= c("RRR_ov","CI_ov")) %>% 
      tidyr::separate(CI_ov, sep="\\,", into= c("ci_lo_ov","ci_up_ov")) %>% 
      tidyr::separate(V4, sep="\\(", into= c("RRR_und","CI_und")) %>% 
      tidyr::separate(CI_und, sep="\\,", into= c("ci_lo_und","ci_up_und")) %>% 
      dplyr::mutate(ci_up_ov= gsub("\\)","",ci_up_ov)) %>% 
      dplyr::mutate(ci_up_und= gsub("\\)","",ci_up_und)) %>% 
#output_logit %>% 
  knitr::kable("markdown", caption="Outputs from the multinomial model")
  # knitr::kable("html", caption="Outputs from the multinomial model") %>% 
  # kableExtra::kable_classic()
```
:::

```{r an-2, eval=F, echo=T, error=T, message=FALSE, warning=FALSE, paged.print=TRUE}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#Base_fiscalia_v13c_dic_2022_4$discrepancies <- factor(Base_fiscalia_v13c_dic_2022_4$discrepancies,
#  levels = c("admin", "manage", "custodial"), ordered = FALSE)

# bw_vglm <- VGAM::vglm(formula= form, family = multinomial,
#   data = bwmale2)
# coef(bw_vglm, matrix = TRUE)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#https://rubenfcasal.github.io/aprendizaje_estadistico/cart-con-el-paquete-rpart.html

set.seed(2125)
ind <- sample(x = 2, size = nrow(Base_fiscalia_v13c_dic_2022_4), replace = T, prob = c(0.7, 0.3))
train <- Base_fiscalia_v13c_dic_2022_4[ind == 1, ]
test <- Base_fiscalia_v13c_dic_2022_4[ind == 2, ]

mod1.2 <- rpart(form, data = train)
#mod1 #print(mod1)
#summary(mod1)
rpart.plot(mod1.2)
rpart.rules(mod1.2, style = "tall")

form2<-
as.formula(paste("discrepancies~ ", paste(setdiff(c(vars_db, "numero_de_hijos_mod", "edad_a_ap_top_num", "fech_ap_top"), c("id_centro", "comuna_residencia_cod")), collapse="+ ")))

form2_multilev<-
as.formula(paste("discrepancies~ ", paste(setdiff(c(vars_db, "numero_de_hijos_mod", "edad_a_ap_top_num", "fech_ap_top"), c("id_centro", "comuna_residencia_cod")), collapse="+ "), "| HASH_KEY"))

mod1.3 <- rpart(form2, data = train, cp=0)

head(mod1.3$cptable, 10)

xerror <- mod1.3$cptable[,"xerror"]
imin.xerror <- which.min(xerror)
# Valor óptimo
mod1.3$cptable[imin.xerror, ]
upper.xerror <- xerror[imin.xerror] + mod1.3$cptable[imin.xerror, "xstd"]
icp <- min(which(xerror <= upper.xerror))
cp <- mod1.3$cptable[icp, "CP"]
tree <- prune(mod1.3, cp = cp)
rpart.plot(tree, box.palette = "Blues") 

invisible("can take more than 15 hours, because the model was taking municipallity and center ID!")

#tm_cl <- mlogit::mlogit(formula= form_multilev, data=Base_fiscalia_v13c_dic_2022_4)#, reflevel = "coincidence")
#pivot_longer(Base_fiscalia_v13c_dic_2022_4, id=c("HASH_KEY", "edad_a_ap_top_num"))
#modelsummary(list("Conditional logit"=tm_cl), 
#             fmt=3, estimate="{estimate}{stars}")
```

## Inverse probability Adjusted ROC

::: controlly2

<div class="layout-chunk" data-layout="l-body">

```{r roc, echo=T, fig.align='center', message=T, error=T, eval=T, results='asis', layout="l-body-outset"}
invisible("In the end, this is very similar to a predict from a logistic regression and comparison with the true value")

## Warning: package 'ROCit' was built under R version 3.5.2
message("Error in convertclass(class, reference = negref) :    class must have exactly two unique values)")

set.seed(2125)
W2 <- weightit(as.formula(paste("motivodeegreso_mod_imp_rec~", paste(vars_cov, collapse = "+"))),
               data=Base_fiscalia_v13c_dic_2022_3[which(!is.na(Base_fiscalia_v14$motivodeegreso_mod_imp_rec))], stabilize = T, method = "ps", estimand = "ATE", int=T, use.mlogit = FALSE)
invisible("Warning: Missing values are present in the covariates. See ?WeightIt::method_ps for information on how these are handled.")
invisible("Warning message:
Some extreme weights were generated. Examine them with summary() and maybe trim them with trim().")
Base_fiscalia_v14_mod$weight_mult_a1 <-W2$weights

set.seed(2125)
W1 <- weightit(as.formula(paste("con_quien_vive_joel~", paste(c(), collapse = "+"))),
               data=Base_fiscalia_v13c_dic_2022_3, stabilize = T,
                method = "bart", estimand = "ATE", int=T,
                use.mlogit = FALSE)
prueba2_imp22$weight_mult_a0 <-W1$weights




cat("::::: {.panelset}", "\n")
cat("::: {.panel}", "\n", "[Total]{.panel-name}", "\n")


ROCit_obj_adj <-WeightedROC(fitted(Model3), Model3$y, weights(psurvey))
plot(ROCit_obj)

#Del YOuden, el óptimo es...
pander::pander(ciROC(ROCit_obj,nboot = 500))
#FPR: 1-especificidad
#TPR: Sensibilidad

cat(":::", "\n")
cat("::: {.panel}", "\n", "[Acquisitive]{.panel-name}", "\n")

ROCit_acq <- rocit(score=Base_fiscalia_v13c_dic_2022_3$acq_top_bin,class=Base_fiscalia_v13c_dic_2022_3$acq_bin)
plot(ROCit_acq)

pander::pander(ciROC(ROCit_acq,nboot = 500))

cat(":::", "\n")
cat("::: {.panel}", "\n", "[SUD]{.panel-name}", "\n")

ROCit_sud <- rocit(score=Base_fiscalia_v13c_dic_2022_3$sud_top_bin,class=Base_fiscalia_v13c_dic_2022_3$sud_bin)
plot(ROCit_sud)

pander::pander(ciROC(ROCit_sud,nboot = 500))

cat(":::", "\n")
cat("::: {.panel}", "\n", "[Violent]{.panel-name}", "\n")

ROCit_vio <- rocit(score=Base_fiscalia_v13c_dic_2022_3$vio_top_bin,class=Base_fiscalia_v13c_dic_2022_3$vio_bin)
plot(ROCit_vio)

pander::pander(ciROC(ROCit_vio,nboot = 500))

cat(":::", "\n")
cat("::: {.panel}", "\n", "[Other]{.panel-name}", "\n")

ROCit_oth <- rocit(score=Base_fiscalia_v13c_dic_2022_3$oth_top_bin,class=Base_fiscalia_v13c_dic_2022_3$oth_bin)
plot(ROCit_oth)

pander::pander(ciROC(ROCit_oth,nboot = 500))

cat(":::", "\n")
cat(":::::", "\n")
```

</div>

:::

<br>

# Flowchart

```{r flwchrt-export-svg-1,echo=T, paged.print=TRUE, eval=T, error=T}

a_tab1_lab_aft_d<- paste0('Original C1 Dataset \n(p= ', formatC(CONS_C1%>% dplyr::distinct(HASH_KEY)%>% nrow(), format='f', big.mark=',', digits=0), ';\np= ', formatC(nrow(CONS_C1), format='f', big.mark=',', digits=0),')')

a_tab2_lab_aft_d<- paste0('&#8226;Remove duplicated entries\\\\\\l&#8226;Overlapping treatments of patients\\\\\\l&#8226;Intermediate treatment events (continuous referrals)    \\\\\\l')

a_tab3_lab_aft_d<- paste0('      C1 Dataset          \n(p= ', formatC(CONS_C1_df_dup_SEP_2020%>% dplyr::distinct(hash_key)%>% nrow(), format='f', big.mark=',', digits=0), ';\nn= ', formatC(nrow(CONS_C1_df_dup_SEP_2020), format='f', big.mark=',', digits=0),')')


a_tab4_lab_aft_d<- paste0('Original Prosecutors Office\n(p= ',Base_fiscalia_v2%>% dplyr::distinct(rut_enc_saf)%>% nrow() %>% format(big.mark=','), ';\nCauses= ',Base_fiscalia_v2%>% dplyr::distinct(ruc)%>% nrow() %>% format(big.mark=','), ';\nRel.=',Base_fiscalia_v2%>%dplyr::distinct(idrelacion)%>%nrow()%>%format(big.mark=','), ';\nRUC_Vic_Imp=',Base_fiscalia_v2%>%dplyr::mutate(rel=paste0(ruc,"_",idsujeto_victima,"_",idsujeto_imputado,"_","iddelito"))%>%dplyr::distinct(rel)%>%nrow()%>%format(big.mark=','), ';\nn= ',format(nrow(Base_fiscalia_v2),big.mark=","),')')

#crimes committed after study follow-up
a_tab5_lab_aft_d1<-
    paste0("(p= ",format(nrow(unique(subset(Base_fiscalia_v2,fec_comision_simple>as.Date("2019-11-13"),"rut_enc_saf"))),big.mark=","),"; RUCs= ", format(nrow(unique(subset(Base_fiscalia_v2,fec_comision_simple>as.Date("2019-11-13"),"ruc"))), big.mark=","),";n= ", format(nrow(subset(Base_fiscalia_v2,fec_comision_simple>as.Date("2019-11-13"),"rut_enc_saf")), big.mark=","),")")
#erase entries with missing values in fec_comision_simple y termino_relacion_simple
leftovers_Base_fiscalia_v3<-
Base_fiscalia_v3 %>% 
  dplyr::left_join(after_imp_Base_fiscalia_v3_db[,c("rut_enc_saf","imp_birth_date","flowch_age")], by="rut_enc_saf") %>% 
  dplyr::rename("obs"="flowch_age") %>% 
  dplyr::mutate(imp_birth_date=dplyr::case_when(!is.na(imp_birth_date)~imp_birth_date,T~fec_nacimiento_simple))%>% dplyr::mutate(edad_comision_imp=as.numeric(fec_comision_simple-imp_birth_date)/365.25) %>% dplyr::mutate(edad_ter_rel_imp=as.numeric(termino_relacion_simple-imp_birth_date)/365.25) %>%
  #arrange the rut from the first date of comission of a crime, but we are not detecting if he/she is the victim or not
  dplyr::arrange(rut_enc_saf, edad_comision_imp) %>% #566884
  dplyr::filter(dplyr::case_when(!is.na(edad_comision_imp)~T,T~F)) %>% #566644
  dplyr::filter(imp_birth_date=="1900-01-01"|is.na(imp_birth_date))

a_tab5_lab_aft_d12<-
    paste0("(p= ",format(nrow(dplyr::distinct(leftovers_Base_fiscalia_v3,rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(leftovers_Base_fiscalia_v3,ruc)), big.mark=","),";n= ",
           format(nrow(leftovers_Base_fiscalia_v3), big.mark=","),")")

#minor to 14 years old
a_tab5_lab_aft_d13<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v4,edad_comision_imp<14),rut_enc_saf)),big.mark=","),"; RUCs= ", format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v4,edad_comision_imp<14),ruc)), big.mark=","),";n= ", format(nrow(dplyr::filter(Base_fiscalia_v4,edad_comision_imp<14)), big.mark=","),")")

#Remove duplicated entries
a_tab5_lab_aft_d2<-
  paste0("(p= ",format(length(unique(eliminated_duplicates$rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(length(unique(eliminated_duplicates$ruc)), big.mark=","),";n= ",
           format(nrow(eliminated_duplicates), big.mark=","),")")
#before 2010
a_tab5_lab_aft_d3<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,fec_comision_simple<"2010-01-01"),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,fec_comision_simple<"2010-01-01"),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v7,fec_comision_simple<"2010-01-01")), big.mark=","),")")
#remove administrative annulment
a_tab5_lab_aft_d4<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA"),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA"),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="ANULACI¿N ADMINISTRATIVA")), big.mark=","),")")
#remove grouped to another case
a_tab5_lab_aft_d5<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO"),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO"),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v7,agrupa_terminos=="AGRUPACI¿N A OTRO CASO")), big.mark=","),")")

a_tab5_lab_aft_d<- paste0('&#8226;Filter crimes committed after study follow-up period',a_tab5_lab_aft_d1,'\\\\\\l&#8226;Remove duplicated entries',a_tab5_lab_aft_d2,'\\\\\\l&#8226;Correct dates (birth, comission of crime, end of judicial proceedings), missing nationality and sex\\\\\\l&#8226;Erase entries with missing values in  comission of crime, end of judicial proceedings',a_tab5_lab_aft_d12,'\\\\\\l&#8226;Erase entries with values in comission of crime when minor to 14 years old after imputation',a_tab5_lab_aft_d13,'\\\\\\l&#8226;Filter crimes committed before study follow-up',a_tab5_lab_aft_d3,'\\\\\\l&#8226;Filter records with cause of end of the proceedings= administrative annulment',a_tab5_lab_aft_d4,'\\\\\\l&#8226;Filter records with cause of end of the proceedings= grouped to another case',a_tab5_lab_aft_d5,'\\\\\\l')

a_tab6_lab_aft_d<- paste0("O.P. Dataset \n(p= ", dplyr::distinct(Base_fiscalia_v8, rut_enc_saf)%>% nrow()%>% formatC(big.mark = ","), ";\nn= ",formatC(nrow(Base_fiscalia_v8),big.mark = ","),")")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#DISCARD not coded as an offender
a_tab7_lab_aft_d1<-
    paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v8,!grepl("SI",encontrado_como_imputado)),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v8,!grepl("SI",encontrado_como_imputado)),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v8,!grepl("SI",encontrado_como_imputado))), big.mark=","),")")

#FILTER IF THE PATIENT RECIEVES FOR THE RELATIONSHIP AMONG THOSE THAT WERE OFFENDERS
# end of proceeding  === SIMILAR TO Base_fiscalia_v9
a_tab7_lab_aft_d2<-
      paste0("(p= ",format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v8, grepl("SI",encontrado_como_imputado)) %>%
dplyr::mutate(filter=dplyr::case_when(grepl("REPARATORIO|CONDICIONAL",toupper(agrupa_terminos)) & is.na(gls_mottermino)~1, grepl("REPARATORIO|SENTENCIA DEFINITIVA CONDENATORIA|240|MONIT", toupper(agrupa_terminos), ignore.case=F)~2, T~0))%>% dplyr::filter(filter==0),rut_enc_saf)),big.mark=","),"; RUCs= ",
           format(nrow(dplyr::distinct(dplyr::filter(Base_fiscalia_v8, grepl("SI",encontrado_como_imputado)) %>%
dplyr::mutate(filter=dplyr::case_when(grepl("REPARATORIO|CONDICIONAL",toupper(agrupa_terminos)) & is.na(gls_mottermino)~1, grepl("REPARATORIO|SENTENCIA DEFINITIVA CONDENATORIA|240|MONIT", toupper(agrupa_terminos), ignore.case=F)~2, T~0))%>% dplyr::filter(filter==0),ruc)), big.mark=","),";n= ",
           format(nrow(dplyr::filter(Base_fiscalia_v8, grepl("SI",encontrado_como_imputado)) %>%
dplyr::mutate(filter=dplyr::case_when(grepl("REPARATORIO|CONDICIONAL",toupper(agrupa_terminos)) & is.na(gls_mottermino)~1, grepl("REPARATORIO|SENTENCIA DEFINITIVA CONDENATORIA|240|MONIT", toupper(agrupa_terminos), ignore.case=F)~2, T~0))%>% dplyr::filter(filter==0)), big.mark=","),")")

CONS_TOP_2022_anti<-
  # 107307
  CONS_TOP%>% 
  dplyr::left_join(subset(dplyr::mutate(dplyr::group_by(Base_fiscalia_v11b_dic_2022, hash_key), hash_rn=row_number())%>% ungroup(), hash_rn==1), by= c("HASH_KEY" = "hash_key"))%>% 
  dplyr::mutate(fech_ap_top_num= as.numeric(as.Date(str_sub(as.character(lubridate::parse_date_time(Fecha.Aplicación.TOP, c("%Y-%m-%d"),exact=T)),1,10))))%>% #No parse failures
  dplyr::select(HASH_KEY, fech_ap_top_num, Fecha.Aplicación.TOP, dateofbirth_imp, Hurto, Robo, Venta.Drogas, Riña, Total.VIF, Otro) %>% 
  dplyr::filter(!is.na(HASH_KEY)) %>% 
  dplyr::mutate_at(vars("Hurto", "Robo", "Venta.Drogas", "Riña", "Otro"), ~ifelse(.=="S",1,0)) %>% 
  dplyr::mutate(Total.VIF= ifelse(Total.VIF>0,1,0))%>% 
  dplyr::mutate(tot_off_top = base::rowSums(dplyr::select(.,c(Hurto, Robo, Venta.Drogas, Riña, Total.VIF, Otro)), na.rm = T)) %>% 
  dplyr::mutate(dateofbirth_imp_num= as.numeric(dateofbirth_imp),
                fech_ap_top= lubridate::parse_date_time(Fecha.Aplicación.TOP, c("%Y-%m-%d"),exact=T),
                edad_a_ap_top_num= lubridate::time_length(lubridate::interval(dateofbirth_imp, fech_ap_top),unit="years"),
                edad_b_ap_top_num= (fech_ap_top_num-dateofbirth_imp_num)/365.25,
                edad_a_ap_top_num_lim= edad_a_ap_top_num-(1/12),
                edad_b_ap_top_num_lim= edad_b_ap_top_num-(1/12)) %>% 
  dplyr::select(-dateofbirth_imp, -dateofbirth_imp_num) %>% 
  dplyr::filter(!is.na(edad_a_ap_top_num)) %>% 
  dplyr::group_by(HASH_KEY, edad_a_ap_top_num) %>% 
  dplyr::slice(-1) %>% 
  dplyr::ungroup()

a_tab7_lab_aft_d25<-
        paste0("(p= ",format(length(unique(CONS_TOP_2022_anti$HASH_KEY)),big.mark=","),"; n= ",
           format(length(CONS_TOP_2022_anti$HASH_KEY), big.mark=","),")")


a_tab7_lab_aft_d3<-
        paste0("(p= ",format(nrow(dplyr::distinct(dplyr::anti_join(CONS_C1_df_dup_SEP_2020, CONS_C1_df_dup_SEP_2020_22_d, by=c("hash_key","dup")),hash_key)),big.mark=","),"; n= ",
           format(nrow(dplyr::anti_join(CONS_C1_df_dup_SEP_2020, CONS_C1_df_dup_SEP_2020_22_d, by=c("hash_key","dup"))), big.mark=","),")")

a_tab8_lab_aft_d <- paste0('Offenses previous\nto the first admission\n',"(p= ",format(length(unique(Base_fiscalia_v10b_dic_2022[,"hash_key"])),big.mark=","),"; RUCs= ",
           format(length(unique(Base_fiscalia_v10b_dic_2022[,"caseid"])), big.mark=","),";\nn= ",
           format(length(Base_fiscalia_v10b_dic_2022[,"caseid"]), big.mark=","),")")

a_tab9_lab_aft<- paste0('&#8226;Discard observations coded as victims rather than ofenders ',tab7_lab_aft_d1,'\\\\\\l&#8226;Discard observations depending on the values of the end of the proceedings among offenders ',tab7_lab_aft_d2,'\\\\\\l&#8226;Discard TOP applications with duplicated dates and user ',a_tab7_lab_aft_d25,'\\\\\\l&#8226;Get the first treatment of each user ',a_tab7_lab_aft_d3,'\\\\\\l')

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#//  ON x.hash_key == y.id AND   x.edad_al_egres_imp > y.age_offending_imp AND x.dup = 1"

library(DiagrammeR) 
plot_merge_flowchart_excercise<-
  grViz("digraph flowchart {
        fontname='Comic Sans MS'
        # node definitions with substituted label text
        node [shape = rectangle,fontsize = 9]        
        tab1 [label = '@@1']
        blank [label = '', width = 0.0001, height = 0.0001]
        tab2 [label = '@@2',fontsize = 7]
        tab3 [label = '@@3']
        
        tab4 [label = '@@4',fontsize = 8]
        blank2 [label = '', width = 0.0001, height = 0.0001]
        tab5 [label = '@@5',fontsize = 7]
        tab6 [label= '@@6']
        
        blank3 [label = '', width = 0.0001, height = 0.0001]
        blank4 [label = '', width = 0.0001, height = 0.0001]      
        blank5 [label = '', width = 0.0001, height = 0.0001] 
        
        blank6 [label = '', width = 0.0001, height = 0.0001]
        tab7 [label = '@@7',fontsize = 7]
        tab8 [label= '@@8']
        
        # edge definitions with the node IDs
        rankdir='TB'; rank= same; tab1 -> blank [arrowhead = none,label='        Data wrangling and normalization process',fontsize = 8];
        rankdir='TB'; rank= same; tab1; tab3;   
        blank -> tab2;
                    subgraph {
                rank = same; tab2; blank;
                    }
        rankdir='TB'; rank= same; blank -> tab3;      
              
        tab4 -> blank2 [arrowhead = none,label='        Data wrangling and normalization process',fontsize = 8];
        blank2 -> tab5
        blank2 -> tab6
        blank4 -> blank6 [arrowhead= none, label='  &#10198;']
        blank6 -> tab7 
                    subgraph {
          rank = same; blank6; tab7;
                    }
        # bring_db1_a                    
        blank6 -> tab8 [label= '        Merge records where discharge age is greater than age of offenses', fontsize = 8] 
                    subgraph {
          rank = same; tab5; blank2;
                    }
                    subgraph {
        rank= same; tab3 -> blank3 -> blank4 -> blank5 -> tab6 [arrowhead= none]
                    }
        }
                    subgraph {
          rank = same; tab3; tab6;
                    }
                    subgraph {
          rank = same; tab1; tab4;
                    }         
                    subgraph {
          rank = same; tab2; tab5;
                    } 
                    subgraph {
          rank = same; tab1; tab3;
          rankdir=TB
          rank=same
                    }
                    subgraph {
          rank = same; tab4; tab6;
          rankdir=TB
          rank=same
                    }                     
  
        [1]:  a_tab1_lab_aft_d
        [2]:  a_tab2_lab_aft_d
        [3]:  a_tab3_lab_aft_d
        [4]:  a_tab4_lab_aft_d
        [5]:  a_tab5_lab_aft_d
        [6]:  a_tab6_lab_aft_d
        [7]:  a_tab9_lab_aft
        [8]:  a_tab8_lab_aft_d
        ", width = 1200,
          height = 900)

DPI = 1200
WidthCM = 11
HeightCM = 8

plot_merge_flowchart_excercise

library(DiagrammeRsvg)

plot_merge_flowchart_excercise %>%
  export_svg %>% charToRaw %>% rsvg::rsvg_pdf("./_figs/_flowchart_comm_DAD.pdf")
plot_merge_flowchart_excercise %>% DiagrammeRsvg::export_svg()%>%charToRaw %>% rsvg::rsvg(width = WidthCM *(DPI/2.54), height = HeightCM *(DPI/2.54)) %>% png::writePNG("./_figs/_flowchart_comm_DAD.png")

htmlwidgets::saveWidget(plot_merge_flowchart_excercise, "./_figs/_flowchart_comm_DAD.html")
webshot::webshot("./_figs/_flowchart_comm_DAD.html", "./_figs/_flowchart_comm_DAD.png",vwidth = 1200, vheight = 900, zoom = 3)
webshot::webshot("./_figs/_flowchart_comm_DAD.html", "./_figs/_flowchart_comm_DAD_alt.pdf")
```

```{r flwchrt-export-svg-2, echo=T, paged.print=TRUE, eval=T, error=T}
a_tab10_lab_aft_d<- paste0("TOP Dataset \n(p= ", dplyr::distinct(CONS_TOP, HASH_KEY)%>% nrow()%>% formatC(big.mark = ","),";\nn= ",formatC(nrow(CONS_TOP),big.mark = ","),")")

#bring_db3
a_tab11_lab_aft_d1<- 
    paste0( '(p= ',format(nrow(dplyr::distinct(dplyr::group_by(Base_fiscalia_v9, id, caseid, end_type, fec_comision_simple, crime_code_c) %>% dplyr::slice(-1) %>% dplyr::ungroup(),id)), big.mark=","), '; RUCs= ', format(nrow(dplyr::distinct(dplyr::group_by(Base_fiscalia_v9, id, caseid, end_type, fec_comision_simple, crime_code_c) %>% dplyr::slice(-1) %>% dplyr::ungroup(),caseid)), big.mark=","), '; n= ', format(nrow(dplyr::group_by(Base_fiscalia_v9, id, caseid, end_type, fec_comision_simple, crime_code_c) %>% dplyr::slice(-1) %>% dplyr::ungroup()), big.mark=",") , ')'
    )
message(
paste0("Patients in PO records with unique combination of ID, RUC, end type and date of comission of the offense and offense ", a_tab11_lab_aft_d1)
)

a_tab11_lab_aft_d<- paste0('&#8226;Count events such as shoplifting, theft, domestic violence, drug selling, fights, or related behavior in the last four weeks','\\\\\\l',
                           '&#8226;Get PO data with more than one record with the same case ID, sentence, date of offense and type of crime ', a_tab11_lab_aft_d1,'\\\\\\l')

a_tab12_lab_aft_d<- 
    paste0('Merged database\n(p= ',format(nrow(dplyr::distinct(Base_fiscalia_v13c_dic_2022_3,HASH_KEY)), big.mark=","), '; n= ', format(nrow(Base_fiscalia_v13c_dic_2022_3), big.mark=",") , ')'
    )


plot_merge_flowchart_excercise2<-
  grViz("digraph flowchart {
        fontname='Comic Sans MS'
        # edge definitions with the node IDs
        # node definitions with substituted label text
        node [shape = rectangle, fontsize = 9]        
        tab1 [label = '@@1', fontsize = 7]
        tab2 [label = '@@2', fontsize = 7]
        blank [label = '', width = 0.0001, height = 0.0001]
        blanka [label = '', width = 0.0001, height = 0.0001]
        blankb [label = '', width = 0.0001, height = 0.0001]
        
        # bring_db2       
          subgraph {
            rank = same; tab1 -> blanka -> blank -> blankb -> tab2 [arrowhead= none]
          }
        tab3 [label = '@@3',fontsize = 6]
        blank2 [label = '', width = 0.0001, height = 0.0001]
        blank -> blank2 [arrowhead= none, label='  &#10198;']
        subgraph {
            rank = same; blank2 -> tab3
          }
        tab4 [label = '@@4',fontsize = 9]
        blank2 -> tab4 [label='        Select records of offenses committed before the application of TOP but\n        at least the last month previous to the application of TOP \\\\\\l',fontsize = 7];
  }

        [1]:  a_tab8_lab_aft_d
        [2]:  a_tab10_lab_aft_d
        [3]:  a_tab11_lab_aft_d
        [4]:  a_tab12_lab_aft_d
        [5]:  ''
        [6]:  ''
        [7]:  ''
        [8]:  ''
        ", width = 1200,
          height = 900)

plot_merge_flowchart_excercise2

plot_merge_flowchart_excercise2 %>%
  export_svg %>% charToRaw %>% rsvg::rsvg_pdf("./_figs/_flowchart2_comm_DAD.pdf")
plot_merge_flowchart_excercise2 %>% DiagrammeRsvg::export_svg()%>%charToRaw %>% rsvg::rsvg(width = WidthCM *(DPI/2.54), height = HeightCM *(DPI/2.54)) %>% png::writePNG("./_figs/_flowchart2_comm_DAD.png")

htmlwidgets::saveWidget(plot_merge_flowchart_excercise2, "./_figs/_flowchart2_comm_DAD.html")
webshot::webshot("./_figs/_flowchart2_comm_DAD.html", "./_figs/_flowchart2_comm_DAD.png",vwidth = 1200, vheight = 900, zoom = 3)
webshot::webshot("./_figs/_flowchart2_comm_DAD.html", "./_figs/_flowchart2_comm_DAD_alt.pdf")
```

<br>

# Session Info

```{r session-info, echo=T, error=T, message=TRUE, paged.print=TRUE}
message(Sys.getenv("R_LIBS_USER"))
Sys.Date()
message(paste0("Editor context: ", path))

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/14_alt.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/14_alt.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/14_alt.RData")
  } else {
    tryCatch(save.image(paste0(sub("2019","2022",sub("SUD_CL","",path)),"14_alt.RData")),
              error= save.image(paste0(sub("2019","2022",sub("SUD_CL","",path)),"/14_alt.RData")))
  }

#load(paste0(dirname(rstudioapi::getSourceEditorContext()$path),"/14_alt.RData"))

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}")))
```

