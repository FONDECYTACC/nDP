---
title: "Polysubstance and tr. completion"
description: |
  Analyze the association between polysubstance at admission and tr. compleiton longitudinally along treatments, accounting for irregular observations.
date: "`r format(Sys.time(),'%B %d, %Y')`"
author: "Andrés González Santa Cruz"
format: 
  html:
    code-fold: true
---

```{css}
#| echo: false

script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"

```

```{js zoom-jquery, echo = FALSE}
$(document).ready(function() {

$('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');

// onClick function for all plots (img's)

$('img:not(.zoomImg)').click(function() {
$('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
$('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
});

// onClick function for zoomImg

$('img.zoomImg').click(function() {
$('.zoomDiv').css({opacity: '0', width: '0%'});
});
});
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="https://github.com/AGSCL/gine_brechas_pandemia/blob/main/hideOutput.js"></script>
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {

\$chunks = \$('.fold');

\$chunks.each(function () { // add button to source code chunks
if ( \$(this).hasClass('s') ) {
    \$('pre.r', this).prepend("\<div class=\\"showopt\\"\>Show Source\</div\>\<br style=\\"line-height:22px;\\"/\>");
    \$('pre.r', this).children('code').attr('class', 'folded');
    } // add button to output chunks

    if ( \$(this).hasClass('o') ) {
        \$('pre:not(.r)', this).has('code').prepend("\<div class=\\"showopt\\"\>Show Output\</div\>\<br style=\\"line-height:22px;\\"/\>");
        \$('pre:not(.r)', this).children('code:not(r)').addClass('folded'); // add button to plots
        \$(this).find('img').wrap('\<pre class=\\"plot\\"\>\</pre\>');
        \$('pre.plot', this).prepend("\<div class=\\"showopt\\"\>Show Plot\</div\>\<br style=\\"line-height:22px;\\"/\>");
        \$('pre.plot', this).children('img').addClass('folded');
        }
}); // hide all chunks when document is loaded

\$('.folded').css('display', 'none') // function to toggle the visibility
\$('.showopt').click(function() {
        var label = \$(this).html();
        if (label.indexOf("Show") \>= 0) {
            \$(this).html(label.replace("Show", "Hide"));
        } else {
        \$(this).html(label.replace("Hide", "Show"));
        }

\$(this).siblings('code, img').slideToggle('fast', 'swing');
});
});
```

```{=html}
<style type="text/css">

.showopt {

background-color: #004c93; color: #FFFFFF; width: 100px; height: 20px; text-align: center; vertical-align: middle !important; float: right; font-family: sans-serif; border-radius: 8px;

}

.showopt:hover {
background-color: #dfe4f2;
color: #004c93;

}

pre.plot {
background-color: white !important;
}

.tablelines table, .tablelines td, .tablelines th {
border: 1px solid black;
}

.centrado {
text-align: center;
}

.table.center {
margin-left:auto;
margin-right:auto;
}

/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/

/* Applies to outputs that are not code other than R*/

pre {
overflow-x: auto !important;
}

pre code {
word-wrap: normal !important;
white-space: pre !important;
}

/*
pre:not(.sourceCode) {
white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence */
font-size: 10px !important;
line-height: 50% !important;
}
body{ /* Normal */
text-align: justify;
}
.superbigimage{
overflow-y:scroll;
height:350px;
white-space: nowrap;
overflow-x: auto;
width:100%;
}
.superbigimage img{
overflow-y: scroll;
overflow-x: hidden;
}
.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}
.pandoc-table { /* Should add !important; but it seems no necessary */
margin-left:auto; /* To center */
margin-right:auto;
border-collapse: collapse;
table-layout: auto;
font-size: 11px;
overflow-y: auto;
max-height:450px !important;
white-space: nowrap;
overflow-x: auto;
width:450px;
}
.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}
.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0px;
}
.pandoc-table caption {
text-align: left !important;
font-size: 11px !important;
}

.center-table {
text-align: left !important;
font-size: 9px;
padding: 0px;
overflow-y:scroll;
height:400px;
overflow-x: scroll;
}

.controlly{
overflow-y:scroll;
height:350px;
overflow-x: scroll;

}
</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->

<script>
function myFunction1() {
var x = document.getElementById("myDIV");
if (x.style.display === "none") {
x.style.display = "block";
} else {
x.style.display = "none";
}
}
</script>

<script>
function myFunction2() {
var x = document.getElementById("myDIV2");
if (x.style.display === "none") {
x.style.display = "block";
} else {
x.style.display = "none";
}
}
</script>
```
```{r entorno-python}
rm(list = ls()) 
unlink("proposal_grant_23_24_files", recursive=T)
#fuentes: 
#https://rpubs.com/georgy_makarov/897844
path<-paste0(getwd(),'/env')

#Sys.setenv(RETICULATE_PYTHON =  "")

#Sys.setenv(RETICULATE_PYTHON =  Sys.which("python"))

#reticulate::py_config()
#use_python(paste0(path,"/Scripts/python.exe"))

#Sys.setenv(LD_LIBRARY_PATH =  paste0(path,"/Lib"))
#Sys.setenv(LD_LIBRARY_PATH_64 =  paste0(path,"/Lib"))
#instalar paquetes de funcionalidades básicas para tener ubicaciones relativas y acceso a python (reticulate)
if(!require(reticulate)){install.packages("reticulate")}
if(!require(rstudioapi)){install.packages("rstudioapi")}


invisible("Create env")
#https://stackoverflow.com/questions/54043607/how-to-set-pyenv-python-for-reticulate
#Directory H:/Mi unidad/PERSONAL ANDRES/UCH_salud_publica/asignaturas/env is not a Python virtualenv
#virtualenv_create(envname  = path, packages = c("pip", "statsmodels", "matplotlib", "numpy", "pandas", "scipy"))
# "C:/Users/andre/anaconda3/python.exe" -m venv "H:/Mi unidad/PERSONAL ANDRES/UCH_salud_publica/asignaturas/9_Computacion_Estadistica/env"

#FUENTES:
#https://rstudio.github.io/reticulate/articles/versions.html
#Virtual environment functions are not supported on Windows (the use of conda environments is recommended on Windows).

invisible("Use environment")
#https://ugoproto.github.io/ugo_r_doc/pdf/reticulate.pdf


# tx  <- readLines(paste0(path,"/pyvenv.cfg"))
# tx[[1]] <- paste0("home = ",gsub('/', '\\', paste0(path,"/Scripts/python.exe"), fixed=T))
# tx[[3]] <- "version = 3.8.0"

#writeLines(tx, con=paste0(path,"/pyvenv.cfg"))

#H:/Mi unidad/PERSONAL ANDRES/UCH_salud_publica/asignaturas/env/Scripts/python.exe"
#use_virtualenv(path)

#usar entorno virtual ya creado
#información sobre entorno virtual
#py_discover_config()
#conda_python(envname =  "r-scrublet")


# FUENTES
#https://akrabat.com/creating-virtual-environments-with-pyenv/
#https://rstudio.github.io/reticulate/reference/install_python.html
#https://github.com/pyenv/pyenv/wiki#suggested-build-environment
#https://github.com/pyenv/pyenv
#https://stackoverflow.com/questions/56755156/reticulate-not-setting-python-path
#https://github.com/rstudio/reticulate/issues/291#issuecomment-437143751
#https://github.com/pyenv/pyenv
#https://github.com/pyenv-win/pyenv-win#installation
#https://stackoverflow.com/questions/52060867/how-to-use-pip-for-pyenv
#https://github.com/pyenv/pyenv/issues/2417
```

```{python, eval=F}
!pyenv install -l | findstr 3.8
!pip install --upgrade pyenv-win
!env PYTHON_CONFIGURE_OPTS="--enable-shared" pyenv install
!env PYTHON_CONFIGURE_OPTS="--enable-shared" pyenv install 3.7.5
!pyenv build
```

```{r, "load-data", eval=T}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

# `r format(Sys.time(),'%B %d, %Y')`

# Data import

load("an_grant_23_24.RData")

# List all of the objects names in RData:
#ls(.GlobalEnv)
#ls(new_environment)
#rm(new_environment)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
```

<br>

# Packages

```{r}
#| message: false
#| include: false
#| warning: false
pacman::p_unlock(lib.loc = .libPaths()) #para no tener problemas reinstalando paquetes

if(!require(pacman)){install.packages("pacman")}

if (getRversion() != "4.1.2") { stop("Requires R version 4.1.2. Actual: ", getRversion()) }

# limpiar completamente el entorno global environment

#Para importar bases
if(!require(rio)){install.packages("rio")}
if(!require(arrow)){install.packages("arrow")}
#Para manipular bases de datos
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(tidylog)){install.packages("tidylog")}
if(!require(sqldf)){install.packages("sqldf")}

#mstate para rediseñar los datos en formato long
if(!require(mstate)){install.packages("mstate")}

#For table 1
if(!require(tableone)){install.packages("tableone")}
if(!require(compareGroups)){install.packages("compareGroups")}
if(!require(Hmisc)){install.packages("Hmisc")}
if(!require(kableExtra)){install.packages("kableExtra")}
if(!require(DT)){install.packages("DT")}
#For regression models
if(!require(jtools)){install.packages("jtools")}
if(!require(fastDummies)){install.packages("fastDummies")}
#To install packages easy
if(!require(pacman)){install.packages("pacman")}
#To handle missing variables
pacman::p_load(missRanger, missForest, install=T)
#plots
if(!require(plotly)){install.packages("plotly")}
if(!require(easyalluvial)){install.packages("easyalluvial")}
if(!require(parcats)){install.packages("parcats")}
#IrregLong
if(!require(IrregLong)){install.packages("IrregLong")}
if(!require(MEMSS)){install.packages("MEMSS")}
if(!require(survival)){install.packages("survival")}
if(!require(geepack)){install.packages("geepack")}
if(!require(geesmv)){install.packages("geesmv")}
if(!require(rms)){install.packages("rms")}
if(!require(survex)){install.packages("survex")}
if(!require(survminer)){install.packages("survminer")}

######0.C. functions------------------

read_excel_mult <- function(dir, filename) {
  assign(paste0(substr(filename, 1, 7)),read.delim(paste0(dir, filename),
        na.strings="null", header = T, fileEncoding="UTF-8"),envir = .GlobalEnv)
  }

#function to copy names
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,...) {
  write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
  return(x)}


copiar_nombres2 <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(try(dplyr::ungroup(x)))[1]=="tbl_df"){
    if(options()$OutDec=="."){
      options(OutDec = dec)
      write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ".")
      return(x)
    } else {
      options(OutDec = ",")
      write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ",")
      return(x)    
    }
  } else {
    if(options()$OutDec=="."){
      options(OutDec = dec)
      write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ".")
      return(x)
    } else {
      options(OutDec = ",")
      write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ",")
      return(x)       
    }
  }
}  

#function to save datasets in excel files (x=object to change; y=name of the excel file)
guardar_tablas <- function (x,y) {writexl::write_xlsx(as.data.frame(x, keeprownames= T),paste0(y,".xlsx"))}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#to format rows in bold
format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  # one * for italics, two ** for bold
  map <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  

  for (r in rows){
    for(c in cols){

      # Make sure values are not factors
      df[[c]] <- as.character( df[[c]])

      # Update formatting
      df[r, c] <- ifelse(nchar(df[r, c])==0,"",paste0(markup, gsub(" ", "", df[r, c]), markup))
    }
  }

  return(df)
}
#To produce line breaks in messages and warnings
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('<div class="message">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
)
```

<br>

# Database consolidation

We used `Base_fiscalia_v15f_grant_23_24` instead of v16, because we wanted to capture more treatments from each people.

```{r bring-db2-label-variables, echo=T, error=F, eval=T}
invisible("Label variables")

#2023-07-19
attr(Base_fiscalia_v15f_grant_23_24$motivodeegreso_mod_imp_rec,"label") <- "Complete status of treatment (binary)"
attr(Base_fiscalia_v15f_grant_23_24$offense_after_adm,"label") <- "Committing an offense after admission (binary)"
attr(Base_fiscalia_v15f_grant_23_24$age_at_censor_date,"label") <- "Age at censorship"
attr(Base_fiscalia_v15f_grant_23_24$age_offending_imp,"label") <- "Age at offending"
attr(Base_fiscalia_v15f_grant_23_24$age_tr_comp_imp,"label") <- "Age at completing tr."

#attr(Base_fiscalia_v15f_grant_23_24$tr_modality,"label") <- "Treatment Modality"
attr(Base_fiscalia_v15f_grant_23_24$time_to_off_from_adm,"label") <- "Time to offense from admission"
attr(Base_fiscalia_v15f_grant_23_24$time_to_drop_from_adm,"label") <- "Time to dropout from admission"

#2023-07-31
attr(Base_fiscalia_v15f_grant_23_24$age_at_death,"label") <- "Age at death"
attr(Base_fiscalia_v15f_grant_23_24$date_death,"label") <- "Time to death from admission"
attr(Base_fiscalia_v15f_grant_23_24$event_death,"label") <- "Death from admission"

attr(Base_fiscalia_v15f_grant_23_24$event_comp,"label") <- "Event: tr.completion"
attr(Base_fiscalia_v15f_grant_23_24$event_offense,"label") <- "Event: offense"


attr(Base_fiscalia_v15f_grant_23_24$edad_al_ing_1,"label") <- "Age (admission to treatment)"
attr(Base_fiscalia_v15f_grant_23_24$sex,"label") <- "Sex"
attr(Base_fiscalia_v15f_grant_23_24$edad_ini_cons,"label") <- "Age of Onset of Substance Use"
attr(Base_fiscalia_v15f_grant_23_24$escolaridad_rec,"label") <- "Educational Attainment"
attr(Base_fiscalia_v15f_grant_23_24$sus_principal_mod,"label") <- "Primary Substance (admission to treatment)"
attr(Base_fiscalia_v15f_grant_23_24$freq_cons_sus_prin,"label") <- "Frequency of Substance Use (Primary Substance)"
attr(Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr,"label") <- "Corrected Occupational Status (f)"
attr(Base_fiscalia_v15f_grant_23_24$policonsumo,"label") <- "Co-occurring Substance Use Disorders (Polysubstance use)"

#20203-07-17
attr(Base_fiscalia_v15f_grant_23_24$otras_sus1_mod,"label") <- "First additional substance at admission"
attr(Base_fiscalia_v15f_grant_23_24$otras_sus2_mod,"label") <- "Second additional substance at admission"
attr(Base_fiscalia_v15f_grant_23_24$otras_sus3_mod,"label") <- "Third additional substance at admission"

attr(Base_fiscalia_v15f_grant_23_24$num_hijos_mod_joel_bin,"label") <- "Number of Children (dichotomized)"
attr(Base_fiscalia_v15f_grant_23_24$tenencia_de_la_vivienda_mod,"label") <- "Housing Situation (Tenure Status)"
attr(Base_fiscalia_v15f_grant_23_24$macrozona,"label") <- "Macro Administrative Zone in Chile"
attr(Base_fiscalia_v15f_grant_23_24$n_off_vio,"label") <- "Violent Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$n_off_acq,"label") <- "Acquisitive Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$n_off_sud,"label") <- "Substance-Related Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$n_off_oth,"label") <- "Other Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$dg_cie_10_rec,"label") <- "Psychiatric Comorbidity (ICD-10)"
attr(Base_fiscalia_v15f_grant_23_24$dg_trs_cons_sus_or,"label") <- "SUD Severity (Dependence status)"
attr(Base_fiscalia_v15f_grant_23_24$clas_r,"label") <- "Urbanicity"
attr(Base_fiscalia_v15f_grant_23_24$porc_pobr,"label") <- "Percentage of people in poverty"
attr(Base_fiscalia_v15f_grant_23_24$sus_ini_mod_mvv,"label") <- "Primary Substance (initial diagnosis)"
attr(Base_fiscalia_v15f_grant_23_24$ano_nac_corr,"label") <- "Corrected birth year"
attr(Base_fiscalia_v15f_grant_23_24$con_quien_vive_joel,"label") <- "Cohabitation status (Recoded) (f)"
attr(Base_fiscalia_v15f_grant_23_24$fis_comorbidity_icd_10,"label") <- "Physical Comorbidity (ICD-10)"

attr(Base_fiscalia_v15f_grant_23_24$n_post_off_vio,"label") <- "Count of Violent Criminal Offenses (Post-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$n_post_off_acq,"label") <- "Count of Acquisitive Criminal Offenses (Post-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$n_post_off_sud,"label") <- "Count of Substance-Related Criminal Offenses (Post-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$n_post_off_oth,"label") <- "Count of Other Criminal Offenses (Post-Treatment)"
attr(Base_fiscalia_v15f_grant_23_24$n_post_off,"label") <- "Count of Post-treatment Offenses"

#2024-01-27
attr(Base_fiscalia_v15f_grant_23_24$compromiso_biopsicosocial,"label") <- "Biopsychosocial compromise"
attr(Base_fiscalia_v15f_grant_23_24$origen_ingreso_mod,"label") <- "Treatment Admission Motive"


Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr24 <- 
  dplyr::if_else(Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr=="Looking for a job for the first time","Unemployed", Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr, missing=NA_character_)
Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr24 <- 
  dplyr::if_else(Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr=="No activity","Inactive", Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr24, missing=NA_character_)
Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr24 <- 
  dplyr::if_else(Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr=="Not seeking for work","Inactive", Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr24, missing=NA_character_)
#Si la persona No Trabajó, interesa saber si está Desocupada (“busca trabajo por primera vez” o “cesante”) o
#Inactiva (que corresponde al resto de la opciones, quehaceres del hogar, estudiando, jubilado, etc.)

Base_fiscalia_v15f_grant_23_24 <- Base_fiscalia_v15f_grant_23_24 %>%
  dplyr::mutate(freq_cons_sus_prin_ord = dplyr::case_when(
    freq_cons_sus_prin == "Less than 1 day a week" ~ "1. Less than 1 day a week",
    freq_cons_sus_prin == "1 day a week or more" ~ "2. 1 day a week or more",
    freq_cons_sus_prin == "2 to 3 days a week" ~ "3. 2 to 3 days a week",
    freq_cons_sus_prin == "4 to 6 days a week" ~ "4. 4 to 6 days a week",
    freq_cons_sus_prin == "Daily" ~ "5. Daily"
  )) %>%
  dplyr::mutate(clas_r= dplyr::case_when(clas_r=="Mixta"~"Mixed", clas_r=="Urbana"~"Urban",clas_r=="Rural"~"Rural", T~clas_r)) %>% 
dplyr::mutate(tenencia_de_la_vivienda_mod  = dplyr::case_when(clas_r=="Illegal Settlement"~"Others", T~tenencia_de_la_vivienda_mod)) %>% 
  #2024-04-30: Divide type of plan according to program
          dplyr::mutate(tipo_de_plan_2_mod= dplyr::case_when(as.character(tipo_de_plan_2)=="M-PR"~"WO residential", tipo_de_plan_2=="PG-PR"~ "GP residential",tipo_de_plan_2=="M-PAI"~ "WO intensive ambulatory",tipo_de_plan_2=="PG-PAI"~ "GP intensive ambulatory",grepl("PAB",tipo_de_plan_2)~"basic ambulatory", T~NA_character_)) %>% 
          dplyr::mutate(tipo_de_plan_2= dplyr::case_when(grepl("PR",tipo_de_plan_2)~"residential",grepl("PAB",tipo_de_plan_2)~"basic ambulatory",grepl("PAI",tipo_de_plan_2)~"intensive ambulatory", T~NA_character_))
   #%>% #janitor::tabyl(tipo_de_plan_2_mod)

attr(Base_fiscalia_v15f_grant_23_24$condicion_ocupacional_corr24,"label") <- "Corrected Occupational Status"
attr(Base_fiscalia_v15f_grant_23_24$freq_cons_sus_prin_ord,"label") <- "Frequency of Substance Use (Primary Substance)"

# Check the new variable
table(Base_fiscalia_v15f_grant_23_24$freq_cons_sus_prin_ord)


vars_cov <- c("motivodeegreso_mod_imp_rec", "edad_al_ing_1", "sex", "edad_ini_cons", "escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin_ord", "condicion_ocupacional_corr24", "policonsumo", "num_hijos_mod_joel_bin", "tenencia_de_la_vivienda_mod", "macrozona", "dg_cie_10_rec", "dg_trs_cons_sus_or", "clas_r", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", "fis_comorbidity_icd_10",  "compromiso_biopsicosocial", "origen_ingreso_mod", "tipo_centro_pub","tipo_de_plan_2", "tipo_de_plan_2_mod") 


#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Function to format CreateTableOne into a database")

as.data.frame.TableOne <- function(x, ...) {capture.output(print(x,
                          showAllLevels = TRUE, varLabels = T,...) -> x)
  y <- as.data.frame(x)
  y$characteristic <- dplyr::na_if(rownames(x), "")
  y <- y %>%
  fill(characteristic, .direction = "down") %>%
  dplyr::select(characteristic, everything())
  rownames(y) <- NULL
  y}
#_#_#_#_#_#_#_#_#_#_#_#_#_

tbone_desc_merge_total_grant_23_24<-
CreateTableOne(vars=c(setdiff(vars_cov, "policonsumo"), "offense_after_adm"), data=  Base_fiscalia_v15f_grant_23_24[,c("motivodeegreso_mod_imp_rec", "edad_al_ing_1", "sex", "edad_ini_cons", 
"escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin_ord", 
"condicion_ocupacional_corr24", "policonsumo", "num_hijos_mod_joel_bin", 
"tenencia_de_la_vivienda_mod", "macrozona", "dg_cie_10_rec", "dg_trs_cons_sus_or", 
"clas_r", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", 
"fis_comorbidity_icd_10", "compromiso_biopsicosocial", "origen_ingreso_mod","tipo_centro_pub")], factorVars = setdiff(vars_cov, c("motivodeegreso_mod_imp_rec","edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr")), smd=T, strata="policonsumo", addOverall = T, includeNA=T, test=T)
```

We compared the characteristics of people who used multiple substances and those who did not in the total database between 2013 and 2019.

::: center-table
```{r pre-iww-bivariate-analyses, echo=T, error=F, eval=T, paged.print=TRUE}
as.data.frame.TableOne(tbone_desc_merge_total_grant_23_24, smd=T, nonnormal= T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,TRUE~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  dplyr::mutate(across(.fns = ~ str_replace_all(., pattern = "\\( ", replacement = "\\("))) %>% 
  dplyr::mutate(across(.fns = ~ str_trim(.))) %>% 
  knitr::kable(size=10, format="markdown",caption= "Summary descriptives, Polysubstance(1) and no Polysubstance use (0)", escape=T)
#kable(size=10, format="html",caption= "Summary descriptives, by Baseline Treatment Status") %>%     kableExtra::kable_classic()

as.data.frame.TableOne(tbone_desc_merge_total_grant_23_24, smd=T, nonnormal= T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,TRUE~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  dplyr::mutate(across(.fns = ~ str_replace_all(., pattern = "\\( ", replacement = "\\("))) %>% 
  dplyr::mutate(across(.fns = ~ str_trim(.))) %>% 
  write.table("_proposal_grant/2023/baseline_psu_desc_smd.csv", dec=",", sep="\t")
#C:\Users\CISS Fondecyt\Mi unidad\Alvacast\SISTRAT 2022 (github)\_proposal_grant/2023
```
:::

## Long format

```{r correct-polyuse-original, echo=T, error=F, eval=T, paged.print=TRUE}
CONS_C1_df_dup_SEP_2020_mod<-
CONS_C1_df_dup_SEP_2020[,c("hash_key","rn_hash","otras_sus1_mod","otras_sus2_mod","otras_sus3_mod","sus_principal_mod")] %>% 
    dplyr::mutate(across(starts_with("otras_sus"), ~ dplyr::case_when(
        as.character(.) == "Cocaína" ~ "Cocaine hydrochloride",
        as.character(.) == "Marihuana" ~ "Marijuana",
        as.character(.) == "Otros" ~ "Other",
        as.character(.) == "Pasta Base" ~ "Cocaine paste",
        TRUE ~ as.character(.)
    ))) %>%
    dplyr::mutate(sus_principal_mod= as.character(sus_principal_mod)) %>%
  # Replace with missing if there are any duplicates
  dplyr::mutate(otras_sus3_mod= dplyr::case_when(otras_sus3_mod==otras_sus2_mod| otras_sus3_mod==otras_sus1_mod| otras_sus3_mod==sus_principal_mod~ NA_character_, TRUE~ otras_sus3_mod)) %>% 
  dplyr::mutate(otras_sus2_mod= dplyr::case_when(otras_sus2_mod==otras_sus1_mod| otras_sus2_mod== sus_principal_mod~ NA_character_, TRUE~ otras_sus2_mod)) %>% 
  dplyr::mutate(otras_sus1_mod= dplyr::case_when(otras_sus1_mod== sus_principal_mod~ NA_character_, TRUE~ otras_sus1_mod)) %>% 
  # Empty substances were replaced with the previous
  dplyr::mutate(otras_sus2_mod= dplyr::case_when(!is.na(otras_sus3_mod) & is.na(otras_sus2_mod)~ otras_sus3_mod, TRUE~ otras_sus2_mod)) %>% 
  dplyr::mutate(otras_sus1_mod= dplyr::case_when(!is.na(otras_sus2_mod) & is.na(otras_sus1_mod)~ otras_sus2_mod, TRUE~ otras_sus1_mod)) %>%
  dplyr::mutate(sus_principal_mod= dplyr::case_when(!is.na(otras_sus1_mod) & is.na(sus_principal_mod)~ otras_sus1_mod, TRUE~ sus_principal_mod)) %>%  
  # Replace with missing if there are any duplicates
  dplyr::mutate(otras_sus3_mod= dplyr::case_when(otras_sus3_mod==otras_sus2_mod| otras_sus3_mod==otras_sus1_mod| otras_sus3_mod==sus_principal_mod~ NA_character_, TRUE~ otras_sus3_mod)) %>% 
  dplyr::mutate(otras_sus2_mod= dplyr::case_when(otras_sus2_mod==otras_sus1_mod| otras_sus2_mod== sus_principal_mod~ NA_character_, TRUE~ otras_sus2_mod)) %>% 
  dplyr::mutate(otras_sus1_mod= dplyr::case_when(otras_sus1_mod== sus_principal_mod~ NA_character_, TRUE~ otras_sus1_mod)) %>%   
    # Replace with missing if there are any duplicates
  dplyr::mutate(otras_sus3_mod= dplyr::case_when(otras_sus3_mod==otras_sus2_mod| otras_sus3_mod==otras_sus1_mod| otras_sus3_mod==sus_principal_mod~ NA_character_, TRUE~ otras_sus3_mod)) %>% 
  dplyr::mutate(otras_sus2_mod= dplyr::case_when(otras_sus2_mod==otras_sus1_mod| otras_sus2_mod== sus_principal_mod~ NA_character_, TRUE~ otras_sus2_mod)) %>% 
  dplyr::mutate(otras_sus1_mod= dplyr::case_when(otras_sus1_mod== sus_principal_mod~ NA_character_, TRUE~ otras_sus1_mod)) %>%  
  dplyr::select(hash_key, rn_hash, sus_principal_mod,otras_sus1_mod) %>% 
  dplyr::mutate(policonsumo2= ifelse(!is.na(otras_sus1_mod),1,0)) %>% 
#  dplyr::mutate(adv=ifelse(otras_sus1_mod==sus_principal_mod,1,0)) %>% 
#    dplyr::filter(adv==1)
  data.table::data.table()
```


```{r pivot_long, eval=T, echo=T, paged.print=TRUE}  

# vars_cov <- c("motivodeegreso_mod_imp_rec", "edad_al_ing_1", "sex", "edad_ini_cons", "escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin", "condicion_ocupacional_corr", "policonsumo", "otras_sus1_mod", "otras_sus2_mod", "otras_sus3_mod", "num_hijos_mod_joel_bin", "tenencia_de_la_vivienda_mod", "macrozona", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "dg_cie_10_rec", "dg_trs_cons_sus_or", "clas_r", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", "fis_comorbidity_icd_10", "time_to_off_from_adm", "time_to_drop_from_adm", "age_at_censor_date", "age_tr_comp_imp", "age_offending_imp", "age_at_death","event_death", "n_post_off_vio", "n_post_off_acq", "n_post_off_sud", "n_post_off_oth", "n_post_off","hurto", "robo", "venta_drogas", "rina", "total_vif", "otro", "tot_off_top", "edad_a_ap_top_num",   "edad_b_ap_top_num", "na_top_count", "n_top_records")

#tipo_de_plan_2_1
#motivodeegreso_mod_imp_1
#dias_treat_imp_sin_na_1
#fech_ing_num_1
#fech_egres_num_1
#edad_al_ing_1
#edad_al_egres_1

Base_fiscalia_v15f_grant_23_24_long<-
Base_fiscalia_v15f_grant_23_24 %>% 
  dplyr::select("hash_key",
                paste0("motivodeegreso_mod_imp_",1:10),
                paste0("dias_treat_imp_sin_na_",1:10),
                paste0("fech_ing_num_",1:10),
                paste0("fech_egres_num_",1:10),
                paste0("tipo_de_plan_2_",1:10),
                c("edad_al_ing_1", "sex", "edad_ini_cons", "escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin_ord", "condicion_ocupacional_corr24", "policonsumo", "num_hijos_mod_joel_bin", "tenencia_de_la_vivienda_mod", "macrozona", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "dg_cie_10_rec", "dg_trs_cons_sus_or", "clas_r", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", "tipo_de_plan_2_mod", 
                  #2024-01-28: se agregan 3 variables
                  "tipo_centro_pub", "origen_ingreso_mod", "compromiso_biopsicosocial")) %>% 
  #has 75 missing
        dplyr::mutate(across(paste0("tipo_de_plan_2_",1:10),~dplyr::case_when(grepl("PR",.)~"residential",grepl("PAB",.)~"basic ambulatory",grepl("PAI",.)~"intensive ambulatory", T~NA_character_))) %>% 
# Pivot longer
  pivot_longer(
    # 2024-01-27: por lo que entiendo, estas variables se excluyen de la transformación longitudinal. ES NECESARIO LONGITUDINALIZARLAS
    cols = -c(hash_key, edad_al_ing_1, sex, edad_ini_cons, escolaridad_rec, sus_principal_mod, freq_cons_sus_prin_ord, condicion_ocupacional_corr24, policonsumo, num_hijos_mod_joel_bin, tenencia_de_la_vivienda_mod, macrozona, dg_cie_10_rec, dg_trs_cons_sus_or, clas_r, porc_pobr, sus_ini_mod_mvv, ano_nac_corr, con_quien_vive_joel, tipo_de_plan_2_mod,
             #2024-01-28: se agregan 3 variables
                 tipo_centro_pub, origen_ingreso_mod, compromiso_biopsicosocial 
              ),
    names_to = c(".value", "treatment"),
    names_pattern = "(.+)_(\\d+)$"
  ) %>%
  dplyr::mutate(treatment=as.numeric(treatment)) %>% 
  dplyr::filter(!is.na(fech_ing_num)) %>% 
# create event variables
  arrange(hash_key, treatment) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(enter_time=min(fech_ing_num, na.rm=T)) %>%
  dplyr::mutate(time=fech_egres_num-enter_time) %>%
  dplyr::mutate(cens_time= as.numeric(as.Date("2019-11-13"))-enter_time) %>% 
  dplyr::ungroup() %>% 
  #define event: dropout
  dplyr::mutate(event=ifelse(motivodeegreso_mod_imp %in% c("Abandono Tardio", "Abandono Temprano", "Alta Administrativa"),1,0)) %>% 
  #censorship time if event not present
    dplyr::mutate(time= dplyr::case_when(event==1~ cens_time, TRUE~ time)) %>%   #to months
  dplyr::mutate(time=time/30.5, cens_time= cens_time/30.5) %>% 
  #id variable
  group_by(hash_key) %>%
  mutate(is_first_occurrence = if_else(row_number() == 1, 1, 0)) %>%
  ungroup() %>%
  mutate(id = cumsum(is_first_occurrence)) %>% 
  dplyr::select(-is_first_occurrence)

#  length(unique(Base_fiscalia_v15f_grant_23_24_long2$hash_key))
# [1] 72404

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#Added the time-varyinng polyuse
Base_fiscalia_v15f_grant_23_24_long2<-
Base_fiscalia_v15f_grant_23_24_long %>% 
  dplyr::left_join(CONS_C1_df_dup_SEP_2020_mod[,c("hash_key",
#2024-01-28: agregué biopsychosocial_comp
"rn_hash","policonsumo2")], by=c(c("hash_key"="hash_key","treatment"="rn_hash"))) %>% # nrow() 109756
  dplyr::left_join(CONS_C1_df_dup_SEP_2020[,c("hash_key",
#2024-01-28: agregué biopsychosocial_comp
"rn_hash","compromiso_biopsicosocial")], by=c(c("hash_key"="hash_key","treatment"="rn_hash"))) %>% # nrow() 109756
  dplyr::rename("compromiso_biopsicosocial"="compromiso_biopsicosocial.x") %>% 
#2024-01-29: filtered treatments without finish
  dplyr::filter(!motivodeegreso_mod_imp %in% c("En curso", "Muerte", "Derivación")) %>% 
  #dplyr::select(hash_key,fech_ing_num, fech_egres_num, time, enter_time, cens_time)
  #2024-01-29: create event variables, again
  arrange(hash_key, treatment) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(treatment=row_number()) %>% 
  dplyr::mutate(max_treatment= max( treatment,na.rm=T)) %>% 
  dplyr::mutate(enter_time=min(fech_ing_num, na.rm=T)) %>%
  dplyr::mutate(cens_time= as.numeric(as.Date("2019-11-13"))-enter_time) %>% 
  dplyr::ungroup() %>% 
  #2024-03-04: move out of the nested de discharge date
  dplyr::mutate(time= fech_egres_num-enter_time) %>%
  dplyr::mutate(time=time/30.5, cens_time= cens_time/30.5) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(lag_time= lag(time)) %>% 
  dplyr::ungroup() %>%   
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
  dplyr::mutate(time=dplyr::case_when(lag_time==time & treatment==2~time+.001,
                                 lag_time==time & treatment==3~time+.001,
                                 lag_time==time & treatment==4~time+.001,
                                 lag_time==time & treatment==5~time+.001,
                                 lag_time==time & treatment==6~time+.001,
                                 lag_time==time & treatment==7~time+.001,
                                 lag_time==time & treatment==8~time+.001,
                                 lag_time==time & treatment==9~time+.001,
                                 TRUE~time)) %>% 
    #2024-01-29: censorship time if event not present
  #2024-03-04: surv_time in other variable
  dplyr::mutate(surv_time= dplyr::case_when(event==0~ cens_time, TRUE~ time))#to months

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#  TEST OVERLAPPINGS IN TIMES OF COUNTING PROCESS #_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

error_in_time_pre_followup<-
Base_fiscalia_v15f_grant_23_24_long2 %>% 
    dplyr::filter(dplyr::case_when(time <=lag_time & !is.na(lag_time)~T,T~F)) 
# A tibble: 3,031 x 36

Base_fiscalia_v15f_grant_23_24_long2 %>% 
    dplyr::filter(hash_key %in% unique(error_in_time_pre_followup$hash_key)) %>% 
    dplyr::select(hash_key, time, lag_time, motivodeegreso_mod_imp, dias_treat_imp_sin_na, enter_time, fech_ing_num, fech_egres_num, cens_time, treatment)
# A tibble: 7,706 x 8
# 0039f0d864e402fc7c9b8d326b6a
# 354 808 1296

```

::: center-table
```{r pre-iww-bivariate-analyses2, echo=T, error=F, eval=T}
tbone_desc_merge_total_grant_23_24_post<-
CreateTableOne(vars=c(setdiff(vars_cov, "policonsumo"), "offense_after_adm"), data=  Base_fiscalia_v15f_grant_23_24[,c("hash_key", "motivodeegreso_mod_imp_rec", "edad_al_ing_1", "sex", "edad_ini_cons", 
"escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin_ord", 
"condicion_ocupacional_corr24", "policonsumo", "num_hijos_mod_joel_bin", 
"tenencia_de_la_vivienda_mod", "macrozona", "dg_cie_10_rec", "dg_trs_cons_sus_or", 
"clas_r", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", 
"fis_comorbidity_icd_10", "compromiso_biopsicosocial", "origen_ingreso_mod","tipo_centro_pub")] %>% dplyr::filter(hash_key %in% unlist(unique(Base_fiscalia_v15f_grant_23_24_long2$hash_key))), factorVars = setdiff(vars_cov, c("motivodeegreso_mod_imp_rec","edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr")), smd=T, strata="policonsumo", addOverall = T, includeNA=T, test=T)

as.data.frame.TableOne(tbone_desc_merge_total_grant_23_24_post, smd=T, nonnormal= T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,TRUE~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  dplyr::mutate(across(.fns = ~ str_replace_all(., pattern = "\\( ", replacement = "\\("))) %>% 
  dplyr::mutate(across(.fns = ~ str_trim(.))) %>% 
  knitr::kable(size=10, format="markdown",caption= "Summary descriptives, Polysubstance(1) and no Polysubstance use (0) [exclude ongoing treatments and external referrals]", escape=T)
#kable(size=10, format="html",caption= "Summary descriptives, by Baseline Treatment Status") %>%     kableExtra::kable_classic()

as.data.frame.TableOne(tbone_desc_merge_total_grant_23_24_post, smd=T, nonnormal= T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,TRUE~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>%
  dplyr::mutate(across(.fns = ~ str_replace_all(., pattern = "\\( ", replacement = "\\("))) %>%
  dplyr::mutate(across(.fns = ~ str_trim(.))) %>% 
  write.table(paste0(getwd(),"/_proposal_grant/2023/baseline_psu_desc_smd_post.csv"), dec=",", sep="\t")
#C:\Users\CISS Fondecyt\Mi unidad\Alvacast\SISTRAT 2022 (github)\_proposal_grant/2023
```
:::

```{r abacus, eval=T, echo=T, paged.print=TRUE}
set.seed(21251)
IrregLong::abacus.plot(
    25,
    "time",
    "id",
    Base_fiscalia_v15f_grant_23_24_long2%>% #dplyr::filter(event==1)%>% 
        dplyr::group_by(hash_key) %>%
        dplyr::mutate(is_first_occurrence = if_else(row_number() == 1, 1, 0)) %>%
        dplyr::ungroup() %>%
        dplyr::mutate(id = cumsum(is_first_occurrence)) %>% 
        dplyr::select(-is_first_occurrence) %>% data.frame(),
    0,
    120,
    xlab.abacus = "Time (in months of follow-up)",
    ylab.abacus = "Subject",
    pch.abacus = 16,
    col.abacus = 1
)
#abacus_plot_irrelong
jpeg(filename = "_proposal_grant/2023/_figs/abacus.jpg", units = "in", width=8, height=5, res=500)
set.seed(21251)
IrregLong::abacus.plot(
    25,
    "time",
    "id",
    Base_fiscalia_v15f_grant_23_24_long2%>% #dplyr::filter(event==1)%>% 
        dplyr::group_by(hash_key) %>%
        dplyr::mutate(is_first_occurrence = if_else(row_number() == 1, 1, 0)) %>%
        dplyr::ungroup() %>%
        dplyr::mutate(id = cumsum(is_first_occurrence)) %>% 
        dplyr::select(-is_first_occurrence) %>% data.frame(),
    0,
    120,
    xlab.abacus = "Time (in months of follow-up)",
    ylab.abacus = "Subject",
    pch.abacus = 16,
    col.abacus = 1
)
dev.off()

summary(subset(Base_fiscalia_v15f_grant_23_24_long2, treatment==1)$max_treatment)
#prop. q tienen sólo uno
cat("Only one treatment")
scales::percent(table(subset(Base_fiscalia_v15f_grant_23_24_long2, treatment==1)$max_treatment)[1] / nrow(subset(Base_fiscalia_v15f_grant_23_24_long2, treatment==1)), accuracy=.1)
#scales::percent(59087  /72404, accuracy=.1 )

cat("Patients with 4 or more treatments")
scales::percent(
  sum(table(subset(Base_fiscalia_v15f_grant_23_24_long2, treatment==1)$max_treatment)[4:100], na.rm=T)/nrow(subset(Base_fiscalia_v15f_grant_23_24_long2, treatment==1))
)
#[1] "1%"


Base_fiscalia_v15f_grant_23_24[,c("hash_key", "motivodeegreso_mod_imp_rec", "edad_al_ing_1", "sex", "edad_ini_cons", 
"escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin_ord", 
"condicion_ocupacional_corr24", "policonsumo", "num_hijos_mod_joel_bin", 
"tenencia_de_la_vivienda_mod", "macrozona", "dg_cie_10_rec", "dg_trs_cons_sus_or", 
"clas_r", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", 
"fis_comorbidity_icd_10", "compromiso_biopsicosocial", "origen_ingreso_mod","tipo_centro_pub","duplicates_filtered")] %>% dplyr::filter(hash_key %in% unlist(unique(Base_fiscalia_v15f_grant_23_24_long2$hash_key))) %>% dplyr::mutate(duplicates_filtered= dplyr::case_when(as.numeric(duplicates_filtered)>3~4,TRUE~as.numeric(duplicates_filtered))) %>% 
  janitor::tabyl(policonsumo,duplicates_filtered)%>% 
  chisq.test()

#X-squared = 693, df = 4, p-value <2e-16

data.frame(
    col1 = c(15527, 39686),
    col2 = c(2475, 9902),
    col3 = c(530, 2841),
    col4 = c(175, 1268)
)%>%  
          mutate(across(everything(), ~ . / sum(.)) * 100) %>%
          mutate(across(everything(), round, digits = 2)) 

#    col1 col2  col3  col4
# 1 28.12   20 15.72 12.13
# 2 71.88   80 84.28 87.87

invisible("Patients with more treatments have more baseline PSU")

cbind.data.frame(motivodeegreso_mod_imp_rec = c("Treatment completion", 
                                                 "Treatment non-completion"), 
               `1` = c(15782, 39428), `2` = c(2622, 9750), 
               `3` = c(654, 2717), `4` = c(220, 1222)) %>%  
          mutate_if(is.numeric,~ . / sum(.) * 100) 
#   motivodeegreso_mod_imp_rec     1     2    3     4
# 1       Treatment completion 28.59 21.19 19.4 15.26
# 2   Treatment non-completion 71.41 78.81 80.6 84.74  

```

As seen in the previous plot, a few observations had more than one treatment.

```{r distinct-values-by-id, eval=T, echo=T, paged.print=TRUE}
paste0("Patients with more than one value of PSU (changes in patterns): ",
Base_fiscalia_v15f_grant_23_24_long2%>% 
    dplyr::group_by(hash_key) %>%
    dplyr::group_by(id) %>% 
    summarise(n_dis_psu=n_distinct(policonsumo2), n_dis_event=n_distinct(event), n_dis_event=n_distinct(dias_treat_imp_sin_na), max_tr=max(treatment)) %>% 
    dplyr::filter(n_dis_psu>1) %>% nrow()
)   
#[1] "Patients with more than one value of PSU (changes in patterns): 3235"

paste0("Patients with more than one value of event: ",
Base_fiscalia_v15f_grant_23_24_long2%>% 
    dplyr::group_by(id) %>% 
    summarise(n_dis_psu=n_distinct(policonsumo2), n_dis_event=n_distinct(event), n_dis_dias_tr=n_distinct(dias_treat_imp_sin_na), max_tr=max(treatment)) %>% 
    dplyr::filter(n_dis_event>1) %>% nrow()
)
#[1] "Patients with more than one value of event: 4623"
paste0("Patients with more than one value of days in treatment: ",
Base_fiscalia_v15f_grant_23_24_long2%>% 
    dplyr::group_by(id) %>% 
    summarise(n_dis_psu=n_distinct(policonsumo2), n_dis_event=n_distinct(event), n_dis_dias_tr=n_distinct(dias_treat_imp_sin_na), max_tr=max(treatment)) %>% 
    dplyr::filter(n_dis_dias_tr>1) %>% nrow()
)
#[1] "Patients with more than one value of days in treatment: 13289"
paste0("Patients with more than one value in biopsychosocial compromise: ",
Base_fiscalia_v15f_grant_23_24_long2%>% 
   dplyr::group_by(id) %>% 
    summarise(n_dis_psu=n_distinct(policonsumo2), n_dis_event=n_distinct(event), n_dis_dias_tr=n_distinct(dias_treat_imp_sin_na), n_dis_biopsicomp= n_distinct(compromiso_biopsicosocial.y), max_tr=max(treatment)) %>% 
    dplyr::filter(n_dis_biopsicomp>1) %>% nrow()
)
#[1] "Patients with more than one value in biopsychosocial compromise: 6691"
```


```{r long_alluv, echo=T, error=F, paged.print=TRUE, fig.align = "center", fig.cap="Sankey Plot of Transitions", fig.width=12, fig.height=8, eval=T}
library(easyalluvial)
library(parcats)

#tipo_de_plan2
#treatment, dias_treat_imp_sin_na, policonsumo2, event
# basic ambulatory intensive ambulatory          residential 
table(subset(Base_fiscalia_v15f_grant_23_24_long2, treatment==1)$max_treatment)

cat("================================")

invisible("First 4 treatments, stratified by treatment plan, to see if polysubstance use changes by treatment")

# subset(Base_fiscalia_v15f_grant_23_24_long2, hash_key%in% (dplyr::filter(Base_fiscalia_v15f_grant_23_24_long2, tipo_de_plan_2=="residential" & treatment==1) %>% dplyr::pull("hash_key") %>% unique()) & treatment<5,c("id","treatment","motivodeegreso_mod_imp","policonsumo2"))
p_alluvial<-
alluvial_long(data.frame(subset(Base_fiscalia_v15f_grant_23_24_long2, treatment<5) %>% dplyr::mutate(policonsumo2=if_else(policonsumo2==1,"PSU","no PSU",NA_character_))), 
              key= treatment,
              id= id, 
              value= policonsumo2, 
              fill_by="first_variable",
              NA_label = "censored", 
              complete=F,
              bin=3, 
              stratum_label_size=2,
              stratum_width=1/4,
              bin_labels = c("no PSU", "PSU"),
              col_vector_flow=c("red","gray60"),
              col_vector_value=c("#bf6f6f","#eec1ad","gray60") )+
  theme_void()
#1: In .f(.x[[i]], ...) : bins  (0.4544,0.4549] of policonsumo2 are empty

p_alluvial$data$x_numeric <- as.numeric(as.character(p_alluvial$data$x))  # Convert factor to numeric correctly

library(ggalluvial)
if( !is.na(match("compute",ls())) ){
    p_alluvial$data %>% 
        # dplyr::group_by(x)%>%
        # dplyr::mutate(Percentage = round(n / sum(n[value==]) * 100,1)) %>% 
        # dplyr::mutate(print=glue::glue("{format(n, big.mark=',')}; {Percentage}%"))%>% 
      dplyr::ungroup() %>% 
        ggplot(
           aes(axis1 = x_numeric, axis2 = x_numeric + 1, y = n)) +#, label = print
      geom_alluvium(aes(fill = fill)) +
      geom_stratum() +
      geom_text(stat = "stratum", size = 3) + # Adjust size as needed
      theme_minimal() +
      ggtitle("Alluvial Plot with Custom Flow Labels") +
      xlab("Stage") +
      ylab("Count")
}

df_alluvial<-
p_alluvial$data_key %>% group_by(alluvial_id) %>% slice(1) %>% 
    dplyr::group_by(`1`) %>% 
    dplyr::mutate(perc1=scales::percent(n/sum(n), accuracy=.1)) %>% 
      dplyr::group_by(`1`,`2`)%>% 
    dplyr::mutate(perc2=scales::percent(n/sum(n), accuracy=.1)) %>% 
  ungroup() %>% 
  data.table::data.table()


plot2<-
ggplot(data =df_alluvial,
       aes(axis1 = `1`, axis2 = `2`, axis3 = `3`, y = n)) +
    geom_alluvium(aes(fill = `1`)) +
    geom_stratum(alpha = .5) +
    geom_text(stat = "stratum", aes(label = paste0(after_stat(stratum),"; ",scales::percent(after_stat(prop), .1))), size=4) +
    # geom_text(stat = "flow", nudge_x = 0.3, 
    #           aes(label = paste0(after_stat(flow)," ",round(after_stat(count)*after_stat(prop), 0)), 
    #               hjust = (after_stat(flow) == "to")), 
    #           size=3) +
    scale_fill_manual(name="PSU",values = c("no PSU" = "darkred", "PSU" = "darkblue", "censored" = "gray60")) +
    xlab("Stage") +
  theme_void()+
    theme(legend.position="bottom")


ggsave(plot2, file="_proposal_grant/2023/_figs/alluvial.png", width=8.5, height=5.5, dpi=500)
ggsave(plot2, file="_proposal_grant/2023/_figs/alluvial.jpg", width=8.5, height=5.5, dpi=500)

newdat <- layer_data(plot2)
```

```{r pre-data-tree-df-cons, warning=FALSE, echo=T, error=F, eval=T}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
cat("======================================")
invisible("Database to summarise trajectories")
# data.frame(subset(Base_fiscalia_v15f_grant_23_24_long2, hash_key%in% (dplyr::filter(Base_fiscalia_v15f_grant_23_24_long2, tipo_de_plan_2=="basic ambulatory" & treatment==1) %>% dplyr::pull("hash_key") %>% unique()) & treatment<5,c("id","treatment","dias_treat_imp_sin_na","motivodeegreso_mod_imp","policonsumo2")) %>% dplyr::mutate(policonsumo2= if_else(policonsumo2==1,"PSU","no PSU",NA_character_))) %>%


df_long_trajectories_pre<-
data.frame(subset(Base_fiscalia_v15f_grant_23_24_long2, hash_key %in% (dplyr::filter(Base_fiscalia_v15f_grant_23_24_long2, treatment==1) %>% dplyr::pull("hash_key") %>% unique()) & treatment<5,c("id","treatment","dias_treat_imp_sin_na","motivodeegreso_mod_imp","policonsumo2")) %>% dplyr::mutate(policonsumo2= if_else(policonsumo2==1,"PSU","no PSU",NA_character_))) %>%
  dplyr::mutate(motivodeegreso_mod_imp= dplyr::case_when(dias_treat_imp_sin_na<90 & grepl("Admin",motivodeegreso_mod_imp)~ "Abandono Temprano", dias_treat_imp_sin_na>=90 & grepl("Admin",motivodeegreso_mod_imp)~ "Abandono Tardio", T~  motivodeegreso_mod_imp)) %>% 
  dplyr::select(-dias_treat_imp_sin_na) %>% 
  dplyr::filter(!motivodeegreso_mod_imp %in% c("Derivación","En curso", "Muerte")) %>% 
  dplyr::filter(!is.na(motivodeegreso_mod_imp)) %>% 
  dplyr::ungroup() 

cat("======================================")
invisible("Database to summarise trajectories until 4th treatment")
df_long_trajectories7<-
df_long_trajectories_pre %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats))  %>% 
  dplyr::mutate(trajectory2= trajectory) %>% 
  tidyr::separate(trajectory2, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory2",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory2) %>% 
  dplyr::arrange(desc(count))%>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

df_long_trajectories6<-
df_long_trajectories_pre %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  tidyr::separate(trajectory, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= sum(count, na.rm=T),.groups="drop") %>% 
  dplyr::arrange(desc(count))%>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats)) %>% 
  dplyr::mutate(trajectory2= trajectory) %>% 
  tidyr::separate(trajectory2, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory2",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory2) %>% 
  dplyr::arrange(desc(count))%>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

df_long_trajectories5<-
df_long_trajectories_pre %>% 
   dplyr::filter(treatment <4) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats)) %>% 
  dplyr::mutate(trajectory2= trajectory) %>% 
  tidyr::separate(trajectory2, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory2",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory2) %>% 
  dplyr::arrange(desc(count))%>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

df_long_trajectories4<-
df_long_trajectories_pre %>% 
   dplyr::filter(treatment <4) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  tidyr::separate(trajectory, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= sum(count, na.rm=T),.groups="drop") %>% 
  dplyr::arrange(desc(count))%>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats)) %>% 
  dplyr::mutate(trajectory2= trajectory) %>% 
  tidyr::separate(trajectory2, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory2",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory2) %>% 
  dplyr::arrange(desc(count))%>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

df_long_trajectories3<-
df_long_trajectories_pre %>% 
   dplyr::filter(treatment <3) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats)) %>% 
  dplyr::mutate(trajectory2= trajectory) %>% 
  tidyr::separate(trajectory2, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory2",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory2) %>% 
  dplyr::arrange(desc(count))%>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

df_long_trajectories2<-
df_long_trajectories_pre %>% 
   dplyr::filter(treatment <3) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  tidyr::separate(trajectory, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= sum(count, na.rm=T),.groups="drop") %>% 
  dplyr::arrange(desc(count))%>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats)) %>% 
  dplyr::mutate(trajectory2= trajectory) %>% 
  tidyr::separate(trajectory2, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory2",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory2) %>% 
  dplyr::arrange(desc(count))%>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

df_long_trajectories1<-
df_long_trajectories_pre %>% 
   dplyr::filter(treatment <2) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats)) %>% 
  dplyr::mutate(trajectory2= trajectory) %>% 
  tidyr::separate(trajectory2, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory2",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory2) %>% 
  dplyr::arrange(desc(count))%>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

df_long_trajectories0<-
df_long_trajectories_pre %>% 
   dplyr::filter(treatment <2) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise(trajectory = paste(policonsumo2, motivodeegreso_mod_imp, sep = " -> ", collapse = " -> "), .groups = 'drop') %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= n(),.groups="drop") %>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  tidyr::separate(trajectory, sep=" -> ", into=paste0("traj",1:(max(.$repeats)+1))) %>% 
  tidyr::unite("trajectory",paste0("traj",1:(max(.$repeats))), sep= " -> ", na.rm=T) %>% 
  dplyr::group_by(trajectory) %>% 
  dplyr::summarise(count= sum(count, na.rm=T),.groups="drop") %>% 
  dplyr::arrange(desc(count))%>% 
  dplyr::mutate(repeats = str_count(trajectory, pattern = "->")) %>% 
  dplyr::filter(repeats==max(repeats)) %>% 
  dplyr::arrange(desc(count)) %>%
  dplyr::mutate(Percentage = round(count / sum(count) * 100,1)) %>% 
  dplyr::mutate(print=glue::glue("{format(count, big.mark=',')}; {Percentage}%")) %>% 
  dplyr::ungroup() 

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

cbind.fill <- function(...) {
    transpoted <- lapply(list(...),t)
    transpoted_dataframe <- lapply(transpoted, as.data.table, keep.rownames=T)
    return (data.frame(t(plyr::rbind.fill(transpoted_dataframe))))                                               
} 
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

tree_str<-
    plyr::rbind.fill(cbind(step=1,df_long_trajectories0),
                     cbind(step=2,df_long_trajectories1),
                     cbind(step=3,df_long_trajectories2),
                     cbind(step=4,df_long_trajectories3),
                     cbind(step=5,df_long_trajectories4),
                     cbind(step=6,df_long_trajectories5),
                     cbind(step=7,df_long_trajectories6),
                     cbind(step=8,df_long_trajectories7)) %>% 
  dplyr::mutate(trajectory2 = str_replace_all(trajectory, c(
    "no PSU" = "0", #must be first because it is more specific
    "PSU" = "1",
    "Abandono Temprano" = "0",
    "Abandono Tardio" = "1",
    "Alta Terapéutica" = "2",
    " -> " = "",
    " " = ""
  )))

source(paste0(getwd(),"/_proposal_grant/2023/tree_str_pab.R"))
#tree_str_pab
source(paste0(getwd(),"/_proposal_grant/2023/tree_str_pai.R"))
#tree_str_pai
source(paste0(getwd(),"/_proposal_grant/2023/tree_str_pr.R"))
#tree_str_pr
```



```{r data-tree, warning=FALSE, echo=T, error=F, eval=T}
library(data.tree)

traveller <- Node$new("Admission")
route0 <- traveller$AddChild(paste0("1st tr., no PSU:\n", as.character(subset(tree_str, trajectory2=="0", "print"))
                                    ))
route1 <- traveller$AddChild(paste0("1st tr., PSU:\n", as.character(subset(tree_str, trajectory2=="1", "print"))
                                    ))
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#step 1
route00 <- route0$AddChild(paste0("1st  tr., no PSU, Early drop:\n", 
as.character(subset(tree_str, trajectory2=="00", "print"))
                                    ))
route01 <- route0$AddChild(paste0("1st  tr., no PSU, Late drop:\n", 
as.character(subset(tree_str, trajectory2=="01", "print"))
                                    ))
route02 <- route0$AddChild(paste0("1st  tr., no PSU, Tr. comp:\n", 
as.character(subset(tree_str, trajectory2=="02", "print"))
                                    ))
route10 <- route1$AddChild(paste0("1st  tr., PSU, Early drop:\n", 
as.character(subset(tree_str, trajectory2=="10", "print"))
                                    ))
route11 <- route1$AddChild(paste0("1st  tr., PSU, Late drop:\n", 
as.character(subset(tree_str, trajectory2=="11", "print"))
                                    ))
route12 <- route1$AddChild(paste0("1st  tr., PSU, Tr. comp:\n", 
as.character(subset(tree_str, trajectory2=="12", "print"))
                                    ))
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#step 2
route000 <- route00$AddChild(paste0("2nd tr., no PSU:\n", as.character(subset(tree_str, trajectory2=="000", "print"))
                                    ))
route001 <- route00$AddChild(paste0("2nd tr., PSU:\n", as.character(subset(tree_str, trajectory2=="001", "print"))
                                    ))
route010 <- route01$AddChild(paste0("2nd tr., no PSU:\n", as.character(subset(tree_str, trajectory2=="010", "print"))
                                    ))
route011 <- route01$AddChild(paste0("2nd tr., PSU:\n", as.character(subset(tree_str, trajectory2=="011", "print"))
                                    ))
route020 <- route02$AddChild(paste0("2nd tr., no PSU:\n", as.character(subset(tree_str, trajectory2=="020", "print"))
                                    ))
route021 <- route02$AddChild(paste0("2nd tr., PSU:\n", as.character(subset(tree_str, trajectory2=="021", "print"))
                                    ))
route100 <- route10$AddChild(paste0("2nd tr., no PSU:\n", as.character(subset(tree_str, trajectory2=="100", "print"))
                                    ))
route101 <- route10$AddChild(paste0("2nd tr., PSU:\n", as.character(subset(tree_str, trajectory2=="101", "print"))
                                    ))
route110 <- route11$AddChild(paste0("2nd tr., no PSU:\n", as.character(subset(tree_str, trajectory2=="110", "print"))
                                    ))
route111 <- route11$AddChild(paste0("2nd tr., PSU:\n", as.character(subset(tree_str, trajectory2=="111", "print"))
                                    ))
route120 <- route12$AddChild(paste0("2nd tr., no PSU:\n", as.character(subset(tree_str, trajectory2=="120", "print"))
                                    ))
route121 <- route12$AddChild(paste0("2nd tr., PSU:\n", as.character(subset(tree_str, trajectory2=="121", "print"))
                                    ))
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#step 3
route0000 <- route000$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="0000", "print"))
                                    ))
route0010 <- route001$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="0010", "print"))
                                    ))
route0100 <- route010$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="0100", "print"))
                                    ))
route0110 <- route011$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="0110", "print"))
                                    ))
route0200 <- route020$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="0200", "print"))
                                    ))
route0210 <- route021$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="0210", "print"))
                                    ))
route1000 <- route100$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="1000", "print"))
                                    ))
route1010 <- route101$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="1010", "print"))
                                    ))
route1100 <- route110$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="1100", "print"))
                                    ))
route1110 <- route111$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="1110", "print"))
                                    ))
route1200 <- route120$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="1200", "print"))
                                    ))
route1210 <- route121$AddChild(paste0("3rd tr., Early drop:\n", as.character(subset(tree_str, trajectory2=="1210", "print"))
                                    ))

route0001 <- route000$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="0001", "print"))
                                    ))
route0011 <- route001$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="0011", "print"))
                                    ))
route0101 <- route010$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="0101", "print"))
                                    ))
route0111 <- route011$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="0111", "print"))
                                    ))
route0201 <- route020$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="0201", "print"))
                                    ))
route0211 <- route021$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="0211", "print"))
                                    ))
route1001 <- route100$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="1001", "print"))
                                    ))
route1011 <- route101$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="1011", "print"))
                                    ))
route1101 <- route110$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="1101", "print"))
                                    ))
route1111 <- route111$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="1111", "print"))
                                    ))
route1201 <- route120$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="1201", "print"))
                                    ))
route1211 <- route121$AddChild(paste0("3rd tr., Late drop:\n", as.character(subset(tree_str, trajectory2=="1211", "print"))
                                    ))

route0002 <- route000$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="0002", "print"))
                                    ))
route0012 <- route001$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="0012", "print"))
                                    ))
route0102 <- route010$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="0102", "print"))
                                    ))
route0112 <- route011$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="0112", "print"))
                                    ))
route0202 <- route020$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="0202", "print"))
                                    ))
route0212 <- route021$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="0212", "print"))
                                    ))
route1002 <- route100$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="1002", "print"))
                                    ))
route1012 <- route101$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="1012", "print"))
                                    ))
route1102 <- route110$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="1102", "print"))
                                    ))
route1112 <- route111$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="1112", "print"))
                                    ))
route1202 <- route120$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="1202", "print"))
                                    ))
route1212 <- route121$AddChild(paste0("3rd tr., Tr. comp:\n", as.character(subset(tree_str, trajectory2=="1212", "print"))
                                    ))

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
SetGraphStyle(traveller, rankdir = "LR")
plot(traveller)

```

<br>

## Missingness

```{r miss-diag, echo=T, error=F, eval=T}
paste0("Percentage of the total that has missing values: ",
scales::percent(Base_fiscalia_v15f_grant_23_24_long2[which(complete.cases(subset(Base_fiscalia_v15f_grant_23_24_long2, select= c(hash_key, tipo_de_plan_2, tipo_de_plan_2_mod, sex,  edad_al_ing_1, edad_ini_cons, escolaridad_rec, sus_principal_mod, freq_cons_sus_prin_ord, condicion_ocupacional_corr24, policonsumo, policonsumo2, num_hijos_mod_joel_bin, tenencia_de_la_vivienda_mod, macrozona, dg_cie_10_rec, dg_trs_cons_sus_or, clas_r, porc_pobr, sus_ini_mod_mvv, ano_nac_corr, con_quien_vive_joel, tipo_centro_pub, origen_ingreso_mod, compromiso_biopsicosocial,compromiso_biopsicosocial.y)))),] %>% nrow()/nrow(Base_fiscalia_v15f_grant_23_24_long2), accuracy = 0.1)
, "; total= ", format(nrow(Base_fiscalia_v15f_grant_23_24_long2),big.mark=","))
#[1] "Percentage of the total that has missing values: 84.4%; total= 90,075"
# 76029

# length(unique(Base_fiscalia_v15f_grant_23_24_long2$hash_key))
#patients: 72404

Base_fiscalia_v15f_grant_23_24_long %>% dplyr::filter(!motivodeegreso_mod_imp %in% c("En curso", "Muerte", "Derivación")) %>%  distinct(hash_key) %>% nrow()
#[1] 72404

missing_pct <- colMeans(is.na(subset(Base_fiscalia_v15f_grant_23_24_long2, select= c(hash_key, tipo_de_plan_2, tipo_de_plan_2_mod, sex,  edad_al_ing_1, edad_ini_cons, escolaridad_rec, sus_principal_mod, freq_cons_sus_prin_ord, condicion_ocupacional_corr24, policonsumo, policonsumo2, num_hijos_mod_joel_bin, tenencia_de_la_vivienda_mod, macrozona, dg_cie_10_rec, dg_trs_cons_sus_or, clas_r, porc_pobr, sus_ini_mod_mvv, ano_nac_corr, con_quien_vive_joel, tipo_centro_pub, origen_ingreso_mod, compromiso_biopsicosocial, compromiso_biopsicosocial.y
              ) ))) * 100
round(missing_pct,2)
```


::: controlly

```{r miss-imputation, warning=FALSE, echo=T, error=F, eval=T}
set.seed(2125)
Base_fiscalia_v15f_grant_23_24_long2_miss <- Base_fiscalia_v15f_grant_23_24_long2 %>% 
  dplyr::arrange(hash_key, fech_ing_num) %>% 
   missRanger::missRanger(
                formula =  sus_principal_mod + condicion_ocupacional_corr24 + dg_trs_cons_sus_or + con_quien_vive_joel + clas_r + porc_pobr + edad_al_ing_1 + ano_nac_corr +  macrozona + tipo_centro_pub + tipo_de_plan_2 + tipo_de_plan_2_mod + escolaridad_rec + freq_cons_sus_prin_ord + num_hijos_mod_joel_bin + compromiso_biopsicosocial.y + compromiso_biopsicosocial + tenencia_de_la_vivienda_mod + sus_ini_mod_mvv + edad_ini_cons ~ edad_al_ing_1 + sex + edad_ini_cons + escolaridad_rec + sus_principal_mod + freq_cons_sus_prin_ord + condicion_ocupacional_corr24 + policonsumo + num_hijos_mod_joel_bin + tenencia_de_la_vivienda_mod + macrozona + dg_cie_10_rec + dg_trs_cons_sus_or + clas_r + porc_pobr + sus_ini_mod_mvv + ano_nac_corr + con_quien_vive_joel + tipo_centro_pub + origen_ingreso_mod + compromiso_biopsicosocial + cens_time + policonsumo2 + compromiso_biopsicosocial.y + tipo_de_plan_2 + tipo_de_plan_2_mod, 
                num.trees = 300, 
                pmm.k = 5,                
                returnOOB=T,
                maxiter= 50,
                verbose = 2, 
                seed = 2125)
invisible("2024-04-25: ! Can't subset columns that don't exist; Column `vars_cov` doesn't exist. I corrected that by including explicitly the covariates")
library(arrow)
library(rio)
arrow::write_parquet(Base_fiscalia_v15f_grant_23_24_long2_miss, 
  "_proposal_grant/2023/Base_fiscalia_v15f_grant_23_24_long2_miss240425.gz.parquet", 
  compression = "gzip", compression_level = 5)

column_names <- c(
  "sus_principal_mod", "condicion_ocupacional_corr24", "dg_trs_cons_sus_or", "con_quien_vive_joel",
  "clas_r", "porc_pobr", "edad_al_ing_1", "ano_nac_corr", "macrozona", "tipo_centro_pub",
  "tipo_de_plan_2", "tipo_de_plan_2_mod", "escolaridad_rec", "freq_cons_sus_prin_ord",
  "num_hijos_mod_joel_bin", "compromiso_biopsicosocial.y", "compromiso_biopsicosocial",
  "tenencia_de_la_vivienda_mod", "sus_ini_mod_mvv", "edad_ini_cons"
)
rmses_reduction <- matrix(
  c(
    0.4744, 0.4529, 0.2608, 0.4665, 0.1676, 0.5058, 0.6236, 0.0106, 0.1195, 0.1534, 0.3502, 0.0965, 0.3121, 0.3646, 0.6032, 0.3099, 0.0592, 0.3085, 0.2574, 0.5780, 1e-04, 0.0000, 0.0000, 0.0000, 0.0000, 0.0084, 0.0013, 0.0011, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 1e-04, 0.0012, 0.0000, 0.0000, 4e-04, 1e-04, 0.0186, 1e-04, 0.0000, 0.0000, 0.0000, 0.0000, 0.0083, 0.0012, 0.0012, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 1e-04, 0.0011, 0.0000, 0.0000, 5e-04, 1e-04, 0.0188
  ),
  nrow = 3, byrow = TRUE
)
rmses_reduction <- data.frame(rmses_reduction)
colnames(rmses_reduction) <- column_names



#dput(round(attr(Base_fiscalia_v15f_grant_23_24_long2_miss,"oob"),3))
print("Out of bag error:")
c(sus_principal_mod = 0, 
  condicion_ocupacional_corr24 = 0, 
  dg_trs_cons_sus_or = 0, 
  con_quien_vive_joel = 0, 
  clas_r = 0, 
  porc_pobr = 0.008, 
  edad_al_ing_1 = 0.001, 
  ano_nac_corr = 0.001, 
  macrozona = 0, 
  tipo_centro_pub = 0, 
  tipo_de_plan_2 = 0, tipo_de_plan_2_mod = 0, 
  escolaridad_rec = 0, 
  freq_cons_sus_prin_ord = 0, 
  num_hijos_mod_joel_bin = 0.001, 
  compromiso_biopsicosocial.y = 0, 
  compromiso_biopsicosocial = 0, 
  tenencia_de_la_vivienda_mod = 0, 
  sus_ini_mod_mvv = 0, 
  edad_ini_cons = 0.019)

#OOB prediction error per iteration and variable (1 minus R-squared for regression)

#The default mtry in missRanger is sqrt(p), where p is the number of variables in the dataset.
#OOB prediction errors are quantified as 1 - R^2 for numeric variables, and as classification error otherwise. If a variable has been imputed only univariately, the value is 1.
#https://rdrr.io/cran/missRanger/man/missRanger.html
```

:::

<br>

## IrreLong

### Irregularity

```{r exmple-irrelong, include=F, error=F, eval=F}
#https://cran.r-project.org/web/packages/IrregLong/vignettes/Irreglong-vignette.html
require(MEMSS)
data(Phenobarb)

invisible("2024-03-08: EJEMPLO, NO CORRER")
invisible("Por lo visto, el evento se produce cuando hay conc, ")
invisible("si no no, dejar sólo las veces q salió el evento")
Phenobarb$event <- 1-as.numeric(is.na(Phenobarb$conc))
data <- Phenobarb
data <- data[data$event==1,]
data$id <- as.numeric(data$Subject)
data <- data[data$time<16*24,]
data <- data[order(data$id,data$time),]
# head(data)
# Subject: an ordered factor identifying the infant.
# Wt: a numeric vector giving the birth weight of the infant (kg).
# Apgar: an ordered factor giving the the 5-minute Apgar score for the infant. This is an indication of health of the newborn infant.
# ApgarInd: a factor indicating whether the 5-minute Apgar score is <5 or >=5.
# time: a numeric vector giving the time when the sample is drawn or drug administered (hr).
# dose: a numeric vector giving the dose of drug administered (μg/kg).
# conc: a numeric vector giving the phenobarbital concentration in the serum(μg/L).

#data$Apgar <- as.numeric(data$Apgar)
#     Subject  Wt Apgar ApgarInd  time dose conc event id
# 2         1 1.4     8     >= 5   2.0   NA 17.3     1  1
# 12        1 1.4     8     >= 5 112.5   NA 31.0     1  1
# 136      10 1.4     8     >= 5   1.2   NA 19.9     1  2
# 142      10 1.4     8     >= 5  70.7   NA 23.4     1  2
# 149      10 1.4     8     >= 5 142.2   NA 30.9     1  2
# 155      11 1.2     8     >= 5  57.5   NA 24.3     1  3
# 157      12 1.3     7     >= 5   2.0   NA 17.0     1  4
# 169      12 1.3     7     >= 5 132.2   NA 34.1     1  4
# 171      12 1.3     7     >= 5 302.5   NA 16.0     1  4
# 175      13 1.1     7     >= 5  36.5   NA 24.1     1  5

maxfu_vect<-
    data %>% 
    dplyr::group_by(Subject) %>% 
    summarise(n=max(time, na.rm=T)) %>% pull(n)


i <- iiw.weights(Surv(time.lag,time,event)~Wt + Apgar + 
                   I(conc.lag>0 & conc.lag<=20) + 
                I(conc.lag>20 & conc.lag<=30) + I(conc.lag>30)+
      cluster(Subject),id="Subject",time="time",event="event",data=data,
      invariant=c("Subject","Wt","Apgar"),lagvars=c("time","conc"),maxfu=16*24, #maxfu_vect,#
      lagfirst=c(0,0),first=FALSE)
i$m

```

We first formatted the data according what is being needed by the method used here: `id`  which represents hash_keys in a numeric factored format, and generated the variable `less90d_tr` which is a variable that groups days in treatment between 0-90 in 1, and 0 for anything else. Additionally, we renamed the variable of biopsychosocial compromise longitudinally measured ( `compromiso_biopsicosocial.y`) for `comp_bpsc_y` for ease of processing.

```{r irrelong-1-data-format, warning=FALSE, echo=T, error=F, eval=T}

Base_fiscalia_v15f_grant_23_24_long2_proc<-
Base_fiscalia_v15f_grant_23_24_long2%>% #dplyr::filter(event==1)%>% 
  dplyr::group_by(hash_key) %>%
  dplyr::mutate(is_first_occurrence = if_else(row_number() == 1, 1, 0)) %>%
#para hacer ID
  dplyr::ungroup() %>%
  dplyr::mutate(id = cumsum(is_first_occurrence)) %>% 
  dplyr::select(-is_first_occurrence) %>%
  dplyr::mutate(less_90d_tr= factor(if_else(dias_treat_imp_sin_na<=90 & dias_treat_imp_sin_na>0,1,0,NA_real_)))%>%
  dplyr::rename("comp_bpsc_y"="compromiso_biopsicosocial.y") %>% 
  data.frame()

Base_fiscalia_v15f_grant_23_24_long2_miss_proc<-
Base_fiscalia_v15f_grant_23_24_long2_miss%>% #dplyr::filter(event==1)%>% 
  dplyr::group_by(hash_key) %>%
  dplyr::mutate(is_first_occurrence = if_else(row_number() == 1, 1, 0)) %>%
#para hacer ID
  dplyr::ungroup() %>%
  dplyr::mutate(id = cumsum(is_first_occurrence)) %>% 
  dplyr::select(-is_first_occurrence) %>%
  dplyr::mutate(less_90d_tr= factor(if_else(dias_treat_imp_sin_na<=90 & dias_treat_imp_sin_na>0,1,0,NA_real_)))%>%
  dplyr::rename("comp_bpsc_y"="compromiso_biopsicosocial.y") %>% 
  data.frame()

invisible("parece que había que especificar bien las palabras, no permite data.tables")
```

Next, we measured the extent of irregularity between observation times and gaps between observations. We replicated this analysis in the imputed and original databases, and using calendar time as a reference of time taken.

```{r irrelong-2-irregularity, warning=FALSE, echo=T, error=F, eval=T}

invisible(" Measuring extent of irregularity")

counts <- extent.of.irregularity(Base_fiscalia_v15f_grant_23_24_long2_proc,
                                 time="time",
                                 id="id",
   scheduledtimes=NULL, cutpoints=NULL,ncutpts=50, 
   maxfu=16*24, plot=F, legendx=30, legendy=0.8,
  formula=Surv(time.lag,time,event)~1,tau=12*12)

counts_counts<-
matrix(c(0, 0.81609, 0.18391, 0.4476, 0.49165, 0.06075, 0.61607, 
0.35612, 0.02781, 0.70566, 0.27893, 0.0154, 0.76138, 0.22912, 
0.0095, 0.7994, 0.19428, 0.00632, 0.82702, 0.16847, 0.00451, 
0.84794, 0.14878, 0.00327, 0.86434, 0.1332, 0.00245, 0.87765, 
0.12038, 0.00197, 0.88848, 0.11, 0.00152, 0.8976, 0.10118, 0.00122, 
0.90537, 0.09359, 0.00103, 0.91202, 0.08712, 0.00085, 0.91781, 
0.08147, 0.00072, 0.92287, 0.07653, 6e-04, 0.92734, 0.07216, 
5e-04, 0.93132, 0.06826, 0.00042, 0.9349, 0.06473, 0.00037, 0.93815, 
0.06151, 0.00034, 0.94107, 0.05863, 3e-04, 0.94371, 0.05603, 
0.00025, 0.94615, 0.05361, 0.00023, 0.94838, 0.05141, 0.00021, 
0.95043, 0.04938, 0.00019, 0.95233, 0.0475, 0.00017, 0.95408, 
0.04576, 0.00015, 0.95572, 0.04413, 0.00015, 0.95724, 0.04262, 
0.00014, 0.95866, 0.04122, 0.00012, 0.95999, 0.03989, 0.00012, 
0.96123, 0.03867, 1e-04, 0.9624, 0.0375, 1e-04, 0.9635, 0.03642, 
8e-05, 0.96454, 0.03538, 8e-05, 0.96552, 0.03441, 7e-05, 0.96645, 
0.03348, 7e-05, 0.96733, 0.03261, 7e-05, 0.96817, 0.03177, 6e-05, 
0.96896, 0.03099, 6e-05, 0.96971, 0.03025, 5e-05, 0.97043, 0.02952, 
5e-05, 0.97112, 0.02883, 5e-05, 0.97177, 0.02818, 4e-05, 0.9724, 
0.02756, 4e-05, 0.973, 0.02696, 4e-05, 0.97357, 0.02639, 4e-05, 
0.97412, 0.02584, 4e-05, 0.97464, 0.02533, 3e-05, 0.97515, 0.02482, 
3e-05), 
byrow=T,
 nrow = 50, ncol= 3, dimnames = list(NULL, c("X1", "X2", "X3")))
counts$auc
# $auc
# [1] 0.06548913
counts$transformed.auc
# $transformed.auc
# [1] 20.25358

invisible("Is not that much, but is more than 0")


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

counts_miss <- extent.of.irregularity(Base_fiscalia_v15f_grant_23_24_long2_miss_proc,
                                 time="time",
                                 id="id",
   scheduledtimes=NULL, cutpoints=NULL,ncutpts=50, 
   maxfu=16*24, plot=F, legendx=30, legendy=0.8,
  formula=Surv(time.lag,time,event)~1,tau=12*12)


counts_miss_counts<-
matrix(c(0, 0.81609, 0.18391, 0.4476, 0.49165, 0.06075, 0.61607, 
0.35612, 0.02781, 0.70566, 0.27893, 0.0154, 0.76138, 0.22912, 
0.0095, 0.7994, 0.19428, 0.00632, 0.82702, 0.16847, 0.00451, 
0.84794, 0.14878, 0.00327, 0.86434, 0.1332, 0.00245, 0.87765, 
0.12038, 0.00197, 0.88848, 0.11, 0.00152, 0.8976, 0.10118, 0.00122, 
0.90537, 0.09359, 0.00103, 0.91202, 0.08712, 0.00085, 0.91781, 
0.08147, 0.00072, 0.92287, 0.07653, 6e-04, 0.92734, 0.07216, 
5e-04, 0.93132, 0.06826, 0.00042, 0.9349, 0.06473, 0.00037, 0.93815, 
0.06151, 0.00034, 0.94107, 0.05863, 3e-04, 0.94371, 0.05603, 
0.00025, 0.94615, 0.05361, 0.00023, 0.94838, 0.05141, 0.00021, 
0.95043, 0.04938, 0.00019, 0.95233, 0.0475, 0.00017, 0.95408, 
0.04576, 0.00015, 0.95572, 0.04413, 0.00015, 0.95724, 0.04262, 
0.00014, 0.95866, 0.04122, 0.00012, 0.95999, 0.03989, 0.00012, 
0.96123, 0.03867, 1e-04, 0.9624, 0.0375, 1e-04, 0.9635, 0.03642, 
8e-05, 0.96454, 0.03538, 8e-05, 0.96552, 0.03441, 7e-05, 0.96645, 
0.03348, 7e-05, 0.96733, 0.03261, 7e-05, 0.96817, 0.03177, 6e-05, 
0.96896, 0.03099, 6e-05, 0.96971, 0.03025, 5e-05, 0.97043, 0.02952, 
5e-05, 0.97112, 0.02883, 5e-05, 0.97177, 0.02818, 4e-05, 0.9724, 
0.02756, 4e-05, 0.973, 0.02696, 4e-05, 0.97357, 0.02639, 4e-05, 
0.97412, 0.02584, 4e-05, 0.97464, 0.02533, 3e-05, 0.97515, 0.02482, 
3e-05), 
# 2024-03-07:  i realized that i retrieved the information wrong so i need the byrow
byrow=T,
 nrow = 50, ncol= 3, dimnames = list(NULL, c("X1", "X2", "X3")))

counts_miss$auc
#[1] 0.06548913

counts_miss$transformed.auc
#[1] 20.25358

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("2024-04-27: restrict to people w/ >1 treatment")

Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr<-
Base_fiscalia_v15f_grant_23_24_long2_miss_proc %>% 
  dplyr::group_by(hash_key) %>% dplyr::mutate(n=n()) %>% dplyr::mutate(is_first_occurrence = if_else(row_number() == 1, 1, 0)) %>% dplyr::ungroup() %>% dplyr::filter(case_when(n>1~ T,T~F)) %>% dplyr::mutate(id = factor(cumsum(is_first_occurrence))) %>% data.frame()
    #dplyr::filter(max_treatment>1)


paste0("p= ", length(unique(Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr$hash_key)),
       "; n= ", nrow(Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr))

counts_restricted <- extent.of.irregularity(Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr,
                                 time="time",
                                 id="id",
   scheduledtimes=NULL, cutpoints=NULL,ncutpts=50, 
   maxfu=16*24, plot=F, legendx=30, legendy=0.8,
  formula=Surv(time.lag,time,event)~1,tau=12*12)

#counts_restricted$counts %>% round(.,5) %>% dput()
counts_restricted_counts<-
matrix(c(0, 8e-05, 0.99992, 0.21724, 0.45048, 0.33228, 0.39361, 
0.45328, 0.15311, 0.51048, 0.40435, 0.08517, 0.59123, 0.35607, 
0.0527, 0.64965, 0.31514, 0.03522, 0.69401, 0.28082, 0.02517, 
0.7286, 0.25287, 0.01853, 0.75589, 0.23032, 0.01379, 0.77875, 
0.21026, 0.01099, 0.79751, 0.19379, 0.0087, 0.81332, 0.17973, 
0.00695, 0.8271, 0.16702, 0.00588, 0.83873, 0.1565, 0.00477, 
0.84907, 0.14687, 0.00405, 0.85816, 0.13838, 0.00347, 0.86615, 
0.13091, 0.00294, 0.87323, 0.12434, 0.00243, 0.87973, 0.11814, 
0.00213, 0.88562, 0.11247, 0.00191, 0.89094, 0.10736, 0.0017, 
0.89575, 0.10278, 0.00147, 0.90021, 0.09844, 0.00135, 0.90428, 
0.09453, 0.0012, 0.90803, 0.09088, 0.00109, 0.91152, 0.08749, 
0.00099, 0.91473, 0.08438, 0.00089, 0.91773, 0.08145, 0.00082, 
0.92056, 0.07867, 0.00077, 0.92317, 0.07612, 0.00071, 0.92562, 
0.07371, 0.00067, 0.92791, 0.07148, 0.00061, 0.93006, 0.06938, 
0.00056, 0.93207, 0.06743, 5e-04, 0.93399, 0.06556, 0.00046, 
0.93578, 0.06382, 4e-04, 0.93752, 0.06209, 4e-04, 0.93916, 0.06046, 
0.00038, 0.94071, 0.05892, 0.00037, 0.94216, 0.05751, 0.00033, 
0.94356, 0.05613, 0.00031, 0.94491, 0.05478, 0.00031, 0.94617, 
0.05356, 0.00028, 0.94736, 0.05239, 0.00025, 0.94853, 0.05123, 
0.00024, 0.94965, 0.05012, 0.00023, 0.95072, 0.04906, 0.00022, 
0.95173, 0.04806, 2e-04, 0.95271, 0.04709, 0.00019, 0.95365, 
0.04617, 0.00018), 
# 2024-03-07:  i realized that i retrieved the information wrong so i need the byrow
byrow=T,
 nrow = 50, ncol= 3, dimnames = list(NULL, c("X1", "X2", "X3")))

counts_restricted$auc
#[1] 0.213

counts_restricted$transformed.auc
#80 
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Check if there were any errors in of lag times after time")

error_in_time_followup<-
Base_fiscalia_v15f_grant_23_24_long2_proc %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(lag_time= lag(time)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(dplyr::case_when(time <=lag_time & !is.na(lag_time)~T,T~F)) %>% 
  dplyr::select(hash_key, time, lag_time, motivodeegreso_mod_imp, dias_treat_imp_sin_na, enter_time, fech_ing_num, fech_egres_num, cens_time)
# A tibble: 0 x 9

Base_fiscalia_v15f_grant_23_24_long2_proc %>% 
    dplyr::group_by(hash_key) %>% 
  dplyr::mutate(lag_time= lag(time)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(hash_key %in% unique(error_in_time_followup$hash_key)) %>% 
  dplyr::select(hash_key, time, motivodeegreso_mod_imp, dias_treat_imp_sin_na, enter_time, fech_ing_num, fech_egres_num, cens_time)
# A tibble: 0 x 8

error_in_time_followup_miss<-
Base_fiscalia_v15f_grant_23_24_long2_miss_proc %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(lag_time= lag(time)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(dplyr::case_when(time <=lag_time & !is.na(lag_time)~T,T~F)) %>% 
  dplyr::select(hash_key, time, lag_time, motivodeegreso_mod_imp, dias_treat_imp_sin_na, enter_time, fech_ing_num, fech_egres_num, cens_time)
# A tibble: 0 x 9

Base_fiscalia_v15f_grant_23_24_long2_miss_proc %>% 
    dplyr::group_by(hash_key) %>% 
  dplyr::mutate(lag_time= lag(time)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(hash_key %in% unique(error_in_time_followup_miss$hash_key)) %>% 
  dplyr::select(hash_key, time, motivodeegreso_mod_imp, dias_treat_imp_sin_na, enter_time, fech_ing_num, fech_egres_num, cens_time) %>%
  {
    if (nrow(.) > 0) {
      stop("There are ties or previous events that occured later than the actual events")
    } else {
      # Behavior when the condition isn't met (e.g., return an empty data frame)
      data.frame(.) 
    }  
  }
# [1] hash_key               time                   motivodeegreso_mod_imp dias_treat_imp_sin_na  enter_time            
# [6] fech_ing_num           fech_egres_num         cens_time             
# <0 rows> (or 0-length row.names)
invisible( "There are no ties or previous events that occured later than the following events")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("Now we do it with calendar date unaltered")
set.seed(2125)
counts_corr <- extent.of.irregularity(dplyr::mutate(Base_fiscalia_v15f_grant_23_24_long2_proc, fech_egres_num= fech_egres_num/30.5),
                                 time="fech_egres_num",
                                 id="id",
   scheduledtimes=NULL, cutpoints=NULL,ncutpts=50, 
   maxfu=18213/30.5, plot=F, legendx=30, legendy=0.8,
  formula=Surv(fech_egres_num.lag,fech_egres_num,event)~1,tau=12*12)

counts_corr_counts<-
matrix(c(0.00023, 0.81592, 0.18384, 0.46307, 0.46597, 0.07096, 
0.62881, 0.33313, 0.03807, 0.71395, 0.26336, 0.02269, 0.76724, 
0.21789, 0.01487, 0.80367, 0.18596, 0.01037, 0.8302, 0.16231, 
0.00749, 0.85036, 0.14405, 0.00559, 0.86621, 0.12954, 0.00425, 
0.87903, 0.11765, 0.00332, 0.88967, 0.10767, 0.00266, 0.89855, 
0.09931, 0.00214, 0.90617, 0.09204, 0.00179, 0.91267, 0.08586, 
0.00147, 0.91832, 0.08047, 0.00121, 0.92335, 0.07558, 0.00107, 
0.92776, 0.07134, 9e-04, 0.93165, 0.06762, 0.00073, 0.93519, 
0.06417, 0.00064, 0.93839, 0.06104, 0.00057, 0.94128, 0.05822, 
5e-04, 0.94391, 0.05566, 0.00043, 0.94631, 0.05332, 0.00038, 
0.94852, 0.05115, 0.00034, 0.95054, 0.04917, 0.00029, 0.95245, 
0.04727, 0.00028, 0.95418, 0.04558, 0.00024, 0.95581, 0.04398, 
0.00022, 0.9573, 0.04251, 0.00019, 0.95873, 0.04108, 0.00019, 
0.96004, 0.0398, 0.00016, 0.96129, 0.03855, 0.00016, 0.96245, 
0.03741, 0.00014, 0.96355, 0.03633, 0.00013, 0.96458, 0.0353, 
0.00012, 0.96555, 0.03435, 1e-04, 0.96649, 0.03342, 1e-04, 0.96737, 
0.03254, 9e-05, 0.96819, 0.03172, 8e-05, 0.96898, 0.03094, 8e-05, 
0.96974, 0.03019, 7e-05, 0.97046, 0.02948, 7e-05, 0.97113, 0.02881, 
5e-05, 0.97179, 0.02815, 6e-05, 0.97242, 0.02753, 5e-05, 0.97301, 
0.02694, 5e-05, 0.97358, 0.02638, 4e-05, 0.97413, 0.02583, 4e-05, 
0.97466, 0.0253, 4e-05, 0.97516, 0.0248, 4e-05), 
 nrow = 50, ncol= 3,
# i realized that i needed the byrow=T because i used bad the reading of the dput
byrow=T, dimnames = list(NULL, c("X1", "X2", "X3")))

counts_corr$auc
# $auc
# [1] 0.07266227
# 
counts_corr$transformed.auc
# $transformed.auc
# [1] 22.65514

if(exists("omitted")){
  invisible("To check specific gap bin widths for the 3 options in a specific time after 'filter'==1 (e.g.)")
rbind.data.frame(cbind.data.frame(type=rep("1. Modified",), time= 1:50, counts_counts),cbind.data.frame(type=rep("2. Modified\n(imputation)",), time= 1:50, counts_miss_counts), cbind.data.frame(type=rep("3. More 1\ntreatment",), time= 1:50, counts_restricted_counts), cbind.data.frame(type=rep("4. Original\ncalendar",), time= 1:50, counts_corr_counts)) %>% dplyr::filter(time==2) %>% dplyr::mutate_if(is.numeric,~round(.,2))

rbind.data.frame(cbind.data.frame(type=rep("1. Modified",), time= 1:50, counts_counts),cbind.data.frame(type=rep("2. Modified\n(imputation)",), time= 1:50, counts_miss_counts), cbind.data.frame(type=rep("3. More 1\ntreatment",), time= 1:50, counts_restricted_counts), cbind.data.frame(type=rep("4. Original\ncalendar",), time= 1:50, counts_corr_counts)) %>% dplyr::filter(time==6) %>% dplyr::mutate_if(is.numeric,~round(.,2))

#2024-05-13
cbind.data.frame(type=rep("5. Restricted\ntreatments",), time= 1:50, counts_restricted_counts) %>% dplyr::filter(time==2) %>% dplyr::mutate_if(is.numeric,~round(.,2))

cbind.data.frame(type=rep("5. Restricted\ntreatments",), time= 1:50, counts_restricted_counts) %>% dplyr::filter(time==6) %>% dplyr::mutate_if(is.numeric,~round(.,2))
}

plot_irregularity<-
rbind.data.frame(cbind.data.frame(type=rep("1. Modified",), time= 1:50, counts_counts),cbind.data.frame(type=rep("2. Modified\n(imputation)",), time= 1:50, counts_miss_counts),cbind.data.frame(type=rep("3. More 1\ntreatment",), time= 1:50, counts_restricted_counts),cbind.data.frame(type=rep("4. Original\ncalendar",), time= 1:50, counts_corr_counts)) %>% 
  reshape2::melt(id=c("type", "time")) %>% 
  dplyr::mutate(Observations= factor(variable, labels=c("0 obs per bin","1 obs per bin", "2+ obs per bin"))) %>% 
  ggplot(aes(x=time, y=value, linetype=Observations), linewidth=1)+
  geom_line()+
  facet_wrap(~type)+ #color=factor(type))
  theme_classic()+
  xlab("Bin width (%)")+
  ylab("Mean proportions of individuals")#+
  # scale_linetype_manual(name="Observations")

plot_irregularity

plot_irregularity_05_2024<-
rbind.data.frame(cbind.data.frame(type=rep("3. More 1\ntreatment",), time= 1:50, counts_restricted_counts)) %>% 
    reshape2::melt(id=c("type", "time")) %>% 
    dplyr::mutate(Observations= factor(variable, labels=c("0 obs per bin","1 obs per bin", "2+ obs per bin"))) %>% 
    ggplot(aes(x=time, y=value, linetype=Observations), linewidth=1)+
    geom_line()+
    #facet_wrap(~type)+ #color=factor(type))
    theme_classic()+
    xlab("Bin width (%)")+
    ylab("Mean proportions of individuals")#+


folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")

ggsave(plot_irregularity, file="_proposal_grant/2023/_figs/irreg240427.jpg", width=8.5, height=5.5, dpi=500)
ggsave(plot_irregularity_05_2024, file= paste0(folder_path,"_figs/irreg240513.jpg"), width=8.5, height=5.5, dpi=500)

```

The AUCs that suggest that although low values, we can suspect a share of a counting process behind visits rather than a perfect repeated measures. Thus, it seems reasonable to conduct an analysis that consider irregularity in observations and an extent of informative assessment times, conditional on a bulk of covariates, including past observed outcomes, past assessment history, and baseline covariates.
The graphic show the mean proportions of individuals with 0,1, and >1 visits per bin as bin width varies from 1 to 50% of the gap between admissions. In the graphic, we can see that in the first 5 bins there were more than one observation in the same bin of time.

<br>

### IIW

```{r irrelong-3-iiw-weights, warning=FALSE, echo=T, error=T, eval=T}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/an_grant_23_24_04_15.RData")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

# formulaph: the formula for the proportional hazards model for the visit intensity that will be used to derive inverse-intensity weights. The formula should usually use the counting process format (i.e. Surv(start,stop,event)). If a frailty model is used, the cluster(id) term should appear before other covariates
# 
# formulanull: if stabilised weights are to be used, the formula for the null model used to stabilise the weights
# 
# data: data frame containing the variables in the model
# 
# id: character string indicating which column of the data identifies subjects
# 
# time: character string indicating which column of the data contains the time at which the visit occurred
# 
# event: character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
# 
# lagvars: a vector of variable names corresponding to variables which need to be lagged by one visit to fit the visit intensity model. Typically time will be one of these variables. The function will internally add columns to the data containing the values of the lagged variables from the previous visit. Values of lagged variables for a subject's first visit will be set to NA. To access these variables in specifying the proportional hazards formulae, add ".lag" to the variable you wish to lag. For example, if time is the variable for time, time.lag is the time of the previous visit
# 
# invariant: a vector of variable names corresponding to variables in data that are time-invariant. It is not necessary to list every such variable, just those that are invariant and also included in the proportional hazards model
# 
# maxfu: the maximum follow-up time(s). If everyone is followed for the same length of time, this can be given as a single value. If individuals have different follow-up times, maxfu should have the same number of elements as there are rows of data
# 
# lagfirst: A vector giving the value of each lagged variable for the first time within each subject. This is helpful if, for example, time is the variable to be lagged and you know that all subjects entered the study at time zero
# 
# first: logical variable. If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred; in this case the baseline visit is observed with probability 1.

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("2024-03-06: No es necesario correr el proceso longitudinal con ...")
invisible("fech_ing_num.lag,fech_ing_num, porque ya corregi time y no debiese tener ...")
invisible("superposiciones con lag.time")


invisible("Por lo visto si hay un problema, pq no recupero ninguno")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("2014-03-08: Primero tenemos que ver si es plausible ver evidencia en contra de eventos aleatorios. ")

# glimpse(Phenobarb)

invisible("Correct id so it resemble Phenobarb")
if(class(Base_fiscalia_v15f_grant_23_24_long2_miss_proc$id)!="factor"){
Base_fiscalia_v15f_grant_23_24_long2_miss_proc$id <- factor(Base_fiscalia_v15f_grant_23_24_long2_miss_proc$id)
}
invisible("Correct id so it resemble Phenobarb")
data_mine_miss <- Base_fiscalia_v15f_grant_23_24_long2_miss_proc

invisible("Correct id so it resemble Phenobarb")
if(class(Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr$id)!="factor"){
Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr$id <- factor(Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr$id)
}
data_mine_miss_restr <- Base_fiscalia_v15f_grant_23_24_long2_miss_proc_multtr
 
 invisible("2024-04-15: Need to take into account that this implies having only those who experiment the event, which might be bad. I have to have people that is observed. This should be the event")
# BAD: data_mine_miss <- data_mine_miss[data_mine_miss$event==1,]
 
invisible("2024-04-15: keep the tr. outcome")
data_mine_miss$tr_outcome <- data_mine_miss$event
data_mine_miss_restr$tr_outcome <- data_mine_miss_restr$event

invisible("2024-04-15: transform the event into 1 (being observed")
data_mine_miss$event<-1
data_mine_miss_restr$event<-1


data_mine_miss_proc <-  
cbind.data.frame(data_mine_miss,model.matrix(~ comp_bpsc_y - 1 + less_90d_tr -1, data = data.frame(data_mine_miss))) %>% dplyr::rename("comp_bpsc_y2_moderate"="comp_bpsc_y2-Moderate","comp_bpsc_y3_severe"="comp_bpsc_y3-Severe") %>% data.frame() 

data_mine_miss_restr_proc <-  
cbind.data.frame(data_mine_miss_restr,model.matrix(~ comp_bpsc_y - 1 + less_90d_tr -1, data = data.frame(data_mine_miss_restr))) %>% dplyr::rename("comp_bpsc_y2_moderate"="comp_bpsc_y2-Moderate","comp_bpsc_y3_severe"="comp_bpsc_y3-Severe") %>% data.frame() 

invisible("2024-04-18: eliminate Mild level")
data_mine_miss_proc$comp_bpsc_y1.Mild<-NULL
data_mine_miss_restr_proc$comp_bpsc_y1.Mild<-NULL

invisible("2024-04-15: following the addcensoredrows function vignette [https://search.r-project.org/CRAN/refmans/IrregLong/html/addcensoredrows.html] we crated a database to compute")
maxfu_df<-
  data_mine_miss_proc %>% 
  dplyr::group_by(id) %>% 
  dplyr::summarise(maxfu.time= max(cens_time, na.rm=T)) %>% #,0)
  dplyr::rename("maxfu.id"="id") %>% 
  as.data.frame()

maxfu_restr_df<-
  data_mine_miss_restr_proc  %>% 
  dplyr::group_by(id) %>% 
  dplyr::summarise(maxfu.time= max(cens_time, na.rm=T)) %>% #,0)
  dplyr::rename("maxfu.id"="id") %>% 
  as.data.frame()

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_ 
invisible("2024-04-15: Make a sample of 10% to test quicker")
data_mine_miss_proc_sample<-
data_mine_miss_proc %>% 
  dplyr::filter(id %in%
as.character(sample(1:length(unique(data_mine_miss_proc$id)),5e3)))

maxfu_sample_df<-
  data_mine_miss_proc_sample %>% 
  dplyr::group_by(id) %>% 
  dplyr::summarise(maxfu.time= round(max(cens_time, na.rm=T),0)) %>% 
  dplyr::rename("maxfu.id"="id") %>% 
  as.data.frame()

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("i0: only events; missing values, only event.lag")
i0 <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag + 
  cluster(id),
      id= "id",
      time= "time",
      event= "event", #event: dropout; 2024-04-18 being reobserved (visit)
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome"),#"less_90d_tr", "comp_bpsc_y"), #
      maxfu= maxfu_df,#12*12,# Base_fiscalia_v15f_grant_23_24_long2$cens_time, #12*12,
      lagfirst= c(0,0),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i0$m
broom::tidy(i0$m)
#broom::tidy(i0$m) %>% dput()

i0_df_out<-
  cbind.data.frame(term = "tr_outcome.lag", estimate = -1.86862564229299, 
    std.error = 0.00958080874903184, robust.se = 0.00974694287151046, 
    statistic = -191.714024276765, p.value = 0)%>% 
    dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
    dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
    dplyr::mutate(HR= estimate) %>% 
    dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

i0$datacox %>% 
  dplyr::group_by(id) %>% 
  dplyr::mutate(lag_time= lag(time)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(dplyr::case_when(time <=lag_time & !is.na(lag_time)~T,T~F)) %>% 
  dplyr::select(hash_key, time, lag_time, motivodeegreso_mod_imp, dias_treat_imp_sin_na, enter_time, fech_ing_num, fech_egres_num, cens_time)%>%
  {
    if (nrow(.) > 0) {
      stop("There are ties or previous events that occured later than the actual events")
    } else {
      # Behavior when the condition isn't met (e.g., return an empty data frame)
      data.frame(.) 
    }  
  }

invisible("it seems that there are no errors")


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("i0b: only events; missing values, only event.lag; lag first 1s")
i0b <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag + #comp_bpsc_y.lag+ less_90d_tr.lag+ 
  cluster(id),
      id= "id",
      time= "time",
      event= "event", #event: dropout
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome"),#"less_90d_tr", "comp_bpsc_y"), #
      maxfu= maxfu_df,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(1,1),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i0b$m
broom::tidy(i0b$m)

i0b_df_out<-
  cbind.data.frame(term = "tr_outcome.lag", estimate = 1.06836854522169, 
    std.error = 0.0170488969088114, robust.se = 0.0169029487257102, 
    statistic = 63.2060454396721, p.value = 0)%>% 
    dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
    dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
    dplyr::mutate(HR= estimate) %>% 
    dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i0$iiw.weight)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 1.000   1.000   1.000   1.846   1.000   6.479 
ploti0<-
ggplot( data= as.data.frame(i0$iiw.weight),aes(x= `i0$iiw.weight`))+
    geom_histogram(bins=30)+
  theme_classic()+ xlim(0,10)
#Removed 13708 rows containing non-finite values (`stat_bin()`). 


summary(i0b$iiw.weight)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.3436  1.0000  1.0000  0.8986  1.0000  1.0000
ploti0b<-
ggplot( data= as.data.frame(i0b$iiw.weight),aes(x= `i0b$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Restrict to users with more than one treatment")

data_mine_miss_proc_multtr<-
data_mine_miss_proc %>% 
  dplyr::group_by(hash_key) %>% dplyr::mutate(n=n()) %>% dplyr::ungroup() %>% dplyr::filter(case_when(n>1~ T,T~F)) %>% data.frame()
    #dplyr::filter(max_treatment>1) 

invisible("2014-04-15: make a follow-up for this subsample")
maxfu_multtr_df<-
    data_mine_miss_proc_multtr %>% 
    dplyr::group_by(id) %>% 
    dplyr::summarise(maxfu.time= max(cens_time, na.rm=T)) %>% #,0)
    dplyr::rename("maxfu.id"="id") %>% 
    as.data.frame()

invisible("Remember that his has only events (observations)")

paste0("The original database had ",
       format(length(unique(data_mine_miss_proc$hash_key)), big.mark=","),
       " patients and ",
       format(length(data_mine_miss_proc$hash_key), big.mark=","),
       " observations with only events, but keeping patients with more than one treatment left only ",
       format(length(unique(data_mine_miss_proc_multtr$hash_key)), big.mark=","),
       " patients and ",
       format(length(data_mine_miss_proc_multtr$hash_key), big.mark=","),
       " observations"
       )
#[1] "The original database had 72,404 patients and 90,075 observations with only events, but keeping patients with more than one treatment left only 13,317 patients and 30,988 observations"

invisible("multiple treatments; only event.lag; lag first 0s")
i0c <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag + #comp_bpsc_y.lag+ less_90d_tr.lag+ 
  cluster(id),
      id= "id",
      time= "time",
      event= "event", #event: dropout
      data= data_mine_miss_proc_multtr,
      invariant= "id",
      lagvars= c("time", "tr_outcome"),#"less_90d_tr", "comp_bpsc_y"), #
      maxfu= maxfu_multtr_df, #12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(0,0),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )
# In Surv(fech_ing_num.lag, fech_ing_num, event) :
#   Stop time must be > start time, NA created

i0c$m
broom::tidy(i0c$m)

i0c_df_out<-
  cbind.data.frame(term = "tr_outcome.lag", estimate = -0.747182521538917, 
    std.error = 0.0122906036735641, robust.se = 0.00877334474470237, 
    statistic = -85.1650702532908, p.value = 0)%>% 
    dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
    dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
    dplyr::mutate(HR= estimate) %>% 
    dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

i0d <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag + #comp_bpsc_y.lag+ less_90d_tr.lag+ 
  cluster(id),
      id= "id",
      time= "time",
      event= "event", #event: observed
      data= data_mine_miss_proc_multtr,
      invariant= "id",
      lagvars= c("time", "tr_outcome"),#"less_90d_tr", "comp_bpsc_y"), #
      maxfu= maxfu_multtr_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(1,1),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )
# In Surv(fech_ing_num.lag, fech_ing_num, event) :
#   Stop time must be > start time, NA created

i0d$m
broom::tidy(i0d$m)

i0d_df_out<-
cbind.data.frame(term = "tr_outcome.lag", estimate = 0.274653363170145, 
    std.error = 0.0179832241105765, robust.se = 0.0129143329186389, 
    statistic = 21.2673287037339, p.value = 2.27894355540563e-100)%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i0c$iiw.weight)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 1.000   1.000   1.000   1.499   2.111   2.111 

ploti0c<-
ggplot( data= as.data.frame(i0c$iiw.weight),aes(x= `i0c$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

summary(i0d$iiw.weight)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.7598  0.7598  0.7598  0.7890  0.7598  1.0000 

ploti0d<-
ggplot( data= as.data.frame(i0d$iiw.weight),aes(x= `i0d$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

invisible("Now we use the 'data_mine_miss_proc' and try to dummify previous events")
 
i1 <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ #less_90d_tr.lag+ 
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1", "policonsumo2"),
      maxfu= maxfu_df,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= rep(0),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )
invisible("No longer  Error in as.character.factor(x) : malformed factor")
# Además: Warning message:
# In Surv(time.lag, time, event) : Stop time must be > start time, NA created

invisible("Glimpse")
data_mine_miss_proc[,c("id", "time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1")] %>% glimpse()

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
 
i1b <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ #less_90d_tr.lag+ 
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(1,1,0,1,1,1),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i1$m
broom::tidy(i1$m)

i1_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag"
), estimate = c(0.179303997546012, 0.155159976117794, 0.522643191348996, 
0.0396946478038892, 0.200990917537315), std.error = c(0.0192034667885392, 
0.0319537357893297, 0.0323780221201328, 0.0180015312824529, 0.0198507378783121
), robust.se = c(0.0196804675715693, 0.0322870898718578, 0.0332167392234256, 
0.0184789094834668, 0.020873477226514), statistic = c(9.11075902510759, 
4.80563521623034, 15.7343316522896, 2.14810553833841, 9.62900983656
), p.value = c(8.18076035588734e-20, 1.54260938373677e-06, 8.79807768652411e-56, 
0.0317053723627336, 6.03077841071276e-22))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("It is not necessary to investigate violations of the counting process (progressive times)")
invisible("Does really PSU in the previous treatment protects?. 2024-04-15: now it make sense, every coeff is HR>1!")

i1b$m
broom::tidy(i1b$m)

i1b_df_out<-cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag"
), estimate = c(0.204663142678526, 0.00379136822637489, 1.43645954073343, 
1.27844124422329, 0.840329282274339), std.error = c(0.0185085344588536, 
0.0318597956273076, 0.0306100046937583, 0.011541793220903, 0.0185082077607319
), robust.se = c(0.020386616410505, 0.0335664648273184, 0.03190467043629, 
0.0118920257355396, 0.0211189171816328), statistic = c(10.039093224566, 
0.112951073217852, 45.0234878182453, 107.504076484012, 39.7903583335785
), p.value = c(1.02613077760236e-23, 0.910069344802066, 0, 0, 
0))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i1$iiw.weight)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.3896  1.0000  1.0000  0.9118  1.0000  1.0000 

ploti1<-
ggplot( data= as.data.frame(i1$iiw.weight),aes(x= `i1$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)


summary(i1b$iiw.weight)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.02329 1.00000 1.00000 0.85417 1.00000 1.00000

ploti1b<-
ggplot( data= as.data.frame(i1b$iiw.weight),aes(x= `i1b$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
 
i1c <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ #less_90d_tr.lag+ 
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc_multtr,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_multtr_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= rep(0,6),
      formulanull= Surv(time.lag,time,event)~ 1,
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i1d <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ #less_90d_tr.lag+ 
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc_multtr,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_multtr_df,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst=c(1,1,0,1,1,1),
      formulanull= Surv(time.lag,time,event)~ 1,
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
i1c$m
broom::tidy(i1c$m)

i1c_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag"
), estimate = c(-0.302245037062739, -0.903956210807159, -0.813321897718714, 
-0.114245961363377, -0.308855961637097), std.error = c(0.0154310846877583, 
0.0190313654021939, 0.0198660721579724, 0.0176396124863469, 0.015967581763868
), robust.se = c(0.0129727086353161, 0.0173025650006909, 0.0181205187074852, 
0.0158153935544036, 0.0133307124770294), statistic = c(-23.2985296717391, 
-52.2440580787336, -44.8840295825939, -7.22371915503593, -23.1687512703688
), p.value = c(4.58804176323613e-120, 0, 0, 5.05846724994571e-13, 
9.40892053149018e-119))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

i1d$m
broom::tidy(i1d$m)

i1d_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag"
), estimate = c(0.0914594442348692, -0.0479067360824922, 0.395018880185181, 
0.449421044097101, 0.237239909387438), std.error = c(0.0189119890640763, 
0.0318880405199674, 0.0313463499911823, 0.0141743240908896, 0.0191755226262578
), robust.se = c(0.0147135065696911, 0.0228906898308705, 0.0223775814909527, 
0.0123024239813926, 0.0151689053922935), statistic = c(6.21601953291473, 
-2.09284807214001, 17.6524384614525, 36.5310970242003, 15.6398832514288
), p.value = c(5.09924589471951e-10, 0.0363627189586838, 9.74559709383605e-70, 
3.55949649474628e-292, 3.89441388490098e-55))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i1c$iiw.weight)
  # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  # 1.000   1.000   3.051   2.660   4.155   5.100 

ploti1c<-
ggplot( data= as.data.frame(i1c$iiw.weight),aes(x= `i1c$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

summary(i1d$iiw.weight)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.3094  0.3094  0.3922  0.4848  0.6737  1.0491 

ploti1d<-
ggplot( data= as.data.frame(i1d$iiw.weight),aes(x= `i1d$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

invisible("Now we use the 'data_mine_miss_proc' and try to dummify previous events")
 
i2 <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ treatment+#less_90d_tr.lag+ 
  cluster(hash_key),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2", "treatment"),
      maxfu= maxfu_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(0,0,0,0,0,0,0),
      formulanull= Surv(time.lag,time,event)~ 1,
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i2$m
broom::tidy(i2$m)

i2_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", 
"treatment"), estimate = c(-0.207821827365346, -0.795634053728106, 
-0.645100128805644, 0.165468256440595, -0.492699340028085, -0.263268962510958
), std.error = c(0.0157193638381784, 0.0193245384394512, 0.0204926882142567, 
0.0178456628682898, 0.0161016116581923, 0.0125485993898615), 
    robust.se = c(0.0190740908371374, 0.0254091936208088, 0.0272893127250465, 
    0.0205418969887765, 0.019247319556775, 0.0157928620459193
    ), statistic = c(-10.8955037039414, -31.3128415486796, -23.6392955478708, 
    8.05515948848355, -25.5983353201332, -16.6701236131537), 
    p.value = c(1.21094635824601e-27, 3.120318630146e-215, 1.52095150935808e-123, 
    7.93752420512666e-16, 1.5920600972545e-144, 2.1614709120083e-62
    ))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Does really previous dropout protect dropout?") 
invisible("maybe because lagfirst was 0")
invisible("Does really Severe previous biopsychosocial is a protective factor of dropout?")
invisible("Does really 0-90 days in previous treatment is a protective factor of dropout?")
invisible("Does really PSU in previous treatment is a protective factor of dropout?")
invisible("Does really more treatments protect dropout?")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i2$iiw.weight)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   # 1.00    1.00    1.00    1.72    1.00   44.54 

ploti2<-
ggplot( data= as.data.frame(i2$iiw.weight),aes(x= `i2$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

invisible("Some extreme weights")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i3 <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ policonsumo2+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_df, #12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(0,0,0,0,0,0),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i3$m
broom::tidy(i3$m)

i3_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", "comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", "policonsumo2"), estimate = c(-0.285082046756843, -0.916585948362177, 
-0.795077921451114, 0.11763808302626, -0.569791427138684, 0.164345823420033
), std.error = c(0.01492765131367, 0.0178053744947168, 0.0186611556090444, 
0.0176615698524595, 0.0157351197601704, 0.00773975706029995), 
    robust.se = c(0.0179877493992649, 0.0223101496182252, 0.0236349676291152, 
    0.0202282450263194, 0.0186724156095066, 0.00757289335696934
    ), statistic = c(-15.8486779212352, -41.0838100168282, -33.639898895892, 
    5.81553579528025, -30.5151427139716, 21.7018536605676), p.value = c(1.43569566146437e-56, 
    0, 4.38118085650704e-248, 6.04399775632908e-09, 1.64100047755937e-204, 
    1.97056906465211e-104))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Previous dropout prevents actual dropout?")
invisible("maybe because lagfirst was 0")
invisible("Severe biopsychosocial compromise is a risk factor of actual dropout?")
invisible("previous PSU prevents actual dropout?")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i3$iiw.weight)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.7543  1.0000  1.0000  1.5863  1.0000  5.8794 

ploti3<-
ggplot( data= as.data.frame(i3$iiw.weight),aes(x= `i3$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)

invisible("Reasonable weights")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i3b <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ policonsumo2+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(1,1,0,1,1,1),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i3b$m
broom::tidy(i3b$m)

i3b_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", "comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", "policonsumo2"), estimate = c(0.171524496903936, 0.00483620529764353, 0.596008396206245, 0.855542927694904, 0.125702439454889, 0.0627347379496959), std.error = c(0.018874296525738, 0.0318585598048639, 0.0309630894506515, 0.0128979749956164, 0.0189962053653323, 0.00782722711322035), robust.se = c(0.0179913060388931, 0.0292985300929012, 0.0290119903127091, 0.0144451828760062, 0.020549409265887, 0.00759613906581795), statistic = c(9.53374349439331, 0.165066482253842, 20.543519757938, 59.2268671873984, 6.11708287223425, 8.2587663819897), p.value = c(1.51711569984396e-21, 0.868891654364147, 8.79518334988573e-94, 0, 9.53038111046381e-10, 1.47185680747056e-16))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("previous dropout transform to nothing; 2024-04-16: dropping out previously is a risk factor")
invisible("previous PSU still protects an actual dropout; 2024-04-16: previous PSU is a risk factor")
invisible("previous severe biopsuchosocial still is a risk factor; 2024-04-16: severe biopsychosocial, risk factor (80%+)")
invisible("now less than 90 days in treatment its a risk factor; 2024-04-16: less than 90 days tr. previously, risk factor of being observed posteriorly (readmission) (x2.3)")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i3b$iiw.weight)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.1634  1.0000  1.0000  0.9055  1.0000  1.0000 

ploti3b<-
ggplot( data= as.data.frame(i3b$iiw.weight),aes(x= `i3b$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)
invisible("Many 0s or near 0s")


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i3_nolag <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ policonsumo2+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_df, #12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      #lagfirst= rep(1,6),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )
invisible("Here, i didnt specified lagfirst")
# Error in shift(.SD, fill = lagfirst[col]) : 
#   entrada en evaluacion: recursivo por defecto o problemas anteriores?
invisible("It gives an error")


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

invisible("We format the data to include non-events; 2024-04-16: this is no longer useful because we are including every record (all event=1)")
# data_mine2_miss <- Base_fiscalia_v15f_grant_23_24_long2_miss_proc
# 
# data_mine2_miss_proc <-  
# data_mine2_miss %>% 
# dplyr::mutate(comp_bpsc_y2_moderate= ifelse(as.character(comp_bpsc_y)=="2-Moderate",1,0),
#           comp_bpsc_y3_severe= ifelse(as.character(comp_bpsc_y)=="3-Severe",1,0),
#           less_90d_tr1= ifelse(less_90d_tr==1,1,0)) %>% data.frame() 

i4 <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ treatment.lag+
  cluster(hash_key),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2", "treatment"),
      maxfu= maxfu_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= rep(0,7),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i4$m
broom::tidy(i4$m)

i4_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", 
"treatment.lag"), estimate = c(-0.207821827365346, -0.795634053728106, 
-0.645100128805644, 0.165468256440595, -0.492699340028085, -0.263268962510958
), std.error = c(0.0157193638381784, 0.0193245384394512, 0.0204926882142567, 
0.0178456628682898, 0.0161016116581923, 0.0125485993898615), 
    robust.se = c(0.0190740908371374, 0.0254091936208087, 0.0272893127250465, 
    0.0205418969887765, 0.019247319556775, 0.0157928620459193
    ), statistic = c(-10.8955037039414, -31.3128415486796, -23.6392955478708, 
    8.05515948848355, -25.5983353201332, -16.6701236131537), 
    p.value = c(1.21094635824605e-27, 3.12031863014138e-215, 
    1.52095150935808e-123, 7.93752420512701e-16, 1.59206009725477e-144, 
    2.16147091200972e-62))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Previous dropout protects posterior dropout, but 95% CI does not replicate that; prev. dropouts protects posterior obs.")
invisible("Moderate previous biopsychosocial status protects actual dropout; both severe and moderate pro")
invisible("Severe previous biopsychosocial status protects actual dropout")
invisible("0-90 days in previous tr. predicts actual dropout")
invisible("previous PSU protects actual dropout")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i4$iiw.weight)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 1.00    1.00    1.00    1.72    1.00   44.54  #2024-04-16: muy bizarro que haya un caso con probabilidades muy altas

ploti4<-
ggplot( data= as.data.frame(i4$iiw.weight),aes(x= `i4$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)
invisible("Reasonable, some positive outliers but very big")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i4b <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ treatment.lag+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2", "treatment"),
      maxfu= maxfu_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(1,1,0,1,1,1,1),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i4b$m
broom::tidy(i4b$m)

i4b_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", 
"treatment.lag"), estimate = c(0.204102531211081, -0.000387761814109535, 
1.42748577725764, 1.27218207100866, 0.846223498441861, 0.145344423972201
), std.error = c(0.0184955717163036, 0.0318615324506995, 0.0306160739199961, 
0.011538166117299, 0.0185111088069143, 0.0115312169046261), robust.se = c(0.0202100857453012, 
0.0334267319824861, 0.0317905279138096, 0.0118704233236429, 0.0208804874610975, 
0.0153330805627965), statistic = c(10.0990433085389, -0.0116003507107037, 
44.9028648133129, 107.172426485818, 40.5269991909175, 9.47914043606206
), p.value = c(5.5783718456834e-24, 0.990744466851805, 0, 0, 
0, 2.56386267293478e-21))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Previous dropout now predicts actual dropout")
invisible("Moderate previous biopsychosocial status does not [2024-04-16] predict actual dropout")
invisible("Severe previous biopsychosocial status predict actual dropout")
invisible("0-90 days in previous tr. predicts actual dropout")
invisible("previous PSU predicts posterior dropout")
invisible("more treatments can be a protective factor for subsequent treatments [2024-04-16]")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i4b$iiw.weight)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# 0.008687 1.000000 1.000000 0.853483 1.000000 1.022155 

ploti4b<-
ggplot( data= as.data.frame(i4b$iiw.weight),aes(x= `i4b$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)
invisible("Reasonable")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#2024-04-16: no longer useful
# 
# data_mine2_miss_proc_multtr<-
#     data_mine2_miss_proc %>% 
#     dplyr::group_by(hash_key) %>% dplyr::mutate(n=n()) %>% dplyr::ungroup() %>% dplyr::filter(case_when(n>1~ T,T~F)) %>% data.frame()
# 
# 
# paste0("The original database had ",
#        format(length(unique(data_mine2_miss_proc$hash_key)), big.mark=","),
#        " patients and ",
#        format(length(data_mine2_miss_proc$hash_key), big.mark=","),
#        " observations with only events, but keeping patients with more than one treatment left only ",
#        format(length(unique(data_mine2_miss_proc_multtr$hash_key)), big.mark=","),
#        " patients and ",
#        format(length(data_mine2_miss_proc_multtr$hash_key), big.mark=","),
#        " observations"
#        )

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i4c <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ treatment.lag+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc_multtr,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2", "treatment"),
      maxfu= maxfu_multtr_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= rep(0,7),# c(1,1,0,1,1,1,1),
      #formulanull= Surv(time.lag,time,event)~ 1,
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )


invisible("FORMULANULL entrega ponderaciones y coeficientes iguales a sin formulanull")
i4c$m
broom::tidy(i4c$m)

i4c_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", 
"treatment.lag"), estimate = c(0.0283175141261873, -0.286052899938312, 
-0.12762290937749, 0.123676646115759, -0.18046907845805, -1.33577820010306
), std.error = c(0.0174225204858456, 0.0232998089273985, 0.0242539101271994, 
0.0180040024564168, 0.0178722433414989, 0.0155176207475381), 
    robust.se = c(0.0159600395125907, 0.0240699432379503, 0.0251576808692291, 
    0.0172158438569811, 0.016189953421006, 0.0278980099478121
    ), statistic = c(1.77427594109952, -11.884236581302, -5.07292027595389, 
    7.18388521313221, -11.1469794733255, -47.8807700836676), 
    p.value = c(0.0760175181238697, 1.42935024171782e-32, 3.91756657551751e-07, 
    6.77577589606902e-13, 7.40784798532889e-29, 0))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Risk factors: previous dropout, <90 days previous treatment; protective: previous PSU!!!!, previous treatments")

i4d <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ treatment.lag+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc_multtr,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2", "treatment"),
      maxfu= maxfu_multtr_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(1,1,0,1,1,1,1),# 
      #formulanull= Surv(time.lag,time,event)~ 1,
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i4d$m
broom::tidy(i4d$m)

i4d_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", 
"treatment.lag"), estimate = c(0.132485185827427, 0.00411115497188839, 
0.481109354943001, 0.58947698342646, 0.105500181664414, -1.34747522983601
), std.error = c(0.0190393190327229, 0.0318822421857093, 0.0313896070698578, 
0.0145276202543287, 0.0192443206789934, 0.0166349222671111), 
    robust.se = c(0.0162768310200937, 0.0256183384356621, 0.0259237137593143, 
    0.0149119908677786, 0.0180095159064235, 0.0322392535580045
    ), statistic = c(8.13949506902635, 0.160477034145409, 18.5586586632535, 
    39.5304013161775, 5.85802429185703, -41.7961050931792), p.value = c(3.96929765929241e-16, 
    0.87250531125718, 6.94162601178333e-77, 0, 4.68406148676732e-09, 
    0))%>%
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Razonable: abandono previo, compromiso severo previo, menos de 90 días y policonsumo previo son predictores de readmisiones; no así el recuento de tratamientos (esto con lag 1's)")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_


summary(i4c$iiw.weight)
# Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# 0.19     0.19     0.86     4.91     1.13 49631.97 

ploti4c<-
ggplot( data= as.data.frame(i4c$iiw.weight),aes(x= `i4c$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)
invisible("highly extreme values")


summary(i4d$iiw.weight)
#  Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
# 0.130     0.130     0.210     1.516     0.378 18179.444 

ploti4d<-
ggplot( data= as.data.frame(i4d$iiw.weight),aes(x= `i4d$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)
invisible(" highly extreme values")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i5 <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ policonsumo2+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_df,#12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= rep(0,6),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i5$m
broom::tidy(i5$m)

i5_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", 
"policonsumo2"), estimate = c(-0.285082046756843, -0.916585948362177, 
-0.795077921451114, 0.11763808302626, -0.569791427138684, 0.164345823420033
), std.error = c(0.01492765131367, 0.0178053744947168, 0.0186611556090444, 
0.0176615698524595, 0.0157351197601704, 0.00773975706029995), 
    robust.se = c(0.0179877493992649, 0.0223101496182252, 0.0236349676291152, 
    0.0202282450263194, 0.0186724156095066, 0.00757289335696934
    ), statistic = c(-15.8486779212352, -41.0838100168282, -33.639898895892, 
    5.81553579528025, -30.5151427139716, 21.7018536605676), p.value = c(1.43569566146437e-56, 
    0, 4.38118085650704e-248, 6.04399775632908e-09, 1.64100047755937e-204, 
    1.97056906465211e-104))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Previous dropout protects posterior dropout, but 95% CI does not replicate that; 2024-04-16= protects from being observed and 95% cis too")
invisible("Moderate previous biopsychosocial status protects actual dropout")
invisible("Severe previous biopsychosocial status protects actual dropout")
invisible("0-90 days in previous tr. predicts actual dropout")
invisible("previous PSU protects actual dropout")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i5$iiw.weight)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.7543  1.0000  1.0000  1.5863  1.0000  5.8794 
 
ploti5<-
ggplot( data= as.data.frame(i5$iiw.weight),aes(x= `i5$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)
invisible("Reasonable, but still there are some bit extreme values")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

i5b <- iiw.weights(
  Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y2_moderate.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ policonsumo2.lag+ policonsumo2+
  cluster(id),
      id= "id",
      time= "time",
      event= "event",
      data= data_mine_miss_proc,
      invariant= "id",
      lagvars= c("time", "tr_outcome", "comp_bpsc_y2_moderate", "comp_bpsc_y3_severe", "less_90d_tr1","policonsumo2"),
      maxfu= maxfu_df,# 12*12,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
      lagfirst= c(1,1,0,1,1,1,1),
      first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
      )

i5b$m
broom::tidy(i5b$m)

i5b_df_out<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y2_moderate.lag", 
"comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", 
"policonsumo2"), estimate = c(0.171524496903936, 0.00483620529764353, 
0.596008396206245, 0.855542927694904, 0.125702439454889, 0.0627347379496959
), std.error = c(0.018874296525738, 0.0318585598048639, 0.0309630894506515, 
0.0128979749956164, 0.0189962053653323, 0.00782722711322035), 
    robust.se = c(0.0179913060388931, 0.0292985300929012, 0.0290119903127091, 
    0.0144451828760062, 0.020549409265887, 0.00759613906581795
    ), statistic = c(9.53374349439331, 0.165066482253842, 20.543519757938, 
    59.2268671873984, 6.11708287223425, 8.2587663819897), p.value = c(1.51711569984396e-21, 
    0.868891654364147, 8.79518334988573e-94, 0, 9.53038111046381e-10, 
    1.47185680747056e-16))%>% 
  dplyr::mutate(lo_95ci= estimate- 1.96 * robust.se) %>% 
  dplyr::mutate(up_95ci= estimate+ 1.96 * robust.se) %>% 
  dplyr::mutate(HR= estimate) %>% 
  dplyr::mutate_at(c("HR","lo_95ci","up_95ci"),~exp(.))

invisible("Previous dropout now predicts actual dropout")
invisible("Moderate previous biopsychosocial status predict actual dropout")
invisible("Severe previous biopsychosocial status predict actual dropout")
invisible("0-90 days in previous tr. predicts actual dropout")
invisible("previous PSU protects actual dropout")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

summary(i5b$iiw.weight)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.1634  1.0000  1.0000  0.9055  1.0000  1.0000 
 
invisible("Many low values")


ploti5b<-
ggplot( data= as.data.frame(i5b$iiw.weight),aes(x= `i5b$iiw.weight`))+
    geom_histogram(bins=60)+
  theme_classic()+ xlim(0,10)
invisible("Reasonable, but still there are some bit extreme values")

```

::: center-table
```{r irrelong-3-1-iiw-weights-output-coefs, warning=FALSE, echo=T, error=F, eval=T, results="hold"}

iiw_coefs_df<-
dplyr::bind_rows(
  cbind.data.frame(w= "i0", i0_df_out),
  cbind.data.frame(w= "i0b", i0b_df_out),
  cbind.data.frame(w= "i0c", i0c_df_out),
  cbind.data.frame(w= "i0d", i0d_df_out),
  cbind.data.frame(w= "i1", i1_df_out),
  cbind.data.frame(w= "i1b", i1b_df_out),
  cbind.data.frame(w= "i1c", i1c_df_out),
  cbind.data.frame(w= "i1d", i1d_df_out),
  cbind.data.frame(w= "i2", i2_df_out),
  cbind.data.frame(w= "i3", i3_df_out),
  cbind.data.frame(w= "i3b", i3b_df_out),
  cbind.data.frame(w= "i4", i4_df_out),
  cbind.data.frame(w= "i4b", i4b_df_out),
  cbind.data.frame(w= "i4c", i4c_df_out),
  cbind.data.frame(w= "i4d", i4d_df_out),
  cbind.data.frame(w= "i5", i5_df_out),
  cbind.data.frame(w= "i5b", i5b_df_out)
) %>% dplyr::select(w, term, HR, lo_95ci, up_95ci, p.value)

iiw_coefs_df %>% 
   dplyr::mutate_at(c("HR", "lo_95ci", "up_95ci"), ~ sprintf("%1.2f",.)) %>% 
  dplyr::mutate_at(c("p.value"), ~ ifelse(.<.001,"<0.001",sprintf("%1.3f",.))) %>% 
  { 
    write.table(., file= paste0(getwd(),"/_proposal_grant/2023/iiws_coefs_24_04_18.csv"), dec=",", sep="\t")
    knitr::kable(., size=10, format="markdown",caption= "Different weights, coefficients", escape=T)
  }
```
:::

::: center-table
```{r irrelong-3-2-iiw-weights-output-iiws, warning=FALSE, echo=T, error=F, eval=T, results="hold"}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

iiw_df<-
dplyr::bind_rows(
  cbind.data.frame(w= "i0", iiw=i0$iiw.weight),
  cbind.data.frame(w= "i0b", iiw=i0b$iiw.weight),
  cbind.data.frame(w= "i0c", iiw=i0c$iiw.weight),
  cbind.data.frame(w= "i0d", iiw=i0d$iiw.weight),
  cbind.data.frame(w= "i1", iiw=i1$iiw.weight),
  cbind.data.frame(w= "i1b", iiw=i1b$iiw.weight),
  cbind.data.frame(w= "i1c", iiw=i1c$iiw.weight),
  cbind.data.frame(w= "i1d", iiw=i1d$iiw.weight),
  cbind.data.frame(w= "i2", iiw=i2$iiw.weight),
  cbind.data.frame(w= "i3", iiw=i3$iiw.weight),
  cbind.data.frame(w= "i3b", iiw=i3b$iiw.weight),
  cbind.data.frame(w= "i4", iiw=i4$iiw.weight),
  cbind.data.frame(w= "i4b", iiw=i4b$iiw.weight),
  cbind.data.frame(w= "i4c", iiw=i4c$iiw.weight),
  cbind.data.frame(w= "i4d", iiw=i4d$iiw.weight),
  cbind.data.frame(w= "i5", iiw=i5$iiw.weight),
  cbind.data.frame(w= "i5b", iiw=i5b$iiw.weight)
)

psych::describeBy(iiw~w, data=iiw_df, mat=T) %>% 
   { 
     write.table(., file = paste0(getwd(),"/_proposal_grant/2023/iiws_24_04_18.csv"), dec=",", sep="\t")
     knitr::kable(., size=10, format="markdown",caption= "Different weights, summary descriptives", escape=T)
   }
```
:::

```{r irrelong-3-3-iiw-output-plot, warning=FALSE, echo=T, error=F, eval=T}
library(cowplot)

combined_plot <- plot_grid(ploti0, ploti0b, ploti0c, ploti0d, ploti1, ploti1b, ploti1c, ploti1d, ploti2, ploti3, ploti3b, ploti4, ploti4b, ploti4c, ploti4d, ploti5, ploti5b, ncol = 1, align = 'v', axis = 'tb')

print(combined_plot)

ggsave(combined_plot, file="_proposal_grant/2023/_figs/comb_plot_24_04_18.jpg", width=8.5, height=15.5, dpi=500)
```

```{r irrelong-3-3-iiw-save, warning=FALSE, echo=T, error=F, eval=T}
folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
save.image(paste0(folder_path,"20240430_avance_iiw.RData"))
```


We included several covariates in the model, such as PSU (`policonsumo2`), previous treatment completion status (if any,  `event.lag`), previous biopsychosocial status (if any, `lag(compromiso_biopsicosocial.y)`), sex (`sex`), age of onset of substance use (`edad_ini_cons`), educational attainment (`escolaridad_rec`), primary substance at admission to treatment (`sus_principal_mod`), frequency of primary substance (`freq_cons_sus_prin_ord`), occupational status (`condicion_ocupacional_corr24`), number of children (binary, `num_hijos_mod_joel_bin`), housing tenure status (`tenencia_de_la_vivienda_mod`), administrative macro-zone of municipality of residence (`macrozona`), psychiatric co-morbidity (ICD-10, `dg_cie_10_rec`), SUD severity diagnosis (ICD-10, `dg_trs_cons_sus_or`), rurality status of municipality of residence (`clas_r`), poverty index of municipality  of residence (`porc_pobr`), starting substance used (`sus_ini_mod_mvv`), corrected year of birth (`ano_nac_corr`), and cohabitation status (who the individual lives with, `con_quien_vive_joel`). These covariates are used to adjust for potential confounding factors that may affect the survival outcome.

We provisionally selected `i4d` (not only events; dichotomous transformation of previous biopsychosocial compromise, previous time in treatment (0-90 vs. >90), previous PSU and treatment counts). However, Lokku et al., does not recommend including treatment counts. So we ended selecting  `i1` : Not only events; dichotomous transformation of previous biopsychosocial compromise, previous time in treatment (0-90 vs. >90), previous PSU and lag first 1s; without treatment count.

<br>

#### Definitive model

To account for the dynamic relationship between time since follow-up, we included terms for time elapsed from the first treatment.

```{r irrelong-3-iiw-weights-integrated, warning=FALSE, echo=T, error=F, eval=T}

invisible("2024-04-17: data_mine2_miss_proc2 not needed, data_mine_miss_proc2 instead (no longer needed to select events==1 [only with visits], because we already selected them)")

data_mine_miss_proc2 <-
dplyr::mutate(group_by(data_mine_miss_proc, hash_key), lag_tr_outcome= lag(tr_outcome, default=1), lag_comp_bpsc_y2_moderate= lag(comp_bpsc_y2_moderate, default=0), lag_comp_bpsc_y3_severe= lag(comp_bpsc_y3_severe, default=1), lag_fech_egres_num= lag(fech_egres_num), lag_less_90d_tr1= lag(less_90d_tr1, default=1), lag_policonsumo2= lag(policonsumo2, default=1), lag_dias_treat_imp_sin_na= lag(dias_treat_imp_sin_na)) %>% dplyr::ungroup()%>% 
    dplyr::mutate(log_lag_dias_treat_imp_sin_na= log(lag_dias_treat_imp_sin_na+0.001), log_dias_treat_imp_sin_na= log(dias_treat_imp_sin_na+0.001), esc_dum_rec_3prim = ifelse(as.character(escolaridad_rec)=="3-Completed primary school or less",1,0), esc_dum_rec_2high = ifelse(as.character(escolaridad_rec)== "2-Completed high school or less", 1, 0), susprindum_oh = ifelse(as.character(sus_principal_mod)== "Alcohol", 1, 0), susprindum_coc = ifelse(as.character(sus_principal_mod)== "Cocaine hydrochloride", 1, 0), susprindum_pbc = ifelse(as.character(sus_principal_mod)== "Cocaine paste", 1, 0), susprindum_mar = ifelse(as.character(sus_principal_mod)== "Marijuana", 1, 0), freq_cons_dum_5day= ifelse(as.character(freq_cons_sus_prin_ord)== "5. Daily", 1, 0), freq_cons_dum_44to6wk= ifelse(as.character(freq_cons_sus_prin_ord)== "4. 4 to 6 days a week", 1, 0), freq_cons_dum_32to3wk= ifelse(as.character(freq_cons_sus_prin_ord)== "3. 2 to 3 days a week", 1, 0), freq_cons_dum_21wkmore= ifelse(as.character(freq_cons_sus_prin_ord)== "2. 1 day a week or more", 1, 0), cond_oc_dum_3unemp= ifelse(as.character(condicion_ocupacional_corr24)== "Unemployed", 1, 0), cond_oc_dum_2inact= ifelse(as.character(condicion_ocupacional_corr24)== "Inactive", 1, 0), viv_dum_illegal= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Illegal Settlement", 1, 0), viv_dum_own= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Owner/Transferred dwellings/Pays Dividends", 1, 0), viv_dum_rent= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Renting", 1, 0), viv_dum_temp= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Stays temporarily with a relative", 1, 0), macro_dum_south= ifelse(as.character(macrozona)== "South", 1, 0), macro_dum_north= ifelse(as.character(macrozona)== "North", 1, 0), psycom_dum_with= ifelse(as.character(dg_cie_10_rec)== "With psychiatric comorbidity", 1, 0), psycom_dum_study= ifelse(as.character(dg_cie_10_rec)== "Diagnosis unknown (under study)", 1, 0), psycom_dum_study= ifelse(as.character(dg_cie_10_rec)== "Diagnosis unknown (under study)", 1, 0), rurality_rural= ifelse(as.character(clas_r)== "Rural", 1, 0), rurality_mix= ifelse(as.character(clas_r)== "Mixed", 1, 0), susinidum_oh = ifelse(as.character(sus_ini_mod_mvv)== "Alcohol", 1, 0), susinidum_coc = ifelse(as.character(sus_ini_mod_mvv)== "Cocaine hydrochloride", 1, 0), susinidum_pbc = ifelse(as.character(sus_ini_mod_mvv)== "Cocaine paste", 1, 0), susinidum_mar = ifelse(as.character(sus_ini_mod_mvv)== "Marijuana", 1, 0), cohab_dum_alone = ifelse(as.character(con_quien_vive_joel)== "Alone", 1, 0), cohab_dum_fam_or = ifelse(as.character(con_quien_vive_joel)== "Family of origin", 1, 0), cohab_dum_cpl_child = ifelse(as.character(con_quien_vive_joel)== "With couple/children", 1, 0), surv_time= ifelse(surv_time<0.001, 0.0001, surv_time)) %>% data.frame() 


invisible("2024-05-02: problem with different values in people with plans (possibly imputed)")

data_mine_miss_restr_proc2 <-
dplyr::mutate(group_by(data_mine_miss_restr_proc, hash_key), lag_tr_outcome= lag(tr_outcome, default=1), lag_comp_bpsc_y2_moderate= lag(comp_bpsc_y2_moderate, default=0), lag_comp_bpsc_y3_severe= lag(comp_bpsc_y3_severe, default=1), lag_fech_egres_num= lag(fech_egres_num), lag_less_90d_tr1= lag(less_90d_tr1, default=1), lag_policonsumo2= lag(policonsumo2, default=1), lag_dias_treat_imp_sin_na= lag(dias_treat_imp_sin_na)) %>% dplyr::ungroup()%>% 
    dplyr::mutate(log_lag_dias_treat_imp_sin_na= log(lag_dias_treat_imp_sin_na+0.001), log_dias_treat_imp_sin_na= log(dias_treat_imp_sin_na+0.001), esc_dum_rec_3prim = ifelse(as.character(escolaridad_rec)=="3-Completed primary school or less",1,0), esc_dum_rec_2high = ifelse(as.character(escolaridad_rec)== "2-Completed high school or less", 1, 0), susprindum_oh = ifelse(as.character(sus_principal_mod)== "Alcohol", 1, 0), susprindum_coc = ifelse(as.character(sus_principal_mod)== "Cocaine hydrochloride", 1, 0), susprindum_pbc = ifelse(as.character(sus_principal_mod)== "Cocaine paste", 1, 0), susprindum_mar = ifelse(as.character(sus_principal_mod)== "Marijuana", 1, 0), freq_cons_dum_5day= ifelse(as.character(freq_cons_sus_prin_ord)== "5. Daily", 1, 0), freq_cons_dum_44to6wk= ifelse(as.character(freq_cons_sus_prin_ord)== "4. 4 to 6 days a week", 1, 0), freq_cons_dum_32to3wk= ifelse(as.character(freq_cons_sus_prin_ord)== "3. 2 to 3 days a week", 1, 0), freq_cons_dum_21wkmore= ifelse(as.character(freq_cons_sus_prin_ord)== "2. 1 day a week or more", 1, 0), cond_oc_dum_3unemp= ifelse(as.character(condicion_ocupacional_corr24)== "Unemployed", 1, 0), cond_oc_dum_2inact= ifelse(as.character(condicion_ocupacional_corr24)== "Inactive", 1, 0), viv_dum_illegal= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Illegal Settlement", 1, 0), viv_dum_own= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Owner/Transferred dwellings/Pays Dividends", 1, 0), viv_dum_rent= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Renting", 1, 0), viv_dum_temp= ifelse(as.character(tenencia_de_la_vivienda_mod)== "Stays temporarily with a relative", 1, 0), macro_dum_south= ifelse(as.character(macrozona)== "South", 1, 0), macro_dum_north= ifelse(as.character(macrozona)== "North", 1, 0), psycom_dum_with= ifelse(as.character(dg_cie_10_rec)== "With psychiatric comorbidity", 1, 0), psycom_dum_study= ifelse(as.character(dg_cie_10_rec)== "Diagnosis unknown (under study)", 1, 0), psycom_dum_study= ifelse(as.character(dg_cie_10_rec)== "Diagnosis unknown (under study)", 1, 0), rurality_rural= ifelse(as.character(clas_r)== "Rural", 1, 0), rurality_mix= ifelse(as.character(clas_r)== "Mixed", 1, 0), susinidum_oh = ifelse(as.character(sus_ini_mod_mvv)== "Alcohol", 1, 0), susinidum_coc = ifelse(as.character(sus_ini_mod_mvv)== "Cocaine hydrochloride", 1, 0), susinidum_pbc = ifelse(as.character(sus_ini_mod_mvv)== "Cocaine paste", 1, 0), susinidum_mar = ifelse(as.character(sus_ini_mod_mvv)== "Marijuana", 1, 0), cohab_dum_alone = ifelse(as.character(con_quien_vive_joel)== "Alone", 1, 0), cohab_dum_fam_or = ifelse(as.character(con_quien_vive_joel)== "Family of origin", 1, 0), cohab_dum_cpl_child = ifelse(as.character(con_quien_vive_joel)== "With couple/children", 1, 0), surv_time= ifelse(surv_time<0.001, 0.0001, surv_time)) %>% 
 dplyr::group_by(id) %>% 
 dplyr::mutate(tipo_de_plan_2_mod=first(tipo_de_plan_2_mod)) %>% 
 dplyr::ungroup() %>% 
data.frame() 


dis_run_w_more_type_plan<-
data_mine_miss_restr_proc2 %>% 
    dplyr::group_by(id) %>% 
    dplyr::summarise(count_n_dis=n_distinct(tipo_de_plan_2_mod)) %>% 
    dplyr::filter(count_n_dis>1) %>% distinct(id)
# data_mine_miss_restr_proc2 %>% 
# dplyr::group_by(id) %>% 
# dplyr::mutate(tipo_de_plan_2_mod=first(tipo_de_plan_2_mod)) %>% 
# dplyr::ungroup() %>% 
# dplyr::filter(id  %in% dis_run_w_more_type_plan$id)

invisible("export to python")
arrow::write_parquet(data_mine_miss_proc2 %>% dplyr::mutate(lag_time=ifelse(is.na(lag_time),0,lag_time)), 
                     "_proposal_grant/2023/data_mine_miss_proc2_20240417.gz.parquet", 
                     compression = "gzip", compression_level = 5)
arrow::write_parquet(data_mine_miss_restr_proc2 %>% dplyr::mutate(lag_time=ifelse(is.na(lag_time),0,lag_time)), 
                     "_proposal_grant/2023/data_mine_miss_restr_proc2_20240427.gz.parquet", 
                     compression = "gzip", compression_level = 5)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Explore residuals")
coxph(Surv(lag_time,time,event)~ lag_tr_outcome+ lag_comp_bpsc_y3_severe+ lag_less_90d_tr1+ log_lag_dias_treat_imp_sin_na+ lag_policonsumo2+ edad_al_ing_1+ ano_nac_corr+ cluster(id)+ strata(tipo_de_plan_2), data = data_mine_miss_proc2)
#                                    coef exp(coef)  se(coef) robust se      z        p
# lag_tr_outcome                 0.139016  1.149142  0.019531  0.017338  8.018 1.07e-15
# lag_comp_bpsc_y3_severe        0.129501  1.138261  0.015740  0.015006  8.630  < 2e-16
# lag_less_90d_tr1               0.119756  1.127222  0.021016  0.023976  4.995 5.89e-07
# log_lag_dias_treat_imp_sin_na -0.027876  0.972509  0.007595  0.010510 -2.652    0.008
# lag_policonsumo2              -0.010438  0.989616  0.020266  0.018185 -0.574    0.566
# edad_al_ing_1                  0.232959  1.262330  0.004099  0.003827 60.870  < 2e-16
# ano_nac_corr                   0.236313  1.266571  0.004070  0.003788 62.377  < 2e-16


coxph(Surv(lag_time,time,event)~ lag_tr_outcome+ lag_comp_bpsc_y3_severe+ lag_less_90d_tr1+ log_lag_dias_treat_imp_sin_na+ lag_policonsumo2+ edad_al_ing_1+ ano_nac_corr+ cluster(id)+ strata(tipo_de_plan_2), data = data_mine_miss_restr_proc2)
#                                 coef exp(coef) se(coef) robust se    z      p
# lag_tr_outcome                 0.139     1.149    0.020     0.017  8.0  1e-15
# lag_comp_bpsc_y3_severe        0.128     1.137    0.016     0.015  8.6 <2e-16
# lag_less_90d_tr1               0.120     1.128    0.021     0.024  5.0  5e-07
# log_lag_dias_treat_imp_sin_na -0.028     0.972    0.008     0.011 -2.7  0.008
# lag_policonsumo2              -0.010     0.990    0.020     0.018 -0.6  0.574
# edad_al_ing_1                  0.233     1.262    0.004     0.004 60.9 <2e-16
# ano_nac_corr                   0.236     1.267    0.004     0.004 62.4 <2e-16

cox.zph(
  coxph(Surv(lag_time,time,event)~ lag_tr_outcome+ lag_comp_bpsc_y3_severe+ lag_less_90d_tr1+ log_lag_dias_treat_imp_sin_na+ lag_policonsumo2+ edad_al_ing_1+ ano_nac_corr+ cluster(id)+ strata(tipo_de_plan_2), data= data_mine_miss_proc2)
)
#                                chisq df       p
# lag_tr_outcome                 37.98  1 7.1e-10
# lag_comp_bpsc_y3_severe        61.87  1 3.7e-15
# lag_less_90d_tr1              147.28  1 < 2e-16
# log_lag_dias_treat_imp_sin_na 178.13  1 < 2e-16
# lag_policonsumo2               13.18  1 0.00028
# edad_al_ing_1                  35.57  1 2.5e-09
# ano_nac_corr                    8.73  1 0.00312
# GLOBAL                        521.92  7 < 2e-16


cox.zph(
  coxph(Surv(lag_time,time,event)~ lag_tr_outcome+ lag_comp_bpsc_y3_severe+ lag_less_90d_tr1+ log_lag_dias_treat_imp_sin_na+ lag_policonsumo2+ edad_al_ing_1+ ano_nac_corr+ cluster(id)+ strata(tipo_de_plan_2), data= data_mine_miss_restr_proc2)
)
#                                chisq df       p
# lag_tr_outcome                 37.95  1 7.3e-10
# lag_comp_bpsc_y3_severe        57.93  1 2.7e-14
# lag_less_90d_tr1              147.25  1 < 2e-16
# log_lag_dias_treat_imp_sin_na 178.15  1 < 2e-16
# lag_policonsumo2               13.21  1 0.00028
# edad_al_ing_1                  35.50  1 2.6e-09
# ano_nac_corr                    8.71  1 0.00317
# GLOBAL                        519.01  7 < 2e-16

invisible("Tiene mejor ajuste que las alternativas sólo con días de tto. continuos (log) o el dicotomizado solo:  186751.2 vs. 186756.6 vs. 186779.1; 2024-04-21: 261769.5 el actual sin moderado 262293.3, vs. mucho menos cuando intento agregar términos. Pero lo haré dirigido por la teoría")

cox.zph(
  coxph(Surv(lag_time,time,event)~ lag_tr_outcome+ lag_comp_bpsc_y3_severe+ lag_less_90d_tr1+ log_lag_dias_treat_imp_sin_na+ lag_policonsumo2+ edad_al_ing_1+ ano_nac_corr+ cluster(id)+ strata(tipo_de_plan_2_mod), data= data_mine_miss_restr_proc2)
)
#                                chisq df       p
# lag_tr_outcome                 54.66  1 1.4e-13
# lag_comp_bpsc_y3_severe        19.67  1 9.2e-06
# lag_less_90d_tr1              130.48  1 < 2e-16
# log_lag_dias_treat_imp_sin_na 141.52  1 < 2e-16
# lag_policonsumo2                9.72  1  0.0018
# edad_al_ing_1                  33.47  1 7.2e-09
# ano_nac_corr                    7.88  1  0.0050
# GLOBAL                        459.34  7 < 2e-16

final <- iiw.weights(
   Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ log_dias_treat_imp_sin_na.lag+ policonsumo2.lag+ edad_al_ing_1+ ano_nac_corr+ 
        cluster(hash_key),
    id= "id",
    time= "time",
    event= "event",
    data= data_mine_miss_proc2,
    invariant= c("id", "edad_al_ing_1", "ano_nac_corr"),
    lagvars= c("time", "tr_outcome", "comp_bpsc_y3_severe", "less_90d_tr1", "log_dias_treat_imp_sin_na","policonsumo2"),
    maxfu= maxfu_df,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
    lagfirst= c(2.95082,1,1,1,4.499811,1), #90/30.5 4.499811 es 90 días
    first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
)

final_restr <- iiw.weights(
   Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ log_dias_treat_imp_sin_na.lag+ policonsumo2.lag+ edad_al_ing_1+ ano_nac_corr+ 
        cluster(hash_key),
    id= "id",
    time= "time",
    event= "event",
    data= data_mine_miss_restr_proc2,
    invariant= c("id", "edad_al_ing_1", "ano_nac_corr"),
    lagvars= c("time", "tr_outcome", "comp_bpsc_y3_severe", "less_90d_tr1", "log_dias_treat_imp_sin_na","policonsumo2"),
    maxfu= maxfu_restr_df,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
    lagfirst= c(2.95082,1,1,1,4.499811,1), #90/30.5 4.499811 es 90 días
    first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
)

final_b <- iiw.weights(
   Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ log_dias_treat_imp_sin_na.lag+ policonsumo2.lag+ edad_al_ing_1+ ano_nac_corr+ 
        cluster(hash_key),
    id= "id",
    time= "time",
    event= "event",
    data= data_mine_miss_proc2,
    invariant= c("id", "edad_al_ing_1", "ano_nac_corr"),
    lagvars= c("time", "tr_outcome", "comp_bpsc_y3_severe", "less_90d_tr1", "log_dias_treat_imp_sin_na","policonsumo2"),
    maxfu= maxfu_df,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
    lagfirst= c(2.95082,0,0,0,4.499811/2,0), #90/30.5 4.499811 es 90 días
    first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
)

final_restr_b <- iiw.weights(
   Surv(time.lag,time,event)~ tr_outcome.lag+ comp_bpsc_y3_severe.lag+ less_90d_tr1.lag+ log_dias_treat_imp_sin_na.lag+ policonsumo2.lag+ edad_al_ing_1+ ano_nac_corr+ 
        cluster(hash_key),
    id= "id",
    time= "time",
    event= "event",
    data= data_mine_miss_restr_proc2,
    invariant= c("id", "edad_al_ing_1", "ano_nac_corr"),
    lagvars= c("time", "tr_outcome", "comp_bpsc_y3_severe", "less_90d_tr1", "log_dias_treat_imp_sin_na","policonsumo2"),
    maxfu= maxfu_restr_df,#Base_fiscalia_v15f_grant_23_24_long2$cens_time,
    lagfirst= c(2.95082,0,0,0,4.499811/2,0), #90/30.5 4.499811 es 90 días
    first= T  #If TRUE, the first observation for each individual is assigned an intensity of 1. This is appropriate if the first visit is a baseline visit at which recruitment to the study occurred
)
# 
broom::tidy(final$m, conf.int=T, exponentiate =T)
#   term                    estimate std.error robust.se statistic  p.value conf.low conf.high
#   <chr>                      <dbl>     <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>
# 1 tr_outcome.lag              1.17   0.0189    0.0172       9.01 2.07e-19     1.13      1.21
# 2 comp_bpsc_y3_severe.lag     1.80   0.0126    0.0130      45.3  0            1.75      1.85
# 3 less_90d_tr1.lag            2.27   0.0130    0.0142      57.6  0            2.21      2.34
# 4 policonsumo2.lag            1.18   0.0189    0.0196       8.30 1.06e-16     1.13      1.22
# 5 edad_al_ing_1               1.09   0.00153   0.00139     60.3  0            1.08      1.09
# 6 ano_nac_corr                1.10   0.00153   0.00138     66.2  0            1.09      1.10

broom::tidy(final_restr$m, conf.int=T, exponentiate =T)
# term                          estimate std.error robust.se statistic   p.value conf.low conf.high
# <chr>                            <dbl>     <dbl>     <dbl>     <dbl>     <dbl>    <dbl>     <dbl>
# tr_outcome.lag                    1.27   0.0196    0.0175      13.7  9.41e- 43     1.23      1.32
# comp_bpsc_y3_severe.lag           1.58   0.0135    0.0130      35.1  5.67e-270     1.54      1.62
# less_90d_tr1.lag                  2.47   0.0198    0.0221      41.0  0             2.37      2.58
# log_dias_treat_imp_sin_na.lag     1.26   0.0109    0.0132      17.6  1.97e- 69     1.23      1.29
# policonsumo2.lag                  1.12   0.0195    0.0179       6.31 2.70e- 10     1.08      1.16
# edad_al_ing_1                     1.15   0.00296   0.00267     53.2  0             1.15      1.16
# ano_nac_corr                      1.15   0.00293   0.00263     54.4  0             1.15      1.16

broom::tidy(final_b$m, conf.int=T, exponentiate =T)
#   term                          estimate std.error robust.se statistic  p.value conf.low conf.high
#   <chr>                            <dbl>     <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>
# 1 tr_outcome.lag                   0.551   0.0133    0.0152     -39.3  0           0.534     0.567
# 2 comp_bpsc_y3_severe.lag          0.866   0.0142    0.0162      -8.88 6.86e-19    0.839     0.894
# 3 less_90d_tr1.lag                 0.904   0.0184    0.0263      -3.83 1.31e- 4    0.859     0.952
# 4 log_dias_treat_imp_sin_na.lag    0.873   0.00421   0.0137      -9.86 6.23e-23    0.850     0.897
# 5 policonsumo2.lag                 0.450   0.0135    0.0167     -47.9  0           0.435     0.465
# 6 edad_al_ing_1                    1.07    0.00153   0.00138     51.0  0           1.07      1.08 
# 7 ano_nac_corr                     1.09    0.00152   0.00138     60.0  0           1.08      1.09 
broom::tidy(final_restr_b$m, conf.int=T, exponentiate =T)
# term                          estimate std.error robust.se statistic   p.value conf.low conf.high
# <chr>                            <dbl>     <dbl>     <dbl>     <dbl>     <dbl>    <dbl>     <dbl>
# tr_outcome.lag                   0.603   0.0144    0.0155     -32.6  1.17e-232    0.585     0.621
# comp_bpsc_y3_severe.lag          0.913   0.0144    0.0149      -6.14 8.03e- 10    0.886     0.940
# less_90d_tr1.lag                 0.898   0.0187    0.0249      -4.34 1.45e-  5    0.855     0.943
# log_dias_treat_imp_sin_na.lag    0.887   0.00464   0.0134      -8.92 4.53e- 19    0.864     0.911
# policonsumo2.lag                 0.514   0.0146    0.0163     -40.9  0            0.498     0.530
# edad_al_ing_1                    1.13    0.00291   0.00250     48.1  0            1.12      1.13 
# ano_nac_corr                     1.14    0.00291   0.00249     52.9  0            1.14      1.15 


final_coefs<-
cbind.data.frame(term = c("tr_outcome.lag", "comp_bpsc_y3_severe.lag", "less_90d_tr1.lag", "policonsumo2.lag", "edad_al_ing_1", "ano_nac_corr"), estimate = c(1.1680161176676, 1.79963517024553, 2.2710236051536, 1.17641492065206, 1.08756180792251, 1.09565232375642), std.error = c(0.0188883080181889, 0.0125981011876289, 0.0129873997440068, 0.0189035437658918, 0.00153425515290826, 0.00153498904364182), robust.se = c(0.0172377882900819, 0.0129754816518389, 0.0142405606352216, 0.0195792679568791, 0.00139105857932987, 0.00138071917329718), statistic = c(9.0096641790833, 45.2841734070737, 57.5981998354651, 8.29814532853555, 60.3413245741051, 66.1611116269822), p.value = c(2.06688423909932e-19, 0, 0, 1.05749268471728e-16, 0, 0), conf.low = c(1.12921334955458, 1.75444485412689, 2.20851351433301, 1.13212562626954, 1.0846006909948, 1.09269132170511), conf.high = c(1.20815225189237, 1.84598948115495, 2.33530299076412, 1.22243683335131, 1.09053100912818, 1.09862134960454))

summary(final$iiw)
# 
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   #  0.1     1.0     1.0     0.9     1.0    67.9 

summary(final_restr$iiw)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   # 0.09    0.45    0.85    0.74    1.00   22.04 

invisible("Generar los pesos a asignar")
table(final$iiw, data_mine_miss_proc$treatment) %>% data.frame() %>% dplyr::mutate(Var1=as.numeric(as.character(Var1)), Freq=as.numeric(Freq)) %>% dplyr::arrange(-Freq) %>% dplyr::select(-Var2) %>%  head(20) %>% dput()

df_iiw_final<-
cbind.data.frame(Var1 = c(1, 0.688125981472609, 0.160330998755955, 0.162315144547036, 0.196774517463519, 0.199606787793155, 0.208958220652199, 0.225731677712565, 0.23160770335121, 0.234224555582056, 0.248919669741449, 0.256310292435046, 0.275606737385485, 0.286468644357305, 0.291310136239186, 0.313585733564029, 0.314758256721433, 0.325438651308499, 0.329390866243409, 
0.334785138867613), Freq = c(72404, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2))


invisible("Vemos un ejemplo que los pesos asignados son ABSOLUTAMENTE DISTINTOS DEPENDIENDO DEL MODELO")
cbind.data.frame(mod1= final$iiw, mod2= final_b$iiw) %>%  dplyr::filter(mod1!=mod2) %>% head(20)

diff_in_iiw_final<-
cbind.data.frame(mod1 = c(0.199498133334888, 0.615044327911636, 0.498702140851273, 0.238887400402573, 0.564883027201795, 0.226856508027775, 0.172052897285973, 0.495624040479963, 0.152900128488306, 0.669574361459713, 0.543818575958686, 0.379205064180558, 0.402370920088421, 0.373500499352896, 0.467980694989343, 0.281860985585125, 0.544134768464911, 0.404800245361857, 0.763907890441244, 0.585275800391092), mod2 = c(3.92318595976502, 3.44378094343031, 4.97127471370872, 4.5599185879251, 3.04873855278048, 
3.31979843463701, 6.0865617052278, 5.81549682361537, 4.09528203750446, 3.99883088697191, 1.7257302695626, 3.11919908361139, 3.04433093376514, 4.05407333418453, 2.28706611143663, 2.08872102380155, 8.02426306030948, 8.36617898514813, 6.98296103354168, 1.33559630246317))
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

require(rms)
cox_iiw_proposed<-
rms::cph(Surv(lag_time,time,event)~ 
          cluster(id)+
          lag_tr_outcome+ 
          lag_less_90d_tr1+
          log_lag_dias_treat_imp_sin_na+
          lag_comp_bpsc_y3_severe+ 
          lag_policonsumo2+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          psycom_dum_with+
          psycom_dum_study+ 
          freq_cons_dum_5day+
          cond_oc_dum_2inact+
          cond_oc_dum_3unemp+
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar +
          strat(tipo_de_plan_2_mod), 
          data = data_mine_miss_proc2, 
          x=TRUE, 
          y=TRUE,
          surv= TRUE)
#Must use x=TRUE,y=TRUE to get survival curves with time-dep. covariables
cox_iiw_proposed

# Cox Proportional Hazards Model
# 
# rms::cph(formula = Surv(lag_time, time, event) ~ lag_tr_outcome + 
#     lag_less_90d_tr1 + log_lag_dias_treat_imp_sin_na + lag_comp_bpsc_y3_severe + 
#     lag_policonsumo2 + edad_al_ing_1 + ano_nac_corr + susinidum_oh + 
#     susinidum_coc + susinidum_pbc + susinidum_mar + psycom_dum_with + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar + cluster(id) + strat(tipo_de_plan_2_mod), 
#     data = data_mine_miss_proc2, x = TRUE, y = TRUE, surv = TRUE)
# 
# 
#                                             Status
# Stratum                                      No Event Event
#   tipo_de_plan_2_mod=basic ambulatory               0  5622
#   tipo_de_plan_2_mod=GP intensive ambulatory        0  6501
#   tipo_de_plan_2_mod=GP residential                 0  3034
#   tipo_de_plan_2_mod=WO intensive ambulatory        0  1015
#   tipo_de_plan_2_mod=WO residential                 0  1499
# 
#                           Model Tests       Discrimination    
#                                                    Indexes    
# Obs       17671    LR chi2    3826.50       R2       0.195    
# Events    17671    d.f.            20    R2(20,17671)0.194    
# Center 474.9181    Pr(> chi2)  0.0000       Dxy      0.255    
#                    Score chi2 3855.18                         
#                    Pr(> chi2)  0.0000                         
# 
#                               Coef    S.E.   Wald Z Pr(>|Z|)
# lag_tr_outcome                 0.1545 0.0176  8.76  <0.0001 
# lag_less_90d_tr1               0.1033 0.0242  4.27  <0.0001 
# log_lag_dias_treat_imp_sin_na -0.0222 0.0100 -2.22  0.0263  
# lag_comp_bpsc_y3_severe        0.0584 0.0165  3.54  0.0004  
# lag_policonsumo2              -0.0181 0.0186 -0.97  0.3314  
# edad_al_ing_1                  0.2345 0.0039 60.56  <0.0001 
# ano_nac_corr                   0.2359 0.0038 61.97  <0.0001 
# susinidum_oh                   0.0441 0.0465  0.95  0.3436  
# susinidum_coc                  0.1096 0.0573  1.91  0.0558  
# susinidum_pbc                  0.1586 0.0527  3.01  0.0026  
# susinidum_mar                  0.1589 0.0474  3.35  0.0008  
# psycom_dum_with                0.0174 0.0161  1.08  0.2783  
# psycom_dum_study               0.0304 0.0224  1.36  0.1741  
# freq_cons_dum_5day             0.0135 0.0155  0.87  0.3834  
# cond_oc_dum_2inact             0.0581 0.0214  2.72  0.0066  
# cond_oc_dum_3unemp             0.0621 0.0171  3.63  0.0003  
# susprindum_oh                 -0.1040 0.0626 -1.66  0.0968  
# susprindum_coc                -0.1105 0.0636 -1.74  0.0822  
# susprindum_pbc                -0.0906 0.0622 -1.46  0.1452  
# susprindum_mar                -0.1151 0.0688 -1.67  0.0945 

round(cox.zph(cox_iiw_proposed)$table, 4)
# lag_tr_outcome                 53.1085  1 0.0000 ###
# lag_less_90d_tr1              130.0606  1 0.0000 ###
# log_lag_dias_treat_imp_sin_na 142.4076  1 0.0000 ###
# lag_comp_bpsc_y3_severe        20.3681  1 0.0000 ###
# lag_policonsumo2                8.3301  1 0.0039 #
# edad_al_ing_1                  33.2395  1 0.0000 ###
# ano_nac_corr                    7.7556  1 0.0054 #
# susinidum_oh                   40.0796  1 0.0000 ###
# susinidum_coc                   0.9605  1 0.3271
# susinidum_pbc                   6.6977  1 0.0097
# susinidum_mar                  24.9223  1 0.0000 ###
# psycom_dum_with                16.2090  1 0.0001 ###
# psycom_dum_study               37.2938  1 0.0000 ###
# freq_cons_dum_5day              2.1105  1 0.1463
# cond_oc_dum_2inact              3.1074  1 0.0779
# cond_oc_dum_3unemp             14.3746  1 0.0001 ###
# susprindum_oh                  24.9308  1 0.0000 ###
# susprindum_coc                  0.7316  1 0.3924
# susprindum_pbc                 19.7982  1 0.0000 ###
# susprindum_mar                  2.6082  1 0.1063
# GLOBAL                        495.5153 20 0.0000 

cox_iiw_restr_proposed<-
rms::cph(Surv(lag_time,time,event)~ 
          cluster(id)+ 
          lag_tr_outcome+ 
          lag_less_90d_tr1+
          log_lag_dias_treat_imp_sin_na+
          lag_comp_bpsc_y3_severe+ 
          lag_policonsumo2+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          psycom_dum_with+
          psycom_dum_study+ 
          freq_cons_dum_5day+
          cond_oc_dum_2inact+
          cond_oc_dum_3unemp+
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar +
          strat(tipo_de_plan_2_mod), 
          data = data_mine_miss_restr_proc2, 
          x=TRUE, 
          y=TRUE,
          surv= TRUE)
#Must use x=TRUE,y=TRUE to get survival curves with time-dep. covariables
cox_iiw_restr_proposed
# Cox Proportional Hazards Model
# 
# rms::cph(formula = Surv(lag_time, time, event) ~ lag_tr_outcome + 
#     lag_less_90d_tr1 + log_lag_dias_treat_imp_sin_na + lag_comp_bpsc_y3_severe + 
#     lag_policonsumo2 + edad_al_ing_1 + ano_nac_corr + susinidum_oh + 
#     susinidum_coc + susinidum_pbc + susinidum_mar + psycom_dum_with + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar + cluster(id) + strat(tipo_de_plan_2_mod), 
#     data = data_mine_miss_restr_proc2, x = TRUE, y = TRUE, surv = TRUE)
# 
# 
#                                             Status
# Stratum                                      No Event Event
#   tipo_de_plan_2_mod=basic ambulatory               0  5622
#   tipo_de_plan_2_mod=GP intensive ambulatory        0  6501
#   tipo_de_plan_2_mod=GP residential                 0  3034
#   tipo_de_plan_2_mod=WO intensive ambulatory        0  1015
#   tipo_de_plan_2_mod=WO residential                 0  1499
# 
#                           Model Tests       Discrimination    
#                                                    Indexes    
# Obs       17671    LR chi2    3826.50       R2       0.195    
# Events    17671    d.f.            20    R2(20,17671)0.194    
# Center 474.9181    Pr(> chi2)  0.0000       Dxy      0.255    
#                    Score chi2 3855.18                         
#                    Pr(> chi2)  0.0000                         
# 
#                               Coef    S.E.   Wald Z Pr(>|Z|)
# lag_tr_outcome                 0.1545 0.0176  8.76  <0.0001 
# lag_less_90d_tr1               0.1033 0.0242  4.27  <0.0001 
# log_lag_dias_treat_imp_sin_na -0.0222 0.0100 -2.22  0.0263  
# lag_comp_bpsc_y3_severe        0.0584 0.0165  3.54  0.0004  
# lag_policonsumo2              -0.0181 0.0186 -0.97  0.3314  
# edad_al_ing_1                  0.2345 0.0039 60.56  <0.0001 
# ano_nac_corr                   0.2359 0.0038 61.97  <0.0001 
# susinidum_oh                   0.0441 0.0465  0.95  0.3436  
# susinidum_coc                  0.1096 0.0573  1.91  0.0558  
# susinidum_pbc                  0.1586 0.0527  3.01  0.0026  
# susinidum_mar                  0.1589 0.0474  3.35  0.0008  
# psycom_dum_with                0.0174 0.0161  1.08  0.2783  
# psycom_dum_study               0.0304 0.0224  1.36  0.1741  
# freq_cons_dum_5day             0.0135 0.0155  0.87  0.3834  
# cond_oc_dum_2inact             0.0581 0.0214  2.72  0.0066  
# cond_oc_dum_3unemp             0.0621 0.0171  3.63  0.0003  
# susprindum_oh                 -0.1040 0.0626 -1.66  0.0968  
# susprindum_coc                -0.1105 0.0636 -1.74  0.0822  
# susprindum_pbc                -0.0906 0.0622 -1.46  0.1452  
# susprindum_mar                -0.1151 0.0688 -1.67  0.0945  
cox.zph(cox_iiw_restr_proposed)
#                                 chisq df       p
# lag_tr_outcome                 53.109  1 3.2e-13
# lag_less_90d_tr1              130.061  1 < 2e-16
# log_lag_dias_treat_imp_sin_na 142.408  1 < 2e-16
# lag_comp_bpsc_y3_severe        20.368  1 6.4e-06
# lag_policonsumo2                8.330  1 0.00390
# edad_al_ing_1                  33.239  1 8.1e-09
# ano_nac_corr                    7.756  1 0.00535
# susinidum_oh                   40.080  1 2.4e-10
# susinidum_coc                   0.961  1 0.32706
# susinidum_pbc                   6.698  1 0.00965
# susinidum_mar                  24.922  1 6.0e-07
# psycom_dum_with                16.209  1 5.7e-05
# psycom_dum_study               37.294  1 1.0e-09
# freq_cons_dum_5day              2.110  1 0.14630
# cond_oc_dum_2inact              3.107  1 0.07794
# cond_oc_dum_3unemp             14.375  1 0.00015
# susprindum_oh                  24.931  1 5.9e-07
# susprindum_coc                  0.732  1 0.39237
# susprindum_pbc                 19.798  1 8.6e-06
# susprindum_mar                  2.608  1 0.10631
# GLOBAL                        495.515 20 < 2e-16

invisible("552.545, schoenfeld residuals; now, 496")

res <- resid(cox_iiw_proposed, "scaledsch")
time <- as.numeric(dimnames(res)[[1]])


folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
jpeg(filename = paste0(folder_path,"zph/schoefeld_res_all_variables_240421.jpg"), width = 8, height = 6, units = "in", res = 600, quality = 600)#Users/CISS Fondecyt/
par(mfrow = c(3, 3)) 

z2 <- loess(res[,"lag_tr_outcome"] ~ time, span=0.50)   # residuals 
plot(time, fitted(z2))
lines(supsmu(time, res[,"lag_tr_outcome"]),lty=2)
title("Sch. res., lag_tr_outcome")

z3 <- loess(res[,"lag_less_90d_tr1"] ~ time, span=0.50)   # residual
plot(time, fitted(z3))
lines(supsmu(time, res[,"lag_less_90d_tr1"]),lty=2)
title("Sch. res., lag_less_90d_tr1")

z4 <- loess(res[,"log_lag_dias_treat_imp_sin_na"] ~ time, span=0.50)   # residuals
plot(time, fitted(z4))
lines(supsmu(time, res[,"log_lag_dias_treat_imp_sin_na"]),lty=2)
title("Sch. res., log_lag_dias_treat_imp_sin_na")

z5 <- loess(res[,"lag_comp_bpsc_y3_severe"] ~ time, span=0.50)   # residuals
plot(time, fitted(z5))
lines(supsmu(time, res[,"lag_comp_bpsc_y3_severe"]),lty=2)
title("Sch. res., lag_comp_bpsc_y3_severe")

z6 <- loess(res[,"lag_policonsumo2"] ~ time, span=0.50)   # residuals
plot(time, fitted(z6))
lines(supsmu(time, res[,"lag_policonsumo2"]),lty=2)
title("Sch. res., lag_policonsumo2")

z7 <- loess(res[,"edad_al_ing_1"] ~ time, span=0.50)   # residuals
plot(time, fitted(z7))
lines(supsmu(time, res[,"edad_al_ing_1"]),lty=2)
title("Sch. res., edad_al_ing_1")

z8 <- loess(res[,"susinidum_oh"] ~ time, span=0.50)   # residuals 
plot(time, fitted(z8))
lines(supsmu(time, res[,"susinidum_oh"]),lty=2)
title("Sch. res., susinidum_oh")

z9 <- loess(res[,"psycom_dum_study"] ~ time, span=0.50)   # residuals
plot(time, fitted(z9))
lines(supsmu(time, res[,"psycom_dum_study"]),lty=2)
title("Sch. res., psycom_dum_study")

dev.off()

#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_}
#_#_#_#_#_#_#_#_#_#_#_}
invisible("Explore residuals in restricted subsample")
#_#_#_#_#_#_#_#_#_#_#_}#_#_#_#_#_#_#_#_#_#_#_}

res_restr <- resid(cox_iiw_restr_proposed, "scaledsch")
time_restr <- as.numeric(dimnames(res_restr)[[1]])


folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
jpeg(filename = paste0(folder_path,"zph/schoefeld_res_all_variables_restr_240428.jpg"), width = 8, height = 6, units = "in", res = 600, quality = 600)#Users/CISS Fondecyt/
par(mfrow = c(3, 3)) 

z2_restr <- loess(res_restr[,"lag_tr_outcome"] ~ time, span=0.50)   # residuals 
plot(time_restr, fitted(z2_restr))
lines(supsmu(time_restr, res_restr[,"lag_tr_outcome"]),lty=2)
title("Sch. res., lag_tr_outcome")

z3_restr <- loess(res_restr[,"lag_less_90d_tr1"] ~ time, span=0.50)   # residual
plot(time_restr, fitted(z3_restr))
lines(supsmu(time_restr, res_restr[,"lag_less_90d_tr1"]),lty=2)
title("Sch. res., lag_less_90d_tr1")

z4_restr <- loess(res_restr[,"log_lag_dias_treat_imp_sin_na"] ~ time, span=0.50)   # residuals
plot(time, fitted(z4_restr))
lines(supsmu(time_restr, res_restr[,"log_lag_dias_treat_imp_sin_na"]),lty=2)
title("Sch. res., log_lag_dias_treat_imp_sin_na")

z5_restr <- loess(res_restr[,"lag_comp_bpsc_y3_severe"] ~ time, span=0.50)   # residuals
plot(time_restr, fitted(z5_restr))
lines(supsmu(time_restr, res_restr[,"lag_comp_bpsc_y3_severe"]),lty=2)
title("Sch. res., lag_comp_bpsc_y3_severe")

z6_restr <- loess(res_restr[,"lag_policonsumo2"] ~ time, span=0.50)   # residuals
plot(time_restr, fitted(z6_restr))
lines(supsmu(time_restr, res_restr[,"lag_policonsumo2"]),lty=2)
title("Sch. res., lag_policonsumo2")

z7_restr <- loess(res_restr[,"edad_al_ing_1"] ~ time, span=0.50)   # residuals
plot(time_restr, fitted(z7_restr))
lines(supsmu(time_restr, res_restr[,"edad_al_ing_1"]),lty=2)
title("Sch. res., edad_al_ing_1")

z8_restr <- loess(res_restr[,"susinidum_oh"] ~ time, span=0.50)   # residuals 
plot(time_restr, fitted(z8_restr))
lines(supsmu(time_restr, res_restr[,"susinidum_oh"]),lty=2)
title("Sch. res., susinidum_oh")

z9_restr <- loess(res_restr[,"psycom_dum_study"] ~ time, span=0.50)   # residuals
plot(time_restr, fitted(z9_restr))
lines(supsmu(time_restr, res_restr[,"psycom_dum_study"]),lty=2)
title("Sch. res., psycom_dum_study")

dev.off()
#save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/20240422_avance_iiw.RData")

#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_}
plot(cox.zph(cox_iiw_proposed)[which(attr(cox_iiw_proposed$coefficients, "names") == "log_lag_dias_treat_imp_sin_na")], lwd=2)
abline(0,0, col="red", lty=3, lwd=2)
abline(h=cox_iiw_proposed$coefficients["log_lag_dias_treat_imp_sin_na"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2)
#_#_#_#_#_#_#_#_#_#_#_}
km_days_tr <- survfit(Surv(lag_time,time,event)~ log_lag_dias_treat_imp_sin_na+
    cluster(id), data = data_mine_miss_proc2)

plot(km_days_tr, fun = "cloglog", xlab = "Time (in days) using log",
     ylab = "log-log survival", main = "log-log curves by lag_less_90d_tr1")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Restricted")

plot(cox.zph(cox_iiw_restr_proposed)[which(attr(cox_iiw_restr_proposed$coefficients, "names") == "log_lag_dias_treat_imp_sin_na")], lwd=2)
abline(0,0, col="red", lty=3, lwd=2)
abline(h=cox_iiw_restr_proposed$coefficients["log_lag_dias_treat_imp_sin_na"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2)
#_#_#_#_#_#_#_#_#_#_#_}
km_days_tr_restr <- survfit(Surv(lag_time,time,event)~ log_lag_dias_treat_imp_sin_na+
    cluster(id), data = data_mine_miss_restr_proc2)

plot(km_days_tr_restr, fun = "cloglog", xlab = "Time (in days) using log",
     ylab = "log-log survival", main = "log-log curves by log_lag_dias_treat_imp_sin_na (restr)")
#legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1)
```

#### Transforming variables

```{r irrelong-5-iiw-weights-test-int, warning=FALSE, echo=T, error=F, eval=T}
#load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/20240422_avance_iiw.RData")
#load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/20240422_avance_iiw.RData")
require(splines)

invisible("Primero necesito buscar log_lag_dias_treat_imp_sin_na , luego lag_comp_bpsc_y3_severe, edad_al_ing_1 y porc_pobr")
#specs_dias_treat <- paste0("log_lag_dias_treat_imp_sin_na *", c("time", "poly(time, 3)", "poly(time, 4)", "poly(time, 5)", "poly(time, 6)", "bs(time, 3)", "bs(time, 4)", "bs(time, 5)", "bs(time, 6)", "ns(time, 3)", "ns(time, 4)", "ns(time, 5)", "ns(time, 6)", "rcs(time, 3)", "rcs(time, 4)", "rcs(time, 5)", "rcs(time, 6)"))
specs_dias_treat <- paste0("", c("lag_dias_treat_imp_sin_na", "poly(ifelse(is.na(log_lag_dias_treat_imp_sin_na),.001,log_lag_dias_treat_imp_sin_na), 3)", "poly(ifelse(is.na(log_lag_dias_treat_imp_sin_na),.001,log_lag_dias_treat_imp_sin_na), 4)", "poly(ifelse(is.na(log_lag_dias_treat_imp_sin_na),.001,log_lag_dias_treat_imp_sin_na), 5)", "poly(ifelse(is.na(log_lag_dias_treat_imp_sin_na),.001,log_lag_dias_treat_imp_sin_na), 6)", "bs(log_lag_dias_treat_imp_sin_na, 3)", "bs(log_lag_dias_treat_imp_sin_na, 4)", "bs(log_lag_dias_treat_imp_sin_na, 5)", "bs(log_lag_dias_treat_imp_sin_na, 6)", "ns(log_lag_dias_treat_imp_sin_na, 3)", "ns(log_lag_dias_treat_imp_sin_na, 4)", "ns(log_lag_dias_treat_imp_sin_na, 5)", "ns(log_lag_dias_treat_imp_sin_na, 6)", "rcs(log_lag_dias_treat_imp_sin_na, 3)", "rcs(log_lag_dias_treat_imp_sin_na, 4)", "rcs(log_lag_dias_treat_imp_sin_na, 5)", "rcs(log_lag_dias_treat_imp_sin_na, 6)"))
aic_values0 <- vector(length=length(specs_dias_treat))
coxzph_values0 <-vector(length=length(specs_dias_treat))

for (i in seq_along(specs_dias_treat)) {
  l <- specs_dias_treat[i]
  # TryCatch block to handle errors during model fitting
  #result <- tryCatch({
    model <- cph(as.formula(paste("Surv(lag_time,time,event==1)~ 
            cluster(id) +
            lag_tr_outcome + 
            lag_less_90d_tr1 +",
            l,
            "lag_comp_bpsc_y3_severe + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar +
            strat(tipo_de_plan_2)", sep=" +")), 
           data=data_mine_miss_proc2, x=TRUE, y=TRUE, surv=TRUE)
    
    aic_val <- extractAIC(model)[[2]]
    cox_zph_val <- cox.zph(model)$table[nrow(cox.zph(model)$table), 1]

   # return(c(aic_val, cox_zph_val))
#  }, error = function(e) {
#    return(c(NA, NA))
 # })
    aic_values0[i] <- aic_val
    coxzph_values0[i] <- cox_zph_val
  print(cat(paste("Spec: ", l, "\n")))
  print(cat(paste("AIC: ", aic_val[1], "\n")))
  print(cat(paste("Cox zph test statistic: ", cox_zph_val[1], "\n")))     
}
message(paste0("There was no model that improved cox zph of the restricted sample (vs. ", round(cox.zph(cox_iiw_proposed)$table[nrow(cox.zph(cox_iiw_proposed)$table), 1],1),")"))
#There was no model that improved cox zph of the restricted sample (vs. 495.5)

aic_values0_restr <- vector(length=length(specs_dias_treat))
coxzph_values0_restr <-vector(length=length(specs_dias_treat))

for (i in seq_along(specs_dias_treat)) {
  l <- specs_dias_treat[i]
  # TryCatch block to handle errors during model fitting
  #result <- tryCatch({
    model <- cph(as.formula(paste("Surv(lag_time,time,event==1)~ 
                cluster(id) +
                lag_tr_outcome + 
                lag_less_90d_tr1 +",
                "I(round(",l,",2))+",
                "lag_comp_bpsc_y3_severe + 
                lag_policonsumo2 + 
                edad_al_ing_1 + 
                ano_nac_corr + 
                susinidum_oh +
                susinidum_coc +
                susinidum_pbc +
                susinidum_mar +
                psycom_dum_with +
                psycom_dum_study + 
                freq_cons_dum_5day +
                cond_oc_dum_2inact +
                cond_oc_dum_3unemp +
                susprindum_oh +
                susprindum_coc +
                susprindum_pbc +
                susprindum_mar +
                strat(tipo_de_plan_2_mod)", sep="")), 
           data=data_mine_miss_restr_proc2, x=TRUE, y=TRUE, surv=TRUE)
    
    aic_val_restr <- extractAIC(model)[[2]]
    cox_zph_val_restr <- cox.zph(model)$table[nrow(cox.zph(model)$table), 1]

   # return(c(aic_val, cox_zph_val))
#  }, error = function(e) {
#    return(c(NA, NA))
 # })
    aic_values0_restr[i] <- aic_val_restr
    coxzph_values0_restr[i] <- cox_zph_val_restr
  print(cat(paste("Spec: ", l, "\n")))
  print(cat(paste("AIC: ", aic_val_restr[1], "\n")))
  print(cat(paste("Cox zph test statistic: ", cox_zph_val_restr[1], "\n")))     
}
message(paste0("There was no model that improved cox zph of the restricted sample (vs. ", round(cox.zph(cox_iiw_restr_proposed)$table[nrow(cox.zph(cox_iiw_restr_proposed)$table), 1],1),")"))
#There was no model that improved cox zph of the restricted sample (vs. 495.5)

model_after_mod_log_lag_dias_treat<-
cph(Surv(lag_time,time,event)~ 
    cluster(id)+ 
    lag_tr_outcome +
    log_lag_dias_treat_imp_sin_na_rec.1+
    log_lag_dias_treat_imp_sin_na_rec.2+
    log_lag_dias_treat_imp_sin_na_rec.3+
    lag_less_90d_tr1+
    lag_comp_bpsc_y3_severe + 
    lag_policonsumo2 + 
    edad_al_ing_1 + 
    ano_nac_corr + 
    susinidum_oh +
    susinidum_coc +
    susinidum_pbc +
    susinidum_mar +
    psycom_dum_with +
    psycom_dum_study + 
    freq_cons_dum_5day +
    cond_oc_dum_2inact +
    cond_oc_dum_3unemp +
    susprindum_oh +
    susprindum_coc +
    susprindum_pbc +
    susprindum_mar +
      strat(tipo_de_plan_2), 
    data= data_mine_miss_proc2 %>% dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec= bs(log_lag_dias_treat_imp_sin_na, 3)) %>% data.table::as.data.table() %>% data.frame(), x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

cox.zph(model_after_mod_log_lag_dias_treat)
invisible("The unadjusted was  547; now its 673 21 < 2e-16; we kept the simplest model")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Now we see less than 90 days in treatment interactions, given that the interaction with time of log tr. days did not improved the model")
par(mfrow=c(3,1))
par(mar = c(5, 4, 4, 5))
res240422_1 <- resid(cox_iiw_proposed, "scaledsch")
time240422_1 <- as.numeric(dimnames(res240422_1)[[1]])

z_240422_1_1 <- loess(res240422_1[,"lag_less_90d_tr1"] ~ time240422_1, span=0.50)   # residuals 
# x11() 
plot(time240422_1, fitted(z_240422_1_1))
lines(supsmu(time240422_1, res240422_1[,"psycom_dum_study"]),lty=2)
title("Sch. res., lag_less_90d_tr1")

plot(cox.zph(cox_iiw_proposed)[which(attr(cox_iiw_proposed$coefficients, "names") == "lag_less_90d_tr1")], lwd=2)
abline(0,0, col="red", lty=3, lwd=2)
abline(h=cox_iiw_proposed$coefficients["lag_less_90d_tr1"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

km_home <- survfit(Surv(lag_time,time,event)~ lag_less_90d_tr1+
    cluster(id), data = data_mine_miss_proc2)
#autoplot(km_home) # just to see the km curves
plot(km_home, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"),
     ylab = "log-log survival", main = "log-log curves by lag_less_90d_tr1")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_lag_less_90d_tr1.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("restricted")

par(mfrow=c(2,1))
par(mar = c(5, 4, 4, 5))


plot(cox.zph(cox_iiw_restr_proposed)[which(attr(cox_iiw_restr_proposed$coefficients, "names") == "lag_less_90d_tr1")], lwd=2)
abline(0,0, col="red", lty=3, lwd=2)
abline(h=cox_iiw_restr_proposed$coefficients["lag_less_90d_tr1"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

km_less90d_restr <- survfit(Surv(lag_time,time,event)~ lag_less_90d_tr1+
    cluster(id), data = data_mine_miss_restr_proc2)
#autoplot(km_home) # just to see the km curves
plot(km_less90d_restr, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"),
     ylab = "log-log survival", main = "log-log curves by lag_less_90d_tr1 (restr)")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_lag_less_90d_tr1_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()
```


```{r irrelong-6-iiw-weights-test-int2, warning=FALSE, echo=T, error=F, eval=T}
create_time_varying_effect <- function(binary_covariate, t, decrease_end, increase_start, max_time) {
  # Initialize the effect to be equal to the covariate
  adjusted_effect <- binary_covariate
  
  # Decrease phase: a sharp decrease from the start until decrease_end
  # The covariate's effect is reduced to zero by decrease_end
  adjusted_effect <- ifelse(t <= decrease_end, binary_covariate * (decrease_end - t) / decrease_end, adjusted_effect)
  
  # Flat phase: between decrease_end and increase_start, the effect is zero
  adjusted_effect <- ifelse(t > decrease_end & t <= increase_start, 0, adjusted_effect)
  
  # Increase phase: a gradual increase from increase_start to max_time
  # The covariate's effect is increased back to its original value by max_time
  time_range <- max_time - increase_start
  adjusted_effect <- ifelse(t > increase_start, binary_covariate * (t - increase_start) / time_range, adjusted_effect)
  
  return(adjusted_effect)
}

data_mine_miss_proc2$lag_less_90d_tr1_rec<-
create_time_varying_effect(data_mine_miss_proc2$lag_less_90d_tr1, 
                           data_mine_miss_proc2$time, 
                           20,
                           80,
                           max(data_mine_miss_proc2$time))
data_mine_miss_restr_proc2$lag_less_90d_tr1_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$lag_less_90d_tr1, 
                           data_mine_miss_restr_proc2$time, 
                           20,
                           80,
                           max(data_mine_miss_restr_proc2$time))
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Remove residuals")

mean_resid <- mean(res240422_1[,"lag_less_90d_tr1"], na.rm = TRUE)
sd_resid <- sd(res240422_1[,"lag_less_90d_tr1"], na.rm = TRUE)

# Identify outliers as those residuals greater than 3 standard deviations from the mean
outliers <- which(abs(res240422_1[,"lag_less_90d_tr1"] - mean_resid) > (3 * sd_resid))


data_clean <- data_mine_miss_proc2[-outliers, ]

invisible("even it worse results. Not important //DISCARDED")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("Used a clog log plot, and told chat gpt to suggest a function")
#Here's a possible function that you can tailor to fit the divergence you observe in your log-log plot:
time_varying_coeff <- function(t, change_points, coefficients) {
    # t: vector of times
    # change_points: vector of times at which the hazard ratio changes
    # coefficients: vector of coefficients corresponding to intervals defined by change_points
    
    # Ensure change_points are sorted
    change_points <- sort(c(0, change_points, Inf))
    # Create a vector to hold the coefficient for each time t
    t_coeff <- rep(0, length(t))
    
    # Loop over the intervals defined by change_points
    for (i in seq_along(coefficients)) {
        interval_start <- change_points[i]
        interval_end <- change_points[i + 1]
        # Assign the coefficient to times within the current interval
        t_coeff[t > interval_start & t <= interval_end] <- coefficients[i]
    }
    
    return(t_coeff)
}

# Define the change points and coefficients based on your data and log-log plot
change_points <- c(10, 20, 30)  # Example change points (months)
coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
# Add the time-varying coefficient to your model
data_mine_miss_proc2$lag_less_90d_tr1_rec2 <- with(data_mine_miss_proc2,
                                        lag_less_90d_tr1*time_varying_coeff(lag_time, change_points, coefficients))
data_mine_miss_proc2$less_90d_tr1_rec2 <- with(data_mine_miss_proc2,
                                        less_90d_tr1*time_varying_coeff(time, change_points, coefficients))

invisible("2024-04-30: restricted")
data_mine_miss_restr_proc2$lag_less_90d_tr1_rec2 <- with(data_mine_miss_restr_proc2,
                                        lag_less_90d_tr1*time_varying_coeff(lag_time, change_points, coefficients))
data_mine_miss_restr_proc2$less_90d_tr1_rec2 <- with(data_mine_miss_restr_proc2,
                                        less_90d_tr1*time_varying_coeff(time, change_points, coefficients))
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

model_after_mod_not_log_lag_dias_treat_lag_less_90d<-
cph(Surv(lag_time,time,event)~ 
    cluster(id)+ 
    lag_tr_outcome +
    log_lag_dias_treat_imp_sin_na +
    lag_less_90d_tr1_rec2+
    lag_comp_bpsc_y3_severe + 
    lag_policonsumo2 + 
    edad_al_ing_1 + 
    ano_nac_corr + 
    susinidum_oh +
    susinidum_coc +
    susinidum_pbc +
    susinidum_mar +
    psycom_dum_with +
    psycom_dum_study + 
    freq_cons_dum_5day +
    cond_oc_dum_2inact +
    cond_oc_dum_3unemp +
    susprindum_oh +
    susprindum_coc +
    susprindum_pbc +
    susprindum_mar+
      strat(tipo_de_plan_2), 
    #data= data_clean,
    data= data_mine_miss_proc2 %>% dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec= bs(log_lag_dias_treat_imp_sin_na, 3)) %>% data.table::as.data.table() %>% data.frame(),
    x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

cox.zph(model_after_mod_not_log_lag_dias_treat_lag_less_90d)
#                                 chisq df       p
# log_lag_dias_treat_imp_sin_na 163.562  1 < 2e-16
# lag_less_90d_tr1_rec2          85.349  1 < 2e-16
# lag_comp_bpsc_y3_severe        55.509  1 9.3e-14
# lag_policonsumo2               11.327  1 0.00076
# edad_al_ing_1                  33.351  1 7.7e-09
# ano_nac_corr                    7.573  1 0.00592
# susinidum_oh                   32.526  1 1.2e-08
# susinidum_coc                   0.831  1 0.36209
# susinidum_pbc                   2.136  1 0.14387
# susinidum_mar                  22.932  1 1.7e-06
# psycom_dum_with                10.244  1 0.00137
# psycom_dum_study               41.095  1 1.4e-10
# freq_cons_dum_5day             15.029  1 0.00011
# cond_oc_dum_2inact              0.171  1 0.67918
# cond_oc_dum_3unemp             27.481  1 1.6e-07
# susprindum_oh                  32.539  1 1.2e-08
# susprindum_coc                  1.498  1 0.22104
# susprindum_pbc                 30.540  1 3.3e-08
# susprindum_mar                  0.970  1 0.32457
# GLOBAL                        513.580 19 < 2e-16

message(paste0("There was no model that improved cox zph of the restricted sample (vs. ", round(cox.zph(cox_iiw_proposed)$table[nrow(cox.zph(cox_iiw_proposed)$table), 1],1),")"))

invisible("We improved fit from 552 to 513")
invisible("We do not longer try to change log_lag_dias_treat_imp_sin_na_rec")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("2024-04-30: restricted w/ tipo de plan 2 mod")

for (i in seq(.1,7,.1)) {
  change_points <- c(5*i, 10*i, 15*i)  # Example change points (months)
  coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
  # Add the time-varying coefficient to your model
  data_mine_miss_restr_proc2$lag_less_90d_tr1_rec2 <- with(data_mine_miss_restr_proc2,
                                                           lag_less_90d_tr1*time_varying_coeff(lag_time, change_points, coefficients))
  data_mine_miss_restr_proc2$less_90d_tr1_rec2 <- with(data_mine_miss_restr_proc2,
                                                       less_90d_tr1*time_varying_coeff(lag_time, change_points, coefficients))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              lag_tr_outcome +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec2+
              lag_comp_bpsc_y3_severe + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d)
  invisible("")
  print(paste0("iteration: ",i))
  print(change_points)
  print(format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d)$table), 1]))
  
}
# [1] "iteration: 0.5"
# [1] 2.5 5.0 7.5
# [1] "475.9965"
message(paste0("There was no model that improved cox zph of the restricted sample (vs. ", round(cox.zph(cox_iiw_proposed)$table[nrow(cox.zph(cox_iiw_proposed)$table), 1],1),")"))
#There was no model that improved cox zph of the restricted sample (vs. 495.5)


invisible("Grid search of reduction of TVCs")

for (i in seq(.1,1.5,.05)) {
  tvcs <- c(20,80)*i

data_mine_miss_restr_proc2$lag_less_90d_tr1_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$lag_less_90d_tr1, 
                           data_mine_miss_restr_proc2$time, 
                           tvcs[1],
                           tvcs[2],
                           max(data_mine_miss_restr_proc2$time))
data_mine_miss_restr_proc2$less_90d_tr1_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$less_90d_tr1, 
                           data_mine_miss_restr_proc2$time, 
                           tvcs[1],
                           tvcs[2],
                           max(data_mine_miss_restr_proc2$time))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              lag_tr_outcome +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec+
              lag_comp_bpsc_y3_severe + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)
  invisible("")
  print(paste0("iteration: ",i))
  print(tvcs)
  print(format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table), 1]))
  
}
# [1] "iteration: 0.35"
# [1]  7 28
# [1] "361.9089"

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
# [1] "iteration: 0.5"
# [1] 2.5 5.0 7.5
# [1] "475.9965"
change_points <- c(2.5, 5, 7.5)  # Example change points (months)
coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
# Add the time-varying coefficient to your model
data_mine_miss_restr_proc2$lag_less_90d_tr1_rec2 <- with(data_mine_miss_restr_proc2,
                                                         lag_less_90d_tr1*time_varying_coeff(lag_time, change_points, coefficients))
data_mine_miss_restr_proc2$less_90d_tr1_rec2 <- with(data_mine_miss_restr_proc2,
                                                     less_90d_tr1*time_varying_coeff(lag_time, change_points, coefficients))

model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d<-
cph(Surv(lag_time,time,event)~ 
    cluster(id) + 
    lag_tr_outcome +
    log_lag_dias_treat_imp_sin_na +
    lag_less_90d_tr1_rec2 +
    lag_comp_bpsc_y3_severe + 
    lag_policonsumo2 + 
    edad_al_ing_1 + 
    ano_nac_corr + 
    susinidum_oh +
    susinidum_coc +
    susinidum_pbc +
    susinidum_mar +
    psycom_dum_with +
    psycom_dum_study + 
    freq_cons_dum_5day +
    cond_oc_dum_2inact +
    cond_oc_dum_3unemp +
    susprindum_oh +
    susprindum_coc +
    susprindum_pbc +
    susprindum_mar+
    strat(tipo_de_plan_2_mod), 
    #data= data_clean,
    data= data_mine_miss_restr_proc2 %>% dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec= bs(log_lag_dias_treat_imp_sin_na, 3)) %>% data.table::as.data.table() %>% data.frame(),
    x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d)

message(paste0("The model improved from ", round(cox.zph(cox_iiw_proposed)$table[nrow(cox.zph(cox_iiw_proposed)$table), 1],1)," to 476"))
#The model improved from 495.5 to 476


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
# [1] "iteration: 0.35"
# [1]  7 28
# [1] "361.9089"

tvcs <- c(20,80)*0.35

data_mine_miss_restr_proc2$lag_less_90d_tr1_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$lag_less_90d_tr1, 
                           data_mine_miss_restr_proc2$time, 
                           tvcs[1],
                           tvcs[2],
                           max(data_mine_miss_restr_proc2$time))
data_mine_miss_restr_proc2$less_90d_tr1_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$less_90d_tr1, 
                           data_mine_miss_restr_proc2$time, 
                           tvcs[1],
                           tvcs[2],
                           max(data_mine_miss_restr_proc2$time))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              lag_tr_outcome +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec+
              lag_comp_bpsc_y3_severe + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Analyse the violation of proportional hazards")
par(mar = c(5, 4, 4, 5))
par(mfrow=c(3,1))
res240422_2 <- resid(model_after_mod_not_log_lag_dias_treat_lag_less_90d, "scaledsch")
time240422_2 <- as.numeric(dimnames(res240422_2)[[1]])

z_240422_2_1 <- loess(res240422_2[,"log_lag_dias_treat_imp_sin_na"] ~ time240422_2, span=0.50)   # residuals 
# x11() 
plot(time240422_2, fitted(z_240422_2_1))
lines(supsmu(time240422_2, res240422_2[,"log_lag_dias_treat_imp_sin_na"]),lty=2)
title("Sch. res., log_lag_dias_treat_imp_sin_na")

z_240422_2_2 <- loess(res240422_2[,"lag_comp_bpsc_y3_severe"] ~ time240422_2, span=0.50)   #
plot(time240422_2, fitted(z_240422_2_2))
lines(supsmu(time240422_2, res240422_2[,"lag_comp_bpsc_y3_severe"]),lty=2)
title("Sch. res., lag_comp_bpsc_y3_severe")

km_lag_comp_bpsc_y3_severe <- survfit(Surv(lag_time,time,event)~ lag_comp_bpsc_y3_severe+
    cluster(id), data = data_mine_miss_proc2)
#autoplot(km_home) # just to see the km curves

plot(km_lag_comp_bpsc_y3_severe, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"),
     ylab = "log-log survival", main = "log-log curves by km_lag_comp_bpsc_y3_severe")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1)

recorded_plot <- recordPlot() 
folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_comp_bpsc.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("2024-04-30: Analyse the violation of proportional hazards (restricted)")
par(mar = c(5, 4, 4, 5))
par(mfrow=c(3,1))
res240422_2_restr <- resid(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt, "scaledsch")
time240422_2_restr <- as.numeric(dimnames(res240422_2_restr)[[1]])

z_240422_2_1_restr <- loess(res240422_2_restr[,"log_lag_dias_treat_imp_sin_na"] ~ time240422_2_restr, span=0.50)   # residuals 
# x11() 
plot(time240422_2_restr, fitted(z_240422_2_1_restr))
lines(supsmu(time240422_2_restr, res240422_2_restr[,"log_lag_dias_treat_imp_sin_na"]),lty=2)
title("Sch. res., log_lag_dias_treat_imp_sin_na (restricted)")

z_240422_2_2_restr <- loess(res240422_2_restr[,"lag_comp_bpsc_y3_severe"] ~ time240422_2_restr, span=0.50)   #
plot(time240422_2_restr, fitted(z_240422_2_2_restr))
lines(supsmu(time240422_2_restr, res240422_2_restr[,"lag_comp_bpsc_y3_severe"]),lty=2)
title("Sch. res., lag_comp_bpsc_y3_severe (restricted)")

km_lag_comp_bpsc_y3_severe_restr <- survfit(Surv(lag_time,time,event)~ lag_comp_bpsc_y3_severe+
    cluster(id), data = data_mine_miss_restr_proc2)
#autoplot(km_home) # just to see the km curves

plot(km_lag_comp_bpsc_y3_severe_restr, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"),
     ylab = "log-log survival", main = "log-log curves by km_lag_comp_bpsc_y3_severe")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1)

recorded_plot <- recordPlot() 
folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_comp_bpsc_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()
```

```{r irrelong-7-iiw-weights-test-int3, warning=FALSE, echo=T, error=F, eval=T}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("2024-05-30: restricted w/ tipo de plan 2 mod; find TVCs")

message(paste0("The model was better after correction: ",
               round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table), 1],1)
               ," vs. the original: ",
               round(cox.zph(cox_iiw_proposed)$table[nrow(cox.zph(cox_iiw_proposed)$table), 1],1)
               ))
#The model was better after correction: 361.9 vs. the original: 495.5
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

for (i in seq(.1,7,.1)) {
  change_points <- c(5*i, 10*i, 15*i)  # Example change points (months)
  coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
  # Add the time-varying coefficient to your model
data_mine_miss_restr_proc2$lag_comp_bpsc_y3_severe_rec2 <- with(data_mine_miss_restr_proc2, lag_comp_bpsc_y3_severe*time_varying_coeff(lag_time, change_points, coefficients))

data_mine_miss_restr_proc2$comp_bpsc_y3_severe_rec2 <- with(data_mine_miss_restr_proc2, comp_bpsc_y3_severe*time_varying_coeff(time, change_points, coefficients))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              lag_tr_outcome +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec+
              lag_comp_bpsc_y3_severe_rec2 + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
            data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe)
  invisible("")
  print(paste0("iteration: ",i))
  print(change_points)
  print(format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe)$table), 1]))
  
}

message(paste0("The previously modified model: ",
               round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table), 1],1),
               " vs. the actual models: 354.7"
               ))
#The previously modified model: 361.9 vs. the actual models: 354.7

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_bpsc_severe <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(.1,1.5,.025)) {
tvcs <- c(20,80)*i

data_mine_miss_restr_proc2$lag_comp_bpsc_y3_severe_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$lag_comp_bpsc_y3_severe, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))
data_mine_miss_restr_proc2$comp_bpsc_y3_severe_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$comp_bpsc_y3_severe, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              lag_tr_outcome +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec+
              lag_comp_bpsc_y3_severe_rec + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)[[2]],1)
  print( paste0("Time points: ",tvcs[1],", ", tvcs[2]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_bpsc_severe <- rbind.data.frame(results_bpsc_severe, 
                                          cbind.data.frame(
                                            spec = paste0("iteration: ",i, "; tvcs: ", tvcs[1],", ", tvcs[2]), 
                                            aic = aic_iter,
                                            cox_zph = cox_zph_iter,
                                            success = T
                                          ))
}



#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

results_bpsc_severe[which(as.numeric(results_bpsc_severe$cox_zph)==
                            min(as.numeric(results_bpsc_severe$cox_zph))),]
#                               spec      aic  cox_zph success
# 14 iteration: 0.425; tvcs: 8.5, 34 244802.6 351.5909    TRUE
tvcs <- c(20,80)*0.425

data_mine_miss_restr_proc2$lag_comp_bpsc_y3_severe_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$lag_comp_bpsc_y3_severe, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))
data_mine_miss_restr_proc2$comp_bpsc_y3_severe_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$comp_bpsc_y3_severe, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))


model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt<-
  cph(Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod), 
      data=data_mine_miss_restr_proc2 %>% 
        data.table::as.data.table() %>% data.frame(), 
      x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)
#                                  chisq df       p
# lag_tr_outcome                 19.4440  1 1.0e-05 ###
# log_lag_dias_treat_imp_sin_na  48.7236  1 2.9e-12 ####
# lag_less_90d_tr1_rec           42.0653  1 8.8e-11 ####
# lag_comp_bpsc_y3_severe_rec     1.5369  1 0.21508 
# lag_policonsumo2                1.5765  1 0.20926
# edad_al_ing_1                  17.5785  1 2.8e-05 ###
# ano_nac_corr                    1.6876  1 0.19392
# susinidum_oh                   23.5183  1 1.2e-06 ###
# susinidum_coc                   3.6019  1 0.05771
# susinidum_pbc                   2.6388  1 0.10428
# susinidum_mar                  13.2146  1 0.00028 ##
# psycom_dum_with                14.7208  1 0.00012 #
# psycom_dum_study                8.0570  1 0.00453 #
# freq_cons_dum_5day              0.5748  1 0.44834
# cond_oc_dum_2inact              7.9683  1 0.00476
# cond_oc_dum_3unemp              5.0871  1 0.02410 #
# susprindum_oh                  11.4536  1 0.00071 ##
# susprindum_coc                  0.0549  1 0.81473
# susprindum_pbc                  2.7348  1 0.09818
# susprindum_mar                  7.8675  1 0.00503 ##
# GLOBAL                        351.5909 20 < 2e-16
  
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Analyse the violation of proportional hazards")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("2024-04-30: restricted")

res240422_3_restr <- resid(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt, "scaledsch")
time240422_3_restr <- as.numeric(dimnames(res240422_3_restr)[[1]])

z_240422_3_1_restr <- loess(res240422_3_restr[,"susinidum_oh"] ~ time240422_3_restr, span=0.50)   # residuals 
# x11() 

par(mfrow= c(3,2))
plot(time240422_3_restr, fitted(z_240422_3_1_restr))
lines(supsmu(time240422_3_restr, res240422_3_restr[,"susinidum_oh"]),lty=2)
title("Sch. res., susinidum_oh")

z_240422_3_2_restr <- loess(res240422_3_restr[,"susinidum_oh"] ~ time240422_3_restr, span=0.50)   #
plot(time240422_3_restr, fitted(z_240422_3_2_restr))
lines(supsmu(time240422_3_restr, res240422_3_restr[,"susinidum_oh"]),lty=2)
title("Sch. res., susinidum_oh")

plot(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)[which(attr(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt$coefficients, "names") == "psycom_dum_study")], lwd=2, main= "Residuals of psycom_dum_study")
abline(0,0, col="red", lty=3, lwd=2)
abline(h=model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt$coefficients["psycom_dum_study"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")

plot(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)[which(attr(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d$coefficients, "names") == "psycom_dum_with")], lwd=2, main= "Residuals of psycom_dum_with")
abline(0,0, col="red", lty=3, lwd=2)
abline(h=model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt$coefficients["psycom_dum_with"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")

#autoplot(km_home) # just to see the km curves

km_psycom_dum_study_restr <- survfit(Surv(lag_time,time,event)~ psycom_dum_study+ 
    cluster(id), data = data_mine_miss_restr_proc2)
plot(km_psycom_dum_study_restr, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"), ylab = "log-log survival", main = "log-log curves by psycom_dum_study (restricted)")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

km_psycom_dum_with_restr <- survfit(Surv(lag_time,time,event)~ psycom_dum_with+ 
    cluster(id), data = data_mine_miss_restr_proc2)
#autoplot(km_home) # just to see the km curves

plot(km_psycom_dum_with_restr, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"), ylab = "log-log survival", main = "log-log curves by km_psycom_dum_with (restricted)")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_psycom_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("2024-05-01: restricted")

res240422_4_restr <- resid(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt, "scaledsch")
time240422_4_restr <- as.numeric(dimnames(res240422_3_restr)[[1]])

z_240422_4_1_restr <- loess(res240422_4_restr[,"lag_tr_outcome"] ~ time240422_4_restr, span=0.50)   # residuals 
# x11() 

par(mfrow= c(3,1))
plot(time240422_4_restr, fitted(z_240422_4_1_restr))
lines(supsmu(time240422_4_restr, res240422_4_restr[,"lag_tr_outcome"]),lty=2)
title("Sch. res., lag_tr_outcome")

plot(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt)[which(attr(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt$coefficients, "names") == "lag_tr_outcome")], lwd=2, main= "Residuals of lag_tr_outcome")
abline(0,0, col="red", lty=3, lwd=2)
abline(h=model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt$coefficients["lag_tr_outcome"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")

#autoplot(km_home) # just to see the km curves

km_lag_tr_outcome_restr <- survfit(Surv(lag_time,time,event)~ lag_tr_outcome+ 
    cluster(id), data = data_mine_miss_restr_proc2)
plot(km_lag_tr_outcome_restr, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"), ylab = "log-log survival", main = "log-log curves by km_lag_tr_outcome (restricted)")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_lag_tr_outcome_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()
```


```{r irrelong-8-iiw-weights-test-int4, warning=FALSE, echo=T, error=F, eval=T}
#load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/20240502_avance_iiw.RData")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_lag_tr_outcome <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(.1,1.5,.025)) {
tvcs <- c(20,80)*i

data_mine_miss_restr_proc2$lag_tr_outcome_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$lag_tr_outcome, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))
data_mine_miss_restr_proc2$tr_outcome_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$tr_outcome, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              lag_tr_outcome_rec +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec+
              lag_comp_bpsc_y3_severe_rec + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)[[2]],1)
  print( paste0("Time points: ",tvcs[1],", ", tvcs[2]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_lag_tr_outcome <- rbind.data.frame(results_lag_tr_outcome, 
                                          cbind.data.frame(
                                            spec = paste0("iteration: ",i, "; tvcs: ", tvcs[1],", ", tvcs[2]), 
                                            aic = aic_iter,
                                            cox_zph = cox_zph_iter,
                                            success = T
                                          ))
}

results_lag_tr_outcome[which(as.numeric(results_lag_tr_outcome$cox_zph)==
                            min(as.numeric(results_lag_tr_outcome$cox_zph))),]
#                            spec      aic  cox_zph success
# 15 iteration: 0.45; tvcs: 9, 36 242729.5 321.3004    TRUE

message(paste0("The previously modified model: ",
               round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_alt)$table), 1],1),
               " vs. the minimum model: ",  results_lag_tr_outcome[which(as.numeric(results_lag_tr_outcome$cox_zph)== min(as.numeric(results_lag_tr_outcome$cox_zph))),"cox_zph"]
               ))
#The previously modified model: 361.9 vs. the minimum model: 321.3004


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
require(splines)

specs_lag_tr_out <- paste0("lag_tr_outcome *", c("time", "log(time+0.001)", "poly(ifelse(is.na(time), .001,time), 3)", "poly(ifelse(is.na(time), .001,time), 4)", "poly(ifelse(is.na(time), .001,time), 5)", "poly(ifelse(is.na(time), .001,time), 6)", "pspline(log(time+0.001), df=3)", "pspline(log(time+0.001), df=4)", "pspline(log(time+0.001), df=5)", "pspline(log(time+0.001), df=6)", "bs(time, 3)", "bs(time, 4)", "bs(time, 5)", "bs(time, 6)", "ns(time, 3)", "ns(time, 4)", "ns(time, 5)", "ns(time, 6)", "rcs(time, 3)", "rcs(time, 4)", "rcs(time, 5)", "rcs(time, 6)"))

results_lag_tr_out <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq_along(specs_lag_tr_out)) {
  l <- specs_lag_tr_out[i]

  result <- tryCatch({
    model <- cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              I(round(",l,",2)) +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec+
              lag_comp_bpsc_y3_severe_rec + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
          data=data_mine_miss_restr_proc2 %>% 
            dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec = bs(log_lag_dias_treat_imp_sin_na, 3)) %>% 
            data.table::as.data.table() %>% data.frame(), 
           x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

    aic_val <- extractAIC(model)[[2]]
    cox_zph_val <- cox.zph(model)$table[nrow(cox.zph(model)$table), 1]
    success <- TRUE 

  }, error = function(e) {
    aic_val <- NA
    cox_zph_val <- NA
    success <- FALSE
    warning(paste0("Error fitting specification ", i, " (", l, "): ", e))
  })

  results_lag_tr_out <- rbind(results_lag_tr_out, data.frame(spec = l, aic = aic_val, cox_zph = cox_zph_val, success = success))

  print(cat(paste("Iteration:", i, "\n"))) # Add iteration number
  print(cat(paste("Spec: ", l, "\n")))
  print(cat(paste("AIC: ", results_lag_tr_out$aic[i], "\n"))) 
  print(cat(paste("Cox zph test statistic: ", results_lag_tr_out$cox_zph[i], "\n")))
}

results_lag_tr_out[which(as.numeric(results_lag_tr_out$cox_zph)==
                                 min(as.numeric(results_lag_tr_out$cox_zph))),]
#                              spec      aic  cox_zph success
# 2 lag_tr_outcome *log(time+0.001) 244561.9 1248.051    TRUE
invisible("It worsen. We do nothing")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_lag_tr_outcome_alt <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(1,5,.1)) {
change_points <- c(5*i, 10*i, 15*i)  # Example change points (months)
coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
# Add the time-varying coefficient to your model

data_mine_miss_restr_proc2$lag_tr_outcome_rec2 <- with(data_mine_miss_restr_proc2,
                                                 lag_tr_outcome*time_varying_coeff(lag_time, change_points, coefficients))
data_mine_miss_restr_proc2$tr_outcome_rec2 <- with(data_mine_miss_restr_proc2,
                                                 tr_outcome*time_varying_coeff(time, change_points, coefficients))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
              cluster(id)+ 
              lag_tr_outcome_rec2 +
              log_lag_dias_treat_imp_sin_na +
              lag_less_90d_tr1_rec+
              lag_comp_bpsc_y3_severe_rec + 
              lag_policonsumo2 + 
              edad_al_ing_1 + 
              ano_nac_corr + 
              susinidum_oh +
              susinidum_coc +
              susinidum_pbc +
              susinidum_mar +
              psycom_dum_with +
              psycom_dum_study + 
              freq_cons_dum_5day +
              cond_oc_dum_2inact +
              cond_oc_dum_3unemp +
              susprindum_oh +
              susprindum_coc +
              susprindum_pbc +
              susprindum_mar+
              strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_alt)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_alt)[[2]],1)

  print( paste0("Time points: ",change_points[1],", ", change_points[2], ", ",change_points[3]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_alt)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_lag_tr_outcome_alt <- rbind.data.frame(results_lag_tr_outcome_alt, 
                                          cbind.data.frame(
                                            spec = paste0("iteration: ",i, "; change points: ", change_points[1],", ", change_points[2], ", ",change_points[3]), 
                                            aic = aic_iter,
                                            cox_zph = cox_zph_iter,
                                            success = T
                                          ))
}

results_lag_tr_outcome_alt[which(as.numeric(results_lag_tr_outcome_alt$cox_zph)==
                            min(as.numeric(results_lag_tr_outcome_alt$cox_zph))),]
#                                         spec      aic  cox_zph success
# 25 iteration: 3.4; change points: 17, 34, 51 244869.2 347.3415    TRUE

message(paste0("The minimum of the first modified model: ",
                results_lag_tr_outcome[which(as.numeric(results_lag_tr_outcome$cox_zph)== min(as.numeric(results_lag_tr_outcome$cox_zph))),"cox_zph"],
               " vs. the minimum model: ",  results_lag_tr_outcome_alt[which(as.numeric(results_lag_tr_outcome_alt$cox_zph)== min(as.numeric(results_lag_tr_outcome_alt$cox_zph))),"cox_zph"]
               ))
#The minimum of the first modified model: 321.3004 vs. the minimum model: 347.3415


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_lag_tr_outcome_alt[which(as.numeric(results_lag_tr_outcome$cox_zph)==
                            min(as.numeric(results_lag_tr_outcome$cox_zph))),]
#                            spec      aic  cox_zph success
# 15 iteration: 0.45; tvcs: 9, 36 242729.5 321.3004    TRUE

tvcs<- c(9, 36)

data_mine_miss_restr_proc2$lag_tr_outcome_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$lag_tr_outcome, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))
data_mine_miss_restr_proc2$tr_outcome_rec<-
create_time_varying_effect(data_mine_miss_restr_proc2$tr_outcome, 
                   data_mine_miss_restr_proc2$time, 
                   tvcs[1],
                   tvcs[2],
                   max(data_mine_miss_restr_proc2$time))

model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out<-
  cph(Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod), 
      data=data_mine_miss_restr_proc2 %>% 
        data.table::as.data.table() %>% data.frame(), 
      x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table,4)
#                                  chisq df      p
# lag_tr_outcome_rec             66.6269  1 0.0000 ####
# log_lag_dias_treat_imp_sin_na  10.1949  1 0.0014 #
# lag_less_90d_tr1_rec           84.0361  1 0.0000 ####
# lag_comp_bpsc_y3_severe_rec    17.2093  1 0.0000 ####
# lag_policonsumo2                3.1849  1 0.0743
# edad_al_ing_1                   0.1368  1 0.7115
# ano_nac_corr                    5.2180  1 0.0224 #
# susinidum_oh                   19.9277  1 0.0000 ####
# susinidum_coc                   9.7729  1 0.0018 ##
# susinidum_pbc                   1.9935  1 0.1580
# susinidum_mar                   6.6712  1 0.0098 #
# psycom_dum_with                11.7874  1 0.0006 ##
# psycom_dum_study                1.6215  1 0.2029
# freq_cons_dum_5day              0.0521  1 0.8194
# cond_oc_dum_2inact              4.4607  1 0.0347
# cond_oc_dum_3unemp              1.6238  1 0.2026
# susprindum_oh                   4.3416  1 0.0372
# susprindum_coc                  1.6713  1 0.1961
# susprindum_pbc                  0.0723  1 0.7879
# susprindum_mar                  5.3392  1 0.0209
# GLOBAL                        321.3004 20 0.0000

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Analyse the violation of proportional hazards")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
try(dev.off())
res240422_5_restr <- resid(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out, "scaledsch")
time240422_5_restr <- as.numeric(dimnames(res240422_5_restr)[[1]])

z_240422_5_1_restr <- loess(res240422_5_restr[,"susinidum_oh"] ~ time240422_5_restr, span=0.50)   # residuals 

par(mfrow= c(3,1))
plot(time240422_5_restr, fitted(z_240422_5_1_restr))
lines(supsmu(time240422_5_restr, res240422_5_restr[,"susinidum_oh"]),lty=2)
title("Sch. res., susinidum_oh")

plot(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)[which(attr(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out$coefficients, "names") == "susinidum_oh")], lwd=2, main= "Residuals of susinidum_oh")
abline(0,0, col="red", lty=3, lwd=2)
abline(h=model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out$coefficients["susinidum_oh"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")

km_susinidum_oh <- survfit(Surv(lag_time,time,event)~ susinidum_oh+ 
    cluster(id), data = data_mine_miss_restr_proc2)
plot(km_susinidum_oh, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"), ylab = "log-log survival", main = "log-log curves by susinidum_oh")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_susinidum_oh_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()
```


```{r irrelong-9-iiw-weights-test-int4, warning=FALSE, echo=T, error=F, eval=T}
invisible("Now with Initial substance: Alcohol")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_susinidum_oh <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(.1,1.5,.025)) {
  tvcs <- c(20,80)*i
  
  data_mine_miss_restr_proc2$susinidum_oh_rec<-
    create_time_varying_effect(data_mine_miss_restr_proc2$susinidum_oh, 
                               data_mine_miss_restr_proc2$time, 
                               tvcs[1],
                               tvcs[2],
                               max(data_mine_miss_restr_proc2$time))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh_rec +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh)[[2]],1)
  print( paste0("Time points: ",tvcs[1],", ", tvcs[2]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_susinidum_oh <- rbind.data.frame(results_susinidum_oh, 
                                             cbind.data.frame(
                                               spec = paste0("iteration: ",i, "; tvcs: ", tvcs[1],", ", tvcs[2]), 
                                               aic = aic_iter,
                                               cox_zph = cox_zph_iter,
                                               success = T
                                             ))
}

results_susinidum_oh[which(as.numeric(results_susinidum_oh$cox_zph)==
                               min(as.numeric(results_susinidum_oh$cox_zph))),]
#                            spec      aic  cox_zph success
# 15 iteration: 0.45; tvcs: 9, 36 242729.5 321.3004    TRUE

message(paste0("The previously modified model: ",
               round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table), 1],1),
               " vs. the minimum model: ",  results_susinidum_oh[which(as.numeric(results_susinidum_oh$cox_zph)== min(as.numeric(results_susinidum_oh$cox_zph))),"cox_zph"]
))
#The previously modified model: 321.3 vs. the minimum model: 1547.708
invisible("It worsen")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
require(splines)

specs_susinidum_oh <- paste0("susinidum_oh *", c("time", "log(time+0.001)", "poly(ifelse(is.na(time), .001,time), 3)", "poly(ifelse(is.na(time), .001,time), 4)", "poly(ifelse(is.na(time), .001,time), 5)", "poly(ifelse(is.na(time), .001,time), 6)", "pspline(log(time+0.001), df=3)", "pspline(log(time+0.001), df=4)", "pspline(log(time+0.001), df=5)", "pspline(log(time+0.001), df=6)", "bs(time, 3)", "bs(time, 4)", "bs(time, 5)", "bs(time, 6)", "ns(time, 3)", "ns(time, 4)", "ns(time, 5)", "ns(time, 6)", "rcs(time, 3)", "rcs(time, 4)", "rcs(time, 5)", "rcs(time, 6)"))

results_susini_oh <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq_along(specs_susinidum_oh)) {
  l <- specs_susinidum_oh[i]
  
    
  result <- tryCatch({
    model <- cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            I(round(",l,",2)) +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
                 data=data_mine_miss_restr_proc2 %>% 
                   dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec = bs(log_lag_dias_treat_imp_sin_na, 3)) %>% 
                   data.table::as.data.table() %>% data.frame(), 
                 x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
    
    aic_val <- extractAIC(model)[[2]]
    cox_zph_val <- cox.zph(model)$table[nrow(cox.zph(model)$table), 1]
    success <- TRUE 
    
  }, error = function(e) {
    aic_val <- NA
    cox_zph_val <- NA
    success <- FALSE
    warning(paste0("Error fitting specification ", i, " (", l, "): ", e))
  })
  
  results_susini_oh <- rbind(results_susini_oh, data.frame(spec = l, aic = aic_val, cox_zph = cox_zph_val, success = success))
  
  print(cat(paste("Iteration:", i, "\n"))) # Add iteration number
  print(cat(paste("Spec: ", l, "\n")))
  print(cat(paste("AIC: ", results_susini_oh$aic[i], "\n"))) 
  print(cat(paste("Cox zph test statistic: ", results_susini_oh$cox_zph[i], "\n")))
}

results_susini_oh[which(as.numeric(results_susini_oh$cox_zph)==
                           min(as.numeric(results_susini_oh$cox_zph))),]
#                            spec    aic cox_zph success
# 2 susinidum_oh *log(time+0.001) 241573 1203.69    TRUE
invisible("It worsen. We do nothing")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_susinidum_oh_alt <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(1,5,.1)) {
  change_points <- c(5*i, 10*i, 15*i)  # Example change points (months)
  coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
  # Add the time-varying coefficient to your model
  
  data_mine_miss_restr_proc2$susinidum_oh_rec2 <- with(data_mine_miss_restr_proc2,
                                                       susinidum_oh*time_varying_coeff(time, change_points, coefficients))

  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh_rec2 +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh_alt)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh_alt)[[2]],1)
  
  print( paste0("Time points: ",change_points[1],", ", change_points[2], ", ",change_points[3]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh_alt)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_susinidum_oh_alt <- rbind.data.frame(results_susinidum_oh_alt, 
                                                 cbind.data.frame(
                                                   spec = paste0("iteration: ",i, "; change points: ", change_points[1],", ", change_points[2], ", ",change_points[3]), 
                                                   aic = aic_iter,
                                                   cox_zph = cox_zph_iter,
                                                   success = T
                                                 ))
}

results_susinidum_oh_alt[which(as.numeric(results_susinidum_oh_alt$cox_zph)==
                                   min(as.numeric(results_susinidum_oh_alt$cox_zph))),]
#                                       spec    aic  cox_zph success
# 3 iteration: 1.2; change points: 6, 12, 18 242696 328.8011    TRUE

message(paste0("The minimum of the first modified model: ",
               format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table), 1]),
               " vs. the minimum model: ",  results_susinidum_oh_alt[which(as.numeric(results_susinidum_oh_alt$cox_zph)== min(as.numeric(results_susinidum_oh_alt$cox_zph))),"cox_zph"]
))
#The minimum of the first modified model: 321.3004 vs. the minimum model: 328.8011

invisible("It worsens. We do not integrate this model")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Analyse the violation of proportional hazards")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
try(dev.off())
z_240422_5_2_restr <- loess(res240422_5_restr[,"susinidum_coc"] ~ time240422_5_restr, span=0.50)   # residuals 

par(mfrow= c(3,1))
plot(time240422_5_restr, fitted(z_240422_5_2_restr))
lines(supsmu(time240422_5_restr, res240422_5_restr[,"susinidum_coc"]),lty=2)
title("Sch. res., susinidum_coc")

plot(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)[which(attr(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out$coefficients, "names") == "susinidum_coc")], lwd=2, main= "Residuals of susinidum_coc")
abline(0,0, col="red", lty=3, lwd=2)
abline(h=model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out$coefficients["susinidum_coc"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")

km_susinidum_coc <- survfit(Surv(lag_time,time,event)~ susinidum_coc+ 
    cluster(id), data = data_mine_miss_restr_proc2)
plot(km_susinidum_coc, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"), ylab = "log-log survival", main = "log-log curves by susinidum_coc")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_susinidum_coc_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()
```

```{r irrelong-10-iiw-weights-test-int5, warning=FALSE, echo=T, error=F, eval=T}
invisible("Now with Initial substance: Cocaine")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_susinidum_coc <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(.1,1.5,.025)) {
  tvcs <- c(20,80)*i
  
  data_mine_miss_restr_proc2$susinidum_coc_rec<-
    create_time_varying_effect(data_mine_miss_restr_proc2$susinidum_coc, 
                               data_mine_miss_restr_proc2$time, 
                               tvcs[1],
                               tvcs[2],
                               max(data_mine_miss_restr_proc2$time))
  
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc_rec +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc)[[2]],1)
  print( paste0("Time points: ",tvcs[1],", ", tvcs[2]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_susinidum_coc <- rbind.data.frame(results_susinidum_coc, 
                                             cbind.data.frame(
                                               spec = paste0("iteration: ",i, "; tvcs: ", tvcs[1],", ", tvcs[2]), 
                                               aic = aic_iter,
                                               cox_zph = cox_zph_iter,
                                               success = T
                                             ))
}

results_susinidum_coc[which(as.numeric(results_susinidum_coc$cox_zph)==
                               min(as.numeric(results_susinidum_coc$cox_zph))),]
#                               spec      aic  cox_zph success
# 14 iteration: 0.425; tvcs: 8.5, 34 242575.7 336.8893    TRUE

message(paste0("The previously modified model: ",
               round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table), 1],1),
               " vs. the minimum model: ",  results_susinidum_coc[which(as.numeric(results_susinidum_coc$cox_zph)== min(as.numeric(results_susinidum_coc$cox_zph))),"cox_zph"]
))
#The previously modified model: 321.3 vs. the minimum model: 336.8893
invisible("It worsen")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
require(splines)

specs_susinidum_coc <- paste0("susinidum_coc *", c("time", "log(time+0.001)", "poly(ifelse(is.na(time), .001,time), 3)", "poly(ifelse(is.na(time), .001,time), 4)", "poly(ifelse(is.na(time), .001,time), 5)", "poly(ifelse(is.na(time), .001,time), 6)", "pspline(log(time+0.001), df=3)", "pspline(log(time+0.001), df=4)", "pspline(log(time+0.001), df=5)", "pspline(log(time+0.001), df=6)", "bs(time, 3)", "bs(time, 4)", "bs(time, 5)", "bs(time, 6)", "ns(time, 3)", "ns(time, 4)", "ns(time, 5)", "ns(time, 6)", "rcs(time, 3)", "rcs(time, 4)", "rcs(time, 5)", "rcs(time, 6)"))

results_susini_coc <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq_along(specs_susinidum_coc)) {
  l <- specs_susinidum_coc[i]
  
    
  result <- tryCatch({
    model <- cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            I(round(",l,",2)) +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
                 data=data_mine_miss_restr_proc2 %>% 
                   dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec = bs(log_lag_dias_treat_imp_sin_na, 3)) %>% 
                   data.table::as.data.table() %>% data.frame(), 
                 x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
    
    aic_val <- extractAIC(model)[[2]]
    cox_zph_val <- cox.zph(model)$table[nrow(cox.zph(model)$table), 1]
    success <- TRUE 
    
  }, error = function(e) {
    aic_val <- NA
    cox_zph_val <- NA
    success <- FALSE
    warning(paste0("Error fitting specification ", i, " (", l, "): ", e))
  })
  
  results_susini_coc <- rbind(results_susini_coc, data.frame(spec = l, aic = aic_val, cox_zph = cox_zph_val, success = success))
  
  print(cat(paste("Iteration:", i, "\n"))) # Add iteration number
  print(cat(paste("Spec: ", l, "\n")))
  print(cat(paste("AIC: ", results_susini_oh$aic[i], "\n"))) 
  print(cat(paste("Cox zph test statistic: ", results_susini_oh$cox_zph[i], "\n")))
}

results_susini_coc[which(as.numeric(results_susini_coc$cox_zph)==
                           min(as.numeric(results_susini_coc$cox_zph))),]
#                             spec      aic cox_zph success
# 2 susinidum_coc *log(time+0.001) 242695.6 323.038    TRUE
invisible("It worsen. We do nothing")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_susinidum_coc_alt <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(1,5,.1)) {
  change_points <- c(5*i, 10*i, 15*i)  # Example change points (months)
  coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
  # Add the time-varying coefficient to your model
  
  data_mine_miss_restr_proc2$susinidum_coc_rec2 <- with(data_mine_miss_restr_proc2,
                                                       susinidum_coc*time_varying_coeff(time, change_points, coefficients))

  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)[[2]],1)
  
  print( paste0("Time points: ",change_points[1],", ", change_points[2], ", ",change_points[3]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_susinidum_coc_alt <- rbind.data.frame(results_susinidum_coc_alt, 
                                                 cbind.data.frame(
                                                   spec = paste0("iteration: ",i, "; change points: ", change_points[1],", ", change_points[2], ", ",change_points[3]), 
                                                   aic = aic_iter,
                                                   cox_zph = cox_zph_iter,
                                                   success = T
                                                 ))
}

results_susinidum_coc_alt[which(as.numeric(results_susinidum_coc_alt$cox_zph)==
                                   min(as.numeric(results_susinidum_coc_alt$cox_zph))),]
#                                       spec      aic  cox_zph success
# 21 iteration: 3; change points: 15, 30, 45 242728.3 317.3692    TRUE

message(paste0("The minimum of the first modified model: ",
               format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out)$table), 1]),
               " vs. the minimum model: ",  results_susinidum_coc_alt[which(as.numeric(results_susinidum_coc_alt$cox_zph)== min(as.numeric(results_susinidum_coc_alt$cox_zph))),"cox_zph"]
))
#The minimum of the first modified model: 321.3004 vs. the minimum model: 317.3692
invisible("It improves")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_susinidum_coc_alt[which(as.numeric(results_susinidum_coc_alt$cox_zph)==
                                   min(as.numeric(results_susinidum_coc_alt$cox_zph))),]

change_points <- c(5*3, 10*3, 15*3)  # Example change points (months)
coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
# Add the time-varying coefficient to your model

data_mine_miss_restr_proc2$susinidum_coc_rec2 <- with(data_mine_miss_restr_proc2,
                                                     susinidum_coc*time_varying_coeff(time, change_points, coefficients))

model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt<-
  cph(Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod), 
      data=data_mine_miss_restr_proc2 %>% 
        data.table::as.data.table() %>% data.frame(), 
      x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table,4)
#                                  chisq df      p
# lag_tr_outcome_rec             66.7157  1 0.0000
# log_lag_dias_treat_imp_sin_na  10.3761  1 0.0013
# lag_less_90d_tr1_rec           84.1743  1 0.0000
# lag_comp_bpsc_y3_severe_rec    17.2693  1 0.0000
# lag_policonsumo2                3.1689  1 0.0751
# edad_al_ing_1                   0.1432  1 0.7051
# ano_nac_corr                    5.1839  1 0.0228
# susinidum_coc_rec2              2.9377  1 0.0865
# susinidum_oh                   19.7620  1 0.0000
# susinidum_pbc                   2.0158  1 0.1557
# susinidum_mar                   6.7590  1 0.0093
# psycom_dum_with                11.7916  1 0.0006
# psycom_dum_study                1.6349  1 0.2010
# freq_cons_dum_5day              0.0541  1 0.8161
# cond_oc_dum_2inact              4.5002  1 0.0339
# cond_oc_dum_3unemp              1.6255  1 0.2023
# susprindum_oh                   4.2826  1 0.0385
# susprindum_coc                  1.6036  1 0.2054
# susprindum_pbc                  0.0666  1 0.7964
# susprindum_mar                  5.3207  1 0.0211
# GLOBAL                        317.3692 20 0.0000

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Analyse the violation of proportional hazards")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
try(dev.off())

res240422_6_restr <- resid(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt, "scaledsch")
time240422_6_restr <- as.numeric(dimnames(res240422_6_restr)[[1]])

z_240422_6_1_restr <- loess(res240422_6_restr[,"susinidum_oh"] ~ time240422_6_restr, span=0.50)   # residuals 

par(mfrow= c(3,1))
plot(time240422_6_restr, fitted(z_240422_6_1_restr))
lines(supsmu(time240422_6_restr, res240422_6_restr[,"susinidum_oh"]),lty=2)
title("Sch. res., susinidum_coc")

plot(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)[which(attr(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt$coefficients, "names") == "susinidum_oh")], lwd=2, main= "Residuals of susinidum_oh")
abline(0,0, col="red", lty=3, lwd=2)
abline(h=model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt$coefficients["susinidum_oh"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")

km_susinidum_oh <- survfit(Surv(lag_time,time,event)~ susinidum_oh+ 
    cluster(id), data = data_mine_miss_restr_proc2)
plot(km_susinidum_oh, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"), ylab = "log-log survival", main = "log-log curves by susinidum_oh")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_susinidum_oh2_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()
```


```{r irrelong-11-iiw-weights-test-int6, warning=FALSE, echo=T, error=F, eval=T}
invisible("Now with Initial substance: Alcohol AGAIN")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_susinidum_oh2 <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(.1,1.5,.025)) {
  tvcs <- c(20,80)*i
  
  data_mine_miss_restr_proc2$susinidum_oh_rec<-
    create_time_varying_effect(data_mine_miss_restr_proc2$susinidum_oh, 
                               data_mine_miss_restr_proc2$time, 
                               tvcs[1],
                               tvcs[2],
                               max(data_mine_miss_restr_proc2$time))
  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_susinidum_oh<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh_rec +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_susinidum_oh)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_susinidum_oh)[[2]],1)
  print( paste0("Time points: ",tvcs[1],", ", tvcs[2]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_susinidum_oh)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_susinidum_oh)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_susinidum_oh2 <- rbind.data.frame(results_susinidum_oh2, 
                                             cbind.data.frame(
                                               spec = paste0("iteration: ",i, "; tvcs: ", tvcs[1],", ", tvcs[2]), 
                                               aic = aic_iter,
                                               cox_zph = cox_zph_iter,
                                               success = T
                                             ))
}

results_susinidum_oh2[which(as.numeric(results_susinidum_oh2$cox_zph)==
                               min(as.numeric(results_susinidum_oh2$cox_zph))),]
#                            spec      aic  cox_zph success
# 15 iteration: 0.45; tvcs: 9, 36 242729.5 321.3004    TRUE

results_susinidum_coc_alt[which(as.numeric(results_susinidum_coc_alt$cox_zph)==
                                    min(as.numeric(results_susinidum_coc_alt$cox_zph))),"cox_zph"]

message(paste0("The previously modified model: ",
               round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table), 1],1),
               " vs. the minimum model: ",  results_susinidum_oh2[which(as.numeric(results_susinidum_oh2$cox_zph)== min(as.numeric(results_susinidum_oh2$cox_zph))),"cox_zph"]
))
#The previously modified model: 326.3 vs. the minimum model: 1514.375
invisible("It worsen")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
require(splines)

specs_susinidum_oh <- paste0("susinidum_oh *", c("time", "log(time+0.001)", "poly(ifelse(is.na(time), .001,time), 3)", "poly(ifelse(is.na(time), .001,time), 4)", "poly(ifelse(is.na(time), .001,time), 5)", "poly(ifelse(is.na(time), .001,time), 6)", "pspline(log(time+0.001), df=3)", "pspline(log(time+0.001), df=4)", "pspline(log(time+0.001), df=5)", "pspline(log(time+0.001), df=6)", "bs(time, 3)", "bs(time, 4)", "bs(time, 5)", "bs(time, 6)", "ns(time, 3)", "ns(time, 4)", "ns(time, 5)", "ns(time, 6)", "rcs(time, 3)", "rcs(time, 4)", "rcs(time, 5)", "rcs(time, 6)"))

results_susini_oh2 <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq_along(specs_susinidum_oh)) {
  l <- specs_susinidum_oh[i]
   
  result <- tryCatch({
    model <- cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            I(round(",l,",2)) +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
                 data=data_mine_miss_restr_proc2 %>% 
                   dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec = bs(log_lag_dias_treat_imp_sin_na, 3)) %>% 
                   data.table::as.data.table() %>% data.frame(), 
                 x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
    
    aic_val <- extractAIC(model)[[2]]
    cox_zph_val <- cox.zph(model)$table[nrow(cox.zph(model)$table), 1]
    success <- TRUE 
    
  }, error = function(e) {
    aic_val <- NA
    cox_zph_val <- NA
    success <- FALSE
    warning(paste0("Error fitting specification ", i, " (", l, "): ", e))
  })
  
  results_susini_oh2 <- rbind(results_susini_oh2, data.frame(spec = l, aic = aic_val, cox_zph = cox_zph_val, success = success))
  
  print(cat(paste("Iteration:", i, "\n"))) # Add iteration number
  print(cat(paste("Spec: ", l, "\n")))
  print(cat(paste("AIC: ", results_susini_oh$aic[i], "\n"))) 
  print(cat(paste("Cox zph test statistic: ", results_susini_oh$cox_zph[i], "\n")))
}

results_susini_oh2[which(as.numeric(results_susini_oh2$cox_zph)==
                           min(as.numeric(results_susini_oh2$cox_zph))),]
#                            spec      aic cox_zph success
# 2 susinidum_oh *log(time+0.001) 241712.3 1088.12    TRUE
invisible("It worsen. We do nothing")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_susinidum_oh2_alt <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(1,5,.1)) {
  change_points <- c(5*i, 10*i, 15*i)  # Example change points (months)
  coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
  # Add the time-varying coefficient to your model
  
  data_mine_miss_restr_proc2$susinidum_oh2_rec2 <- with(data_mine_miss_restr_proc2,
                                                       susinidum_oh*time_varying_coeff(time, change_points, coefficients))

  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh2_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh2_rec2 +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh2_alt)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh2_alt)[[2]],1)
  
  print( paste0("Time points: ",change_points[1],", ", change_points[2], ", ",change_points[3]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh2_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_oh2_alt)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_susinidum_oh2_alt <- rbind.data.frame(results_susinidum_oh2_alt, 
                                                 cbind.data.frame(
                                                   spec = paste0("iteration: ",i, "; change points: ", change_points[1],", ", change_points[2], ", ",change_points[3]), 
                                                   aic = aic_iter,
                                                   cox_zph = cox_zph_iter,
                                                   success = T
                                                 ))
}

results_susinidum_oh2_alt[which(as.numeric(results_susinidum_oh2_alt$cox_zph)==
                                   min(as.numeric(results_susinidum_oh2_alt$cox_zph))),]
#                                             spec      aic cox_zph success
# 18 iteration: 2.7; change points: 13.5, 27, 40.5 242706.4  322.13    TRUE

message(paste0("The minimum of the previous model: ",
               format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table), 1]),
               " vs. the minimum model: ",  results_susinidum_oh2_alt[which(as.numeric(results_susinidum_oh2_alt$cox_zph)== min(as.numeric(results_susinidum_oh2_alt$cox_zph))),"cox_zph"]
))
#The minimum of the first modified model: 321.3004 vs. the minimum model: 328.8011

invisible("It worsens. We do not integrate this model")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Analyse the violation of proportional hazards")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

try(dev.off())

z_240422_6_2_restr <- loess(res240422_6_restr[,"psycom_dum_with"] ~ time240422_6_restr, span=0.50)   # residuals 

par(mfrow= c(3,1))
plot(time240422_6_restr, fitted(z_240422_6_2_restr))
lines(supsmu(time240422_6_restr, res240422_6_restr[,"psycom_dum_with"]),lty=2)
title("Sch. res., psycom_dum_with")

plot(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)[which(attr(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt$coefficients, "names") == "psycom_dum_with")], lwd=2, main= "Residuals of psycom_dum_with")
abline(0,0, col="red", lty=3, lwd=2)
abline(h=model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt$coefficients["psycom_dum_with"], col=3, lwd=2, lty= 3)
legend("bottomleft", legend= c("Reference line for the null effect", "Average hazard over time", "Time-varying hazard"), lty=c(3,2,1), col= c("red",3,1), lwd=2, bty = "n", bg = "transparent")

km_psycom_dum_with <- survfit(Surv(lag_time,time,event)~ psycom_dum_with+ 
    cluster(id), data = data_mine_miss_restr_proc2)
plot(km_psycom_dum_with, fun = "cloglog", xlab = "Time (in days) using log",col=c("black", "red"), ylab = "log-log survival", main = "log-log curves by psycom_dum_with")
legend("bottomright", legend=c("=0", "=1"), col=c("black", "red"), lty=1, bty = "n", bg = "transparent")

recorded_plot <- recordPlot() 

folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
png(paste0(folder_path,"zph/proportionallity_psycom_dum_with_restr.png"), height=13, width=10, res=500, units="in") 
recorded_plot
dev.off()
```

```{r irrelong-12-iiw-weights-test-int7, warning=FALSE, echo=T, error=F, eval=T}
invisible("Now with Initial substance: Alcohol")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_psycom_dum_with <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(.1,1.5,.025)) {
  tvcs <- c(20,80)*i
  
  data_mine_miss_restr_proc2$psycom_dum_with_rec<-
    create_time_varying_effect(data_mine_miss_restr_proc2$psycom_dum_with, 
                               data_mine_miss_restr_proc2$time, 
                               tvcs[1],
                               tvcs[2],
                               max(data_mine_miss_restr_proc2$time))

  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with)[[2]],1)
  print( paste0("Time points: ",tvcs[1],", ", tvcs[2]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_psycom_dum_with <- rbind.data.frame(results_psycom_dum_with, 
                                             cbind.data.frame(
                                               spec = paste0("iteration: ",i, "; tvcs: ", tvcs[1],", ", tvcs[2]), 
                                               aic = aic_iter,
                                               cox_zph = cox_zph_iter,
                                               success = T
                                             ))
}

results_psycom_dum_with[which(as.numeric(results_psycom_dum_with$cox_zph)==
                               min(as.numeric(results_psycom_dum_with$cox_zph))),]
#                            spec      aic  cox_zph success
# 17 iteration: 0.5; tvcs: 10, 40 242005.3 355.3837    TRUE

message(paste0("The previously modified model: ",
               round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table), 1],1),
               " vs. the minimum model: ",  results_psycom_dum_with[which(as.numeric(results_psycom_dum_with$cox_zph)== min(as.numeric(results_psycom_dum_with$cox_zph))),"cox_zph"]
))
#The previously modified model: 317.4 vs. the minimum model: 355.3837
invisible("It worsen")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
require(splines)

specs_psycom_dum_with_rec <- paste0("psycom_dum_with *", c("time", "log(time+0.001)", "poly(ifelse(is.na(time), .001,time), 3)", "poly(ifelse(is.na(time), .001,time), 4)", "poly(ifelse(is.na(time), .001,time), 5)", "poly(ifelse(is.na(time), .001,time), 6)", "pspline(log(time+0.001), df=3)", "pspline(log(time+0.001), df=4)", "pspline(log(time+0.001), df=5)", "pspline(log(time+0.001), df=6)", "bs(time, 3)", "bs(time, 4)", "bs(time, 5)", "bs(time, 6)", "ns(time, 3)", "ns(time, 4)", "ns(time, 5)", "ns(time, 6)", "rcs(time, 3)", "rcs(time, 4)", "rcs(time, 5)", "rcs(time, 6)"))

results_psycom_dum_with_rec <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq_along(specs_psycom_dum_with_rec)) {
  l <- specs_psycom_dum_with_rec[i]
   
  result <- tryCatch({
    model <- cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            I(round(",l,",2)) +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
                 data=data_mine_miss_restr_proc2 %>% 
                   dplyr::mutate(log_lag_dias_treat_imp_sin_na_rec = bs(log_lag_dias_treat_imp_sin_na, 3)) %>% 
                   data.table::as.data.table() %>% data.frame(), 
                 x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
    
    aic_val <- extractAIC(model)[[2]]
    cox_zph_val <- cox.zph(model)$table[nrow(cox.zph(model)$table), 1]
    success <- TRUE 
    
  }, error = function(e) {
    aic_val <- NA
    cox_zph_val <- NA
    success <- FALSE
    warning(paste0("Error fitting specification ", i, " (", l, "): ", e))
  })
  
  results_psycom_dum_with_rec <- rbind(results_psycom_dum_with_rec, data.frame(spec = l, aic = aic_val, cox_zph = cox_zph_val, success = success))
  
  print(cat(paste("Iteration:", i, "\n"))) # Add iteration number
  print(cat(paste("Spec: ", l, "\n")))
  print(cat(paste("AIC: ", results_psycom_dum_with_rec$aic[i], "\n"))) 
  print(cat(paste("Cox zph test statistic: ", results_psycom_dum_with_rec$cox_zph[i], "\n")))
}

results_psycom_dum_with_rec[which(as.numeric(results_psycom_dum_with_rec$cox_zph)==
                           min(as.numeric(results_psycom_dum_with_rec$cox_zph))),]
#                               spec      aic  cox_zph success
# 2 psycom_dum_with *log(time+0.001) 242667.5 494.8698    TRUE
invisible("It worsen. We do nothing")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_psycom_dum_with_alt <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

for (i in seq(1,5,.1)) {
  change_points <- c(5*i, 10*i, 15*i)  # Example change points (months)
  coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
  # Add the time-varying coefficient to your model
  
  data_mine_miss_restr_proc2$psycom_dum_with_rec2 <- with(data_mine_miss_restr_proc2,
                                                       psycom_dum_with*time_varying_coeff(time, change_points, coefficients))

  model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt<-
    cph(as.formula(paste0("Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod)")), 
        data=data_mine_miss_restr_proc2 %>% 
          data.table::as.data.table() %>% data.frame(), 
        x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
  
  cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt)
  invisible("")
  print(paste0("iteration: ",i))
  aic_iter <- round(extractAIC(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt)[[2]],1)
  
  print( paste0("Time points: ",change_points[1],", ", change_points[2], ", ",change_points[3]))
  print( paste0("AIC: ", aic_iter))
  cox_zph_iter <- format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt)$table), 1])
  print(paste0("Cox ZPH: ", cox_zph_iter))
  
  results_psycom_dum_with_alt <- rbind.data.frame(results_psycom_dum_with_alt, 
                                                 cbind.data.frame(
                                                   spec = paste0("iteration: ",i, "; change points: ", change_points[1],", ", change_points[2], ", ",change_points[3]), 
                                                   aic = aic_iter,
                                                   cox_zph = cox_zph_iter,
                                                   success = T
                                                 ))
}

results_psycom_dum_with_alt[which(as.numeric(results_psycom_dum_with_alt$cox_zph)==
                                   min(as.numeric(results_psycom_dum_with_alt$cox_zph))),]
#                                       spec      aic  cox_zph success
# 5 iteration: 1.4; change points: 7, 14, 21 242734.7 306.2739    TRUE

message(paste0("The minimum of the previous model: ",
               format(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table[nrow(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt)$table), 1]),
               " vs. the minimum model: ",  results_psycom_dum_with_alt[which(as.numeric(results_psycom_dum_with_alt$cox_zph)== min(as.numeric(results_psycom_dum_with_alt$cox_zph))),"cox_zph"]
))
#The minimum of the previous model: 317.3692 vs. the minimum model: 306.2739

invisible("It worsens. We do not integrate this model")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
results_psycom_dum_with_alt[which(as.numeric(results_psycom_dum_with_alt$cox_zph)==
                                   min(as.numeric(results_psycom_dum_with_alt$cox_zph))),]

change_points <- c(5, 10, 15)*1.4  # Example change points (months)
coefficients <- c(0.5, 1.5, 0.5, 1)  # Example coefficients
# Add the time-varying coefficient to your model

data_mine_miss_restr_proc2$psycom_dum_with_rec2 <- with(data_mine_miss_restr_proc2,
                                                     psycom_dum_with*time_varying_coeff(time, change_points, coefficients))

model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt<-
  cph(Surv(lag_time,time,event==1)~ 
            cluster(id)+ 
            lag_tr_outcome_rec +
            log_lag_dias_treat_imp_sin_na +
            lag_less_90d_tr1_rec+
            lag_comp_bpsc_y3_severe_rec + 
            lag_policonsumo2 + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar+
            strat(tipo_de_plan_2_mod), 
      data=data_mine_miss_restr_proc2 %>% 
        data.table::as.data.table() %>% data.frame(), 
      x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

round(cox.zph(model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt)$table,4)
#                                  chisq df      p
# lag_tr_outcome_rec             66.1801  1 0.0000 ####
# log_lag_dias_treat_imp_sin_na  10.2171  1 0.0014 #
# lag_less_90d_tr1_rec           83.7258  1 0.0000 ####
# lag_comp_bpsc_y3_severe_rec    17.1686  1 0.0000 ####
# lag_policonsumo2                3.2220  1 0.0727
# edad_al_ing_1                   0.1476  1 0.7008
# ano_nac_corr                    5.1430  1 0.0233
# susinidum_coc_rec2              2.9413  1 0.0863
# susinidum_oh                   19.6325  1 0.0000 ####
# susinidum_pbc                   1.9940  1 0.1579
# susinidum_mar                   6.7367  1 0.0094 #
# psycom_dum_with_rec2            0.7771  1 0.3780
# psycom_dum_study                1.4873  1 0.2226
# freq_cons_dum_5day              0.0522  1 0.8193
# cond_oc_dum_2inact              4.5082  1 0.0337
# cond_oc_dum_3unemp              1.6053  1 0.2051
# susprindum_oh                   4.3562  1 0.0369
# susprindum_coc                  1.6009  1 0.2058
# susprindum_pbc                  0.0568  1 0.8117
# susprindum_mar                  5.2723  1 0.0217
# GLOBAL                        306.2739 20 0.0000

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Analyse the violation of proportional hazards")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

```


##### Apply

```{r irrelong-13-iiw-weights-apply, warning=FALSE, echo=T, error=F, eval=T}
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
invisible("IIW")
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

levels_tipo_de_plan_2_mod <-attr(table(data_mine_miss_restr_proc2$tipo_de_plan_2_mod),"name")

invisible("model_restr_after_mod_not_log_lag_dias_treat_lag_less_90d_bpsc_severe_alt_tr_out_susinidum_coc_alt_psycom_dum_with_alt, make IIWs")

invisible("basic ambulatory")

iiw_model_after_ph_ba<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[1]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[1]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811/2,0,0,0,0),  #90/30.5 4.499811 es 90 días
            first= T
)

invisible("2024-05-02: problem with different values in people with plans (possibly imputed)")

dis_run_w_more_type_plan<-
data_mine_miss_restr_proc2 %>% 
    dplyr::group_by(id) %>% 
    dplyr::summarise(count_n_dis=n_distinct(tipo_de_plan_2_mod)) %>% 
    dplyr::filter(count_n_dis>1) %>% distinct(id)


summary(iiw_model_after_ph_ba$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 13471, number of events= 9113 
#    (880 observations deleted due to missingness)
# 
#                                    coef exp(coef)  se(coef) robust se       z Pr(>|z|)    
# tr_outcome_rec.lag            -0.053168  0.948220  0.057677  0.039772  -1.337  0.18128    
# log_dias_treat_imp_sin_na.lag -0.038928  0.961820  0.013773  0.015230  -2.556  0.01059 *  
# less_90d_tr1_rec.lag           0.095160  1.099835  0.073449  0.053940   1.764  0.07770 .  
# comp_bpsc_y3_severe_rec.lag    0.009360  1.009404  0.092595  0.069811   0.134  0.89335    
# policonsumo2.lag              -0.799276  0.449654  0.024645  0.019765 -40.438  < 2e-16 ***
# edad_al_ing_1                  0.023181  1.023452  0.005167  0.003189   7.268 3.64e-13 ***
# ano_nac_corr                   0.030272  1.030735  0.005099  0.003160   9.581  < 2e-16 ***
# susinidum_coc_rec2             0.113215  1.119873  0.081735  0.057953   1.954  0.05075 .  
# susinidum_oh                   0.064995  1.067154  0.064022  0.041330   1.573  0.11581    
# susinidum_pbc                 -0.091810  0.912278  0.076500  0.051320  -1.789  0.07362 .  
# susinidum_mar                  0.070750  1.073313  0.065353  0.042346   1.671  0.09477 .  
# psycom_dum_with_rec2           0.009316  1.009359  0.021927  0.012820   0.727  0.46744    
# psycom_dum_study              -0.172542  0.841523  0.032163  0.024628  -7.006 2.45e-12 ***
# freq_cons_dum_5day             0.002757  1.002760  0.024133  0.014661   0.188  0.85086    
# cond_oc_dum_2inact            -0.019184  0.980999  0.033110  0.020755  -0.924  0.35532    
# cond_oc_dum_3unemp             0.053533  1.054991  0.025441  0.016401   3.264  0.00110 ** 
# susprindum_oh                  0.004280  1.004289  0.097915  0.059290   0.072  0.94245    
# susprindum_coc                 0.167440  1.182274  0.099029  0.060961   2.747  0.00602 ** 
# susprindum_pbc                 0.166351  1.180988  0.097732  0.060049   2.770  0.00560 ** 
# susprindum_mar                 0.152467  1.164705  0.103688  0.062710   2.431  0.01504 *  
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               0.9482     1.0546    0.8771    1.0251
# log_dias_treat_imp_sin_na.lag    0.9618     1.0397    0.9335    0.9910
# less_90d_tr1_rec.lag             1.0998     0.9092    0.9895    1.2225
# comp_bpsc_y3_severe_rec.lag      1.0094     0.9907    0.8803    1.1574
# policonsumo2.lag                 0.4497     2.2239    0.4326    0.4674
# edad_al_ing_1                    1.0235     0.9771    1.0171    1.0299
# ano_nac_corr                     1.0307     0.9702    1.0244    1.0371
# susinidum_coc_rec2               1.1199     0.8930    0.9996    1.2546
# susinidum_oh                     1.0672     0.9371    0.9841    1.1572
# susinidum_pbc                    0.9123     1.0962    0.8250    1.0088
# susinidum_mar                    1.0733     0.9317    0.9878    1.1662
# psycom_dum_with_rec2             1.0094     0.9907    0.9843    1.0350
# psycom_dum_study                 0.8415     1.1883    0.8019    0.8831
# freq_cons_dum_5day               1.0028     0.9972    0.9744    1.0320
# cond_oc_dum_2inact               0.9810     1.0194    0.9419    1.0217
# cond_oc_dum_3unemp               1.0550     0.9479    1.0216    1.0895
# susprindum_oh                    1.0043     0.9957    0.8941    1.1280
# susprindum_coc                   1.1823     0.8458    1.0491    1.3323
# susprindum_pbc                   1.1810     0.8467    1.0499    1.3285
# susprindum_mar                   1.1647     0.8586    1.0300    1.3170
# 
# Concordance= 0.609  (se = 0.002 )
# Likelihood ratio test= 1284  on 20 df,   p=<2e-16
# Wald test            = 2579  on 20 df,   p=<2e-16
# Score (logrank) test = 1333  on 20 df,   p=<2e-16,   Robust = 2025  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_ba$iiw)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.5685  0.8381  1.0387  1.3327  1.8348  3.4639 

iiw_model_after_ph_ba_alt<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[1]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[1]])$id) %>% as.data.frame(),
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811,1,1,1,1),  #90/30.5 4.499811 es 90 días
            first= T
)
summary(iiw_model_after_ph_ba_alt$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 13471, number of events= 9113 
#    (880 observations deleted due to missingness)
# 
#                                    coef exp(coef)  se(coef) robust se      z Pr(>|z|)    
# tr_outcome_rec.lag             2.114216  8.283090  0.072640  0.068485 30.871  < 2e-16 ***
# log_dias_treat_imp_sin_na.lag  0.484348  1.623117  0.023209  0.028675 16.891  < 2e-16 ***
# less_90d_tr1_rec.lag           0.399869  1.491630  0.070287  0.062216  6.427 1.30e-10 ***
# comp_bpsc_y3_severe_rec.lag    0.692117  1.997940  0.055532  0.054833 12.622  < 2e-16 ***
# policonsumo2.lag              -0.009252  0.990791  0.032970  0.027511 -0.336  0.73665    
# edad_al_ing_1                  0.095935  1.100687  0.005243  0.004801 19.983  < 2e-16 ***
# ano_nac_corr                   0.101247  1.106550  0.005183  0.004728 21.415  < 2e-16 ***
# susinidum_coc_rec2             0.162364  1.176289  0.080265  0.090627  1.792  0.07320 .  
# susinidum_oh                   0.049976  1.051246  0.063197  0.057214  0.873  0.38240    
# susinidum_pbc                  0.067771  1.070120  0.075944  0.068309  0.992  0.32114    
# susinidum_mar                  0.080871  1.084231  0.064602  0.058516  1.382  0.16696    
# psycom_dum_with_rec2          -0.077395  0.925524  0.021792  0.017770 -4.355 1.33e-05 ***
# psycom_dum_study              -0.171662  0.842263  0.032046  0.030499 -5.629 1.82e-08 ***
# freq_cons_dum_5day            -0.013027  0.987058  0.024045  0.021068 -0.618  0.53636    
# cond_oc_dum_2inact            -0.005455  0.994559  0.033066  0.028766 -0.190  0.84959    
# cond_oc_dum_3unemp             0.047916  1.049082  0.025405  0.022455  2.134  0.03285 *  
# susprindum_oh                  0.124032  1.132052  0.097439  0.078021  1.590  0.11190    
# susprindum_coc                 0.176572  1.193120  0.098636  0.079742  2.214  0.02681 *  
# susprindum_pbc                 0.217877  1.243434  0.097414  0.078704  2.768  0.00563 ** 
# susprindum_mar                 0.183830  1.201811  0.103376  0.083412  2.204  0.02753 *  
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               8.2831     0.1207    7.2427    9.4730
# log_dias_treat_imp_sin_na.lag    1.6231     0.6161    1.5344    1.7170
# less_90d_tr1_rec.lag             1.4916     0.6704    1.3204    1.6851
# comp_bpsc_y3_severe_rec.lag      1.9979     0.5005    1.7944    2.2246
# policonsumo2.lag                 0.9908     1.0093    0.9388    1.0457
# edad_al_ing_1                    1.1007     0.9085    1.0904    1.1111
# ano_nac_corr                     1.1065     0.9037    1.0963    1.1169
# susinidum_coc_rec2               1.1763     0.8501    0.9849    1.4049
# susinidum_oh                     1.0512     0.9513    0.9397    1.1760
# susinidum_pbc                    1.0701     0.9345    0.9360    1.2234
# susinidum_mar                    1.0842     0.9223    0.9667    1.2160
# psycom_dum_with_rec2             0.9255     1.0805    0.8938    0.9583
# psycom_dum_study                 0.8423     1.1873    0.7934    0.8941
# freq_cons_dum_5day               0.9871     1.0131    0.9471    1.0287
# cond_oc_dum_2inact               0.9946     1.0055    0.9400    1.0522
# cond_oc_dum_3unemp               1.0491     0.9532    1.0039    1.0963
# susprindum_oh                    1.1321     0.8834    0.9715    1.3191
# susprindum_coc                   1.1931     0.8381    1.0205    1.3950
# susprindum_pbc                   1.2434     0.8042    1.0657    1.4508
# susprindum_mar                   1.2018     0.8321    1.0206    1.4153
# 
# Concordance= 0.706  (se = 0.002 )
# Likelihood ratio test= 5371  on 20 df,   p=<2e-16
# Wald test            = 5053  on 20 df,   p=<2e-16
# Score (logrank) test = 5632  on 20 df,   p=<2e-16,   Robust = 3864  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_ba_alt$iiw)
 #   Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
 # 0.0643    0.1402    0.5821    1.1179    1.4574 1294.5167 

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("GP intensive ambulatory")

iiw_model_after_ph_gp_ia<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[2]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[2]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811/2,0,0,0,0),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_gp_ia$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 15256, number of events= 10260 
#    (1237 observations deleted due to missingness)
# 
#                                    coef exp(coef)  se(coef) robust se       z Pr(>|z|)    
# tr_outcome_rec.lag             0.194561  1.214778  0.060033  0.041647   4.672 2.99e-06 ***
# log_dias_treat_imp_sin_na.lag  0.037861  1.038587  0.012193  0.011379   3.327 0.000877 ***
# less_90d_tr1_rec.lag           0.109752  1.116001  0.068389  0.049698   2.208 0.027217 *  
# comp_bpsc_y3_severe_rec.lag    0.023291  1.023564  0.058271  0.040852   0.570 0.568590    
# policonsumo2.lag              -0.865899  0.420673  0.023128  0.019879 -43.559  < 2e-16 ***
# edad_al_ing_1                  0.037553  1.038267  0.004720  0.002930  12.819  < 2e-16 ***
# ano_nac_corr                   0.042753  1.043681  0.004647  0.002895  14.771  < 2e-16 ***
# susinidum_coc_rec2             0.131486  1.140522  0.074109  0.050774   2.590 0.009607 ** 
# susinidum_oh                   0.145019  1.156062  0.058176  0.037817   3.835 0.000126 ***
# susinidum_pbc                 -0.007182  0.992844  0.068385  0.045736  -0.157 0.875226    
# susinidum_mar                  0.175201  1.191485  0.059249  0.038641   4.534 5.79e-06 ***
# psycom_dum_with_rec2           0.019278  1.019465  0.019842  0.011894   1.621 0.105056    
# psycom_dum_study              -0.242411  0.784734  0.032301  0.026523  -9.140  < 2e-16 ***
# freq_cons_dum_5day             0.018721  1.018897  0.020325  0.013005   1.439 0.150020    
# cond_oc_dum_2inact            -0.059131  0.942583  0.030582  0.019607  -3.016 0.002562 ** 
# cond_oc_dum_3unemp             0.008273  1.008307  0.021893  0.013962   0.593 0.553497    
# susprindum_oh                 -0.104867  0.900444  0.088141  0.051923  -2.020 0.043417 *  
# susprindum_coc                 0.047539  1.048688  0.088742  0.052255   0.910 0.362951    
# susprindum_pbc                 0.056574  1.058205  0.086757  0.051073   1.108 0.267988    
# susprindum_mar                 0.058619  1.060371  0.095320  0.056059   1.046 0.295721    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               1.2148     0.8232    1.1196    1.3181
# log_dias_treat_imp_sin_na.lag    1.0386     0.9628    1.0157    1.0620
# less_90d_tr1_rec.lag             1.1160     0.8961    1.0124    1.2302
# comp_bpsc_y3_severe_rec.lag      1.0236     0.9770    0.9448    1.1089
# policonsumo2.lag                 0.4207     2.3771    0.4046    0.4374
# edad_al_ing_1                    1.0383     0.9631    1.0323    1.0442
# ano_nac_corr                     1.0437     0.9581    1.0378    1.0496
# susinidum_coc_rec2               1.1405     0.8768    1.0325    1.2599
# susinidum_oh                     1.1561     0.8650    1.0735    1.2450
# susinidum_pbc                    0.9928     1.0072    0.9077    1.0860
# susinidum_mar                    1.1915     0.8393    1.1046    1.2852
# psycom_dum_with_rec2             1.0195     0.9809    0.9960    1.0435
# psycom_dum_study                 0.7847     1.2743    0.7450    0.8266
# freq_cons_dum_5day               1.0189     0.9815    0.9933    1.0452
# cond_oc_dum_2inact               0.9426     1.0609    0.9070    0.9795
# cond_oc_dum_3unemp               1.0083     0.9918    0.9811    1.0363
# susprindum_oh                    0.9004     1.1106    0.8133    0.9969
# susprindum_coc                   1.0487     0.9536    0.9466    1.1618
# susprindum_pbc                   1.0582     0.9450    0.9574    1.1696
# susprindum_mar                   1.0604     0.9431    0.9500    1.1835
# 
# Concordance= 0.625  (se = 0.002 )
# Likelihood ratio test= 1595  on 20 df,   p=<2e-16
# Wald test            = 2810  on 20 df,   p=<2e-16
# Score (logrank) test = 1706  on 20 df,   p=<2e-16,   Robust = 2370  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_gp_ia$iiw.weight)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.5251  0.9191  1.2296  1.4771  1.9988  3.7976 


iiw_model_after_ph_gp_ia_alt<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[2]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[2]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811,1,1,1,1),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_gp_ia_alt$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 15256, number of events= 10260 
#    (1237 observations deleted due to missingness)
# 
#                                    coef exp(coef)  se(coef) robust se      z Pr(>|z|)    
# tr_outcome_rec.lag             2.014920  7.500129  0.071852  0.068771 29.299  < 2e-16 ***
# log_dias_treat_imp_sin_na.lag  0.500735  1.649933  0.019681  0.026847 18.652  < 2e-16 ***
# less_90d_tr1_rec.lag           0.549827  1.732953  0.059743  0.050431 10.903  < 2e-16 ***
# comp_bpsc_y3_severe_rec.lag    0.433513  1.542667  0.048326  0.045058  9.621  < 2e-16 ***
# policonsumo2.lag               0.079196  1.082417  0.034122  0.029496  2.685  0.00725 ** 
# edad_al_ing_1                  0.107546  1.113542  0.004831  0.004325 24.868  < 2e-16 ***
# ano_nac_corr                   0.111431  1.117877  0.004759  0.004253 26.199  < 2e-16 ***
# susinidum_coc_rec2             0.103013  1.108506  0.072414  0.075162  1.371  0.17051    
# susinidum_oh                   0.102275  1.107689  0.057331  0.051648  1.980  0.04768 *  
# susinidum_pbc                  0.112886  1.119504  0.067849  0.060463  1.867  0.06190 .  
# susinidum_mar                  0.157963  1.171122  0.058585  0.052701  2.997  0.00272 ** 
# psycom_dum_with_rec2          -0.047860  0.953267  0.019768  0.015955 -3.000  0.00270 ** 
# psycom_dum_study              -0.281336  0.754775  0.031771  0.031912 -8.816  < 2e-16 ***
# freq_cons_dum_5day             0.030022  1.030478  0.020274  0.017996  1.668  0.09525 .  
# cond_oc_dum_2inact            -0.037308  0.963380  0.030618  0.026755 -1.394  0.16320    
# cond_oc_dum_3unemp             0.031426  1.031925  0.021888  0.019230  1.634  0.10222    
# susprindum_oh                 -0.085834  0.917747  0.087841  0.069617 -1.233  0.21760    
# susprindum_coc                -0.021955  0.978285  0.088512  0.070315 -0.312  0.75487    
# susprindum_pbc                 0.017908  1.018069  0.086516  0.068698  0.261  0.79435    
# susprindum_mar                -0.053078  0.948306  0.095181  0.077342 -0.686  0.49254    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               7.5001     0.1333    6.5544    8.5824
# log_dias_treat_imp_sin_na.lag    1.6499     0.6061    1.5654    1.7391
# less_90d_tr1_rec.lag             1.7330     0.5770    1.5699    1.9130
# comp_bpsc_y3_severe_rec.lag      1.5427     0.6482    1.4123    1.6851
# policonsumo2.lag                 1.0824     0.9239    1.0216    1.1468
# edad_al_ing_1                    1.1135     0.8980    1.1041    1.1230
# ano_nac_corr                     1.1179     0.8946    1.1086    1.1272
# susinidum_coc_rec2               1.1085     0.9021    0.9567    1.2844
# susinidum_oh                     1.1077     0.9028    1.0010    1.2257
# susinidum_pbc                    1.1195     0.8933    0.9944    1.2604
# susinidum_mar                    1.1711     0.8539    1.0562    1.2986
# psycom_dum_with_rec2             0.9533     1.0490    0.9239    0.9835
# psycom_dum_study                 0.7548     1.3249    0.7090    0.8035
# freq_cons_dum_5day               1.0305     0.9704    0.9948    1.0675
# cond_oc_dum_2inact               0.9634     1.0380    0.9142    1.0152
# cond_oc_dum_3unemp               1.0319     0.9691    0.9938    1.0716
# susprindum_oh                    0.9177     1.0896    0.8007    1.0519
# susprindum_coc                   0.9783     1.0222    0.8523    1.1228
# susprindum_pbc                   1.0181     0.9823    0.8898    1.1648
# susprindum_mar                   0.9483     1.0545    0.8149    1.1035
# 
# Concordance= 0.707  (se = 0.002 )
# Likelihood ratio test= 5753  on 20 df,   p=<2e-16
# Wald test            = 5237  on 20 df,   p=<2e-16
# Score (logrank) test = 5780  on 20 df,   p=<2e-16,   Robust = 4219  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_gp_ia_alt$iiw.weight)
#  Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
# 0.0678    0.1663    0.5251    1.4332    1.3754 1183.8688 

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("GP residential")

iiw_model_after_ph_gp_res<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[3]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[3]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811/2,0,0,0,0),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_gp_res$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 6745, number of events= 4567 
#    (637 observations deleted due to missingness)
# 
#                                    coef exp(coef)  se(coef) robust se       z Pr(>|z|)    
# tr_outcome_rec.lag            -0.039009  0.961742  0.105701  0.074349  -0.525 0.599808    
# log_dias_treat_imp_sin_na.lag  0.078977  1.082180  0.015647  0.013905   5.680 1.35e-08 ***
# less_90d_tr1_rec.lag           0.150856  1.162829  0.107295  0.080559   1.873 0.061122 .  
# comp_bpsc_y3_severe_rec.lag    0.353959  1.424696  0.090172  0.070675   5.008 5.49e-07 ***
# policonsumo2.lag              -0.837956  0.432594  0.035119  0.032878 -25.487  < 2e-16 ***
# edad_al_ing_1                  0.025965  1.026305  0.007319  0.004690   5.536 3.09e-08 ***
# ano_nac_corr                   0.030994  1.031479  0.007283  0.004684   6.617 3.66e-11 ***
# susinidum_coc_rec2             0.160851  1.174510  0.124649  0.094183   1.708 0.087664 .  
# susinidum_oh                   0.114160  1.120931  0.094181  0.074294   1.537 0.124391    
# susinidum_pbc                  0.009529  1.009575  0.101467  0.080150   0.119 0.905358    
# susinidum_mar                  0.103063  1.108562  0.094427  0.074787   1.378 0.168173    
# psycom_dum_with_rec2           0.071582  1.074206  0.029128  0.019756   3.623 0.000291 ***
# psycom_dum_study              -0.187465  0.829058  0.048601  0.037539  -4.994 5.92e-07 ***
# freq_cons_dum_5day            -0.017574  0.982579  0.034084  0.023154  -0.759 0.447831    
# cond_oc_dum_2inact             0.102551  1.107994  0.055537  0.038242   2.682 0.007327 ** 
# cond_oc_dum_3unemp             0.099801  1.104951  0.045743  0.031127   3.206 0.001345 ** 
# susprindum_oh                 -0.030306  0.970149  0.158516  0.107214  -0.283 0.777431    
# susprindum_coc                 0.111599  1.118064  0.159135  0.107984   1.033 0.301381    
# susprindum_pbc                 0.080561  1.083895  0.154488  0.104564   0.770 0.441033    
# susprindum_mar                 0.064293  1.066405  0.177941  0.113070   0.569 0.569619    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               0.9617     1.0398    0.8313    1.1126
# log_dias_treat_imp_sin_na.lag    1.0822     0.9241    1.0531    1.1121
# less_90d_tr1_rec.lag             1.1628     0.8600    0.9930    1.3617
# comp_bpsc_y3_severe_rec.lag      1.4247     0.7019    1.2404    1.6364
# policonsumo2.lag                 0.4326     2.3116    0.4056    0.4614
# edad_al_ing_1                    1.0263     0.9744    1.0169    1.0358
# ano_nac_corr                     1.0315     0.9695    1.0221    1.0410
# susinidum_coc_rec2               1.1745     0.8514    0.9765    1.4126
# susinidum_oh                     1.1209     0.8921    0.9690    1.2966
# susinidum_pbc                    1.0096     0.9905    0.8628    1.1813
# susinidum_mar                    1.1086     0.9021    0.9574    1.2836
# psycom_dum_with_rec2             1.0742     0.9309    1.0334    1.1166
# psycom_dum_study                 0.8291     1.2062    0.7702    0.8924
# freq_cons_dum_5day               0.9826     1.0177    0.9390    1.0282
# cond_oc_dum_2inact               1.1080     0.9025    1.0280    1.1942
# cond_oc_dum_3unemp               1.1050     0.9050    1.0396    1.1745
# susprindum_oh                    0.9701     1.0308    0.7863    1.1970
# susprindum_coc                   1.1181     0.8944    0.9048    1.3816
# susprindum_pbc                   1.0839     0.9226    0.8830    1.3304
# susprindum_mar                   1.0664     0.9377    0.8544    1.3310
# 
# Concordance= 0.618  (se = 0.003 )
# Likelihood ratio test= 644.2  on 20 df,   p=<2e-16
# Wald test            = 1048  on 20 df,   p=<2e-16
# Score (logrank) test = 689.3  on 20 df,   p=<2e-16,   Robust = 950.3  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_gp_res$iiw.weight)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.5131  0.8729  1.2617  1.3565  1.7689  6.7300 



iiw_model_after_ph_gp_res_alt<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[3]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[3]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811,1,1,1,1),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_gp_res_alt$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 6745, number of events= 4567 
#    (637 observations deleted due to missingness)
# 
#                                    coef exp(coef)  se(coef) robust se      z Pr(>|z|)    
# tr_outcome_rec.lag             0.981483  2.668410  0.120321  0.103018  9.527  < 2e-16 ***
# log_dias_treat_imp_sin_na.lag  0.328445  1.388807  0.021738  0.031862 10.308  < 2e-16 ***
# less_90d_tr1_rec.lag           0.482546  1.620195  0.097638  0.084879  5.685 1.31e-08 ***
# comp_bpsc_y3_severe_rec.lag    0.940955  2.562426  0.100147  0.088610 10.619  < 2e-16 ***
# policonsumo2.lag               0.161177  1.174893  0.054428  0.050466  3.194   0.0014 ** 
# edad_al_ing_1                  0.060548  1.062418  0.007416  0.006446  9.393  < 2e-16 ***
# ano_nac_corr                   0.063469  1.065526  0.007369  0.006388  9.936  < 2e-16 ***
# susinidum_coc_rec2             0.226938  1.254752  0.122208  0.130113  1.744   0.0811 .  
# susinidum_oh                   0.083881  1.087500  0.093000  0.086277  0.972   0.3309    
# susinidum_pbc                  0.163264  1.177348  0.100532  0.094265  1.732   0.0833 .  
# susinidum_mar                  0.107515  1.113507  0.093363  0.086830  1.238   0.2156    
# psycom_dum_with_rec2          -0.050914  0.950360  0.029484  0.024602 -2.069   0.0385 *  
# psycom_dum_study              -0.357490  0.699430  0.047553  0.046607 -7.670 1.72e-14 ***
# freq_cons_dum_5day            -0.012423  0.987654  0.033856  0.029387 -0.423   0.6725    
# cond_oc_dum_2inact             0.106389  1.112255  0.055170  0.048125  2.211   0.0271 *  
# cond_oc_dum_3unemp             0.065295  1.067474  0.045224  0.039172  1.667   0.0955 .  
# susprindum_oh                  0.101693  1.107044  0.158048  0.131136  0.775   0.4381    
# susprindum_coc                 0.046216  1.047300  0.159165  0.131835  0.351   0.7259    
# susprindum_pbc                 0.015162  1.015277  0.154594  0.127081  0.119   0.9050    
# susprindum_mar                 0.042951  1.043887  0.177913  0.138399  0.310   0.7563    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               2.6684     0.3748    2.1805    3.2654
# log_dias_treat_imp_sin_na.lag    1.3888     0.7200    1.3047    1.4783
# less_90d_tr1_rec.lag             1.6202     0.6172    1.3719    1.9134
# comp_bpsc_y3_severe_rec.lag      2.5624     0.3903    2.1539    3.0484
# policonsumo2.lag                 1.1749     0.8511    1.0642    1.2970
# edad_al_ing_1                    1.0624     0.9412    1.0491    1.0759
# ano_nac_corr                     1.0655     0.9385    1.0523    1.0790
# susinidum_coc_rec2               1.2548     0.7970    0.9723    1.6192
# susinidum_oh                     1.0875     0.9195    0.9183    1.2879
# susinidum_pbc                    1.1773     0.8494    0.9787    1.4163
# susinidum_mar                    1.1135     0.8981    0.9393    1.3201
# psycom_dum_with_rec2             0.9504     1.0522    0.9056    0.9973
# psycom_dum_study                 0.6994     1.4297    0.6384    0.7663
# freq_cons_dum_5day               0.9877     1.0125    0.9324    1.0462
# cond_oc_dum_2inact               1.1123     0.8991    1.0121    1.2223
# cond_oc_dum_3unemp               1.0675     0.9368    0.9886    1.1527
# susprindum_oh                    1.1070     0.9033    0.8561    1.4315
# susprindum_coc                   1.0473     0.9548    0.8088    1.3561
# susprindum_pbc                   1.0153     0.9850    0.7914    1.3024
# susprindum_mar                   1.0439     0.9580    0.7959    1.3692
# 
# Concordance= 0.682  (se = 0.003 )
# Likelihood ratio test= 1994  on 20 df,   p=<2e-16
# Wald test            = 2159  on 20 df,   p=<2e-16
# Score (logrank) test = 2003  on 20 df,   p=<2e-16,   Robust = 1726  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("WO intensive ambulatory")

iiw_model_after_ph_wo_ia<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[4]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[4]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811/2,0,0,0,0),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_wo_ia$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 2342, number of events= 1597 
#    (163 observations deleted due to missingness)
# 
#                                     coef  exp(coef)   se(coef)  robust se       z Pr(>|z|)    
# tr_outcome_rec.lag             0.0960769  1.1008437  0.1608893  0.1073787   0.895 0.370922    
# log_dias_treat_imp_sin_na.lag  0.0601846  1.0620325  0.0341951  0.0323800   1.859 0.063070 .  
# less_90d_tr1_rec.lag           0.3920119  1.4799554  0.1955210  0.1410453   2.779 0.005447 ** 
# comp_bpsc_y3_severe_rec.lag    0.0021099  1.0021122  0.1634728  0.1074412   0.020 0.984332    
# policonsumo2.lag              -0.8194113  0.4406910  0.0577374  0.0471515 -17.378  < 2e-16 ***
# edad_al_ing_1                  0.0264262  1.0267785  0.0120769  0.0079482   3.325 0.000885 ***
# ano_nac_corr                   0.0326238  1.0331618  0.0116686  0.0077493   4.210 2.55e-05 ***
# susinidum_coc_rec2             0.0065845  1.0066062  0.1708421  0.1250574   0.053 0.958010    
# susinidum_oh                   0.0354693  1.0361059  0.1442859  0.1006518   0.352 0.724541    
# susinidum_pbc                  0.0354305  1.0360656  0.1568797  0.1101749   0.322 0.747768    
# susinidum_mar                  0.0902561  1.0944546  0.1448738  0.0980071   0.921 0.357095    
# psycom_dum_with_rec2           0.0288659  1.0292865  0.0500612  0.0300631   0.960 0.336967    
# psycom_dum_study              -0.2367838  0.7891619  0.0863122  0.0688161  -3.441 0.000580 ***
# freq_cons_dum_5day             0.0330127  1.0335637  0.0517079  0.0316338   1.044 0.296676    
# cond_oc_dum_2inact            -0.0004428  0.9995573  0.0653684  0.0422072  -0.010 0.991630    
# cond_oc_dum_3unemp            -0.0078465  0.9921842  0.0678832  0.0425011  -0.185 0.853528    
# susprindum_oh                  0.0346128  1.0352188  0.1838352  0.1319090   0.262 0.793014    
# susprindum_coc                 0.1080539  1.1141078  0.1862425  0.1412067   0.765 0.444142    
# susprindum_pbc                 0.1142682  1.1210528  0.1808628  0.1382042   0.827 0.408346    
# susprindum_mar                 0.1072029  1.1131601  0.1989858  0.1539935   0.696 0.486334    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               1.1008     0.9084    0.8919    1.3587
# log_dias_treat_imp_sin_na.lag    1.0620     0.9416    0.9967    1.1316
# less_90d_tr1_rec.lag             1.4800     0.6757    1.1225    1.9512
# comp_bpsc_y3_severe_rec.lag      1.0021     0.9979    0.8118    1.2370
# policonsumo2.lag                 0.4407     2.2692    0.4018    0.4834
# edad_al_ing_1                    1.0268     0.9739    1.0109    1.0429
# ano_nac_corr                     1.0332     0.9679    1.0176    1.0490
# susinidum_coc_rec2               1.0066     0.9934    0.7878    1.2862
# susinidum_oh                     1.0361     0.9652    0.8506    1.2621
# susinidum_pbc                    1.0361     0.9652    0.8348    1.2858
# susinidum_mar                    1.0945     0.9137    0.9032    1.3262
# psycom_dum_with_rec2             1.0293     0.9715    0.9704    1.0918
# psycom_dum_study                 0.7892     1.2672    0.6896    0.9031
# freq_cons_dum_5day               1.0336     0.9675    0.9714    1.0997
# cond_oc_dum_2inact               0.9996     1.0004    0.9202    1.0858
# cond_oc_dum_3unemp               0.9922     1.0079    0.9129    1.0784
# susprindum_oh                    1.0352     0.9660    0.7994    1.3406
# susprindum_coc                   1.1141     0.8976    0.8448    1.4693
# susprindum_pbc                   1.1211     0.8920    0.8550    1.4698
# susprindum_mar                   1.1132     0.8983    0.8231    1.5053
# 
# Concordance= 0.627  (se = 0.005 )
# Likelihood ratio test= 226.7  on 20 df,   p=<2e-16
# Wald test            = 427.2  on 20 df,   p=<2e-16
# Score (logrank) test = 241.2  on 20 df,   p=<2e-16,   Robust = 343  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_wo_ia$iiw.weight)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.5302  0.9069  1.1501  1.3870  1.8680  3.0902 




iiw_model_after_ph_wo_ia_alt<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[4]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[4]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811,1,1,1,1),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_wo_ia_alt$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 2342, number of events= 1597 
#    (163 observations deleted due to missingness)
# 
#                                   coef exp(coef) se(coef) robust se      z Pr(>|z|)    
# tr_outcome_rec.lag             2.07668   7.97793  0.18951   0.17050 12.180  < 2e-16 ***
# log_dias_treat_imp_sin_na.lag  0.48119   1.61800  0.04878   0.05862  8.208 2.24e-16 ***
# less_90d_tr1_rec.lag           0.53253   1.70324  0.15975   0.12591  4.230 2.34e-05 ***
# comp_bpsc_y3_severe_rec.lag    0.24739   1.28067  0.13099   0.12212  2.026  0.04280 *  
# policonsumo2.lag              -0.06660   0.93557  0.07911   0.07156 -0.931  0.35204    
# edad_al_ing_1                  0.10711   1.11305  0.01271   0.01175  9.116  < 2e-16 ***
# ano_nac_corr                   0.11118   1.11759  0.01230   0.01146  9.705  < 2e-16 ***
# susinidum_coc_rec2            -0.19912   0.81945  0.16603   0.16462 -1.210  0.22642    
# susinidum_oh                  -0.24978   0.77897  0.14191   0.12065 -2.070  0.03842 *  
# susinidum_pbc                 -0.07015   0.93225  0.15381   0.13115 -0.535  0.59273    
# susinidum_mar                 -0.14500   0.86502  0.14235   0.11908 -1.218  0.22334    
# psycom_dum_with_rec2          -0.03390   0.96667  0.05027   0.04078 -0.831  0.40585    
# psycom_dum_study              -0.22053   0.80210  0.08298   0.08202 -2.689  0.00717 ** 
# freq_cons_dum_5day             0.03082   1.03130  0.05150   0.04617  0.668  0.50442    
# cond_oc_dum_2inact             0.02049   1.02070  0.06522   0.06013  0.341  0.73326    
# cond_oc_dum_3unemp            -0.01038   0.98968  0.06734   0.06267 -0.166  0.86850    
# susprindum_oh                  0.03448   1.03508  0.18281   0.17658  0.195  0.84517    
# susprindum_coc                 0.06938   1.07184  0.18629   0.18800  0.369  0.71210    
# susprindum_pbc                 0.11002   1.11631  0.18066   0.18587  0.592  0.55390    
# susprindum_mar                 0.05398   1.05546  0.19901   0.20360  0.265  0.79092    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               7.9779     0.1253    5.7117   11.1434
# log_dias_treat_imp_sin_na.lag    1.6180     0.6180    1.4424    1.8150
# less_90d_tr1_rec.lag             1.7032     0.5871    1.3308    2.1799
# comp_bpsc_y3_severe_rec.lag      1.2807     0.7808    1.0081    1.6270
# policonsumo2.lag                 0.9356     1.0689    0.8131    1.0764
# edad_al_ing_1                    1.1131     0.8984    1.0877    1.1390
# ano_nac_corr                     1.1176     0.8948    1.0928    1.1430
# susinidum_coc_rec2               0.8194     1.2203    0.5935    1.1315
# susinidum_oh                     0.7790     1.2837    0.6149    0.9868
# susinidum_pbc                    0.9323     1.0727    0.7209    1.2055
# susinidum_mar                    0.8650     1.1560    0.6850    1.0924
# psycom_dum_with_rec2             0.9667     1.0345    0.8924    1.0471
# psycom_dum_study                 0.8021     1.2467    0.6830    0.9420
# freq_cons_dum_5day               1.0313     0.9696    0.9421    1.1290
# cond_oc_dum_2inact               1.0207     0.9797    0.9072    1.1484
# cond_oc_dum_3unemp               0.9897     1.0104    0.8753    1.1190
# susprindum_oh                    1.0351     0.9661    0.7323    1.4631
# susprindum_coc                   1.0718     0.9330    0.7415    1.5494
# susprindum_pbc                   1.1163     0.8958    0.7755    1.6069
# susprindum_mar                   1.0555     0.9475    0.7082    1.5731
# 
# Concordance= 0.697  (se = 0.006 )
# Likelihood ratio test= 817.7  on 20 df,   p=<2e-16
# Wald test            = 852.1  on 20 df,   p=<2e-16
# Score (logrank) test = 848  on 20 df,   p=<2e-16,   Robust = 632.9  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_wo_ia_alt$iiw.weight)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.1065  0.2508  0.7104  1.3025  1.8834 27.4746 


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("WO residential")

iiw_model_after_ph_wo_res<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[5]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[5]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811/2,0,0,0,0),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_wo_res$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 3189, number of events= 2153 
#    (381 observations deleted due to missingness)
# 
#                                    coef exp(coef)  se(coef) robust se       z Pr(>|z|)    
# tr_outcome_rec.lag            -0.126675  0.881020  0.163284  0.124402  -1.018 0.308550    
# log_dias_treat_imp_sin_na.lag  0.031652  1.032159  0.022850  0.021963   1.441 0.149546    
# less_90d_tr1_rec.lag           0.363190  1.437908  0.157358  0.121227   2.996 0.002736 ** 
# comp_bpsc_y3_severe_rec.lag    0.349023  1.417682  0.139042  0.107539   3.246 0.001172 ** 
# policonsumo2.lag              -0.778676  0.459014  0.050648  0.044979 -17.312  < 2e-16 ***
# edad_al_ing_1                  0.023880  1.024168  0.010199  0.006895   3.463 0.000534 ***
# ano_nac_corr                   0.030909  1.031392  0.009928  0.006625   4.666 3.07e-06 ***
# susinidum_coc_rec2             0.353985  1.424734  0.156986  0.101414   3.490 0.000482 ***
# susinidum_oh                   0.291847  1.338899  0.132369  0.078022   3.741 0.000184 ***
# susinidum_pbc                  0.186272  1.204750  0.138703  0.088234   2.111 0.034763 *  
# susinidum_mar                  0.294218  1.342076  0.132819  0.078394   3.753 0.000175 ***
# psycom_dum_with_rec2           0.075649  1.078584  0.048007  0.033882   2.233 0.025566 *  
# psycom_dum_study              -0.341685  0.710572  0.070190  0.057146  -5.979 2.24e-09 ***
# freq_cons_dum_5day            -0.020624  0.979587  0.050671  0.033925  -0.608 0.543239    
# cond_oc_dum_2inact             0.011996  1.012068  0.081341  0.053444   0.224 0.822402    
# cond_oc_dum_3unemp             0.076550  1.079556  0.081384  0.054527   1.404 0.160354    
# susprindum_oh                 -0.077120  0.925778  0.148321  0.077766  -0.992 0.321346    
# susprindum_coc                 0.072353  1.075035  0.149194  0.083542   0.866 0.386453    
# susprindum_pbc                -0.011860  0.988210  0.140132  0.073586  -0.161 0.871956    
# susprindum_mar                 0.154065  1.166566  0.210712  0.124652   1.236 0.216472    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               0.8810     1.1350    0.6904    1.1243
# log_dias_treat_imp_sin_na.lag    1.0322     0.9688    0.9887    1.0776
# less_90d_tr1_rec.lag             1.4379     0.6955    1.1338    1.8236
# comp_bpsc_y3_severe_rec.lag      1.4177     0.7054    1.1483    1.7503
# policonsumo2.lag                 0.4590     2.1786    0.4203    0.5013
# edad_al_ing_1                    1.0242     0.9764    1.0104    1.0381
# ano_nac_corr                     1.0314     0.9696    1.0181    1.0449
# susinidum_coc_rec2               1.4247     0.7019    1.1679    1.7380
# susinidum_oh                     1.3389     0.7469    1.1490    1.5601
# susinidum_pbc                    1.2047     0.8300    1.0134    1.4322
# susinidum_mar                    1.3421     0.7451    1.1509    1.5650
# psycom_dum_with_rec2             1.0786     0.9271    1.0093    1.1526
# psycom_dum_study                 0.7106     1.4073    0.6353    0.7948
# freq_cons_dum_5day               0.9796     1.0208    0.9166    1.0469
# cond_oc_dum_2inact               1.0121     0.9881    0.9114    1.1238
# cond_oc_dum_3unemp               1.0796     0.9263    0.9701    1.2013
# susprindum_oh                    0.9258     1.0802    0.7949    1.0782
# susprindum_coc                   1.0750     0.9302    0.9127    1.2663
# susprindum_pbc                   0.9882     1.0119    0.8555    1.1415
# susprindum_mar                   1.1666     0.8572    0.9137    1.4894
# 
# Concordance= 0.612  (se = 0.005 )
# Likelihood ratio test= 298.2  on 20 df,   p=<2e-16
# Wald test            = 480.2  on 20 df,   p=<2e-16
# Score (logrank) test = 312.9  on 20 df,   p=<2e-16,   Robust = 428.9  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_wo_res$iiw.weight)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.4578  0.8652  1.2333  1.3288  1.6967  4.6168 




iiw_model_after_ph_wo_res_alt<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome_rec.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1_rec.lag+
            comp_bpsc_y3_severe_rec.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc_rec2 +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with_rec2 +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod== levels_tipo_de_plan_2_mod[[5]]) %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= subset(maxfu_restr_df, subset=  maxfu.id %in% subset(data_mine_miss_restr_proc2, tipo_de_plan_2_mod==levels_tipo_de_plan_2_mod[[5]])$id) %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc_rec2", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with_rec2", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome_rec", "comp_bpsc_y3_severe_rec", "less_90d_tr1_rec", "policonsumo2"),
            lagfirst= c(2.95082,4.499811,1,1,1,1),  #90/30.5 4.499811 es 90 días
            first= T
)

summary(iiw_model_after_ph_wo_res_alt$m)
# Call:
# coxph(formula = Surv(time.lag, time, event) ~ tr_outcome_rec.lag + 
#     log_dias_treat_imp_sin_na.lag + less_90d_tr1_rec.lag + comp_bpsc_y3_severe_rec.lag + 
#     policonsumo2.lag + edad_al_ing_1 + ano_nac_corr + susinidum_coc_rec2 + 
#     susinidum_oh + susinidum_pbc + susinidum_mar + psycom_dum_with_rec2 + 
#     psycom_dum_study + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar, data = datacox, cluster = id)
# 
#   n= 3189, number of events= 2153 
#    (381 observations deleted due to missingness)
# 
#                                     coef  exp(coef)   se(coef)  robust se      z Pr(>|z|)    
# tr_outcome_rec.lag             0.7205801  2.0556254  0.1852413  0.1688667  4.267 1.98e-05 ***
# log_dias_treat_imp_sin_na.lag  0.2567171  1.2926793  0.0273630  0.0340385  7.542 4.63e-14 ***
# less_90d_tr1_rec.lag           0.6130288  1.8460141  0.1493355  0.1272692  4.817 1.46e-06 ***
# comp_bpsc_y3_severe_rec.lag    0.8473593  2.3334766  0.1535169  0.1444312  5.867 4.44e-09 ***
# policonsumo2.lag               0.0184737  1.0186454  0.0734914  0.0667181  0.277   0.7819    
# edad_al_ing_1                  0.0575836  1.0592739  0.0104369  0.0089922  6.404 1.52e-10 ***
# ano_nac_corr                   0.0650981  1.0672637  0.0101748  0.0087168  7.468 8.14e-14 ***
# susinidum_coc_rec2             0.3116140  1.3656274  0.1602666  0.1367453  2.279   0.0227 *  
# susinidum_oh                   0.1895267  1.2086774  0.1337491  0.0914487  2.072   0.0382 *  
# susinidum_pbc                  0.1983614  1.2194030  0.1404151  0.1021221  1.942   0.0521 .  
# susinidum_mar                  0.1989101  1.2200723  0.1343948  0.0922898  2.155   0.0311 *  
# psycom_dum_with_rec2          -0.0087068  0.9913310  0.0483988  0.0404580 -0.215   0.8296    
# psycom_dum_study              -0.3746894  0.6875028  0.0680287  0.0652967 -5.738 9.57e-09 ***
# freq_cons_dum_5day             0.0004056  1.0004056  0.0506595  0.0444514  0.009   0.9927    
# cond_oc_dum_2inact             0.0813419  1.0847417  0.0809746  0.0759279  1.071   0.2840    
# cond_oc_dum_3unemp             0.1300692  1.1389072  0.0814469  0.0765984  1.698   0.0895 .  
# susprindum_oh                 -0.1079311  0.8976894  0.1483977  0.1155415 -0.934   0.3502    
# susprindum_coc                 0.0027078  1.0027114  0.1498413  0.1207600  0.022   0.9821    
# susprindum_pbc                -0.0637471  0.9382423  0.1407408  0.1099733 -0.580   0.5621    
# susprindum_mar                -0.0838286  0.9195888  0.2112160  0.1592995 -0.526   0.5987    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
#                               exp(coef) exp(-coef) lower .95 upper .95
# tr_outcome_rec.lag               2.0556     0.4865    1.4764    2.8621
# log_dias_treat_imp_sin_na.lag    1.2927     0.7736    1.2093    1.3819
# less_90d_tr1_rec.lag             1.8460     0.5417    1.4385    2.3690
# comp_bpsc_y3_severe_rec.lag      2.3335     0.4285    1.7582    3.0970
# policonsumo2.lag                 1.0186     0.9817    0.8938    1.1610
# edad_al_ing_1                    1.0593     0.9440    1.0408    1.0781
# ano_nac_corr                     1.0673     0.9370    1.0492    1.0857
# susinidum_coc_rec2               1.3656     0.7323    1.0446    1.7854
# susinidum_oh                     1.2087     0.8274    1.0103    1.4459
# susinidum_pbc                    1.2194     0.8201    0.9982    1.4896
# susinidum_mar                    1.2201     0.8196    1.0182    1.4620
# psycom_dum_with_rec2             0.9913     1.0087    0.9158    1.0731
# psycom_dum_study                 0.6875     1.4545    0.6049    0.7814
# freq_cons_dum_5day               1.0004     0.9996    0.9169    1.0915
# cond_oc_dum_2inact               1.0847     0.9219    0.9348    1.2588
# cond_oc_dum_3unemp               1.1389     0.8780    0.9801    1.3234
# susprindum_oh                    0.8977     1.1140    0.7158    1.1258
# susprindum_coc                   1.0027     0.9973    0.7914    1.2705
# susprindum_pbc                   0.9382     1.0658    0.7563    1.1639
# susprindum_mar                   0.9196     1.0874    0.6730    1.2566
# 
# Concordance= 0.666  (se = 0.005 )
# Likelihood ratio test= 814.4  on 20 df,   p=<2e-16
# Wald test            = 982.1  on 20 df,   p=<2e-16
# Score (logrank) test = 834.4  on 20 df,   p=<2e-16,   Robust = 780.6  p=<2e-16
# 
#   (Note: the likelihood ratio and score tests assume independence of
#      observations within a cluster, the Wald and robust score tests do not).

summary(iiw_model_after_ph_wo_res_alt$iiw.weight)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.1235  0.2374  0.5581  0.8884  1.2695 52.2809 
```

```{r irrelong-14-iiw-weights-apply2, warning=FALSE, echo=T, error=F, eval=T}
data_mine_miss_restr_proc2_iiw_after_ph <- NULL # Initialize empty result

df_models_after_ph<-
cbind.data.frame(tipo_de_plan_2= attr(table(data_mine_miss_restr_proc2$tipo_de_plan_2_mod),"names"), 
                 models_after_ph= c("iiw_model_after_ph_ba", 
                                    "iiw_model_after_ph_gp_ia", 
                                    "iiw_model_after_ph_gp_res", 
                                    "iiw_model_after_ph_wo_ia", 
                                    "iiw_model_after_ph_wo_res"))

  for (i in 1:nrow(df_models_after_ph)) {
    subset_data0 <- subset(dplyr::mutate(data_mine_miss_restr_proc2, rn=dplyr::row_number()), subset= tipo_de_plan_2_mod== df_models_after_ph[i,1])
    
    subset_data02<- cbind.data.frame(subset_data0, iiw_after_ph= get(df_models_after_ph[i,2])$iiw.weight)
    
    data_mine_miss_restr_proc2_iiw_after_ph <- rbind.data.frame(data_mine_miss_restr_proc2_iiw_after_ph, subset_data02)
  }

#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_

data_mine_miss_restr_proc2_iiw_after_ph_alt <- NULL # Initialize empty result

df_models_after_ph_alt<-
cbind.data.frame(tipo_de_plan_2= attr(table(data_mine_miss_restr_proc2$tipo_de_plan_2_mod),"names"), 
                 models_after_ph= paste0(c("iiw_model_after_ph_ba", 
                                    "iiw_model_after_ph_gp_ia", 
                                    "iiw_model_after_ph_gp_res", 
                                    "iiw_model_after_ph_wo_ia", 
                                    "iiw_model_after_ph_wo_res"),"_alt"))
  for (i in 1:nrow(df_models_after_ph_alt)) {
    subset_data00 <- subset(dplyr::mutate(data_mine_miss_restr_proc2, rn=dplyr::row_number()), subset= tipo_de_plan_2_mod== df_models_after_ph_alt[i,1])
    
    subset_data002<- cbind.data.frame(subset_data00, iiw_after_ph= get(df_models_after_ph_alt[i,2])$iiw.weight)
    
    data_mine_miss_restr_proc2_iiw_after_ph_alt <- rbind.data.frame(data_mine_miss_restr_proc2_iiw_after_ph_alt, subset_data002)
  }

summary(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.4578  0.8791  1.1600  1.3930  1.8724  6.7300 

summary(data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph)
#  Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
# 0.0643    0.1688    0.5455    1.1908    1.3579 1294.5167 

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Stabilize weights")
data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph_st<-data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph
data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph_st[data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph>quantile(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph,0.975)] <- quantile(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph,0.975)
data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph_st[data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph<quantile(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph,0.025)] <- quantile(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph,0.025)

invisible("stabilize alternative weights")
data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph_st<-data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph
data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph_st[data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph>quantile(data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph,0.975)] <- quantile(data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph,0.975)
data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph_st[data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph<quantile(data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph,0.025)] <- quantile(data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph,0.025)


summary(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph_st)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.6912  0.8791  1.1600  1.3873  1.8724  2.5741 

summary(data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph_st)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.09766 0.16882 0.54545 0.88019 1.35785 3.56260 


rbind.data.frame(
cbind.data.frame(model= "Primary (after PH, lag=0)", t(matrix(summary(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph_st)))),
cbind.data.frame(model= "Alternative (after PH, lag=1)", t(matrix(summary(data_mine_miss_restr_proc2_iiw_after_ph_alt$iiw_after_ph_st)))))%>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/iiw_after_ph_240426.csv"), dec=",", sep="\t")
    knitr::kable(., size=10, format="markdown", caption="Weights (after correction for PHs)", col.names= c("Weight",attr(summary(data_mine_miss_restr_proc2_iiw_after_ph$iiw_after_ph_st),"names")) ) 
  }
```

##### GEE

::: center-table
```{r irrelong-15a-iiw-weights-gee1, warning=T, echo=T, error=F, eval=T}
#The id= option is where we specify the clusters within which we have repeated observations that may be correlated, and tehe scale.fix=T option is to avoid R's default approach of introducing an overdispersion scale parameter.
#However, caution is advised when employing QIC and its use should not be routine, see Wang et al. (2015). growing use of quasi-likelihood-based information criteria for longitudinal data to select a working correlation structure in a generalized estimating equation framework. [https://onlinelibrary.wiley.com/doi/full/10.1002/sta4.95]

#poisson(link = "log"),

#https://www.thelancet.com/cms/10.1016/S2468-2667(22)00042-1/attachment/eb69ffc4-cb6c-4a47-9524-94e1ba9302b2/mmc1.pdf
#https://www.thelancet.com/cms/10.1016/S2468-2667(22)00201-8/attachment/05a17ae1-1e31-4ffd-a727-78ec915dc03b/mmc1.pdf

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("Must be independence structure")

m <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
id=id, data=data_mine_miss_restr_proc2_iiw_after_ph, family=binomial, corstr="independence")
summary(m)

m_full <- geeglm( tr_outcome  ~ policonsumo2 +
          comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2_iiw_after_ph, family=binomial, corstr="independence") 


rbind.data.frame(cbind.data.frame(model="simplest", broom::tidy(m, exponentiate = T, conf.int=T)),cbind.data.frame(model="full", broom::tidy(m_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/gee_240502.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models (after correction for PHs)") 
  }
```
:::

::: center-table
```{r irrelong-15b-iiw-weights-geew, warning=T, echo=T, error=F, eval=T}
data_mine_miss_restr_proc2_iiw_after_ph$edad_al_ing_1_st = data_mine_miss_restr_proc2_iiw_after_ph$edad_al_ing_1 - mean(data_mine_miss_restr_proc2_iiw_after_ph$edad_al_ing_1)

# can use to fit a weighted GEE
mw <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2_iiw_after_ph, family= binomial, weights=iiw_after_ph_st, corstr="independence")
#In eval(family$initialize) : non-integer #successes in a binomial glm!
#summary(mw)

mwpois <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2_iiw_after_ph, family= poisson(link = "log"), weights=iiw_after_ph_st, corstr="independence")
summary(mwpois)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

mw_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2_iiw_after_ph, family=binomial, weights=iiw_after_ph_st, corstr="independence") 
#In eval(family$initialize) : non-integer #successes in a binomial glm!


mwpois_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2_iiw_after_ph, family= poisson(link = "log"), weights=iiw_after_ph_st, corstr="independence") 

invisible("Model fit")
#broom::glance(mwpois_full)
#QIC(mw)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

rbind.data.frame(cbind.data.frame(model="simplest, binomial", broom::tidy(mw, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, binomial", broom::tidy(mw_full, exponentiate = T, conf.int=T)),cbind.data.frame(model="simplest, poisson", broom::tidy(mwpois, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, poisson", broom::tidy(mwpois_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/geew_240502.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models, weighted (after correction for PHs)") 
  }
```
:::


::: center-table
```{r irrelong-15c-iiw-weights-geew-alt, warning=T, echo=T, error=F, eval=T}

# can use to fit a weighted GEE
mw_alt <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2_iiw_after_ph_alt, family= binomial, weights=iiw_after_ph_st, corstr="independence")
#In eval(family$initialize) : non-integer #successes in a binomial glm!
#summary(mw)

mwpois_alt <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2_iiw_after_ph_alt, family= poisson(link = "log"), weights=iiw_after_ph_st, corstr="independence")
summary(mwpois)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

mw_alt_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2_iiw_after_ph_alt, family=binomial, weights=iiw_after_ph_st, corstr="independence") 
#In eval(family$initialize) : non-integer #successes in a binomial glm!


mwpois_alt_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2_iiw_after_ph_alt, family= poisson(link = "log"), weights=iiw_after_ph_st, corstr="independence") 

invisible("Model fit")
#broom::glance(mwpois_full)
#QIC(mw)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

rbind.data.frame(cbind.data.frame(model="simplest, binomial", broom::tidy(mw_alt, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, binomial", broom::tidy(mw_alt_full, exponentiate = T, conf.int=T)),cbind.data.frame(model="simplest, poisson", broom::tidy(mwpois_alt, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, poisson", broom::tidy(mwpois_alt_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/geew_alt_240502.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models, alternative weighting (after correction for PHs)") 
  }
```
:::


#### Stratifying

```{r irrelong-16-iiw-weights-test-strat, warning=FALSE, echo=T, error=T, eval=T}
# Define possible sets of breakpoints
set.seed(2125)
samp1<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2121)
samp2<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2121e4)
samp3<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2121e2)
samp4<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2121e3)
samp5<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(212e3)
samp6<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(212e4)
samp7<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(21e4)
samp8<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(21e6)
samp9<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(21e8)
samp10<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(1e2)
samp11<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(1e3)
samp12<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(1e4)
samp13<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(1e7)
samp14<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(1e5)
samp15<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(1)
samp16<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2)
samp17<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(3)
samp17<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(4)
samp18<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(5)
samp19<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(6)
samp20<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(217e2)
samp21<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(215e2)
samp22<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(214e2)
samp23<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(213e2)
samp24<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(212e2)
samp25<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(211e2)
samp26<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2111e3)
samp27<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2112e3)
samp28<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2113e3)
samp29<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))
set.seed(2114e3)
samp30<- sort(c(0,sample.int(max(data_mine_miss_restr_proc2$time)-1, 5, replace = F),max(data_mine_miss_restr_proc2$time)))


breaks_list <- list(
  c(0, 10, 20, 40, 60, 80, max(data_mine_miss_restr_proc2$time)),
  c(0, 15, 30, 45, 60, 75, max(data_mine_miss_restr_proc2$time)),
  c(0, 15, 30, 45, 60, 80, max(data_mine_miss_restr_proc2$time)),
  c(0, 20, 40, 60, 80, 100, max(data_mine_miss_restr_proc2$time)),
    # Unevenly spaced, emphasizing early times
  c(0, 10, 20, 30, 50, 70, max(data_mine_miss_restr_proc2$time)),
  # Long tail distribution
  c(0, 20, 40, 60, 80, 100, 150, max(data_mine_miss_restr_proc2$time)),
  # Quantile-based intervals (ensure you have no NA in `time`)
  quantile(data_mine_miss_restr_proc2$time, probs = seq(0, 1, by = 0.2), na.rm = TRUE),
  samp1, 
  samp2, 
  samp3, 
  samp4, 
  samp5,
  samp6,
  samp7,
  samp8,
  samp9, 
  samp10,
  samp11, 
  samp12, 
  samp13, 
  samp14, 
  samp15,
  samp16,
  samp17,
  samp18,
  samp19, 
  samp20,  
  samp21, 
  samp22, 
  samp23, 
  samp24, 
  samp25,
  samp26,
  samp27,
  samp28,
  samp29, 
  samp30
)

# Prepare to store results
results_strat <- list()

# Loop over the list of breakpoints
for (i in seq_along(breaks_list)) {
  # Create the factor variable with the current set of time intervals
  data_mine_miss_restr_proc2$time_interval2 <- cut(data_mine_miss_restr_proc2$time, breaks_list[[i]], include.lowest = TRUE)
  # Fit the Cox model
  model<-
  cph(as.formula(paste0("Surv(lag_time,time,event)~ 
          cluster(id)+ 
          lag_tr_outcome+
          lag_comp_bpsc_y3_severe+
          lag_less_90d_tr1+
          log_lag_dias_treat_imp_sin_na +
          lag_policonsumo2 + 
          edad_al_ing_1 + 
          ano_nac_corr + 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar +
          psycom_dum_study +
          psycom_dum_with +
          freq_cons_dum_5day +
          cond_oc_dum_2inact +
          cond_oc_dum_3unemp +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar +
          strat(tipo_de_plan_2_mod)+
          strat(time_interval2)")), 
    data= data_mine_miss_restr_proc2 %>% data.table::as.data.table() %>% data.frame(), x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)

  # Perform cox.zph test
  cox_test <- format(cox.zph(model)$table[nrow(cox.zph(model)$table), 1])
  
  # Create a contingency table
  contingency_table <- table(data_mine_miss_restr_proc2$time_interval2, data_mine_miss_restr_proc2$tipo_de_plan_2)
  
  # Store results
  results_strat[[i]] <- list(
    AIC = AIC(model),
    cox_zph = cox_test,
    table = contingency_table,
    fail= model$fail,
    lrtest= paste0(model$stats["Model L.R."],", ",model$stats["d.f."]," p=", model$stats["P"]),
    r2= model$stats["R2"]
  )
}

# You can now inspect 'results' for the output from each set of breakpoints
print(results_strat)

print(results_strat[[2]])
#117
invisible("El original X2= 430.6824, df=18, p< 2e-16; ")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("SELECTY INTERVAL TIME TO STRATIFY")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/selected_models_strat.R")
# Create a factor variable with time intervals
data_mine_miss_restr_proc2$time_interval3 <- cut(data_mine_miss_restr_proc2$time, 
                                                 breaks_list[[17]][c(1:3,7)], 
                                                 include.lowest = TRUE)

#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:
model_after_time_strat<-
cph(Surv(lag_time,time,event)~
          cluster(id)+ 
          lag_tr_outcome+
          lag_comp_bpsc_y3_severe+
          lag_less_90d_tr1+
          log_lag_dias_treat_imp_sin_na +
          lag_policonsumo2 + 
          edad_al_ing_1 + 
          ano_nac_corr + 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar +
          psycom_dum_study +
          psycom_dum_with +
          freq_cons_dum_5day +
          cond_oc_dum_2inact +
          cond_oc_dum_3unemp +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar +
          strat(tipo_de_plan_2_mod)+
          strat(time_interval3),
    data= data_mine_miss_restr_proc2 %>% data.table::as.data.table() %>% data.frame(), 
    x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
# 
model_after_time_strat
# Cox Proportional Hazards Model
# 
# cph(formula = Surv(lag_time, time, event) ~ cluster(id) + lag_tr_outcome + 
#     lag_comp_bpsc_y3_severe + lag_less_90d_tr1 + log_lag_dias_treat_imp_sin_na + 
#     lag_policonsumo2 + edad_al_ing_1 + ano_nac_corr + susinidum_oh + 
#     susinidum_coc + susinidum_pbc + susinidum_mar + psycom_dum_study + 
#     psycom_dum_with + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar + strat(tipo_de_plan_2_mod) + strat(time_interval3), 
#     data = data_mine_miss_restr_proc2 %>% data.table::as.data.table() %>% 
#         data.frame(), x = TRUE, y = TRUE, iter.max = 250 * 4, 
#     tol = 1e-06, surv = TRUE)
# 
# 
#                                                                     Status
# Stratum                                                              No Event Event
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3=[0,88]                 0  5356
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3=[0,88]          0  6212
#   tipo_de_plan_2_mod=GP residential.time_interval3=[0,88]                   0  2895
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3=[0,88]          0   964
#   tipo_de_plan_2_mod=WO residential.time_interval3=[0,88]                   0  1451
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3=(88,93]                0    77
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3=(88,93]         0    74
#   tipo_de_plan_2_mod=GP residential.time_interval3=(88,93]                  0    44
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3=(88,93]         0    10
#   tipo_de_plan_2_mod=WO residential.time_interval3=(88,93]                  0    13
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3=(93,135]               0   200
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3=(93,135]        0   213
#   tipo_de_plan_2_mod=GP residential.time_interval3=(93,135]                 0    87
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3=(93,135]        0    41
#   tipo_de_plan_2_mod=WO residential.time_interval3=(93,135]                 0    34
# 
#                        Model Tests       Discrimination    
#                                                 Indexes    
# Obs    17671    LR chi2    2722.85       R2       0.143    
# Events 17671    d.f.            20    R2(20,17671)0.142    
# Center   402    Pr(> chi2)  0.0000       Dxy      0.256    
#                 Score chi2 2731.11                         
#                 Pr(> chi2)  0.0000                         
# 
#                               Coef    S.E.   Wald Z Pr(>|Z|)
# lag_tr_outcome                 0.1374 0.0182  7.55  <0.0001 
# lag_comp_bpsc_y3_severe        0.0508 0.0169  3.00  0.0027  
# lag_less_90d_tr1               0.1048 0.0252  4.16  <0.0001 
# log_lag_dias_treat_imp_sin_na -0.0197 0.0110 -1.79  0.0733  
# lag_policonsumo2              -0.0206 0.0191 -1.07  0.2828  
# edad_al_ing_1                  0.1987 0.0038 52.28  <0.0001 
# ano_nac_corr                   0.1997 0.0037 53.44  <0.0001 
# susinidum_oh                   0.0440 0.0483  0.91  0.3623  
# susinidum_coc                  0.1127 0.0595  1.89  0.0582  
# susinidum_pbc                  0.1409 0.0545  2.58  0.0098  
# susinidum_mar                  0.1610 0.0492  3.27  0.0011  
# psycom_dum_study               0.0132 0.0231  0.57  0.5691  
# psycom_dum_with                0.0145 0.0164  0.89  0.3759  
# freq_cons_dum_5day             0.0094 0.0160  0.59  0.5556  
# cond_oc_dum_2inact             0.0757 0.0218  3.47  0.0005  
# cond_oc_dum_3unemp             0.0841 0.0176  4.79  <0.0001 
# susprindum_oh                 -0.0798 0.0679 -1.18  0.2398  
# susprindum_coc                -0.0757 0.0687 -1.10  0.2708  
# susprindum_pbc                -0.0578 0.0675 -0.86  0.3917  
# susprindum_mar                -0.0801 0.0744 -1.08  0.2814  

cox.zph(model_after_time_strat)
#                                 chisq df       p
# lag_tr_outcome                 60.354  1 7.9e-15
# lag_comp_bpsc_y3_severe        20.528  1 5.9e-06
# lag_less_90d_tr1              151.524  1 < 2e-16
# log_lag_dias_treat_imp_sin_na 160.971  1 < 2e-16
# lag_policonsumo2                5.712  1 0.01685
# edad_al_ing_1                  31.506  1 2.0e-08
# ano_nac_corr                   19.244  1 1.2e-05
# susinidum_oh                   35.309  1 2.8e-09
# susinidum_coc                   0.931  1 0.33456
# susinidum_pbc                  10.487  1 0.00120
# susinidum_mar                  17.059  1 3.6e-05
# psycom_dum_study               51.800  1 6.1e-13
# psycom_dum_with                18.230  1 2.0e-05
# freq_cons_dum_5day              3.577  1 0.05860
# cond_oc_dum_2inact              3.270  1 0.07055
# cond_oc_dum_3unemp              7.459  1 0.00631
# susprindum_oh                  16.966  1 3.8e-05
# susprindum_coc                  0.186  1 0.66631
# susprindum_pbc                 12.610  1 0.00038
# susprindum_mar                  1.337  1 0.24758
# GLOBAL                        323.981 20 < 2e-16

table(data_mine_miss_restr_proc2$time_interval3, data_mine_miss_restr_proc2$tipo_de_plan_2_mod)
  #          basic ambulatory GP intensive ambulatory GP residential WO intensive ambulatory WO residential
  # [0,88]               9716                   11210           5073                    1709           2487
  # (88,93]                77                      74             44                      10             13
  # (93,135]              200                     213             87                      41             34

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
data_mine_miss_restr_proc2$time_interval3_alt <- cut(data_mine_miss_restr_proc2$time, 
                                                 breaks_list[[5]], 
                                                 include.lowest = TRUE)

model_after_time_strat_alt<-
cph(Surv(lag_time,time,event)~
          cluster(id)+ 
          lag_tr_outcome+
          lag_comp_bpsc_y3_severe+
          lag_less_90d_tr1+
          log_lag_dias_treat_imp_sin_na +
          lag_policonsumo2 + 
          edad_al_ing_1 + 
          ano_nac_corr + 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar +
          psycom_dum_study +
          psycom_dum_with +
          freq_cons_dum_5day +
          cond_oc_dum_2inact +
          cond_oc_dum_3unemp +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar +
          strat(tipo_de_plan_2_mod)+
          strat(time_interval3_alt),
    data= data_mine_miss_restr_proc2 %>% data.table::as.data.table() %>% data.frame(), 
    x=TRUE, y=TRUE, surv=TRUE, iter.max = 250*4, tol = 1e-6)
# 
model_after_time_strat_alt
# Cox Proportional Hazards Model
# 
# cph(formula = Surv(lag_time, time, event) ~ cluster(id) + lag_tr_outcome + 
#     lag_comp_bpsc_y3_severe + lag_less_90d_tr1 + log_lag_dias_treat_imp_sin_na + 
#     lag_policonsumo2 + edad_al_ing_1 + ano_nac_corr + susinidum_oh + 
#     susinidum_coc + susinidum_pbc + susinidum_mar + psycom_dum_study + 
#     psycom_dum_with + freq_cons_dum_5day + cond_oc_dum_2inact + 
#     cond_oc_dum_3unemp + susprindum_oh + susprindum_coc + susprindum_pbc + 
#     susprindum_mar + strat(tipo_de_plan_2_mod) + strat(time_interval3_alt), 
#     data = data_mine_miss_restr_proc2 %>% data.table::as.data.table() %>% 
#         data.frame(), x = TRUE, y = TRUE, iter.max = 250 * 4, 
#     tol = 1e-06, surv = TRUE)
# 
# 
#                                                                         Status
# Stratum                                                                  No Event Event
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3_alt=[0,10]                 0   313
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3_alt=[0,10]          0   427
#   tipo_de_plan_2_mod=GP residential.time_interval3_alt=[0,10]                   0   306
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3_alt=[0,10]          0    55
#   tipo_de_plan_2_mod=WO residential.time_interval3_alt=[0,10]                   0   178
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3_alt=(10,20]                0  1040
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3_alt=(10,20]         0  1288
#   tipo_de_plan_2_mod=GP residential.time_interval3_alt=(10,20]                  0   673
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3_alt=(10,20]         0   223
#   tipo_de_plan_2_mod=WO residential.time_interval3_alt=(10,20]                  0   322
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3_alt=(20,30]                0  1073
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3_alt=(20,30]         0  1311
#   tipo_de_plan_2_mod=GP residential.time_interval3_alt=(20,30]                  0   578
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3_alt=(20,30]         0   216
#   tipo_de_plan_2_mod=WO residential.time_interval3_alt=(20,30]                  0   310
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3_alt=(30,50]                0  1535
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3_alt=(30,50]         0  1774
#   tipo_de_plan_2_mod=GP residential.time_interval3_alt=(30,50]                  0   752
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3_alt=(30,50]         0   265
#   tipo_de_plan_2_mod=WO residential.time_interval3_alt=(30,50]                  0   370
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3_alt=(50,70]                0   973
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3_alt=(50,70]         0   952
#   tipo_de_plan_2_mod=GP residential.time_interval3_alt=(50,70]                  0   392
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3_alt=(50,70]         0   147
#   tipo_de_plan_2_mod=WO residential.time_interval3_alt=(50,70]                  0   178
#   tipo_de_plan_2_mod=basic ambulatory.time_interval3_alt=(70,135]               0   699
#   tipo_de_plan_2_mod=GP intensive ambulatory.time_interval3_alt=(70,135]        0   747
#   tipo_de_plan_2_mod=GP residential.time_interval3_alt=(70,135]                 0   325
#   tipo_de_plan_2_mod=WO intensive ambulatory.time_interval3_alt=(70,135]        0   109
#   tipo_de_plan_2_mod=WO residential.time_interval3_alt=(70,135]                 0   140
# 
#                       Model Tests       Discrimination    
#                                                Indexes    
# Obs    17671    LR chi2    263.53       R2       0.015    
# Events 17671    d.f.           20    R2(20,17671)0.014    
# Center   105    Pr(> chi2) 0.0000       Dxy      0.251    
#                 Score chi2 263.20                         
#                 Pr(> chi2) 0.0000                         
# 
#                               Coef    S.E.   Wald Z Pr(>|Z|)
# lag_tr_outcome                 0.0448 0.0190  2.36  0.0183  
# lag_comp_bpsc_y3_severe        0.0238 0.0170  1.40  0.1629  
# lag_less_90d_tr1               0.0374 0.0227  1.65  0.0993  
# log_lag_dias_treat_imp_sin_na -0.0289 0.0084 -3.44  0.0006  
# lag_policonsumo2              -0.0071 0.0201 -0.35  0.7234  
# edad_al_ing_1                  0.0520 0.0038 13.68  <0.0001 
# ano_nac_corr                   0.0524 0.0038 13.96  <0.0001 
# susinidum_oh                  -0.0306 0.0524 -0.58  0.5591  
# susinidum_coc                  0.0607 0.0617  0.98  0.3256  
# susinidum_pbc                 -0.0096 0.0573 -0.17  0.8671  
# susinidum_mar                 -0.0109 0.0529 -0.21  0.8361  
# psycom_dum_study               0.0047 0.0220  0.21  0.8311  
# psycom_dum_with               -0.0208 0.0169 -1.23  0.2190  
# freq_cons_dum_5day             0.0204 0.0161  1.26  0.2067  
# cond_oc_dum_2inact            -0.0145 0.0222 -0.65  0.5137  
# cond_oc_dum_3unemp             0.0231 0.0178  1.30  0.1938  
# susprindum_oh                  0.0811 0.0694  1.17  0.2423  
# susprindum_coc                 0.0585 0.0700  0.84  0.4034  
# susprindum_pbc                 0.0645 0.0684  0.94  0.3454  
# susprindum_mar                 0.0681 0.0745  0.91  0.3607 

cox.zph(model_after_time_strat_alt)
#                                  chisq df       p
# lag_tr_outcome                  6.8110  1  0.0091
# lag_comp_bpsc_y3_severe         3.2478  1  0.0715
# lag_less_90d_tr1               16.6116  1 4.6e-05
# log_lag_dias_treat_imp_sin_na  32.2194  1 1.4e-08
# lag_policonsumo2                0.6498  1  0.4202
# edad_al_ing_1                   3.4324  1  0.0639
# ano_nac_corr                    0.2407  1  0.6237
# susinidum_oh                    3.3813  1  0.0659
# susinidum_coc                   1.5745  1  0.2096
# susinidum_pbc                   1.7148  1  0.1904
# susinidum_mar                   0.5145  1  0.4732
# psycom_dum_study                5.8375  1  0.0157
# psycom_dum_with                 3.0765  1  0.0794
# freq_cons_dum_5day              0.2376  1  0.6259
# cond_oc_dum_2inact              0.7335  1  0.3918
# cond_oc_dum_3unemp              4.4843  1  0.0342
# susprindum_oh                   4.5222  1  0.0335
# susprindum_coc                  0.0816  1  0.7751
# susprindum_pbc                  2.2638  1  0.1324
# susprindum_mar                  1.6041  1  0.2053
# GLOBAL                        177.1396 20 < 2e-16

table(data_mine_miss_restr_proc2$time_interval3_alt, data_mine_miss_restr_proc2$tipo_de_plan_2_mod)
#          basic ambulatory GP intensive ambulatory GP residential WO intensive ambulatory WO residential
# [0,10]               3756                    4289           2015                     602            994
# (10,20]              1787                    2228           1104                     383            510
# (20,30]              1208                    1468            612                     247            337
# (30,50]              1568                    1813            756                     272            374
# (50,70]               975                     952            392                     147            179
# (70,135]              699                     747            325                     109            140
```

```{r irrelong-17-3-iiw-save, warning=FALSE, echo=T, error=F, eval=T}
folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
save.image(paste0(folder_path,"20240503_avance_iiw.RData"))
```


##### Apply

```{r irrelong-18-iiw-weights-apply-weights-strat, warning=FALSE, echo=T, error=T, eval=T}

#iiws_strat_id <- data.frame(spec = character(), aic = numeric(), cox_zph = numeric(), success = logical())

iiws_strat <- list()

comb_strata <- expand.grid(unique(data_mine_miss_restr_proc2$tipo_de_plan_2_mod), 
                           unique(data_mine_miss_restr_proc2$time_interval3))

for (xx in seq_along(1:nrow(comb_strata))) {
  i<- comb_strata[xx,"Var1"]
  j<- comb_strata[xx,"Var2"]
  data_mine_miss_proc2_subset<-
  subset(data_mine_miss_restr_proc2, subset= tipo_de_plan_2_mod==i & time_interval3==j)
  maxfu_df_subset <- subset(maxfu_restr_df, subset= maxfu.id %in% unique(data_mine_miss_proc2_subset$id))
  iiw_model_strat<-
    IrregLong::iiw.weights(Surv(time.lag,time,event)~ 
          cluster(id)+ #If a frailty model is used, the cluster(id) term should appear before other covariates
          tr_outcome.lag+
          less_90d_tr1.lag+
          log_dias_treat_imp_sin_na.lag +
          comp_bpsc_y3_severe.lag+
          policonsumo2.lag + 
          edad_al_ing_1 + 
          ano_nac_corr + 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar +
          psycom_dum_with +
          psycom_dum_study + 
          freq_cons_dum_5day +
          cond_oc_dum_2inact +
          cond_oc_dum_3unemp +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar, 
      data= data_mine_miss_proc2_subset,
      id= "id",
      time= "time",
      event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
      maxfu= maxfu_df_subset,
      invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_oh", "susinidum_coc", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with", "psycom_dum_study_rec2", "freq_cons_dum_5day", "cond_oc_dum_3unemp", "cond_oc_dum_2inact", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
      lagvars= c("time", "tr_outcome","log_dias_treat_imp_sin_na", "less_90d_tr1","comp_bpsc_y3_severe", "policonsumo2"),
      lagfirst= c(2.95082,0,4.499811/2,0,0,0),  #90/30.5 4.499811 es 90 días
      first= T
)
  
  iiws_strat[[xx]] <- list(
      model = iiw_model_strat,
      comb = paste0("Modality: ",i,"\nTime interval: ", j,"."),
      cox_iiw = summary(iiw_model_strat$m),
      iiw = summary(iiw_model_strat$iiw)
  )
  print(paste0("Modality: ",i,"\nTime interval: ", j))
  print(summary(iiw_model_strat$m))
  print(summary(iiw_model_strat$iiw))

}

invisible("This model had some problems, not stable (low n in strata)")

invisible("Did it later, at 2024-05-16")

iiws_strat1 <- list()

comb_strata1 <- expand.grid(unique(data_mine_miss_restr_proc2$tipo_de_plan_2_mod), 
                           unique(data_mine_miss_restr_proc2$time_interval3))

for (xx in seq_along(1:nrow(comb_strata1))) {
  i<- comb_strata1[xx,"Var1"]
  j<- comb_strata1[xx,"Var2"]
  data_mine_miss_proc2_subset<-
  subset(data_mine_miss_restr_proc2, subset= tipo_de_plan_2_mod==i & time_interval3==j)
  maxfu_df_subset <- subset(maxfu_restr_df, subset= maxfu.id %in% unique(data_mine_miss_proc2_subset$id))
  iiw_model_strat1<-
    IrregLong::iiw.weights(Surv(time.lag,time,event)~ 
          cluster(id)+ #If a frailty model is used, the cluster(id) term should appear before other covariates
          tr_outcome.lag+
          less_90d_tr1.lag+
          log_dias_treat_imp_sin_na.lag +
          comp_bpsc_y3_severe.lag+
          policonsumo2.lag + 
          edad_al_ing_1 + 
          ano_nac_corr + 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar +
          psycom_dum_with +
          psycom_dum_study + 
          freq_cons_dum_5day +
          cond_oc_dum_2inact +
          cond_oc_dum_3unemp +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar, 
      data= data_mine_miss_proc2_subset,
      id= "id",
      time= "time",
      event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
      maxfu= maxfu_df_subset,
      invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_oh", "susinidum_coc", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with", "psycom_dum_study_rec2", "freq_cons_dum_5day", "cond_oc_dum_3unemp", "cond_oc_dum_2inact", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
      lagvars= c("time", "tr_outcome","log_dias_treat_imp_sin_na", "less_90d_tr1","comp_bpsc_y3_severe", "policonsumo2"),
      lagfirst= c(2.95082,1,4.499811,1,1,1),  #90/30.5 4.499811 es 90 días
      first= T
)
  
  iiws_strat1[[xx]] <- list(
      model = iiw_model_strat1,
      comb = paste0("Modality: ",i,"\nTime interval: ", j,"."),
      cox_iiw = summary(iiw_model_strat1$m),
      iiw = summary(iiw_model_strat1$iiw)
  )
  print(paste0("Modality: ",i,"\nTime interval: ", j))
  print(summary(iiw_model_strat1$m))
  print(summary(iiw_model_strat1$iiw))

}
# Warning messages:
# 1: In Surv(time.lag, time, event) :
#   Stop time must be > start time, NA created
# 2: In Surv(time.lag, time, event) :
#   Stop time must be > start time, NA created
# 3: In Surv(time.lag, time, event) :
#   Stop time must be > start time, NA created
# 4: In Surv(time.lag, time, event) :
#   Stop time must be > start time, NA created
# 5: In Surv(time.lag, time, event) :
#   Stop time must be > start time, NA created
# 6: In agreg.fit(X, Y, istrat, offset, init, control, weights = weights,  :
#   Loglik converged before variable  1,2,3,4,5 ; beta may be infinite. 
# 7: In agreg.fit(X, Y, istrat, offset, init, control, weights = weights,  :
#   Ran out of iterations and did not converge
# 8: In agreg.fit(X, Y, istrat, offset, init, control, weights = weights,  :
#   Loglik converged before variable  17,18,19,20 ; beta may be infinite. 
# 9: In agreg.fit(X, Y, istrat, offset, init, control, weights = weights,  :
#   Ran out of iterations and did not converge

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:
iiws_strat_alt <- list()

comb_strata_alt <- expand.grid(unique(data_mine_miss_restr_proc2$tipo_de_plan_2_mod), 
                           unique(data_mine_miss_restr_proc2$time_interval3_alt))

for (ff in seq_along(1:nrow(comb_strata_alt))) {
  i<- comb_strata_alt[ff,"Var1"]
  j<- comb_strata_alt[ff,"Var2"]
  data_mine_miss_proc2_subset<-
  subset(data_mine_miss_restr_proc2, subset= tipo_de_plan_2_mod==i & time_interval3_alt==j)
  maxfu_df_subset <- subset(maxfu_restr_df, subset= maxfu.id %in% unique(data_mine_miss_proc2_subset$id))  
  iiw_model_strat_alt<-
    IrregLong::iiw.weights(Surv(time.lag,time,event)~ 
          cluster(id)+ #If a frailty model is used, the cluster(id) term should appear before other covariates
          tr_outcome.lag+
          less_90d_tr1.lag+
          log_dias_treat_imp_sin_na.lag +
          comp_bpsc_y3_severe.lag+
          policonsumo2.lag + 
          edad_al_ing_1 + 
          ano_nac_corr + 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar +
          psycom_dum_with +
          psycom_dum_study + 
          freq_cons_dum_5day +
          cond_oc_dum_2inact +
          cond_oc_dum_3unemp +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar, 
      data= data_mine_miss_proc2_subset,
      id= "id",
      time= "time",
      event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
      maxfu= maxfu_df_subset,
      invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_oh", "susinidum_coc", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with", "psycom_dum_study_rec2", "freq_cons_dum_5day", "cond_oc_dum_3unemp", "cond_oc_dum_2inact", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
      lagvars= c("time", "tr_outcome","log_dias_treat_imp_sin_na", "less_90d_tr1","comp_bpsc_y3_severe", "policonsumo2"),
      lagfirst= c(2.95082,0,4.499811/2,0,0,0),  #90/30.5 4.499811 es 90 días
      first= T
)
  
  iiws_strat_alt[[ff]] <- list(
      model = iiw_model_strat_alt,
      comb = paste0("Modality: ",i,"\nTime interval: ", j,"."),
      cox_iiw = summary(iiw_model_strat_alt$m),
      iiw = summary(iiw_model_strat_alt$iiw)
  )
  print(paste0("Modality: ",i,"\nTime interval: ", j))
  print(summary(iiw_model_strat_alt$m))
  print(summary(iiw_model_strat_alt$iiw))

}


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:
iiws_strat_alt_alt <- list()

comb_strata_alt_alt <- expand.grid(unique(data_mine_miss_restr_proc2$tipo_de_plan_2_mod), 
                           unique(data_mine_miss_restr_proc2$time_interval3_alt))

for (ff in seq_along(1:nrow(comb_strata_alt_alt))) {
  i<- comb_strata_alt_alt[ff,"Var1"]
  j<- comb_strata_alt_alt[ff,"Var2"]
  data_mine_miss_proc2_subset<-
  subset(data_mine_miss_restr_proc2, subset= tipo_de_plan_2_mod==i & time_interval3_alt==j)
  maxfu_df_subset <- subset(maxfu_restr_df, subset= maxfu.id %in% unique(data_mine_miss_proc2_subset$id))  
  iiw_model_strat_alt_alt<-
    IrregLong::iiw.weights(Surv(time.lag,time,event)~ 
          cluster(id)+ #If a frailty model is used, the cluster(id) term should appear before other covariates
          tr_outcome.lag+
          less_90d_tr1.lag+
          log_dias_treat_imp_sin_na.lag +
          comp_bpsc_y3_severe.lag+
          policonsumo2.lag + 
          edad_al_ing_1 + 
          ano_nac_corr + 
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar +
          psycom_dum_with +
          psycom_dum_study + 
          freq_cons_dum_5day +
          cond_oc_dum_2inact +
          cond_oc_dum_3unemp +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar, 
      data= data_mine_miss_proc2_subset,
      id= "id",
      time= "time",
      event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
      maxfu= maxfu_df_subset,
      invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_oh", "susinidum_coc", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with", "psycom_dum_study_rec2", "freq_cons_dum_5day", "cond_oc_dum_3unemp", "cond_oc_dum_2inact", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
      lagvars= c("time", "tr_outcome","log_dias_treat_imp_sin_na", "less_90d_tr1","comp_bpsc_y3_severe", "policonsumo2"),
      lagfirst= c(2.95082,1,4.499811,1,1,1),  #90/30.5 4.499811 es 90 días
      first= T
)
  
  iiws_strat_alt_alt[[ff]] <- list(
      model = iiw_model_strat_alt_alt,
      comb = paste0("Modality: ",i,"\nTime interval: ", j,"."),
      cox_iiw = summary(iiw_model_strat_alt_alt$m),
      iiw = summary(iiw_model_strat_alt_alt$iiw)
  )
  print(paste0("Modality: ",i,"\nTime interval: ", j))
  print(summary(iiw_model_strat_alt_alt$m))
  print(summary(iiw_model_strat_alt_alt$iiw))

}

```


```{r irrelong-19-iiw-weights-apply-weights-strat2, warning=FALSE, echo=T, error=T, eval=T}

data_mine_miss_proc2_iiw_strata <- NULL # Initialize empty result

  for (i in 1:nrow(comb_strata)) {
    subset_data <- subset(dplyr::mutate(data_mine_miss_restr_proc2, rn=dplyr::row_number()), subset= tipo_de_plan_2_mod==comb_strata[i,"Var1"] & time_interval3== comb_strata[i,"Var2"])
    
    subset_data2<- cbind.data.frame(subset_data, iiw_strata= iiws_strat[[i]][[1]][[1]])
    
    data_mine_miss_proc2_iiw_strata <- rbind.data.frame(data_mine_miss_proc2_iiw_strata, subset_data2)
  }

#:#:#:#:#:#:#:#:#:#:#:#:#
#:#:#:#:#:#:#:#:#:#:#:#:#
#:#:#:#:#:#:#:#:#:#:#:#:#

data_mine_miss_proc2_iiw_strata_alt <- NULL # Initialize empty result

  for (i in 1:nrow(comb_strata_alt)) {
    subset_data_alt <- subset(dplyr::mutate(data_mine_miss_restr_proc2, rn=dplyr::row_number()), subset= tipo_de_plan_2_mod==comb_strata_alt[i,"Var1"] & time_interval3_alt== comb_strata_alt[i,"Var2"])
    
    subset_data2_alt<- cbind.data.frame(subset_data_alt, iiw_strata= iiws_strat_alt[[i]][[1]][[1]])
    
    data_mine_miss_proc2_iiw_strata_alt <- rbind.data.frame(data_mine_miss_proc2_iiw_strata_alt, subset_data2_alt)
  }


#:#:#:#:#:#:#:#:#:#:#:#:#
#:#:#:#:#:#:#:#:#:#:#:#:#
#:#:#:#:#:#:#:#:#:#:#:#:#

data_mine_miss_proc2_iiw_strata_alt_alt <- NULL # Initialize empty result

  for (i in 1:nrow(comb_strata_alt_alt)) {
    subset_data_alt <- subset(dplyr::mutate(data_mine_miss_restr_proc2, rn=dplyr::row_number()), subset= tipo_de_plan_2_mod==comb_strata_alt_alt[i,"Var1"] & time_interval3_alt== comb_strata_alt_alt[i,"Var2"])
    
    subset_data2_alt_alt<- cbind.data.frame(subset_data_alt, iiw_strata= iiws_strat_alt_alt[[i]][[1]][[1]])
    
    data_mine_miss_proc2_iiw_strata_alt_alt <- rbind.data.frame(data_mine_miss_proc2_iiw_strata_alt_alt, subset_data2_alt_alt)
  }

#:#:#:#:#:#:#:#:#:#:#:#:#
#:#:#:#:#:#:#:#:#:#:#:#:#
#:#:#:#:#:#:#:#:#:#:#:#:#

summary(data_mine_miss_proc2_iiw_strata$iiw_strata)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.18    0.77    0.91    0.91    1.04   10.94 

summary(data_mine_miss_proc2_iiw_strata_alt$iiw_strata)
 # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.01    0.61    0.87    1.08    1.20   29.96 

summary(data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata)
  # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  #   0.0     0.3     0.4     0.7     0.8    42.1 

invisible("Más confiable el 2do por LEJOS")
  
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
invisible("Stabilize weights")
data_mine_miss_proc2_iiw_strata$iiw_strata_st<-data_mine_miss_proc2_iiw_strata$iiw_strata

data_mine_miss_proc2_iiw_strata$iiw_strata_st[data_mine_miss_proc2_iiw_strata$iiw_strata>quantile(data_mine_miss_proc2_iiw_strata$iiw_strata,0.975)] <- quantile(data_mine_miss_proc2_iiw_strata$iiw_strata,0.975)
data_mine_miss_proc2_iiw_strata$iiw_strata_st[data_mine_miss_proc2_iiw_strata$iiw_after_ph<quantile(data_mine_miss_proc2_iiw_strata$iiw_strata,0.025)] <- quantile(data_mine_miss_proc2_iiw_strata$iiw_strata,0.025)

invisible("stabilize alternative weights")
data_mine_miss_proc2_iiw_strata_alt$iiw_strata_st<-data_mine_miss_proc2_iiw_strata_alt$iiw_strata

data_mine_miss_proc2_iiw_strata_alt$iiw_strata_st[data_mine_miss_proc2_iiw_strata_alt$iiw_strata>quantile(data_mine_miss_proc2_iiw_strata_alt$iiw_strata,0.975)] <- quantile(data_mine_miss_proc2_iiw_strata_alt$iiw_strata,0.975)
data_mine_miss_proc2_iiw_strata_alt$iiw_strata_st[data_mine_miss_proc2_iiw_strata_alt$iiw_strata<quantile(data_mine_miss_proc2_iiw_strata_alt$iiw_strata,0.025)] <- quantile(data_mine_miss_proc2_iiw_strata_alt$iiw_strata,0.025)

data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata_st<-data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata

data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata_st[data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata>quantile(data_mine_miss_proc2_iiw_strata_alt$iiw_strata,0.975)] <- quantile(data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata,0.975)
data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata_st[data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata<quantile(data_mine_miss_proc2_iiw_strata_alt$iiw_strata,0.025)] <- quantile(data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata,0.025)


summary(data_mine_miss_proc2_iiw_strata$iiw_strata_st)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   # 0.00    0.78    1.37    1.88    2.67    5.68 

summary(data_mine_miss_proc2_iiw_strata_alt$iiw_strata_st)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.292   0.614   0.873   1.003   1.196   3.121 

summary(data_mine_miss_proc2_iiw_strata_alt_alt$iiw_strata_st)
  #  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  # 0.116   0.116   0.439   0.603   0.761   3.118 

rbind.data.frame(
cbind.data.frame(model= "Primary (strata, lag=0)", t(matrix(summary(data_mine_miss_proc2_iiw_strata$iiw_strata_st)))),
cbind.data.frame(model= "Alternative (strata, lag=1)", t(matrix(summary(data_mine_miss_proc2_iiw_strata_alt$iiw_strata_st)))),
cbind.data.frame(model= "Alternative (2nd strata intervals, lag=1)", t(matrix(summary(data_mine_miss_proc2_iiw_strata_alt$iiw_strata_st)))))%>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/iiw_strat_240503.csv"), dec=",", sep="\t")
    knitr::kable(., size=10, format="markdown", caption="Weights (stratifying)", col.names= c("Weight",attr(summary(data_mine_miss_proc2_iiw_strata$iiw_strata_st),"names")) ) 
  }
```


##### GEE

::: center-table
```{r irrelong-20a-iiw-weights-strata-gee1, warning=T, echo=T, error=F, eval=T}
#The id= option is where we specify the clusters within which we have repeated observations that may be correlated, and tehe scale.fix=T option is to avoid R's default approach of introducing an overdispersion scale parameter.
#However, caution is advised when employing QIC and its use should not be routine, see Wang et al. (2015). growing use of quasi-likelihood-based information criteria for longitudinal data to select a working correlation structure in a generalized estimating equation framework. [https://onlinelibrary.wiley.com/doi/full/10.1002/sta4.95]

#poisson(link = "log"),

#https://www.thelancet.com/cms/10.1016/S2468-2667(22)00042-1/attachment/eb69ffc4-cb6c-4a47-9524-94e1ba9302b2/mmc1.pdf
#https://www.thelancet.com/cms/10.1016/S2468-2667(22)00201-8/attachment/05a17ae1-1e31-4ffd-a727-78ec915dc03b/mmc1.pdf

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("Must be independence structure")

m_strata <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
id=id, data=data_mine_miss_proc2_iiw_strata, family=binomial, corstr="independence")
summary(m)

m_strata_full <- geeglm( tr_outcome  ~ policonsumo2 +
          comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_proc2_iiw_strata, family=binomial, corstr="independence") 


rbind.data.frame(cbind.data.frame(model="simplest", broom::tidy(m_strata, exponentiate = T, conf.int=T)),cbind.data.frame(model="full", broom::tidy(m_strata_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/gee_strata_240503.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models (Stratifying)") 
  }
```
:::

::: center-table
```{r irrelong-20b-iiw-weights-strata-geew, warning=T, echo=F, error=F, eval=T}
data_mine_miss_proc2_iiw_strata$edad_al_ing_1_st = data_mine_miss_proc2_iiw_strata$edad_al_ing_1 - mean(data_mine_miss_proc2_iiw_strata$edad_al_ing_1)

# can use to fit a weighted GEE
mw_strata <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_proc2_iiw_strata, family= binomial, weights=iiw_strata_st, corstr="independence")
#In eval(family$initialize) : non-integer #successes in a binomial glm!
#summary(mw)

mw_strata_pois <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_proc2_iiw_strata, family= poisson(link = "log"), weights=iiw_strata_st, corstr="independence")
summary(mw_strata_pois)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

mw_strata_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_proc2_iiw_strata, family=binomial, weights=iiw_strata_st, corstr="independence") 
#In eval(family$initialize) : non-integer #successes in a binomial glm!


mw_strata_pois_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_proc2_iiw_strata, family= poisson(link = "log"), weights=iiw_strata_st, corstr="independence") 

invisible("Model fit")
#broom::glance(mwpois_full)
#QIC(mw)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

rbind.data.frame(cbind.data.frame(model="simplest, binomial", broom::tidy(mw_strata, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, binomial", broom::tidy(mw_strata_full, exponentiate = T, conf.int=T)),cbind.data.frame(model="simplest, poisson", broom::tidy(mw_strata_pois, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, poisson", broom::tidy(mw_strata_pois_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/geew_strata_240502.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models, weighted (Stratifying)") 
  }
```
:::


::: center-table
```{r irrelong-20c-iiw-weights-strata-geew-alt, warning=T, echo=T, error=F, eval=T}

# can use to fit a weighted GEE
mw_alt2 <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_proc2_iiw_strata_alt_alt, family= binomial, weights=iiw_strata_st, corstr="independence")
#In eval(family$initialize) : non-integer #successes in a binomial glm!
#summary(mw)

mwpois_alt2 <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_proc2_iiw_strata_alt_alt, family= poisson(link = "log"), weights=iiw_strata_st, corstr="independence")

mwpois_alt2 <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_proc2_iiw_strata_alt_alt, family= poisson(link = "log"), weights=iiw_strata_st, corstr="independence")


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

mw_alt_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_proc2_iiw_strata_alt, family=binomial, weights=iiw_strata_st, corstr="independence") 
#In eval(family$initialize) : non-integer #successes in a binomial glm!

mw_alt2_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_proc2_iiw_strata_alt_alt, family=binomial, weights=iiw_strata_st, corstr="independence")

mwpois_alt_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_proc2_iiw_strata_alt, family= poisson(link = "log"), weights=iiw_strata_st, corstr="independence") 




mwpois_alt2_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_proc2_iiw_strata_alt_alt, family= poisson(link = "log"), weights=iiw_strata_st, corstr="independence") 

invisible("Model fit")
#broom::glance(mwpois_full)
#QIC(mw)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

rbind.data.frame(cbind.data.frame(model="simplest, binomial", broom::tidy(mw_alt, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, binomial", broom::tidy(mw_alt_full, exponentiate = T, conf.int=T)),cbind.data.frame(model="simplest, poisson", broom::tidy(mwpois_alt, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, poisson", broom::tidy(mwpois_alt_full, exponentiate = T, conf.int=T)),
                cbind.data.frame(model="simplest, binomial (alt)", broom::tidy(mw_alt2, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, binomial (alt)", broom::tidy(mw_alt2_full, exponentiate = T, conf.int=T)),cbind.data.frame(model="simplest, poisson (alt)", broom::tidy(mwpois_alt2, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, poisson (alt)", broom::tidy(mwpois_alt2_full, exponentiate = T, conf.int=T))
                 ) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/geew_strata_alt_240503.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models, alternative weighting (Stratifying)") 
  }
```
:::


#### No corrections

```{r irrelong-21-iiw-weights-nocorr, warning=T, echo=T, error=F, eval=T}
#load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/20240503_avance_iiw.RData")
iiw_nocorr<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1.lag+
            comp_bpsc_y3_severe.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= data_mine_miss_restr_proc2 %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= maxfu_restr_df %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome", "comp_bpsc_y3_severe", "less_90d_tr1", "policonsumo2"),
            lagfirst= c(2.95082,4.499811/2,0,0,0,0),  #90/30.5 4.499811 es 90 días
            first= T
)
iiw_nocorr_alt<-
iiw.weights(Surv(time.lag,time,event)~ 
            cluster(id)+ 
            tr_outcome.lag +
            log_dias_treat_imp_sin_na.lag +
            less_90d_tr1.lag+
            comp_bpsc_y3_severe.lag + 
            policonsumo2.lag + 
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_coc +
            susinidum_oh +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_with +
            psycom_dum_study + 
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_oh +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            data= data_mine_miss_restr_proc2 %>% as.data.frame(),
            id= "id",
            time= "time",
            event= "event", #character string indicating which column of the data indicates whether or not a visit occurred. If every row corresponds to a visit, then this column will consist entirely of ones
            maxfu= maxfu_restr_df %>% as.data.frame(),
            # formulanull = Surv(time.lag,time,event)~ edad_al_ing_1 + 
            #       ano_nac_corr,
            invariant= c("edad_al_ing_1", "ano_nac_corr", "susinidum_coc", "susinidum_oh", "susinidum_pbc", "susinidum_mar",  "psycom_dum_with", "psycom_dum_study", "freq_cons_dum_5day", "cond_oc_dum_2inact", "cond_oc_dum_3unemp", "susprindum_oh", "susprindum_coc", "susprindum_pbc", "susprindum_mar"),
            lagvars= c("time", "log_dias_treat_imp_sin_na","tr_outcome", "comp_bpsc_y3_severe", "less_90d_tr1", "policonsumo2"),
            lagfirst= c(2.95082,4.499811,1,1,1,1),  #90/30.5 2.95082 ; 4.499811 es 90 días
            first= T
)
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
```


```{r irrelong-22-iiw-weights-nocorr, warning=T, echo=T, error=F, eval=T}
summary(iiw_nocorr$iiw)

summary(iiw_nocorr_alt$iiw)

data_mine_miss_restr_proc2$iiw_nocorr<-iiw_nocorr$iiw
data_mine_miss_restr_proc2$iiw_nocorr_alt<-iiw_nocorr_alt$iiw

data_mine_miss_restr_proc2$iiw_nocorr_st<-data_mine_miss_restr_proc2$iiw_nocorr
data_mine_miss_restr_proc2$iiw_nocorr_st[data_mine_miss_restr_proc2$iiw_nocorr>quantile(data_mine_miss_restr_proc2$iiw_nocorr,0.975)] <- quantile(data_mine_miss_restr_proc2$iiw_nocorr,0.975)
data_mine_miss_restr_proc2$iiw_nocorr_st[data_mine_miss_restr_proc2_iiw_after_ph$iiw_nocorr<quantile(data_mine_miss_restr_proc2$iiw_nocorr,0.025)] <- quantile(data_mine_miss_restr_proc2$iiw_nocorr,0.025)


data_mine_miss_restr_proc2$iiw_nocorr_alt_st<-data_mine_miss_restr_proc2$iiw_nocorr_alt
data_mine_miss_restr_proc2$iiw_nocorr_alt_st[data_mine_miss_restr_proc2$iiw_nocorr_alt>quantile(data_mine_miss_restr_proc2$iiw_nocorr_alt,0.975)] <- quantile(data_mine_miss_restr_proc2$iiw_nocorr_alt,0.975)
data_mine_miss_restr_proc2$iiw_nocorr_st[data_mine_miss_restr_proc2_iiw_after_ph$iiw_iiw_nocorr_altnocorr<quantile(data_mine_miss_restr_proc2$iiw_nocorr_alt,0.025)] <- quantile(data_mine_miss_restr_proc2$iiw_nocorr_alt,0.025)

summary(iiw_nocorr$iiw)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   # 0.53    1.00    1.54    1.87    2.67    6.03 
summary(iiw_nocorr_alt$iiw)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   #  0.1     0.4     0.7     0.8     1.0   102.3 
summary(data_mine_miss_restr_proc2$iiw_nocorr)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   # 0.53    1.00    1.54    1.87    2.67    6.03 
summary(data_mine_miss_restr_proc2$iiw_nocorr_st)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   # 0.53    1.00    1.54    1.86    2.67    3.89 
summary(data_mine_miss_restr_proc2$iiw_nocorr_alt_st)
  #  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  # 0.129   0.418   0.676   0.697   1.000   1.000 

rbind.data.frame(
cbind.data.frame(model= "Primary (no corrections, lag=0)", t(matrix(summary(data_mine_miss_restr_proc2$iiw_nocorr_st)))),
cbind.data.frame(model= "Alternative (no corrections, lag=1)", t(matrix(summary(data_mine_miss_restr_proc2$iiw_nocorr_alt_st)))))%>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/iiw_nocorr_240503.csv"), dec=",", sep="\t")
    knitr::kable(., size=10, format="markdown", caption="Weights (No corrections)", col.names= c("Weight",attr(summary(data_mine_miss_restr_proc2$iiw_nocorr_st),"names")) ) 
  }
```

##### GEE

::: center-table
```{r irrelong-23a-iiw-weights-nocorr-gee1, warning=T, echo=T, error=F, eval=T}
#The id= option is where we specify the clusters within which we have repeated observations that may be correlated, and tehe scale.fix=T option is to avoid R's default approach of introducing an overdispersion scale parameter.
#However, caution is advised when employing QIC and its use should not be routine, see Wang et al. (2015). growing use of quasi-likelihood-based information criteria for longitudinal data to select a working correlation structure in a generalized estimating equation framework. [https://onlinelibrary.wiley.com/doi/full/10.1002/sta4.95]

#poisson(link = "log"),

#https://www.thelancet.com/cms/10.1016/S2468-2667(22)00042-1/attachment/eb69ffc4-cb6c-4a47-9524-94e1ba9302b2/mmc1.pdf
#https://www.thelancet.com/cms/10.1016/S2468-2667(22)00201-8/attachment/05a17ae1-1e31-4ffd-a727-78ec915dc03b/mmc1.pdf

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

invisible("Must be independence structure")

m_nocorr <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
id=id, data=data_mine_miss_restr_proc2, family=binomial, corstr="independence")
summary(m_nocorr)

m_nocorr_full <- geeglm( tr_outcome  ~ policonsumo2 +
          comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2, family=binomial, corstr="independence") 


rbind.data.frame(cbind.data.frame(model="simplest", broom::tidy(m_nocorr, exponentiate = T, conf.int=T)),cbind.data.frame(model="full", broom::tidy(m_nocorr_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/gee_nocorr_240503.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models (no correction)") 
  }
```
:::

::: center-table
```{r irrelong-23b-iiw-weights-nocorr-geew, warning=T, echo=T, error=F, eval=T}
data_mine_miss_restr_proc2$edad_al_ing_1_st = data_mine_miss_restr_proc2$edad_al_ing_1 - mean(data_mine_miss_restr_proc2$edad_al_ing_1)

# can use to fit a weighted GEE
mw_nocorr <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2, family= binomial, weights=iiw_nocorr_st, corstr="independence")
#In eval(family$initialize) : non-integer #successes in a binomial glm!
#summary(mw)

mw_nocorr_pois <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2, family= poisson(link = "log"), weights=iiw_nocorr_st, corstr="independence")
summary(mwpois)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

mw_nocorr_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2, family=binomial, weights=iiw_nocorr_st, corstr="independence") 
#In eval(family$initialize) : non-integer #successes in a binomial glm!


mw_nocorr_pois_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2, family= poisson(link = "log"), weights=iiw_nocorr_st, corstr="independence") 

invisible("Model fit")
#broom::glance(mwpois_full)
#QIC(mw)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

rbind.data.frame(cbind.data.frame(model="simplest, binomial", broom::tidy(mw_nocorr, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, binomial", broom::tidy(mw_nocorr_full, exponentiate = T, conf.int=T)),cbind.data.frame(model="simplest, poisson", broom::tidy(mw_nocorr_pois, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, poisson", broom::tidy(mw_nocorr_pois_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/geew_nocorr_240503.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models, weighted (no correction)") 
  }
```
:::


::: center-table
```{r irrelong-23c-iiw-weights-nocorr-geew-alt, warning=T, echo=T, error=F, eval=T}

# can use to fit a weighted GEE
mw_nocorr_alt <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2, family= binomial, weights=iiw_nocorr_alt_st, corstr="independence")
#In eval(family$initialize) : non-integer #successes in a binomial glm!
#summary(mw)

mw_nocorr_pois_alt <- geeglm( tr_outcome  ~ policonsumo2 +
            edad_al_ing_1 + 
            ano_nac_corr + 
            susinidum_oh +
            susinidum_coc +
            susinidum_pbc +
            susinidum_mar +
            psycom_dum_study +
            psycom_dum_with +
            freq_cons_dum_5day +
            cond_oc_dum_2inact +
            cond_oc_dum_3unemp +
            susprindum_coc +
            susprindum_pbc +
            susprindum_mar, 
            id=id, data=data_mine_miss_restr_proc2, family= poisson(link = "log"), weights=iiw_nocorr_alt_st, corstr="independence")
summary(mwpois)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

mw_nocorr_alt_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2, family=binomial, weights=iiw_nocorr_alt_st, corstr="independence") 
#In eval(family$initialize) : non-integer #successes in a binomial glm!


mw_nocorr_pois_alt_full <- geeglm( tr_outcome  ~ policonsumo2 +
           comp_bpsc_y2_moderate+ 
          comp_bpsc_y3_severe+ 
          edad_al_ing_1+ 
          ano_nac_corr+ 
          esc_dum_rec_3prim+ 
          esc_dum_rec_2high +
          susprindum_oh +
          susprindum_coc +
          susprindum_pbc +
          susprindum_mar+
          freq_cons_dum_5day+
          freq_cons_dum_44to6wk+
          freq_cons_dum_32to3wk+
          freq_cons_dum_21wkmore+
          cond_oc_dum_3unemp+
          cond_oc_dum_2inact+
          viv_dum_illegal+
          viv_dum_own+
          viv_dum_rent+
          viv_dum_temp+
          psycom_dum_with+
          psycom_dum_study+
          susinidum_oh +
          susinidum_coc +
          susinidum_pbc +
          susinidum_mar+
          cohab_dum_alone+
          cohab_dum_fam_or+
          cohab_dum_cpl_child, 
id=id, data=data_mine_miss_restr_proc2, family= poisson(link = "log"), weights=iiw_nocorr_alt_st, corstr="independence") 

invisible("Model fit")
#broom::glance(mwpois_full)
#QIC(mw)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

rbind.data.frame(cbind.data.frame(model="simplest, binomial", broom::tidy(mw_nocorr_alt, exponentiate = T, conf.int=T)), cbind.data.frame(model="full, binomial", broom::tidy(mw_nocorr_alt_full, exponentiate = T, conf.int=T)), cbind.data.frame(model="simplest, poisson", broom::tidy(mw_nocorr_pois_alt, exponentiate = T, conf.int=T)),cbind.data.frame(model="full, poisson", broom::tidy(mw_nocorr_pois_alt_full, exponentiate = T, conf.int=T))) %>% dplyr::mutate_at(c("estimate","std.error","conf.low","conf.high"), ~sprintf("%1.2f",.))%>% dplyr::mutate_at(c("p.value"), ~sprintf("%1.4f",.)) %>% dplyr::select(-statistic) %>% 
  { 
    write.table(., file = paste0(getwd(),"/_proposal_grant/2023/geew_nocorr_alt_240503.csv"), dec=",", sep="\t")
    knitr::kable(dplyr::filter(.,term=="policonsumo2"), size=10, format="markdown", caption="GEE Models, alternative weighting (no correction)") 
  }
```
:::



<br>

# Session info

```{r session-info, echo=T, error=T, message=TRUE, paged.print=TRUE,eval=T}
message(paste0("R library: ", Sys.getenv("R_LIBS_USER")))
message(paste0("Date: ",withr::with_locale(new = c('LC_TIME' = 'C'), code =Sys.time())))
message(paste0("Editor context: ", path))
```

::: center-table
```{r session-info-r, echo=T, error=T, message=TRUE, paged.print=TRUE,eval=T}
sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
 kable(caption = "R packages", format = "markdown",
      col.names = c("Row number", "Package", "Version"),
    row.names = FALSE,
      align = c("c", "l", "r"))
```
:::

::: center-table
```{r session-info-python, echo=T, error=T, message=TRUE, paged.print=TRUE,eval=T}
reticulate::py_list_packages()%>% 
 kable(caption = "Python packages", format = "markdown",
      col.names = c("Package", "Version", "Requirement"),
    row.names = FALSE,
      align = c("c", "l", "r", "r"))
```
:::

Save

```{r}
folder_path <- ifelse(dir.exists("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/"),
                      "E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/",
                      "C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/_proposal_grant/2023/")
save.image(paste0(folder_path,"an_grant_23_24_3.RData"))
```

<!--
#https://quarto.org/docs/get-started/
#https://stackoverflow.com/questions/76542517/r-studio-quarto-markdown-error-os-error-2-the-system-cannot-find-the-file-s
-->