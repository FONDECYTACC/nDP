---
title: "Chilean prosecutor's office Data merge (Step 5)"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  distill::distill_article:
    code_folding: true
    fig_height: 6
    fig_width: 8
    theme: flatly
    toc: yes
    toc_depth: 5
    toc_float: yes
    output_dir: "docs"
  toc_float:
    collapsed: false
    smooth_scroll: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 

```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }

.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }

.centrado {
    text-align: center;
}

.table.center {
    margin-left:auto; 
    margin-right:auto;
  }

/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/

/* Applies to outputs that are not code other than R*/

pre {
  overflow-x: auto !important;
}
pre code {
  word-wrap: normal !important;
  white-space: pre !important;
}
/*
pre:not(.sourceCode) { 
  white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence  */
  font-size: 10px !important;
  line-height: 50% !important;
}

body{ /* Normal  */
      text-align: justify;
  }

.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: auto; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}

.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}

.pandoc-table { /* Should add !important; but it seems no necessary  */
  margin-left:auto; /* To center */
  margin-right:auto;
  border-collapse: collapse;
  table-layout: auto;
  font-size: 11px;
  overflow-y: auto;
  max-height:450px !important;
  white-space: nowrap;
  overflow-x: auto; 
  width:450px;
}

.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}

.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0px;
}

.pandoc-table caption {
    text-align: left !important;
    font-size: 11px !important;
}

.controlly{
    overflow-y:scroll;
    height:350px;
    overflow-x: scroll; 
}


.controlly2{
    overflow-y:scroll;
    height:550px;
    overflow-x: scroll; 
}

</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```

```{r prev-setup, include = FALSE, cache=T, error=T}
rm(list=ls());gc()

#If you render multiple documents from the same script or R session, you should detach("Statamarkdown") in between documents.
try(detach("Statamarkdown"))

if(!grepl("4.1.2",R.version.string)){stop("Different version (must be 4.1.2)")}
path<-getwd()#we define it again later in setup chunk
if (grepl("CISS Fondecyt",path)==T){
    try(setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)"));load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
  } else if (grepl("andre",path)==T){
    try(setwd('C:/Users/andre/Desktop/SUD_CL/'));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
  } else if (grepl("E:",path)==T){
    try(setwd("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/SUD_CL/"));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
  } else {
    try(setwd(paste0(path)));load(paste0(gsub("SUD_CL","",gsub("2022","2019",path)),"/14.Rdata"))
  }
```

```{r setup, include = FALSE, cache=T, error=T, echo=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(try(dplyr::ungroup(x)))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
pacman::p_unlock(lib.loc = .libPaths()) #para no tener problemas reinstalando paquetes

if(!require(pacman)){install.packages("pacman")}
if(!require(devtools)){install.packages("devtools", type = "win.binary", dependencies=T)}

pacman::p_load(ggpattern, withr, boot, matrixStats, knitr, tidyr, stringi, stringr, ggplot2, Hmisc, kableExtra, plotly, janitor, rbokeh, zoo, broom, sqldf, devtools, codebook, data.table, panelr, RColorBrewer, lsmeans, finalfit, ggiraph, sf, treemapify, dplyr, tidyverse, epiR, survminer, ggfortify, survMisc, foreign, reshape2, stargazer, tableone, MatchIt, cobalt, eha, igraph, Amelia, DiagrammeR, DiagrammeRsvg, rsvg, mstate, htmltools, webshot, flexsurv, muhaz, Metrics, rpivotTable, caret, polycor, ClusterR, flextable, ggstatsplot, ggside, daff, explore, sjPlot, compareGroups, job, missForest, showtext, ggpattern, distill, showtext, googleVis, tidylog, magick, dlookr, survRM2, easystats, tidylog, sqldf,  adjustedCurves, ggpmisc, rms, SpatialEpiApp, spatsurv, SuperLearner, survex, install=T)

pacman::p_load(WeightIt, coxed, twang, survey, dbarts, jskm, adjustedCurves, pammtools, hrcomprisk, randomForestSRC, install=T, force=T)
if(!require(AdjKM.CIF)){try(devtools::install_github("Lesly1031/AdjKM.CIF",dependencies = TRUE, force=T, upgrade="never"))}
if(!require(RMSTSens)){try(remotes::install_github("seungjae2525/RMSTSens",dependencies = TRUE, force=T, upgrade="never"))}



#Error in if (options$noisey == TRUE) message(paste("\n", options$engine, : argument is of length zero

if(!require(SpatialEpiApp)){try(install_github("Paula-Moraga/SpatialEpiApp",upgrade ="never"))}
if(!require(survcomp)){try(devtools::install_github("bhklab/survcomp",upgrade ="never"))}

try(webshot::install_phantomjs())

if(!require(bpmn)){try(devtools::install_github("bergant/bpmn",upgrade ="never"))}

if (!requireNamespace("BiocManager", quietly = TRUE)){renv::install('BiocManager')}
 
if(!require(fmrs)){renv::install("bioc::fmrs")}
#http://www.bioconductor.org/packages/release/bioc/manuals/fmrs/man/fmrs.pdf

#if(!require(Statamarkdown)){try(devtools::install_github("Hemken/Statamarkdown",upgrade ="never"))}
# #Error in if (options$noisey == TRUE) message(paste("\n", options$engine,  : 
#   argumento tiene longitud cero
# Calls: <Anonymous> ... sew.list -> lapply -> FUN -> sew.character -> <Anonymous>

#easystats::install_suggested()

options(scipen=2) #display numbers rather scientific number

#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")
invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_")
invisible("ERASE INFORMATION")
rm(list = setdiff(ls(), c("CONS_C1_df_dup_SEP_2020", "Base_fiscalia_v13", "Base_fiscalia_v13_pris")))
invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

# Own Mode method to calculate mode
Mode <- function(x, na.rm = FALSE) {
  # it takes two areguments x, and na.rm
  if(na.rm){ #if na.rm is false it means no need to remove NA values
    x = x[!is.na(x)]
  }

  valx <- unique(x)
  return(valx[which.max(tabulate(match(x, valx)))])
}

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

fitstats.flexsurvreg = function(x){
  ll = x$loglik
  aic = x$AIC
  k = length(x$coefficients)
  n = sum(x$data$m["(weights)"])
  aicc = aic + ((2 * k) * (k + 1) / (n - k - 1))
  bic = - 2 * ll + (k * log(n))
  data.frame(
   Df = k,
    "n2ll" = -2 * ll,
    AIC = aic,
    AICc = aicc,
    BIC = bic
  )
}
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:


if(.Platform$OS.type == "windows") withAutoprint({
  memory.size()
  memory.size(TRUE)
  memory.limit()
})
memory.limit(size=56000)

path<-dirname(rstudioapi::getSourceEditorContext()$path)

options(knitr.kable.NA = '')


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- ifelse(difftime(Sys.time(), now)>(60^2),difftime(Sys.time(), now)/(60^2),difftime(Sys.time(), now)/(60^1))
      # return a character string to show the time
      x<-ifelse(difftime(Sys.time(), now)>(60^2),paste("Time for this code chunk to run:", round(res,1), "hours"),paste("Time for this code chunk to run:", round(res,1), "minutes"))
      paste('<div class="message">', gsub('##', '\n', x),'</div>', sep = '\n')
    }
  }
}))
knitr::opts_chunk$set(time_it = TRUE)
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#to format rows in bold
format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  # one * for italics, two ** for bold
  map <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  

  for (r in rows){
    for(c in cols){

      # Make sure values are not factors
      df[[c]] <- as.character( df[[c]])

      # Update formatting
      df[r, c] <- ifelse(nchar(df[r, c])==0,"",paste0(markup, gsub(" ", "", df[r, c]), markup))
    }
  }

  return(df)
}
#To produce line breaks in messages and warnings
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('<div class="message">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
)
```


::: blue

<!--- https://docs.google.com/document/d/1d0lwgylQ89JyLZuQ6b6Tn8-u_idgDjfq_hTumTYQ9Aw/edit --->

- Estimate different survival distributions

- Finite mixture models

- 

:::

<br>

# Compare Stata weights

::: controlly
```{r stata1, echo=T, fig.align='center', message=T, error=T, eval=T}
     # tryCatch(load(paste0(sub("2019","2022",sub("SUD_CL","",path)),"15.RData")),
     #          error= load(paste0(sub("2019","2022",sub("SUD_CL","",path)),"/15.RData")))
mariel_stata_sentence<-rio::import("mariel_nov_22.dta") #no prison
mariel_stata_prison<-rio::import("mariel_nov_22_2.dta") # prison

#rpdf10_m_stag_ten_viv rpdf10_m_nostag_or_ing_num_hij gomp_m_nostag_ten_viv gomp_m_nostag_or_ing_num_hij rpdf6_m_nostag_ten_viv rpdf6_m_nostag_or_ing_num_hij rpdf10_m_stag_ten_viv rpdf10_m_stag_or_ing_num_hij gomp_m_stag_ten_viv gomp_m_stag_or_ing_num_hij rpdf6_m_stag_ten_viv rpdf6_m_stag_or_ing_num_hij

vec_vars_stata<-
c("event", "motivodeegreso_mod_imp_rec2", "edad_al_ing_1", "edad_ini_cons", "sex_enc", "esc_rec", "sus_prin_mod", "fr_sus_prin", "comp_biosoc", "ten_viv", "dg_cie_10_rec", "sud_severity_icd10", "macrozone", "policonsumo", "n_off_vio", "n_off_acq", "n_off_sud", "clas")

warning(paste0("The sample fell from ",format(nrow(mariel_stata_sentence), big.mark=",")," to ",format(nrow(mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c(vec_vars_stata)]),]), big.mark=","), " observations without missing data in the variables of interest, and to ", format(nrow(mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c(vec_vars_stata, "rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),]), big.mark=","), " if erased also the rows that possess missing values in the weights. We only eliminated missing data in the treatment weights (n=", format(nrow(mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c("rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),]), big.mark=","),")"))


mariel_stata_sentence<-
  mariel_stata_sentence %>% 
  dplyr::mutate(across(c("sex_enc","esc_rec", "sus_prin_mod", "fr_sus_prin", "comp_biosoc", "ten_viv", "dg_cie_10_rec", "sud_severity_icd10", "macrozone", "policonsumo", "n_off_vio", "n_off_acq", "n_off_sud", "clas", "motivodeegreso_mod_imp_rec3"),~as.factor(.)))
  

bal_tab2<-
cobalt::bal.tab(motivodeegreso_mod_imp_rec2 ~ edad_al_ing_1+ edad_ini_cons + sex_enc + esc_rec + sus_prin_mod + fr_sus_prin + comp_biosoc+ ten_viv + dg_cie_10_rec + sud_severity_icd10+ macrozone + policonsumo+ n_off_vio + n_off_acq+ n_off_sud + clas, data = mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c("rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),],
                weights = list("RP(df=10)+ Tenure status households" = "rpdf10_m_stag_ten_viv", "RP(df=10)+ Motive of admission & No. of children"="rpdf10_m_nostag_or_ing_num_hij", "Gompertz+ Tenure status households"="gomp_m_nostag_ten_viv", "Gompertz+ Motive of admission & No. of children"="gomp_m_nostag_or_ing_num_hij", "RP(df=6)+ Tenure status households"="rpdf6_m_nostag_ten_viv", "RP(df=6)+ Motive of admission & No. of children"="rpdf6_m_nostag_or_ing_num_hij"),
                estimand = "ATE",
                which.treat = .all,
                un = T, 
                thresholds = c(cor = .2),
                 binary = "std", continuous = "std",
                stats = c("mean.diffs", "variance.ratios"))
invisible("Error: NAs are not allowed in the weights.")

bal_tab2$Balance %>% 
  dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Balance Measures (multinomial response weights)")
  #knitr::kable("html", caption="Balance Measures") %>% 
  #   kableExtra::kable_classic_2()

invisible("differences in dg_cie10_rec")
```
:::

::: controlly 
```{r stata2, echo=T, fig.align='center', message=T, error=T, eval=T}
#The “effective sample size” (ESS) is a measure of the sample size a non-weighted sample would have to have to achieve the same level of precision as the weighted sample (Ridgeway 2006).
bal_tab2$Observations %>% 
  #dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Effective sample sizes")
```
:::

Now we compared against multi-valued treatments format.

::: controlly
```{r stata1-2, echo=T, fig.align='center', message=T, error=T, eval=T}

bal_tab2b<-
cobalt::bal.tab(motivodeegreso_mod_imp_rec3 ~ edad_al_ing_1+ edad_ini_cons + sex_enc + esc_rec + sus_prin_mod + fr_sus_prin + comp_biosoc+ ten_viv + dg_cie_10_rec + sud_severity_icd10+ macrozone + policonsumo+ n_off_vio + n_off_acq+ n_off_sud + clas, data = mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c("motivodeegreso_mod_imp_rec", "rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),],
                weights = list("RP(df=10)+ Tenure status households" = "rpdf10_m_stag_ten_viv", "RP(df=10)+ Motive of admission & No. of children"="rpdf10_m_nostag_or_ing_num_hij", "Gompertz+ Tenure status households"="gomp_m_nostag_ten_viv", "Gompertz+ Motive of admission & No. of children"="gomp_m_nostag_or_ing_num_hij", "RP(df=6)+ Tenure status households"="rpdf6_m_nostag_ten_viv", "RP(df=6)+ Motive of admission & No. of children"="rpdf6_m_nostag_or_ing_num_hij"),
                estimand = "ATE",
                which.treat = .all,
                un = T, 
                thresholds = c(cor = .2),
                 binary = "std", continuous = "std",
                stats = c("mean.diffs", "variance.ratios"))
invisible("Error: The treatment must have at least two unique values.")

rbind(data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`2 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late vs. Early Dropout",bal_tab2b$Pair.Balance$`3 vs. 2`$Balance), keep.rownames=T)) %>% 
  data.table::data.table(keep.rownames = T) %>% 
  dplyr::select(comp, rn, everything()) %>% 
  dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Balance Measures (multinomial response weights)")
 #  knitr::kable("html", caption="Balance Measures") %>% 
   #   kableExtra::kable_classic_2()

invisible("0= completar; 1= no-completar;policonsumo looks not balanced, the number of previous acquisitive offenses, and South")
```
:::

::: controlly 
```{r stata1-5-2, echo=T, fig.align='center', message=T, error=T, eval=T}
rbind(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`2 vs. 1`$Balance),
      cbind(comp="Late Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 1`$Balance),
      cbind(comp="Late vs. Early Dropout",bal_tab2b$Pair.Balance$`3 vs. 2`$Balance)) %>% 
    data.table::data.table(keep.rownames = T) %>% 
    dplyr::select(comp, rn, everything()) %>% 
    dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
    dplyr::summarise_if(is.numeric, ~list(min= min(.,na.rm=T), max= max(.,na.rm=T))) %>% t() %>%
  knitr::kable("markdown", caption="Balance Measures (multinomial response weights)", col.names=c("min", "max"))
 #  knitr::kable("html", caption="Balance Measures (multinomial response weights)") %>% 
   #   kableExtra::kable_classic_2()
```
:::    

::: controlly 
```{r stata2-2, echo=T, fig.align='center', message=T, error=T, eval=T}
#The “effective sample size” (ESS) is a measure of the sample size a non-weighted sample would have to have to achieve the same level of precision as the weighted sample (Ridgeway 2006).

dplyr::bind_rows(data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`2 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 2`$Observations),keep.rownames = T)) %>% 
  #dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Effective sample sizes")
```
:::

<br>

# Bring other databases

```{r bring_db1, echo=T, fig.align='center', message=T, error=T, eval=T}
#http://observatorio.ministeriodesarrollosocial.gob.cl/pobreza-comunal-2020

Comunas_PNDR <- readxl::read_excel("Clasificacion-comunas-PNDR.xlsx")%>% 
  dplyr::mutate(cod= dplyr::case_when(as.character(cod_com)=="16101"~"8401",
                                      as.character(cod_com)=="16102"~"8402",
                                      as.character(cod_com)=="16103"~"8406",
                                      as.character(cod_com)=="16104"~"8407",
                                      as.character(cod_com)=="16105"~"8410",
                                      as.character(cod_com)=="16106"~"8411",
                                      as.character(cod_com)=="16107"~"8413",
                                      as.character(cod_com)=="16108"~"8418",
                                      as.character(cod_com)=="16109"~"8421",
                                      as.character(cod_com)=="16201"~"8414",
                                      as.character(cod_com)=="16202"~"8403",
                                      as.character(cod_com)=="16203"~"8404",
                                      as.character(cod_com)=="16204"~"8408",
                                      as.character(cod_com)=="16205"~"8412",
                                      as.character(cod_com)=="16206"~"8415",
                                      as.character(cod_com)=="16207"~"8420",
                                      as.character(cod_com)=="16301"~"8416",
                                      as.character(cod_com)=="16302"~"8405",
                                      as.character(cod_com)=="16303"~"8409",
                                      as.character(cod_com)=="16304"~"8417",
                                      as.character(cod_com)=="16305"~"8419",
                                      T~ as.character(cod_com)
                                      ))

#http://observatorio.ministeriodesarrollosocial.gob.cl/pobreza-comunal-2011
pobr_mult_2020<-readxl::read_excel("Estimaciones_de_Tasa_de_Pobreza_por_Ingresos_por_Comunas_2020_revisada2022_09.xlsx", skip=1) %>% dplyr::mutate(anio=2020) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2019<-readxl::read_excel("Estimaciones_de_Tasa_de_Pobreza_por_Ingresos_por_Comunas_2020_revisada2022_09.xlsx", skip=1) %>% dplyr::mutate(anio=2019) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2018<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2017.xlsx", skip=1) %>% dplyr::mutate(anio=2018) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2017<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2017.xlsx", skip=1) %>% dplyr::mutate(anio=2017) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2016<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2015.xlsx", skip=1) %>% dplyr::mutate(anio=2016) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2015<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2015.xlsx", skip=1) %>% dplyr::mutate(anio=2015) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2014<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_2013.xlsx", skip=1)%>% dplyr::mutate(anio=2014) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2013<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_2013.xlsx", skip=1)%>% dplyr::mutate(anio=2013) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2012<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2012) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2011<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2011) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2010<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2010) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2009<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2009) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2008<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2008) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2007<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2007) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)

# replace comuna= "16103" if strpos(strlower(comuna),"8406")>0
# replace comuna= "16104" if strpos(strlower(comuna),"8407")>0
# replace comuna= "16105" if strpos(strlower(comuna),"8410")>0
# replace comuna= "16106" if strpos(strlower(comuna),"8411")>0
# replace comuna= "16107" if strpos(strlower(comuna),"8413")>0
# replace comuna= "16108" if strpos(strlower(comuna),"8418")>0
# replace comuna= "16109" if strpos(strlower(comuna),"8421")>0
# replace comuna= "16201" if strpos(strlower(comuna),"8414")>0
# replace comuna= "16202" if strpos(strlower(comuna),"8403")>0
# replace comuna= "16203" if strpos(strlower(comuna),"8404")>0
# replace comuna= "16204" if strpos(strlower(comuna),"8408")>0
# replace comuna= "16205" if strpos(strlower(comuna),"8412")>0
# replace comuna= "16206" if strpos(strlower(comuna),"8415")>0
# replace comuna= "16207" if strpos(strlower(comuna),"8420")>0
# replace comuna= "16301" if strpos(strlower(comuna),"8416")>0
# replace comuna= "16302" if strpos(strlower(comuna),"8405")>0
# replace comuna= "16303" if strpos(strlower(comuna),"8409")>0
# replace comuna= "16304" if strpos(strlower(comuna),"8417")>0
# replace comuna= "16305" if strpos(strlower(comuna),"8419")>0
pobr_mult_2007_2020<-
rbind.data.frame(pobr_mult_2007, pobr_mult_2008, pobr_mult_2009, pobr_mult_2010, pobr_mult_2011, pobr_mult_2012, pobr_mult_2013, pobr_mult_2014, pobr_mult_2015, pobr_mult_2016, pobr_mult_2017, pobr_mult_2018, pobr_mult_2019, pobr_mult_2020) %>% 
  dplyr::mutate(cod= dplyr::case_when(Código=="16101"~"8401",
                                      Código=="16102"~"8402",
                                      Código=="16103"~"8406",
                                      Código=="16104"~"8407",
                                      Código=="16105"~"8410",
                                      Código=="16106"~"8411",
                                      Código=="16107"~"8413",
                                      Código=="16108"~"8418",
                                      Código=="16109"~"8421",
                                      Código=="16201"~"8414",
                                      Código=="16202"~"8403",
                                      Código=="16203"~"8404",
                                      Código=="16204"~"8408",
                                      Código=="16205"~"8412",
                                      Código=="16206"~"8415",
                                      Código=="16207"~"8420",
                                      Código=="16301"~"8416",
                                      Código=="16302"~"8405",
                                      Código=="16303"~"8409",
                                      Código=="16304"~"8417",
                                      Código=="16305"~"8419",
                                      T~ Código
                                      ))


#2023-02-01:classifications by municipality
class_centros <- readxl::read_excel("_ig_borquez/class_centros.xlsx")%>%
    tidylog::left_join(CONS_C1_df_dup_SEP_2020[,c("id_centro","nombre_centro")], by=c("nombre_centro_1" ="nombre_centro"))%>%
    dplyr::group_by(id_centro)%>%
    slice(1)%>% 
    dplyr::ungroup()%>%
    dplyr::mutate(id_centro=dplyr::case_when(grepl("Allende",nombre_centro_1) & is.na(id_centro)~ "475",  T~ as.character(id_centro)))%>%
    dplyr::group_by(id_centro)%>%
    slice(1)
    #dplyr::filter(grepl("Allende",nombre_centro_1))


Base_fiscalia_v14<-
Base_fiscalia_v13 %>% 
  dplyr::mutate(comuna_residencia_cod_rec= as.character(readr::parse_number(comuna_residencia_cod)), anio_ing_tr= lubridate::epiyear(fech_ing)) %>% #glimpse()
  dplyr::left_join(pobr_mult_2007_2020[,c("anio", "cod","porc_pobr")], by= c("comuna_residencia_cod_rec"="cod", "anio_ing_tr"="anio")) %>% 
  dplyr::left_join(Comunas_PNDR[,c("cod", "Clasificación")], by= c("comuna_residencia_cod_rec"="cod"))%>%
  #2023-02-01
  dplyr::left_join(class_centros[,c("id_centro", "nombre_centro_1", "classification")], by= "id_centro")%>%
    purrr::when(nrow(.)>nrow(Base_fiscalia_v13) ~ stop("More cases in the new database"), ~.) %>% 
  dplyr::mutate(age_offending_imp= dplyr::case_when(age_offending_imp-edad_al_egres_imp<=0~ age_offending_imp+ 0.0001,T~age_offending_imp), event_r= ifelse(!is.na(offender_d),1,0)) %>% 
  dplyr::mutate(freq_cons_sus_prin= dplyr::case_when(as.character(freq_cons_sus_prin)=="Did not use"~"Less than 1 day a week", T~ as.character(freq_cons_sus_prin)))%>%
  dplyr::mutate(escolaridad_rec=parse_factor(as.character(escolaridad_rec),levels=c('3-Completed primary school or less', '2-Completed high school or less', '1-More than high school'), ordered =T,trim_ws=T,include_na =F, locale=locale(encoding = "Latin1"))) %>%  
  dplyr::mutate(freq_cons_sus_prin=parse_factor(as.character(freq_cons_sus_prin),levels=c('Less than 1 day a week','2 to 3 days a week','4 to 6 days a week','1 day a week or more','Daily'), ordered =T,trim_ws=F,include_na =F)) %>% #, locale=locale(encoding = "Latin1")
  dplyr::mutate(across(c("motivodeegreso_mod_imp_rec","sus_principal_mod", "origen_ingreso_mod", "tenencia_de_la_vivienda_mod", "condicion_ocupacional_corr", "dg_cie_10_rec", "macrozona", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "classification", "tr_modality"),~as.factor(.)))%>% 
  dplyr::mutate(via_adm_sus_prin_act= factor(dplyr::case_when(via_adm_sus_prin_act=="Injected Intravenously or Intramuscularly"~ "Other",T~via_adm_sus_prin_act))) %>% 
#TO CHECK IF SOME MUNICIPALLITIES DID NOT JOIN
  #dplyr::filter(is.na(porc_pobr)) %>% dplyr::select(comuna_residencia_cod, anio_ing_tr)
  dplyr::mutate(con_quien_vive_joel=dplyr::case_when(
    grepl("Solo$",con_quien_vive, ignore.case=T)~"Alone",
    grepl("Con abuelos",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con hermanos",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con la madre \\(sola\\)",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con otro pariente",con_quien_vive, ignore.case=T)~"Others",
    grepl("con hijos y padres o familia",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("con la pareja y padres o familia de origen",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("con padres o familia de origen",con_quien_vive, ignore.case=T)~"Family of origin",
    #2021-10-01
    grepl("Únicamente con hijos",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Únicamente con pareja",con_quien_vive, ignore.case=T)~"With couple/children",
    #2021-10-01
    grepl("Con la Pareja, Hijos y Padres o Familia de Origen",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Hijos y Padres o Familia de Origen",con_quien_vive, ignore.case=T)~"Family of origin",
    #2021-10-01
    grepl("Únicamente con la pareja e hijos",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Con amigos",con_quien_vive, ignore.case=T)~"Others",
    grepl("Con otro NO pariente",con_quien_vive, ignore.case=T)~"Others",
    grepl("*Otros$",con_quien_vive, ignore.case=T)~"Others")) %>% 
  dplyr::left_join(subset(CONS_C1_df_dup_SEP_2020, dup==1, c("hash_key","embarazo")), by= "hash_key")%>%
  dplyr::mutate(numero_de_hijos_mod_joel=dplyr::case_when(grepl("Si$",embarazo, ignore.case=T)~as.integer(numero_de_hijos_mod+1),T~as.integer(numero_de_hijos_mod)))  %>% 
  dplyr::mutate(ano_nac_corr=as.numeric(stringr::str_sub(as.character(fech_nac_rec),1,4))) %>% 
  dplyr::mutate(num_hijos_mod_joel_bin=dplyr::if_else(numero_de_hijos_mod_joel>0, 1, 0)) %>%
  dplyr::mutate(across(c("dg_fis_otr_cond_fis_ries_vit", "dg_fis_pat_ges_intrau", "dg_fis_hep_cro", "dg_fis_hep_alc", "dg_fis_enf_som", "dg_fis_otr_cond_fis", "dg_fis_hep_alc", "dg_fis_ets", "dg_fis_card"), ~as.numeric(.)-1)) %>%
  dplyr::mutate(dg_fis_total = rowSums(dplyr::select(., c("dg_fis_otr_cond_fis_ries_vit", "dg_fis_pat_ges_intrau", "dg_fis_hep_cro", "dg_fis_hep_alc", "dg_fis_enf_som", "dg_fis_otr_cond_fis", "dg_fis_hep_alc", "dg_fis_ets", "dg_fis_card")))) %>% 
  dplyr::mutate(cnt_dg_trs_fis= dplyr::case_when(dg_fis_total>=1~ "One or more", as.character(dg_fis_in_study)== "Presence" & dg_fis_total== 0~"Diagnosis unknown (under study)", dg_fis_total==0~"Without physical comorbidity")) %>% #janitor::tabyl(cnt_dg_trs_fis)
  dplyr::mutate(fis_comorbidity_icd_10=parse_factor(as.character(cnt_dg_trs_fis),levels=c('Without physical comorbidity', 'Diagnosis unknown (under study)','One or more'), ordered =T,trim_ws=F,include_na =F)) #, locale=locale(encoding = "Latin1") 

Base_fiscalia_v14_pris<-
Base_fiscalia_v13_pris %>% 
  dplyr::mutate(comuna_residencia_cod_rec= as.character(readr::parse_number(comuna_residencia_cod)), anio_ing_tr= lubridate::epiyear(fech_ing)) %>% #glimpse()
  dplyr::left_join(pobr_mult_2007_2020[,c("anio", "cod","porc_pobr")], by= c("comuna_residencia_cod_rec"="cod", "anio_ing_tr"="anio")) %>% 
  dplyr::left_join(Comunas_PNDR[,c("cod", "Clasificación")], by= c("comuna_residencia_cod_rec"="cod"))%>%
  #2023-02-01
  dplyr::left_join(class_centros[,c("id_centro", "nombre_centro_1", "classification")], by= "id_centro")%>%
    purrr::when(nrow(.)>nrow(Base_fiscalia_v13) ~ stop("More cases in the new database"), ~.)%>% 
  dplyr::mutate(age_offending_imp= dplyr::case_when(age_offending_imp-edad_al_egres_imp<=0~ age_offending_imp+ 0.0001,T~age_offending_imp), event_r= ifelse(!is.na(offender_d),1,0)) %>% 
  dplyr::mutate(freq_cons_sus_prin= dplyr::case_when(as.character(freq_cons_sus_prin)=="Did not use"~"Less than 1 day a week", T~ as.character(freq_cons_sus_prin)))%>%
  dplyr::mutate(escolaridad_rec=parse_factor(as.character(escolaridad_rec),levels=c('3-Completed primary school or less', '2-Completed high school or less', '1-More than high school'), ordered =T,trim_ws=T,include_na =F, locale=locale(encoding = "Latin1"))) %>%  
  dplyr::mutate(freq_cons_sus_prin=parse_factor(as.character(freq_cons_sus_prin),levels=c('Less than 1 day a week','2 to 3 days a week','4 to 6 days a week','1 day a week or more','Daily'), ordered =T,trim_ws=F,include_na =F)) %>% #, locale=locale(encoding = "Latin1")
  dplyr::mutate(freq_cons_sus_prin= as.factor(freq_cons_sus_prin)) %>% 
  dplyr::mutate(across(c("motivodeegreso_mod_imp_rec","sus_principal_mod", "origen_ingreso_mod", "tenencia_de_la_vivienda_mod", "condicion_ocupacional_corr", "dg_cie_10_rec", "macrozona", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "classification", "tr_modality"),~as.factor(.))) %>% 
  dplyr::mutate(via_adm_sus_prin_act= factor(dplyr::case_when(via_adm_sus_prin_act=="Injected Intravenously or Intramuscularly"~ "Other",T~via_adm_sus_prin_act))) %>% 
#TO CHECK IF SOME MUNICIPALLITIES DID NOT JOIN
  #dplyr::filter(is.na(porc_pobr)) %>% dplyr::select(comuna_residencia_cod, anio_ing_tr)  
  dplyr::mutate(con_quien_vive_joel=dplyr::case_when(
    grepl("Solo$",con_quien_vive, ignore.case=T)~"Alone",
    grepl("Con abuelos",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con hermanos",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con la madre \\(sola\\)",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("Con otro pariente",con_quien_vive, ignore.case=T)~"Others",
    grepl("con hijos y padres o familia",con_quien_vive, ignore.case=T)~"Family of origin",
    grepl("con la pareja y padres o familia de origen",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("con padres o familia de origen",con_quien_vive, ignore.case=T)~"Family of origin",
    #2021-10-01
    grepl("Únicamente con hijos",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Únicamente con pareja",con_quien_vive, ignore.case=T)~"With couple/children",
    #2021-10-01
    grepl("Con la Pareja, Hijos y Padres o Familia de Origen",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Hijos y Padres o Familia de Origen",con_quien_vive, ignore.case=T)~"Family of origin",
    #2021-10-01
    grepl("Únicamente con la pareja e hijos",con_quien_vive, ignore.case=T)~"With couple/children",
    grepl("Con amigos",con_quien_vive, ignore.case=T)~"Others",
    grepl("Con otro NO pariente",con_quien_vive, ignore.case=T)~"Others",
    grepl("*Otros$",con_quien_vive, ignore.case=T)~"Others")) %>% 
  dplyr::left_join(subset(CONS_C1_df_dup_SEP_2020, dup==1, c("hash_key","embarazo")), by= "hash_key")%>%
  dplyr::mutate(numero_de_hijos_mod_joel=dplyr::case_when(grepl("Si$",embarazo, ignore.case=T)~as.integer(numero_de_hijos_mod+1),T~as.integer(numero_de_hijos_mod)))  %>% 
  dplyr::mutate(ano_nac_corr=as.numeric(stringr::str_sub(as.character(fech_nac_rec),1,4))) %>% 
  dplyr::mutate(num_hijos_mod_joel_bin=dplyr::if_else(numero_de_hijos_mod_joel>0, 1, 0)) %>%
  dplyr::mutate(across(c("dg_fis_otr_cond_fis_ries_vit", "dg_fis_pat_ges_intrau", "dg_fis_hep_cro", "dg_fis_hep_alc", "dg_fis_enf_som", "dg_fis_otr_cond_fis", "dg_fis_hep_alc", "dg_fis_ets", "dg_fis_card"), ~as.numeric(.)-1)) %>%
  dplyr::mutate(dg_fis_total = rowSums(dplyr::select(., c("dg_fis_otr_cond_fis_ries_vit", "dg_fis_pat_ges_intrau", "dg_fis_hep_cro", "dg_fis_hep_alc", "dg_fis_enf_som", "dg_fis_otr_cond_fis", "dg_fis_ets", "dg_fis_card")))) %>% 
  dplyr::mutate(cnt_dg_trs_fis= dplyr::case_when(dg_fis_total>=1~ "One or more", as.character(dg_fis_in_study)== "Presence" & dg_fis_total== 0~"Diagnosis unknown (under study)", dg_fis_total==0~"Without physical comorbidity")) %>% #janitor::tabyl(cnt_dg_trs_fis)
  dplyr::mutate(fis_comorbidity_icd_10=parse_factor(as.character(cnt_dg_trs_fis),levels=c('Without physical comorbidity', 'Diagnosis unknown (under study)','One or more'), ordered =T,trim_ws=F,include_na =F)) #, locale=locale(encoding = "Latin1") 
                                          
  
#Base_fiscalia_v14 %>% dplyr::filter(dplyr::case_when(age_offending_imp-edad_al_egres_imp<=0~T,T~F))

#Private Therapeutic Community, ref
Base_fiscalia_v14$clas_r <- relevel(factor(Base_fiscalia_v14$Clasificación), ref = "Urbana")
Base_fiscalia_v14_pris$clas_r <- relevel(factor(Base_fiscalia_v14$Clasificación), ref = "Urbana")
Base_fiscalia_v14$via_adm_sus_prin_act <- relevel(factor(Base_fiscalia_v14$via_adm_sus_prin_act), ref = "Oral (drunk or eaten)")
Base_fiscalia_v14_pris$via_adm_sus_prin_act <- relevel(factor(Base_fiscalia_v14_pris$via_adm_sus_prin_act), ref = "Oral (drunk or eaten)")

Base_fiscalia_v14$yrs_to_condemn<- Base_fiscalia_v14$age_offending_imp - Base_fiscalia_v14$edad_al_egres_imp
Base_fiscalia_v14_pris$yrs_to_pris<- Base_fiscalia_v14_pris$age_offending_imp - Base_fiscalia_v14_pris$edad_al_egres_imp

#2022-02-27
Base_fiscalia_v14$clas_centers_r <- Base_fiscalia_v14$classification
Base_fiscalia_v14$classification<- NULL
Base_fiscalia_v14_pris$clas_centers_r <- Base_fiscalia_v14_pris$classification
Base_fiscalia_v14_pris$classification<- NULL

cat_vars_dg_fis<-
c("dg_fis_anemia", "dg_fis_card", "dg_fis_in_study", "dg_fis_enf_som", "dg_fis_ets", "dg_fis_hep_alc", "dg_fis_hep_b", "dg_fis_hep_cro", "dg_fis_inf", "dg_fis_otr_cond_fis_ries_vit", "dg_fis_otr_cond_fis", "dg_fis_pat_buc", "dg_fis_pat_ges_intrau", "dg_fis_trau_sec")

#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_


invisible("to see if there ar imbalances in the categories")
#lapply(preds2, function(p) {round(prop.table(table(as.tibble(Base_fiscalia_v14_pris)[p], exclude=NULL)),3)*100})
  #numero_de_hijos_mod_joel con_quien_vive_joel

attr(Base_fiscalia_v14$motivodeegreso_mod_imp_rec,"label") <- "Motive of Discharge"
attr(Base_fiscalia_v14$tr_modality,"label") <- "Treatment Modality"
attr(Base_fiscalia_v14$edad_al_ing_1,"label") <- "Age (admission to treatment)"
attr(Base_fiscalia_v14$sex,"label") <- "Sex"
attr(Base_fiscalia_v14$edad_ini_cons,"label") <- "Age of Onset of Substance Use"
attr(Base_fiscalia_v14$escolaridad_rec,"label") <- "Educational Attainment"
attr(Base_fiscalia_v14$sus_principal_mod,"label") <- "Primary Substance (admission to treatment)"
attr(Base_fiscalia_v14$freq_cons_sus_prin,"label") <- "Frequency of Substance Use (Primary Substance)"
attr(Base_fiscalia_v14$condicion_ocupacional_corr,"label") <- "Corrected Occupational Status (f)"
attr(Base_fiscalia_v14$policonsumo,"label") <- "Co-occurring Substance Use Disorders (Polysubstance use)"
attr(Base_fiscalia_v14$num_hijos_mod_joel_bin,"label") <- "Number of Children (dichotomized)"
attr(Base_fiscalia_v14$tenencia_de_la_vivienda_mod,"label") <- "Housing Situation (Tenure Status)"
attr(Base_fiscalia_v14$macrozona,"label") <- "Macro Administrative Zone in Chile"
attr(Base_fiscalia_v14$n_off_vio,"label") <- "Violent Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14$n_off_acq,"label") <- "Acquisitive Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14$n_off_sud,"label") <- "Substance-Related Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14$n_off_oth,"label") <- "Other Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14$dg_cie_10_rec,"label") <- "Psychiatric Comorbidity (ICD-10)"
attr(Base_fiscalia_v14$dg_trs_cons_sus_or,"label") <- "SUD Severity (Dependence status)"
attr(Base_fiscalia_v14$clas_r,"label") <- "Socioeconomic Classification"
attr(Base_fiscalia_v14$porc_pobr,"label") <- "Percentage of people in poverty"
attr(Base_fiscalia_v14$sus_ini_mod_mvv,"label") <- "Primary Substance (initial diagnosis)"
attr(Base_fiscalia_v14$ano_nac_corr,"label") <- "Corrected birth year"
attr(Base_fiscalia_v14$con_quien_vive_joel,"label") <- "Cohabitation status (Recoded) (f)"
attr(Base_fiscalia_v14$fis_comorbidity_icd_10,"label") <- "Physical Comorbidity (ICD-10)"


attr(Base_fiscalia_v14_pris$motivodeegreso_mod_imp_rec,"label") <- "Motive of Discharge"
attr(Base_fiscalia_v14_pris$tr_modality,"label") <- "Treatment Modality"
attr(Base_fiscalia_v14_pris$edad_al_ing_1,"label") <- "Age (admission to treatment)"
attr(Base_fiscalia_v14_pris$sex,"label") <- "Sex"
attr(Base_fiscalia_v14_pris$edad_ini_cons,"label") <- "Age of Onset of Substance Use"
attr(Base_fiscalia_v14_pris$escolaridad_rec,"label") <- "Educational Attainment"
attr(Base_fiscalia_v14_pris$sus_principal_mod,"label") <- "Primary Substance (admission to treatment)"
attr(Base_fiscalia_v14_pris$freq_cons_sus_prin,"label") <- "Frequency of Substance Use (Primary Substance)"
attr(Base_fiscalia_v14_pris$condicion_ocupacional_corr,"label") <- "Corrected Occupational Status (f)"
attr(Base_fiscalia_v14_pris$policonsumo,"label") <- "Co-occurring Substance Use Disorders (Polysubstance use)"
attr(Base_fiscalia_v14_pris$num_hijos_mod_joel_bin,"label") <- "Number of Children (dichotomized)"
attr(Base_fiscalia_v14_pris$tenencia_de_la_vivienda_mod,"label") <- "Housing Situation (Tenure Status)"
attr(Base_fiscalia_v14_pris$macrozona,"label") <- "Macro Administrative Zone in Chile"
attr(Base_fiscalia_v14_pris$n_off_vio,"label") <- "Violent Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14_pris$n_off_acq,"label") <- "Acquisitive Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14_pris$n_off_sud,"label") <- "Substance-Related Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14_pris$n_off_oth,"label") <- "Other Criminal Offenses (Pre-Treatment)"
attr(Base_fiscalia_v14_pris$dg_cie_10_rec,"label") <- "Psychiatric Comorbidity (ICD-10)"
attr(Base_fiscalia_v14_pris$dg_trs_cons_sus_or,"label") <- "SUD Severity (Dependence status)"
attr(Base_fiscalia_v14_pris$clas_r,"label") <- "Socioeconomic Classification"
attr(Base_fiscalia_v14_pris$porc_pobr,"label") <- "Percentage of people in poverty"
attr(Base_fiscalia_v14_pris$sus_ini_mod_mvv,"label") <- "Primary Substance (initial diagnosis)"
attr(Base_fiscalia_v14_pris$ano_nac_corr,"label") <- "Corrected birth year"
attr(Base_fiscalia_v14_pris$con_quien_vive_joel,"label") <- "Cohabitation status (Recoded) (f)"
attr(Base_fiscalia_v14_pris$fis_comorbidity_icd_10,"label") <- "Physical Comorbidity (ICD-10)"

#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_

rbind(
  cbind(cat="Admission to baseline treatment age",
        Base_fiscalia_v13 %>% 
          dplyr::summarise(min = as.Date(min(unclass(fech_ing_num_1), na.rm=T), origin = "1970-01-01"),
           p025=as.Date(quantile(unclass(fech_ing_num_1), .025, na.rm=T), origin = "1970-01-01"),
           p25=as.Date(quantile(unclass(fech_ing_num_1), .25, na.rm=T), origin = "1970-01-01"),
           p50=as.Date(quantile(unclass(fech_ing_num_1), .5, na.rm=T), origin = "1970-01-01"),
           p75=as.Date(quantile(unclass(fech_ing_num_1), .75, na.rm=T), origin = "1970-01-01"),
           p975=as.Date(quantile(unclass(fech_ing_num_1), .975, na.rm=T), origin = "1970-01-01"),
           max = as.Date(max(unclass(fech_ing_num_1), na.rm=T), origin = "1970-01-01"))),
  cbind(cat="Date of birth (corrected)",
        Base_fiscalia_v13 %>% 
          dplyr::summarise(min = as.Date(min(unclass(fech_nac_rec), na.rm=T), origin = "1970-01-01"),
           p025=as.Date(quantile(unclass(fech_nac_rec), .025, na.rm=T), origin = "1970-01-01"),
           p25=as.Date(quantile(unclass(fech_nac_rec), .25, na.rm=T), origin = "1970-01-01"),
           p50=as.Date(quantile(unclass(fech_nac_rec), .5, na.rm=T), origin = "1970-01-01"),
           p75=as.Date(quantile(unclass(fech_nac_rec), .75, na.rm=T), origin = "1970-01-01"),
           p975=as.Date(quantile(unclass(fech_nac_rec), .975, na.rm=T), origin = "1970-01-01"),
           max = as.Date(max(unclass(fech_nac_rec), na.rm=T), origin = "1970-01-01")))) %>% 
  knitr::kable(format="html",caption= "Summary of Dates (after correcting dates)") %>% #,col.names=c("Variables","Residential", "Ambulatory", "p-value")) %>% 
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover","condensed"),font_size= 12) 
```

<br>

# Explore

## Crude RMST & RMSTL

We calculated the restricted mean survival time and lost, considering hazards did not seem to be proportional. We considered people with complete data (n= `r nrow(Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),])`) of the total sample (n= `r nrow(Base_fiscalia_v14)`). 

::: controlly 
```{r rmst, echo=T, fig.align='center', message=T, error=T, eval=T, fig.height= 10, fig.cap= "Kaplan-Meier curves by, Difference with age of offense from discharge"}
#Treatment completion Treatment non-completion (Early)  Treatment non-completion (Late) 
yrs_to_condemn_comp_cases<-
Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),"yrs_to_condemn"]
event_r_comp_cases<-
Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),"event_r"]


motivo_egreso_comp_cases <- Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),"motivodeegreso_mod_imp_rec"]
tr_comp_comp_cases<-ifelse(motivo_egreso_comp_cases=="Treatment completion",1,0)
tr_early_drop_comp_cases<-ifelse(motivo_egreso_comp_cases=="Treatment non-completion (Early)",1,0)

tr_late_drop_comp_cases<-ifelse(motivo_egreso_comp_cases=="Treatment non-completion (Late)",1,0)



#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
cat("===============================================================================")
cat("Treatment completion vs. Late and Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_comp_comp_cases, tau=.33)

cat("Treatment completion vs. Late and Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_comp_comp_cases, tau=1)

cat("Treatment completion vs. Late and Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_comp_comp_cases, tau=3)

cat("Treatment completion vs. Late and Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_comp_comp_cases, tau=5)


cat("===============================================================================")
cat("Treatment completion vs. Late Dropouts at 3 months")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=.33)

cat("Treatment completion vs. Late Dropouts at 1 year")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=1)

cat("Treatment completion vs. Late Dropouts at 3 years")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=3)

cat("Treatment completion vs. Late Dropouts at 5 years")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Early",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=5)


cat("===============================================================================")
cat("Treatment completion vs. Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=.33)

cat("Treatment completion vs. Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=1)

cat("Treatment completion vs. Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=3)

cat("Treatment completion vs. Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases[!grepl("Late",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=5)

cat("===============================================================================")
cat("Late vs. Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=.33)

cat("Late vs. Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=1)

cat("Late vs. Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=3)

cat("Late vs. Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_condemn_comp_cases$yrs_to_condemn[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases$event_r[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases[grepl("non",motivo_egreso_comp_cases$motivodeegreso_mod_imp_rec),1], tau=5)

```
:::


::: controlly 
```{r rmst-pris, echo=T, fig.align='center', message=T, error=T, eval=T, fig.height= 10, fig.cap= "Kaplan-Meier curves by, Difference with age of offense from discharge (prison)"}
#Treatment completion Treatment non-completion (Early)  Treatment non-completion (Late) 
yrs_to_pris_comp_cases<-
Base_fiscalia_v14_pris[complete.cases(Base_fiscalia_v14_pris[,c("motivodeegreso_mod_imp_rec", "yrs_to_pris", "event_r")]),"yrs_to_pris"]
event_r_comp_cases_pris<-
Base_fiscalia_v14_pris[complete.cases(Base_fiscalia_v14_pris[,c("motivodeegreso_mod_imp_rec", "yrs_to_pris", "event_r")]),"event_r"]


motivo_egreso_comp_cases_pris <- Base_fiscalia_v14_pris[complete.cases(Base_fiscalia_v14_pris[,c("motivodeegreso_mod_imp_rec", "yrs_to_pris", "event_r")]),"motivodeegreso_mod_imp_rec"]
tr_comp_comp_cases_pris<-ifelse(motivo_egreso_comp_cases_pris=="Treatment completion",1,0)
tr_early_drop_comp_cases_pris<-ifelse(motivo_egreso_comp_cases_pris=="Treatment non-completion (Early)",1,0)

tr_late_drop_comp_cases_pris<-ifelse(motivo_egreso_comp_cases_pris=="Treatment non-completion (Late)",1,0)



#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
cat("===============================================================================")
cat("Treatment completion vs. Late and Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_pris_comp_cases, event_r_comp_cases_pris, tr_comp_comp_cases_pris, tau=.33)

cat("Treatment completion vs. Late and Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_pris_comp_cases, event_r_comp_cases_pris, tr_comp_comp_cases_pris, tau=1)

cat("Treatment completion vs. Late and Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_pris_comp_cases, event_r_comp_cases_pris, tr_comp_comp_cases_pris, tau=3)

cat("Treatment completion vs. Late and Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_pris_comp_cases, event_r_comp_cases_pris, tr_comp_comp_cases_pris, tau=5)


cat("===============================================================================")
cat("Treatment completion vs. Late Dropouts at 3 months")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=.33)

cat("Treatment completion vs. Late Dropouts at 1 year")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=1)

cat("Treatment completion vs. Late Dropouts at 3 years")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=3)

cat("Treatment completion vs. Late Dropouts at 5 years")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Early",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=5)


cat("===============================================================================")
cat("Treatment completion vs. Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=.33)

cat("Treatment completion vs. Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=1)

cat("Treatment completion vs. Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=3)

cat("Treatment completion vs. Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_comp_comp_cases_pris[!grepl("Late",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=5)

cat("===============================================================================")
cat("Late vs. Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=.33)

cat("Late vs. Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=1)

cat("Late vs. Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=3)

cat("Late vs. Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_pris_comp_cases$yrs_to_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               event_r_comp_cases_pris$event_r[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec)], 
               tr_early_drop_comp_cases_pris[grepl("non",motivo_egreso_comp_cases_pris$motivodeegreso_mod_imp_rec),1], tau=5)

```
:::

<br>

## Linearity

We checked the proportionality and linearity of covariates.

::: controlly
```{r diag11, echo=T, fig.align='center', message=T, error=T, eval=T}
preds2<- c("motivodeegreso_mod_imp_rec", "tr_modality", "edad_al_ing_1", "sex", "edad_ini_cons", "escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin", "condicion_ocupacional_corr", "policonsumo", "num_hijos_mod_joel_bin", "tenencia_de_la_vivienda_mod", "macrozona", "n_off_vio", "n_off_acq",  "n_off_sud", "n_off_oth", "clas_r", "dg_cie_10_rec", "dg_trs_cons_sus_or", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", "fis_comorbidity_icd_10")

vars_cov<-c("motivodeegreso_mod_imp_rec", "tr_modality", "edad_al_ing_1", "sex", "edad_ini_cons", "escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin", "condicion_ocupacional_corr", "policonsumo", "num_hijos_mod_joel_bin", "tenencia_de_la_vivienda_mod", "macrozona", "n_off_vio", "n_off_acq",  "n_off_sud", "n_off_oth", "dg_cie_10_rec", "dg_trs_cons_sus_or", "clas_r", "porc_pobr", "sus_ini_mod_mvv", "ano_nac_corr", "con_quien_vive_joel", "fis_comorbidity_icd_10")

#numero_de_hijos_mod_joel ano_nac_corr con_quien_vive_joel

coxfit_more_var1 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec +", paste(setdiff(vars_cov,""), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)#[1:250,]
#n_prev_off + 
coxfit_more_var05 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec +", paste(setdiff(vars_cov,""), collapse = "+"))), ties="efron", data= Base_fiscalia_v14 %>% dplyr::mutate(edad_al_ing_1= VGAM::yeo.johnson(Base_fiscalia_v14$edad_al_ing_1, .5)))#[1:250,]


#*If you are not directly interested in the relations of x1 or x2 to outcome and are simply controlling for them to analyze your predictor of main interest, then you don't have to worry much about the initially confusing display of p-values and hazard ratios for each of the terms associated with the splines.

coxfit_more_var2 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,3) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var3 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,4) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var4 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,5) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var5 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,6) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var6 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var7 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 2) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var8 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 3) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var9 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 4) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

anova(coxfit_more_var05, coxfit_more_var1, coxfit_more_var2, coxfit_more_var3, coxfit_more_var4, coxfit_more_var5, coxfit_more_var6, coxfit_more_var7, coxfit_more_var8, coxfit_more_var9)

anova(coxfit_more_var3, coxfit_more_var4, coxfit_more_var5,  coxfit_more_var8, coxfit_more_var9)

invisible("coxfit_more_var3 , rcs 4, the best")

# Dimitris Rizopoulos (https://stats.stackexchange.com/users/219012/dimitris-rizopoulos), Check log-linearity of a continuous variable to predict survival, URL (version: 2018-10-08): https://stats.stackexchange.com/q/370353

# https://www.drizopoulos.com/courses/EMC/EP03.pdf

# Create an effect plot to depict the relationship
ND <- with(Base_fiscalia_v14, 
data.frame(edad_al_ing_1 = seq(min(edad_al_ing_1),  max(edad_al_ing_1), length.out = 50),
            motivodeegreso_mod_imp_rec=rep(Mode(motivodeegreso_mod_imp_rec),50),
            #edad_al_ing_1=rep(mean(edad_al_ing_1, na.rm=T))
            tr_modality= rep(Mode(tr_modality),50),
            sex= rep(Mode(sex),50),
            edad_ini_cons=rep(quantile(edad_ini_cons, .5, na.rm=T),50),
            escolaridad_rec= rep(Mode(escolaridad_rec),50),
            sus_principal_mod= rep(Mode(sus_principal_mod),50),
            freq_cons_sus_prin= rep(Mode(freq_cons_sus_prin),50),
            condicion_ocupacional_corr= rep(Mode(condicion_ocupacional_corr),50),
            policonsumo= rep(Mode(policonsumo),50),
            num_hijos_mod_joel_bin= rep(Mode(num_hijos_mod_joel_bin),50),
            tenencia_de_la_vivienda_mod= rep(Mode(tenencia_de_la_vivienda_mod),50),
            macrozona = rep(Mode(macrozona),50),
            #n_prev_off= rep(quantile(n_prev_off, .5, na.rm=T),50),
            n_off_vio= rep(Mode(n_off_vio),50),
            n_off_acq= rep(Mode(n_off_acq),50),
            n_off_sud= rep(Mode(n_off_sud),50),
            n_off_oth= rep(Mode(n_off_oth),50),
            dg_cie_10_rec = rep(Mode(dg_cie_10_rec),50),
            dg_trs_cons_sus_or = rep(Mode(dg_trs_cons_sus_or),50),
            clas_r= rep(Mode(clas_r),50),
            porc_pobr=rep(quantile(porc_pobr, .5, na.rm=T),50),
            sus_ini_mod_mvv=rep(Mode(sus_ini_mod_mvv),50),
            ano_nac_corr=rep(quantile(ano_nac_corr, .5, na.rm=T),50),
            con_quien_vive_joel=rep(Mode(con_quien_vive_joel),50),
            fis_comorbidity_icd_10=rep(Mode(fis_comorbidity_icd_10),50)
))

prs <- predict(coxfit_more_var3, newdata = ND, type = "lp", se.fit = TRUE)
ND$pred <- prs[[1]]
ND$se <- prs[[2]]
ND$lo <- ND$pred - 1.96 * ND$se
ND$up <- ND$pred + 1.96 * ND$se

xyplot(pred + lo + up ~ edad_al_ing_1, data = ND,
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Admission age")


prs2 <- predict(coxfit_more_var3, newdata = ND%>% dplyr::mutate(edad_ini_cons= seq(min(Base_fiscalia_v14$edad_ini_cons,na.rm=T),  max(Base_fiscalia_v14$edad_ini_cons,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T))), type = "lp", se.fit = TRUE)
ND$pred2 <- prs2[[1]]
ND$se2 <- prs2[[2]]
ND$lo2 <- ND$pred2 - 1.96 * ND$se2
ND$up2 <- ND$pred2 + 1.96 * ND$se2

xyplot(pred2 + lo2 + up2 ~ edad_ini_cons, data = ND%>% dplyr::mutate(edad_ini_cons= seq(min(Base_fiscalia_v14$edad_ini_cons,na.rm=T),  max(Base_fiscalia_v14$edad_ini_cons,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T))),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Substance use onset age")

prs3 <- predict(coxfit_more_var3, newdata = ND%>% dplyr::mutate(ano_nac_corr= seq(min(Base_fiscalia_v14$ano_nac_corr,na.rm=T),  max(Base_fiscalia_v14$ano_nac_corr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T))), type = "lp", se.fit = TRUE)
ND$pred3 <- prs3[[1]]
ND$se3 <- prs3[[2]]
ND$lo3 <- ND$pred3 - 1.96 * ND$se3
ND$up3 <- ND$pred3 + 1.96 * ND$se3

xyplot(pred3 + lo3 + up3 ~ ano_nac_corr, data = ND%>% dplyr::mutate(ano_nac_corr= seq(min(Base_fiscalia_v14$ano_nac_corr,na.rm=T),  max(Base_fiscalia_v14$ano_nac_corr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T))),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Year of birth")

prs4 <- predict(coxfit_more_var3, newdata = ND%>% dplyr::mutate(porc_pobr= seq(min(Base_fiscalia_v14$porc_pobr,na.rm=T),  max(Base_fiscalia_v14$porc_pobr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T))), type = "lp", se.fit = TRUE)
ND$pred4 <- prs4[[1]]
ND$se4 <- prs4[[2]]
ND$lo4 <- ND$pred4 - 1.96 * ND$se4
ND$up4 <- ND$pred4 + 1.96 * ND$se4

xyplot(pred4 + lo4 + up4 ~ porc_pobr, data = ND%>% dplyr::mutate(porc_pobr= seq(min(Base_fiscalia_v14$porc_pobr,na.rm=T),  max(Base_fiscalia_v14$porc_pobr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T))),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Percentage of poverty")
```
:::


::: controlly
```{r diag2, echo=T, fig.align='center', message=T, error=T, eval=F}
#http://www.sthda.com/english/wiki/cox-model-assumptions
invisible("omitted")
invisible("Martingale residual to assess nonlinearity, does not allow ns or rcs")
# 
# #https://github.com/kassambara/survminer/issues/357
 res.cox_edad_ing <- coxph(Surv(yrs_to_condemn,  event_r) ~ edad_al_ing_1+ log(edad_al_ing_1) + I(edad_al_ing_1^2) + I(log(edad_al_ing_1)^2) + I(sqrt(edad_al_ing_1)), data = Base_fiscalia_v14)
 
 
 ggcoxfunctional(res.cox_edad_ing,  data = Base_fiscalia_v14%>% dplyr::filter(!is.na(edad_al_ing_1)), point.col = "blue", point.alpha = 0.5)
 
cat("______________________________________________________________________") 
 
# 
# #to avoid errors, we deleted missing values
# 
 res.cox_porc_pobr <- coxph(Surv(yrs_to_condemn,  event_r) ~ porc_pobr + log(porc_pobr) + I(porc_pobr^2) + I(log(porc_pobr)^2) + I(sqrt(porc_pobr)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(porc_pobr)))
# 
 ggcoxfunctional(res.cox_porc_pobr,  data = Base_fiscalia_v14%>% dplyr::filter(!is.na(porc_pobr)), point.col = "blue", point.alpha = 0.5)

cat("______________________________________________________________________")
  
#to avoid errors, we replaced 0s with 0.0001
res.cox_dias_treat <- coxph(Surv(yrs_to_condemn,  event_r) ~ dias_treat_imp_sin_na_1 + log(dias_treat_imp_sin_na_1) + I(log(dias_treat_imp_sin_na_1)^2) + I(dias_treat_imp_sin_na_1^2) +  I(sqrt(dias_treat_imp_sin_na_1)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(dias_treat_imp_sin_na_1)) %>% dplyr::mutate(dias_treat_imp_sin_na_1= dplyr::case_when(dias_treat_imp_sin_na_1==0~.0001,T~dias_treat_imp_sin_na_1)))

ggcoxfunctional(res.cox_dias_treat,  data = Base_fiscalia_v14%>% dplyr::filter(!is.na(dias_treat_imp_sin_na_1)) %>% dplyr::mutate(dias_treat_imp_sin_na_1= dplyr::case_when(dias_treat_imp_sin_na_1==0~.0001,T~dias_treat_imp_sin_na_1)), point.col = "blue", point.alpha = 0.5)

cat("______________________________________________________________________")

res.cox_num_hijos <- coxph(Surv(yrs_to_condemn,  event_r) ~ numero_de_hijos_mod + log(numero_de_hijos_mod) + I(log(numero_de_hijos_mod)^2) + I(numero_de_hijos_mod^2) +  I(sqrt(numero_de_hijos_mod)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(numero_de_hijos_mod)) %>% dplyr::mutate(numero_de_hijos_mod= dplyr::case_when(numero_de_hijos_mod==0~.0001,T~as.numeric(numero_de_hijos_mod))))

ggcoxfunctional(res.cox_num_hijos,  data =  Base_fiscalia_v14%>% dplyr::filter(!is.na(numero_de_hijos_mod)) %>% dplyr::mutate(numero_de_hijos_mod= dplyr::case_when(numero_de_hijos_mod==0~.0001,T~as.numeric(numero_de_hijos_mod))), point.col = "blue", point.alpha = 0.5)

cat("______________________________________________________________________")

res.cox_n_prev_off <- coxph(Surv(yrs_to_condemn,  event_r) ~ n_prev_off + log(n_prev_off) + I(log(n_prev_off)^2) + I(n_prev_off^2) +  I(sqrt(n_prev_off)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(n_prev_off)) %>% dplyr::mutate(n_prev_off= dplyr::case_when(n_prev_off==0~.0001,T~as.numeric(n_prev_off))))

ggcoxfunctional(res.cox_n_prev_off,  data =  Base_fiscalia_v14%>% dplyr::filter(!is.na(n_prev_off)) %>% dplyr::mutate(n_prev_off= dplyr::case_when(n_prev_off==0~.0001,T~as.numeric(n_prev_off))), point.col = "blue", point.alpha = 0.5)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
check_PH <- cox.zph(coxfit_more_var3, transform="km")
data.frame(check_PH$table)%>% 
  knitr::kable("markdown", caption= "Schoefeld residuals") #sigue alto
```
:::

::: controlly
```{r diag2-2, echo=T, fig.align='center', message=T, error=T, eval=T}
check_PH <- cox.zph(coxfit_more_var3, transform="km")
data.frame(check_PH$table)%>% 
  knitr::kable("markdown", caption= "Schoefeld residuals")
```
:::


::: controlly
```{r diag11-pris, echo=T, fig.align='center', message=T, error=T, eval=T}

#numero_de_hijos_mod_joel ano_nac_corr con_quien_vive_joel

coxfit_more_var21 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec +", paste(setdiff(vars_cov,""), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)#[1:250,]
#n_prev_off + 
coxfit_more_var205 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec +", paste(setdiff(vars_cov,""), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris %>% dplyr::mutate(edad_al_ing_1= VGAM::yeo.johnson(Base_fiscalia_v14$edad_al_ing_1, .5)))#[1:250,]


#*If you are not directly interested in the relations of x1 or x2 to outcome and are simply controlling for them to analyze your predictor of main interest, then you don't have to worry much about the initially confusing display of p-values and hazard ratios for each of the terms associated with the splines.

coxfit_more_var22 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,3) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

coxfit_more_var23 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,4) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

coxfit_more_var24 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,5) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

coxfit_more_var25 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,6) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

coxfit_more_var26 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

coxfit_more_var27 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 2) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

coxfit_more_var28 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 3) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

coxfit_more_var29 <- coxph(as.formula(paste("Surv(yrs_to_pris,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 4) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14_pris)

anova(coxfit_more_var205, coxfit_more_var21, coxfit_more_var22, coxfit_more_var23, coxfit_more_var24, coxfit_more_var25, coxfit_more_var26, coxfit_more_var27, coxfit_more_var28, coxfit_more_var29)

anova(coxfit_more_var23, coxfit_more_var25, coxfit_more_var29,coxfit_more_var28)

invisible("coxfit_more_var25 , rcs 6, the best; but for linearity, coxfit_more_var23")

# Dimitris Rizopoulos (https://stats.stackexchange.com/users/219012/dimitris-rizopoulos), Check log-linearity of a continuous variable to predict survival, URL (version: 2018-10-08): https://stats.stackexchange.com/q/370353

# Create an effect plot to depict the relationship
ND_pris <- with(Base_fiscalia_v14_pris, 
data.frame(edad_al_ing_1 = seq(min(edad_al_ing_1),  max(edad_al_ing_1), length.out = 50),
            motivodeegreso_mod_imp_rec=rep(Mode(motivodeegreso_mod_imp_rec),50),
            #edad_al_ing_1=rep(mean(edad_al_ing_1, na.rm=T))
            tr_modality= rep(Mode(tr_modality),50),
            sex= rep(Mode(sex),50),
            edad_ini_cons=rep(quantile(edad_ini_cons, .5, na.rm=T),50),
            escolaridad_rec= rep(Mode(escolaridad_rec),50),
            sus_principal_mod= rep(Mode(sus_principal_mod),50),
            freq_cons_sus_prin= rep(Mode(freq_cons_sus_prin),50),
            condicion_ocupacional_corr= rep(Mode(condicion_ocupacional_corr),50),
            policonsumo= rep(Mode(policonsumo),50),
            num_hijos_mod_joel_bin= rep(Mode(num_hijos_mod_joel_bin),50),
            tenencia_de_la_vivienda_mod= rep(Mode(tenencia_de_la_vivienda_mod),50),
            macrozona = rep(Mode(macrozona),50),
            #n_prev_off= rep(quantile(n_prev_off, .5, na.rm=T),50),
            n_off_vio= rep(Mode(n_off_vio),50),
            n_off_acq= rep(Mode(n_off_acq),50),
            n_off_sud= rep(Mode(n_off_sud),50),
            n_off_oth= rep(Mode(n_off_oth),50),
            dg_cie_10_rec = rep(Mode(dg_cie_10_rec),50),
            dg_trs_cons_sus_or = rep(Mode(dg_trs_cons_sus_or),50),
            clas_r= rep(Mode(clas_r),50),
            porc_pobr=rep(quantile(porc_pobr, .5, na.rm=T),50),
            sus_ini_mod_mvv=rep(Mode(sus_ini_mod_mvv),50),
            ano_nac_corr=rep(quantile(ano_nac_corr, .5, na.rm=T),50),
            con_quien_vive_joel=rep(Mode(con_quien_vive_joel),50),
            fis_comorbidity_icd_10=rep(Mode(fis_comorbidity_icd_10),50)
))

prs_pris <- predict(coxfit_more_var23, newdata = ND_pris, type = "lp", se.fit = TRUE)
ND_pris$pred <- prs_pris[[1]]
ND_pris$se <- prs_pris[[2]]
ND_pris$lo <- ND_pris$pred - 1.96 * ND_pris$se
ND_pris$up <- ND_pris$pred + 1.96 * ND_pris$se

xyplot(pred + lo + up ~ edad_al_ing_1, data = ND_pris,
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Admission age")

prs2 <- predict(coxfit_more_var23, newdata = ND_pris%>% dplyr::mutate(edad_ini_cons= seq(min(Base_fiscalia_v14_pris$edad_ini_cons,na.rm=T),  max(Base_fiscalia_v14_pris$edad_ini_cons,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14_pris$edad_al_ing_1, .5, na.rm=T))), type = "lp", se.fit = TRUE)
ND_pris$pred2 <- prs2[[1]]
ND_pris$se2 <- prs2[[2]]
ND_pris$lo2 <- ND_pris$pred2 - 1.96 * ND_pris$se2
ND_pris$up2 <- ND_pris$pred2 + 1.96 * ND_pris$se2

xyplot(pred2 + lo2 + up2 ~ edad_ini_cons, data = ND_pris%>% dplyr::mutate(edad_ini_cons= seq(min(Base_fiscalia_v14_pris$edad_ini_cons,na.rm=T),  max(Base_fiscalia_v14_pris$edad_ini_cons,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14_pris$edad_al_ing_1, .5, na.rm=T))),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Substance use onset age")

prs3 <- predict(coxfit_more_var23, newdata = ND_pris%>% dplyr::mutate(ano_nac_corr= seq(min(Base_fiscalia_v14_pris$ano_nac_corr,na.rm=T),  max(Base_fiscalia_v14_pris$ano_nac_corr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14_pris$edad_al_ing_1, .5, na.rm=T))), type = "lp", se.fit = TRUE)
ND_pris$pred3 <- prs3[[1]]
ND_pris$se3 <- prs3[[2]]
ND_pris$lo3 <- ND_pris$pred3 - 1.96 * ND_pris$se3
ND_pris$up3 <- ND_pris$pred3 + 1.96 * ND_pris$se3

xyplot(pred3 + lo3 + up3 ~ ano_nac_corr, data = ND_pris%>% dplyr::mutate(ano_nac_corr= seq(min(Base_fiscalia_v14_pris$ano_nac_corr,na.rm=T),  max(Base_fiscalia_v14_pris$ano_nac_corr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14_pris$edad_al_ing_1, .5, na.rm=T))),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Year of birth")

prs4 <- predict(coxfit_more_var23, newdata = ND_pris%>% dplyr::mutate(porc_pobr= seq(min(Base_fiscalia_v14_pris$porc_pobr,na.rm=T),  max(Base_fiscalia_v14_pris$porc_pobr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14_pris$edad_al_ing_1, .5, na.rm=T))), type = "lp", se.fit = TRUE)
ND_pris$pred4 <- prs4[[1]]
ND_pris$se4 <- prs4[[2]]
ND_pris$lo4 <- ND_pris$pred4 - 1.96 * ND_pris$se4
ND_pris$up4 <- ND_pris$pred4 + 1.96 * ND_pris$se4

xyplot(pred4 + lo4 + up4 ~ porc_pobr, data = ND_pris%>% dplyr::mutate(porc_pobr= seq(min(Base_fiscalia_v14_pris$porc_pobr,na.rm=T),  max(Base_fiscalia_v14_pris$porc_pobr,na.rm=T), length.out = 50))%>% dplyr::mutate(`rcs(edad_al_ing_1, 4)edad_al_ing_1`= log(quantile(Base_fiscalia_v14_pris$edad_al_ing_1, .5, na.rm=T))),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio", main="Percentage of poverty")
```
:::


::: controlly
```{r diag2-2-pris, echo=T, fig.align='center', message=T, error=T, eval=T}
check_PH_pris <- cox.zph(coxfit_more_var23, transform="km")
data.frame(check_PH_pris$table)%>% 
  knitr::kable("markdown", caption= "Schoefeld residuals (prison)")
```
:::

<br>

## Kaplan-Meier

```{r diag3, echo=T, fig.align='center', message=T, error=T, eval=T, fig.cap= "Kaplan-Meier (Cond. Sentence)"}
#Bradburn, M., Clark, T., Love, S. et al. Survival Analysis Part III: Multivariate data analysis – choosing a model and assessing its adequacy and fit. Br J Cancer 89, 605–611 (2003). https://doi.org/10.1038/sj.bjc.6601120

KM_fit <- survfit(Surv(age_offending_imp-edad_al_egres_imp, event_r) ~ 
    strata(motivodeegreso_mod_imp_rec), data = Base_fiscalia_v14)

par(mfrow = c(1, 2))

plot(KM_fit, xlab = "Years", ylab = "Survival", col = 2:4, main="Survival")
#legend("topright", levels(factor(Base_fiscalia_v14$motivodeegreso_mod_imp_rec)), lty = 1, col = 2:4, bty = "n")

plot(KM_fit, fun = function (s) -log(-log(s)), xlab = "Years", 
    ylab = "-log(- log(Survival))", col = 2:4, main="-Log(−log(survival)) ")
legend("topright", levels(factor(Base_fiscalia_v14$motivodeegreso_mod_imp_rec)), lty = 1, col = 2:4, bty = "n")
```


```{r diag3-pris, echo=T, fig.align='center', message=T, error=T, eval=T, fig.cap= "Kaplan-Meier (Prison)"}
KM_fit_pris <- survfit(Surv(age_offending_imp-edad_al_egres_imp, event_r) ~ 
    strata(motivodeegreso_mod_imp_rec), data = Base_fiscalia_v14_pris)

par(mfrow = c(1, 2))

plot(KM_fit_pris, xlab = "Years", ylab = "Survival", col = 2:4, main="Survival")
#legend("topright", levels(factor(Base_fiscalia_v14$motivodeegreso_mod_imp_rec)), lty = 1, col = 2:4, bty = "n")

plot(KM_fit_pris, fun = function (s) -log(-log(s)), xlab = "Years", 
    ylab = "-log(- log(Survival))", col = 2:4, main="-Log(−log(survival)) ")
legend("topright", levels(factor(Base_fiscalia_v14_pris$motivodeegreso_mod_imp_rec)), lty = 1, col = 2:4, bty = "n")
```

<br>

```{r diag4, echo=T, fig.align='center', message=T, error=T, eval=T, fig.cap="Schoefeld residuals, Treatment Outcome", fig.height=8}
par(mfrow = c(2, 1))

plot(check_PH, var = 1, ylab= "Beta(t) for Treatment outcome", col = "red", lwd = 2, main= "Cond. Sentence", xlab="")
abline(h = coef(coxfit_more_var3)[1], col = "red", lwd = 2)

plot(check_PH_pris, var = 1, ylab= "Beta(t) for Treatment outcome", col = "red", lwd = 2, main="Prison")
abline(h = coef(coxfit_more_var23)[1], col = "red", lwd = 2)
```

```{r diag5, echo=T, fig.align='center', message=T, error=T, eval=T, fig.cap="Schoefeld residuals, Treatment Outcome", fig.height=8}

```

```{r diag2-6, echo=T, fig.align='center', message=T, error=T, eval=F}

cat("(==============================# EXPERIMENTAL, COXED ======================================)")
invisible("http://dx.doi.org/10.7910/DVN/ELT9VD")
invisible("https://cran.r-project.org/web/packages/coxed/coxed.pdf")
invisible("https://cran.r-project.org/web/packages/coxed/vignettes/coxed.html")

system.time({
npsf1<-coxed(coxfit_more_var8, method="npsf")
})
warning("Error: cannot allocate vector of size 18.3 Gb")
#https://search.r-project.org/CRAN/refmans/pec/html/predictSurvProb.html
system.time({
npsf2<-coxed(coxfit_more_var8, method="npsf", bootstrap = T)
})
system.time({
coxed_gam<-coxed(coxfit_more_var8, method="gam",bootstrap = TRUE, B=100,
  newdata= dplyr::mutate(Base_fiscalia_v14, motivodeegreso_mod_imp_rec="Treatment completion"), 
  newdata2= dplyr::mutate(Base_fiscalia_v14,motivodeegreso_mod_imp_rec="Treatment non-completion (Early)"),
  newdata3= dplyr::mutate(Base_fiscalia_v14,motivodeegreso_mod_imp_rec="Treatment non-completion (Late)")) #newdata3= dplyr::mutate(motivodeegreso_mod_imp_rec="Treatment non-completion (Late)")
}) 
invisible("Inclusion of censored cases increases mean duration by more than 25%. Consider using method='npsf' instead")

cat("(====================================================================)")

invisible("https://cran.r-project.org/web/packages/randomForestSRC/randomForestSRC.pdf")

follic.obj <- randomForestSRC::rfsrc(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ ", paste(vars_cov, collapse = "+ "))), Base_fiscalia_v14_mod %>% dplyr::mutate(cat_ocupacional_corr= factor(cat_ocupacional_corr), dg_trs_cons_sus_or= factor(dg_trs_cons_sus_or)), nsplit = 3, ntree = 100)

p.v <- plot.variable(follic.obj, target = 2)
p.v$plots.per.page <- 1


invisible("Error in finalizeData(c(subj.names, yvar.names, xvar.names), data, na.action,  : 
  data types cannot be character: please convert all characters to factors")
```

```{r survex1, echo=T, fig.align='center', message=T, error=T, eval=F}
# 
cat("(==============================# EXPERIMENTAL, Survex ======================================)")
require("mboost")

prueba_stata<-rio::import("mariel_feb_23.dta")

my_vector <- c("motivodeegreso_mod_imp_rec", "tr_mod2", "edad_al_ing_1", "sex_dum2", "edad_ini_cons", "esc1", "esc2", "sus_prin2", "sus_prin3", "sus_prin4", "sus_prin5", "fr_cons_sus_prin2", "fr_cons_sus_prin3", "fr_cons_sus_prin4", "fr_cons_sus_prin5", "cond_ocu2", "cond_ocu3", "cond_ocu4", "cond_ocu5", "cond_ocu6", "policonsumo", "num_hij2", "tenviv1", "tenviv2", "tenviv4", "tenviv5", "mzone2", "mzone3", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "rural2", "rural3", "porc_pobr", "susini2", "susini3", "susini4", "susini5", "dg_fis_anemia", "dg_fis_card", "dg_fis_enf_som", "dg_fis_ets", "dg_fis_hep_alc", "dg_fis_hep_b", "dg_fis_hep_cro", "dg_fis_inf", "dg_fis_otr_cond_fis_ries_vit", "dg_fis_otr_cond_fis", "dg_fis_pat_buc", "dg_fis_pat_ges_intrau", "dg_fis_trau_sec")

# create a model
#ranger(as.formula(paste("Surv(diff, event)~ ", paste(my_vector, collapse = "+"))), data = prueba_stata[complete.cases(prueba_stata[,my_vector]),])
model <- 
  glmboost(as.formula(paste("Surv(diff, event)~ ", paste(my_vector, collapse = "+"))),
  data = prueba_stata, family = CoxPH(), center = TRUE, control=boost_control(mstop = 500))

#Computes the predicted survivor function for a Cox proportional hazards model.
pred_boost_cph<-survFit(model)

plot(varimp(model), blorder = "rev_alphabetical")
```

<br>

# Missing data

::: controlly

```{r miss, warning=FALSE, echo=T, error=T, eval=T}
set.seed(2125)
Base_fiscalia_v14_miss <-
subset(Base_fiscalia_v14, select= c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec", "offender_d", "age_offending_imp", "edad_al_egres_imp")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>% 
   missRanger::missRanger(
                formula = .  -offender_d - age_offending_imp ~ . - hash_key -offender_d - age_offending_imp,
                num.trees = 200, 
                pmm.k = 3,                
                returnOOB=T,
                maxiter= 50,
                verbose = 2, 
                seed = 2125)

set.seed(2125)
  Base_fiscalia_v14_pris_miss <-
subset(Base_fiscalia_v14_pris, select= c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec", "offender_d", "age_offending_imp", "edad_al_egres_imp")) %>% 
     missRanger::missRanger(
                formula = .  -offender_d - age_offending_imp ~ . - hash_key -offender_d - age_offending_imp,
                num.trees = 200, 
                pmm.k = 3,
                returnOOB=T,
                maxiter= 50,
                verbose = 2,
                seed = 2125)

set.seed(2125)
Base_fiscalia_v14_miss2 <-
subset(Base_fiscalia_v14, select= c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec", "offender_d", "age_offending_imp", "edad_al_egres_imp")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>% 
  dplyr::mutate(dg_cie_10_rec= dplyr::case_when(as.character(dg_cie_10_rec)=="Diagnosis unknown (under study)"~NA_character_,T~as.character(dg_cie_10_rec)))%>%
  #code to multiple response in  physical comorbidity (deprecated)
  #dplyr::mutate(SUM = rowSums(dplyr::mutate_all(dplyr::select(., dplyr::starts_with("dg_fis")),~as.numeric(.)-1))) %>% 
  #dplyr::mutate(across(dplyr::starts_with("dg_fis"), ~factor(dplyr::case_when(as.character(dg_fis_in_study)=="Presence" & SUM==1 ~NA_character_,T~as.character(.))))) %>%
  dplyr::mutate(fis_comorbidity_icd_10= dplyr::case_when(as.character(fis_comorbidity_icd_10)=="Diagnosis unknown (under study)"~NA_character_,T~as.character(fis_comorbidity_icd_10)))%>% 
  missRanger::missRanger(
                formula = .  -offender_d - age_offending_imp ~ . - hash_key -offender_d - age_offending_imp,
                num.trees = 200, 
                pmm.k = 3,                
                returnOOB=T,
                maxiter= 50,
                verbose = 2, 
                seed = 2125)

set.seed(2125)
  Base_fiscalia_v14_pris_miss2 <-
subset(Base_fiscalia_v14_pris, select= c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec", "offender_d", "age_offending_imp", "edad_al_egres_imp")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>% 
  dplyr::mutate(dg_cie_10_rec= dplyr::case_when(as.character(dg_cie_10_rec)=="Diagnosis unknown (under study)"~NA_character_,T~as.character(dg_cie_10_rec)))%>%
  # dplyr::mutate(SUM = rowSums(dplyr::mutate_all(dplyr::select(., dplyr::starts_with("dg_fis")),~as.numeric(.)-1))) %>% 
  # dplyr::mutate(across(dplyr::starts_with("dg_fis"), ~factor(dplyr::case_when(as.character(dg_fis_in_study)=="Presence" & SUM==1 ~NA_character_,T~as.character(.))))) %>%
  dplyr::mutate(fis_comorbidity_icd_10= dplyr::case_when(as.character(fis_comorbidity_icd_10)=="Diagnosis unknown (under study)"~NA_character_,T~as.character(fis_comorbidity_icd_10)))%>% 
   missRanger::missRanger(
                formula = .  -offender_d - age_offending_imp ~ . - hash_key -offender_d - age_offending_imp,
                num.trees = 200, 
                pmm.k = 3,                
                returnOOB=T,
                maxiter= 50,
                verbose = 2, 
                seed = 2125)
```

:::

<br>


# Export

```{r export, warning=FALSE, echo=T, error=T, eval=T}
#2023-01-01 we had a problem with edad_al_ing_fmt. This variable predict better (it had lower amount of missing data and was in wide format)

#cont_vars_desc[1]<-ifelse(cont_vars_desc[1]=="edad_al_ing_fmt","edad_al_ing_1",cont_vars_desc[1])

library(missRanger)
#attr(Base_fiscalia_v14$tipo_centro,"label") <- "Type of Center"

subset(Base_fiscalia_v14, select= c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec", "offender_d", "age_offending_imp", "edad_al_egres_imp")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1)  %>% 
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA.dta"))

subset(Base_fiscalia_v14_pris, select= c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec", "offender_d", "age_offending_imp", "edad_al_egres_imp")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>%   
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_pris.dta"))


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
# IMPUTATION
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

Base_fiscalia_v14_miss %>% 
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss.dta"))

  
Base_fiscalia_v14_pris_miss %>%   
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss_pris.dta"))


Base_fiscalia_v14_miss2 %>% 
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss2.dta"))

  
Base_fiscalia_v14_pris_miss2 %>%   
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss_pris2.dta"))
```

<br>

----

# Characteristics

::: controlly 
```{r desc, echo=T, fig.align='center', message=T, error=T, eval=T}
# Treatment status (Early dropout/Late dropout/Treatment completion) 

as.data.frame.TableOne <- function(x, ...) {capture.output(print(x,
                          showAllLevels = TRUE, ...) -> x)
  y <- as.data.frame(x)
  y$characteristic <- dplyr::na_if(rownames(x), "")
  y <- y %>%
  fill(characteristic, .direction = "down") %>%
  select(characteristic, everything())
  rownames(y) <- NULL
  y}

tbone_desc_merge5<-
CreateTableOne(vars=c(setdiff(vars_cov, "motivodeegreso_mod_imp_rec"), "offender_d"), data=  subset(Base_fiscalia_v14, select=c(vars_cov, "offender_d"), subset=!is.na(motivodeegreso_mod_imp_rec)), factorVars = setdiff(vars_cov, c("motivodeegreso_mod_imp_rec","edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr")), smd=T, strata="motivodeegreso_mod_imp_rec", addOverall = T, includeNA=T, test=T)

as.data.frame.TableOne(tbone_desc_merge5, smd=T, nonnormal= T)%>% 
  dplyr::mutate(char2=characteristic) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold") %>%
  dplyr::select(-1) %>% 
  knitr::kable(size=10, format="markdown",caption= "Summary descriptives, Condemnatory sentence(1), Found as an imputed (YES), by Baseline Treatment Status", escape=T)
#kable(size=10, format="html",caption= "Summary descriptives, by Baseline Treatment Status") %>%     kableExtra::kable_classic()
```
:::


::: controlly 
```{r desc-pris, echo=T, fig.align='center', message=T, error=T, eval=T}
# Treatment status (Early dropout/Late dropout/Treatment completion) 

tbone_desc_merge52<-
CreateTableOne(vars=c(setdiff(vars_cov, "motivodeegreso_mod_imp_rec"), "offender_d"), data=  subset(Base_fiscalia_v14, select=c(vars_cov, "offender_d"), subset=!is.na(motivodeegreso_mod_imp_rec)), factorVars = setdiff(vars_cov, c("motivodeegreso_mod_imp_rec","edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr")), smd=T, strata="motivodeegreso_mod_imp_rec", addOverall = T, includeNA=T, test=T)

tbone_desc_merge53<-
CreateTableOne(vars=c(setdiff(vars_cov, "motivodeegreso_mod_imp_rec"), "offender_d"), data=  subset(Base_fiscalia_v14_pris, select=c(vars_cov, "offender_d"), subset=!is.na(motivodeegreso_mod_imp_rec)), factorVars = setdiff(vars_cov, c("motivodeegreso_mod_imp_rec","edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr")), smd=T, strata="motivodeegreso_mod_imp_rec", addOverall = T, includeNA=T, test=T)

bind_rows(
(as.data.frame.TableOne(tbone_desc_merge52, smd=T, nonnormal= T)%>% 
  dplyr::mutate(char2=`characteristic`) %>% 
  tidyr::fill(char2) %>% 
  dplyr::select(char2,everything()) %>% 
  dplyr::mutate(level=ifelse(is.na(level),"[Missing]",level)) %>% 
  dplyr::mutate(char2=dplyr::case_when(characteristic=="NA"~NA_character_,T~as.character(characteristic))) %>% 
  format_cells(1, 1:length(names(.)), "bold")),
subset(as.data.frame.TableOne(tbone_desc_merge53, smd=T, nonnormal= T),subset= grepl("offender",characteristic))) %>% 
  dplyr::select(-1) %>% 
  rio::export("tableone_grant_22_23.xlsx")

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
if(no_mostrar==0){
Base_fiscalia_v14_filt<- subset(Base_fiscalia_v14, select=c(vars_cov, "offender_d"), subset=!is.na(motivodeegreso_mod_imp_rec))
Base_fiscalia_v14_pris_filt<- subset(Base_fiscalia_v14_pris, select=c(vars_cov, "offender_d"), subset=!is.na(motivodeegreso_mod_imp_rec))

  
CreateTableOne(vars=c(setdiff(vars_cov, "motivodeegreso_mod_imp_rec"), "offender_d"), data=  Base_fiscalia_v14_filt, factorVars = setdiff(vars_cov, c("motivodeegreso_mod_imp_rec","edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr")), smd=T, strata="motivodeegreso_mod_imp_rec", addOverall = T, includeNA=T, test=T)  
  
Base_fiscalia_v14_filt%>% 
    dplyr::select(setdiff(vars_cov, c("edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr"))) %>% 
    tidyr::gather(variable,measure, -motivodeegreso_mod_imp_rec) %>% 
    dplyr::group_by(variable) %>%
    dplyr::do(cbind.data.frame(broom::tidy(chisq.test(.$motivodeegreso_mod_imp_rec, .$measure)),broom::tidy(sum(table(.$motivodeegreso_mod_imp_rec, .$measure))))
              ) %>% 
  #casos completos
#chisq.test(table(Base_fiscalia_v14_filt$motivodeegreso_mod_imp_rec, Base_fiscalia_v14_filt$sus_principal_mod, exclude=NULL))
    dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",sprintf("%1.3f",p.value))) %>% 
    dplyr::mutate(statistic=sprintf("%2.0f",statistic)) %>% 
    dplyr::mutate(report=paste0("X²(",parameter,", ",x,")=",statistic,"; p", ifelse(p.value=="<0.001",p.value, paste0("=",p.value)))) %>%
    dplyr::mutate(report=sub("0\\.","0,",sub("\\.",",",report)))%>%
    rio::export("tableone_grant_22_23_3_alt.xlsx")

 chisq.test(Base_fiscalia_v14_filt$motivodeegreso_mod_imp_rec, is.na(Base_fiscalia_v14_filt$offender_d)) 
 chisq.test(Base_fiscalia_v14_filt$motivodeegreso_mod_imp_rec, is.na(Base_fiscalia_v14_filt$offender_d)) 

Base_fiscalia_v14_filt %>% 
    dplyr::select(setdiff(vars_cov, c("edad_al_ing_1", "edad_ini_cons","ano_nac_corr", "porc_pobr"))) %>% 
    tidyr::gather(variable,measure, -motivodeegreso_mod_imp_rec) %>% 
    dplyr::group_by(variable) %>%
    dplyr::do(fisher.test(table(.$motivodeegreso_mod_imp_rec, .$measure, exclude=NULL), workspace = 2e10, simulate.p.value = T, B=1e5) %>% broom::tidy()) %>% 
    rio::export("tableone_grant_22_23_2_alt.xlsx")

fisher.test(table(Base_fiscalia_v14_filt$motivodeegreso_mod_imp_rec, 
            is.na(Base_fiscalia_v14_filt$offender_d),exclude=NULL), workspace = 2e10, simulate.p.value = T, B=1e5) 
fisher.test(table(Base_fiscalia_v14_pris_filt$motivodeegreso_mod_imp_rec, 
            is.na(Base_fiscalia_v14_pris_filt$offender_d),exclude=NULL), workspace = 2e10, simulate.p.value = T, B=1e5) 

# Kurksal Wallis
paste0("H(",kruskal.test(edad_al_ing_1 ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$parameter,")=",
       round(kruskal.test(edad_al_ing_1 ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$statistic,1), ", p=",
       round(kruskal.test(edad_al_ing_1 ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$p.value,3))

paste0("H(",kruskal.test(edad_ini_cons ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$parameter,")=",
       round(kruskal.test(edad_ini_cons ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$statistic,1), ", p=",
       round(kruskal.test(edad_ini_cons ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$p.value,3)) 

paste0("H(",kruskal.test(ano_nac_corr ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$parameter,")=",
       round(kruskal.test(ano_nac_corr ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$statistic,1), ", p=",
       round(kruskal.test(ano_nac_corr ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$p.value,3)) 

paste0("H(",kruskal.test(porc_pobr ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$parameter,")=",
       round(kruskal.test(porc_pobr ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$statistic,1), ", p=",
       round(kruskal.test(porc_pobr ~ motivodeegreso_mod_imp_rec, data=Base_fiscalia_v14_filt)$p.value,3)) 
}
```
:::

# Summary of Results

```{r exp-surv23-1, eval=T, echo=F, error=T, fig.align='center', message=FALSE, warning=FALSE}
require(XML); require(RCurl); require(rlist)
prob_imp<-rvest::read_html("prob_condsent_m1_main.html") %>% rvest::html_table()
rmst_imp<-rvest::read_html("rmst_condsent_m1_main.html") %>% rvest::html_table()
prob_imp_diff<-rvest::read_html("prob_condsent_m1_main_diff.html") %>% rvest::html_table()
rmst_imp_diff<-rvest::read_html("rmst_condsent_m1_main_diff.html") %>% rvest::html_table()

prob_imp_tab<-
prob_imp %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_lci,",",Comp_uci,")"), Early_ci = paste0(Early," (", Early_lci,",",Early_uci,")"), Late_ci = paste0(Late," (", Late_lci,",",Late_uci,")")) %>% 
  dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>%
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

prob_imp_diff_tab<-
prob_imp_diff %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths")) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

rmst_imp_tab<-
rmst_imp %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate(t=readr::parse_number(Var.1)) %>% 
  dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.3f",t-readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_uci,",",Comp_lci,")"), Early_ci= paste0(Early," (", Early_uci,",",Early_lci,")"), Late_ci= paste0(Late," (", Late_uci,",",Late_lci,")")) %>%
  dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

rmst_imp_diff_tab<-
rmst_imp_diff %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.3f",-readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths")) 

rbindlist(list(list(c("Probs.",rep("",0))),cbind.data.frame(prob_imp_tab,prob_imp_diff_tab[,-1]),
               list(c("RMTL",rep("",0))), cbind.data.frame(rmst_imp_tab,rmst_imp_diff_tab[,-1])), fill=T) %>% 
    #dplyr::slice(-2,-3,-4,-5,-6,-7,-14,-15,-16,-17,-18,-19) %>%        
  dplyr::filter(nchar(Time)>=2) %>% 
  #knitr::kable("markdown", size=3, col.names= c("Time", "Complete Tr.","Late Disch.", "Early Disch.", "Comp. vs Late", "Comp. vs Early", "Early vs Late"), caption= "Offending with Condemnatory Sentence")
kbl(format = 'markdown',
        escape = FALSE,
        col.names= c("Time", "Complete Tr.","Late Disch.", "Early Disch.", "Comp. vs Late", "Comp. vs Early", "Early vs Late"), 
    caption= "Offending with Condemnatory Sentence")
```

```{r exp-surv23-2, eval=T, echo=F, error=T, fig.align='center', message=FALSE, warning=FALSE}

prob_imp_pris<-rvest::read_html("prob_prison_m1_main.html") %>% rvest::html_table()
rmst_imp_pris<-rvest::read_html("rmst_prison_m1_main.html") %>% rvest::html_table()
prob_imp_diff_pris<-rvest::read_html("prob_prison_m1_main_diff.html") %>% rvest::html_table()
rmst_imp_diff_pris<-rvest::read_html("rmst_prison_m1_main_diff.html") %>% rvest::html_table()

prob_imp_pris_tab<-
prob_imp_pris %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_lci,",",Comp_uci,")"), Early_ci = paste0(Early," (", Early_lci,",",Early_uci,")"), Late_ci = paste0(Late," (", Late_lci,",",Late_uci,")")) %>% 
  dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

prob_imp_diff_pris_tab<-
prob_imp_diff_pris %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>%
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths")) 

rmst_imp_pris_tab<-
rmst_imp_pris %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate(t=readr::parse_number(Var.1)) %>% 
  dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.3f",t-readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_uci,",",Comp_lci,")"), Early_ci= paste0(Early," (", Early_uci,",",Early_lci,")"), Late_ci= paste0(Late," (", Late_uci,",",Late_lci,")")) %>%
  dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

rmst_imp_diff_pris_tab<-
rmst_imp_diff_pris %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.3f",-readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

rbindlist(
  list(list(c("Probs.",rep("",0))),cbind.data.frame(prob_imp_pris_tab,prob_imp_diff_pris_tab[,-1]),   list(c("RMTL",rep("",0))),cbind.data.frame(rmst_imp_pris_tab,rmst_imp_diff_pris_tab[,-1])), 
          fill=T) %>% 
    dplyr::filter(nchar(Time)>=2)  %>% #%>% rio::export("_tab_mariel_results.xlsx")
kbl(format = 'markdown',
        escape = FALSE,
        col.names= c("Time", "Complete Tr.","Late Disch.", "Early Disch.", "Comp. vs Late", "Comp. vs Early", "Early vs Late"), 
    caption= "Offending with imprisonment")
```


```{r exp-surv23-3, eval=T, echo=F, error=T, fig.align='center', message=FALSE, warning=FALSE}
require(XML); require(RCurl); require(rlist)
prob_imp_cc<-rvest::read_html("prob_condsent_m0_main.html") %>% rvest::html_table()
rmst_imp_cc<-rvest::read_html("rmst_condsent_m0_main.html") %>% rvest::html_table()
prob_imp_diff_cc<-rvest::read_html("prob_condsent_m0_main_diff.html") %>% rvest::html_table()
rmst_imp_diff_cc<-rvest::read_html("rmst_condsent_m0_main_diff.html") %>% rvest::html_table()

prob_imp_tab_cc<-
prob_imp_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_lci,",",Comp_uci,")"), Early_ci = paste0(Early," (", Early_lci,",",Early_uci,")"), Late_ci = paste0(Late," (", Late_lci,",",Late_uci,")")) %>% 
  dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

prob_imp_diff_tab_cc<-
prob_imp_diff_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths")) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

rmst_imp_tab_cc<-
rmst_imp_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate(t=readr::parse_number(Var.1)) %>% 
  dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.3f",t-readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_uci,",",Comp_lci,")"), Early_ci= paste0(Early," (", Early_uci,",",Early_lci,")"), Late_ci= paste0(Late," (", Late_uci,",",Late_lci,")")) %>%
  dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

rmst_imp_diff_tab_cc<-
rmst_imp_diff_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.3f",-readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths")) 

rbindlist(
  list(list(c("Probs.",rep("",0))),cbind.data.frame(prob_imp_tab_cc,prob_imp_diff_tab_cc[,-1]),
  list(c("RMTL",rep("",0))), cbind.data.frame(rmst_imp_tab_cc,rmst_imp_diff_tab_cc[,-1])), fill=T)%>% 
    #dplyr::slice(-2,-3,-4,-5,-6,-7,-14,-15,-16,-17,-18,-19) %>%        
  dplyr::filter(nchar(Time)>=2) %>% 
  #knitr::kable("markdown", size=3, col.names= c("Time", "Complete Tr.","Late Disch.", "Early Disch.", "Comp. vs Late", "Comp. vs Early", "Early vs Late"), caption= "Offending with Condemnatory Sentence")
kbl(format = 'markdown',
        escape = FALSE,
        col.names= c("Time", "Complete Tr.","Late Disch.", "Early Disch.", "Comp. vs Late", "Comp. vs Early", "Early vs Late"), 
    caption= "Offending with Condemnatory Sentence (complete cases)")
```

```{r exp-surv23-4, eval=T, echo=F, error=T, fig.align='center', message=FALSE, warning=FALSE}
prob_imp_pris_cc<-rvest::read_html("prob_prison_m0_main.html") %>% rvest::html_table()
rmst_imp_pris_cc<-rvest::read_html("rmst_prison_m0_main.html") %>% rvest::html_table()
prob_imp_diff_pris_cc<-rvest::read_html("prob_prison_m0_main_diff.html") %>% rvest::html_table()
rmst_imp_diff_pris_cc<-rvest::read_html("rmst_prison_m0_main_diff.html") %>% rvest::html_table()

prob_imp_pris_tab_cc<-
prob_imp_pris_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_lci,",",Comp_uci,")"), Early_ci = paste0(Early," (", Early_lci,",",Early_uci,")"), Late_ci = paste0(Late," (", Late_lci,",",Late_uci,")")) %>% 
  dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

prob_imp_diff_pris_tab_cc<-
prob_imp_diff_pris_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.1f",readr::parse_number(.))) %>%
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths")) 

rmst_imp_pris_tab_cc<-
rmst_imp_pris_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  plyr::mutate(t=readr::parse_number(Var.1)) %>% 
dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.3f",t-readr::parse_number(.))) %>% 
     dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_ci= paste0(Comp," (", Comp_uci,",",Comp_lci,")"), Early_ci= paste0(Early," (", Early_uci,",",Early_lci,")"), Late_ci= paste0(Late," (", Late_uci,",",Late_lci,")")) %>%
     dplyr::select(Time, Comp_ci, Late_ci, Early_ci) %>% 
     dplyr::filter(!Time %in% c("3_mths","6_mths"))

rmst_imp_diff_pris_tab_cc<-
rmst_imp_diff_pris_cc %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>% 
  dplyr::mutate_at(2:ncol(.), ~sprintf("%1.3f",-readr::parse_number(.))) %>% 
  dplyr::rename("Time" = 1) %>% slice(5:6) %>% mutate(Comp_Early_ci= paste0(Comp_Early," (", Comp_Early_lci,",",Comp_Early_uci,")"), Comp_Late_ci = paste0(Comp_Late," (", Comp_Late_lci,",",Comp_Late_uci,")"), Early_Late_ci = paste0(Early_Late," (", Early_Late_lci,",",Early_Late_uci,")")) %>% 
  dplyr::select(Time, Comp_Late_ci, Comp_Early_ci, Early_Late_ci) %>% 
  dplyr::filter(!Time %in% c("3_mths","6_mths"))

rbindlist(
  list(list(c("Probs.",rep("",0))),cbind.data.frame(prob_imp_pris_tab_cc,prob_imp_diff_pris_tab_cc[,-1]), 
  list(c("RMTL",rep("",0))),cbind.data.frame(rmst_imp_pris_tab_cc,rmst_imp_diff_pris_tab_cc[,-1])),
  fill=T) %>% 
    dplyr::filter(nchar(Time)>=2)  %>% #rio::export("_tab_mariel_results.xlsx")
kbl(format = 'markdown',
        escape = FALSE,
        col.names= c("Time", "Complete Tr.","Late Disch.", "Early Disch.", "Comp. vs Late", "Comp. vs Early", "Early vs Late"), 
    caption= "Offending with imprisonment (complete cases)")
```

```{r, fig.align='center', layout="l-body-outset"}

require(cowplot)
require(gridExtra)
require(coin)
require(magick)
require(pdftools)
fig1 <- image_read_pdf('h_m_ns_rp6_stdif_s2_m1.pdf')%>%
    image_border("white", "80x20")%>%
    image_annotate("A)", 
                   location = "+18+0", 
                   size = 35, 
                   gravity = "northwest", 
                   boxcolor = "transparent", 
                   font = "Arial", 
                   strokecolor = "black")

fig2 <- image_read_pdf('h_m_ns_rp6_stdif_rmst_m1.pdf')%>%
    image_border("white", "80x20")%>%
    image_annotate("B)", 
                   location = "+18+0", 
                   size = 35, 
                   gravity = "northwest", 
                   boxcolor = "transparent", 
                   font = "Arial", 
                   strokecolor = "black")
fig2rmtl <- image_read_pdf('_figs/h_m_ns_rp6_stdif_rmtl_m1.pdf')%>%
    image_border("white", "80x20")%>%
    image_annotate("B)", 
                   location = "+18+0", 
                   size = 35, 
                   gravity = "northwest", 
                   boxcolor = "transparent", 
                   font = "Arial", 
                   strokecolor = "black")
fig3 <- image_read_pdf('h_m_ns_rp6_stdif_s2_pris_m1.pdf')%>%
    image_border("white", "80x20")%>%
    image_annotate("C)", 
                   location = "+18+0", 
                   size = 35, 
                   gravity = "northwest", 
                   boxcolor = "transparent", 
                   font = "Arial", 
                   strokecolor = "black")
fig4 <- image_read_pdf('h_m_ns_rp6_stdif_rmst_pris_m1.pdf')%>%
    image_border("white", "80x20")%>%
    image_annotate("D)", 
                   location = "+18+0", 
                   size = 35, 
                   gravity = "northwest", 
                   boxcolor = "transparent", 
                   font = "Arial", 
                   strokecolor = "black")
fig4rmtl <- image_read_pdf('_figs/h_m_ns_rp6_stdif_rmtl_pris_m1.pdf')%>%
    image_border("white", "80x20")%>%
    image_annotate("D)", 
                   location = "+18+0", 
                   size = 35, 
                   gravity = "northwest", 
                   boxcolor = "transparent", 
                   font = "Arial", 
                   strokecolor = "black")
#https://fondecytacc.github.io/nDP/analisis_mariel_feb_2023_stata_m1.html
#https://fondecytacc.github.io/nDP/analisis_mariel_feb_2023_stata_pris_m1.html
#ggsave(plot= p4,filename= "./_figs/SER2023_test.jpg", dpi=740, height = 16*0.7, width =20*0.7)
image_montage(c(fig1, fig2, fig3, fig4), tile = '2x2', geometry = 'x500', gravity = "Center")#
image_write(image_montage(c(fig1, fig2, fig3, fig4), tile = '2x2', geometry = 'x500', gravity = "Center"), path = "montage.png", format = "png", density = "300x300")
image_write(image_montage(c(fig1, fig2, fig3, fig4), tile = '2x2', geometry = 'x500', gravity = "Center"), path = "montage.pdf", format = "pdf", density = "300x300")

image_montage(c(fig1, fig2rmtl, fig3, fig4rmtl), tile = '2x2', geometry = 'x500', gravity = "Center")#
image_write(image_montage(c(fig1, fig2rmtl, fig3, fig4rmtl), tile = '2x2', geometry = 'x500', gravity = "Center"), path = "montage_rmtl.png", format = "png", density = "300x300")
image_write(image_montage(c(fig1, fig2rmtl, fig3, fig4rmtl), tile = '2x2', geometry = 'x500', gravity = "Center"), path = "montage_rmtl.pdf", format = "pdf", density = "300x300")

```

::: controlly
```{r exp-surv23-5-hr, eval=T, echo=F, error=T, fig.align='center', message=FALSE, warning=FALSE}
# In this model, the term dxb: is typically used to indicate a time-dependent covariate, 
#which is a covariate whose effect changes over time. For example, if you are studying the survival of 
#patients after surgery, a time-dependent covariate might be the patient's age at the time of surgery.
# 
# On the other hand, xb: is typically used to denote time-independent covariates, which are covariates 
#whose effect does not change over time. An example of a time-independent covariate might
#be the patient's gender.

tab1<-rvest::read_html("mat_tab1.html") %>% rvest::html_table() %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>%   dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.2f",readr::parse_number(.))) %>% dplyr::filter(dplyr::case_when(b!="NA"~T,T~F)) %>% 
  dplyr::mutate(pvalue=dplyr::case_when(readr::parse_number(pvalue)<0.001~"<0.001",T~sprintf("%1.3f",readr::parse_number(pvalue))))
tab2<-rvest::read_html("mat_tab2.html")  %>% rvest::html_table() %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>%   dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.2f",readr::parse_number(.))) %>% dplyr::filter(dplyr::case_when(b!="NA"~T,T~F)) %>% 
  dplyr::mutate(pvalue=dplyr::case_when(readr::parse_number(pvalue)<0.001~"<0.001",T~sprintf("%1.3f",readr::parse_number(pvalue))))
tab3<-rvest::read_html("mat_tab3.html")  %>% rvest::html_table() %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>%   dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.2f",readr::parse_number(.))) %>% dplyr::filter(dplyr::case_when(b!="NA"~T,T~F)) %>% 
  dplyr::mutate(pvalue=dplyr::case_when(readr::parse_number(pvalue)<0.001~"<0.001",T~sprintf("%1.3f",readr::parse_number(pvalue))))
tab4<-rvest::read_html("mat_tab4.html")  %>% rvest::html_table() %>% as.data.table() %>% janitor::row_to_names(3) %>% data.frame() %>%   dplyr::mutate_at(2:(ncol(.)-1), ~sprintf("%1.2f",readr::parse_number(.))) %>% dplyr::filter(dplyr::case_when(b!="NA"~T,T~F)) %>% 
  dplyr::mutate(pvalue=dplyr::case_when(readr::parse_number(pvalue)<0.001~"<0.001",T~sprintf("%1.3f",readr::parse_number(pvalue))))

tab1 %>% 
  dplyr::left_join(`tab2`,by="Var.1") %>% 
  dplyr::left_join(`tab3`,by="Var.1") %>% 
  dplyr::left_join(`tab4`,by="Var.1") %>% 
  dplyr::mutate(`Var.1`=str_replace_all(`Var.1`, "^_d_rcs", "time-dependent: knot ")) %>% 
  dplyr::mutate(`Var.1`=str_replace_all(`Var.1`, "^_rcs", "time-independent: knot ")) %>% 
  dplyr::mutate(`Var.1`=str_replace_all(`Var.1`, "knot _mot_egr_early1", "Early discharge")) %>% 
  dplyr::mutate(`Var.1`=str_replace_all(`Var.1`, "knot _mot_egr_late1", "Late discharge")) %>% 
  dplyr::mutate(`Var.1`=str_replace_all(`Var.1`, "^mot_egr_early$", "Early discharge")) %>% 
  dplyr::mutate(`Var.1`=str_replace_all(`Var.1`, "^mot_egr_late$", "Late discharge")) %>%  
  dplyr::mutate(across(everything(), ~replace_na(., ""))) %>%
  #rio::export("hrs_intramural2223.xlsx")
  knitr::kable("markdown", caption="sdasd", col.names=c("Term",rep(c("Estimate", "95%CI lo", "95%CI up", "P-value"),4)))
```
:::

<br>

# Sensitivity analyses

```{r stata-sens}
invisible("
coxph(formula = as.formula(paste('Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,4) +', 
     paste(setdiff(vars_cov, 'edad_al_ing_1'), collapse = '+'))), 
     data = Base_fiscalia_v14, ties = 'efron')
")

vars <- c("tr_mod2", "sex_dum2", "edad_ini_cons", "esc1", "esc2", 
          "sus_prin2", "sus_prin3", "sus_prin4", "sus_prin5", 
          "fr_cons_sus_prin2", "fr_cons_sus_prin3", "fr_cons_sus_prin4", "fr_cons_sus_prin5", 
          "cond_ocu2", "cond_ocu3", "cond_ocu4", "cond_ocu5", "cond_ocu6", 
          "policonsumo", "num_hij2", "tenviv1", "tenviv2", "tenviv4", "tenviv5", 
          "mzone2", "mzone3", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", 
          "psy_com2", "psy_com3", "dep2", "rural2", "rural3", 
          "porc_pobr", "susini2", "susini3", "susini4", "susini5", 
          "ano_nac_corr", "cohab2", "cohab3", "cohab4", 
          "fis_com2", "fis_com3", "rc_x1", "rc_x2", "rc_x3")

statadf_main          <- rio::import("mariel_feb_23.dta")
statadf_main_cc       <-  statadf_main[complete.cases(statadf_main[, c(vars,"motivodeegreso_mod_imp_rec")]),] %>% dplyr::mutate(motivodeegreso_mod_imp_rec=factor(motivodeegreso_mod_imp_rec)) #%>% dplyr::mutate(across(vars,~factor(.)))
# statadf_main_l        <- rio::import("mariel_feb_23_late.dta")
# statadf_main_e        <- rio::import("mariel_feb_23_early.dta")
# statadf_main_e_l      <- rio::import("mariel_feb_23_early_late.dta")

statadf_main_pris     <- rio::import("mariel_feb_23_2.dta")
statadf_main_pris_cc  <- statadf_main_pris[complete.cases(statadf_main_pris[, c(vars,"motivodeegreso_mod_imp_rec")]),] %>% dplyr::mutate(motivodeegreso_mod_imp_rec=factor(motivodeegreso_mod_imp_rec)) 
# statadf_main_pris_l   <- rio::import("mariel_feb_23_2_late.dta")
# statadf_main_pris_e   <- rio::import("mariel_feb_23_2_early.dta")
# statadf_main_pris_e_l <- rio::import("mariel_feb_23_2_early_late.dta")
statadf_miss          <- rio::import("mariel_feb_23_m1.dta")%>% dplyr::mutate(motivodeegreso_mod_imp_rec=factor(motivodeegreso_mod_imp_rec)) #%>%
statadf_miss_pris     <- rio::import("mariel_feb_23_2_m1.dta")%>% dplyr::mutate(motivodeegreso_mod_imp_rec=factor(motivodeegreso_mod_imp_rec)) #%>%

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
# 
# motivodeegreso_mod_imp_rec ~ tr_mod2+ sex_dum2+ edad_ini_cons+ esc1+ esc2+ sus_prin2+ sus_prin3+ sus_prin4+ sus_prin5+ fr_cons_sus_prin2+ fr_cons_sus_prin3+ fr_cons_sus_prin4+ fr_cons_sus_prin5+ cond_ocu2+ cond_ocu3+ cond_ocu4+ cond_ocu5+ cond_ocu6+ policonsumo+ num_hij2+ tenviv1+ tenviv2+ tenviv4+ tenviv5+ mzone2+ mzone3+ n_off_vio+ n_off_acq+ n_off_sud+ n_off_oth+ psy_com2+ psy_com3+ dep2+ rural2+ rural3+ porc_pobr+ susini2+ susini3+ susini4+ susini5+ ano_nac_corr+ cohab2+ cohab3+ cohab4+ fis_com2+ fis_com3+ rc_x1+ rc_x2+ rc_x3, data = statadf_main_cc

set.seed(2125)
W1 <- WeightIt::weightit(as.formula(paste("motivodeegreso_mod_imp_rec~", paste(vars, collapse = "+"))), data=statadf_miss, method = "bart", estimand = "ATE", use.mlogit = FALSE)
statadf_miss$weight_mult_b <- WeightIt::get_w_from_ps(W1$weights, statadf_miss$motivodeegreso_mod_imp_rec, estimand = "ATE", stabilize=T)
set.seed(2125)
W2 <- WeightIt::weightit(as.formula(paste("motivodeegreso_mod_imp_rec~", paste(vars, collapse = "+"))), data=statadf_miss_pris, method = "bart", estimand = "ATE", use.mlogit = FALSE)
statadf_miss_pris$weight_mult_b <- WeightIt::get_w_from_ps(W2$weights, statadf_miss_pris$motivodeegreso_mod_imp_rec, estimand = "ATE", stabilize=T)

# Surv(yrs_to_condemn, event_r) ~ motivodeegreso_mod_imp_rec + 
#     rcs(edad_al_ing_1, 4) + motivodeegreso_mod_imp_rec + tr_modality + 
#     sex + edad_ini_cons + escolaridad_rec + sus_principal_mod + 
#     freq_cons_sus_prin + condicion_ocupacional_corr + policonsumo + 
#     num_hijos_mod_joel_bin + tenencia_de_la_vivienda_mod + macrozona + 
#     n_off_vio + n_off_acq + n_off_sud + n_off_oth + dg_cie_10_rec + 
#     dg_trs_cons_sus_or + clas_r + porc_pobr + sus_ini_mod_mvv + 
#     ano_nac_corr + con_quien_vive_joel + fis_comorbidity_icd_10
```

::: controlly
```{r stata1-2023, echo=T, fig.align='center', message=T, error=T, eval=T}

bal_tab_2023_res_1<-
cobalt::bal.tab(motivodeegreso_mod_imp_rec ~ tr_mod2+ sex_dum2+ edad_ini_cons+ esc1+ esc2+ sus_prin2+ sus_prin3+ sus_prin4+ sus_prin5+ fr_cons_sus_prin2+ fr_cons_sus_prin3+ fr_cons_sus_prin4+ fr_cons_sus_prin5+ cond_ocu2+ cond_ocu3+ cond_ocu4+ cond_ocu5+ cond_ocu6+ policonsumo+ num_hij2+ tenviv1+ tenviv2+ tenviv4+ tenviv5+ mzone2+ mzone3+ n_off_vio+ n_off_acq+ n_off_sud+ n_off_oth+ psy_com2+ psy_com3+ dep2+ rural2+ rural3+ porc_pobr+ susini2+ susini3+ susini4+ susini5+ ano_nac_corr+ cohab2+ cohab3+ cohab4+ fis_com2+ fis_com3+ rc_x1+ rc_x2+ rc_x3, data = statadf_miss,
                weights = list("Beyasian Additive Regression Trees" = "weight_mult_b"),
                estimand = "ATE",
                which.treat = .all,
                un = T, 
                thresholds = c(cor = .2),
                 binary = "std", continuous = "std",
                stats = c("mean.diffs", "variance.ratios"))

bal_tab_2023_res_2<-
cobalt::bal.tab(motivodeegreso_mod_imp_rec ~ tr_mod2+ sex_dum2+ edad_ini_cons+ esc1+ esc2+ sus_prin2+ sus_prin3+ sus_prin4+ sus_prin5+ fr_cons_sus_prin2+ fr_cons_sus_prin3+ fr_cons_sus_prin4+ fr_cons_sus_prin5+ cond_ocu2+ cond_ocu3+ cond_ocu4+ cond_ocu5+ cond_ocu6+ policonsumo+ num_hij2+ tenviv1+ tenviv2+ tenviv4+ tenviv5+ mzone2+ mzone3+ n_off_vio+ n_off_acq+ n_off_sud+ n_off_oth+ psy_com2+ psy_com3+ dep2+ rural2+ rural3+ porc_pobr+ susini2+ susini3+ susini4+ susini5+ ano_nac_corr+ cohab2+ cohab3+ cohab4+ fis_com2+ fis_com3+ rc_x1+ rc_x2+ rc_x3, data = statadf_miss_pris,
                weights = list("Beyasian Additive Regression Trees" = "weight_mult_b"),
                estimand = "ATE",
                which.treat = .all,
                un = T, 
                thresholds = c(cor = .2),
                 binary = "std", continuous = "std",
                stats = c("mean.diffs", "variance.ratios"))

cbind.data.frame(type=c(rep("Cond. sentence",3), rep("Imprisonment",3)),
rbind(data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab_2023_res_1$Pair.Balance$`2 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late Dropout vs. Tr. completion",bal_tab_2023_res_1$Pair.Balance$`3 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late vs. Early Dropout",bal_tab_2023_res_1$Pair.Balance$`3 vs. 2`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab_2023_res_2$Pair.Balance$`2 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late Dropout vs. Tr. completion",bal_tab_2023_res_2$Pair.Balance$`3 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late vs. Early Dropout",bal_tab_2023_res_2$Pair.Balance$`3 vs. 2`$Balance), keep.rownames=T))) %>% 
  #data.table::data.table(keep.rownames = T) %>% 
  dplyr::select(type, comp, rn, everything()) %>%
  dplyr::arrange(type, comp, -Diff.Adj) %>% 
  dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Balance Measures (multinomial response BART weights)")
 #  knitr::kable("html", caption="Balance Measures") %>% 
   #   kableExtra::kable_classic_2()

invisible("0= completar; 1= no-completar;policonsumo looks not balanced, the number of previous acquisitive offenses, and South")
```
:::

::: controlly 
```{r stata1-5-2023, echo=T, fig.align='center', message=T, error=T, eval=T}
cbind.data.frame(type=c(rep("Cond. sentence",3), rep("Imprisonment",3)),
rbind(cbind(comp="Early Dropout vs. Tr. completion",
            bal_tab_2023_res_1$Pair.Balance$`2 vs. 1`$Balance),
      cbind(comp="Late Dropout vs. Tr. completion",
            bal_tab_2023_res_1$Pair.Balance$`3 vs. 1`$Balance),
      cbind(comp="Late vs. Early Dropout",
            bal_tab_2023_res_1$Pair.Balance$`3 vs. 2`$Balance),
      cbind(comp="Early Dropout vs. Tr. completion",
            bal_tab_2023_res_2$Pair.Balance$`2 vs. 1`$Balance),
      cbind(comp="Late Dropout vs. Tr. completion",
            bal_tab_2023_res_2$Pair.Balance$`3 vs. 1`$Balance),
      cbind(comp="Late vs. Early Dropout",
            bal_tab_2023_res_2$Pair.Balance$`3 vs. 2`$Balance))) %>% 
    data.table::data.table(keep.rownames = T) %>% 
    dplyr::select(type, comp, rn, everything()) %>% 
    dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
    dplyr::group_by(type, comp) %>% 
    dplyr::summarise_if(is.numeric, ~list(min= min(.,na.rm=T), max= max(.,na.rm=T)))%>%
  ungroup() %>% 
  knitr::kable("markdown", caption="Balance Measures (multinomial response BART weights)", col.names=c("Type","Comparison","Diff. Unstandardized","V.Ratio Unstandardized","Diff.Adjusted","V.Ratio.Adjusted"))
 #  knitr::kable("html", caption="Balance Measures (multinomial response weights)") %>% 
   #   kableExtra::kable_classic_2()
```
:::    

::: controlly 
```{r stata2-2023, echo=T, fig.align='center', message=T, error=T, eval=T}
#The “effective sample size” (ESS) is a measure of the sample size a non-weighted sample would have to have to achieve the same level of precision as the weighted sample (Ridgeway 2006).
cbind.data.frame(type=c(rep("Cond.sentence",6), rep("Imprisonmente",6)),
dplyr::bind_rows(
data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab_2023_res_1$Pair.Balance$`2 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Late Dropout vs. Tr. completion",bal_tab_2023_res_1$Pair.Balance$`3 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Late vs. Early Dropout",bal_tab_2023_res_1$Pair.Balance$`3 vs. 2`$Observations),keep.rownames = T),
data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab_2023_res_2$Pair.Balance$`2 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab_2023_res_2$Pair.Balance$`3 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Late vs. Early Dropout",bal_tab_2023_res_2$Pair.Balance$`3 vs. 2`$Observations),keep.rownames = T)))%>% 
  #dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Effective sample sizes", col.names = c("Type", "Adj", "Comparison", "Tr. completion", "Early Dropout", "Late Dropout"))
```
:::

::: controlly2
```{r stata-sens2, echo=T, fig.align='center', message=T, error=T, eval=F}
sub1_statadf_miss<- subset(statadf_miss,subset= motivodeegreso_mod_imp_rec!=3) |> dplyr::mutate(motivodeegreso_mod_imp_rec= ifelse(motivodeegreso_mod_imp_rec==2,1,0))|> slice(1:5e5)|>data.table::data.table()
require(RMSTSens)
results.approx11 <- RMSTSens(time="diff", status="event", exposure="motivodeegreso_mod_imp_rec", level.exposed="1", ps="weight_mult_b", data=sub1_statadf_miss, methods="Optim", use.multicore=TRUE, n.core=parallel::detectCores()-2, lambda=c(1,1.25,1.5), tau=1, ini.par=1, verbose=FALSE)
invisible("If the censoring rate is greater than 0.7, the direct optimization method can be used as an alternative because it is implemented as fast as the approximate optimization method.")
results.approx11

results.approx13 <- RMSTSens(time="diff", status="event", exposure="motivodeegreso_mod_imp_rec", level.exposed="1", ps="weight_mult_b", data=sub1_statadf_miss, methods="Optim", use.multicore=TRUE, n.core=parallel::detectCores()-2, lambda=c(1,1.25,1.5), tau=3, ini.par=1, verbose=FALSE)
invisible("If the censoring rate is greater than 0.7, the direct optimization method can be used as an alternative because it is implemented as fast as the approximate optimization method.")
results.approx13

results.approx15 <- RMSTSens(time="diff", status="event", exposure="motivodeegreso_mod_imp_rec", level.exposed="1", ps="weight_mult_b", data=sub1_statadf_miss, methods="Optim", use.multicore=TRUE, n.core=parallel::detectCores()-2, lambda=c(1,1.25,1.5), tau=5, ini.par=1, verbose=FALSE)
invisible("If the censoring rate is greater than 0.7, the direct optimization method can be used as an alternative because it is implemented as fast as the approximate optimization method.")
results.approx15

results.approx21 <- RMSTSens(time="diff", status="event", exposure="motivodeegreso_mod_imp_rec", level.exposed="1", ps="weight_mult_b", data=sub1_statadf_miss, methods="Optim", use.multicore=TRUE, n.core=parallel::detectCores()-2, lambda=c(1,1.25,1.5), tau=1, ini.par=1, verbose=FALSE)
invisible("If the censoring rate is greater than 0.7, the direct optimization method can be used as an alternative because it is implemented as fast as the approximate optimization method.")
results.approx21

results.approx23 <- RMSTSens(time="diff", status="event", exposure="motivodeegreso_mod_imp_rec", level.exposed="1", ps="weight_mult_b", data=sub1_statadf_miss, methods="Optim", use.multicore=TRUE, n.core=parallel::detectCores()-2, lambda=c(1,1.25,1.5), tau=3, ini.par=1, verbose=FALSE)
invisible("If the censoring rate is greater than 0.7, the direct optimization method can be used as an alternative because it is implemented as fast as the approximate optimization method.")
results.approx23

results.approx25 <- RMSTSens(time="diff", status="event", exposure="motivodeegreso_mod_imp_rec", level.exposed="1", ps="weight_mult_b", data=sub1_statadf_miss, methods="Optim", use.multicore=TRUE, n.core=parallel::detectCores()-2, lambda=c(1,1.25,1.5), tau=5, ini.par=1, verbose=FALSE)
invisible("If the censoring rate is greater than 0.7, the direct optimization method can be used as an alternative because it is implemented as fast as the approximate optimization method.")
results.approx25
```
:::


::: controlly2
```{r coxphw, echo=T, fig.align='center', message=T, error=T, eval=T}
ifelse(!require("coxphw"), install.packages("coxphw"),library("coxphw"))

system.time({
pwp_pris<-
  coxphw::coxphw(Surv(diff,event==1)  ~ mot_egr_early+ mot_egr_late+ tr_mod2+ sex_dum2+ edad_ini_cons+ esc1+ esc2+ sus_prin2+ sus_prin3+ sus_prin4+ sus_prin5+ fr_cons_sus_prin2+ fr_cons_sus_prin3+ fr_cons_sus_prin4+ fr_cons_sus_prin5+ cond_ocu2+ cond_ocu3+ cond_ocu4+ cond_ocu5+ cond_ocu6+ policonsumo+ num_hij2+ tenviv1+ tenviv2+ tenviv4+ tenviv5+ mzone2+ mzone3+ n_off_vio+ n_off_acq+ n_off_sud+ n_off_oth+ psy_com2+ psy_com3+ dep2+ rural2+ rural3+ porc_pobr+ susini2+ susini3+ susini4+ susini5+ ano_nac_corr+ cohab2+ cohab3+ cohab4+ fis_com2+ fis_com3+ rc_x1+ rc_x2+ rc_x3, data = statadf_miss_pris, template="AHR",  robust=T) #, clusterid=statadf_miss_pris$hash_key
#  ~ motivodeegreso_mod_imp_rec+ tr_mod2+ sex_dum2+ edad_ini_cons+ esc1+ esc2+ sus_prin2+ sus_prin3+ sus_prin4+ sus_prin5+ fr_cons_sus_prin2+ fr_cons_sus_prin3+ fr_cons_sus_prin4+ fr_cons_sus_prin5+ cond_ocu2+ cond_ocu3+ cond_ocu4+ cond_ocu5+ cond_ocu6+ policonsumo+ num_hij2+ tenviv1+ tenviv2+ tenviv4+ tenviv5+ mzone2+ mzone3+ n_off_vio+ n_off_acq+ n_off_sud+ n_off_oth+ psy_com2+ psy_com3+ dep2+ rural2+ rural3+ porc_pobr+ susini2+ susini3+ susini4+ susini5+ ano_nac_corr+ cohab2+ cohab3+ cohab4+ fis_com2+ fis_com3+ rc_x1+ rc_x2+ rc_x3, data = statadf_miss_pris
})


system.time({
pwp_condemn<-
  coxphw::coxphw(Surv(diff,event==1)  ~ mot_egr_early+ mot_egr_late+ tr_mod2+ sex_dum2+ edad_ini_cons+ esc1+ esc2+ sus_prin2+ sus_prin3+ sus_prin4+ sus_prin5+ fr_cons_sus_prin2+ fr_cons_sus_prin3+ fr_cons_sus_prin4+ fr_cons_sus_prin5+ cond_ocu2+ cond_ocu3+ cond_ocu4+ cond_ocu5+ cond_ocu6+ policonsumo+ num_hij2+ tenviv1+ tenviv2+ tenviv4+ tenviv5+ mzone2+ mzone3+ n_off_vio+ n_off_acq+ n_off_sud+ n_off_oth+ psy_com2+ psy_com3+ dep2+ rural2+ rural3+ porc_pobr+ susini2+ susini3+ susini4+ susini5+ ano_nac_corr+ cohab2+ cohab3+ cohab4+ fis_com2+ fis_com3+ rc_x1+ rc_x2+ rc_x3, data = statadf_miss, template="AHR",  robust=T) #, clusterid=statadf_miss_pris$hash_key
#  ~ motivodeegreso_mod_imp_rec+ tr_mod2+ sex_dum2+ edad_ini_cons+ esc1+ esc2+ sus_prin2+ sus_prin3+ sus_prin4+ sus_prin5+ fr_cons_sus_prin2+ fr_cons_sus_prin3+ fr_cons_sus_prin4+ fr_cons_sus_prin5+ cond_ocu2+ cond_ocu3+ cond_ocu4+ cond_ocu5+ cond_ocu6+ policonsumo+ num_hij2+ tenviv1+ tenviv2+ tenviv4+ tenviv5+ mzone2+ mzone3+ n_off_vio+ n_off_acq+ n_off_sud+ n_off_oth+ psy_com2+ psy_com3+ dep2+ rural2+ rural3+ porc_pobr+ susini2+ susini3+ susini4+ susini5+ ano_nac_corr+ cohab2+ cohab3+ cohab4+ fis_com2+ fis_com3+ rc_x1+ rc_x2+ rc_x3, data = statadf_miss_pris
})
#pris
#sent
coxphw_coefs<-
rbind.data.frame(
cbind.data.frame(type="Condemnatory Sentence", coef= coef(pwp_condemn)[c(1:2)],coxphw:::confint.coxphw(pwp_condemn)[c(1:2),]),
cbind.data.frame(type="Imprisonment",coef= c(coef(pwp_pris)[c(1:2)]),coxphw:::confint.coxphw(pwp_pris)[c(1:2),])
) 

coxphw_coefs%>% 
  dplyr::mutate_if(is.numeric,~exp(.)) %>% 
  knitr::kable("markdown", caption="Averaged hazard ratios", digits=2)
```


```{r coxphw2, echo=T, fig.align='center', message=T, error=T, eval=T}
#early
#pwp_pris, mot_egr_early 1.8193382  1.5723899  2.1050704  ==== 3.040261 2.521084      NA
#pwp_condemn, mot_egr_early  1.6981313  1.5911785  1.8122731 ==== 2.239818 2.101310       NA

#late
#pwp_pris, mot_egr_late  1.4784520  1.3134946  1.6641257 ==== 2.319504 1.955190       NA
#pwp_condemn, mot_egr_late   1.5377467  1.4629155  1.6164056  ====  2.029950 1.927147       NA
require(EValue)

evalues.RR(est = exp(coxphw_coefs[3,2]), 
           lo = exp(coxphw_coefs[3,3]), hi= exp(coxphw_coefs[3,4]), rare=T)
#E-values 3.040261 2.521084      NA
evalues.RR(est = toRR(HR(exp(coxphw_coefs[1,2]), rare = FALSE)), 
           lo = toRR(HR(exp(coxphw_coefs[1,3]), rare = FALSE)), 
           hi = toRR(HR(exp(coxphw_coefs[1,4]), rare = FALSE)), 
           rare=T)
#RR       1.441756 1.378716 1.507518
#2.239818 2.101310       NA
evalues.RR(est = exp(coxphw_coefs[4,2]), 
           lo = exp(coxphw_coefs[4,3]), 
           hi = exp(coxphw_coefs[4,4]), rare=T)
# 2.319504 1.955190       NA
evalues.RR(est = toRR(HR(exp(coxphw_coefs[2,2]), rare = FALSE)), 
           lo = toRR(HR(exp(coxphw_coefs[2,3]), rare = FALSE)), 
           hi = toRR(HR(exp(coxphw_coefs[2,4]) , rare = FALSE)), 
           rare=T)
# RR       1.346677 1.301161 1.393714
# E-values 2.029950 1.927147       NA
```
:::

<br>

# Session Info

```{r session-info, echo=T, error=T, message=TRUE, paged.print=TRUE}
message(Sys.getenv("R_LIBS_USER"))
Sys.Date()
message(paste0("Editor context: ", path))
#load(paste0(dirname(rstudioapi::getSourceEditorContext()$path),"/15.RData"))

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/15.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/15.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/15.RData")
  } else {
     tryCatch(save.image(paste0(sub("2019","2022",sub("SUD_CL","",path)),"15.RData")),
              error= save.image(paste0(sub("2019","2022",sub("SUD_CL","",path)),"/15.RData")))
  }

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}")))
```

<br>

## `r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`

<br>

::: controlly
```{r label_to_stata, echo=T, paged.print=TRUE, eval=F}
#put name of the file
file<- "fiscalia_mariel_feb_2023_match_SENDA.dta"

subset(Base_fiscalia_v14, select= c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec")) %>% 

export_lab_stata_merge<-
  tibble::rownames_to_column(data.frame(Hmisc::label(dplyr::select(Base_fiscalia_v14,  all_of(c("hash_key", vars_cov, "fech_ing_num_1", "fech_nac_rec"))))))%>% data.frame() %>%
  
  dplyr::rename("code" = !!names(.[1]), "label" = !!names(.[2]))%>% data.frame()%>%
  dplyr::mutate(first= "cap noi label variable")%>%
  dplyr::mutate(final= paste0(first, " ",code,' "',label,'"'))%>%
  dplyr::select(-code,-label,-first)%>%
  dplyr::rename("*clear all"="final") %>%
  rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\',file,'", replace'))%>%
  rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\',file,'", replace'))

rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\',file,'", clear'),export_lab_stata_merge) %>% knitr::kable("markdown")

write.table(rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\',file,'", clear'),export_lab_stata_merge), file = paste0(path,"/_label_var_to_stata_feb2023.do"), sep = "",row.names = FALSE, quote = FALSE, fileEncoding="UTF-8")
```
:::

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">

```{stata 2, collectcode=F, include=T, error=T, cleanlog=F}
*should be in the same folder of the .Rmd to work
cap noi do _label_var_to_stata_jan2023_mod
```

</div>
