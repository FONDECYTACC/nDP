---
title: "Chilean prosecutor's office Data merge (Step 5)"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  distill::distill_article:
    code_folding: true
    fig_height: 6
    fig_width: 8
    theme: flatly
    toc: yes
    toc_depth: 5
    toc_float: yes
    output_dir: "docs"
  toc_float:
    collapsed: false
    smooth_scroll: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 

```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }

.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }

.centrado {
    text-align: center;
}

.table.center {
    margin-left:auto; 
    margin-right:auto;
  }

/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/

/* Applies to outputs that are not code other than R*/

pre {
  overflow-x: auto !important;
}
pre code {
  word-wrap: normal !important;
  white-space: pre !important;
}
/*
pre:not(.sourceCode) { 
  white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence  */
  font-size: 10px !important;
  line-height: 50% !important;
}

body{ /* Normal  */
      text-align: justify;
  }

.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: auto; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}

.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}

.pandoc-table { /* Should add !important; but it seems no necessary  */
  margin-left:auto; /* To center */
  margin-right:auto;
  border-collapse: collapse;
  table-layout: auto;
  font-size: 11px;
  overflow-y: auto;
  max-height:450px !important;
  white-space: nowrap;
  overflow-x: auto; 
  width:450px;
}

.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}

.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0px;
}

.pandoc-table caption {
    text-align: left !important;
    font-size: 11px !important;
}

.controlly{
    overflow-y:scroll;
    height:350px;
    overflow-x: scroll; 
}

</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```

```{r prev-setup, include = FALSE, cache=T, error=T}
rm(list=ls());gc()

#If you render multiple documents from the same script or R session, you should detach("Statamarkdown") in between documents.
try(detach("Statamarkdown"))

if(!grepl("4.1.2",R.version.string)){stop("Different version (must be 4.1.2)")}
path<-getwd()#we define it again later in setup chunk
if (grepl("CISS Fondecyt",path)==T){
    try(setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)"));load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
  } else if (grepl("andre",path)==T){
    try(setwd('C:/Users/andre/Desktop/SUD_CL/'));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
  } else if (grepl("E:",path)==T){
    try(setwd("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/SUD_CL/"));load("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/14.Rdata")
  } else {
    try(setwd(paste0(path)));load(paste0(gsub("SUD_CL","",gsub("2022","2019",path)),"/14.Rdata"))
  }
```

```{r setup, include = FALSE, cache=T, error=T, echo=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(try(dplyr::ungroup(x)))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
pacman::p_unlock(lib.loc = .libPaths()) #para no tener problemas reinstalando paquetes

if(!require(pacman)){install.packages("pacman")}
if(!require(devtools)){install.packages("devtools", type = "win.binary", dependencies=T)}

pacman::p_load(APCtools, ggpattern, withr, boot, matrixStats, knitr, tidyr, stringi,stringr, ggplot2, Hmisc, kableExtra, plotly, janitor, rbokeh, zoo, broom, sqldf, devtools, codebook, data.table, panelr, RColorBrewer, lsmeans, finalfit, ggiraph, sf, treemapify, dplyr, tidyverse, epiR, survminer, ggfortify, survMisc, foreign, reshape2, stargazer, tableone, MatchIt, cobalt, eha, igraph, Amelia, DiagrammeR, DiagrammeRsvg, rsvg, mstate, htmltools, webshot, flexsurv, muhaz, Metrics, rpivotTable, caret, polycor, ClusterR, flextable, ggstatsplot, ggside, daff, explore, sjPlot, compareGroups, job, missForest, showtext, ggpattern, distill, showtext, googleVis, tidylog, magick, dlookr, survRM2, easystats, tidylog, sqldf,  adjustedCurves, ggpmisc, rms, SpatialEpiApp, spatsurv, SuperLearner, install=T)

pacman::p_load(WeightIt, coxed, twang, survey, dbarts, jskm, adjustedCurves, pammtools, hrcomprisk, randomForestSRC, install=T, force=T)
if(!require(AdjKM.CIF)){try(devtools::install_github("Lesly1031/AdjKM.CIF",dependencies = TRUE, force=T, upgrade="never"))}

#Error in if (options$noisey == TRUE) message(paste("\n", options$engine, : argument is of length zero

if(!require(SpatialEpiApp)){try(install_github("Paula-Moraga/SpatialEpiApp",upgrade ="never"))}
if(!require(survcomp)){try(devtools::install_github("bhklab/survcomp",upgrade ="never"))}

try(webshot::install_phantomjs())

if(!require(bpmn)){try(devtools::install_github("bergant/bpmn",upgrade ="never"))}

if (!requireNamespace("BiocManager", quietly = TRUE)){install.packages("BiocManager")}

if(!require(fmrs)){BiocManager::install("fmrs")}
#http://www.bioconductor.org/packages/release/bioc/manuals/fmrs/man/fmrs.pdf

#if(!require(Statamarkdown)){try(devtools::install_github("Hemken/Statamarkdown",upgrade ="never"))}
# #Error in if (options$noisey == TRUE) message(paste("\n", options$engine,  : 
#   argumento tiene longitud cero
# Calls: <Anonymous> ... sew.list -> lapply -> FUN -> sew.character -> <Anonymous>

#easystats::install_suggested()

options(scipen=2) #display numbers rather scientific number

#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

fitstats.flexsurvreg = function(x){
  ll = x$loglik
  aic = x$AIC
  k = length(x$coefficients)
  n = sum(x$data$m["(weights)"])
  aicc = aic + ((2 * k) * (k + 1) / (n - k - 1))
  bic = - 2 * ll + (k * log(n))
  data.frame(
   Df = k,
    "n2ll" = -2 * ll,
    AIC = aic,
    AICc = aicc,
    BIC = bic
  )
}
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:


if(.Platform$OS.type == "windows") withAutoprint({
  memory.size()
  memory.size(TRUE)
  memory.limit()
})
memory.limit(size=56000)

path<-dirname(rstudioapi::getSourceEditorContext()$path)

options(knitr.kable.NA = '')


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- ifelse(difftime(Sys.time(), now)>(60^2),difftime(Sys.time(), now)/(60^2),difftime(Sys.time(), now)/(60^1))
      # return a character string to show the time
      x<-ifelse(difftime(Sys.time(), now)>(60^2),paste("Time for this code chunk to run:", round(res,1), "hours"),paste("Time for this code chunk to run:", round(res,1), "minutes"))
      paste('<div class="message">', gsub('##', '\n', x),'</div>', sep = '\n')
    }
  }
}))
knitr::opts_chunk$set(time_it = TRUE)
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

# Own Mode method to calculate mode
Mode <- function(x, na.rm = FALSE) {
  # it takes two areguments x, and na.rm
  if(na.rm){ #if na.rm is false it means no need to remove NA values
    x = x[!is.na(x)]
  }

  valx <- unique(x)
  return(valx[which.max(tabulate(match(x, valx)))])
}

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#to format rows in bold
format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  # one * for italics, two ** for bold
  map <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  

  for (r in rows){
    for(c in cols){

      # Make sure values are not factors
      df[[c]] <- as.character( df[[c]])

      # Update formatting
      df[r, c] <- ifelse(nchar(df[r, c])==0,"",paste0(markup, gsub(" ", "", df[r, c]), markup))
    }
  }

  return(df)
}
#To produce line breaks in messages and warnings
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('<div class="message">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
)
```


::: blue

<!--- https://docs.google.com/document/d/1d0lwgylQ89JyLZuQ6b6Tn8-u_idgDjfq_hTumTYQ9Aw/edit --->

- Estimate different survival distributions

- Finite mixture models

- 

:::

<br>


# Compare with Stata weights

::: controlly
```{r stata1, echo=T, fig.align='center', message=T, error=T, eval=T}
     # tryCatch(load(paste0(sub("2019","2022",sub("SUD_CL","",path)),"15.RData")),
     #          error= load(paste0(sub("2019","2022",sub("SUD_CL","",path)),"/15.RData")))
mariel_stata_sentence<-rio::import("mariel_nov_22.dta") #no prison
mariel_stata_prison<-rio::import("mariel_nov_22_2.dta") # prison

#rpdf10_m_stag_ten_viv rpdf10_m_nostag_or_ing_num_hij gomp_m_nostag_ten_viv gomp_m_nostag_or_ing_num_hij rpdf6_m_nostag_ten_viv rpdf6_m_nostag_or_ing_num_hij rpdf10_m_stag_ten_viv rpdf10_m_stag_or_ing_num_hij gomp_m_stag_ten_viv gomp_m_stag_or_ing_num_hij rpdf6_m_stag_ten_viv rpdf6_m_stag_or_ing_num_hij

vec_vars_stata<-
c("event", "motivodeegreso_mod_imp_rec2", "edad_al_ing_1", "edad_ini_cons", "sex_enc", "esc_rec", "sus_prin_mod", "fr_sus_prin", "comp_biosoc", "ten_viv", "dg_cie_10_rec", "sud_severity_icd10", "macrozone", "policonsumo", "n_off_vio", "n_off_acq", "n_off_sud", "clas")

warning(paste0("The sample fell from ",format(nrow(mariel_stata_sentence), big.mark=",")," to ",format(nrow(mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c(vec_vars_stata)]),]), big.mark=","), " observations without missing data in the variables of interest, and to ", format(nrow(mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c(vec_vars_stata, "rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),]), big.mark=","), " if erased also the rows that possess missing values in the weights. We only eliminated missing data in the treatment weights (n=", format(nrow(mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c("rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),]), big.mark=","),")"))


mariel_stata_sentence<-
  mariel_stata_sentence %>% 
  dplyr::mutate(across(c("sex_enc","esc_rec", "sus_prin_mod", "fr_sus_prin", "comp_biosoc", "ten_viv", "dg_cie_10_rec", "sud_severity_icd10", "macrozone", "policonsumo", "n_off_vio", "n_off_acq", "n_off_sud", "clas", "motivodeegreso_mod_imp_rec3"),~as.factor(.)))
  

bal_tab2<-
cobalt::bal.tab(motivodeegreso_mod_imp_rec2 ~ edad_al_ing_1+ edad_ini_cons + sex_enc + esc_rec + sus_prin_mod + fr_sus_prin + comp_biosoc+ ten_viv + dg_cie_10_rec + sud_severity_icd10+ macrozone + policonsumo+ n_off_vio + n_off_acq+ n_off_sud + clas, data = mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c("rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),],
                weights = list("RP(df=10)+ Tenure status households" = "rpdf10_m_stag_ten_viv", "RP(df=10)+ Motive of admission & No. of children"="rpdf10_m_nostag_or_ing_num_hij", "Gompertz+ Tenure status households"="gomp_m_nostag_ten_viv", "Gompertz+ Motive of admission & No. of children"="gomp_m_nostag_or_ing_num_hij", "RP(df=6)+ Tenure status households"="rpdf6_m_nostag_ten_viv", "RP(df=6)+ Motive of admission & No. of children"="rpdf6_m_nostag_or_ing_num_hij"),
                estimand = "ATE",
                which.treat = .all,
                un = T, 
                thresholds = c(cor = .2),
                 binary = "std", continuous = "std",
                stats = c("mean.diffs", "variance.ratios"))
invisible("Error: NAs are not allowed in the weights.")

bal_tab2$Balance %>% 
  dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Balance Measures (multinomial response weights)")
  #knitr::kable("html", caption="Balance Measures") %>% 
  #   kableExtra::kable_classic_2()

invisible("differences in dg_cie10_rec")
```
:::

::: controlly 
```{r stata2, echo=T, fig.align='center', message=T, error=T, eval=T}
#The “effective sample size” (ESS) is a measure of the sample size a non-weighted sample would have to have to achieve the same level of precision as the weighted sample (Ridgeway 2006).
bal_tab2$Observations %>% 
  #dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Effective sample sizes")
```
:::

Now we compared against multi-valued treatments format.

::: controlly
```{r stata1-2, echo=T, fig.align='center', message=T, error=T, eval=T}

bal_tab2b<-
cobalt::bal.tab(motivodeegreso_mod_imp_rec3 ~ edad_al_ing_1+ edad_ini_cons + sex_enc + esc_rec + sus_prin_mod + fr_sus_prin + comp_biosoc+ ten_viv + dg_cie_10_rec + sud_severity_icd10+ macrozone + policonsumo+ n_off_vio + n_off_acq+ n_off_sud + clas, data = mariel_stata_sentence[complete.cases(mariel_stata_sentence[, c("motivodeegreso_mod_imp_rec", "rpdf10_m_stag_ten_viv", "rpdf10_m_nostag_or_ing_num_hij", "gomp_m_nostag_ten_viv", "gomp_m_nostag_or_ing_num_hij", "rpdf6_m_nostag_ten_viv", "rpdf6_m_nostag_or_ing_num_hij")]),],
                weights = list("RP(df=10)+ Tenure status households" = "rpdf10_m_stag_ten_viv", "RP(df=10)+ Motive of admission & No. of children"="rpdf10_m_nostag_or_ing_num_hij", "Gompertz+ Tenure status households"="gomp_m_nostag_ten_viv", "Gompertz+ Motive of admission & No. of children"="gomp_m_nostag_or_ing_num_hij", "RP(df=6)+ Tenure status households"="rpdf6_m_nostag_ten_viv", "RP(df=6)+ Motive of admission & No. of children"="rpdf6_m_nostag_or_ing_num_hij"),
                estimand = "ATE",
                which.treat = .all,
                un = T, 
                thresholds = c(cor = .2),
                 binary = "std", continuous = "std",
                stats = c("mean.diffs", "variance.ratios"))
invisible("Error: The treatment must have at least two unique values.")

rbind(data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`2 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 1`$Balance), keep.rownames=T),
      data.table::data.table(cbind(comp="Late vs. Early Dropout",bal_tab2b$Pair.Balance$`3 vs. 2`$Balance), keep.rownames=T)) %>% 
  data.table::data.table(keep.rownames = T) %>% 
  dplyr::select(comp, rn, everything()) %>% 
  dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Balance Measures (multinomial response weights)")
 #  knitr::kable("html", caption="Balance Measures") %>% 
   #   kableExtra::kable_classic_2()

invisible("0= completar; 1= no-completar;policonsumo looks not balanced, the number of previous acquisitive offenses, and South")
```
:::

::: controlly 
```{r stata1-5-2, echo=T, fig.align='center', message=T, error=T, eval=T}
rbind(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`2 vs. 1`$Balance),
      cbind(comp="Late Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 1`$Balance),
      cbind(comp="Late vs. Early Dropout",bal_tab2b$Pair.Balance$`3 vs. 2`$Balance)) %>% 
    data.table::data.table(keep.rownames = T) %>% 
    dplyr::select(comp, rn, everything()) %>% 
    dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
    dplyr::summarise_if(is.numeric, ~list(min= min(.,na.rm=T), max= max(.,na.rm=T))) %>% t() %>%
  knitr::kable("markdown", caption="Balance Measures (multinomial response weights)", col.names=c("min", "max"))
 #  knitr::kable("html", caption="Balance Measures (multinomial response weights)") %>% 
   #   kableExtra::kable_classic_2()
```
:::    

::: controlly 
```{r stata2-2, echo=T, fig.align='center', message=T, error=T, eval=T}
#The “effective sample size” (ESS) is a measure of the sample size a non-weighted sample would have to have to achieve the same level of precision as the weighted sample (Ridgeway 2006).

dplyr::bind_rows(data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`2 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 1`$Observations),keep.rownames = T), data.table::data.table(cbind(comp="Early Dropout vs. Tr. completion",bal_tab2b$Pair.Balance$`3 vs. 2`$Observations),keep.rownames = T)) %>% 
  #dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Effective sample sizes")
```
:::

<br>

# Bring other databases

```{r bring_db1, echo=T, fig.align='center', message=T, error=T, eval=T}
#http://observatorio.ministeriodesarrollosocial.gob.cl/pobreza-comunal-2020

Comunas_PNDR <- readxl::read_excel("Clasificacion-comunas-PNDR.xlsx")%>% 
  dplyr::mutate(cod= dplyr::case_when(as.character(cod_com)=="16101"~"8401",
                                      as.character(cod_com)=="16102"~"8402",
                                      as.character(cod_com)=="16103"~"8406",
                                      as.character(cod_com)=="16104"~"8407",
                                      as.character(cod_com)=="16105"~"8410",
                                      as.character(cod_com)=="16106"~"8411",
                                      as.character(cod_com)=="16107"~"8413",
                                      as.character(cod_com)=="16108"~"8418",
                                      as.character(cod_com)=="16109"~"8421",
                                      as.character(cod_com)=="16201"~"8414",
                                      as.character(cod_com)=="16202"~"8403",
                                      as.character(cod_com)=="16203"~"8404",
                                      as.character(cod_com)=="16204"~"8408",
                                      as.character(cod_com)=="16205"~"8412",
                                      as.character(cod_com)=="16206"~"8415",
                                      as.character(cod_com)=="16207"~"8420",
                                      as.character(cod_com)=="16301"~"8416",
                                      as.character(cod_com)=="16302"~"8405",
                                      as.character(cod_com)=="16303"~"8409",
                                      as.character(cod_com)=="16304"~"8417",
                                      as.character(cod_com)=="16305"~"8419",
                                      T~ as.character(cod_com)
                                      ))

#http://observatorio.ministeriodesarrollosocial.gob.cl/pobreza-comunal-2011
pobr_mult_2020<-readxl::read_excel("Estimaciones_de_Tasa_de_Pobreza_por_Ingresos_por_Comunas_2020_revisada2022_09.xlsx", skip=1) %>% dplyr::mutate(anio=2020) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2019<-readxl::read_excel("Estimaciones_de_Tasa_de_Pobreza_por_Ingresos_por_Comunas_2020_revisada2022_09.xlsx", skip=1) %>% dplyr::mutate(anio=2019) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2018<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2017.xlsx", skip=1) %>% dplyr::mutate(anio=2018) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2017<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2017.xlsx", skip=1) %>% dplyr::mutate(anio=2017) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2016<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2015.xlsx", skip=1) %>% dplyr::mutate(anio=2016) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2015<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_multidimensional_2015.xlsx", skip=1) %>% dplyr::mutate(anio=2015) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2014<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_2013.xlsx", skip=1)%>% dplyr::mutate(anio=2014) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2013<-readxl::read_excel("PLANILLA_Estimaciones_comunales_tasa_pobreza_por_ingresos_2013.xlsx", skip=1)%>% dplyr::mutate(anio=2013) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2012<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2012) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2011<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2011) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2010<-readxl::read_excel("Estimacion_tasa_de_pobreza_comunal_2011_(nueva _metodologia).xlsx", skip=1)%>% dplyr::mutate(anio=2010) %>% dplyr::rename_at(vars( contains("Porcentaje de") ), ~"porc_pobr") %>% dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2009<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2009) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2008<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2008) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)
pobr_mult_2007<-readxl::read_excel("PobrezaporComunas_SAE_20092011.xlsx", skip=3)%>% dplyr::mutate(anio=2007) %>% dplyr::select(anio, everything()) %>% dplyr::select(1:5) %>%  dplyr::rename_at(vars( contains("Incidencia pobreza") ), ~"porc_pobr") %>% dplyr::rename("Código"=2, "Nombre comuna"=3) %>%  dplyr::mutate(Región=rep("")) %>%  dplyr::select(anio, Código, Región, `Nombre comuna`, porc_pobr)

# replace comuna= "16103" if strpos(strlower(comuna),"8406")>0
# replace comuna= "16104" if strpos(strlower(comuna),"8407")>0
# replace comuna= "16105" if strpos(strlower(comuna),"8410")>0
# replace comuna= "16106" if strpos(strlower(comuna),"8411")>0
# replace comuna= "16107" if strpos(strlower(comuna),"8413")>0
# replace comuna= "16108" if strpos(strlower(comuna),"8418")>0
# replace comuna= "16109" if strpos(strlower(comuna),"8421")>0
# replace comuna= "16201" if strpos(strlower(comuna),"8414")>0
# replace comuna= "16202" if strpos(strlower(comuna),"8403")>0
# replace comuna= "16203" if strpos(strlower(comuna),"8404")>0
# replace comuna= "16204" if strpos(strlower(comuna),"8408")>0
# replace comuna= "16205" if strpos(strlower(comuna),"8412")>0
# replace comuna= "16206" if strpos(strlower(comuna),"8415")>0
# replace comuna= "16207" if strpos(strlower(comuna),"8420")>0
# replace comuna= "16301" if strpos(strlower(comuna),"8416")>0
# replace comuna= "16302" if strpos(strlower(comuna),"8405")>0
# replace comuna= "16303" if strpos(strlower(comuna),"8409")>0
# replace comuna= "16304" if strpos(strlower(comuna),"8417")>0
# replace comuna= "16305" if strpos(strlower(comuna),"8419")>0
pobr_mult_2007_2020<-
rbind.data.frame(pobr_mult_2007, pobr_mult_2008, pobr_mult_2009, pobr_mult_2010, pobr_mult_2011, pobr_mult_2012, pobr_mult_2013, pobr_mult_2014, pobr_mult_2015, pobr_mult_2016, pobr_mult_2017, pobr_mult_2018, pobr_mult_2019, pobr_mult_2020) %>% 
  dplyr::mutate(cod= dplyr::case_when(Código=="16101"~"8401",
                                      Código=="16102"~"8402",
                                      Código=="16103"~"8406",
                                      Código=="16104"~"8407",
                                      Código=="16105"~"8410",
                                      Código=="16106"~"8411",
                                      Código=="16107"~"8413",
                                      Código=="16108"~"8418",
                                      Código=="16109"~"8421",
                                      Código=="16201"~"8414",
                                      Código=="16202"~"8403",
                                      Código=="16203"~"8404",
                                      Código=="16204"~"8408",
                                      Código=="16205"~"8412",
                                      Código=="16206"~"8415",
                                      Código=="16207"~"8420",
                                      Código=="16301"~"8416",
                                      Código=="16302"~"8405",
                                      Código=="16303"~"8409",
                                      Código=="16304"~"8417",
                                      Código=="16305"~"8419",
                                      T~ Código
                                      ))


#2023-02-01:classifications by municipality
class_centros <- readxl::read_excel("_ig_borquez/class_centros.xlsx")%>%
    tidylog::left_join(CONS_C1_df_dup_SEP_2020[,c("id_centro","nombre_centro")], by=c("nombre_centro_1" ="nombre_centro"))%>%
    dplyr::group_by(id_centro)%>%
    slice(1)%>% 
    dplyr::ungroup()%>%
    dplyr::mutate(id_centro=dplyr::case_when(grepl("Allende",nombre_centro_1) & is.na(id_centro)~ "475",  T~ as.character(id_centro)))%>%
    dplyr::group_by(id_centro)%>%
    slice(1)
    #dplyr::filter(grepl("Allende",nombre_centro_1))


Base_fiscalia_v14<-
Base_fiscalia_v13 %>% 
  dplyr::mutate(comuna_residencia_cod_rec= as.character(readr::parse_number(comuna_residencia_cod)), anio_ing_tr= lubridate::epiyear(fech_ing)) %>% #glimpse()
  dplyr::left_join(pobr_mult_2007_2020[,c("anio", "cod","porc_pobr")], by= c("comuna_residencia_cod_rec"="cod", "anio_ing_tr"="anio")) %>% 
  dplyr::left_join(Comunas_PNDR[,c("cod", "Clasificación")], by= c("comuna_residencia_cod_rec"="cod"))%>%
  #2023-02-01
  dplyr::left_join(class_centros[,c("id_centro", "nombre_centro_1", "classification")], by= "id_centro")%>%
    purrr::when(nrow(.)>nrow(Base_fiscalia_v13) ~ stop("More cases in the new database"), ~.) %>% 
  dplyr::mutate(age_offending_imp= dplyr::case_when(age_offending_imp-edad_al_egres_imp<=0~ age_offending_imp+ 0.0001,T~age_offending_imp), event_r= ifelse(!is.na(offender_d),1,0)) %>% 
  dplyr::mutate(freq_cons_sus_prin= dplyr::case_when(as.character(freq_cons_sus_prin)=="Did not use"~"Less than 1 day a week", T~ as.character(freq_cons_sus_prin)))%>%
  dplyr::mutate(escolaridad_rec=parse_factor(as.character(escolaridad_rec),levels=c('3-Completed primary school or less', '2-Completed high school or less', '1-More than high school'), ordered =T,trim_ws=T,include_na =F, locale=locale(encoding = "Latin1"))) %>%  
  dplyr::mutate(freq_cons_sus_prin=parse_factor(as.character(freq_cons_sus_prin),levels=c('Less than 1 day a week','2 to 3 days a week','4 to 6 days a week','1 day a week or more','Daily'), ordered =T,trim_ws=F,include_na =F)) %>% #, locale=locale(encoding = "Latin1")
  dplyr::mutate(across(c("motivodeegreso_mod_imp_rec","sus_principal_mod", "origen_ingreso_mod", "tenencia_de_la_vivienda_mod", "condicion_ocupacional_corr", "dg_cie_10_rec", "macrozona", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "classification", "tr_modality"),~as.factor(.)))%>% 
  dplyr::mutate(via_adm_sus_prin_act= factor(dplyr::case_when(via_adm_sus_prin_act=="Injected Intravenously or Intramuscularly"~ "Other",T~via_adm_sus_prin_act)))
#TO CHECK IF SOME MUNICIPALLITIES DID NOT JOIN
  #dplyr::filter(is.na(porc_pobr)) %>% dplyr::select(comuna_residencia_cod, anio_ing_tr)

Base_fiscalia_v14_pris<-
Base_fiscalia_v13_pris %>% 
  dplyr::mutate(comuna_residencia_cod_rec= as.character(readr::parse_number(comuna_residencia_cod)), anio_ing_tr= lubridate::epiyear(fech_ing)) %>% #glimpse()
  dplyr::left_join(pobr_mult_2007_2020[,c("anio", "cod","porc_pobr")], by= c("comuna_residencia_cod_rec"="cod", "anio_ing_tr"="anio")) %>% 
  dplyr::left_join(Comunas_PNDR[,c("cod", "Clasificación")], by= c("comuna_residencia_cod_rec"="cod"))%>%
  #2023-02-01
  dplyr::left_join(class_centros[,c("id_centro", "nombre_centro_1", "classification")], by= "id_centro")%>%
    purrr::when(nrow(.)>nrow(Base_fiscalia_v13) ~ stop("More cases in the new database"), ~.)%>% 
  dplyr::mutate(age_offending_imp= dplyr::case_when(age_offending_imp-edad_al_egres_imp<=0~ age_offending_imp+ 0.0001,T~age_offending_imp), event_r= ifelse(!is.na(offender_d),1,0)) %>% 
  dplyr::mutate(freq_cons_sus_prin= dplyr::case_when(as.character(freq_cons_sus_prin)=="Did not use"~"Less than 1 day a week", T~ as.character(freq_cons_sus_prin)))%>%
  dplyr::mutate(escolaridad_rec=parse_factor(as.character(escolaridad_rec),levels=c('3-Completed primary school or less', '2-Completed high school or less', '1-More than high school'), ordered =T,trim_ws=T,include_na =F, locale=locale(encoding = "Latin1"))) %>%  
  dplyr::mutate(freq_cons_sus_prin=parse_factor(as.character(freq_cons_sus_prin),levels=c('Less than 1 day a week','2 to 3 days a week','4 to 6 days a week','1 day a week or more','Daily'), ordered =T,trim_ws=F,include_na =F)) %>% #, locale=locale(encoding = "Latin1")
  dplyr::mutate(freq_cons_sus_prin= as.factor(freq_cons_sus_prin)) %>% 
  dplyr::mutate(across(c("motivodeegreso_mod_imp_rec","sus_principal_mod", "origen_ingreso_mod", "tenencia_de_la_vivienda_mod", "condicion_ocupacional_corr", "dg_cie_10_rec", "macrozona", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "classification", "tr_modality"),~as.factor(.))) %>% 
  dplyr::mutate(via_adm_sus_prin_act= factor(dplyr::case_when(via_adm_sus_prin_act=="Injected Intravenously or Intramuscularly"~ "Other",T~via_adm_sus_prin_act)))


#TO CHECK IF SOME MUNICIPALLITIES DID NOT JOIN
  #dplyr::filter(is.na(porc_pobr)) %>% dplyr::select(comuna_residencia_cod, anio_ing_tr)  

#Base_fiscalia_v14 %>% dplyr::filter(dplyr::case_when(age_offending_imp-edad_al_egres_imp<=0~T,T~F))

#Private Therapeutic Community, ref
Base_fiscalia_v14$clas_r <- relevel(factor(Base_fiscalia_v14$Clasificación), ref = "Urbana")
Base_fiscalia_v14_pris$clas_r <- relevel(factor(Base_fiscalia_v14$Clasificación), ref = "Urbana")
Base_fiscalia_v14$via_adm_sus_prin_act <- relevel(factor(Base_fiscalia_v14$via_adm_sus_prin_act), ref = "Oral (drunk or eaten)")
Base_fiscalia_v14_pris$via_adm_sus_prin_act <- relevel(factor(Base_fiscalia_v14_pris$via_adm_sus_prin_act), ref = "Oral (drunk or eaten)")

Base_fiscalia_v14$yrs_to_condemn<- Base_fiscalia_v14$age_offending_imp - Base_fiscalia_v14$edad_al_egres_imp
Base_fiscalia_v14_pris$yrs_to_pris<- Base_fiscalia_v14_pris$age_offending_imp - Base_fiscalia_v14_pris$edad_al_egres_imp

#2022-02-27
Base_fiscalia_v14$clas_centers_r <- Base_fiscalia_v14$classification
Base_fiscalia_v14$classification<- NULL
Base_fiscalia_v14_pris$clas_centers_r <- Base_fiscalia_v14_pris$classification
Base_fiscalia_v14_pris$classification<- NULL

cat_vars_dg_fis<-
c("dg_fis_anemia", "dg_fis_card", "dg_fis_in_study", "dg_fis_enf_som", "dg_fis_ets", "dg_fis_hep_alc", "dg_fis_hep_b", "dg_fis_hep_cro", "dg_fis_inf", "dg_fis_otr_cond_fis_ries_vit", "dg_fis_otr_cond_fis", "dg_fis_pat_buc", "dg_fis_pat_ges_intrau", "dg_fis_trau_sec")
```

<br>

## Crude RMST & RMSTL

We calculated the restricted mean survival time and lost, considering hazards did not seem to be proportional. We considered people with complete data (n= `r nrow(Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),])`) of the total sample (n= `r nrow(Base_fiscalia_v14)`). 

::: controlly 
```{r rmst, echo=T, fig.align='center', message=T, error=T, eval=T, fig.height= 10, fig.cap= "Kaplan-Meier curves by, Difference with age of offense from discharge"}
#Treatment completion Treatment non-completion (Early)  Treatment non-completion (Late) 
yrs_to_condemn_comp_cases<-
Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),"yrs_to_condemn"]
event_r_comp_cases<-
Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),"event_r"]
motivo_egreso_comp_cases <- Base_fiscalia_v14[complete.cases(Base_fiscalia_v14[,c("motivodeegreso_mod_imp_rec", "yrs_to_condemn", "event_r")]),"motivodeegreso_mod_imp_rec"]
tr_comp_comp_cases<-ifelse(motivo_egreso_comp_cases=="Treatment completion",1,0)
tr_early_drop_comp_cases<-ifelse(motivo_egreso_comp_cases=="Treatment non-completion (Early)",1,0)

tr_late_drop_comp_cases<-ifelse(motivo_egreso_comp_cases=="Treatment non-completion (Late)",1,0)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

cat("Treatment completion vs. Late and Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_comp_comp_cases, tau=.33)

cat("Treatment completion vs. Late and Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r, tr_comp_comp_cases, tau=1)

cat("Treatment completion vs. Late and Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_comp_comp_cases, tau=3)

cat("Treatment completion vs. Late and Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_comp_comp_cases, tau=5)


cat("===============================================================================")


cat("Treatment Late Discharge vs. Tratment completion and Early Dropouts at 3 months")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_late_drop_comp_cases, tau=.33)

cat("Treatment Late Discharge vs. Tratment completion and Early Dropouts at 1 year")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_late_drop_comp_cases, tau=1)

cat("Treatment Late Discharge vs. Tratment completion and Early Dropouts at 3 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_late_drop_comp_cases, tau=3)

cat("Treatment Late Discharge vs. Tratment completion and Early Dropouts at 5 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_late_drop_comp_cases, tau=5)


cat("===============================================================================")

cat("Treatment Early Discharge vs. Tratment completion and Late Dropouts at 3 months")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_early_drop_comp_cases, tau=.33)

cat("Treatment Early Discharge vs. Tratment completion and Late Dropouts at 1 year")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_early_drop_comp_cases, tau=1)

cat("Treatment Early Discharge vs. Tratment completion and Late Dropouts at 3 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_early_drop_comp_cases, tau=3)

cat("Treatment Early Discharge vs. Tratment completion and Late Dropouts at 5 years")
survRM2::rmst2(yrs_to_condemn_comp_cases, event_r_comp_cases, tr_early_drop_comp_cases, tau=5)
```
:::

- Those patients who completed treatment had more time avoiding condemnatory sentences and differences and ratios are statistically significant at three months to five years of follow-up.

- Those with early discharge had less time avoiding avoiding condemnatory sentences and differences and ratios are statistically significant at three months to five years of follow-up.

<br>

## Linearity

We checked the proportionality and linearity of covariates.

::: controlly
```{r diag, echo=T, fig.align='center', message=T, error=T, eval=T}
vars_cov<-c("tr_modality", "edad_al_ing_1", "sex", "edad_ini_cons", "dias_treat_imp_sin_na_1", "escolaridad_rec", "sus_principal_mod", "freq_cons_sus_prin", "condicion_ocupacional_corr", "via_adm_sus_prin_act", "policonsumo", "origen_ingreso_mod", "numero_de_hijos_mod", "tenencia_de_la_vivienda_mod", "dg_cie_10_rec", "dg_trs_cons_sus_or", "macrozona", "n_off_vio", "n_off_acq", "n_off_sud", "n_off_oth", "clas_centers_r", "clas_r", "porc_pobr")

coxfit_more_var1 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec +", paste(setdiff(vars_cov,""), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)#[1:250,]
#n_prev_off + 

coxfit_more_var2 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,3) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var3 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,4) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var4 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,5) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var5 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + rcs(edad_al_ing_1,6) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var6 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var7 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 2) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var8 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 3) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

coxfit_more_var9 <- coxph(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ motivodeegreso_mod_imp_rec + ns(edad_al_ing_1,df= 4) +", paste(setdiff(vars_cov,"edad_al_ing_1"), collapse = "+"))), ties="efron", data= Base_fiscalia_v14)

anova(coxfit_more_var1, coxfit_more_var2, coxfit_more_var3, coxfit_more_var4, coxfit_more_var5, coxfit_more_var6, coxfit_more_var7, coxfit_more_var8, coxfit_more_var9)

anova(coxfit_more_var4, coxfit_more_var8)

# Dimitris Rizopoulos (https://stats.stackexchange.com/users/219012/dimitris-rizopoulos), Check log-linearity of a continuous variable to predict survival, URL (version: 2018-10-08): https://stats.stackexchange.com/q/370353

# Create an effect plot to depict the relationship
ND <- with(Base_fiscalia_v14, data.frame(edad_al_ing_1 = seq(min(edad_al_ing_1),  max(edad_al_ing_1), length.out = 500),
  motivodeegreso_mod_imp_rec=rep(Mode(motivodeegreso_mod_imp_rec),500),
  #edad_al_ing_1=rep(mean(edad_al_ing_1, na.rm=T))
  sex= rep(Mode(sex),500),
  tr_modality= rep(Mode(tr_modality),500),
  edad_ini_cons=rep(quantile(edad_ini_cons, .5, na.rm=T),500),
  dias_treat_imp_sin_na_1= rep(quantile(dias_treat_imp_sin_na_1, .5, na.rm=T),500),
  escolaridad_rec= rep(Mode(escolaridad_rec),500),
  sus_principal_mod= rep(Mode(sus_principal_mod),500),
  freq_cons_sus_prin= rep(Mode(freq_cons_sus_prin),500),
  condicion_ocupacional_corr= rep(Mode(condicion_ocupacional_corr),500),
  via_adm_sus_prin_act= rep(Mode(via_adm_sus_prin_act),500),
  policonsumo= rep(Mode(policonsumo),500),
  origen_ingreso_mod= rep(Mode(origen_ingreso_mod),500),
  numero_de_hijos_mod= rep(quantile(numero_de_hijos_mod, .5, na.rm=T),500),
  tenencia_de_la_vivienda_mod= rep(Mode(tenencia_de_la_vivienda_mod),500),
  dg_cie_10_rec = rep(Mode(dg_cie_10_rec),500),
  dg_trs_cons_sus_or = rep(Mode(dg_trs_cons_sus_or),500),
  macrozona = rep(Mode(macrozona),500),
  #n_prev_off= rep(quantile(n_prev_off, .5, na.rm=T),500),
  n_off_vio= rep(Mode(n_off_vio),500),
  n_off_acq= rep(Mode(n_off_acq),500),
  n_off_sud= rep(Mode(n_off_sud),500),
  n_off_oth= rep(Mode(n_off_oth),500),
  clas_centers_r= rep(Mode(clas_centers_r),500),
  clas_r= rep(Mode(clas_r),500),
  porc_pobr=rep(quantile(porc_pobr, .5, na.rm=T),500) 
))

prs <- predict(coxfit_more_var8, newdata = ND, type = "lp", se.fit = TRUE)
ND$pred <- prs[[1]]
ND$se <- prs[[2]]
ND$lo <- ND$pred - 1.96 * ND$se
ND$up <- ND$pred + 1.96 * ND$se

xyplot(pred + lo + up ~ edad_al_ing_1, data = ND,
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio")

prs2 <- predict(coxfit_more_var1, newdata = ND%>% dplyr::mutate(edad_ini_cons= seq(min(Base_fiscalia_v14$edad_ini_cons,na.rm=T),  max(Base_fiscalia_v14$edad_ini_cons,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)), type = "lp", se.fit = TRUE)
ND$pred2 <- prs2[[1]]
ND$se2 <- prs2[[2]]
ND$lo2 <- ND$pred2 - 1.96 * ND$se2
ND$up2 <- ND$pred2 + 1.96 * ND$se2

xyplot(pred2 + lo2 + up2 ~ edad_ini_cons, data = ND%>% dplyr::mutate(edad_ini_cons= seq(min(Base_fiscalia_v14$edad_ini_cons,na.rm=T),  max(Base_fiscalia_v14$edad_ini_cons,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio")

prs3 <- predict(coxfit_more_var8, newdata = ND%>% dplyr::mutate(dias_treat_imp_sin_na_1= seq(min(Base_fiscalia_v14$dias_treat_imp_sin_na_1,na.rm=T),  max(Base_fiscalia_v14$dias_treat_imp_sin_na_1,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)), type = "lp", se.fit = TRUE)
ND$pred3 <- prs3[[1]]
ND$se3 <- prs3[[2]]
ND$lo3 <- ND$pred3 - 1.96 * ND$se3
ND$up3 <- ND$pred3 + 1.96 * ND$se3

xyplot(pred3 + lo3 + up3 ~ dias_treat_imp_sin_na_1, data = ND%>% dplyr::mutate(dias_treat_imp_sin_na_1= seq(min(Base_fiscalia_v14$dias_treat_imp_sin_na_1,na.rm=T),  max(Base_fiscalia_v14$dias_treat_imp_sin_na_1,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio")

prs4 <- predict(coxfit_more_var8, newdata = ND%>% dplyr::mutate(numero_de_hijos_mod= seq(min(Base_fiscalia_v14$numero_de_hijos_mod,na.rm=T),  max(Base_fiscalia_v14$numero_de_hijos_mod,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)), type = "lp", se.fit = TRUE)
ND$pred4 <- prs4[[1]]
ND$se4 <- prs4[[2]]
ND$lo4 <- ND$pred4 - 1.96 * ND$se4
ND$up4 <- ND$pred4 + 1.96 * ND$se4

xyplot(pred4 + lo4 + up4 ~ numero_de_hijos_mod, data = ND%>% dplyr::mutate(numero_de_hijos_mod= seq(min(Base_fiscalia_v14$numero_de_hijos_mod,na.rm=T),  max(Base_fiscalia_v14$numero_de_hijos_mod,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio")

prs5 <- predict(coxfit_more_var8, newdata = ND%>% dplyr::mutate(n_prev_off= seq(min(Base_fiscalia_v14$n_prev_off,na.rm=T),  max(Base_fiscalia_v14$n_prev_off,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)), type = "lp", se.fit = TRUE)
ND$pred5 <- prs5[[1]]
ND$se5 <- prs5[[2]]
ND$lo5 <- ND$pred5 - 1.96 * ND$se5
ND$up5 <- ND$pred5 + 1.96 * ND$se5

xyplot(pred5 + lo5 + up5 ~ n_prev_off, data = ND%>% dplyr::mutate(n_prev_off= seq(min(Base_fiscalia_v14$n_prev_off,na.rm=T),  max(Base_fiscalia_v14$n_prev_off,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio")

prs6 <- predict(coxfit_more_var8, newdata = ND%>% dplyr::mutate(porc_pobr= seq(min(Base_fiscalia_v14$porc_pobr,na.rm=T),  max(Base_fiscalia_v14$porc_pobr,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)), type = "lp", se.fit = TRUE)
ND$pred6 <- prs6[[1]]
ND$se6 <- prs6[[2]]
ND$lo6 <- ND$pred6 - 1.96 * ND$se6
ND$up6 <- ND$pred6 + 1.96 * ND$se6

xyplot(pred6 + lo6 + up6 ~ porc_pobr, data = ND%>% dplyr::mutate(porc_pobr= seq(min(Base_fiscalia_v14$porc_pobr,na.rm=T),  max(Base_fiscalia_v14$porc_pobr,na.rm=T), length.out = 500))%>% dplyr::mutate(edad_al_ing_1= quantile(Base_fiscalia_v14$edad_al_ing_1, .5, na.rm=T)),
       type = "l", col = "black", lwd = 2, lty = c(1, 2, 2),
       abline = list(h = 0, lty = 2, lwd = 2, col = "red"),
       xlab = "Risk Factor", ylab = "log Hazard Ratio")
```
:::

::: controlly
```{r diag2, echo=T, fig.align='center', message=T, error=T, eval=T}
#http://www.sthda.com/english/wiki/cox-model-assumptions
invisible("Martingale residual to assess nonlinearity, does not allow ns or rcs")
# 
# #https://github.com/kassambara/survminer/issues/357
 res.cox_edad_ing <- coxph(Surv(yrs_to_condemn,  event_r) ~ edad_al_ing_1+ log(edad_al_ing_1) + I(edad_al_ing_1^2) + I(log(edad_al_ing_1)^2) + I(sqrt(edad_al_ing_1)), data = Base_fiscalia_v14)
 
 
 ggcoxfunctional(res.cox_edad_ing,  data = Base_fiscalia_v14%>% dplyr::filter(!is.na(edad_al_ing_1)), point.col = "blue", point.alpha = 0.5)
 
cat("______________________________________________________________________") 
 
# 
# #to avoid errors, we deleted missing values
# 
 res.cox_porc_pobr <- coxph(Surv(yrs_to_condemn,  event_r) ~ porc_pobr + log(porc_pobr) + I(porc_pobr^2) + I(log(porc_pobr)^2) + I(sqrt(porc_pobr)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(porc_pobr)))
# 
 ggcoxfunctional(res.cox_porc_pobr,  data = Base_fiscalia_v14%>% dplyr::filter(!is.na(porc_pobr)), point.col = "blue", point.alpha = 0.5)

cat("______________________________________________________________________")
  
#to avoid errors, we replaced 0s with 0.0001
res.cox_dias_treat <- coxph(Surv(yrs_to_condemn,  event_r) ~ dias_treat_imp_sin_na_1 + log(dias_treat_imp_sin_na_1) + I(log(dias_treat_imp_sin_na_1)^2) + I(dias_treat_imp_sin_na_1^2) +  I(sqrt(dias_treat_imp_sin_na_1)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(dias_treat_imp_sin_na_1)) %>% dplyr::mutate(dias_treat_imp_sin_na_1= dplyr::case_when(dias_treat_imp_sin_na_1==0~.0001,T~dias_treat_imp_sin_na_1)))

ggcoxfunctional(res.cox_dias_treat,  data = Base_fiscalia_v14%>% dplyr::filter(!is.na(dias_treat_imp_sin_na_1)) %>% dplyr::mutate(dias_treat_imp_sin_na_1= dplyr::case_when(dias_treat_imp_sin_na_1==0~.0001,T~dias_treat_imp_sin_na_1)), point.col = "blue", point.alpha = 0.5)

cat("______________________________________________________________________")

res.cox_num_hijos <- coxph(Surv(yrs_to_condemn,  event_r) ~ numero_de_hijos_mod + log(numero_de_hijos_mod) + I(log(numero_de_hijos_mod)^2) + I(numero_de_hijos_mod^2) +  I(sqrt(numero_de_hijos_mod)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(numero_de_hijos_mod)) %>% dplyr::mutate(numero_de_hijos_mod= dplyr::case_when(numero_de_hijos_mod==0~.0001,T~as.numeric(numero_de_hijos_mod))))

ggcoxfunctional(res.cox_num_hijos,  data =  Base_fiscalia_v14%>% dplyr::filter(!is.na(numero_de_hijos_mod)) %>% dplyr::mutate(numero_de_hijos_mod= dplyr::case_when(numero_de_hijos_mod==0~.0001,T~as.numeric(numero_de_hijos_mod))), point.col = "blue", point.alpha = 0.5)

cat("______________________________________________________________________")

res.cox_n_prev_off <- coxph(Surv(yrs_to_condemn,  event_r) ~ n_prev_off + log(n_prev_off) + I(log(n_prev_off)^2) + I(n_prev_off^2) +  I(sqrt(n_prev_off)), data = Base_fiscalia_v14%>% dplyr::filter(!is.na(n_prev_off)) %>% dplyr::mutate(n_prev_off= dplyr::case_when(n_prev_off==0~.0001,T~as.numeric(n_prev_off))))

ggcoxfunctional(res.cox_n_prev_off,  data =  Base_fiscalia_v14%>% dplyr::filter(!is.na(n_prev_off)) %>% dplyr::mutate(n_prev_off= dplyr::case_when(n_prev_off==0~.0001,T~as.numeric(n_prev_off))), point.col = "blue", point.alpha = 0.5)
# 
# n_prev_off numero_de_hijos_mod
# coxfit_pris_more_var <- coxph(Surv(edad_al_egres_imp,age_offending_imp,  event_r) ~ motivodeegreso_mod_imp_rec + edad_al_ing_1 + edad_ini_cons + dias_treat_imp_sin_na_1 + escolaridad_rec + sus_principal_mod + freq_cons_sus_prin + condicion_ocupacional_corr+ via_adm_sus_prin_act+ origen_ingreso_mod + numero_de_hijos_mod + tenencia_de_la_vivienda_mod + dg_cie_10_rec + dg_trs_cons_sus_or + macrozona + n_prev_off + n_off_vio + n_off_acq + n_off_sud + n_off_oth + clas_centers_r+ clas_r + porc_pobr, ties="efron", data= Base_fiscalia_v14_pris)#[1:250,]

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
check_PH <- cox.zph(coxfit_more_var8, transform="km")
data.frame(check_PH$table)%>% 
  knitr::kable("markdown", caption= "Schoefeld residuals")
```
:::

::: controlly
```{r diag2-2, echo=T, fig.align='center', message=T, error=T, eval=T}
check_PH <- cox.zph(coxfit_more_var8, transform="km")
data.frame(check_PH$table)%>% 
  knitr::kable("markdown", caption= "Schoefeld residuals")
```
:::

```{r diag2-5, echo=T, fig.align='center', message=T, error=T, eval=T}
#predict(coxfit_more_var8,type="expected")

ND2 <- with(Base_fiscalia_v14, data.frame(edad_al_ing_1 = rep(quantile(edad_al_ing_1, .5, na.rm=T),3), 
  motivodeegreso_mod_imp_rec= c(rep(as.character(unlist(strsplit(attr(table(Base_fiscalia_v14$motivodeegreso_mod_imp_rec),"name"), split="\t"))),1)),
  #edad_al_ing_1=rep(mean(edad_al_ing_1, na.rm=T))
  sex= rep(Mode(sex),3),
  tr_modality= rep(Mode(tr_modality),3),
  edad_ini_cons=rep(quantile(edad_ini_cons, .5, na.rm=T),3),
  dias_treat_imp_sin_na_1= rep(quantile(dias_treat_imp_sin_na_1, .5, na.rm=T),3),
  escolaridad_rec= rep(Mode(escolaridad_rec),3),
  sus_principal_mod= rep(Mode(sus_principal_mod),3),
  freq_cons_sus_prin= rep(Mode(freq_cons_sus_prin),3),
  condicion_ocupacional_corr= rep(Mode(condicion_ocupacional_corr),3),
  via_adm_sus_prin_act= rep(Mode(via_adm_sus_prin_act),3),
  policonsumo= rep(Mode(policonsumo),3),  
  origen_ingreso_mod= rep(Mode(origen_ingreso_mod),3),
  numero_de_hijos_mod= rep(quantile(numero_de_hijos_mod, .5, na.rm=T),3),
  tenencia_de_la_vivienda_mod= rep(Mode(tenencia_de_la_vivienda_mod),3),
  dg_cie_10_rec = rep(Mode(dg_cie_10_rec),3),
  dg_trs_cons_sus_or = rep(Mode(dg_trs_cons_sus_or),3),
  macrozona = rep(Mode(macrozona),3),
  #n_prev_off= rep(quantile(n_prev_off, .5, na.rm=T),3),
  n_off_vio= rep(Mode(n_off_vio),3),
  n_off_acq= rep(Mode(n_off_acq),3),
  n_off_sud= rep(Mode(n_off_sud),3),
  n_off_oth= rep(Mode(n_off_oth),3),
  clas_centers_r= rep(Mode(clas_centers_r),3),
  clas_r= rep(Mode(clas_r),3),
  porc_pobr=rep(quantile(porc_pobr, .5, na.rm=T),3) 
))

#If you give it a fitted Cox model, then it calculates the Breslow estimator of the survival function under the fitted model.

risk = function(model, newdata, time) {
  rbind(est=as.numeric(1-summary(survfit(model, newdata = newdata, se.fit = T, conf.int = .95), times = time)$surv),
  lo= as.numeric(1-summary(survfit(model, newdata = newdata, se.fit = T, conf.int = .95), times= time)$upper),
  hi= as.numeric(1-summary(survfit(model, newdata = newdata, se.fit = T, conf.int = .95), times= time)$lower))
}
risk1<-
round(risk(coxfit_more_var8,ND2, .33),2)
risk2<-
round(risk(coxfit_more_var8,ND2, 1),2)
risk3<-
round(risk(coxfit_more_var8,ND2, 3),2)
risk4<-
round(risk(coxfit_more_var8,ND2, 5),2)

risk_df<-
data.frame(cbind(t=rep(c("3 months", "1 year", "3 years", "5 years"), each=3),mod= rep(c("T.comp", "Early drop", "Late drop"),4),rbind(t(risk1), t(risk2), t(risk3), t(risk4))))

colnames(risk_df) <- c("t", "Tr.status", "est", "lo", "hi")

risk_df %>% 
  knitr::kable("markdown", caption="Predicted cumulative risk by tr. status (Cox model)")
```

```{r diag3, echo=T, fig.align='center', message=T, error=T, eval=T}
KM_fit <- survfit(Surv(edad_al_egres_imp, age_offending_imp, event_r) ~ 
    strata(motivodeegreso_mod_imp_rec), data = Base_fiscalia_v14)

par(mfrow = c(1, 2))

plot(KM_fit, xlab = "Years", ylab = "Survival", col = 2:4)
#legend("topright", levels(factor(Base_fiscalia_v14$motivodeegreso_mod_imp_rec)), lty = 1, col = 2:4, bty = "n")

plot(KM_fit, fun = function (s) -log(-log(s)), xlab = "Years", 
    ylab = "-log(- log(Survival))", col = 2:4)
legend("topright", levels(factor(Base_fiscalia_v14$motivodeegreso_mod_imp_rec)), lty = 1, col = 2:4, bty = "n")
```

<br>

```{r diag4, echo=T, fig.align='center', message=T, error=T, eval=T}
par(mfrow = c(1, 1))

plot(check_PH, var = 1)
abline(h = coef(coxfit_more_var8)[1], col = "red", lwd = 2)
```

<br>


```{r diag2-6, echo=T, fig.align='center', message=T, error=T, eval=F}

cat("(====================================================================)")
invisible("http://dx.doi.org/10.7910/DVN/ELT9VD")
invisible("https://cran.r-project.org/web/packages/coxed/coxed.pdf")
invisible("https://cran.r-project.org/web/packages/coxed/vignettes/coxed.html")

system.time({
npsf1<-coxed(coxfit_more_var8, method="npsf")
})
warning("Error: cannot allocate vector of size 18.3 Gb")
#https://search.r-project.org/CRAN/refmans/pec/html/predictSurvProb.html
system.time({
npsf2<-coxed(coxfit_more_var8, method="npsf", bootstrap = T)
})
system.time({
coxed_gam<-coxed(coxfit_more_var8, method="gam",bootstrap = TRUE, B=100,
  newdata= dplyr::mutate(Base_fiscalia_v14, motivodeegreso_mod_imp_rec="Treatment completion"), 
  newdata2= dplyr::mutate(Base_fiscalia_v14,motivodeegreso_mod_imp_rec="Treatment non-completion (Early)"),
  newdata3= dplyr::mutate(Base_fiscalia_v14,motivodeegreso_mod_imp_rec="Treatment non-completion (Late)")) #newdata3= dplyr::mutate(motivodeegreso_mod_imp_rec="Treatment non-completion (Late)")
}) 
invisible("Inclusion of censored cases increases mean duration by more than 25%. Consider using method='npsf' instead")

cat("(====================================================================)")

invisible("https://cran.r-project.org/web/packages/randomForestSRC/randomForestSRC.pdf")

follic.obj <- randomForestSRC::rfsrc(as.formula(paste("Surv(yrs_to_condemn,  event_r) ~ ", paste(vars_cov, collapse = "+ "))), Base_fiscalia_v14_mod %>% dplyr::mutate(cat_ocupacional_corr= factor(cat_ocupacional_corr), dg_trs_cons_sus_or= factor(dg_trs_cons_sus_or)), nsplit = 3, ntree = 100)

p.v <- plot.variable(follic.obj, target = 2)
p.v$plots.per.page <- 1


invisible("Error in finalizeData(c(subj.names, yvar.names, xvar.names), data, na.action,  : 
  data types cannot be character: please convert all characters to factors")
```

<br>

# IPW

We calculated the restricted mean survival time and lost, considering that proportionality of trends could be violated.

::: controlly 
```{r rmst-adj0, echo=T, fig.align='center', message=T, error=T, eval=T}
invisible("Discard missing values in cause of discharge")
Base_fiscalia_v14_mod<-Base_fiscalia_v14[which(!is.na(Base_fiscalia_v14$motivodeegreso_mod_imp_rec))]
# Base_fiscalia_v14$clas_r <- relevel(factor(Base_fiscalia_v14$Clasificación), ref = "Urbana")
# Base_fiscalia_v14_pris$clas_r <- relevel(factor(Base_fiscalia_v14$Clasificación), ref = "Urbana")
# Base_fiscalia_v14$via_adm_sus_prin_act <- relevel(factor(Base_fiscalia_v14$via_adm_sus_prin_act), ref = "Oral (drunk or eaten)")
# Base_fiscalia_v14_pris$via_adm_sus_prin_act <- relevel(factor(Base_fiscalia_v14_pris$via_adm_sus_prin_act), ref = "Oral (drunk or eaten)")
# 
# Base_fiscalia_v14$yrs_to_condemn<- Base_fiscalia_v14$age_offending_imp - Base_fiscalia_v14$edad_al_egres_imp
# Base_fiscalia_v14_pris$yrs_to_pris<- Base_fiscalia_v14_pris$age_offending_imp - Base_fiscalia_v14_pris$edad_al_egres_imp


set.seed(2125)
W2 <- weightit(as.formula(paste("motivodeegreso_mod_imp_rec~", paste(vars_cov, collapse = "+"))),
               data=Base_fiscalia_v14[which(!is.na(Base_fiscalia_v14$motivodeegreso_mod_imp_rec))], stabilize = T, method = "ps", estimand = "ATE", int=T, use.mlogit = FALSE)
invisible("Warning: Missing values are present in the covariates. See ?WeightIt::method_ps for information on how these are handled.")
invisible("Warning message:
Some extreme weights were generated. Examine them with summary() and maybe trim them with trim().")
Base_fiscalia_v14_mod$weight_mult_a1 <-W2$weights
Base_fiscalia_v14_mod$weight_mult_a2 <-trim(W2$weights,.01)
Base_fiscalia_v14_mod$weight_mult_a3 <-trim(W2$weights,.05)
Base_fiscalia_v14_mod$weight_mult_a4 <-trim(W2$weights,.1)
summary(W2)

#Error: The treatment must have at least two unique values.
#Error in set(x, j = name, value = value) : 
#  Supplied 27185 items to be assigned to 70863 items of column 'weight_mult_a00'. If you wish to 'recycle' the RHS please use rep() to make this intent clear to readers of your code.

#truncate weights at 1%
Base_fiscalia_v14_mod$weight_tr <- ifelse(Base_fiscalia_v14_mod$weight_mult_a1 < quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.01), quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.01), Base_fiscalia_v14_mod$weight_mult_a1)
Base_fiscalia_v14_mod$weight_tr <- ifelse(Base_fiscalia_v14_mod$weight_mult_a1 > quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.99), quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.99), Base_fiscalia_v14_mod$weight_tr)

#truncate weights at 5%
Base_fiscalia_v14_mod$weight_tr2 <- ifelse(Base_fiscalia_v14_mod$weight_mult_a1 < quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.05), quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.05), Base_fiscalia_v14_mod$weight_mult_a1)
Base_fiscalia_v14_mod$weight_tr2 <- ifelse(Base_fiscalia_v14_mod$weight_mult_a1 > quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.95), quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.95), Base_fiscalia_v14_mod$weight_tr2)

#truncate weights at 10%
Base_fiscalia_v14_mod$weight_tr3 <- ifelse(Base_fiscalia_v14_mod$weight_mult_a1 < quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.1), quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.1), Base_fiscalia_v14_mod$weight_mult_a1)
Base_fiscalia_v14_mod$weight_tr3 <- ifelse(Base_fiscalia_v14_mod$weight_mult_a1 >
quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.9), quantile(Base_fiscalia_v14_mod$weight_mult_a1, probs=.9), Base_fiscalia_v14_mod$weight_tr3)

# AKM RMST adjusted for age
source("https://raw.githubusercontent.com/s-conner/akm-rmst/master/AKM_rmst.R")


cat("===============================================================================")

cat("at 3 months (adjusted), not trimmed weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a1, tau=.33)

cat("At 1 year (adjusted), not trimmed weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a1, tau=1)

cat("At 3 years (adjusted), not trimmed weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a1, tau=3)

cat("At 5 years (adjusted), not trimmed weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a1, tau=5)


cat("===============================================================================")

cat("at 3 months (adjusted), weights trimmed by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a2, tau=.33)

cat("At 1 year (adjusted), weights trimmed by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a2, tau=1)

cat("At 3 years (adjusted), weights trimmed by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a2, tau=3)

cat("At 5 years (adjusted), weights trimmed by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a2, tau=5)


cat("===============================================================================")

cat("at 3 months (adjusted), weights trimmed by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a3, tau=.33)

cat("At 1 year (adjusted), weights trimmed by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a3, tau=1)

cat("At 3 years (adjusted), weights trimmed by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a3, tau=3)

cat("At 5 years (adjusted), weights trimmed by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a3, tau=5)


cat("===============================================================================")

cat("at 3 months (adjusted), weights trimmed by 10%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a4, tau=.33)

cat("At 1 year (adjusted), weights trimmed by 10%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a4, tau=1)

cat("At 3 years (adjusted), weights trimmed by 10%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a4, tau=3)

cat("At 5 years (adjusted), weights trimmed by 10%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_mult_a4, tau=5)

cat("===============================================================================")

cat("===============================================================================")

cat("at 3 months (adjusted), not stabilized weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr, tau=.33)

cat("At 1 year (adjusted), not stabilized weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr, tau=1)

cat("At 3 years (adjusted), not stabilized weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr, tau=3)

cat("At 5 years (adjusted), not stabilized weights")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr, tau=5)

cat("===============================================================================")

cat("at 3 months (adjusted), weights stabilized by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr2, tau=.33)

cat("At 1 year (adjusted), weights stabilized by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr2, tau=1)

cat("At 3 years (adjusted), weights stabilized by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr2, tau=3)

cat("At 5 years (adjusted), weights stabilized by 1%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr2, tau=5)

cat("===============================================================================")

cat("at 3 months (adjusted), weights stabilized by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr3, tau=.33)

cat("At 1 year (adjusted), weights stabilized by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr3, tau=1)

cat("At 3 years (adjusted), weights stabilized by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr3, tau=3)

cat("At 5 years (adjusted), weights stabilized by 5%")
akm_rmst(time=Base_fiscalia_v14_mod$yrs_to_condemn, status=Base_fiscalia_v14_mod$event_r, group= Base_fiscalia_v14_mod$motivodeegreso_mod_imp_rec, weight=Base_fiscalia_v14_mod$weight_tr3, tau=5)

```

We used the kaplan-meier curves with survey-weighting, according to a commentary made by Thomas Lumley.

::: controlly
```{r adj-km, echo=T, fig.align='center', message=T, error=T, eval=T}
#Rader, Kevin Andrew. 2014. Methods for Analyzing Survival and Binary Data in Complex Surveys. Doctoral dissertation, Harvard University.http://nrs.harvard.edu/urn-3:HUL.InstRepos:12274283

#load(paste0(dirname(rstudioapi::getSourceEditorContext()$path),"/__analisis_joel.RData"))
library(survey)
# survey::svylogrank
#First, you can use the survey::svylogrank function, as @IRTFM suggests. This will treat the weights as sampling weights, but I think that's ok with the robust standard errors that svylogrank uses.

design_weights <- survey::svydesign(ids = ~1, data = dplyr::mutate(Base_fiscalia_v14_mod, yrs_to_condemn= dplyr::case_when(yrs_to_condemn==0~0.0001,T~yrs_to_condemn)), weights = ~weight_mult_a1)
# Error in .logrank(formula, design, rho, gamma, ...) : 


survey::svykm(Surv(time=yrs_to_condemn,event=event_r)~motivodeegreso_mod_imp_rec,
                        #con_quien_vive_joel, 
                        design=design_weights, rho=0, gamma=0)

system.time({
s1<- survey::svylogrank(Surv(time=yrs_to_condemn,event=event_r)~con_quien_vive_joel_alone,
                        #con_quien_vive_joel, 
                        design=design_weights, rho=0, gamma=0) #tslow , se=T
#primero es familia de origen vs. el resto
#alone vs. el resto da -41.77638 60.81932 -0.6868932 0.49215
#couple/children vs. el resto da .003 
})

system.time({
s2<- survey::svylogrank(Surv(time=yrs_to_condemn,event=event_r)~con_quien_vive_joel_coup_chil,
                        #con_quien_vive_joel, 
                        design=design_weights, rho=0, gamma=0) #tslow , se=T
#primero es familia de origen vs. el resto
#alone vs. el resto da -41.77638 60.81932 -0.6868932 0.49215
#couple/children vs. el resto da .003 
})

system.time({
s3<- survey::svylogrank(Surv(time=yrs_to_condemn,event=event_r)~con_quien_vive_joel_fam_or,
                        #con_quien_vive_joel, 
                        design=design_weights, rho=0, gamma=0) #tslow , se=T
#primero es familia de origen vs. el resto
#alone vs. el resto da -41.77638 60.81932 -0.6868932 0.49215
#couple/children vs. el resto da .003 
})

system.time({
s4<- survey::svylogrank(Surv(time=yrs_to_condemn,event=event_r)~con_quien_vive_joel,
                        #con_quien_vive_joel, 
                        design=design_weights, rho=0, gamma=0) #tslow , se=T
#primero es familia de origen vs. el resto
#alone vs. el resto da -41.77638 60.81932 -0.6868932 0.49215
#couple/children vs. el resto da .003 
})

cat("Alone (1) vs. With couple/children and Family of origin")
s1
cat("With couple/children(1) vs. Alone and Family of origin")
s2
cat("Family of origin(1) vs. Alone and With couple/children")
s3
cat("Every level")
s4

#svykm -->
# Error: cannot allocate vector of size 3.1 Gb
# Timing stopped at: 6913 368.1 7453

```
:::


We tested weights that account for a multinomial response using Propensity score weighting using Bayesian additive regression trees (BART) (`weight_mult_a0`), multinomial regression (`weight_mult_a`), and Generalized Boosted Regression Modeling with multinomial response on the average effect on the treated or ATE (`weight_mult_b`),  weights with multiple treatments or ATO (Li, & Li, 2019) (`weight_mult_c`) and weights to simultaneously compare three treatment groups or ATM (Yoshida et al., 2007) (`weight_mult_d`).


```{r alt-an1, echo=T, fig.align='center', message=T, error=T, eval=T}
#load(paste0(dirname(rstudioapi::getSourceEditorContext()$path),"/__analisis_joel.RData"))
prueba2_imp22<-prueba2_imp2 %>% dplyr::mutate(con_quien_vive_joel= factor(con_quien_vive_joel))#, numero_de_hijos_mod_joel= as.ordered(numero_de_hijos_mod_joel)) %>% dplyr::mutate(freq_cons_sus_prin=ordered(freq_cons_sus_prin,levels=c("Did not use", "Less than 1 day a week", "1 day a week or more", "2 to 3 days a week","4 to 6 days a week", "Daily")))
#A multi-category example using GBM predicted probabilities
library(caret)

#Here, we'll set multinomial distribution, 10 cross-validation fold, and 200 trees.
#learning rate (shrinkage) of 0.001. This is a very small learning rate and typically requires a large number of trees to find the minimum MSE. 
#find the better model
#https://www.webpages.uidaho.edu/~stevel/517/Gradient%20Boosting%20Machines%20at%20UC.html
set.seed(2125)
W1 <- weightit(as.formula(paste("con_quien_vive_joel~", paste(vars, collapse = "+"))),
               data=prueba2_imp22, stabilize = T,
                method = "bart", estimand = "ATE", int=T,
                use.mlogit = FALSE)
prueba2_imp22$weight_mult_a0 <-W1$weights

set.seed(2125)
mod_gbm = gbm::gbm(as.formula(paste("con_quien_vive_joel~", paste(vars, collapse = "+"))),
              data = prueba2_imp22,
              distribution = "multinomial",
              cv.folds = 10,
              shrinkage = .001,
              n.minobsinnode = 10,
              n.trees = 5e3)
#gbm.perf(mod_gbm, method = "cv") weightit.fit

ps.multi <- drop(predict(mod_gbm, type = "response", n.trees = 5e3))
#https://ngreifer.github.io/WeightIt/reference/method_ps.html
#https://search.r-project.org/CRAN/refmans/WeightIt/html/get_w_from_ps.html
prueba2_imp22$weight_mult_b <- WeightIt::get_w_from_ps(ps.multi, prueba2_imp22$con_quien_vive_joel, estimand = "ATE", stabilize=T)
prueba2_imp22$weight_mult_c <- WeightIt::get_w_from_ps(ps.multi, prueba2_imp22$con_quien_vive_joel, estimand = "ATO", stabilize=T)
prueba2_imp22$weight_mult_d <- WeightIt::get_w_from_ps(ps.multi, prueba2_imp22$con_quien_vive_joel, estimand = "ATM", stabilize=T)

# Multinomial Treatments
# 
# - estimand = "ATO"
# Li, F., & Li, F. (2019). Propensity score weighting for causal inference with multiple treatments. The Annals of Applied Statistics, 13(4), 2389<U+2013>2415. 10.1214/19-AOAS1282
# 
# - estimand = "ATM"

```

We assess the covariates' balance after the weighting

::: controlly 
```{r post-rmst-alt-an, echo=T, fig.align='center', message=T, error=T, eval=T}
bal_tab2<-
cobalt::bal.tab(event ~ con_quien_vive_joel+ edad_al_ing+ sexo_2 + escolaridad_rec + sus_ini_mod_mvv + freq_cons_sus_prin + via_adm_sus_prin_act + condicion_ocupacional_corr+ compromiso_biopsicosocial + numero_de_hijos_mod_joel + tipo_de_plan_2_mod+ tenencia_de_la_vivienda_mod + tipo_centro+ cnt_mod_cie_10_dg_cons_sus_or + sus_principal_mod+ macrozona + cnt_mod_cie_10_or, data = prueba2_imp22,
                weights = list("Multinomial Logistic, not stabilized" = "weight_mult_a00", "Multinomial Logistic, stabilized at 1%"="weight_tr", "Multinomial Logistic, stabilized at 5%"="weight_tr2", "Multinomial Logistic, stabilized at 10%"="weight_tr3", "Bayesian additive regression trees (BART)"="weight_mult_a0", "Propensity Scores (WeightIt)"="weight_mult_a", "Generalized Boosted Regression Modeling with multinomial response, ATE"="weight_mult_b", "Generalized Boosted Regression Modeling with multinomial response, ATO"="weight_mult_c", "Generalized Boosted Regression Modeling with multinomial response, ATM"="weight_mult_d"),
                estimand = "ATE",
                which.treat = .all,
                un = T, 
                thresholds = c(cor = .2),
                 binary = "std", continuous = "std",
                stats = c("mean.diffs", "variance.ratios"))

bal_tab2$Balance %>% 
  dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Balance Measures (multinomial response weights)")
  # knitr::kable("html", caption="Balance Measures") %>% 
  #      kableExtra::kable_classic()
```
:::

::: controlly 
```{r post-rmst2-alt-an, echo=T, fig.align='center', message=T, error=T, eval=T}
bal_tab2$Observations %>% 
  #dplyr::mutate_if(is.numeric, ~round(.,2)) %>% 
  knitr::kable("markdown", caption="Effective sample sizes")
```
:::

The model with multinomial logistic regression (`weight_mult_a`) performed better in terms of balance of the variables. We estimate the restricted survival times using these weights. 

::: controlly 
```{r rmst-adj-tr3-alt-an, echo=T, fig.align='center', message=T, error=T, eval=T}


#(3) (PDF) Adjusted restricted mean survival times in observational studies. Available from: https://www.researchgate.net/publication/333326572_Adjusted_restricted_mean_survival_times_in_observational_studies [accessed Feb 02 2023].


akm_rmst(time=prueba2_imp22$yrs_to_tr_dropout, status=prueba2_imp22$event, group=prueba2_imp22$con_quien_vive_joel,weight=prueba2_imp22$weight_mult_a, tau=.33)

akm_rmst(time=prueba2_imp22$yrs_to_tr_dropout, status=prueba2_imp22$event, group=prueba2_imp22$con_quien_vive_joel,weight=prueba2_imp22$weight_mult_a, tau=1)

akm_rmst(time=prueba2_imp22$yrs_to_tr_dropout, status=prueba2_imp22$event, group=prueba2_imp22$con_quien_vive_joel,weight=prueba2_imp22$weight_mult_a, tau=3)

```
:::

- Who lives with his/her couple and children have lower mean time without experiencing dropout in comparison with vs. Family of origin and alone, meaning that experience it more quickly.

<br>

# Session Info

```{r session-info, echo=T, error=T, message=TRUE, paged.print=TRUE}
message(Sys.getenv("R_LIBS_USER"))
Sys.Date()
message(paste0("Editor context: ", path))

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2022 (github)/15.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/15.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2022 (github)/15.RData")
  } else {
     tryCatch(save.image(paste0(sub("2019","2022",sub("SUD_CL","",path)),"15.RData")),
              error= save.image(paste0(sub("2019","2022",sub("SUD_CL","",path)),"/15.RData")))
  }

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}")))
```

<br>

+a##`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`

<br>

# Missing data

```{r miss, warning=FALSE, echo=T, error=T, eval=T}
set.seed(2125)
Base_fiscalia_v14_miss <-
subset(Base_fiscalia_v14, select= c(c("hash_key", cont_vars_desc, cat_vars_desc, cat_vars_desc_off, cat_vars_dg_fis, vars_desc, "id_centro", "comuna_residencia_cod", "fech_ing_num_1", "fech_egres_imp", "cut_com_del", "cut_fec_nac","offender_d", "comuna_residencia_cod_rec", "porc_pobr", "Clasificación", "tipo_de_vivienda_mod"), "via_adm_sus_prin_act", "cat_ocupacional_corr", "clas_centers_r", "clas_r", "sus_ini_mod_mvv")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>% 
   missRanger::missRanger(
                formula = . ~ . - hash_key,
                num.trees = 200, 
                returnOOB=T,
                maxiter=50,
                verbose = 2, 
                seed = 2125)

set.seed(2125)
  Base_fiscalia_v14_pris_miss <-
subset(Base_fiscalia_v14_pris, select= c(c("hash_key", cont_vars_desc, cat_vars_desc, cat_vars_desc_off, cat_vars_dg_fis, vars_desc, "id_centro", "comuna_residencia_cod", "fech_ing_num_1", "fech_egres_imp", "cut_com_del", "cut_fec_nac","offender_d", "comuna_residencia_cod_rec", "porc_pobr", "Clasificación", "tipo_de_vivienda_mod"), "via_adm_sus_prin_act", "cat_ocupacional_corr", "clas_centers_r", "clas_r", "sus_ini_mod_mvv")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>% 
     missRanger::missRanger(
                formula = . ~ . - hash_key,
                num.trees = 200, 
                returnOOB=T,
                maxiter=50,
                verbose = 2, 
                seed = 2125)

  set.seed(2125)
Base_fiscalia_v14_miss2 <-
subset(Base_fiscalia_v14, select= c(c("hash_key", cont_vars_desc, cat_vars_desc, cat_vars_desc_off, cat_vars_dg_fis, vars_desc, "id_centro", "comuna_residencia_cod", "fech_ing_num_1", "fech_egres_imp", "cut_com_del", "cut_fec_nac","offender_d", "comuna_residencia_cod_rec", "porc_pobr", "Clasificación", "tipo_de_vivienda_mod"), "via_adm_sus_prin_act", "cat_ocupacional_corr", "clas_centers_r", "clas_r", "sus_ini_mod_mvv")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>% 
  dplyr::mutate(dg_cie_10_rec= dplyr::case_when(as.character(dg_cie_10_rec)=="Diagnosis unknown (under study)"~NA_character_,T~as.character(dg_cie_10_rec))) %>% 
   missRanger::missRanger(
                formula = . ~ . - hash_key,
                num.trees = 200, 
                returnOOB=T,
                maxiter=50,
                verbose = 2, 
                seed = 2125)

set.seed(2125)
  Base_fiscalia_v14_pris_miss2 <-
subset(Base_fiscalia_v14_pris, select= c(c("hash_key", cont_vars_desc, cat_vars_desc, cat_vars_desc_off, cat_vars_dg_fis, vars_desc, "id_centro", "comuna_residencia_cod", "fech_ing_num_1", "fech_egres_imp", "cut_com_del", "cut_fec_nac","offender_d", "comuna_residencia_cod_rec", "porc_pobr", "Clasificación", "tipo_de_vivienda_mod"), "via_adm_sus_prin_act", "cat_ocupacional_corr", "clas_centers_r", "clas_r", "sus_ini_mod_mvv")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>% 
    dplyr::mutate(dg_cie_10_rec= dplyr::case_when(as.character(dg_cie_10_rec)=="Diagnosis unknown (under study)"~NA_character_,T~as.character(dg_cie_10_rec))) %>% 
     missRanger::missRanger(
                formula = . ~ . - hash_key,
                num.trees = 200, 
                returnOOB=T,
                maxiter=50,
                verbose = 2, 
                seed = 2125)
```

<br>

# Export

```{r export, warning=FALSE, echo=T, error=T, eval=T}
#2023-01-01 we had a problem with edad_al_ing_fmt. This variable predict better (it had lower amount of missing data and was in wide format)
cont_vars_desc[1]<-ifelse(cont_vars_desc[1]=="edad_al_ing_fmt","edad_al_ing_1",cont_vars_desc[1])

library(missRanger)
attr(Base_fiscalia_v14$tipo_centro,"label") <- "Type of Center"

subset(Base_fiscalia_v14, select= c(c("hash_key", cont_vars_desc, cat_vars_desc, cat_vars_desc_off, cat_vars_dg_fis, vars_desc, "id_centro", "comuna_residencia_cod", "fech_ing_num_1", "fech_egres_imp", "cut_com_del", "cut_fec_nac","offender_d", "comuna_residencia_cod_rec", "porc_pobr", "Clasificación", "tipo_de_vivienda_mod"), "via_adm_sus_prin_act", "cat_ocupacional_corr", "clas_centers_r", "clas_r", "sus_ini_mod_mvv")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1)  %>% 
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA.dta"))

attr(Base_fiscalia_v14_pris$tipo_centro,"label") <- "Type of Center"

subset(Base_fiscalia_v14_pris, select= c(c("hash_key", cont_vars_desc, cat_vars_desc, cat_vars_desc_off, cat_vars_dg_fis, vars_desc, "id_centro", "comuna_residencia_cod", "fech_ing_num_1", "fech_egres_imp", "cut_com_del", "cut_fec_nac","offender_d", "comuna_residencia_cod_rec", "porc_pobr", "Clasificación", "tipo_de_vivienda_mod"), "via_adm_sus_prin_act", "cat_ocupacional_corr", "clas_centers_r", "clas_r", "sus_ini_mod_mvv")) %>% 
  dplyr::arrange(hash_key, fech_ing_num_1) %>%   
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_pris.dta"))


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
# IMPUTATION
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

Base_fiscalia_v14_miss %>% 
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss.dta"))

  
Base_fiscalia_v14_pris_miss %>%   
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss_pris.dta"))


Base_fiscalia_v14_miss2 %>% 
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss2.dta"))

  
Base_fiscalia_v14_pris_miss2 %>%   
  dplyr::mutate(age_at_censor_date=lubridate::time_length(lubridate::interval(fech_nac_rec, as.Date("2019-11-13")),unit="years")) %>% 
  data.table::data.table() %>% 
  rio::export(file = paste0("fiscalia_mariel_feb_2023_match_SENDA_miss_pris2.dta"))
```


::: controlly
```{r label_to_stata, echo=T, paged.print=TRUE}
#put name of the file
file<- "fiscalia_mariel_feb_2023_match_SENDA.dta"

export_lab_stata_merge<-
  tibble::rownames_to_column(data.frame(Hmisc::label(dplyr::select(Base_fiscalia_v14,  all_of(c("hash_key", cont_vars_desc, cat_vars_desc, cat_vars_desc_off, vars_desc, "fech_ing_num_1", "fech_egres_imp", "cut_com_del", "cut_fec_nac","offender_d", "comuna_residencia_cod_rec", "porc_pobr", "Clasificación", "tipo_de_vivienda_mod", "via_adm_sus_prin_act", "cat_ocupacional_corr", "clas_centers_r", "clas_r"))))))%>% data.frame() %>%
  
  dplyr::rename("code" = !!names(.[1]), "label" = !!names(.[2]))%>% data.frame()%>%
  dplyr::mutate(first= "cap noi label variable")%>%
  dplyr::mutate(final= paste0(first, " ",code,' "',label,'"'))%>%
  dplyr::select(-code,-label,-first)%>%
  dplyr::rename("*clear all"="final") %>%
  rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\',file,'", replace'))%>%
  rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\',file,'", replace'))

rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\',file,'", clear'),export_lab_stata_merge) %>% knitr::kable("markdown")

write.table(rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\',file,'", clear'),export_lab_stata_merge), file = paste0(path,"/_label_var_to_stata_feb2023.do"), sep = "",row.names = FALSE, quote = FALSE, fileEncoding="UTF-8")
```
:::

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">

```{stata 2, collectcode=F, include=T, error=T, cleanlog=F}
*should be in the same folder of the .Rmd to work
cap noi do _label_var_to_stata_jan2023
```

</div>
